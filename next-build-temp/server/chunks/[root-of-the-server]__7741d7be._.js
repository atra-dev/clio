module.exports=[70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},2157,(e,t,r)=>{t.exports=e.x("node:fs",()=>require("node:fs"))},50227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},22177,e=>{"use strict";function t(e,r=""){return String(e||"").trim()||r}function r(e){return Array.isArray(e)?e:[]}function i(e){return t(e).toLowerCase()}function n(e){return String(e||"").replace(/[^\d+]/g,"").trim()}function o(e){return t(e).split(",").map(e=>e.trim()).filter(Boolean)}function a(e=[]){return Array.from(new Set(e.filter(Boolean)))}function s(){let e,r=(e=t(process.env.CLIO_ALERT_EMAIL_PROVIDER).toLowerCase())?e.includes("resend")?"resend":e.includes("firebase")?"firebase":e.includes("console")||"dev"===e?"console":"none"===e||"off"===e?"none":e:"";return r||"none"}function l(){let e,r=(e=t(process.env.CLIO_ALERT_SMS_PROVIDER).toLowerCase())?e.includes("twilio")?"twilio":e.includes("console")||"dev"===e?"console":"none"===e||"off"===e?"none":e:"";return r||"none"}function c(e=[]){return a([...o(process.env.CLIO_SECURITY_ALERT_RECIPIENTS),...o(process.env.GRC_EMAILS),...o(process.env.SUPER_ADMIN_EMAILS),...r(e)].map(e=>i(e)).filter(Boolean))}async function u({recipients:e,subject:r,text:i,html:n}){let o=t(process.env.RESEND_API_KEY),a=t(process.env.CLIO_EMAIL_FROM);if(!o||!a||!o.startsWith("re_"))throw Error("email_provider_not_configured");let s=await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({from:a,to:e,subject:r,text:i,html:n})}),l=await s.json().catch(()=>({}));if(!s.ok){let e=t(l?.message)||t(l?.error?.message)||"email_delivery_failed";throw Error(`email_delivery_failed:${e}`)}return{provider:"resend",status:"sent",messageId:t(l?.id,`resend-${Date.now()}`),recipientCount:e.length}}async function d({recipients:e,subject:n,text:o,html:l}){let c=a(r(e).map(i).filter(Boolean));if(0===c.length)return{provider:"none",status:"skipped",reason:"no_recipients",recipientCount:0};let d=s();return"none"===d?{provider:d,status:"skipped",reason:"provider_disabled",recipientCount:0}:"firebase"===d?{provider:d,status:"skipped",reason:"firebase_not_supported_for_custom_alert_email",recipientCount:0}:"console"===d?function({recipients:e,subject:r,text:i}){return function(e,r=!1){let i=t(process.env[e]).toLowerCase();return i?"true"===i||"1"===i||"yes"===i:r}("CLIO_ALLOW_CONSOLE_EMAIL",!0)&&console.info("[CLIO:SecurityAlert:Email]",{recipients:e,subject:r,text:i}),{provider:"console",status:"simulated",recipientCount:e.length}}({recipients:c,subject:n,text:o}):"resend"===d?await u({recipients:c,subject:n,text:o,html:l}):{provider:d,status:"skipped",reason:"unsupported_provider",recipientCount:0}}async function p({recipients:e,body:r}){let i=t(process.env.TWILIO_ACCOUNT_SID),n=t(process.env.TWILIO_AUTH_TOKEN),o=t(process.env.TWILIO_FROM_NUMBER);if(!i||!n||!o)throw Error("twilio_not_configured");let a=Buffer.from(`${i}:${n}`,"utf8").toString("base64"),s=e.map(async e=>{let n=new URLSearchParams;n.set("To",e),n.set("From",o),n.set("Body",r);let s=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${encodeURIComponent(i)}/Messages.json`,{method:"POST",headers:{Authorization:`Basic ${a}`,"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}),l=await s.json().catch(()=>({}));if(!s.ok){let e=t(l?.message,"sms_delivery_failed");throw Error(`twilio_delivery_failed:${e}`)}return{to:e,sid:t(l?.sid)}}),l=await Promise.allSettled(s),c=l.filter(e=>"fulfilled"===e.status).map(e=>e.value),u=l.filter(e=>"rejected"===e.status).map(e=>t(e.reason?.message||"sms_delivery_failed"));return{provider:"twilio",status:u.length>0?c.length>0?"partial":"failed":"sent",deliveredCount:c.length,recipientCount:e.length,delivered:c,failed:u}}async function f({recipients:e,body:t}){let i=a(r(e).map(n).filter(Boolean));if(0===i.length)return{provider:"none",status:"skipped",reason:"no_recipients",deliveredCount:0,recipientCount:0,failed:[]};let o=l();return"none"===o?{provider:o,status:"skipped",reason:"provider_disabled",deliveredCount:0,recipientCount:i.length,failed:[]}:"console"===o?function({recipients:e,body:t}){return{provider:"console",status:"simulated",deliveredCount:e.length,recipientCount:e.length,delivered:e.map(e=>({to:e,sid:`console-${Date.now()}`})),failed:[]}}({recipients:i,body:t}):"twilio"===o?await p({recipients:i,body:t}):{provider:o,status:"skipped",reason:"unsupported_provider",deliveredCount:0,recipientCount:i.length,failed:[]}}async function m({url:e,label:r,token:i,payload:n,timeoutMs:o}){let a=new AbortController,s=setTimeout(()=>a.abort(),o);try{let o={"Content-Type":"application/json","X-CLIO-Source":"security-detection","X-CLIO-Target":r};i&&(o.Authorization=`Bearer ${i}`);let s=await fetch(e,{method:"POST",headers:o,body:JSON.stringify(n),signal:a.signal}),l=await s.text().catch(()=>"");return{label:r,url:e,ok:s.ok,status:s.status,body:t(l)}}catch(i){return{label:r,url:e,ok:!1,status:0,body:t(i?.message,"webhook_delivery_failed")}}finally{clearTimeout(s)}}async function _(e){let r,i,n,a,s=(r=o(process.env.CLIO_SECURITY_WEBHOOK_URLS).map(e=>({label:"security-webhook",url:e,token:t(process.env.CLIO_SECURITY_WEBHOOK_TOKEN)})),i=t(process.env.CLIO_SIEM_WEBHOOK_URL),n=t(process.env.CLIO_EDR_WEBHOOK_URL),a=[...r],i&&a.push({label:"siem",url:i,token:t(process.env.CLIO_SIEM_WEBHOOK_TOKEN)}),n&&a.push({label:"edr",url:n,token:t(process.env.CLIO_EDR_WEBHOOK_TOKEN)}),a.filter(e=>t(e.url)));if(0===s.length)return{status:"skipped",targets:[],successCount:0};let l=Number.parseInt(t(process.env.CLIO_SECURITY_WEBHOOK_TIMEOUT_MS,"5000"),10)||5e3,c=await Promise.all(s.map(t=>m({...t,payload:e,timeoutMs:Math.max(1e3,Math.min(2e4,l))}))),u=c.filter(e=>e.ok).length;return{status:u===c.length?"sent":u>0?"partial":"failed",targets:c,successCount:u}}async function y({incident:e,detection:i,sourceEvent:u,emailRecipients:p=[],smsRecipients:m=[]}={}){let h,v=c(p),w=function(e=[]){return a([...o(process.env.CLIO_SMS_ALERT_RECIPIENTS),...r(e)].map(e=>n(e)).filter(Boolean))}(m),g=function({incident:e,detection:r}){let i=t(e?.severity||r?.severity||"Medium").toUpperCase(),n=t(e?.incidentCode,"INCIDENT"),o=t(e?.title,"Security anomaly detected");return`[CLIO][${i}] ${n} - ${o}`}({incident:e,detection:i}),I=function({incident:e,detection:r,sourceEvent:i}){let n=t(r?.ruleId,"N/A"),o=t(i?.metadata?.sourceIp||i?.sourceIp,"unknown"),a=t(i?.performedBy,"unknown"),s=t(i?.metadata?.requestPath||i?.requestPath,"unknown"),l=Number(r?.observedCount||0),c=t(e?.detectedAt||i?.occurredAt,new Date().toISOString());return`CLIO security anomaly alert
Incident: ${t(e?.incidentCode,"-")} | ${t(e?.title,"-")}
Severity: ${t(e?.severity,"-")}
Rule: ${n}
Detected At: ${c}
Actor: ${a}
Source IP: ${o}
Request Path: ${s}
Observed Count: ${l>0?l:"-"}
Summary: ${t(e?.summary||r?.summary,"-")}
Action URL: ${t(e?.actionUrl,"/incident-management")}`}({incident:e,detection:i,sourceEvent:u}),C=(h=String(I||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"),`<pre style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap;">${h}</pre>`),[A,S,E]=await Promise.all([d({recipients:v,subject:g,text:I,html:C}).catch(e=>({provider:s(),status:"failed",reason:t(e?.message,"email_delivery_failed"),recipientCount:v.length})),f({recipients:w,body:`${g}
${I}`.slice(0,1200)}).catch(e=>({provider:l(),status:"failed",reason:t(e?.message,"sms_delivery_failed"),deliveredCount:0,recipientCount:w.length,failed:[t(e?.message,"sms_delivery_failed")]})),_({eventType:"clio.security.incident",generatedAt:new Date().toISOString(),incident:e,detection:i,sourceEvent:{id:t(u?.id),module:t(u?.module),activityName:t(u?.activityName),status:t(u?.status),occurredAt:t(u?.occurredAt),sourceIp:t(u?.metadata?.sourceIp||u?.sourceIp),requestPath:t(u?.metadata?.requestPath||u?.requestPath)}})]);return{subject:g,email:A,sms:S,webhooks:E,recipients:v,smsRecipients:w}}function h(e=[]){return c(e)}async function v({recipients:e=[],body:r=""}={}){return await f({recipients:e,body:t(r,"")})}e.s(["dispatchDirectSms",()=>v,"dispatchSecurityIncidentAlerts",()=>y,"resolveSecurityAlertEmailRecipients",()=>h])},33355,e=>{"use strict";e.i(18097);var t=e.i(19e3),r=e.i(67658),i=e.i(45709);function n(){return new Date().toISOString()}function o(e,t=""){return String(e||"").trim()||t}function a(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){let r=e.trim().toLowerCase();if(!r)return t;if(["true","1","yes","on","y"].includes(r))return!0;if(["false","0","no","off","n"].includes(r))return!1}return t}function s(e){return e&&"object"==typeof e&&!Array.isArray(e)?e:{}}function l(e){return Array.isArray(e)?e:[]}function c(e,t,{min:r=1,max:i=Number.MAX_SAFE_INTEGER}={}){let n=Number.parseInt(String(e||""),10);return Number.isFinite(n)?Math.min(i,Math.max(r,n)):t}function u(e){return String(e||"").trim().toLowerCase()}function d(e){return String(e||"").trim().toLowerCase()}function p(e){return String(e||"").split(",").map(e=>u(e)).filter(Boolean)}function f(e){return"read"===String(e||"").trim().toLowerCase()?"read":"unread"}function m(){return o(process.env.CLIO_FIRESTORE_NOTIFICATIONS_COLLECTION,"clio_notifications")}function _(){return(0,r.isFirestoreEnabled)()?(0,r.getFirestoreDb)():null}function y(e){return{...e.data()||{},id:e.id,recordId:e.id}}function h(e,t){let r=u(t),i=u(e?.recipientEmail);return a(e?.broadcast,!1)||r&&i&&r===i}function v(e,t){return new Date(t?.createdAt||0).getTime()-new Date(e?.createdAt||0).getTime()}async function w(e){let r=_();if(!r)return null;let i=function(e){let t,r=n(),i=u(e?.recipientEmail),l=a(e?.broadcast,!1);if(!i&&!l)throw Error("invalid_notification_recipient");return{title:o(e?.title,"Security notification"),message:o(e?.message,"A security event requires review."),severity:"critical"===(t=String(e?.severity||"").trim().toLowerCase())?"critical":"high"===t?"high":"low"===t?"low":"medium",type:o(e?.type,"security"),module:o(e?.module,"Incident Management"),actionUrl:o(e?.actionUrl,"/incident-management"),recipientEmail:i,broadcast:l,status:f(e?.status),metadata:s(e?.metadata),createdAt:o(e?.createdAt,r),updatedAt:o(e?.updatedAt,r),readAt:o(e?.readAt,""),createdBy:u(e?.createdBy)}}(e),l=await (0,t.addDoc)((0,t.collection)(r,m()),i);return{...i,id:l.id,recordId:l.id}}async function g(e){let t=l(e);if(0===t.length)return[];let r=[];for(let e of t){let t=await w(e);t&&r.push(t)}return r}async function I(e,r){let i=_();if(!i)return null;let n=o(e);if(!n)throw Error("invalid_record_id");let a=(0,t.doc)(i,m(),n),s=await (0,t.getDoc)(a);if(!s.exists())return null;let l=y(s);if(!h(l,r))throw Error("forbidden_notification_access");return l}async function C({recipientEmail:e,status:r="all",limit:i=20}={}){let n=_();if(!n)return{records:[],unreadCount:0,totalScoped:0};let o=String(r||"").trim().toLowerCase(),a=c(i,20,{min:1,max:120}),s=Math.max(4*a,100),l=(await (0,t.getDocs)((0,t.query)((0,t.collection)(n,m()),(0,t.orderBy)("createdAt","desc"),(0,t.limit)(s)))).docs.map(y).filter(t=>h(t,e)),u=l.reduce((e,t)=>e+ +("unread"===f(t?.status)),0);return{records:l.filter(e=>"all"===o||!o||f(e?.status)===o).sort(v).slice(0,a),unreadCount:u,totalScoped:l.length}}async function A(e,r){let i=_();if(!i)return null;let a=o(e);if(!a)throw Error("invalid_record_id");let s=(0,t.doc)(i,m(),a),l=await (0,t.getDoc)(s);if(!l.exists())return null;let c=y(l);if(!h(c,r))throw Error("forbidden_notification_access");if("read"===f(c.status))return c;let u={...c,status:"read",readAt:n(),updatedAt:n()};return await (0,t.updateDoc)(s,u),u}async function S(e,r,i){let a=_();if(!a)return null;let l=o(e);if(!l)throw Error("invalid_record_id");let c=u(r),d=o(i).toLowerCase();if("confirm"!==d&&"deny"!==d)throw Error("invalid_device_verification_decision");let p=(0,t.doc)(a,m(),l),f=await (0,t.getDoc)(p);if(!f.exists())return null;let v=y(f);if(!h(v,c))throw Error("forbidden_notification_access");let w=s(v?.metadata),g=o(w?.deviceVerificationDecision).toLowerCase();if(g){if(g===d)return v;throw Error("device_verification_already_resolved")}let I=n(),C={...v,status:"read",readAt:o(v?.readAt,I),updatedAt:I,metadata:{...w,deviceVerificationDecision:d,deviceVerificationResolvedAt:I,deviceVerificationResponder:c}};return await (0,t.updateDoc)(p,C),C}async function E({recipientEmail:e,limit:r=120}={}){let i=u(e);if(!i)return{updatedCount:0};let a=_();if(!a)return{updatedCount:0};let s=c(r,120,{min:1,max:300}),{records:l}=await C({recipientEmail:i,status:"unread",limit:s}),d=0;for(let e of l){let r=o(e?.id||e?.recordId);if(!r)continue;let i=(0,t.doc)(a,m(),r);await (0,t.updateDoc)(i,{status:"read",readAt:n(),updatedAt:n()}),d+=1}return{updatedCount:d}}function L(e=[]){return Array.from(new Set(l(e).map(e=>u(e)).filter(Boolean)))}async function O({ownerEmail:e,affectedEmployeeEmail:t,actorEmail:r,includeAffectedEmployee:n=!0,includeActor:o=!1}={}){let a=[u(process.env.CLIO_GRC_ALERT_EMAIL),...p(process.env.GRC_EMAILS),u(e)];n&&a.push(u(t)),o&&a.push(u(r));let s=[];try{let e=await (0,i.listUserAccounts)();s=l(e).filter(e=>u(e?.email)).filter(e=>"active"===d(e?.status)).filter(e=>{let t=String(e?.role||"").trim().toUpperCase();return"GRC"===t}).map(e=>u(e?.email))}catch{s=[]}return L([...a,...s])}async function R(){let e=[u(process.env.CLIO_GRC_ALERT_EMAIL),...p(process.env.GRC_EMAILS)],t=[];try{let e=await (0,i.listUserAccounts)();t=l(e).filter(e=>u(e?.email)).filter(e=>"active"===d(e?.status)).filter(e=>"GRC"===String(e?.role||"").trim().toUpperCase()).map(e=>u(e?.email))}catch{t=[]}return L([...e,...t])}e.s(["createInAppNotification",()=>w,"createInAppNotificationsBulk",()=>g,"getInAppNotificationForRecipient",()=>I,"listInAppNotifications",()=>C,"markAllInAppNotificationsRead",()=>E,"markInAppNotificationRead",()=>A,"resolveDeviceVerificationNotification",()=>S,"resolveGrcRecipients",()=>R,"resolveIncidentStakeholderRecipients",()=>O])},4381,e=>{"use strict";let t="__clio_rate_limit_buckets__";function r(e){return String(e||"").trim().toLowerCase()}function i(e){if(!e||!e.headers)return"unknown";let t=e.headers.get("x-forwarded-for");if(t){let e=t.split(",")[0]?.trim();if(e)return e}for(let t of["x-real-ip","cf-connecting-ip","x-vercel-forwarded-for"]){let r=String(e.headers.get(t)||"").trim();if(r)return r}return"unknown"}function n({scope:e,identifier:i,limit:n=20,windowMs:o=3e5}){let a=String(e||"default").trim().toLowerCase(),s=r(i)||"unknown",l=Math.max(1,Number.parseInt(String(n),10)||1),c=Math.max(1e3,Number.parseInt(String(o),10)||1e3),u=(globalThis[t]||(globalThis[t]=new Map),globalThis[t]),d=Date.now();!function(e,t){if(e.size<=5e3)return;for(let[r,i]of e.entries())(!i||t>=i.resetAt)&&e.delete(r);if(e.size<=5e3)return;let r=e.size-5e3;for(let t of e.keys())if(e.delete(t),(r-=1)<=0)break}(u,d);let p=`${a}:${s}`,f=u.get(p);(!f||d>=f.resetAt)&&(f={count:0,resetAt:d+c}),f.count+=1,u.set(p,f);let m=Math.max(0,l-f.count),_=Math.max(1,Math.ceil((f.resetAt-d)/1e3));return{allowed:f.count<=l,key:p,remaining:m,retryAfterSeconds:_,resetAt:f.resetAt,headers:{"Retry-After":String(_),"X-RateLimit-Limit":String(l),"X-RateLimit-Remaining":String(m),"X-RateLimit-Reset":String(Math.floor(f.resetAt/1e3))}}}function o({request:e,scope:t,identifier:o,limit:a,windowMs:s}){return n({scope:t,identifier:r(o)||i(e),limit:a,windowMs:s})}e.s(["consumeRateLimit",()=>n,"enforceRateLimitByRequest",()=>o,"getRequestSourceIp",()=>i])},14277,e=>{"use strict";var t=e.i(4381),r=e.i(33355);let i=new Set(["invalid_otp","otp_expired","otp_attempts_exceeded","otp_not_requested","otp_cooldown","firebase_phone_not_verified"]);function n(e){return String(e||"").trim()}function o(e){return n(e).toLowerCase()}async function a(e){let t=await (0,r.resolveGrcRecipients)();if(0===t.length)return;let i=t.map(t=>e(t));await (0,r.createInAppNotificationsBulk)(i)}async function s({request:e,actorEmail:r,reason:l,context:c="login_sms_verification"}={}){let u,d=n(l).toLowerCase();if(!i.has(d))return;let p=(0,t.getRequestSourceIp)(e),f=(u=o(r))||n(p)||"unknown",m=(0,t.consumeRateLimit)({scope:`auth-otp-failure-alert:${c}`,identifier:f,limit:5,windowMs:6e5});m.allowed&&!(m.remaining>0)&&await a(e=>({title:"Repeated OTP verification failures detected",message:`Detected 5 OTP failure events for ${f} within 10 minutes.`,severity:"high",type:"auth-otp-failure-spike",module:"Authentication",actionUrl:"/incident-management",recipientEmail:e,metadata:{actorEmail:o(r),sourceIp:p,reason:d,context:c,threshold:5,windowMinutes:10},createdBy:o(r)||"system@gmail.com"}))}async function l({actorEmail:e,sourceIp:r,deviceLabel:i}={}){let s=o(e);if(!s)return;let c=(0,t.consumeRateLimit)({scope:"auth-new-device-alert",identifier:s,limit:3,windowMs:18e5});c.allowed&&!(c.remaining>0)&&await a(e=>({title:"Unusual new-device sign-in pattern detected",message:`User ${s} triggered 3 new-device sign-ins within 30 minutes.`,severity:"medium",type:"auth-new-device-anomaly",module:"Authentication",actionUrl:"/incident-management",recipientEmail:e,metadata:{actorEmail:s,sourceIp:n(r),deviceLabel:n(i),threshold:3,windowMinutes:30},createdBy:s}))}e.s(["alertRepeatedNewDeviceSignIns",()=>l,"alertRepeatedOtpFailures",()=>s])},11072,e=>{e.v(t=>Promise.all(["server/chunks/src_lib_9a482084._.js","server/chunks/src_lib_hris-backend_4dbd0cdd.js","server/chunks/src_lib_security-detection_4bdbe3ad.js"].map(t=>e.l(t))).then(()=>t(74405)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__7741d7be._.js.map