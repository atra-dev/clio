{"version":3,"sources":["../../../src/lib/hris-backend.js"],"sourcesContent":["import {\r\n  addDoc,\r\n  collection,\r\n  deleteField,\r\n  deleteDoc,\r\n  doc,\r\n  getDoc,\r\n  getDocs,\r\n  query,\r\n  updateDoc,\r\n  where,\r\n} from \"firebase/firestore/lite\";\r\nimport { getFirestoreDb, isFirestoreEnabled } from \"@/lib/firebase\";\r\nimport {\r\n  archiveUserAccount,\r\n  getLoginAccount,\r\n  inviteUserAccount,\r\n  listUserAccounts,\r\n  purgeDueArchivedUserAccounts,\r\n  revokeInviteById,\r\n  updateUserAccountRole,\r\n  updateUserAccountStatus,\r\n} from \"@/lib/user-accounts\";\r\nimport { deliverInviteEmail } from \"@/lib/invite-delivery\";\r\nimport { formatEmployeeName } from \"@/lib/name-utils\";\r\nimport { listAuditEvents } from \"@/lib/audit-log\";\r\n\r\nconst MAX_AUDIT_TRAIL_ITEMS = 80;\r\nconst DEFAULT_ARCHIVE_RETENTION_YEARS = 5;\r\nconst MAX_LIFECYCLE_CHECKLIST_ITEMS = 32;\r\nconst MAX_LIFECYCLE_EVIDENCE_ITEMS = 80;\r\nconst MAX_INCIDENT_EVIDENCE_ITEMS = 50;\r\nconst MAX_INCIDENT_FORENSIC_SAMPLES = 8;\r\nconst MAX_REFERENCE_LABEL_LENGTH = 72;\r\nconst MAX_REFERENCE_CATALOG_ITEMS = 256;\r\nconst ALLOWED_REFERENCE_KINDS = new Set([\"role\", \"department\"]);\r\nconst SYSTEM_REFERENCE_ROLES = [\r\n  { value: \"SUPER_ADMIN\", label: \"Super Admin\" },\r\n  { value: \"GRC\", label: \"GRC\" },\r\n  { value: \"HR\", label: \"HR\" },\r\n  { value: \"EA\", label: \"EA\" },\r\n  { value: \"EMPLOYEE_L1\", label: \"Employee (L1)\" },\r\n  { value: \"EMPLOYEE_L2\", label: \"Employee (L2)\" },\r\n  { value: \"EMPLOYEE_L3\", label: \"Employee (L3)\" },\r\n];\r\nconst SYSTEM_REFERENCE_DEPARTMENTS = [\r\n  \"Governance, Risk, and Compliance (GRC)\",\r\n  \"Research and Development (R&D)\",\r\n  \"Cyber Security Operations Center (CSOC)\",\r\n  \"Threat Intelligence (TI)\",\r\n];\r\nconst LIFECYCLE_ROLE_ALIAS = new Map([\r\n  [\"SUPER_ADMIN\", \"SUPER_ADMIN\"],\r\n  [\"SUPERADMIN\", \"SUPER_ADMIN\"],\r\n  [\"ADMIN\", \"SUPER_ADMIN\"],\r\n  [\"GRC\", \"GRC\"],\r\n  [\"HR\", \"HR\"],\r\n  [\"EA\", \"EA\"],\r\n  [\"EMPLOYEE\", \"EMPLOYEE_L1\"],\r\n  [\"EMPLOYEE_L1\", \"EMPLOYEE_L1\"],\r\n  [\"EMPLOYEE_L2\", \"EMPLOYEE_L2\"],\r\n  [\"EMPLOYEE_L3\", \"EMPLOYEE_L3\"],\r\n  [\"L1\", \"EMPLOYEE_L1\"],\r\n  [\"L2\", \"EMPLOYEE_L2\"],\r\n  [\"L3\", \"EMPLOYEE_L3\"],\r\n]);\r\n\r\nconst LIFECYCLE_WORKFLOW_TEMPLATES = {\r\n  onboarding: {\r\n    type: \"onboarding\",\r\n    category: \"Onboarding\",\r\n    stages: [\"Initiated\", \"Document Verification\", \"Access Provisioning\", \"Activation\"],\r\n    checklist: [\r\n      { id: \"profile-intake\", label: \"Collect employee profile and contacts\", required: true, slaHours: 12 },\r\n      { id: \"contract-check\", label: \"Validate contract and onboarding requirements\", required: true, slaHours: 24 },\r\n      { id: \"account-activation\", label: \"Activate employee account\", required: true, slaHours: 48 },\r\n    ],\r\n    approverRoles: [\"HR\", \"GRC\"],\r\n    slaHours: 72,\r\n  },\r\n  \"role-change\": {\r\n    type: \"role-change\",\r\n    category: \"Role Change\",\r\n    stages: [\"Initiated\", \"Approval Review\", \"Role Sync\", \"Completed\"],\r\n    checklist: [\r\n      { id: \"movement-justification\", label: \"Attach role-change justification\", required: true, slaHours: 24 },\r\n      { id: \"effective-date-review\", label: \"Validate effective date and scope\", required: true, slaHours: 24 },\r\n      { id: \"permission-sync\", label: \"Apply role and permission sync\", required: true, slaHours: 48 },\r\n    ],\r\n    approverRoles: [\"HR\", \"GRC\"],\r\n    slaHours: 96,\r\n  },\r\n  disciplinary: {\r\n    type: \"disciplinary\",\r\n    category: \"Disciplinary\",\r\n    stages: [\"Case Opened\", \"Investigation\", \"Decision\", \"Closed\"],\r\n    checklist: [\r\n      { id: \"incident-report\", label: \"Record incident report\", required: true, slaHours: 24 },\r\n      { id: \"evidence-review\", label: \"Attach and review case evidence\", required: true, slaHours: 48 },\r\n      { id: \"decision-log\", label: \"Finalize disciplinary decision\", required: true, slaHours: 72 },\r\n    ],\r\n    approverRoles: [\"HR\", \"GRC\"],\r\n    slaHours: 120,\r\n  },\r\n  offboarding: {\r\n    type: \"offboarding\",\r\n    category: \"Offboarding\",\r\n    stages: [\"Initiated\", \"Clearance\", \"Access Revocation\", \"Archived\"],\r\n    checklist: [\r\n      { id: \"clearance-init\", label: \"Start employee clearance checklist\", required: true, slaHours: 12 },\r\n      { id: \"access-revoked\", label: \"Disable account and revoke access\", required: true, slaHours: 24 },\r\n      { id: \"archive-records\", label: \"Archive employee records\", required: true, slaHours: 48 },\r\n    ],\r\n    approverRoles: [\"HR\", \"GRC\"],\r\n    slaHours: 72,\r\n  },\r\n};\r\n\r\nconst LIFECYCLE_PRIVILEGED_TARGET_ROLES = new Set([\"SUPER_ADMIN\", \"GRC\", \"HR\", \"EA\"]);\r\nconst LIFECYCLE_ASSIGNABLE_BY_PRIVILEGED = new Set([\"EMPLOYEE_L1\", \"EMPLOYEE_L2\", \"EMPLOYEE_L3\"]);\r\nconst LIFECYCLE_ASSIGNABLE_BY_GRC = new Set([\"GRC\", \"HR\", \"EA\", \"EMPLOYEE_L1\", \"EMPLOYEE_L2\", \"EMPLOYEE_L3\"]);\r\nconst LIFECYCLE_REQUIRED_EVIDENCE_RULES = {\r\n  disciplinary: [\r\n    {\r\n      id: \"incident-report\",\r\n      label: \"Incident Report\",\r\n      keywords: [\"incident\", \"report\"],\r\n    },\r\n    {\r\n      id: \"notice-to-explain\",\r\n      label: \"Notice to Explain / Written Explanation\",\r\n      keywords: [\"notice\", \"explain\", \"written explanation\", \"explanation\"],\r\n    },\r\n    {\r\n      id: \"decision-memo\",\r\n      label: \"Decision Memo\",\r\n      keywords: [\"decision\", \"memo\"],\r\n    },\r\n  ],\r\n  offboarding: [\r\n    {\r\n      id: \"resignation-termination\",\r\n      label: \"Resignation / Termination Document\",\r\n      keywords: [\"resignation\", \"termination\", \"termination notice\"],\r\n    },\r\n    {\r\n      id: \"clearance-form\",\r\n      label: \"Clearance Form\",\r\n      keywords: [\"clearance\"],\r\n    },\r\n    {\r\n      id: \"handover-exit\",\r\n      label: \"Handover / Exit Checklist\",\r\n      keywords: [\"handover\", \"exit checklist\", \"exit interview\", \"knowledge transfer\"],\r\n    },\r\n  ],\r\n};\r\nconst INCIDENT_SEVERITY_LEVELS = [\"Low\", \"High\"];\r\nconst INCIDENT_STATUS_VALUES = [\"Open\", \"Containment\", \"Investigating\", \"Escalated\", \"Regulatory Review\", \"Resolved\", \"Closed\"];\r\nconst INCIDENT_CONTAINMENT_STATUS_VALUES = [\"Not Started\", \"In Progress\", \"Contained\"];\r\nconst INCIDENT_IMPACT_STATUS_VALUES = [\"Pending\", \"In Progress\", \"Completed\"];\r\nconst INCIDENT_TYPE_VALUES = [\r\n  \"Unauthorized Access\",\r\n  \"Data Exposure\",\r\n  \"Credential Compromise\",\r\n  \"Insider Misuse\",\r\n  \"Malware / Ransomware\",\r\n  \"Policy Violation\",\r\n  \"System Misconfiguration\",\r\n  \"Other\",\r\n];\r\nconst DEFAULT_INCIDENT_EVIDENCE_MAX_BYTES = 10 * 1024 * 1024;\r\nconst DEFAULT_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS = new Set([\r\n  \"pdf\",\r\n  \"png\",\r\n  \"jpg\",\r\n  \"jpeg\",\r\n  \"webp\",\r\n  \"doc\",\r\n  \"docx\",\r\n  \"xls\",\r\n  \"xlsx\",\r\n  \"csv\",\r\n  \"txt\",\r\n]);\r\nconst DEFAULT_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES = new Set([\r\n  \"application/pdf\",\r\n  \"image/png\",\r\n  \"image/jpeg\",\r\n  \"image/webp\",\r\n  \"application/msword\",\r\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\r\n  \"application/vnd.ms-excel\",\r\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\r\n  \"text/csv\",\r\n  \"text/plain\",\r\n]);\r\n\r\nfunction env(name, fallback) {\r\n  const value = String(process.env[name] || \"\").trim();\r\n  return value || fallback;\r\n}\r\n\r\nfunction parseBooleanEnv(name, fallbackValue = false) {\r\n  const raw = String(process.env[name] || \"\")\r\n    .trim()\r\n    .toLowerCase();\r\n  if (!raw) {\r\n    return fallbackValue;\r\n  }\r\n  return raw === \"true\" || raw === \"1\" || raw === \"yes\";\r\n}\r\n\r\nfunction parseCsvSet(value, fallbackSet) {\r\n  const normalized = String(value || \"\")\r\n    .split(\",\")\r\n    .map((item) => String(item || \"\").trim().toLowerCase())\r\n    .filter(Boolean);\r\n  if (normalized.length === 0) {\r\n    return new Set([...fallbackSet]);\r\n  }\r\n  return new Set(normalized);\r\n}\r\n\r\nfunction parseIntegerEnv(name, fallbackValue, { min = 1, max = Number.MAX_SAFE_INTEGER } = {}) {\r\n  const parsed = Number.parseInt(String(process.env[name] || \"\").trim(), 10);\r\n  if (!Number.isFinite(parsed)) {\r\n    return fallbackValue;\r\n  }\r\n  return Math.min(max, Math.max(min, parsed));\r\n}\r\n\r\nfunction getIncidentEvidenceValidationConfig() {\r\n  return {\r\n    maxBytes: parseIntegerEnv(\"CLIO_INCIDENT_EVIDENCE_MAX_BYTES\", DEFAULT_INCIDENT_EVIDENCE_MAX_BYTES, {\r\n      min: 128 * 1024,\r\n      max: 50 * 1024 * 1024,\r\n    }),\r\n    allowedExtensions: parseCsvSet(\r\n      process.env.CLIO_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS,\r\n      DEFAULT_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS,\r\n    ),\r\n    allowedMimeTypes: parseCsvSet(\r\n      process.env.CLIO_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES,\r\n      DEFAULT_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES,\r\n    ),\r\n  };\r\n}\r\n\r\nfunction isInviteDeliveryRequired() {\r\n  const defaultRequired = process.env.NODE_ENV === \"production\";\r\n  return parseBooleanEnv(\"CLIO_REQUIRE_EMAIL_DELIVERY\", defaultRequired);\r\n}\r\n\r\nfunction extractDeliveryErrorInfo(reason) {\r\n  const normalized = String(reason || \"\").trim();\r\n  if (normalized.startsWith(\"email_delivery_failed:\")) {\r\n    return {\r\n      code: \"email_delivery_failed\",\r\n      providerMessage: normalized.slice(\"email_delivery_failed:\".length).trim(),\r\n    };\r\n  }\r\n\r\n  return {\r\n    code: normalized || \"email_delivery_failed\",\r\n    providerMessage: \"\",\r\n  };\r\n}\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction addYearsToIso(isoTimestamp, years) {\r\n  const base = new Date(isoTimestamp);\r\n  if (Number.isNaN(base.getTime())) {\r\n    const fallback = new Date();\r\n    fallback.setUTCFullYear(fallback.getUTCFullYear() + years);\r\n    return fallback.toISOString();\r\n  }\r\n  base.setUTCFullYear(base.getUTCFullYear() + years);\r\n  return base.toISOString();\r\n}\r\n\r\nfunction getArchiveRetentionYears() {\r\n  const raw = Number.parseInt(String(process.env.CLIO_RETENTION_YEARS || \"\").trim(), 10);\r\n  if (!Number.isFinite(raw) || raw < 1) {\r\n    return DEFAULT_ARCHIVE_RETENTION_YEARS;\r\n  }\r\n  return Math.min(raw, 25);\r\n}\r\n\r\nfunction asString(value, fallback = \"\") {\r\n  const normalized = String(value ?? \"\").trim();\r\n  return normalized || fallback;\r\n}\r\n\r\nfunction normalizeText(value) {\r\n  return String(value || \"\")\r\n    .trim()\r\n    .toLowerCase();\r\n}\r\n\r\nfunction normalizeEmail(value) {\r\n  return String(value || \"\").trim().toLowerCase();\r\n}\r\n\r\nfunction normalizeRoleKey(value) {\r\n  return String(value || \"\")\r\n    .trim()\r\n    .toUpperCase()\r\n    .replace(/[^A-Z0-9]+/g, \"_\")\r\n    .replace(/^_+|_+$/g, \"\");\r\n}\r\n\r\nfunction normalizeReferenceKind(value) {\r\n  const normalized = String(value || \"\")\r\n    .trim()\r\n    .toLowerCase();\r\n  return ALLOWED_REFERENCE_KINDS.has(normalized) ? normalized : \"\";\r\n}\r\n\r\nfunction normalizeReferenceLabel(value) {\r\n  return String(value || \"\")\r\n    .trim()\r\n    .replace(/\\s+/g, \" \");\r\n}\r\n\r\nfunction normalizeDepartmentKey(value) {\r\n  return String(value || \"\")\r\n    .trim()\r\n    .toLowerCase()\r\n    .replace(/[^a-z0-9]+/g, \"-\")\r\n    .replace(/^-+|-+$/g, \"\");\r\n}\r\n\r\nfunction normalizeReferenceKey(kind, value) {\r\n  const normalizedKind = normalizeReferenceKind(kind);\r\n  if (!normalizedKind) {\r\n    return \"\";\r\n  }\r\n  if (normalizedKind === \"role\") {\r\n    return normalizeRoleKey(value);\r\n  }\r\n  return normalizeDepartmentKey(value);\r\n}\r\n\r\nfunction buildSystemReferenceCatalog() {\r\n  const roles = SYSTEM_REFERENCE_ROLES.map((entry) => {\r\n    const value = asString(entry.value);\r\n    const label = asString(entry.label, value);\r\n    const key = normalizeReferenceKey(\"role\", value || label);\r\n    return {\r\n      id: `system-role-${key}`,\r\n      kind: \"role\",\r\n      key,\r\n      value,\r\n      label,\r\n      isSystem: true,\r\n      createdAt: \"\",\r\n      updatedAt: \"\",\r\n    };\r\n  });\r\n\r\n  const departments = SYSTEM_REFERENCE_DEPARTMENTS.map((entry) => {\r\n    const label = asString(entry);\r\n    const key = normalizeReferenceKey(\"department\", label);\r\n    return {\r\n      id: `system-department-${key}`,\r\n      kind: \"department\",\r\n      key,\r\n      value: label,\r\n      label,\r\n      isSystem: true,\r\n      createdAt: \"\",\r\n      updatedAt: \"\",\r\n    };\r\n  });\r\n\r\n  return {\r\n    roles,\r\n    departments,\r\n  };\r\n}\r\n\r\nfunction sortReferenceCatalogItems(items) {\r\n  return [...items].sort((left, right) => {\r\n    if (Boolean(left?.isSystem) !== Boolean(right?.isSystem)) {\r\n      return left?.isSystem ? -1 : 1;\r\n    }\r\n    return String(left?.label || \"\").localeCompare(String(right?.label || \"\"), undefined, {\r\n      sensitivity: \"base\",\r\n    });\r\n  });\r\n}\r\n\r\nfunction asArray(value) {\r\n  return Array.isArray(value) ? value : [];\r\n}\r\n\r\nfunction asObject(value, fallback = {}) {\r\n  if (value && typeof value === \"object\" && !Array.isArray(value)) {\r\n    return value;\r\n  }\r\n  return fallback;\r\n}\r\n\r\nfunction asBoolean(value, fallback = false) {\r\n  if (typeof value === \"boolean\") {\r\n    return value;\r\n  }\r\n  if (typeof value === \"number\") {\r\n    return value !== 0;\r\n  }\r\n  if (typeof value === \"string\") {\r\n    const normalized = value.trim().toLowerCase();\r\n    if (!normalized) {\r\n      return fallback;\r\n    }\r\n    if ([\"true\", \"1\", \"yes\", \"y\", \"on\"].includes(normalized)) {\r\n      return true;\r\n    }\r\n    if ([\"false\", \"0\", \"no\", \"n\", \"off\"].includes(normalized)) {\r\n      return false;\r\n    }\r\n  }\r\n  return fallback;\r\n}\r\n\r\nfunction normalizeEmployeeDocumentsPayload(documents, { actorEmail, now } = {}) {\r\n  const fallbackActor = normalizeEmail(actorEmail) || \"system@gmail.com\";\r\n  const fallbackAt = asString(now, nowIso());\r\n  return asArray(documents)\r\n    .map((entry, index) => {\r\n      const source = asObject(entry, {});\r\n      const uploadedAt = asString(source.uploadedAt, fallbackAt);\r\n      const uploadedBy = normalizeEmail(source.uploadedBy || fallbackActor) || fallbackActor;\r\n      const sizeRaw = Number(source.sizeBytes);\r\n      return {\r\n        id: asString(source.id),\r\n        name: asString(source.name, \"Employee Document\"),\r\n        type: asString(source.type, \"General\"),\r\n        ref: asString(source.ref),\r\n        storagePath: asString(source.storagePath),\r\n        contentType: asString(source.contentType),\r\n        sizeBytes: Number.isFinite(sizeRaw) && sizeRaw >= 0 ? sizeRaw : 0,\r\n        uploadedAt,\r\n        uploadedBy,\r\n        order: Number.isFinite(Number(source.order)) ? Number(source.order) : index,\r\n      };\r\n    })\r\n    .filter((entry) => entry.ref || entry.name);\r\n}\r\n\r\nasync function listEmployeeDocumentSubcollectionById(recordId, { db } = {}) {\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    return [];\r\n  }\r\n\r\n  const database = db || getDbOrThrow();\r\n  const employeesCollection = getCollectionName(\"employees\");\r\n  const subcollectionName = getEmployeeDocumentsSubcollectionName();\r\n  const snapshot = await getDocs(collection(database, employeesCollection, normalizedId, subcollectionName));\r\n  return snapshot.docs\r\n    .map((item, index) => {\r\n      const payload = normalizeEmployeeDocumentsPayload([item.data()], {\r\n        now: nowIso(),\r\n      })[0];\r\n      if (!payload) {\r\n        return null;\r\n      }\r\n      return {\r\n        ...payload,\r\n        id: item.id,\r\n        recordId: item.id,\r\n        order: Number.isFinite(Number(payload.order)) ? Number(payload.order) : index,\r\n      };\r\n    })\r\n    .filter(Boolean)\r\n    .sort((left, right) => {\r\n      const leftTime = new Date(left.uploadedAt || 0).getTime();\r\n      const rightTime = new Date(right.uploadedAt || 0).getTime();\r\n      if (Number.isFinite(leftTime) && Number.isFinite(rightTime) && rightTime !== leftTime) {\r\n        return rightTime - leftTime;\r\n      }\r\n      return Number(left.order || 0) - Number(right.order || 0);\r\n    });\r\n}\r\n\r\nasync function deleteEmployeeDocumentSubcollectionById(recordId, { db } = {}) {\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    return 0;\r\n  }\r\n\r\n  const database = db || getDbOrThrow();\r\n  const employeesCollection = getCollectionName(\"employees\");\r\n  const subcollectionName = getEmployeeDocumentsSubcollectionName();\r\n  const snapshot = await getDocs(collection(database, employeesCollection, normalizedId, subcollectionName));\r\n  let removed = 0;\r\n  for (const item of snapshot.docs) {\r\n    await deleteDoc(item.ref);\r\n    removed += 1;\r\n  }\r\n  return removed;\r\n}\r\n\r\nasync function replaceEmployeeDocumentSubcollectionById(recordId, documents, { actorEmail, db } = {}) {\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    throw new Error(\"invalid_record_id\");\r\n  }\r\n\r\n  const database = db || getDbOrThrow();\r\n  const employeesCollection = getCollectionName(\"employees\");\r\n  const subcollectionName = getEmployeeDocumentsSubcollectionName();\r\n  const collectionRef = collection(database, employeesCollection, normalizedId, subcollectionName);\r\n  const normalizedDocuments = normalizeEmployeeDocumentsPayload(documents, {\r\n    actorEmail,\r\n    now: nowIso(),\r\n  });\r\n\r\n  await deleteEmployeeDocumentSubcollectionById(normalizedId, { db: database });\r\n  const created = [];\r\n  for (const item of normalizedDocuments) {\r\n    const payload = {\r\n      name: item.name,\r\n      type: item.type,\r\n      ref: item.ref,\r\n      storagePath: item.storagePath,\r\n      contentType: item.contentType,\r\n      sizeBytes: item.sizeBytes,\r\n      uploadedAt: item.uploadedAt,\r\n      uploadedBy: item.uploadedBy,\r\n      order: item.order,\r\n    };\r\n    const createdRef = await addDoc(collectionRef, payload);\r\n    created.push({\r\n      ...payload,\r\n      id: createdRef.id,\r\n      recordId: createdRef.id,\r\n    });\r\n  }\r\n\r\n  return created\r\n    .sort((left, right) => new Date(right.uploadedAt || 0).getTime() - new Date(left.uploadedAt || 0).getTime())\r\n    .map((item, index) => ({\r\n      ...item,\r\n      order: Number.isFinite(Number(item.order)) ? Number(item.order) : index,\r\n    }));\r\n}\r\n\r\nfunction resolveEmployeeDocumentsForResponse(record, subcollectionDocs = []) {\r\n  if (Array.isArray(subcollectionDocs) && subcollectionDocs.length > 0) {\r\n    return subcollectionDocs;\r\n  }\r\n  return normalizeEmployeeDocumentsPayload(record?.documents, {\r\n    actorEmail: record?.updatedBy || record?.createdBy,\r\n    now: record?.updatedAt || record?.createdAt || nowIso(),\r\n  });\r\n}\r\n\r\nfunction withEmployeeDocuments(record, documents = []) {\r\n  const normalized = Array.isArray(documents) ? documents : [];\r\n  return {\r\n    ...record,\r\n    documents: normalized,\r\n    documentsCount: normalized.length,\r\n  };\r\n}\r\n\r\nasync function resolveAndMigrateEmployeeDocuments(record, { db } = {}) {\r\n  if (!record?.id) {\r\n    return [];\r\n  }\r\n\r\n  const documentsFromSubcollection = await listEmployeeDocumentSubcollectionById(record.id, { db });\r\n  if (documentsFromSubcollection.length > 0) {\r\n    return documentsFromSubcollection;\r\n  }\r\n\r\n  const legacyDocuments = resolveEmployeeDocumentsForResponse(record, []);\r\n  if (legacyDocuments.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  const migrated = await replaceEmployeeDocumentSubcollectionById(record.id, legacyDocuments, {\r\n    actorEmail: record.updatedBy || record.createdBy,\r\n    db,\r\n  });\r\n  await clearLegacyEmployeeDocumentsField(record.id, {\r\n    documentsCount: migrated.length,\r\n    db,\r\n  });\r\n  return migrated;\r\n}\r\n\r\nasync function clearLegacyEmployeeDocumentsField(recordId, { documentsCount, db } = {}) {\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    return;\r\n  }\r\n\r\n  const database = db || getDbOrThrow();\r\n  const patch = {\r\n    documents: deleteField(),\r\n  };\r\n  if (Number.isFinite(Number(documentsCount))) {\r\n    patch.documentsCount = Math.max(0, Number(documentsCount));\r\n  }\r\n  await updateDoc(doc(database, getCollectionName(\"employees\"), normalizedId), patch);\r\n}\r\n\r\nfunction toEmployeeDocumentMergeKey(document) {\r\n  const storagePath = asString(document?.storagePath);\r\n  if (storagePath) {\r\n    return `path:${storagePath}`;\r\n  }\r\n  const ref = asString(document?.ref);\r\n  if (ref) {\r\n    return `ref:${ref}`;\r\n  }\r\n  return `fallback:${asString(document?.name)}|${Number.isFinite(Number(document?.sizeBytes)) ? Number(document.sizeBytes) : 0}|${asString(\r\n    document?.uploadedAt,\r\n  )}`;\r\n}\r\n\r\nfunction mergeEmployeeDocuments(existingDocuments, incomingDocuments) {\r\n  const merged = [];\r\n  const seen = new Set();\r\n  let addedCount = 0;\r\n\r\n  const pushUnique = (entry, trackAdded = false) => {\r\n    const normalized = normalizeEmployeeDocumentsPayload([entry], {\r\n      actorEmail: entry?.uploadedBy,\r\n      now: entry?.uploadedAt,\r\n    })[0];\r\n    if (!normalized) {\r\n      return;\r\n    }\r\n    const key = toEmployeeDocumentMergeKey(normalized);\r\n    if (seen.has(key)) {\r\n      return;\r\n    }\r\n    seen.add(key);\r\n    merged.push(normalized);\r\n    if (trackAdded) {\r\n      addedCount += 1;\r\n    }\r\n  };\r\n\r\n  asArray(existingDocuments).forEach((entry) => pushUnique(entry, false));\r\n  asArray(incomingDocuments).forEach((entry) => pushUnique(entry, true));\r\n\r\n  return {\r\n    merged,\r\n    addedCount,\r\n  };\r\n}\r\n\r\nfunction toOnboardingEvidenceDocuments(evidence, actorEmail) {\r\n  const now = nowIso();\r\n  const mapped = asArray(evidence).map((item) => {\r\n    const source = asObject(item, {});\r\n    return {\r\n      id: asString(source.id),\r\n      name: asString(source.name, \"Onboarding Document\"),\r\n      type: asString(source.type, \"Onboarding\"),\r\n      ref: asString(source.ref),\r\n      storagePath: asString(source.storagePath),\r\n      contentType: asString(source.contentType),\r\n      sizeBytes: Number.isFinite(Number(source.sizeBytes)) ? Number(source.sizeBytes) : 0,\r\n      uploadedAt: asString(source.uploadedAt, now),\r\n      uploadedBy: asString(source.uploadedBy, actorEmail),\r\n    };\r\n  });\r\n  return normalizeEmployeeDocumentsPayload(mapped, {\r\n    actorEmail,\r\n    now,\r\n  });\r\n}\r\n\r\nasync function syncOnboardingEvidenceToEmployeeDocuments(record, actorEmail) {\r\n  const category = asString(record?.category).toLowerCase();\r\n  if (!category.includes(\"onboarding\")) {\r\n    return {\r\n      synced: false,\r\n      addedCount: 0,\r\n    };\r\n  }\r\n\r\n  const employeeEmail = normalizeEmail(record?.employeeEmail);\r\n  if (!employeeEmail) {\r\n    return {\r\n      synced: false,\r\n      addedCount: 0,\r\n    };\r\n  }\r\n\r\n  const onboardingDocuments = toOnboardingEvidenceDocuments(record?.evidence, actorEmail);\r\n  if (onboardingDocuments.length === 0) {\r\n    return {\r\n      synced: false,\r\n      addedCount: 0,\r\n    };\r\n  }\r\n\r\n  const employeeRows = await listCollectionRecords(getCollectionName(\"employees\"), {\r\n    filterField: \"email\",\r\n    filterValue: employeeEmail,\r\n  });\r\n  const employeeRecord = employeeRows[0];\r\n  if (!employeeRecord?.id) {\r\n    return {\r\n      synced: false,\r\n      addedCount: 0,\r\n    };\r\n  }\r\n\r\n  const existingDocuments = await resolveAndMigrateEmployeeDocuments(employeeRecord);\r\n  const { merged, addedCount } = mergeEmployeeDocuments(existingDocuments, onboardingDocuments);\r\n  if (addedCount <= 0) {\r\n    return {\r\n      synced: false,\r\n      addedCount: 0,\r\n    };\r\n  }\r\n\r\n  const syncedDocuments = await replaceEmployeeDocumentSubcollectionById(employeeRecord.id, merged, {\r\n    actorEmail,\r\n  });\r\n  await clearLegacyEmployeeDocumentsField(employeeRecord.id, {\r\n    documentsCount: syncedDocuments.length,\r\n  });\r\n\r\n  return {\r\n    synced: true,\r\n    addedCount,\r\n    documentsCount: syncedDocuments.length,\r\n    employeeRecordId: employeeRecord.id,\r\n  };\r\n}\r\n\r\nasync function collectOnboardingEvidenceDocumentsByEmployeeEmail(employeeEmail, actorEmail) {\r\n  const normalizedEmail = normalizeEmail(employeeEmail);\r\n  if (!normalizedEmail) {\r\n    return [];\r\n  }\r\n\r\n  const lifecycleRows = await listCollectionRecords(getCollectionName(\"lifecycle\"), {\r\n    filterField: \"employeeEmail\",\r\n    filterValue: normalizedEmail,\r\n  });\r\n\r\n  const onboardingEvidenceDocuments = lifecycleRows\r\n    .filter((row) => asString(row?.category).toLowerCase().includes(\"onboarding\"))\r\n    .flatMap((row) => toOnboardingEvidenceDocuments(row?.evidence, actorEmail));\r\n\r\n  return mergeEmployeeDocuments([], onboardingEvidenceDocuments).merged;\r\n}\r\n\r\nfunction composeEmployeeName({ firstName, middleName, lastName, suffix, fallback }) {\r\n  return formatEmployeeName({\r\n    firstName: asString(firstName),\r\n    middleName: asString(middleName),\r\n    lastName: asString(lastName),\r\n    suffix: asString(suffix),\r\n    fallback: asString(fallback),\r\n    fallbackLabel: \"Employee\",\r\n  });\r\n}\r\n\r\nfunction normalizeLifecycleType(value) {\r\n  const normalized = String(value || \"\")\r\n    .trim()\r\n    .toLowerCase();\r\n  if (!normalized) {\r\n    return \"onboarding\";\r\n  }\r\n  if (normalized.includes(\"role\") || normalized.includes(\"promotion\")) {\r\n    return \"role-change\";\r\n  }\r\n  if (normalized.includes(\"disciplin\")) {\r\n    return \"disciplinary\";\r\n  }\r\n  if (normalized.includes(\"offboard\") || normalized.includes(\"resign\") || normalized.includes(\"terminate\")) {\r\n    return \"offboarding\";\r\n  }\r\n  if (normalized.includes(\"onboard\")) {\r\n    return \"onboarding\";\r\n  }\r\n  return \"onboarding\";\r\n}\r\n\r\nfunction getLifecycleTemplateByCategory(category) {\r\n  const type = normalizeLifecycleType(category);\r\n  return LIFECYCLE_WORKFLOW_TEMPLATES[type] || LIFECYCLE_WORKFLOW_TEMPLATES.onboarding;\r\n}\r\n\r\nfunction addHoursToIso(isoValue, hours) {\r\n  const timestamp = Number.isFinite(Number(hours)) ? Number(hours) : 0;\r\n  const base = new Date(isoValue || nowIso());\r\n  if (Number.isNaN(base.getTime())) {\r\n    return nowIso();\r\n  }\r\n  base.setTime(base.getTime() + Math.max(0, timestamp) * 60 * 60 * 1000);\r\n  return base.toISOString();\r\n}\r\n\r\nfunction normalizeRoleId(value) {\r\n  return String(value || \"\")\r\n    .trim()\r\n    .toUpperCase()\r\n    .replace(/[^A-Z0-9_]+/g, \"\");\r\n}\r\n\r\nfunction normalizeDecision(value) {\r\n  const normalized = String(value || \"\")\r\n    .trim()\r\n    .toLowerCase();\r\n  if (normalized === \"approve\" || normalized === \"approved\") {\r\n    return \"approved\";\r\n  }\r\n  if (normalized === \"reject\" || normalized === \"rejected\") {\r\n    return \"rejected\";\r\n  }\r\n  return \"\";\r\n}\r\n\r\nfunction buildChecklistFromTemplate(template, { atIso }) {\r\n  return asArray(template?.checklist)\r\n    .slice(0, MAX_LIFECYCLE_CHECKLIST_ITEMS)\r\n    .map((task, index) => {\r\n      const id = asString(task?.id, `task-${index + 1}`);\r\n      const slaHours = Number.parseInt(String(task?.slaHours || \"\"), 10);\r\n      return {\r\n        id,\r\n        label: asString(task?.label, id),\r\n        required: task?.required !== false,\r\n        status: \"Pending\",\r\n        dueAt: addHoursToIso(atIso, Number.isFinite(slaHours) && slaHours > 0 ? slaHours : 24),\r\n        completedAt: \"\",\r\n        completedBy: \"\",\r\n      };\r\n    });\r\n}\r\n\r\nfunction mergeChecklistWithTemplate(baseChecklist, templateChecklist) {\r\n  const existing = new Map();\r\n  asArray(baseChecklist).forEach((task) => {\r\n    const key = asString(task?.id);\r\n    if (key) {\r\n      existing.set(key, task);\r\n    }\r\n  });\r\n\r\n  return templateChecklist.map((task) => {\r\n    const previous = existing.get(task.id);\r\n    if (!previous) {\r\n      return task;\r\n    }\r\n    return {\r\n      ...task,\r\n      status: asString(previous.status, task.status),\r\n      dueAt: asString(previous.dueAt, task.dueAt),\r\n      completedAt: asString(previous.completedAt),\r\n      completedBy: asString(previous.completedBy),\r\n    };\r\n  });\r\n}\r\n\r\nfunction buildApprovalChain(requiredRoles, existingChain) {\r\n  const existingByRole = new Map();\r\n  asArray(existingChain).forEach((entry) => {\r\n    const role = normalizeRoleId(entry?.role);\r\n    if (role) {\r\n      existingByRole.set(role, entry);\r\n    }\r\n  });\r\n\r\n  return requiredRoles.map((role, index) => {\r\n    const previous = existingByRole.get(role);\r\n    return {\r\n      order: index + 1,\r\n      role,\r\n      status: asString(previous?.status, \"Pending\"),\r\n      decidedAt: asString(previous?.decidedAt),\r\n      decidedBy: asString(previous?.decidedBy),\r\n      note: asString(previous?.note),\r\n    };\r\n  });\r\n}\r\n\r\nfunction resolveApprovalState(approvalChain) {\r\n  const chain = asArray(approvalChain);\r\n  if (chain.length === 0) {\r\n    return \"Not Required\";\r\n  }\r\n  if (chain.some((step) => normalizeText(step?.status) === \"rejected\")) {\r\n    return \"Rejected\";\r\n  }\r\n  if (chain.length > 0 && chain.every((step) => normalizeText(step?.status) === \"approved\")) {\r\n    return \"Approved\";\r\n  }\r\n  return \"Pending\";\r\n}\r\n\r\nfunction summarizeChecklistProgress(checklist) {\r\n  const requiredTasks = checklist.filter((task) => task.required !== false);\r\n  const completedRequired = requiredTasks.filter((task) => normalizeText(task.status) === \"completed\").length;\r\n  const totalRequired = requiredTasks.length;\r\n  return {\r\n    completedRequired,\r\n    totalRequired,\r\n    percent: totalRequired === 0 ? 0 : Math.round((completedRequired / totalRequired) * 100),\r\n  };\r\n}\r\n\r\nfunction isLifecycleFinalStatusForEvidence(workflowType, statusValue) {\r\n  const workflow = normalizeText(workflowType);\r\n  const status = normalizeText(statusValue);\r\n  if (!workflow || !status) {\r\n    return false;\r\n  }\r\n\r\n  if (workflow === \"disciplinary\") {\r\n    return status.includes(\"approved\") || status.includes(\"completed\");\r\n  }\r\n\r\n  if (workflow === \"offboarding\") {\r\n    return (\r\n      status.includes(\"approved\") ||\r\n      status.includes(\"completed\") ||\r\n      status.includes(\"access revoked\") ||\r\n      status.includes(\"revoked\") ||\r\n      status.includes(\"resign\") ||\r\n      status.includes(\"terminated\")\r\n    );\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction summarizeLifecycleRequiredEvidence(workflowType, evidenceItems = []) {\r\n  const normalizedWorkflowType = normalizeText(workflowType);\r\n  const requiredRules = asArray(LIFECYCLE_REQUIRED_EVIDENCE_RULES[normalizedWorkflowType]);\r\n  if (requiredRules.length === 0) {\r\n    return {\r\n      required: [],\r\n      matched: [],\r\n      missing: [],\r\n      complete: true,\r\n    };\r\n  }\r\n\r\n  const normalizedEvidence = asArray(evidenceItems).map((entry) => {\r\n    const source = asObject(entry, {});\r\n    return normalizeText([source.name, source.type, source.note].filter(Boolean).join(\" \"));\r\n  });\r\n\r\n  const matched = [];\r\n  const missing = [];\r\n\r\n  requiredRules.forEach((rule) => {\r\n    const keywords = asArray(rule?.keywords).map((item) => normalizeText(item)).filter(Boolean);\r\n    const isMatch = normalizedEvidence.some((evidenceText) => keywords.some((keyword) => evidenceText.includes(keyword)));\r\n    const detail = {\r\n      id: asString(rule?.id),\r\n      label: asString(rule?.label),\r\n    };\r\n    if (isMatch) {\r\n      matched.push(detail);\r\n    } else {\r\n      missing.push(detail);\r\n    }\r\n  });\r\n\r\n  return {\r\n    required: requiredRules.map((rule) => ({\r\n      id: asString(rule?.id),\r\n      label: asString(rule?.label),\r\n    })),\r\n    matched,\r\n    missing,\r\n    complete: missing.length === 0,\r\n  };\r\n}\r\n\r\nfunction sanitizeWorkflowStageIndex(stageIndex, stagesLength) {\r\n  const parsed = Number.parseInt(String(stageIndex ?? \"\"), 10);\r\n  if (!Number.isFinite(parsed)) {\r\n    return 0;\r\n  }\r\n  return Math.max(0, Math.min(parsed, Math.max(0, stagesLength - 1)));\r\n}\r\n\r\nfunction resolveRequiredApproverRoles() {\r\n  return [];\r\n}\r\n\r\nfunction validateLifecycleTargetRolePermission({ actorRole, targetRole }) {\r\n  if (!targetRole) {\r\n    return;\r\n  }\r\n\r\n  const normalizedActorRole = normalizeRoleId(actorRole);\r\n  const normalizedTargetRole = normalizeRoleId(targetRole);\r\n\r\n  if (normalizedActorRole === \"SUPER_ADMIN\") {\r\n    return;\r\n  }\r\n\r\n  if (normalizedActorRole === \"GRC\") {\r\n    if (normalizedTargetRole === \"SUPER_ADMIN\") {\r\n      throw new Error(\"forbidden_target_role\");\r\n    }\r\n    if (!LIFECYCLE_ASSIGNABLE_BY_GRC.has(normalizedTargetRole)) {\r\n      throw new Error(\"invalid_target_role\");\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (normalizedActorRole === \"HR\" || normalizedActorRole === \"EA\") {\r\n    if (!LIFECYCLE_ASSIGNABLE_BY_PRIVILEGED.has(normalizedTargetRole)) {\r\n      throw new Error(\"forbidden_target_role\");\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (LIFECYCLE_PRIVILEGED_TARGET_ROLES.has(normalizedTargetRole)) {\r\n    throw new Error(\"forbidden_target_role\");\r\n  }\r\n\r\n  if (!LIFECYCLE_ASSIGNABLE_BY_PRIVILEGED.has(normalizedTargetRole)) {\r\n    throw new Error(\"invalid_target_role\");\r\n  }\r\n}\r\n\r\nfunction buildInitialLifecycleWorkflow({\r\n  template,\r\n  baseWorkflow,\r\n  requiredApprovers,\r\n  atIso,\r\n  actorEmail,\r\n}) {\r\n  const templateChecklist = buildChecklistFromTemplate(template, { atIso });\r\n  const checklist = mergeChecklistWithTemplate(baseWorkflow?.checklist, templateChecklist);\r\n  const approvalChain = buildApprovalChain(requiredApprovers, baseWorkflow?.approvalChain);\r\n  const stages = asArray(template?.stages).map((stage) => asString(stage)).filter(Boolean);\r\n  const stageIndex = sanitizeWorkflowStageIndex(baseWorkflow?.stageIndex ?? 0, stages.length);\r\n  const stage = asString(stages[stageIndex], \"Initiated\");\r\n  const stageHistory = appendTrail(baseWorkflow?.stageHistory, {\r\n    at: atIso,\r\n    by: actorEmail,\r\n    stage,\r\n  });\r\n  const progress = summarizeChecklistProgress(checklist);\r\n\r\n  return {\r\n    type: asString(template?.type, \"onboarding\"),\r\n    stageIndex,\r\n    stage,\r\n    stages,\r\n    checklist,\r\n    stageHistory,\r\n    approvalChain,\r\n    approvalState: resolveApprovalState(approvalChain),\r\n    progress,\r\n    slaDueAt: asString(baseWorkflow?.slaDueAt, addHoursToIso(atIso, Number.parseInt(String(template?.slaHours || 72), 10))),\r\n    slaBreached: false,\r\n    updatedAt: atIso,\r\n  };\r\n}\r\n\r\nfunction applyLifecycleWorkflowAction({\r\n  workflow,\r\n  evidence,\r\n  action,\r\n  actorEmail,\r\n  atIso,\r\n}) {\r\n  const nextWorkflow = {\r\n    ...workflow,\r\n    checklist: asArray(workflow.checklist).map((task) => ({ ...task })),\r\n    stageHistory: asArray(workflow.stageHistory).map((entry) => ({ ...entry })),\r\n  };\r\n  let nextEvidence = asArray(evidence).map((item) => ({ ...item }));\r\n  const actionType = normalizeText(action?.type);\r\n\r\n  if (!actionType) {\r\n    return {\r\n      workflow: nextWorkflow,\r\n      evidence: nextEvidence,\r\n    };\r\n  }\r\n\r\n  if (actionType === \"toggle-task\") {\r\n    const taskId = asString(action?.taskId);\r\n    if (!taskId) {\r\n      throw new Error(\"invalid_workflow_action\");\r\n    }\r\n\r\n    let matched = false;\r\n    nextWorkflow.checklist = nextWorkflow.checklist.map((task) => {\r\n      if (task.id !== taskId) {\r\n        return task;\r\n      }\r\n      matched = true;\r\n      const completed = Boolean(action?.completed);\r\n      return {\r\n        ...task,\r\n        status: completed ? \"Completed\" : \"Pending\",\r\n        completedAt: completed ? atIso : \"\",\r\n        completedBy: completed ? actorEmail : \"\",\r\n      };\r\n    });\r\n    if (!matched) {\r\n      throw new Error(\"invalid_workflow_action\");\r\n    }\r\n  } else if (actionType === \"set-stage\") {\r\n    const nextIndex = sanitizeWorkflowStageIndex(action?.stageIndex, asArray(nextWorkflow.stages).length);\r\n    const nextStage = asString(nextWorkflow.stages?.[nextIndex], nextWorkflow.stage);\r\n    nextWorkflow.stageIndex = nextIndex;\r\n    nextWorkflow.stage = nextStage;\r\n    nextWorkflow.stageHistory = appendTrail(nextWorkflow.stageHistory, {\r\n      at: atIso,\r\n      by: actorEmail,\r\n      stage: nextStage,\r\n      action: \"stage-update\",\r\n    });\r\n  } else if (actionType === \"add-evidence\") {\r\n    const evidenceEntry = asObject(action?.evidence, null);\r\n    if (!evidenceEntry) {\r\n      throw new Error(\"invalid_workflow_action\");\r\n    }\r\n    const evidenceId = asString(evidenceEntry.id, `evidence-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`);\r\n    nextEvidence = [\r\n      ...nextEvidence,\r\n      {\r\n        id: evidenceId,\r\n        name: asString(evidenceEntry.name, \"Evidence File\"),\r\n        ref: asString(evidenceEntry.ref),\r\n        storagePath: asString(evidenceEntry.storagePath),\r\n        contentType: asString(evidenceEntry.contentType),\r\n        sizeBytes: Number.isFinite(Number(evidenceEntry.sizeBytes)) ? Number(evidenceEntry.sizeBytes) : 0,\r\n        uploadedAt: asString(evidenceEntry.uploadedAt, atIso),\r\n        uploadedBy: asString(evidenceEntry.uploadedBy, actorEmail),\r\n        note: asString(evidenceEntry.note),\r\n      },\r\n    ].slice(-MAX_LIFECYCLE_EVIDENCE_ITEMS);\r\n  } else if (actionType === \"remove-evidence\") {\r\n    const evidenceId = asString(action?.evidenceId);\r\n    if (!evidenceId) {\r\n      throw new Error(\"invalid_workflow_action\");\r\n    }\r\n    nextEvidence = nextEvidence.filter((item) => asString(item?.id) !== evidenceId);\r\n  } else {\r\n    throw new Error(\"invalid_workflow_action\");\r\n  }\r\n\r\n  const progress = summarizeChecklistProgress(nextWorkflow.checklist);\r\n  nextWorkflow.progress = progress;\r\n  nextWorkflow.updatedAt = atIso;\r\n  nextWorkflow.slaBreached =\r\n    Boolean(nextWorkflow.slaDueAt) &&\r\n    new Date(nextWorkflow.slaDueAt).getTime() < new Date(atIso).getTime() &&\r\n    progress.completedRequired < progress.totalRequired;\r\n\r\n  return {\r\n    workflow: nextWorkflow,\r\n    evidence: nextEvidence,\r\n  };\r\n}\r\n\r\nfunction applyApprovalDecision({\r\n  workflow,\r\n  actorRole,\r\n  actorEmail,\r\n  decision,\r\n  note,\r\n  atIso,\r\n}) {\r\n  const normalizedDecision = normalizeDecision(decision);\r\n  if (!normalizedDecision) {\r\n    throw new Error(\"invalid_approval_decision\");\r\n  }\r\n\r\n  const chain = asArray(workflow?.approvalChain).map((step) => ({ ...step }));\r\n  const pendingIndex = chain.findIndex((step) => normalizeText(step?.status) === \"pending\");\r\n  if (pendingIndex < 0) {\r\n    throw new Error(\"no_pending_approval_step\");\r\n  }\r\n\r\n  const actorRoleId = normalizeRoleId(actorRole);\r\n  const expectedRole = normalizeRoleId(chain[pendingIndex]?.role);\r\n  if (!actorRoleId || actorRoleId !== expectedRole) {\r\n    throw new Error(\"approval_not_allowed_for_role\");\r\n  }\r\n\r\n  chain[pendingIndex] = {\r\n    ...chain[pendingIndex],\r\n    status: normalizedDecision === \"approved\" ? \"Approved\" : \"Rejected\",\r\n    decidedAt: atIso,\r\n    decidedBy: actorEmail,\r\n    note: asString(note),\r\n  };\r\n\r\n  if (normalizedDecision === \"rejected\") {\r\n    return {\r\n      workflow: {\r\n        ...workflow,\r\n        approvalChain: chain,\r\n        approvalState: \"Rejected\",\r\n        updatedAt: atIso,\r\n      },\r\n      status: \"Rejected\",\r\n    };\r\n  }\r\n\r\n  const approvalState = resolveApprovalState(chain);\r\n  const nextWorkflow = {\r\n    ...workflow,\r\n    approvalChain: chain,\r\n    approvalState,\r\n    updatedAt: atIso,\r\n  };\r\n\r\n  const nextStatus = approvalState === \"Approved\" ? \"Approved\" : asString(workflow?.status, \"Pending Approval\");\r\n  return {\r\n    workflow: nextWorkflow,\r\n    status: nextStatus,\r\n  };\r\n}\r\n\r\nfunction appendTrail(currentValue, entry) {\r\n  const trail = [...asArray(currentValue), entry];\r\n  if (trail.length <= MAX_AUDIT_TRAIL_ITEMS) {\r\n    return trail;\r\n  }\r\n  return trail.slice(trail.length - MAX_AUDIT_TRAIL_ITEMS);\r\n}\r\n\r\nfunction byRecentUpdated(a, b) {\r\n  return new Date(b.updatedAt || b.createdAt || 0).getTime() - new Date(a.updatedAt || a.createdAt || 0).getTime();\r\n}\r\n\r\nfunction getCollectionName(key) {\r\n  const map = {\r\n    employees: env(\"CLIO_FIRESTORE_EMPLOYEES_COLLECTION\", \"employees\"),\r\n    lifecycle: env(\"CLIO_FIRESTORE_LIFECYCLE_COLLECTION\", \"employment_lifecycle\"),\r\n    attendance: env(\"CLIO_FIRESTORE_ATTENDANCE_COLLECTION\", \"attendance\"),\r\n    leave: env(\"CLIO_FIRESTORE_LEAVE_COLLECTION\", \"leave_requests\"),\r\n    performance: env(\"CLIO_FIRESTORE_PERFORMANCE_COLLECTION\", \"performance_records\"),\r\n    templates: env(\"CLIO_FIRESTORE_TEMPLATES_COLLECTION\", \"document_templates\"),\r\n    exports: env(\"CLIO_FIRESTORE_EXPORTS_COLLECTION\", \"export_requests\"),\r\n    incidents: env(\"CLIO_FIRESTORE_INCIDENTS_COLLECTION\", \"security_incidents\"),\r\n    settingsReference: env(\"CLIO_FIRESTORE_SETTINGS_REFERENCE_COLLECTION\", \"settings_reference_data\"),\r\n  };\r\n  return map[key] || key;\r\n}\r\n\r\nfunction getEmployeeDocumentsSubcollectionName() {\r\n  return env(\"CLIO_FIRESTORE_EMPLOYEE_DOCUMENTS_SUBCOLLECTION\", \"documents\");\r\n}\r\n\r\nfunction getDbOrThrow() {\r\n  if (!isFirestoreEnabled()) {\r\n    throw new Error(\"firestore_not_configured\");\r\n  }\r\n  const db = getFirestoreDb();\r\n  if (!db) {\r\n    throw new Error(\"firestore_not_configured\");\r\n  }\r\n  return db;\r\n}\r\n\r\nasync function listCollectionRecords(collectionName, { filterField, filterValue } = {}) {\r\n  const db = getDbOrThrow();\r\n  const ref = collection(db, collectionName);\r\n  let snapshot;\r\n  if (filterField && typeof filterValue === \"string\" && filterValue.trim()) {\r\n    snapshot = await getDocs(query(ref, where(filterField, \"==\", filterValue.trim())));\r\n  } else {\r\n    snapshot = await getDocs(ref);\r\n  }\r\n\r\n  return snapshot.docs\r\n    .map((item) => ({\r\n      ...item.data(),\r\n      id: item.id,\r\n      recordId: item.id,\r\n    }))\r\n    .sort(byRecentUpdated);\r\n}\r\n\r\nasync function getCollectionRecordById(collectionName, recordId) {\r\n  const db = getDbOrThrow();\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    throw new Error(\"invalid_record_id\");\r\n  }\r\n\r\n  const ref = doc(db, collectionName, normalizedId);\r\n  const snapshot = await getDoc(ref);\r\n  if (!snapshot.exists()) {\r\n    return null;\r\n  }\r\n  return {\r\n    ...snapshot.data(),\r\n    id: snapshot.id,\r\n    recordId: snapshot.id,\r\n  };\r\n}\r\n\r\nasync function createCollectionRecord(collectionName, payload) {\r\n  const db = getDbOrThrow();\r\n  const ref = await addDoc(collection(db, collectionName), payload);\r\n  return {\r\n    ...payload,\r\n    id: ref.id,\r\n    recordId: ref.id,\r\n  };\r\n}\r\n\r\nasync function updateCollectionRecord(collectionName, recordId, payload) {\r\n  const db = getDbOrThrow();\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    throw new Error(\"invalid_record_id\");\r\n  }\r\n\r\n  const ref = doc(db, collectionName, normalizedId);\r\n  const snapshot = await getDoc(ref);\r\n  if (!snapshot.exists()) {\r\n    return null;\r\n  }\r\n\r\n  const current = snapshot.data() || {};\r\n  const next = {\r\n    ...current,\r\n    ...payload,\r\n  };\r\n  await updateDoc(ref, next);\r\n  return {\r\n    ...next,\r\n    id: snapshot.id,\r\n    recordId: snapshot.id,\r\n  };\r\n}\r\n\r\nasync function updateCollectionRecordsByField(collectionName, filterField, filterValue, buildPatch) {\r\n  const db = getDbOrThrow();\r\n  const normalized = asString(filterValue);\r\n  if (!normalized) {\r\n    return 0;\r\n  }\r\n\r\n  const snapshot = await getDocs(\r\n    query(collection(db, collectionName), where(filterField, \"==\", normalized)),\r\n  );\r\n\r\n  let updatedCount = 0;\r\n  for (const recordSnapshot of snapshot.docs) {\r\n    const current = recordSnapshot.data() || {};\r\n    const patch = buildPatch(current, recordSnapshot.id);\r\n    if (!patch || typeof patch !== \"object\" || Object.keys(patch).length === 0) {\r\n      continue;\r\n    }\r\n    await updateDoc(doc(db, collectionName, recordSnapshot.id), patch);\r\n    updatedCount += 1;\r\n  }\r\n\r\n  return updatedCount;\r\n}\r\n\r\nasync function deleteCollectionRecord(collectionName, recordId) {\r\n  const db = getDbOrThrow();\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    throw new Error(\"invalid_record_id\");\r\n  }\r\n\r\n  const ref = doc(db, collectionName, normalizedId);\r\n  const snapshot = await getDoc(ref);\r\n  if (!snapshot.exists()) {\r\n    return null;\r\n  }\r\n\r\n  await deleteDoc(ref);\r\n  return {\r\n    ...snapshot.data(),\r\n    id: snapshot.id,\r\n    recordId: snapshot.id,\r\n  };\r\n}\r\n\r\nfunction toReferenceCatalogItem(raw, kind) {\r\n  const normalizedKind = normalizeReferenceKind(kind || raw?.kind);\r\n  if (!normalizedKind) {\r\n    return null;\r\n  }\r\n\r\n  const valueSource = asString(raw?.value || raw?.label);\r\n  const labelSource = asString(raw?.label || raw?.value);\r\n  const value = valueSource || labelSource;\r\n  const label = labelSource || valueSource;\r\n  const key = normalizeReferenceKey(normalizedKind, value || label);\r\n  if (!value || !label || !key) {\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    id: asString(raw?.id || raw?.recordId),\r\n    kind: normalizedKind,\r\n    key,\r\n    value,\r\n    label,\r\n    isSystem: Boolean(raw?.isSystem),\r\n    createdAt: asString(raw?.createdAt),\r\n    updatedAt: asString(raw?.updatedAt),\r\n  };\r\n}\r\n\r\nexport async function listSettingsReferenceCatalogBackend() {\r\n  const collectionName = getCollectionName(\"settingsReference\");\r\n  const baseCatalog = buildSystemReferenceCatalog();\r\n  const rows = (await listCollectionRecords(collectionName)).slice(0, MAX_REFERENCE_CATALOG_ITEMS);\r\n\r\n  const roleByKey = new Map(baseCatalog.roles.map((item) => [item.key, item]));\r\n  const departmentByKey = new Map(baseCatalog.departments.map((item) => [item.key, item]));\r\n\r\n  rows.forEach((row) => {\r\n    const item = toReferenceCatalogItem(row);\r\n    if (!item) {\r\n      return;\r\n    }\r\n\r\n    if (item.kind === \"role\") {\r\n      if (!roleByKey.has(item.key)) {\r\n        roleByKey.set(item.key, item);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (!departmentByKey.has(item.key)) {\r\n      departmentByKey.set(item.key, item);\r\n    }\r\n  });\r\n\r\n  return {\r\n    roles: sortReferenceCatalogItems([...roleByKey.values()]),\r\n    departments: sortReferenceCatalogItems([...departmentByKey.values()]),\r\n  };\r\n}\r\n\r\nexport async function createSettingsReferenceItemBackend({ kind, label }, actorEmail) {\r\n  const normalizedKind = normalizeReferenceKind(kind);\r\n  if (!normalizedKind) {\r\n    throw new Error(\"invalid_reference_kind\");\r\n  }\r\n\r\n  const normalizedLabel = normalizeReferenceLabel(label);\r\n  if (!normalizedLabel || normalizedLabel.length > MAX_REFERENCE_LABEL_LENGTH) {\r\n    throw new Error(\"invalid_reference_label\");\r\n  }\r\n\r\n  const key = normalizeReferenceKey(normalizedKind, normalizedLabel);\r\n  if (!key) {\r\n    throw new Error(\"invalid_reference_label\");\r\n  }\r\n\r\n  const catalog = await listSettingsReferenceCatalogBackend();\r\n  const targetRows = normalizedKind === \"role\" ? catalog.roles : catalog.departments;\r\n  const alreadyExists = targetRows.some((entry) => entry.key === key);\r\n  if (alreadyExists) {\r\n    throw new Error(\"duplicate_reference_value\");\r\n  }\r\n\r\n  const timestamp = nowIso();\r\n  const payload = {\r\n    kind: normalizedKind,\r\n    key,\r\n    value: normalizedLabel,\r\n    label: normalizedLabel,\r\n    isSystem: false,\r\n    createdAt: timestamp,\r\n    createdBy: actorEmail,\r\n    updatedAt: timestamp,\r\n    updatedBy: actorEmail,\r\n  };\r\n\r\n  const created = await createCollectionRecord(getCollectionName(\"settingsReference\"), payload);\r\n  const item = toReferenceCatalogItem(created, normalizedKind);\r\n  if (!item) {\r\n    throw new Error(\"invalid_reference_label\");\r\n  }\r\n  return item;\r\n}\r\n\r\nexport async function deleteSettingsReferenceItemBackend({ kind, recordId }) {\r\n  const normalizedKind = normalizeReferenceKind(kind);\r\n  if (!normalizedKind) {\r\n    throw new Error(\"invalid_reference_kind\");\r\n  }\r\n\r\n  const normalizedRecordId = asString(recordId);\r\n  if (!normalizedRecordId || normalizedRecordId.startsWith(\"system-\")) {\r\n    throw new Error(\"immutable_reference_item\");\r\n  }\r\n\r\n  const current = await getCollectionRecordById(getCollectionName(\"settingsReference\"), normalizedRecordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n\r\n  const currentKind = normalizeReferenceKind(current.kind);\r\n  if (!currentKind || currentKind !== normalizedKind || current.isSystem === true) {\r\n    throw new Error(\"immutable_reference_item\");\r\n  }\r\n\r\n  const deleted = await deleteCollectionRecord(getCollectionName(\"settingsReference\"), normalizedRecordId);\r\n  return toReferenceCatalogItem(deleted, normalizedKind);\r\n}\r\n\r\nfunction normalizeEmployeeWritePayload(payload, actorEmail, { base } = {}) {\r\n  const timestamp = nowIso();\r\n  const employeeEmail = normalizeEmail(payload?.email || base?.email);\r\n  if (!employeeEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const baseGovernmentIds = asObject(base?.governmentIds, {});\r\n  const incomingGovernmentIds = asObject(payload?.governmentIds, {});\r\n  const governmentIds = {\r\n    ...baseGovernmentIds,\r\n    ...incomingGovernmentIds,\r\n  };\r\n\r\n  const basePayrollInformation = asObject(base?.payrollInformation, {});\r\n  const incomingPayrollInformation = asObject(payload?.payrollInformation, {});\r\n  const payrollInformation = {\r\n    ...basePayrollInformation,\r\n    ...incomingPayrollInformation,\r\n  };\r\n\r\n  const managerEmail = normalizeEmail(payload?.managerEmail || base?.managerEmail);\r\n  const contact = asString(payload?.contact, asString(base?.contact, \"-\"));\r\n  const address = asString(payload?.address, asString(base?.address, \"-\"));\r\n  const emergencyContact = asString(payload?.emergencyContact, asString(base?.emergencyContact, \"-\"));\r\n  const govId = asString(payload?.govId, asString(base?.govId, \"Masked\"));\r\n  const firstName = asString(payload?.firstName, asString(base?.firstName, \"\"));\r\n  const middleName = asString(payload?.middleName, asString(base?.middleName, \"\"));\r\n  const lastName = asString(payload?.lastName, asString(base?.lastName, \"\"));\r\n  const suffix = asString(payload?.suffix, asString(base?.suffix, \"\"));\r\n  const legacyName = asString(payload?.name, asString(base?.name, employeeEmail));\r\n  const composedName = composeEmployeeName({\r\n    firstName,\r\n    middleName,\r\n    lastName,\r\n    suffix,\r\n    fallback: legacyName || employeeEmail,\r\n  });\r\n\r\n  if (!governmentIds.primaryId) {\r\n    governmentIds.primaryId = govId;\r\n  }\r\n\r\n  const payloadHasDocuments = Object.prototype.hasOwnProperty.call(asObject(payload, {}), \"documents\");\r\n  const payloadDocuments = payloadHasDocuments ? asArray(payload?.documents) : null;\r\n  const baseDocumentsCountRaw = Number(base?.documentsCount);\r\n  const baseDocumentsCount = Number.isFinite(baseDocumentsCountRaw)\r\n    ? Math.max(0, baseDocumentsCountRaw)\r\n    : asArray(base?.documents).length;\r\n  const documentsCount = payloadDocuments ? payloadDocuments.length : baseDocumentsCount;\r\n\r\n  return {\r\n    employeeId: asString(payload?.employeeId, asString(base?.employeeId, `CL-${Date.now().toString().slice(-6)}`)),\r\n    name: composedName,\r\n    firstName,\r\n    middleName,\r\n    lastName,\r\n    suffix,\r\n    email: employeeEmail,\r\n    role: asString(payload?.role, asString(base?.role, \"EMPLOYEE_L1\")),\r\n    department: asString(payload?.department, asString(base?.department, \"-\")),\r\n    jobTitle: asString(payload?.jobTitle, asString(base?.jobTitle, \"-\")),\r\n    managerEmail,\r\n    hireDate: asString(payload?.hireDate, asString(base?.hireDate, \"\")),\r\n    employmentStatus: asString(payload?.employmentStatus, asString(base?.employmentStatus, \"Active Employee\")),\r\n    status: asString(payload?.status, asString(base?.status, \"Active\")),\r\n    governmentIds,\r\n    govId,\r\n    contact,\r\n    address,\r\n    emergencyContact,\r\n    contactInformation: {\r\n      primaryPhone: contact,\r\n      address,\r\n      emergencyContact,\r\n    },\r\n    payrollInformation,\r\n    payrollGroup: asString(payload?.payrollGroup, asString(base?.payrollGroup, \"-\")),\r\n    documentsCount,\r\n    classification: \"Restricted PII\",\r\n    createdAt: asString(base?.createdAt, timestamp),\r\n    createdBy: asString(base?.createdBy, actorEmail),\r\n    updatedAt: timestamp,\r\n    updatedBy: actorEmail,\r\n    activityHistory: appendTrail(base?.activityHistory, {\r\n      at: timestamp,\r\n      by: actorEmail,\r\n      action: base ? \"update\" : \"create\",\r\n    }),\r\n  };\r\n}\r\n\r\nexport async function listEmployeeRecordsBackend({ ownerEmail, includeDocuments = false } = {}) {\r\n  const rows = await listCollectionRecords(getCollectionName(\"employees\"), {\r\n    filterField: ownerEmail ? \"email\" : undefined,\r\n    filterValue: ownerEmail ? normalizeEmail(ownerEmail) : undefined,\r\n  });\r\n  if (!includeDocuments) {\r\n    return rows;\r\n  }\r\n\r\n  const enriched = await Promise.all(\r\n    rows.map(async (record) => {\r\n      const documents = await resolveAndMigrateEmployeeDocuments(record);\r\n      return withEmployeeDocuments(record, documents);\r\n    }),\r\n  );\r\n  return enriched;\r\n}\r\n\r\nexport async function getEmployeeRecordBackend(recordId, { includeDocuments = true } = {}) {\r\n  const record = await getCollectionRecordById(getCollectionName(\"employees\"), recordId);\r\n  if (!record || !includeDocuments) {\r\n    return record;\r\n  }\r\n\r\n  let documents = await resolveAndMigrateEmployeeDocuments(record);\r\n  if (documents.length === 0) {\r\n    const backfilledDocuments = await collectOnboardingEvidenceDocumentsByEmployeeEmail(\r\n      record.email,\r\n      record.updatedBy || record.createdBy,\r\n    );\r\n    if (backfilledDocuments.length > 0) {\r\n      documents = await replaceEmployeeDocumentSubcollectionById(record.id, backfilledDocuments, {\r\n        actorEmail: record.updatedBy || record.createdBy,\r\n      });\r\n      await clearLegacyEmployeeDocumentsField(record.id, {\r\n        documentsCount: documents.length,\r\n      });\r\n    }\r\n  }\r\n  return withEmployeeDocuments(record, documents);\r\n}\r\n\r\nexport async function createEmployeeRecordBackend(payload, actorEmail) {\r\n  const normalized = normalizeEmployeeWritePayload(payload, actorEmail);\r\n  const created = await createCollectionRecord(getCollectionName(\"employees\"), normalized);\r\n  const payloadDocuments = asArray(payload?.documents);\r\n  if (payloadDocuments.length === 0) {\r\n    return withEmployeeDocuments(created, []);\r\n  }\r\n\r\n  const syncedDocuments = await replaceEmployeeDocumentSubcollectionById(created.id, payloadDocuments, {\r\n    actorEmail,\r\n  });\r\n  await clearLegacyEmployeeDocumentsField(created.id, {\r\n    documentsCount: syncedDocuments.length,\r\n  });\r\n  return withEmployeeDocuments(created, syncedDocuments);\r\n}\r\n\r\nexport async function updateEmployeeRecordBackend(recordId, payload, actorEmail) {\r\n  const current = await getEmployeeRecordBackend(recordId, { includeDocuments: true });\r\n  if (!current) {\r\n    return null;\r\n  }\r\n  const payloadHasDocuments = Object.prototype.hasOwnProperty.call(asObject(payload, {}), \"documents\");\r\n  const payloadDocuments = payloadHasDocuments ? asArray(payload?.documents) : null;\r\n  const normalized = normalizeEmployeeWritePayload(payload, actorEmail, { base: current });\r\n  const updated = await updateCollectionRecord(getCollectionName(\"employees\"), recordId, normalized);\r\n  if (!updated) {\r\n    return null;\r\n  }\r\n\r\n  if (payloadDocuments) {\r\n    const syncedDocuments = await replaceEmployeeDocumentSubcollectionById(recordId, payloadDocuments, {\r\n      actorEmail,\r\n    });\r\n    await clearLegacyEmployeeDocumentsField(recordId, {\r\n      documentsCount: syncedDocuments.length,\r\n    });\r\n    return withEmployeeDocuments(updated, syncedDocuments);\r\n  }\r\n\r\n  const documents = await resolveAndMigrateEmployeeDocuments(updated);\r\n  return withEmployeeDocuments(updated, documents);\r\n}\r\n\r\nexport async function deleteEmployeeRecordBackend(recordId) {\r\n  await deleteEmployeeDocumentSubcollectionById(recordId);\r\n  return await deleteCollectionRecord(getCollectionName(\"employees\"), recordId);\r\n}\r\n\r\nfunction normalizeLifecyclePayload(payload, actorEmail, actorRole, { base } = {}) {\r\n  const timestamp = nowIso();\r\n  const category = asString(payload?.category, asString(base?.category, \"Onboarding\"));\r\n  const employeeEmail = normalizeEmail(payload?.employeeEmail || base?.employeeEmail);\r\n  if (!employeeEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const baseDetails = asObject(base?.details, {});\r\n  const incomingDetails = asObject(payload?.details, {});\r\n  const details = {\r\n    ...baseDetails,\r\n    ...incomingDetails,\r\n  };\r\n\r\n  const template = getLifecycleTemplateByCategory(category);\r\n  const requiredApprovers = resolveRequiredApproverRoles(template, details);\r\n  const baseWorkflow = asObject(base?.workflow, {});\r\n  const workflowPatch = asObject(payload?.workflow, {});\r\n  const workflowSeed = {\r\n    ...baseWorkflow,\r\n    ...workflowPatch,\r\n  };\r\n\r\n  const workflow = buildInitialLifecycleWorkflow({\r\n    template,\r\n    baseWorkflow: workflowSeed,\r\n    requiredApprovers,\r\n    atIso: timestamp,\r\n    actorEmail,\r\n  });\r\n\r\n  const action = payload?.workflowAction && typeof payload.workflowAction === \"object\" ? payload.workflowAction : null;\r\n  const withAction = applyLifecycleWorkflowAction({\r\n    workflow,\r\n    evidence: asArray(base?.evidence),\r\n    action,\r\n    actorEmail,\r\n    atIso: timestamp,\r\n  });\r\n\r\n  const progress = summarizeChecklistProgress(withAction.workflow.checklist);\r\n  withAction.workflow.progress = progress;\r\n  withAction.workflow.slaBreached =\r\n    Boolean(withAction.workflow.slaDueAt) &&\r\n    new Date(withAction.workflow.slaDueAt).getTime() < new Date(timestamp).getTime() &&\r\n    progress.completedRequired < progress.totalRequired;\r\n  withAction.workflow.approvalState = resolveApprovalState(withAction.workflow.approvalChain);\r\n\r\n  const requestedStatus = asString(payload?.status, asString(base?.status, \"In Progress\"));\r\n  const status = requestedStatus;\r\n  const workflowType = asString(template.type, \"onboarding\");\r\n  const workflowActionType = normalizeText(action?.type);\r\n  const requiredEvidence = summarizeLifecycleRequiredEvidence(workflowType, withAction.evidence);\r\n  const mustEnforceRequiredEvidence = isLifecycleFinalStatusForEvidence(workflowType, status);\r\n  if (mustEnforceRequiredEvidence && requiredEvidence.missing.length > 0 && workflowActionType !== \"add-evidence\") {\r\n    throw new Error(\"lifecycle_required_evidence_missing\");\r\n  }\r\n\r\n  return {\r\n    employeeEmail,\r\n    employee: asString(payload?.employee, asString(base?.employee, employeeEmail || \"Unknown Employee\")),\r\n    category,\r\n    workflowType,\r\n    owner: asString(payload?.owner, asString(base?.owner, \"HR Operations\")),\r\n    details,\r\n    evidence: withAction.evidence,\r\n    requiredEvidence,\r\n    workflow: withAction.workflow,\r\n    status,\r\n    createdAt: asString(base?.createdAt, timestamp),\r\n    createdBy: asString(base?.createdBy, actorEmail),\r\n    updatedAt: timestamp,\r\n    updatedBy: actorEmail,\r\n    traceability: appendTrail(base?.traceability, {\r\n      at: timestamp,\r\n      by: actorEmail,\r\n      action: base ? \"update\" : \"create\",\r\n      category,\r\n      status,\r\n      stage: withAction.workflow.stage,\r\n      checklistProgress: withAction.workflow.progress.percent,\r\n      approvalState: withAction.workflow.approvalState,\r\n    }),\r\n  };\r\n}\r\n\r\nfunction shouldTriggerAccessRevocation(record) {\r\n  const category = asString(record?.category).toLowerCase();\r\n  const status = asString(record?.status).toLowerCase();\r\n  return (\r\n    category.includes(\"offboarding\") ||\r\n    status.includes(\"resign\") ||\r\n    status.includes(\"terminated\") ||\r\n    status.includes(\"access revoked\")\r\n  );\r\n}\r\n\r\nfunction shouldApplyLifecycleRoleSync(record) {\r\n  const category = asString(record?.category).toLowerCase();\r\n  const status = asString(record?.status).toLowerCase();\r\n  const isRoleMovement = category.includes(\"role change\") || category.includes(\"promotion\");\r\n  const isFinalized = status.includes(\"approved\") || status.includes(\"completed\");\r\n  return isRoleMovement && isFinalized;\r\n}\r\n\r\nfunction shouldApplyLifecycleArchivePolicy(record) {\r\n  const category = asString(record?.category).toLowerCase();\r\n  const status = asString(record?.status).toLowerCase();\r\n  const exitStatusDetected =\r\n    status.includes(\"resign\") || status.includes(\"terminated\") || status.includes(\"access revoked\");\r\n  const finalizedOffboarding =\r\n    category.includes(\"offboarding\") &&\r\n    (status.includes(\"approved\") || status.includes(\"completed\") || status.includes(\"revoked\"));\r\n  return exitStatusDetected || finalizedOffboarding;\r\n}\r\n\r\nfunction shouldApplyOnboardingActivation(record) {\r\n  const category = asString(record?.category).toLowerCase();\r\n  const status = asString(record?.status).toLowerCase();\r\n  const hasEmployeeEmail = Boolean(normalizeEmail(record?.employeeEmail));\r\n  const isOnboarding = category.includes(\"onboarding\");\r\n  const isFinalized = status.includes(\"approved\") || status.includes(\"completed\");\r\n  return hasEmployeeEmail && isOnboarding && isFinalized;\r\n}\r\n\r\nfunction shouldTriggerOnboardingInvite(record) {\r\n  const category = asString(record?.category).toLowerCase();\r\n  const hasEmployeeEmail = Boolean(normalizeEmail(record?.employeeEmail));\r\n  return hasEmployeeEmail && category.includes(\"onboarding\");\r\n}\r\n\r\nfunction resolveLifecycleInviteRole(record) {\r\n  const details = asObject(record?.details, {});\r\n  const roleRaw = asString(details?.roleTo || details?.role || details?.roleFrom);\r\n  if (!roleRaw) {\r\n    return \"EMPLOYEE_L1\";\r\n  }\r\n  const normalized = normalizeRoleKey(roleRaw);\r\n  if (!normalized) {\r\n    return \"EMPLOYEE_L1\";\r\n  }\r\n  return LIFECYCLE_ROLE_ALIAS.get(normalized) || normalized || \"EMPLOYEE_L1\";\r\n}\r\n\r\nasync function triggerOnboardingInvite(record, actorEmail, actorRole, { requestOrigin = \"\" } = {}) {\r\n  const normalizedEmail = normalizeEmail(record?.employeeEmail);\r\n  if (!normalizedEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const existingAccount = await getLoginAccount(normalizedEmail).catch(() => null);\r\n  const existingStatus = asString(existingAccount?.status).toLowerCase();\r\n  if (existingStatus === \"active\") {\r\n    return {\r\n      type: \"onboarding-invite-skipped\",\r\n      message: \"User account is already active. Invite was not reissued.\",\r\n      accountStatus: \"active\",\r\n    };\r\n  }\r\n\r\n  const inviteRole = resolveLifecycleInviteRole(record);\r\n  validateLifecycleTargetRolePermission({\r\n    actorRole,\r\n    targetRole: inviteRole,\r\n  });\r\n  const result = await inviteUserAccount({\r\n    email: normalizedEmail,\r\n    role: inviteRole,\r\n    invitedBy: actorEmail,\r\n  });\r\n\r\n  const enforceDelivery = isInviteDeliveryRequired();\r\n  let delivery = null;\r\n  try {\r\n    delivery = await deliverInviteEmail({\r\n      toEmail: result.user.email,\r\n      role: result.user.role,\r\n      invitedBy: actorEmail,\r\n      expiresAt: result.invite.expiresAt,\r\n      inviteToken: result.invite.token,\r\n      requestOrigin,\r\n    });\r\n  } catch (deliveryError) {\r\n    const rawReason = deliveryError instanceof Error ? deliveryError.message : \"email_delivery_failed\";\r\n    const deliveryErrorInfo = extractDeliveryErrorInfo(rawReason);\r\n    if (enforceDelivery) {\r\n      await revokeInviteById(result.invite.id).catch(() => null);\r\n      throw new Error(deliveryErrorInfo.code || \"email_delivery_failed\");\r\n    }\r\n\r\n    delivery = {\r\n      provider: \"unavailable\",\r\n      status: \"failed\",\r\n      messageId: null,\r\n      reason: deliveryErrorInfo.code || \"email_delivery_failed\",\r\n      providerMessage: deliveryErrorInfo.providerMessage || null,\r\n    };\r\n  }\r\n\r\n  return {\r\n    type: \"onboarding-invite\",\r\n    message:\r\n      delivery?.status === \"failed\"\r\n        ? \"Onboarding invite was created. Email delivery failed in test mode.\"\r\n        : delivery?.provider === \"firebase\"\r\n          ? \"Onboarding invite sent via Firebase email-link template. User must verify email to open the CLIO account, then complete SMS OTP.\"\r\n          : \"Onboarding invite sent. User must verify email to open the CLIO account, then complete SMS OTP.\",\r\n    inviteId: result.invite.id,\r\n    inviteStatus: result.invite.status,\r\n    role: result.user.role,\r\n    deliveryProvider: delivery?.provider || \"unknown\",\r\n    deliveryStatus: delivery?.status || \"unknown\",\r\n  };\r\n}\r\n\r\nfunction resolveLifecycleRoleTarget(record) {\r\n  const details = asObject(record?.details, {});\r\n  const roleToRaw = asString(details?.roleTo);\r\n  if (!roleToRaw) {\r\n    return \"\";\r\n  }\r\n\r\n  const normalized = normalizeRoleKey(roleToRaw);\r\n  return LIFECYCLE_ROLE_ALIAS.get(normalized) || \"\";\r\n}\r\n\r\nfunction resolveArchiveReasonFromLifecycle(record) {\r\n  const details = asObject(record?.details, {});\r\n  const detailReason = asString(details?.offboardingReason || details?.reason || details?.note);\r\n  if (detailReason) {\r\n    return detailReason;\r\n  }\r\n\r\n  const category = asString(record?.category);\r\n  const status = asString(record?.status);\r\n  if (category || status) {\r\n    return [category, status].filter(Boolean).join(\" - \");\r\n  }\r\n\r\n  return \"Resigned\";\r\n}\r\n\r\nfunction buildArchivePatch(current, { actorEmail, archivedAt, reason, retentionDeleteAt, trailField }) {\r\n  const patch = {\r\n    isArchived: true,\r\n    archivedAt,\r\n    archivedBy: actorEmail,\r\n    archiveReason: reason,\r\n    retentionDeleteAt,\r\n    updatedAt: archivedAt,\r\n    updatedBy: actorEmail,\r\n  };\r\n\r\n  if (trailField) {\r\n    patch[trailField] = appendTrail(current?.[trailField], {\r\n      at: archivedAt,\r\n      by: actorEmail,\r\n      action: \"archive\",\r\n      reason,\r\n    });\r\n  }\r\n\r\n  return patch;\r\n}\r\n\r\nasync function syncUserRoleByLifecycle(record, actorRole) {\r\n  const normalizedEmail = normalizeEmail(record?.employeeEmail);\r\n  if (!normalizedEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const targetRole = resolveLifecycleRoleTarget(record);\r\n  if (!targetRole) {\r\n    throw new Error(\"invalid_target_role\");\r\n  }\r\n  validateLifecycleTargetRolePermission({\r\n    actorRole,\r\n    targetRole,\r\n  });\r\n\r\n  const updated = await updateUserAccountRole({\r\n    userId: normalizedEmail,\r\n    role: targetRole,\r\n  });\r\n  if (!updated) {\r\n    throw new Error(\"role_sync_failed\");\r\n  }\r\n\r\n  return updated;\r\n}\r\n\r\nasync function syncEmployeeRecordRoleByLifecycle(record, actorEmail, actorRole) {\r\n  const normalizedEmail = normalizeEmail(record?.employeeEmail);\r\n  if (!normalizedEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const targetRole = resolveLifecycleRoleTarget(record);\r\n  if (!targetRole) {\r\n    throw new Error(\"invalid_target_role\");\r\n  }\r\n  validateLifecycleTargetRolePermission({\r\n    actorRole,\r\n    targetRole,\r\n  });\r\n\r\n  const details = asObject(record?.details, {});\r\n  const nextDepartment = asString(details?.departmentTo);\r\n  const updatedAt = nowIso();\r\n  const updatedCount = await updateCollectionRecordsByField(\r\n    getCollectionName(\"employees\"),\r\n    \"email\",\r\n    normalizedEmail,\r\n    (current) => {\r\n      const patch = {\r\n        role: targetRole,\r\n        updatedAt,\r\n        updatedBy: actorEmail,\r\n        activityHistory: appendTrail(current?.activityHistory, {\r\n          at: updatedAt,\r\n          by: actorEmail,\r\n          action: \"lifecycle-role-sync\",\r\n          role: targetRole,\r\n        }),\r\n      };\r\n      if (nextDepartment) {\r\n        patch.department = nextDepartment;\r\n      }\r\n      return patch;\r\n    },\r\n  );\r\n\r\n  return updatedCount;\r\n}\r\n\r\nasync function revokeUserAccessByEmail(email) {\r\n  const normalizedEmail = normalizeEmail(email);\r\n  if (!normalizedEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const updated = await updateUserAccountStatus({\r\n    userId: normalizedEmail,\r\n    status: \"disabled\",\r\n  });\r\n  if (!updated) {\r\n    throw new Error(\"employee_account_not_found\");\r\n  }\r\n  if (asString(updated.status).toLowerCase() !== \"disabled\") {\r\n    throw new Error(\"access_revocation_failed\");\r\n  }\r\n  return updated;\r\n}\r\n\r\nasync function activateUserAccessByEmail(email) {\r\n  const normalizedEmail = normalizeEmail(email);\r\n  if (!normalizedEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const updated = await updateUserAccountStatus({\r\n    userId: normalizedEmail,\r\n    status: \"active\",\r\n  });\r\n  if (!updated) {\r\n    throw new Error(\"employee_account_not_found\");\r\n  }\r\n  if (asString(updated.status).toLowerCase() !== \"active\") {\r\n    throw new Error(\"account_activation_failed\");\r\n  }\r\n  return updated;\r\n}\r\n\r\nasync function activateEmployeeRecordByEmail(record, actorEmail) {\r\n  const normalizedEmail = normalizeEmail(record?.employeeEmail);\r\n  if (!normalizedEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const details = asObject(record?.details, {});\r\n  const employeeId = asString(details?.employeeId || details?.employeeNumber);\r\n  const firstName = asString(details?.firstName);\r\n  const middleName = asString(details?.middleName);\r\n  const lastName = asString(details?.lastName);\r\n  const suffix = asString(details?.suffix);\r\n  const startDate = asString(details?.startDate);\r\n  const roleRaw = asString(details?.roleTo || details?.role || details?.roleFrom);\r\n  const roleNormalized = normalizeRoleKey(roleRaw);\r\n  const roleValue = LIFECYCLE_ROLE_ALIAS.get(roleNormalized) || roleNormalized || \"EMPLOYEE_L1\";\r\n  const departmentValue = asString(details?.departmentTo || details?.department);\r\n  const displayName = composeEmployeeName({\r\n    firstName,\r\n    middleName,\r\n    lastName,\r\n    suffix,\r\n    fallback: asString(record?.employee, normalizedEmail),\r\n  });\r\n  const updatedAt = nowIso();\r\n  const updatedCount = await updateCollectionRecordsByField(getCollectionName(\"employees\"), \"email\", normalizedEmail, (current) => {\r\n    const patch = {\r\n      status: \"Active\",\r\n      employmentStatus: \"Active Employee\",\r\n      isArchived: false,\r\n      updatedAt,\r\n      updatedBy: actorEmail,\r\n      activityHistory: appendTrail(current?.activityHistory, {\r\n        at: updatedAt,\r\n        by: actorEmail,\r\n        action: \"lifecycle-onboarding-sync\",\r\n        status: \"Active\",\r\n      }),\r\n    };\r\n    if (employeeId) {\r\n      patch.employeeId = employeeId;\r\n    }\r\n    if (firstName) {\r\n      patch.firstName = firstName;\r\n    }\r\n    if (middleName) {\r\n      patch.middleName = middleName;\r\n    }\r\n    if (lastName) {\r\n      patch.lastName = lastName;\r\n    }\r\n    if (suffix) {\r\n      patch.suffix = suffix;\r\n    }\r\n    if (displayName) {\r\n      patch.name = displayName;\r\n    }\r\n    if (departmentValue) {\r\n      patch.department = departmentValue;\r\n    }\r\n    if (roleValue) {\r\n      patch.role = roleValue;\r\n    }\r\n    if (startDate) {\r\n      patch.hireDate = startDate;\r\n    }\r\n    return patch;\r\n  });\r\n\r\n  if (updatedCount > 0) {\r\n    return updatedCount;\r\n  }\r\n\r\n  const createdPayload = normalizeEmployeeWritePayload(\r\n    {\r\n      employeeId,\r\n      email: normalizedEmail,\r\n      name: displayName,\r\n      firstName,\r\n      middleName,\r\n      lastName,\r\n      suffix,\r\n      role: roleValue || \"EMPLOYEE_L1\",\r\n      department: departmentValue || \"-\",\r\n      hireDate: startDate || \"\",\r\n      status: \"Active\",\r\n      employmentStatus: \"Active Employee\",\r\n    },\r\n    actorEmail,\r\n  );\r\n  await createCollectionRecord(getCollectionName(\"employees\"), createdPayload);\r\n  return 1;\r\n}\r\n\r\nasync function archiveEmployeeDataByEmail(record, actorEmail) {\r\n  const normalizedEmail = normalizeEmail(record?.employeeEmail);\r\n  if (!normalizedEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const archivedAt = nowIso();\r\n  const retentionDeleteAt = addYearsToIso(archivedAt, getArchiveRetentionYears());\r\n  const reason = resolveArchiveReasonFromLifecycle(record);\r\n\r\n  const userArchive = await archiveUserAccount({\r\n    userId: normalizedEmail,\r\n    archivedBy: actorEmail,\r\n    reason,\r\n    retentionDeleteAt,\r\n  });\r\n\r\n  const employeesArchived = await updateCollectionRecordsByField(getCollectionName(\"employees\"), \"email\", normalizedEmail, (current) => ({\r\n    ...buildArchivePatch(current, {\r\n      actorEmail,\r\n      archivedAt,\r\n      reason,\r\n      retentionDeleteAt,\r\n      trailField: \"activityHistory\",\r\n    }),\r\n    status: \"Archived\",\r\n    employmentStatus: \"Resigned\",\r\n  }));\r\n\r\n  const lifecycleArchived = await updateCollectionRecordsByField(getCollectionName(\"lifecycle\"), \"employeeEmail\", normalizedEmail, (current) => ({\r\n    ...buildArchivePatch(current, {\r\n      actorEmail,\r\n      archivedAt,\r\n      reason,\r\n      retentionDeleteAt,\r\n      trailField: \"traceability\",\r\n    }),\r\n    archiveStatus: \"Archived\",\r\n  }));\r\n\r\n  const attendanceArchived = await updateCollectionRecordsByField(getCollectionName(\"attendance\"), \"employeeEmail\", normalizedEmail, (current) => ({\r\n    ...buildArchivePatch(current, {\r\n      actorEmail,\r\n      archivedAt,\r\n      reason,\r\n      retentionDeleteAt,\r\n      trailField: \"modificationTrail\",\r\n    }),\r\n    archiveStatus: \"Archived\",\r\n  }));\r\n\r\n  const leaveArchived = await updateCollectionRecordsByField(getCollectionName(\"leave\"), \"employeeEmail\", normalizedEmail, (current) => ({\r\n    ...buildArchivePatch(current, {\r\n      actorEmail,\r\n      archivedAt,\r\n      reason,\r\n      retentionDeleteAt,\r\n      trailField: \"modificationTrail\",\r\n    }),\r\n    archiveStatus: \"Archived\",\r\n  }));\r\n\r\n  const performanceArchived = await updateCollectionRecordsByField(getCollectionName(\"performance\"), \"employeeEmail\", normalizedEmail, (current) => ({\r\n    ...buildArchivePatch(current, {\r\n      actorEmail,\r\n      archivedAt,\r\n      reason,\r\n      retentionDeleteAt,\r\n      trailField: \"traceability\",\r\n    }),\r\n    archiveStatus: \"Archived\",\r\n  }));\r\n\r\n  const exportsArchived = await updateCollectionRecordsByField(getCollectionName(\"exports\"), \"requestedBy\", normalizedEmail, (current) => ({\r\n    ...buildArchivePatch(current, {\r\n      actorEmail,\r\n      archivedAt,\r\n      reason,\r\n      retentionDeleteAt,\r\n      trailField: \"history\",\r\n    }),\r\n    archiveStatus: \"Archived\",\r\n  }));\r\n\r\n  return {\r\n    archivedAt,\r\n    retentionDeleteAt,\r\n    reason,\r\n    userStatus: userArchive?.status || \"disabled\",\r\n    counts: {\r\n      employees: employeesArchived,\r\n      lifecycle: lifecycleArchived,\r\n      attendance: attendanceArchived,\r\n      leave: leaveArchived,\r\n      performance: performanceArchived,\r\n      exports: exportsArchived,\r\n    },\r\n  };\r\n}\r\n\r\nasync function applyLifecycleAutomations(record, actorEmail, actorRole) {\r\n  const effects = [];\r\n  if (shouldApplyOnboardingActivation(record)) {\r\n    const activatedAccount = await activateUserAccessByEmail(record.employeeEmail);\r\n    const activatedEmployeeRecords = await activateEmployeeRecordByEmail(record, actorEmail);\r\n    effects.push({\r\n      type: \"onboarding-activation\",\r\n      message: \"User account and employee profile activated.\",\r\n      accountStatus: activatedAccount?.status || \"active\",\r\n      employeeRecordsUpdated: activatedEmployeeRecords,\r\n    });\r\n  }\r\n  if (shouldApplyLifecycleRoleSync(record)) {\r\n    const employeeRecordsUpdated = await syncEmployeeRecordRoleByLifecycle(record, actorEmail, actorRole);\r\n    const account = await syncUserRoleByLifecycle(record, actorRole);\r\n    effects.push({\r\n      type: \"role-sync\",\r\n      message: `Role synchronized to ${account?.role || \"target role\"}.`,\r\n      role: account?.role || null,\r\n      employeeRecordsUpdated,\r\n    });\r\n  }\r\n  if (shouldTriggerAccessRevocation(record)) {\r\n    const account = await revokeUserAccessByEmail(record.employeeEmail);\r\n    effects.push({\r\n      type: \"access-revocation\",\r\n      message: \"User account access revoked.\",\r\n      accountStatus: account?.status || \"disabled\",\r\n    });\r\n  }\r\n  if (shouldApplyLifecycleArchivePolicy(record)) {\r\n    const archiveResult = await archiveEmployeeDataByEmail(record, actorEmail);\r\n    effects.push({\r\n      type: \"archive-policy\",\r\n      message: `Employee data archived until ${archiveResult.retentionDeleteAt}.`,\r\n      retentionDeleteAt: archiveResult.retentionDeleteAt,\r\n      archivedAt: archiveResult.archivedAt,\r\n      counts: archiveResult.counts,\r\n    });\r\n  }\r\n  return effects;\r\n}\r\n\r\nexport async function listLifecycleRecordsBackend() {\r\n  return await listCollectionRecords(getCollectionName(\"lifecycle\"));\r\n}\r\n\r\nexport async function getLifecycleRecordBackend(recordId) {\r\n  return await getCollectionRecordById(getCollectionName(\"lifecycle\"), recordId);\r\n}\r\n\r\nexport async function createLifecycleRecordBackend(payload, actorEmail, actorRole = \"\", { requestOrigin = \"\" } = {}) {\r\n  const normalized = normalizeLifecyclePayload(payload, actorEmail, actorRole);\r\n  const effects = [];\r\n  if (shouldTriggerOnboardingInvite(normalized)) {\r\n    const inviteEffect = await triggerOnboardingInvite(normalized, actorEmail, actorRole, {\r\n      requestOrigin,\r\n    });\r\n    if (inviteEffect) {\r\n      effects.push(inviteEffect);\r\n    }\r\n  }\r\n  const automationEffects = await applyLifecycleAutomations(normalized, actorEmail, actorRole);\r\n  effects.push(...automationEffects);\r\n\r\n  const created = await createCollectionRecord(getCollectionName(\"lifecycle\"), {\r\n    ...normalized,\r\n    lastAutomationEffects: effects,\r\n    lastAutomationAt: nowIso(),\r\n    lastAutomationBy: actorEmail,\r\n  });\r\n\r\n  await syncOnboardingEvidenceToEmployeeDocuments(created, actorEmail).catch(() => null);\r\n\r\n  return {\r\n    record: created,\r\n    effects,\r\n  };\r\n}\r\n\r\nexport async function updateLifecycleRecordBackend(recordId, payload, actorEmail, actorRole = \"\") {\r\n  const current = await getLifecycleRecordBackend(recordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n  const normalized = normalizeLifecyclePayload(payload, actorEmail, actorRole, { base: current });\r\n  const effects = await applyLifecycleAutomations(normalized, actorEmail, actorRole);\r\n\r\n  const updated = await updateCollectionRecord(getCollectionName(\"lifecycle\"), recordId, {\r\n    ...normalized,\r\n    lastAutomationEffects: effects,\r\n    lastAutomationAt: nowIso(),\r\n    lastAutomationBy: actorEmail,\r\n  });\r\n\r\n  await syncOnboardingEvidenceToEmployeeDocuments(updated, actorEmail).catch(() => null);\r\n\r\n  return {\r\n    record: updated,\r\n    effects,\r\n  };\r\n}\r\n\r\nexport async function forceOffboardLifecycleRecordBackend(recordId, actorEmail, reason, actorRole = \"\") {\r\n  return await updateLifecycleRecordBackend(\r\n    recordId,\r\n    {\r\n      category: \"Offboarding\",\r\n      status: \"Access Revoked\",\r\n      details: {\r\n        offboardingReason: asString(reason, \"Resignation\"),\r\n      },\r\n    },\r\n    actorEmail,\r\n    actorRole,\r\n  );\r\n}\r\n\r\nexport async function approveLifecycleRecordBackend(\r\n  recordId,\r\n  { decision, note } = {},\r\n  actorEmail,\r\n  actorRole = \"\",\r\n) {\r\n  const current = await getLifecycleRecordBackend(recordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n\r\n  const timestamp = nowIso();\r\n  const baseWorkflow = asObject(current.workflow, {});\r\n  const approvalResult = applyApprovalDecision({\r\n    workflow: baseWorkflow,\r\n    actorRole,\r\n    actorEmail,\r\n    decision,\r\n    note,\r\n    atIso: timestamp,\r\n  });\r\n\r\n  const normalized = normalizeLifecyclePayload(\r\n    {\r\n      status: approvalResult.status,\r\n      workflow: approvalResult.workflow,\r\n    },\r\n    actorEmail,\r\n    actorRole,\r\n    { base: current },\r\n  );\r\n\r\n  const effects = await applyLifecycleAutomations(normalized, actorEmail, actorRole);\r\n  const updated = await updateCollectionRecord(getCollectionName(\"lifecycle\"), recordId, {\r\n    ...normalized,\r\n    lastAutomationEffects: effects,\r\n    lastAutomationAt: nowIso(),\r\n    lastAutomationBy: actorEmail,\r\n  });\r\n\r\n  await syncOnboardingEvidenceToEmployeeDocuments(updated, actorEmail).catch(() => null);\r\n\r\n  return {\r\n    record: updated,\r\n    effects,\r\n  };\r\n}\r\n\r\nfunction normalizeAttendancePayload(payload, actorEmail, { base } = {}) {\r\n  const timestamp = nowIso();\r\n  const employeeEmail = normalizeEmail(payload?.employeeEmail || base?.employeeEmail);\r\n  if (!employeeEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const next = {\r\n    employeeEmail,\r\n    employee: asString(payload?.employee, asString(base?.employee, employeeEmail)),\r\n    date: asString(payload?.date, asString(base?.date, timestamp.slice(0, 10))),\r\n    checkIn: asString(payload?.checkIn, asString(base?.checkIn, \"-\")),\r\n    checkOut: asString(payload?.checkOut, asString(base?.checkOut, \"-\")),\r\n    status: asString(payload?.status, asString(base?.status, \"Recorded\")),\r\n    reason: asString(payload?.reason, asString(base?.reason, \"\")),\r\n    createdAt: asString(base?.createdAt, timestamp),\r\n    createdBy: asString(base?.createdBy, actorEmail),\r\n    updatedAt: timestamp,\r\n    updatedBy: actorEmail,\r\n  };\r\n\r\n  next.modificationTrail = appendTrail(base?.modificationTrail, {\r\n    at: timestamp,\r\n    by: actorEmail,\r\n    action: base ? \"update\" : \"create\",\r\n    status: next.status,\r\n    checkIn: next.checkIn,\r\n    checkOut: next.checkOut,\r\n    reason: next.reason,\r\n  });\r\n\r\n  return next;\r\n}\r\n\r\nfunction normalizeLeavePayload(payload, actorEmail, { base } = {}) {\r\n  const timestamp = nowIso();\r\n  const employeeEmail = normalizeEmail(payload?.employeeEmail || base?.employeeEmail);\r\n  if (!employeeEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  const status = asString(payload?.status, asString(base?.status, \"Pending\"));\r\n  const next = {\r\n    employeeEmail,\r\n    employee: asString(payload?.employee, asString(base?.employee, employeeEmail)),\r\n    leaveType: asString(payload?.leaveType, asString(base?.leaveType, \"Leave\")),\r\n    startDate: asString(payload?.startDate, asString(base?.startDate, \"\")),\r\n    endDate: asString(payload?.endDate, asString(base?.endDate, \"\")),\r\n    reason: asString(payload?.reason, asString(base?.reason, \"\")),\r\n    status,\r\n    approver: asString(payload?.approver, asString(base?.approver, \"\")),\r\n    approvalNote: asString(payload?.approvalNote, asString(base?.approvalNote, \"\")),\r\n    createdAt: asString(base?.createdAt, timestamp),\r\n    createdBy: asString(base?.createdBy, actorEmail),\r\n    updatedAt: timestamp,\r\n    updatedBy: actorEmail,\r\n  };\r\n\r\n  next.modificationTrail = appendTrail(base?.modificationTrail, {\r\n    at: timestamp,\r\n    by: actorEmail,\r\n    action: base ? \"update\" : \"create\",\r\n    status,\r\n    leaveType: next.leaveType,\r\n  });\r\n\r\n  return next;\r\n}\r\n\r\nexport async function listAttendanceLogsBackend({ ownerEmail } = {}) {\r\n  return await listCollectionRecords(getCollectionName(\"attendance\"), {\r\n    filterField: ownerEmail ? \"employeeEmail\" : undefined,\r\n    filterValue: ownerEmail ? normalizeEmail(ownerEmail) : undefined,\r\n  });\r\n}\r\n\r\nexport async function getAttendanceLogBackend(recordId) {\r\n  return await getCollectionRecordById(getCollectionName(\"attendance\"), recordId);\r\n}\r\n\r\nexport async function createAttendanceLogBackend(payload, actorEmail) {\r\n  const normalized = normalizeAttendancePayload(payload, actorEmail);\r\n  return await createCollectionRecord(getCollectionName(\"attendance\"), normalized);\r\n}\r\n\r\nexport async function updateAttendanceLogBackend(recordId, payload, actorEmail) {\r\n  const current = await getAttendanceLogBackend(recordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n  const normalized = normalizeAttendancePayload(payload, actorEmail, { base: current });\r\n  return await updateCollectionRecord(getCollectionName(\"attendance\"), recordId, normalized);\r\n}\r\n\r\nexport async function listLeaveRequestsBackend({ ownerEmail } = {}) {\r\n  return await listCollectionRecords(getCollectionName(\"leave\"), {\r\n    filterField: ownerEmail ? \"employeeEmail\" : undefined,\r\n    filterValue: ownerEmail ? normalizeEmail(ownerEmail) : undefined,\r\n  });\r\n}\r\n\r\nexport async function getLeaveRequestBackend(recordId) {\r\n  return await getCollectionRecordById(getCollectionName(\"leave\"), recordId);\r\n}\r\n\r\nexport async function createLeaveRequestBackend(payload, actorEmail) {\r\n  const normalized = normalizeLeavePayload(payload, actorEmail);\r\n  return await createCollectionRecord(getCollectionName(\"leave\"), normalized);\r\n}\r\n\r\nexport async function updateLeaveRequestBackend(recordId, payload, actorEmail) {\r\n  const current = await getLeaveRequestBackend(recordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n  const normalized = normalizeLeavePayload(payload, actorEmail, { base: current });\r\n  return await updateCollectionRecord(getCollectionName(\"leave\"), recordId, normalized);\r\n}\r\n\r\nfunction normalizePerformancePayload(payload, actorEmail, { base } = {}) {\r\n  const timestamp = nowIso();\r\n  const employeeEmail = normalizeEmail(payload?.employeeEmail || base?.employeeEmail);\r\n  if (!employeeEmail) {\r\n    throw new Error(\"invalid_employee_email\");\r\n  }\r\n\r\n  return {\r\n    employeeEmail,\r\n    employee: asString(payload?.employee, asString(base?.employee, employeeEmail)),\r\n    period: asString(payload?.period, asString(base?.period, \"\")),\r\n    kpiScore: asString(payload?.kpiScore, asString(base?.kpiScore, \"\")),\r\n    evaluationForm: payload?.evaluationForm ?? base?.evaluationForm ?? {},\r\n    reviewHistory: asArray(payload?.reviewHistory ?? base?.reviewHistory),\r\n    promotionJustification: asString(payload?.promotionJustification, asString(base?.promotionJustification, \"\")),\r\n    reviewer: asString(payload?.reviewer, asString(base?.reviewer, \"\")),\r\n    rating: asString(payload?.rating, asString(base?.rating, \"\")),\r\n    status: asString(payload?.status, asString(base?.status, \"Draft\")),\r\n    createdAt: asString(base?.createdAt, timestamp),\r\n    createdBy: asString(base?.createdBy, actorEmail),\r\n    updatedAt: timestamp,\r\n    updatedBy: actorEmail,\r\n    traceability: appendTrail(base?.traceability, {\r\n      at: timestamp,\r\n      by: actorEmail,\r\n      action: base ? \"update\" : \"create\",\r\n      period: asString(payload?.period, asString(base?.period, \"\")),\r\n    }),\r\n  };\r\n}\r\n\r\nexport async function listPerformanceRecordsBackend({ ownerEmail } = {}) {\r\n  return await listCollectionRecords(getCollectionName(\"performance\"), {\r\n    filterField: ownerEmail ? \"employeeEmail\" : undefined,\r\n    filterValue: ownerEmail ? normalizeEmail(ownerEmail) : undefined,\r\n  });\r\n}\r\n\r\nexport async function getPerformanceRecordBackend(recordId) {\r\n  return await getCollectionRecordById(getCollectionName(\"performance\"), recordId);\r\n}\r\n\r\nexport async function createPerformanceRecordBackend(payload, actorEmail) {\r\n  const normalized = normalizePerformancePayload(payload, actorEmail);\r\n  return await createCollectionRecord(getCollectionName(\"performance\"), normalized);\r\n}\r\n\r\nexport async function updatePerformanceRecordBackend(recordId, payload, actorEmail) {\r\n  const current = await getPerformanceRecordBackend(recordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n  const normalized = normalizePerformancePayload(payload, actorEmail, { base: current });\r\n  return await updateCollectionRecord(getCollectionName(\"performance\"), recordId, normalized);\r\n}\r\n\r\nfunction normalizeTemplatePayload(payload, actorEmail, { base } = {}) {\r\n  const timestamp = nowIso();\r\n  const version = asString(payload?.version, asString(base?.version, \"v1.0\"));\r\n  const templateName = asString(payload?.templateName, asString(base?.templateName));\r\n  if (!templateName) {\r\n    throw new Error(\"invalid_template_name\");\r\n  }\r\n\r\n  const previousVersionEntry = base\r\n    ? {\r\n        version: asString(base.version, \"v1.0\"),\r\n        changedAt: timestamp,\r\n        changedBy: actorEmail,\r\n        note: asString(payload?.changeNote, \"Template updated\"),\r\n      }\r\n    : null;\r\n\r\n  const currentHistory = asArray(base?.versionHistory);\r\n  const nextHistory = previousVersionEntry ? appendTrail(currentHistory, previousVersionEntry) : currentHistory;\r\n\r\n  const modificationLog = appendTrail(base?.modificationLog, {\r\n    at: timestamp,\r\n    by: actorEmail,\r\n    action: base ? \"update\" : \"upload\",\r\n    version,\r\n  });\r\n\r\n  return {\r\n    templateName,\r\n    category: asString(payload?.category, asString(base?.category, \"HR Template\")),\r\n    classification: asString(payload?.classification, asString(base?.classification, \"Restricted PII\")),\r\n    documentType: asString(payload?.documentType, asString(base?.documentType, \"Template\")),\r\n    tags: asArray(payload?.tags ?? base?.tags),\r\n    version,\r\n    status: asString(payload?.status, asString(base?.status, \"Active\")),\r\n    contentRef: asString(payload?.contentRef, asString(base?.contentRef, \"\")),\r\n    acknowledgments: asArray(payload?.acknowledgments ?? base?.acknowledgments),\r\n    usageLogs: asArray(payload?.usageLogs ?? base?.usageLogs),\r\n    versionHistory: nextHistory,\r\n    modificationLog,\r\n    createdAt: asString(base?.createdAt, timestamp),\r\n    createdBy: asString(base?.createdBy, actorEmail),\r\n    updatedAt: timestamp,\r\n    updatedBy: actorEmail,\r\n  };\r\n}\r\n\r\nexport async function listDocumentTemplatesBackend() {\r\n  return await listCollectionRecords(getCollectionName(\"templates\"));\r\n}\r\n\r\nexport async function getDocumentTemplateBackend(recordId) {\r\n  return await getCollectionRecordById(getCollectionName(\"templates\"), recordId);\r\n}\r\n\r\nexport async function createDocumentTemplateBackend(payload, actorEmail) {\r\n  const normalized = normalizeTemplatePayload(payload, actorEmail);\r\n  return await createCollectionRecord(getCollectionName(\"templates\"), normalized);\r\n}\r\n\r\nexport async function updateDocumentTemplateBackend(recordId, payload, actorEmail) {\r\n  const current = await getDocumentTemplateBackend(recordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n  const normalized = normalizeTemplatePayload(payload, actorEmail, { base: current });\r\n  return await updateCollectionRecord(getCollectionName(\"templates\"), recordId, normalized);\r\n}\r\n\r\nexport async function deleteDocumentTemplateBackend(recordId, actorEmail) {\r\n  const current = await getDocumentTemplateBackend(recordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n  return await updateCollectionRecord(getCollectionName(\"templates\"), recordId, {\r\n    ...current,\r\n    status: \"Archived\",\r\n    archivedAt: nowIso(),\r\n    archivedBy: actorEmail,\r\n    updatedAt: nowIso(),\r\n    updatedBy: actorEmail,\r\n    modificationLog: appendTrail(current.modificationLog, {\r\n      at: nowIso(),\r\n      by: actorEmail,\r\n      action: \"archive\",\r\n      version: asString(current.version, \"v1.0\"),\r\n    }),\r\n  });\r\n}\r\n\r\nfunction normalizeExportRequestPayload(payload, actorEmail, { base } = {}) {\r\n  const timestamp = nowIso();\r\n  const dataset = asString(payload?.dataset, asString(base?.dataset, \"Employee Dataset\"));\r\n  if (!dataset) {\r\n    throw new Error(\"invalid_export_dataset\");\r\n  }\r\n\r\n  const format = asString(payload?.format, asString(base?.format, \"CSV\")).toUpperCase();\r\n  const requestedBy = normalizeEmail(payload?.requestedBy || base?.requestedBy || actorEmail);\r\n  const scope = asString(payload?.scope, asString(base?.scope, \"full\"));\r\n  const status = asString(payload?.status, asString(base?.status, \"Pending\"));\r\n  const estimateVolume = asString(payload?.estimateVolume, asString(base?.estimateVolume, \"0\"));\r\n  const justification = asString(payload?.justification, asString(base?.justification));\r\n\r\n  return {\r\n    dataset,\r\n    format,\r\n    requestedBy,\r\n    scope,\r\n    estimateVolume,\r\n    justification,\r\n    status,\r\n    reviewer: asString(payload?.reviewer, asString(base?.reviewer, \"\")),\r\n    reviewNote: asString(payload?.reviewNote, asString(base?.reviewNote, \"\")),\r\n    reviewedAt: asString(payload?.reviewedAt, asString(base?.reviewedAt, \"\")),\r\n    exportedAt: asString(payload?.exportedAt, asString(base?.exportedAt, \"\")),\r\n    exportedBy: asString(payload?.exportedBy, asString(base?.exportedBy, \"\")),\r\n    alert: asString(payload?.alert, asString(base?.alert, \"\")),\r\n    createdAt: asString(base?.createdAt, timestamp),\r\n    createdBy: asString(base?.createdBy, actorEmail),\r\n    updatedAt: timestamp,\r\n    updatedBy: actorEmail,\r\n    history: appendTrail(base?.history, {\r\n      at: timestamp,\r\n      by: actorEmail,\r\n      action: base ? \"update\" : \"create\",\r\n      status,\r\n    }),\r\n  };\r\n}\r\n\r\nexport async function listExportRequestsBackend({ ownerEmail } = {}) {\r\n  return await listCollectionRecords(getCollectionName(\"exports\"), {\r\n    filterField: ownerEmail ? \"requestedBy\" : undefined,\r\n    filterValue: ownerEmail ? normalizeEmail(ownerEmail) : undefined,\r\n  });\r\n}\r\n\r\nexport async function getExportRequestBackend(recordId) {\r\n  return await getCollectionRecordById(getCollectionName(\"exports\"), recordId);\r\n}\r\n\r\nexport async function createExportRequestBackend(payload, actorEmail) {\r\n  const normalized = normalizeExportRequestPayload(payload, actorEmail);\r\n  return await createCollectionRecord(getCollectionName(\"exports\"), normalized);\r\n}\r\n\r\nexport async function updateExportRequestBackend(recordId, payload, actorEmail) {\r\n  const current = await getExportRequestBackend(recordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n  const normalized = normalizeExportRequestPayload(payload, actorEmail, { base: current });\r\n  return await updateCollectionRecord(getCollectionName(\"exports\"), recordId, normalized);\r\n}\r\n\r\nexport async function approveExportRequestBackend(recordId, actorEmail, { approved, note } = {}) {\r\n  const status = approved ? \"Approved\" : \"Rejected\";\r\n  return await updateExportRequestBackend(\r\n    recordId,\r\n    {\r\n      status,\r\n      reviewer: actorEmail,\r\n      reviewNote: asString(note, \"\"),\r\n      reviewedAt: nowIso(),\r\n    },\r\n    actorEmail,\r\n  );\r\n}\r\n\r\nexport async function markExportAsCompletedBackend(recordId, actorEmail) {\r\n  return await updateExportRequestBackend(\r\n    recordId,\r\n    {\r\n      status: \"Exported\",\r\n      exportedBy: actorEmail,\r\n      exportedAt: nowIso(),\r\n    },\r\n    actorEmail,\r\n  );\r\n}\r\n\r\nfunction normalizeIncidentSeverity(value, fallback = \"Low\") {\r\n  const normalized = asString(value, fallback).toLowerCase();\r\n  if (normalized === \"critical\") {\r\n    return \"High\";\r\n  }\r\n  if (normalized === \"medium\") {\r\n    return \"Low\";\r\n  }\r\n  const matched = INCIDENT_SEVERITY_LEVELS.find((entry) => entry.toLowerCase() === normalized);\r\n  return matched || \"Low\";\r\n}\r\n\r\nfunction normalizeIncidentStatus(value, fallback = \"Open\") {\r\n  const normalized = asString(value, fallback).toLowerCase();\r\n  const matched = INCIDENT_STATUS_VALUES.find((entry) => entry.toLowerCase() === normalized);\r\n  return matched || \"Open\";\r\n}\r\n\r\nfunction normalizeIncidentContainmentStatus(value, fallback = \"Not Started\") {\r\n  const normalized = asString(value, fallback).toLowerCase();\r\n  const matched = INCIDENT_CONTAINMENT_STATUS_VALUES.find((entry) => entry.toLowerCase() === normalized);\r\n  return matched || \"Not Started\";\r\n}\r\n\r\nfunction normalizeIncidentImpactStatus(value, fallback = \"Pending\") {\r\n  const normalized = asString(value, fallback).toLowerCase();\r\n  const matched = INCIDENT_IMPACT_STATUS_VALUES.find((entry) => entry.toLowerCase() === normalized);\r\n  return matched || \"Pending\";\r\n}\r\n\r\nfunction normalizeIncidentType(value, fallback = \"Other\") {\r\n  const normalized = asString(value, fallback).toLowerCase();\r\n  const matched = INCIDENT_TYPE_VALUES.find((entry) => entry.toLowerCase() === normalized);\r\n  return matched || \"Other\";\r\n}\r\n\r\nfunction buildIncidentCode(isoValue = nowIso()) {\r\n  const date = new Date(isoValue || nowIso());\r\n  if (Number.isNaN(date.getTime())) {\r\n    return `INC-${Date.now().toString().slice(-10)}`;\r\n  }\r\n  const yyyy = String(date.getUTCFullYear());\r\n  const mm = String(date.getUTCMonth() + 1).padStart(2, \"0\");\r\n  const dd = String(date.getUTCDate()).padStart(2, \"0\");\r\n  const hh = String(date.getUTCHours()).padStart(2, \"0\");\r\n  const mi = String(date.getUTCMinutes()).padStart(2, \"0\");\r\n  const random = Math.random().toString(36).slice(2, 5).toUpperCase();\r\n  return `INC-${yyyy}${mm}${dd}-${hh}${mi}${random}`;\r\n}\r\n\r\nfunction extractEvidenceExtension(value) {\r\n  const normalized = asString(value).toLowerCase();\r\n  if (!normalized) {\r\n    return \"\";\r\n  }\r\n  const clean = normalized.split(\"?\")[0].split(\"#\")[0];\r\n  const token = clean.split(\".\").pop() || \"\";\r\n  if (!/^[a-z0-9]{2,10}$/.test(token)) {\r\n    return \"\";\r\n  }\r\n  return token;\r\n}\r\n\r\nfunction sanitizeIncidentEvidenceDocuments(value, actorEmail, fallbackNowIso) {\r\n  const timestamp = asString(fallbackNowIso, nowIso());\r\n  const config = getIncidentEvidenceValidationConfig();\r\n  return asArray(value)\r\n    .map((entry, index) => {\r\n      const source = asObject(entry, {});\r\n      const uploadedAt = toIsoOrEmpty(source.uploadedAt || timestamp) || timestamp;\r\n      const uploadedBy = normalizeEmail(source.uploadedBy || actorEmail);\r\n      const name = asString(source.name, `Incident Evidence ${index + 1}`);\r\n      const type = asString(source.type, \"Incident Evidence\");\r\n      const ref = asString(source.ref);\r\n      const storagePath = asString(source.storagePath);\r\n      const fileExtension = extractEvidenceExtension(source.fileExtension || name || storagePath || ref);\r\n      const contentType = normalizeText(source.contentType);\r\n      const sizeBytes = Number.isFinite(Number(source.sizeBytes)) ? Number(source.sizeBytes) : 0;\r\n      const id = asString(source.id || source.recordId || storagePath || `${index + 1}`);\r\n      if (!name && !ref && !storagePath) {\r\n        return null;\r\n      }\r\n      if (fileExtension && !config.allowedExtensions.has(fileExtension)) {\r\n        throw new Error(\"invalid_incident_evidence_extension\");\r\n      }\r\n      if (contentType && !config.allowedMimeTypes.has(contentType)) {\r\n        throw new Error(\"invalid_incident_evidence_content_type\");\r\n      }\r\n      if (sizeBytes > config.maxBytes) {\r\n        throw new Error(\"invalid_incident_evidence_size\");\r\n      }\r\n      return {\r\n        id,\r\n        name: name || \"Incident Evidence\",\r\n        type: type || \"Incident Evidence\",\r\n        ref,\r\n        storagePath,\r\n        fileExtension,\r\n        contentType,\r\n        sizeBytes,\r\n        scanStatus: asString(source.scanStatus),\r\n        scanReference: asString(source.scanReference),\r\n        scannedAt: toIsoOrEmpty(source.scannedAt || \"\"),\r\n        uploadedAt,\r\n        uploadedBy: uploadedBy || actorEmail,\r\n      };\r\n    })\r\n    .filter(Boolean)\r\n    .slice(0, MAX_INCIDENT_EVIDENCE_ITEMS);\r\n}\r\n\r\nfunction sanitizeIncidentAlertOccurrences(value) {\r\n  return asArray(value)\r\n    .map((entry) => {\r\n      const source = asObject(entry, {});\r\n      const at = toIsoOrEmpty(source.at || source.occurredAt || \"\");\r\n      if (!at) {\r\n        return null;\r\n      }\r\n      return {\r\n        at,\r\n        activityName: asString(source.activityName || source.action || \"Activity\"),\r\n        module: asString(source.module || \"System\"),\r\n        sourceEventId: asString(source.sourceEventId || source.eventId || \"\"),\r\n        sourceIp: asString(source.sourceIp || \"\"),\r\n        requestPath: asString(source.requestPath || \"\"),\r\n        requestMethod: asString(source.requestMethod || \"\"),\r\n        actorEmail: normalizeEmail(source.actorEmail || source.performedBy || \"\"),\r\n        targetEmployeeEmail: normalizeEmail(source.targetEmployeeEmail || source.employeeEmail || \"\"),\r\n      };\r\n    })\r\n    .filter(Boolean)\r\n    .slice(-40);\r\n}\r\n\r\nfunction resolveIncidentEscalationLevel({ severity, restrictedPiiInvolved, executiveNotificationRequired }) {\r\n  if (severity === \"High\" || executiveNotificationRequired) {\r\n    return \"Executive\";\r\n  }\r\n  if (restrictedPiiInvolved) {\r\n    return \"GRC\";\r\n  }\r\n  return \"Operational\";\r\n}\r\n\r\nfunction resolveIncidentRegulatoryStatus({\r\n  regulatoryNotificationRequired,\r\n  regulatoryNotifiedAt,\r\n  regulatoryDueAt,\r\n  nowIsoValue = nowIso(),\r\n}) {\r\n  if (!regulatoryNotificationRequired) {\r\n    return \"Not Required\";\r\n  }\r\n  if (toTimeMs(regulatoryNotifiedAt)) {\r\n    return \"Notified\";\r\n  }\r\n  const dueAtMs = toTimeMs(regulatoryDueAt);\r\n  const nowMs = toTimeMs(nowIsoValue) || Date.now();\r\n  if (Number.isFinite(dueAtMs) && dueAtMs < nowMs) {\r\n    return \"Overdue\";\r\n  }\r\n  return \"Pending\";\r\n}\r\n\r\nfunction incidentSeverityRank(value) {\r\n  const severity = normalizeIncidentSeverity(value);\r\n  switch (severity) {\r\n    case \"High\":\r\n      return 1;\r\n    default:\r\n      return 0;\r\n  }\r\n}\r\n\r\nfunction isIncidentAccessEvent(row) {\r\n  const method = normalizeText(row?.requestMethod);\r\n  const activity = normalizeText(row?.activityName);\r\n  return method === \"get\" || activity.includes(\"viewed\") || activity.includes(\"listed\") || activity.includes(\"access\");\r\n}\r\n\r\nfunction isIncidentExportEvent(row) {\r\n  const moduleName = normalizeText(row?.module);\r\n  const path = normalizeText(row?.requestPath);\r\n  const activity = normalizeText(row?.activityName);\r\n  return moduleName.includes(\"export\") || path.includes(\"/api/hris/exports\") || activity.includes(\"export\");\r\n}\r\n\r\nfunction isIncidentDeletionEvent(row) {\r\n  const method = normalizeText(row?.requestMethod);\r\n  const activity = normalizeText(row?.activityName);\r\n  return (\r\n    method === \"delete\" ||\r\n    activity.includes(\"delete\") ||\r\n    activity.includes(\"purge\") ||\r\n    activity.includes(\"removed\") ||\r\n    activity.includes(\"archive\")\r\n  );\r\n}\r\n\r\nfunction isIncidentAdministrativeEvent(row) {\r\n  const moduleName = normalizeText(row?.module);\r\n  const method = normalizeText(row?.requestMethod);\r\n  const activity = normalizeText(row?.activityName);\r\n  return (\r\n    moduleName.includes(\"authorization\") ||\r\n    moduleName.includes(\"user management\") ||\r\n    moduleName.includes(\"access management\") ||\r\n    method === \"patch\" ||\r\n    method === \"post\" ||\r\n    activity.includes(\"approve\") ||\r\n    activity.includes(\"revok\") ||\r\n    activity.includes(\"invite\") ||\r\n    activity.includes(\"role\")\r\n  );\r\n}\r\n\r\nfunction normalizeIncidentForensicSample(row) {\r\n  const metadata = asObject(row?.metadata, {});\r\n  return {\r\n    id: asString(row?.id),\r\n    activityName: asString(row?.activityName),\r\n    module: asString(row?.module),\r\n    status: asString(row?.status),\r\n    occurredAt: asString(row?.occurredAt),\r\n    performedBy: asString(row?.performedBy),\r\n    requestMethod: asString(row?.requestMethod),\r\n    requestPath: asString(row?.requestPath),\r\n    sourceIp: asString(row?.sourceIp || metadata?.sourceIp),\r\n    userAgent: asString(row?.userAgent || metadata?.userAgent),\r\n    device: asString(metadata?.device || \"\"),\r\n    recordRef: asString(metadata?.recordRef || metadata?.recordId),\r\n    resourceLabel: asString(metadata?.resourceLabel),\r\n    employeeEmail: asString(metadata?.employeeEmail),\r\n    targetEmployeeEmail: asString(metadata?.targetEmployeeEmail || metadata?.affectedEmployeeEmail),\r\n    viewedFields: asArray(metadata?.viewedFields, []),\r\n    viewedFieldCount: Number(metadata?.viewedFieldCount || 0),\r\n    accessedDocuments: asArray(metadata?.accessedDocuments, []),\r\n    accessedDocumentCount: Number(metadata?.accessedDocumentCount || 0),\r\n    updatedFields: asArray(metadata?.updatedFields, []),\r\n    changedFields: asArray(metadata?.changedFields, []),\r\n  };\r\n}\r\n\r\nfunction incidentMatchesSubject(row, subjectEmail) {\r\n  const subject = normalizeEmail(subjectEmail);\r\n  if (!subject) {\r\n    return true;\r\n  }\r\n\r\n  const metadata = asObject(row?.metadata, {});\r\n  const candidates = [\r\n    row?.performedBy,\r\n    row?.performedByEmail,\r\n    metadata.employeeEmail,\r\n    metadata.ownerEmail,\r\n    metadata.requestedBy,\r\n    metadata.targetEmployeeEmail,\r\n    metadata.affectedEmployeeEmail,\r\n  ];\r\n  return candidates.some((value) => normalizeEmail(value) === subject);\r\n}\r\n\r\nasync function buildIncidentForensicSnapshot(record, { limit } = {}) {\r\n  const nowIsoValue = nowIso();\r\n  const windowStart = toIsoOrEmpty(record?.forensicWindowStart || record?.detectedAt) || nowIsoValue;\r\n  const windowEnd = toIsoOrEmpty(record?.forensicWindowEnd || nowIsoValue) || nowIsoValue;\r\n  const windowStartMs = toTimeMs(windowStart) || 0;\r\n  const windowEndMs = toTimeMs(windowEnd) || Date.now();\r\n  const subjectEmail = normalizeEmail(record?.affectedEmployeeEmail || record?.employeeEmail || \"\");\r\n  const safeLimit = Number.isFinite(Number(limit)) ? Number(limit) : 1800;\r\n\r\n  let rows = [];\r\n  try {\r\n    rows = await listAuditEvents({ limit: Math.max(100, Math.min(5000, safeLimit)) });\r\n  } catch {\r\n    rows = [];\r\n  }\r\n\r\n  const scopedRows = rows.filter((row) => {\r\n    const occurredAtMs = toTimeMs(row?.occurredAt || row?.loggedAt);\r\n    if (!Number.isFinite(occurredAtMs)) {\r\n      return false;\r\n    }\r\n    if (occurredAtMs < windowStartMs || occurredAtMs > windowEndMs) {\r\n      return false;\r\n    }\r\n    return incidentMatchesSubject(row, subjectEmail);\r\n  });\r\n\r\n  const buckets = {\r\n    accessLogs: [],\r\n    exportLogs: [],\r\n    administrativeActions: [],\r\n    deletionActivities: [],\r\n  };\r\n\r\n  scopedRows.forEach((row) => {\r\n    const sample = normalizeIncidentForensicSample(row);\r\n    if (isIncidentDeletionEvent(row)) {\r\n      buckets.deletionActivities.push(sample);\r\n      return;\r\n    }\r\n    if (isIncidentExportEvent(row)) {\r\n      buckets.exportLogs.push(sample);\r\n      return;\r\n    }\r\n    if (isIncidentAdministrativeEvent(row)) {\r\n      buckets.administrativeActions.push(sample);\r\n      return;\r\n    }\r\n    if (isIncidentAccessEvent(row)) {\r\n      buckets.accessLogs.push(sample);\r\n    }\r\n  });\r\n\r\n  return {\r\n    generatedAt: nowIsoValue,\r\n    windowStart,\r\n    windowEnd,\r\n    scopedSubjectEmail: subjectEmail || \"\",\r\n    totalScopedLogs: scopedRows.length,\r\n    accessLogsCount: buckets.accessLogs.length,\r\n    exportLogsCount: buckets.exportLogs.length,\r\n    administrativeActionsCount: buckets.administrativeActions.length,\r\n    deletionActivitiesCount: buckets.deletionActivities.length,\r\n    accessLogs: buckets.accessLogs.slice(0, MAX_INCIDENT_FORENSIC_SAMPLES),\r\n    exportLogs: buckets.exportLogs.slice(0, MAX_INCIDENT_FORENSIC_SAMPLES),\r\n    administrativeActions: buckets.administrativeActions.slice(0, MAX_INCIDENT_FORENSIC_SAMPLES),\r\n    deletionActivities: buckets.deletionActivities.slice(0, MAX_INCIDENT_FORENSIC_SAMPLES),\r\n  };\r\n}\r\n\r\nfunction normalizeIncidentWritePayload(payload, actorEmail, { base } = {}) {\r\n  const timestamp = nowIso();\r\n  const title = asString(payload?.title, asString(base?.title));\r\n  if (!title) {\r\n    throw new Error(\"invalid_incident_title\");\r\n  }\r\n\r\n  const detectedAt = toIsoOrEmpty(payload?.detectedAt || base?.detectedAt || timestamp) || timestamp;\r\n  const severity = normalizeIncidentSeverity(payload?.severity, asString(base?.severity, \"Low\"));\r\n  const incidentType = normalizeIncidentType(payload?.incidentType, asString(base?.incidentType, \"Other\"));\r\n  const restrictedPiiInvolved = asBoolean(payload?.restrictedPiiInvolved, asBoolean(base?.restrictedPiiInvolved, false));\r\n  const executiveNotificationRequired = asBoolean(\r\n    payload?.executiveNotificationRequired,\r\n    severity === \"High\" || asBoolean(base?.executiveNotificationRequired, false),\r\n  );\r\n  const escalationRequired = asBoolean(\r\n    payload?.escalationRequired,\r\n    executiveNotificationRequired ||\r\n      restrictedPiiInvolved ||\r\n      incidentSeverityRank(severity) >= incidentSeverityRank(\"High\") ||\r\n      asBoolean(base?.escalationRequired, false),\r\n  );\r\n  const escalationLevel = resolveIncidentEscalationLevel({\r\n    severity,\r\n    restrictedPiiInvolved,\r\n    executiveNotificationRequired,\r\n  });\r\n\r\n  const status = normalizeIncidentStatus(payload?.status, asString(base?.status, \"Open\"));\r\n  const containmentStatus = normalizeIncidentContainmentStatus(\r\n    payload?.containmentStatus,\r\n    asString(base?.containmentStatus, \"Not Started\"),\r\n  );\r\n  const impactAssessmentStatus = normalizeIncidentImpactStatus(\r\n    payload?.impactAssessmentStatus,\r\n    asString(base?.impactAssessmentStatus, \"Pending\"),\r\n  );\r\n\r\n  const regulatoryNotificationRequired = asBoolean(\r\n    payload?.regulatoryNotificationRequired,\r\n    restrictedPiiInvolved || asBoolean(base?.regulatoryNotificationRequired, false),\r\n  );\r\n  const regulatoryDueAt = regulatoryNotificationRequired\r\n    ? asString(base?.regulatoryDueAt, addHoursToIso(detectedAt, 72))\r\n    : \"\";\r\n  const regulatoryNotifiedAt = toIsoOrEmpty(payload?.regulatoryNotifiedAt || base?.regulatoryNotifiedAt || \"\");\r\n  const affectedIndividualsNotifiedAt = toIsoOrEmpty(\r\n    payload?.affectedIndividualsNotifiedAt || base?.affectedIndividualsNotifiedAt || \"\",\r\n  );\r\n  const regulatoryStatus = resolveIncidentRegulatoryStatus({\r\n    regulatoryNotificationRequired,\r\n    regulatoryNotifiedAt,\r\n    regulatoryDueAt,\r\n    nowIsoValue: timestamp,\r\n  });\r\n\r\n  const documentationRetained = asBoolean(payload?.documentationRetained, asBoolean(base?.documentationRetained, false));\r\n  const documentationRetainedAt = documentationRetained\r\n    ? toIsoOrEmpty(payload?.documentationRetainedAt || base?.documentationRetainedAt || timestamp) || timestamp\r\n    : \"\";\r\n  const executiveNotifiedAt = toIsoOrEmpty(payload?.executiveNotifiedAt || base?.executiveNotifiedAt || \"\");\r\n  const grcAlertedAt = escalationRequired\r\n    ? toIsoOrEmpty(payload?.grcAlertedAt || base?.grcAlertedAt || timestamp) || timestamp\r\n    : \"\";\r\n  const breachConfirmed = asBoolean(payload?.breachConfirmed, asBoolean(base?.breachConfirmed, false));\r\n  const breachConfirmedAt = breachConfirmed\r\n    ? toIsoOrEmpty(payload?.breachConfirmedAt || base?.breachConfirmedAt || timestamp) || timestamp\r\n    : \"\";\r\n  const breachConfirmedBy = breachConfirmed\r\n    ? normalizeEmail(payload?.breachConfirmedBy || base?.breachConfirmedBy || actorEmail)\r\n    : \"\";\r\n\r\n  const containmentStartedAt =\r\n    containmentStatus === \"In Progress\" || containmentStatus === \"Contained\"\r\n      ? toIsoOrEmpty(payload?.containmentStartedAt || base?.containmentStartedAt || timestamp) || timestamp\r\n      : toIsoOrEmpty(payload?.containmentStartedAt || base?.containmentStartedAt || \"\");\r\n  const containmentCompletedAt =\r\n    containmentStatus === \"Contained\"\r\n      ? toIsoOrEmpty(payload?.containmentCompletedAt || base?.containmentCompletedAt || timestamp) || timestamp\r\n      : toIsoOrEmpty(payload?.containmentCompletedAt || base?.containmentCompletedAt || \"\");\r\n  const impactAssessmentCompletedAt =\r\n    impactAssessmentStatus === \"Completed\"\r\n      ? toIsoOrEmpty(payload?.impactAssessmentCompletedAt || base?.impactAssessmentCompletedAt || timestamp) || timestamp\r\n      : toIsoOrEmpty(payload?.impactAssessmentCompletedAt || base?.impactAssessmentCompletedAt || \"\");\r\n\r\n  const forensicWindowStart = toIsoOrEmpty(payload?.forensicWindowStart || base?.forensicWindowStart || detectedAt) || detectedAt;\r\n  const forensicWindowEnd = toIsoOrEmpty(payload?.forensicWindowEnd || base?.forensicWindowEnd || timestamp) || timestamp;\r\n  const evidenceDocuments = sanitizeIncidentEvidenceDocuments(\r\n    Object.prototype.hasOwnProperty.call(asObject(payload, {}), \"evidenceDocuments\")\r\n      ? payload?.evidenceDocuments\r\n      : base?.evidenceDocuments,\r\n    actorEmail,\r\n    timestamp,\r\n  );\r\n  const detectionWindowStart = toIsoOrEmpty(payload?.detectionWindowStart || base?.detectionWindowStart || \"\");\r\n  const detectionWindowEnd = toIsoOrEmpty(payload?.detectionWindowEnd || base?.detectionWindowEnd || \"\");\r\n  const detectionCorrelationKey = asString(payload?.detectionCorrelationKey, asString(base?.detectionCorrelationKey));\r\n  const alertDescription = asString(payload?.alertDescription, asString(base?.alertDescription));\r\n  const alertOccurrences = sanitizeIncidentAlertOccurrences(payload?.alertOccurrences || base?.alertOccurrences);\r\n  const alertFirstObservedAt = toIsoOrEmpty(\r\n    payload?.alertFirstObservedAt || base?.alertFirstObservedAt || detectedAt || \"\",\r\n  );\r\n  const alertLastObservedAt = toIsoOrEmpty(\r\n    payload?.alertLastObservedAt || base?.alertLastObservedAt || detectedAt || \"\",\r\n  );\r\n  const defaultOccurrenceCount = alertOccurrences.length > 0 ? alertOccurrences.length : 1;\r\n  const alertOccurrenceCount = Math.max(\r\n    1,\r\n    Number.parseInt(\r\n      String(\r\n        payload?.alertOccurrenceCount ??\r\n          base?.alertOccurrenceCount ??\r\n          defaultOccurrenceCount,\r\n      ),\r\n      10,\r\n    ) || defaultOccurrenceCount,\r\n  );\r\n  const alertRecipients = asArray(payload?.alertRecipients || base?.alertRecipients)\r\n    .map((value) => normalizeEmail(value))\r\n    .filter(Boolean)\r\n    .slice(0, 40);\r\n  const involvedEmployees = asArray(payload?.involvedEmployees || base?.involvedEmployees)\r\n    .map((value) => normalizeEmail(value))\r\n    .filter(Boolean)\r\n    .slice(0, 40);\r\n\r\n  return {\r\n    incidentCode: asString(base?.incidentCode, buildIncidentCode(detectedAt)),\r\n    title,\r\n    summary: asString(payload?.summary, asString(base?.summary)),\r\n    incidentType,\r\n    severity,\r\n    status,\r\n    restrictedPiiInvolved,\r\n    affectedEmployeeEmail: normalizeEmail(payload?.affectedEmployeeEmail || base?.affectedEmployeeEmail),\r\n    ownerEmail: normalizeEmail(payload?.ownerEmail || base?.ownerEmail || actorEmail),\r\n    department: asString(payload?.department, asString(base?.department)),\r\n    involvedEmployees,\r\n    escalationRequired,\r\n    escalationLevel,\r\n    executiveNotificationRequired,\r\n    executiveNotifiedAt,\r\n    grcAlertedAt,\r\n    containmentStatus,\r\n    containmentSummary: asString(payload?.containmentSummary, asString(base?.containmentSummary)),\r\n    containmentStartedAt,\r\n    containmentCompletedAt,\r\n    impactAssessmentStatus,\r\n    impactSummary: asString(payload?.impactSummary, asString(base?.impactSummary)),\r\n    impactAssessmentCompletedAt,\r\n    regulatoryNotificationRequired,\r\n    regulatoryDueAt,\r\n    regulatoryNotifiedAt,\r\n    affectedIndividualsNotifiedAt,\r\n    regulatoryStatus,\r\n    documentationRetained,\r\n    documentationRetainedAt,\r\n    documentationLocation: asString(payload?.documentationLocation, asString(base?.documentationLocation)),\r\n    breachConfirmed,\r\n    breachConfirmedAt,\r\n    breachConfirmedBy,\r\n    correctiveActions: asString(payload?.correctiveActions, asString(base?.correctiveActions)),\r\n    disciplinaryActions: asString(payload?.disciplinaryActions, asString(base?.disciplinaryActions)),\r\n    resolutionNotes: asString(payload?.resolutionNotes, asString(base?.resolutionNotes)),\r\n    closureApprovalStatus: asString(payload?.closureApprovalStatus, asString(base?.closureApprovalStatus, \"Pending Approval\")),\r\n    closureApprovedBy: asString(payload?.closureApprovedBy, asString(base?.closureApprovedBy)),\r\n    closureApprovedAt: toIsoOrEmpty(payload?.closureApprovedAt || base?.closureApprovedAt || \"\"),\r\n    forensicWindowStart,\r\n    forensicWindowEnd,\r\n    evidenceDocuments,\r\n    evidenceDocumentsCount: evidenceDocuments.length,\r\n    notes: asString(payload?.notes, asString(base?.notes)),\r\n    classificationStandard: asString(payload?.classificationStandard, asString(base?.classificationStandard, \"CLIO-IR-SEVERITY-V1\")),\r\n    autoGenerated: asBoolean(payload?.autoGenerated, asBoolean(base?.autoGenerated, false)),\r\n    detectionRuleId: asString(payload?.detectionRuleId, asString(base?.detectionRuleId)),\r\n    detectionFingerprint: asString(payload?.detectionFingerprint, asString(base?.detectionFingerprint)),\r\n    detectionCorrelationKey,\r\n    detectionWindowStart,\r\n    detectionWindowEnd,\r\n    alertDescription,\r\n    alertOccurrenceCount,\r\n    alertFirstObservedAt,\r\n    alertLastObservedAt,\r\n    alertOccurrences,\r\n    sourceSystem: asString(payload?.sourceSystem, asString(base?.sourceSystem)),\r\n    sourceEventId: asString(payload?.sourceEventId, asString(base?.sourceEventId)),\r\n    sourceEventModule: asString(payload?.sourceEventModule, asString(base?.sourceEventModule)),\r\n    sourceEventPath: asString(payload?.sourceEventPath, asString(base?.sourceEventPath)),\r\n    sourceIp: asString(payload?.sourceIp, asString(base?.sourceIp)),\r\n    alertRecipients,\r\n    alertDispatchSummary: asObject(payload?.alertDispatchSummary, asObject(base?.alertDispatchSummary, {})),\r\n    externalIntegrations: asObject(payload?.externalIntegrations, asObject(base?.externalIntegrations, {})),\r\n    lastAlertDispatchAt: toIsoOrEmpty(payload?.lastAlertDispatchAt || base?.lastAlertDispatchAt || \"\"),\r\n    detectedAt,\r\n    resolvedAt: toIsoOrEmpty(payload?.resolvedAt || base?.resolvedAt || (status === \"Resolved\" ? timestamp : \"\")),\r\n    closedAt: toIsoOrEmpty(payload?.closedAt || base?.closedAt || (status === \"Closed\" ? timestamp : \"\")),\r\n    createdAt: asString(base?.createdAt, timestamp),\r\n    createdBy: asString(base?.createdBy, actorEmail),\r\n    updatedAt: timestamp,\r\n    updatedBy: actorEmail,\r\n    traceability: appendTrail(base?.traceability, {\r\n      at: timestamp,\r\n      by: actorEmail,\r\n      action: base ? \"update\" : \"create\",\r\n      status,\r\n      severity,\r\n      escalationLevel,\r\n      regulatoryStatus,\r\n    }),\r\n  };\r\n}\r\n\r\nfunction withIncidentForensic(record, forensicSnapshot, actorEmail) {\r\n  const snapshot = asObject(forensicSnapshot, {});\r\n  return {\r\n    ...record,\r\n    forensicSnapshot: snapshot,\r\n    forensicSummary: {\r\n      accessLogsCount: Number(snapshot.accessLogsCount || 0),\r\n      exportLogsCount: Number(snapshot.exportLogsCount || 0),\r\n      administrativeActionsCount: Number(snapshot.administrativeActionsCount || 0),\r\n      deletionActivitiesCount: Number(snapshot.deletionActivitiesCount || 0),\r\n      totalScopedLogs: Number(snapshot.totalScopedLogs || 0),\r\n      generatedAt: asString(snapshot.generatedAt),\r\n      windowStart: asString(snapshot.windowStart),\r\n      windowEnd: asString(snapshot.windowEnd),\r\n    },\r\n    forensicLastUpdatedAt: asString(snapshot.generatedAt, nowIso()),\r\n    forensicLastUpdatedBy: actorEmail,\r\n  };\r\n}\r\n\r\nexport async function listIncidentRecordsBackend() {\r\n  return await listCollectionRecords(getCollectionName(\"incidents\"));\r\n}\r\n\r\nexport async function getIncidentRecordBackend(recordId) {\r\n  return await getCollectionRecordById(getCollectionName(\"incidents\"), recordId);\r\n}\r\n\r\nexport async function createIncidentRecordBackend(payload, actorEmail) {\r\n  const normalized = normalizeIncidentWritePayload(payload, actorEmail);\r\n  const forensicSnapshot = await buildIncidentForensicSnapshot(normalized, {\r\n    limit: Number.parseInt(env(\"CLIO_INCIDENT_FORENSIC_LOG_LIMIT\", \"1800\"), 10),\r\n  });\r\n  const withForensic = withIncidentForensic(normalized, forensicSnapshot, actorEmail);\r\n  return await createCollectionRecord(getCollectionName(\"incidents\"), withForensic);\r\n}\r\n\r\nexport async function updateIncidentRecordBackend(recordId, payload, actorEmail) {\r\n  const current = await getIncidentRecordBackend(recordId);\r\n  if (!current) {\r\n    return null;\r\n  }\r\n  const normalized = normalizeIncidentWritePayload(payload, actorEmail, { base: current });\r\n  const shouldRefreshForensic =\r\n    asBoolean(payload?.refreshForensicSnapshot, false) ||\r\n    Object.prototype.hasOwnProperty.call(asObject(payload, {}), \"forensicWindowStart\") ||\r\n    Object.prototype.hasOwnProperty.call(asObject(payload, {}), \"forensicWindowEnd\") ||\r\n    Object.prototype.hasOwnProperty.call(asObject(payload, {}), \"affectedEmployeeEmail\") ||\r\n    Object.prototype.hasOwnProperty.call(asObject(payload, {}), \"detectedAt\");\r\n\r\n  const forensicSnapshot = shouldRefreshForensic\r\n    ? await buildIncidentForensicSnapshot(normalized, {\r\n        limit: Number.parseInt(env(\"CLIO_INCIDENT_FORENSIC_LOG_LIMIT\", \"1800\"), 10),\r\n      })\r\n    : asObject(current.forensicSnapshot, {});\r\n  const withForensic = withIncidentForensic(normalized, forensicSnapshot, actorEmail);\r\n  return await updateCollectionRecord(getCollectionName(\"incidents\"), recordId, withForensic);\r\n}\r\n\r\nasync function purgeCollectionByRetention(collectionName, cutoff) {\r\n  const db = getDbOrThrow();\r\n  const snapshot = await getDocs(\r\n    query(collection(db, collectionName), where(\"retentionDeleteAt\", \"<=\", cutoff)),\r\n  );\r\n  let deleted = 0;\r\n  for (const recordSnapshot of snapshot.docs) {\r\n    await deleteDoc(doc(db, collectionName, recordSnapshot.id));\r\n    deleted += 1;\r\n  }\r\n  return deleted;\r\n}\r\n\r\nasync function purgeEmployeeCollectionByRetention(cutoff) {\r\n  const db = getDbOrThrow();\r\n  const employeesCollection = getCollectionName(\"employees\");\r\n  const snapshot = await getDocs(\r\n    query(collection(db, employeesCollection), where(\"retentionDeleteAt\", \"<=\", cutoff)),\r\n  );\r\n\r\n  let deleted = 0;\r\n  for (const recordSnapshot of snapshot.docs) {\r\n    await deleteEmployeeDocumentSubcollectionById(recordSnapshot.id, { db });\r\n    await deleteDoc(doc(db, employeesCollection, recordSnapshot.id));\r\n    deleted += 1;\r\n  }\r\n  return deleted;\r\n}\r\n\r\nexport async function purgeArchivedEmployeeDataBackend({ now } = {}) {\r\n  const cutoff = asString(now, nowIso());\r\n  const deletedByCollection = {\r\n    employees: await purgeEmployeeCollectionByRetention(cutoff),\r\n    lifecycle: await purgeCollectionByRetention(getCollectionName(\"lifecycle\"), cutoff),\r\n    attendance: await purgeCollectionByRetention(getCollectionName(\"attendance\"), cutoff),\r\n    leave: await purgeCollectionByRetention(getCollectionName(\"leave\"), cutoff),\r\n    performance: await purgeCollectionByRetention(getCollectionName(\"performance\"), cutoff),\r\n    exports: await purgeCollectionByRetention(getCollectionName(\"exports\"), cutoff),\r\n  };\r\n\r\n  const deletedUsers = await purgeDueArchivedUserAccounts({ now: cutoff });\r\n  return {\r\n    cutoff,\r\n    deletedByCollection,\r\n    deletedUsers,\r\n  };\r\n}\r\n\r\nfunction toTimeMs(value) {\r\n  const timestamp = new Date(value || \"\").getTime();\r\n  return Number.isNaN(timestamp) ? null : timestamp;\r\n}\r\n\r\nfunction toIsoOrEmpty(value) {\r\n  const timestamp = toTimeMs(value);\r\n  if (!Number.isFinite(timestamp)) {\r\n    return \"\";\r\n  }\r\n  return new Date(timestamp).toISOString();\r\n}\r\n\r\nfunction clampInt(value, fallback, { min = 0, max = Number.MAX_SAFE_INTEGER } = {}) {\r\n  const parsed = Number.parseInt(String(value ?? \"\"), 10);\r\n  if (!Number.isFinite(parsed)) {\r\n    return fallback;\r\n  }\r\n  return Math.min(max, Math.max(min, parsed));\r\n}\r\n\r\nfunction deriveRetentionState(retentionDeleteAt, nowMs, dueWithinMs) {\r\n  const retentionMs = toTimeMs(retentionDeleteAt);\r\n  if (!Number.isFinite(retentionMs)) {\r\n    return {\r\n      state: \"no_retention\",\r\n      daysToDeletion: null,\r\n    };\r\n  }\r\n\r\n  const daysToDeletion = Math.ceil((retentionMs - nowMs) / (24 * 60 * 60 * 1000));\r\n  if (retentionMs <= nowMs) {\r\n    return {\r\n      state: \"due\",\r\n      daysToDeletion,\r\n    };\r\n  }\r\n\r\n  if (retentionMs <= nowMs + dueWithinMs) {\r\n    return {\r\n      state: \"due_soon\",\r\n      daysToDeletion,\r\n    };\r\n  }\r\n\r\n  return {\r\n    state: \"scheduled\",\r\n    daysToDeletion,\r\n  };\r\n}\r\n\r\nfunction getRetentionRecordLabel(moduleId, row, moduleLabel) {\r\n  const recordId = asString(row?.recordId, asString(row?.id));\r\n  if (moduleId === \"employees\") {\r\n    return asString(row?.name, asString(row?.employeeId, asString(row?.email, recordId || `${moduleLabel} Record`)));\r\n  }\r\n  if (moduleId === \"lifecycle\") {\r\n    const employee = asString(row?.employee, asString(row?.employeeEmail));\r\n    const category = asString(row?.category);\r\n    return [employee || \"Employee\", category].filter(Boolean).join(\" - \");\r\n  }\r\n  if (moduleId === \"attendance\") {\r\n    return [asString(row?.employee, \"Employee\"), asString(row?.date)].filter(Boolean).join(\" - \");\r\n  }\r\n  if (moduleId === \"leave\") {\r\n    return [asString(row?.employee, \"Employee\"), asString(row?.leaveType, \"Leave\")].filter(Boolean).join(\" - \");\r\n  }\r\n  if (moduleId === \"performance\") {\r\n    return [asString(row?.employee, \"Employee\"), asString(row?.period, \"Performance\")].filter(Boolean).join(\" - \");\r\n  }\r\n  if (moduleId === \"exports\") {\r\n    return [asString(row?.dataset, \"Export Request\"), asString(row?.format)].filter(Boolean).join(\" - \");\r\n  }\r\n  if (moduleId === \"user_accounts\") {\r\n    return asString(row?.email, recordId || \"User Account\");\r\n  }\r\n\r\n  return asString(\r\n    row?.name,\r\n    asString(row?.employee, asString(row?.dataset, asString(row?.email, recordId || `${moduleLabel} Record`))),\r\n  );\r\n}\r\n\r\nfunction toRetentionArchiveRecord({ moduleId, moduleLabel, row, nowMs, dueWithinMs }) {\r\n  const archivedAt = toIsoOrEmpty(row?.archivedAt);\r\n  const retentionDeleteAt = toIsoOrEmpty(row?.retentionDeleteAt);\r\n  const normalizedStatus = normalizeText(row?.status);\r\n  const normalizedArchiveStatus = normalizeText(row?.archiveStatus);\r\n  const isArchived = Boolean(\r\n    row?.isArchived ||\r\n      archivedAt ||\r\n      retentionDeleteAt ||\r\n      normalizedStatus === \"archived\" ||\r\n      normalizedArchiveStatus === \"archived\",\r\n  );\r\n  if (!isArchived) {\r\n    return null;\r\n  }\r\n\r\n  const recordId = asString(row?.recordId, asString(row?.id));\r\n  const retention = deriveRetentionState(retentionDeleteAt, nowMs, dueWithinMs);\r\n  const label = getRetentionRecordLabel(moduleId, row, moduleLabel);\r\n  const ownerEmail = normalizeEmail(row?.employeeEmail || row?.email || row?.requestedBy || row?.ownerEmail);\r\n  const subtitleParts = [\r\n    asString(row?.employeeId),\r\n    ownerEmail,\r\n    asString(row?.department),\r\n    asString(row?.category),\r\n  ].filter(Boolean);\r\n\r\n  return {\r\n    id: `${moduleId}:${recordId || Math.random().toString(36).slice(2, 10)}`,\r\n    moduleId,\r\n    moduleLabel,\r\n    recordId: recordId || \"\",\r\n    title: label,\r\n    subtitle: subtitleParts.join(\" | \"),\r\n    ownerEmail: ownerEmail || \"\",\r\n    status: asString(row?.status, asString(row?.archiveStatus, \"Archived\")),\r\n    archiveReason: asString(row?.archiveReason, asString(row?.reason, asString(row?.reviewNote, \"\"))),\r\n    archivedAt,\r\n    retentionDeleteAt,\r\n    daysToDeletion: retention.daysToDeletion,\r\n    deletionState: retention.state,\r\n    updatedAt: toIsoOrEmpty(row?.updatedAt),\r\n  };\r\n}\r\n\r\nfunction summarizeRetentionRecords(records, { moduleCatalog, nowMs, dueWithinDays }) {\r\n  const dueCounts = {\r\n    due: 0,\r\n    dueSoon: 0,\r\n    scheduled: 0,\r\n    noRetention: 0,\r\n  };\r\n\r\n  const moduleCounts = moduleCatalog.map((module) => ({\r\n    id: module.id,\r\n    label: module.label,\r\n    count: 0,\r\n  }));\r\n  const moduleCountById = new Map(moduleCounts.map((item) => [item.id, item]));\r\n\r\n  let nextDeletionAt = \"\";\r\n  let oldestArchivedAt = \"\";\r\n\r\n  records.forEach((record) => {\r\n    if (record.deletionState === \"due\") {\r\n      dueCounts.due += 1;\r\n    } else if (record.deletionState === \"due_soon\") {\r\n      dueCounts.dueSoon += 1;\r\n    } else if (record.deletionState === \"scheduled\") {\r\n      dueCounts.scheduled += 1;\r\n    } else {\r\n      dueCounts.noRetention += 1;\r\n    }\r\n\r\n    const moduleCount = moduleCountById.get(record.moduleId);\r\n    if (moduleCount) {\r\n      moduleCount.count += 1;\r\n    }\r\n\r\n    if (record.retentionDeleteAt) {\r\n      if (!nextDeletionAt || toTimeMs(record.retentionDeleteAt) < toTimeMs(nextDeletionAt)) {\r\n        nextDeletionAt = record.retentionDeleteAt;\r\n      }\r\n    }\r\n\r\n    if (record.archivedAt) {\r\n      if (!oldestArchivedAt || toTimeMs(record.archivedAt) < toTimeMs(oldestArchivedAt)) {\r\n        oldestArchivedAt = record.archivedAt;\r\n      }\r\n    }\r\n  });\r\n\r\n  return {\r\n    generatedAt: new Date(nowMs).toISOString(),\r\n    totalArchived: records.length,\r\n    dueNow: dueCounts.due,\r\n    dueWithinWindow: dueCounts.due + dueCounts.dueSoon,\r\n    scheduledFuture: dueCounts.scheduled,\r\n    missingRetentionDate: dueCounts.noRetention,\r\n    nextDeletionAt: nextDeletionAt || null,\r\n    oldestArchivedAt: oldestArchivedAt || null,\r\n    dueWithinDays,\r\n    moduleBreakdown: moduleCounts.sort((left, right) => right.count - left.count),\r\n  };\r\n}\r\n\r\nfunction sortRetentionRecords(records) {\r\n  const stateRank = {\r\n    due: 0,\r\n    due_soon: 1,\r\n    scheduled: 2,\r\n    no_retention: 3,\r\n  };\r\n\r\n  return [...records].sort((left, right) => {\r\n    const leftRank = stateRank[left.deletionState] ?? 9;\r\n    const rightRank = stateRank[right.deletionState] ?? 9;\r\n    if (leftRank !== rightRank) {\r\n      return leftRank - rightRank;\r\n    }\r\n\r\n    const leftRetention = toTimeMs(left.retentionDeleteAt);\r\n    const rightRetention = toTimeMs(right.retentionDeleteAt);\r\n    if (Number.isFinite(leftRetention) && Number.isFinite(rightRetention) && leftRetention !== rightRetention) {\r\n      return leftRetention - rightRetention;\r\n    }\r\n    if (Number.isFinite(leftRetention) && !Number.isFinite(rightRetention)) {\r\n      return -1;\r\n    }\r\n    if (!Number.isFinite(leftRetention) && Number.isFinite(rightRetention)) {\r\n      return 1;\r\n    }\r\n\r\n    return (toTimeMs(right.archivedAt) || 0) - (toTimeMs(left.archivedAt) || 0);\r\n  });\r\n}\r\n\r\nexport async function listRetentionArchiveSnapshotBackend({\r\n  moduleId = \"all\",\r\n  status = \"all\",\r\n  queryText = \"\",\r\n  dueWithinDays = 30,\r\n  now,\r\n} = {}) {\r\n  const normalizedModuleId = normalizeText(moduleId) || \"all\";\r\n  const normalizedStatus = normalizeText(status) || \"all\";\r\n  const normalizedQuery = normalizeText(queryText);\r\n  const retentionYears = getArchiveRetentionYears();\r\n  const safeDueWithinDays = clampInt(dueWithinDays, 30, { min: 1, max: 365 });\r\n  const nowIsoValue = toIsoOrEmpty(now) || nowIso();\r\n  const nowMs = toTimeMs(nowIsoValue) || Date.now();\r\n  const dueWithinMs = safeDueWithinDays * 24 * 60 * 60 * 1000;\r\n\r\n  const moduleCatalog = [\r\n    { id: \"employees\", label: \"Employee Records\", loader: () => listEmployeeRecordsBackend() },\r\n    { id: \"lifecycle\", label: \"Employment Lifecycle\", loader: () => listLifecycleRecordsBackend() },\r\n    { id: \"attendance\", label: \"Attendance\", loader: () => listAttendanceLogsBackend() },\r\n    { id: \"leave\", label: \"Leave Requests\", loader: () => listLeaveRequestsBackend() },\r\n    { id: \"performance\", label: \"Performance\", loader: () => listPerformanceRecordsBackend() },\r\n    { id: \"exports\", label: \"Reports & Exports\", loader: () => listExportRequestsBackend() },\r\n    { id: \"user_accounts\", label: \"User Accounts\", loader: () => listUserAccounts() },\r\n  ];\r\n\r\n  const moduleIds = new Set(moduleCatalog.map((item) => item.id));\r\n  if (normalizedModuleId !== \"all\" && !moduleIds.has(normalizedModuleId)) {\r\n    throw new Error(\"invalid_retention_module\");\r\n  }\r\n\r\n  const supportedStatusFilters = new Set([\"all\", \"due\", \"due_soon\", \"scheduled\", \"no_retention\"]);\r\n  const effectiveStatus = supportedStatusFilters.has(normalizedStatus) ? normalizedStatus : \"all\";\r\n\r\n  const loaded = await Promise.all(\r\n    moduleCatalog.map(async (module) => {\r\n      const rows = await module.loader();\r\n      return {\r\n        ...module,\r\n        rows: Array.isArray(rows) ? rows : [],\r\n      };\r\n    }),\r\n  );\r\n\r\n  const archivedRecords = loaded.flatMap((module) =>\r\n    module.rows\r\n      .map((row) =>\r\n        toRetentionArchiveRecord({\r\n          moduleId: module.id,\r\n          moduleLabel: module.label,\r\n          row,\r\n          nowMs,\r\n          dueWithinMs,\r\n        }),\r\n      )\r\n      .filter(Boolean),\r\n  );\r\n\r\n  const moduleScopedRecords =\r\n    normalizedModuleId === \"all\"\r\n      ? archivedRecords\r\n      : archivedRecords.filter((record) => record.moduleId === normalizedModuleId);\r\n\r\n  const filteredRecords = moduleScopedRecords.filter((record) => {\r\n    const byStatus = effectiveStatus === \"all\" ? true : record.deletionState === effectiveStatus;\r\n    const textBlob = normalizeText(\r\n      [\r\n        record.moduleLabel,\r\n        record.recordId,\r\n        record.title,\r\n        record.subtitle,\r\n        record.ownerEmail,\r\n        record.archiveReason,\r\n      ].join(\" \"),\r\n    );\r\n    const byQuery = normalizedQuery ? textBlob.includes(normalizedQuery) : true;\r\n    return byStatus && byQuery;\r\n  });\r\n\r\n  return {\r\n    policy: {\r\n      retentionYears,\r\n      dueWithinDays: safeDueWithinDays,\r\n      generatedAt: nowIsoValue,\r\n      moduleCatalog: moduleCatalog.map((module) => ({\r\n        id: module.id,\r\n        label: module.label,\r\n      })),\r\n    },\r\n    summary: summarizeRetentionRecords(moduleScopedRecords, {\r\n      moduleCatalog,\r\n      nowMs,\r\n      dueWithinDays: safeDueWithinDays,\r\n    }),\r\n    records: sortRetentionRecords(filteredRecords),\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}