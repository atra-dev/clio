module.exports=[22177,e=>{"use strict";function t(e,r=""){return String(e||"").trim()||r}function r(e){return Array.isArray(e)?e:[]}function n(e){return t(e).toLowerCase()}function o(e){return String(e||"").replace(/[^\d+]/g,"").trim()}function i(e){return t(e).split(",").map(e=>e.trim()).filter(Boolean)}function s(e=[]){return Array.from(new Set(e.filter(Boolean)))}function a(){let e,r=(e=t(process.env.CLIO_ALERT_EMAIL_PROVIDER).toLowerCase())?e.includes("resend")?"resend":e.includes("firebase")?"firebase":e.includes("console")||"dev"===e?"console":"none"===e||"off"===e?"none":e:"";return r||"none"}function l(){let e,r=(e=t(process.env.CLIO_ALERT_SMS_PROVIDER).toLowerCase())?e.includes("twilio")?"twilio":e.includes("console")||"dev"===e?"console":"none"===e||"off"===e?"none":e:"";return r||"none"}function c(e=[]){return s([...i(process.env.CLIO_SECURITY_ALERT_RECIPIENTS),...i(process.env.GRC_EMAILS),...i(process.env.SUPER_ADMIN_EMAILS),...r(e)].map(e=>n(e)).filter(Boolean))}async function u({recipients:e,subject:r,text:n,html:o}){let i=t(process.env.RESEND_API_KEY),s=t(process.env.CLIO_EMAIL_FROM);if(!i||!s||!i.startsWith("re_"))throw Error("email_provider_not_configured");let a=await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({from:s,to:e,subject:r,text:n,html:o})}),l=await a.json().catch(()=>({}));if(!a.ok){let e=t(l?.message)||t(l?.error?.message)||"email_delivery_failed";throw Error(`email_delivery_failed:${e}`)}return{provider:"resend",status:"sent",messageId:t(l?.id,`resend-${Date.now()}`),recipientCount:e.length}}async function d({recipients:e,subject:o,text:i,html:l}){let c=s(r(e).map(n).filter(Boolean));if(0===c.length)return{provider:"none",status:"skipped",reason:"no_recipients",recipientCount:0};let d=a();return"none"===d?{provider:d,status:"skipped",reason:"provider_disabled",recipientCount:0}:"firebase"===d?{provider:d,status:"skipped",reason:"firebase_not_supported_for_custom_alert_email",recipientCount:0}:"console"===d?function({recipients:e,subject:r,text:n}){return function(e,r=!1){let n=t(process.env[e]).toLowerCase();return n?"true"===n||"1"===n||"yes"===n:r}("CLIO_ALLOW_CONSOLE_EMAIL",!0)&&console.info("[CLIO:SecurityAlert:Email]",{recipients:e,subject:r,text:n}),{provider:"console",status:"simulated",recipientCount:e.length}}({recipients:c,subject:o,text:i}):"resend"===d?await u({recipients:c,subject:o,text:i,html:l}):{provider:d,status:"skipped",reason:"unsupported_provider",recipientCount:0}}async function p({recipients:e,body:r}){let n=t(process.env.TWILIO_ACCOUNT_SID),o=t(process.env.TWILIO_AUTH_TOKEN),i=t(process.env.TWILIO_FROM_NUMBER);if(!n||!o||!i)throw Error("twilio_not_configured");let s=Buffer.from(`${n}:${o}`,"utf8").toString("base64"),a=e.map(async e=>{let o=new URLSearchParams;o.set("To",e),o.set("From",i),o.set("Body",r);let a=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${encodeURIComponent(n)}/Messages.json`,{method:"POST",headers:{Authorization:`Basic ${s}`,"Content-Type":"application/x-www-form-urlencoded"},body:o.toString()}),l=await a.json().catch(()=>({}));if(!a.ok){let e=t(l?.message,"sms_delivery_failed");throw Error(`twilio_delivery_failed:${e}`)}return{to:e,sid:t(l?.sid)}}),l=await Promise.allSettled(a),c=l.filter(e=>"fulfilled"===e.status).map(e=>e.value),u=l.filter(e=>"rejected"===e.status).map(e=>t(e.reason?.message||"sms_delivery_failed"));return{provider:"twilio",status:u.length>0?c.length>0?"partial":"failed":"sent",deliveredCount:c.length,recipientCount:e.length,delivered:c,failed:u}}async function m({recipients:e,body:t}){let n=s(r(e).map(o).filter(Boolean));if(0===n.length)return{provider:"none",status:"skipped",reason:"no_recipients",deliveredCount:0,recipientCount:0,failed:[]};let i=l();return"none"===i?{provider:i,status:"skipped",reason:"provider_disabled",deliveredCount:0,recipientCount:n.length,failed:[]}:"console"===i?function({recipients:e,body:t}){return{provider:"console",status:"simulated",deliveredCount:e.length,recipientCount:e.length,delivered:e.map(e=>({to:e,sid:`console-${Date.now()}`})),failed:[]}}({recipients:n,body:t}):"twilio"===i?await p({recipients:n,body:t}):{provider:i,status:"skipped",reason:"unsupported_provider",deliveredCount:0,recipientCount:n.length,failed:[]}}async function f({url:e,label:r,token:n,payload:o,timeoutMs:i}){let s=new AbortController,a=setTimeout(()=>s.abort(),i);try{let i={"Content-Type":"application/json","X-CLIO-Source":"security-detection","X-CLIO-Target":r};n&&(i.Authorization=`Bearer ${n}`);let a=await fetch(e,{method:"POST",headers:i,body:JSON.stringify(o),signal:s.signal}),l=await a.text().catch(()=>"");return{label:r,url:e,ok:a.ok,status:a.status,body:t(l)}}catch(n){return{label:r,url:e,ok:!1,status:0,body:t(n?.message,"webhook_delivery_failed")}}finally{clearTimeout(a)}}async function _(e){let r,n,o,s,a=(r=i(process.env.CLIO_SECURITY_WEBHOOK_URLS).map(e=>({label:"security-webhook",url:e,token:t(process.env.CLIO_SECURITY_WEBHOOK_TOKEN)})),n=t(process.env.CLIO_SIEM_WEBHOOK_URL),o=t(process.env.CLIO_EDR_WEBHOOK_URL),s=[...r],n&&s.push({label:"siem",url:n,token:t(process.env.CLIO_SIEM_WEBHOOK_TOKEN)}),o&&s.push({label:"edr",url:o,token:t(process.env.CLIO_EDR_WEBHOOK_TOKEN)}),s.filter(e=>t(e.url)));if(0===a.length)return{status:"skipped",targets:[],successCount:0};let l=Number.parseInt(t(process.env.CLIO_SECURITY_WEBHOOK_TIMEOUT_MS,"5000"),10)||5e3,c=await Promise.all(a.map(t=>f({...t,payload:e,timeoutMs:Math.max(1e3,Math.min(2e4,l))}))),u=c.filter(e=>e.ok).length;return{status:u===c.length?"sent":u>0?"partial":"failed",targets:c,successCount:u}}async function C({incident:e,detection:n,sourceEvent:u,emailRecipients:p=[],smsRecipients:f=[]}={}){let v,I=c(p),y=function(e=[]){return s([...i(process.env.CLIO_SMS_ALERT_RECIPIENTS),...r(e)].map(e=>o(e)).filter(Boolean))}(f),h=function({incident:e,detection:r}){let n=t(e?.severity||r?.severity||"Medium").toUpperCase(),o=t(e?.incidentCode,"INCIDENT"),i=t(e?.title,"Security anomaly detected");return`[CLIO][${n}] ${o} - ${i}`}({incident:e,detection:n}),O=function({incident:e,detection:r,sourceEvent:n}){let o=t(r?.ruleId,"N/A"),i=t(n?.metadata?.sourceIp||n?.sourceIp,"unknown"),s=t(n?.performedBy,"unknown"),a=t(n?.metadata?.requestPath||n?.requestPath,"unknown"),l=Number(r?.observedCount||0),c=t(e?.detectedAt||n?.occurredAt,new Date().toISOString());return`CLIO security anomaly alert
Incident: ${t(e?.incidentCode,"-")} | ${t(e?.title,"-")}
Severity: ${t(e?.severity,"-")}
Rule: ${o}
Detected At: ${c}
Actor: ${s}
Source IP: ${i}
Request Path: ${a}
Observed Count: ${l>0?l:"-"}
Summary: ${t(e?.summary||r?.summary,"-")}
Action URL: ${t(e?.actionUrl,"/incident-management")}`}({incident:e,detection:n,sourceEvent:u}),E=(v=String(O||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"),`<pre style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap;">${v}</pre>`),[g,S,w]=await Promise.all([d({recipients:I,subject:h,text:O,html:E}).catch(e=>({provider:a(),status:"failed",reason:t(e?.message,"email_delivery_failed"),recipientCount:I.length})),m({recipients:y,body:`${h}
${O}`.slice(0,1200)}).catch(e=>({provider:l(),status:"failed",reason:t(e?.message,"sms_delivery_failed"),deliveredCount:0,recipientCount:y.length,failed:[t(e?.message,"sms_delivery_failed")]})),_({eventType:"clio.security.incident",generatedAt:new Date().toISOString(),incident:e,detection:n,sourceEvent:{id:t(u?.id),module:t(u?.module),activityName:t(u?.activityName),status:t(u?.status),occurredAt:t(u?.occurredAt),sourceIp:t(u?.metadata?.sourceIp||u?.sourceIp),requestPath:t(u?.metadata?.requestPath||u?.requestPath)}})]);return{subject:h,email:g,sms:S,webhooks:w,recipients:I,smsRecipients:y}}function v(e=[]){return c(e)}async function I({recipients:e=[],body:r=""}={}){return await m({recipients:e,body:t(r,"")})}e.s(["dispatchDirectSms",()=>I,"dispatchSecurityIncidentAlerts",()=>C,"resolveSecurityAlertEmailRecipients",()=>v])}];

//# sourceMappingURL=src_lib_security-alert-delivery_e5801815.js.map