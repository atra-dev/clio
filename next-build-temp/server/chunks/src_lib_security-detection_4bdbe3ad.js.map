{"version":3,"sources":["../../../src/lib/security-detection.js"],"sourcesContent":["import {\r\n  createIncidentRecordBackend,\r\n  listIncidentRecordsBackend,\r\n  updateIncidentRecordBackend,\r\n} from \"@/lib/hris-backend\";\r\nimport {\r\n  addDoc,\r\n  collection,\r\n  deleteDoc,\r\n  doc,\r\n  getDocs,\r\n  limit as queryLimit,\r\n  orderBy,\r\n  query,\r\n  updateDoc,\r\n} from \"firebase/firestore/lite\";\r\nimport { getFirestoreDb, isFirestoreEnabled } from \"@/lib/firebase\";\r\nimport {\r\n  createInAppNotificationsBulk,\r\n  resolveIncidentStakeholderRecipients,\r\n} from \"@/lib/security-notifications\";\r\nimport {\r\n  dispatchSecurityIncidentAlerts,\r\n  resolveSecurityAlertEmailRecipients,\r\n} from \"@/lib/security-alert-delivery\";\r\n\r\nconst EVENT_COUNTER_WINDOWS = new Map();\r\nconst INCIDENT_COOLDOWN_CACHE = new Map();\r\nconst MAX_COUNTER_BUCKET_SIZE = 256;\r\nconst DEFAULT_SYSTEM_ACTOR = \"system@gmail.com\";\r\nlet IDS_RETRY_DRAIN_PROMISE = null;\r\n\r\nconst PERMISSION_DENIED_REASONS = new Set([\r\n  \"missing_permission\",\r\n  \"role_not_allowed\",\r\n  \"ownership_validation_failed\",\r\n  \"unauthorized\",\r\n  \"account_not_active\",\r\n  \"session_role_mismatch\",\r\n  \"session_version_mismatch\",\r\n]);\r\nconst ACCOUNT_ACCESS_BLOCK_REASONS = new Set([\r\n  \"account_disabled\",\r\n  \"account_inactive\",\r\n  \"account_archived\",\r\n  \"offboarded_user\",\r\n]);\r\nconst PRIVILEGED_ROLE_KEYS = new Set([\"SUPER_ADMIN\", \"GRC\", \"HR\", \"EA\"]);\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction asString(value, fallback = \"\") {\r\n  const normalized = String(value || \"\").trim();\r\n  return normalized || fallback;\r\n}\r\n\r\nfunction asObject(value) {\r\n  if (value && typeof value === \"object\" && !Array.isArray(value)) {\r\n    return value;\r\n  }\r\n  return {};\r\n}\r\n\r\nfunction asArray(value) {\r\n  return Array.isArray(value) ? value : [];\r\n}\r\n\r\nfunction normalizeText(value) {\r\n  return asString(value).toLowerCase();\r\n}\r\n\r\nfunction normalizeEmail(value) {\r\n  return asString(value).toLowerCase();\r\n}\r\n\r\nfunction normalizeIp(value) {\r\n  const ip = asString(value).toLowerCase();\r\n  return ip || \"unknown\";\r\n}\r\n\r\nfunction normalizeRoleKey(value) {\r\n  return asString(value)\r\n    .toUpperCase()\r\n    .replace(/[^A-Z0-9]+/g, \"_\")\r\n    .replace(/^_+|_+$/g, \"\");\r\n}\r\n\r\nfunction toTimeMs(value) {\r\n  const timestamp = new Date(value || \"\").getTime();\r\n  return Number.isNaN(timestamp) ? null : timestamp;\r\n}\r\n\r\nfunction parseBooleanEnv(name, fallbackValue = false) {\r\n  const raw = normalizeText(process.env[name]);\r\n  if (!raw) {\r\n    return fallbackValue;\r\n  }\r\n  return raw === \"true\" || raw === \"1\" || raw === \"yes\";\r\n}\r\n\r\nfunction parseIntegerEnv(name, fallbackValue, { min = 1, max = Number.MAX_SAFE_INTEGER } = {}) {\r\n  const parsed = Number.parseInt(asString(process.env[name]), 10);\r\n  if (!Number.isFinite(parsed)) {\r\n    return fallbackValue;\r\n  }\r\n  return Math.min(max, Math.max(min, parsed));\r\n}\r\n\r\nfunction normalizeBaseUrl(value) {\r\n  const raw = asString(value);\r\n  if (!raw) {\r\n    return \"\";\r\n  }\r\n  if (raw.startsWith(\"http://\") || raw.startsWith(\"https://\")) {\r\n    return raw.replace(/\\/+$/, \"\");\r\n  }\r\n  return `https://${raw.replace(/^\\/+/, \"\").replace(/\\/+$/, \"\")}`;\r\n}\r\n\r\nfunction resolveAppBaseUrl() {\r\n  const configured = normalizeBaseUrl(process.env.CLIO_APP_BASE_URL);\r\n  if (configured) {\r\n    return configured;\r\n  }\r\n\r\n  const publicSiteUrl = normalizeBaseUrl(process.env.NEXT_PUBLIC_APP_URL);\r\n  if (publicSiteUrl) {\r\n    return publicSiteUrl;\r\n  }\r\n\r\n  const firebaseAuthDomain = normalizeBaseUrl(\r\n    process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN || process.env.FIREBASE_AUTH_DOMAIN,\r\n  );\r\n  if (firebaseAuthDomain) {\r\n    return firebaseAuthDomain;\r\n  }\r\n\r\n  const vercelUrl = normalizeBaseUrl(\r\n    process.env.VERCEL_PROJECT_PRODUCTION_URL || process.env.VERCEL_URL,\r\n  );\r\n  if (vercelUrl) {\r\n    return vercelUrl;\r\n  }\r\n\r\n  return \"\";\r\n}\r\n\r\nfunction getDetectionRetryQueueCollectionName() {\r\n  return asString(process.env.CLIO_FIRESTORE_IDS_RETRY_COLLECTION, \"clio_ids_retry_queue\");\r\n}\r\n\r\nfunction getDetectionDeadLetterCollectionName() {\r\n  return asString(process.env.CLIO_FIRESTORE_IDS_DEAD_LETTER_COLLECTION, \"clio_ids_dead_letter\");\r\n}\r\n\r\nfunction getDetectionQueueDb() {\r\n  if (!isFirestoreEnabled()) {\r\n    return null;\r\n  }\r\n  return getFirestoreDb();\r\n}\r\n\r\nfunction getDetectionConfig() {\r\n  return {\r\n    enabled: parseBooleanEnv(\"CLIO_IDS_ENABLED\", true),\r\n    authFailureThreshold: parseIntegerEnv(\"CLIO_IDS_AUTH_FAILURE_THRESHOLD\", 5, { min: 2, max: 30 }),\r\n    authFailureWindowMinutes: parseIntegerEnv(\"CLIO_IDS_AUTH_FAILURE_WINDOW_MINUTES\", 10, { min: 1, max: 120 }),\r\n    permissionDeniedThreshold: parseIntegerEnv(\"CLIO_IDS_PERMISSION_DENIED_THRESHOLD\", 3, { min: 2, max: 20 }),\r\n    permissionDeniedWindowMinutes: parseIntegerEnv(\"CLIO_IDS_PERMISSION_DENIED_WINDOW_MINUTES\", 15, { min: 1, max: 120 }),\r\n    exportSpikeThreshold: parseIntegerEnv(\"CLIO_IDS_EXPORT_SPIKE_THRESHOLD\", 4, { min: 2, max: 20 }),\r\n    exportSpikeWindowMinutes: parseIntegerEnv(\"CLIO_IDS_EXPORT_SPIKE_WINDOW_MINUTES\", 20, { min: 1, max: 180 }),\r\n    piiAccessSpikeThreshold: parseIntegerEnv(\"CLIO_IDS_PII_ACCESS_SPIKE_THRESHOLD\", 12, { min: 4, max: 80 }),\r\n    piiAccessSpikeWindowMinutes: parseIntegerEnv(\"CLIO_IDS_PII_ACCESS_SPIKE_WINDOW_MINUTES\", 15, { min: 1, max: 180 }),\r\n    offboardedAccessThreshold: parseIntegerEnv(\"CLIO_IDS_OFFBOARDED_ACCESS_THRESHOLD\", 2, { min: 1, max: 30 }),\r\n    offboardedAccessWindowMinutes: parseIntegerEnv(\"CLIO_IDS_OFFBOARDED_ACCESS_WINDOW_MINUTES\", 30, { min: 1, max: 240 }),\r\n    privilegedRoleChangeThreshold: parseIntegerEnv(\"CLIO_IDS_ROLE_ESCALATION_THRESHOLD\", 2, { min: 1, max: 20 }),\r\n    privilegedRoleChangeWindowMinutes: parseIntegerEnv(\"CLIO_IDS_ROLE_ESCALATION_WINDOW_MINUTES\", 60, { min: 1, max: 480 }),\r\n    breachWindowMinutes: parseIntegerEnv(\"CLIO_IDS_BREACH_WINDOW_MINUTES\", 30, { min: 5, max: 240 }),\r\n    breachExportThreshold: parseIntegerEnv(\"CLIO_IDS_BREACH_EXPORT_THRESHOLD\", 2, { min: 1, max: 50 }),\r\n    breachPiiThreshold: parseIntegerEnv(\"CLIO_IDS_BREACH_PII_THRESHOLD\", 6, { min: 1, max: 120 }),\r\n    breachDeniedThreshold: parseIntegerEnv(\"CLIO_IDS_BREACH_DENIED_THRESHOLD\", 2, { min: 0, max: 50 }),\r\n    incidentCooldownMinutes: parseIntegerEnv(\"CLIO_IDS_INCIDENT_COOLDOWN_MINUTES\", 15, { min: 1, max: 360 }),\r\n    maxRecipientCount: parseIntegerEnv(\"CLIO_IDS_MAX_RECIPIENTS\", 20, { min: 1, max: 100 }),\r\n    systemActorEmail: normalizeEmail(process.env.CLIO_IDS_SYSTEM_ACTOR_EMAIL) || DEFAULT_SYSTEM_ACTOR,\r\n    appBaseUrl: resolveAppBaseUrl(),\r\n    retryEnabled: parseBooleanEnv(\"CLIO_IDS_RETRY_ENABLED\", true),\r\n    retryBatchSize: parseIntegerEnv(\"CLIO_IDS_RETRY_BATCH_SIZE\", 8, { min: 1, max: 32 }),\r\n    retryMaxAttempts: parseIntegerEnv(\"CLIO_IDS_RETRY_MAX_ATTEMPTS\", 5, { min: 1, max: 20 }),\r\n    retryBaseBackoffSeconds: parseIntegerEnv(\"CLIO_IDS_RETRY_BASE_BACKOFF_SECONDS\", 30, {\r\n      min: 5,\r\n      max: 3600,\r\n    }),\r\n    retryMaxBackoffSeconds: parseIntegerEnv(\"CLIO_IDS_RETRY_MAX_BACKOFF_SECONDS\", 1800, {\r\n      min: 30,\r\n      max: 24 * 3600,\r\n    }),\r\n    retryCollectionName: getDetectionRetryQueueCollectionName(),\r\n    deadLetterCollectionName: getDetectionDeadLetterCollectionName(),\r\n  };\r\n}\r\n\r\nfunction pruneCounterWindow(values, currentTimeMs, windowMs) {\r\n  const cutoff = currentTimeMs - windowMs;\r\n  return values.filter((value) => value >= cutoff).slice(-MAX_COUNTER_BUCKET_SIZE);\r\n}\r\n\r\nfunction incrementCounterWindow(key, timestampMs, windowMs) {\r\n  const normalizedKey = asString(key);\r\n  if (!normalizedKey) {\r\n    return 0;\r\n  }\r\n  const safeTimestamp = Number.isFinite(timestampMs) ? timestampMs : Date.now();\r\n  const existing = EVENT_COUNTER_WINDOWS.get(normalizedKey) || [];\r\n  const pruned = pruneCounterWindow(existing, safeTimestamp, windowMs);\r\n  pruned.push(safeTimestamp);\r\n  EVENT_COUNTER_WINDOWS.set(normalizedKey, pruned);\r\n  return pruned.length;\r\n}\r\n\r\nfunction getCounterCount(key, timestampMs, windowMs) {\r\n  const normalizedKey = asString(key);\r\n  if (!normalizedKey) {\r\n    return 0;\r\n  }\r\n  const safeTimestamp = Number.isFinite(timestampMs) ? timestampMs : Date.now();\r\n  const existing = EVENT_COUNTER_WINDOWS.get(normalizedKey) || [];\r\n  const pruned = pruneCounterWindow(existing, safeTimestamp, windowMs);\r\n  EVENT_COUNTER_WINDOWS.set(normalizedKey, pruned);\r\n  return pruned.length;\r\n}\r\n\r\nfunction cleanupIncidentCooldown(nowMs) {\r\n  const current = Number.isFinite(nowMs) ? nowMs : Date.now();\r\n  for (const [key, value] of INCIDENT_COOLDOWN_CACHE.entries()) {\r\n    if (!Number.isFinite(value) || value <= current) {\r\n      INCIDENT_COOLDOWN_CACHE.delete(key);\r\n    }\r\n  }\r\n}\r\n\r\nfunction isInIncidentCooldown(fingerprint, nowMs) {\r\n  cleanupIncidentCooldown(nowMs);\r\n  const expiresAt = INCIDENT_COOLDOWN_CACHE.get(fingerprint);\r\n  return Number.isFinite(expiresAt) && expiresAt > nowMs;\r\n}\r\n\r\nfunction rememberIncidentCooldown(fingerprint, nowMs, minutes) {\r\n  const ttlMs = Math.max(1, Number(minutes || 1)) * 60 * 1000;\r\n  INCIDENT_COOLDOWN_CACHE.set(fingerprint, nowMs + ttlMs);\r\n}\r\n\r\nfunction shouldSkipEvent(entry) {\r\n  const metadata = asObject(entry?.metadata);\r\n  if (metadata.skipAnomalyDetection === true || metadata.autoGenerated === true) {\r\n    return true;\r\n  }\r\n\r\n  const moduleName = normalizeText(entry?.module);\r\n  const requestPath = normalizeText(metadata.requestPath || entry?.requestPath);\r\n  if (moduleName.includes(\"incident management\")) {\r\n    return true;\r\n  }\r\n  if (requestPath.startsWith(\"/api/notifications\")) {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction buildFingerprint(ruleId, entry, detection, nowMs, windowMinutes) {\r\n  const actor = normalizeEmail(entry?.performedBy);\r\n  const sourceIp = normalizeIp(entry?.metadata?.sourceIp || entry?.sourceIp);\r\n  const moduleName = normalizeText(entry?.module || \"\");\r\n  const target = normalizeEmail(detection?.affectedEmployeeEmail || entry?.metadata?.employeeEmail || \"\");\r\n  const bucket = Math.floor(nowMs / (Math.max(1, Number(windowMinutes || 1)) * 60 * 1000));\r\n  return [asString(ruleId), actor || \"unknown\", sourceIp, moduleName || \"module\", target || \"none\", bucket].join(\"|\");\r\n}\r\n\r\nfunction buildCorrelationKey(ruleId, entry, detection) {\r\n  const actor = normalizeEmail(entry?.performedBy);\r\n  const sourceIp = normalizeIp(entry?.metadata?.sourceIp || entry?.sourceIp);\r\n  const moduleName = normalizeText(entry?.module || \"\");\r\n  const target = normalizeEmail(detection?.affectedEmployeeEmail || entry?.metadata?.employeeEmail || \"\");\r\n  return [asString(ruleId), actor || \"unknown\", sourceIp, moduleName || \"module\", target || \"none\"].join(\"|\");\r\n}\r\n\r\nfunction normalizeIncidentState(value) {\r\n  return normalizeText(value).replace(/\\s+/g, \"_\");\r\n}\r\n\r\nfunction isIncidentOpenForConsolidation(status) {\r\n  const state = normalizeIncidentState(status);\r\n  return ![\"resolved\", \"closed\"].includes(state);\r\n}\r\n\r\nfunction toDetectionOccurrenceEntry(entry) {\r\n  const metadata = asObject(entry?.metadata);\r\n  return {\r\n    at: asString(entry?.occurredAt, nowIso()),\r\n    activityName: asString(entry?.activityName, \"Activity\"),\r\n    module: asString(entry?.module, \"System\"),\r\n    sourceEventId: asString(entry?.id),\r\n    sourceIp: asString(metadata.sourceIp || entry?.sourceIp),\r\n    requestPath: asString(metadata.requestPath || entry?.requestPath),\r\n    requestMethod: asString(metadata.requestMethod || entry?.requestMethod),\r\n    actorEmail: normalizeEmail(entry?.performedBy),\r\n    targetEmployeeEmail: normalizeEmail(metadata.targetEmployeeEmail || metadata.employeeEmail || metadata.affectedEmployeeEmail),\r\n  };\r\n}\r\n\r\nfunction chooseSeverity(baseSeverity, observedCount, threshold) {\r\n  const severity = normalizeText(baseSeverity);\r\n  if (severity === \"critical\") {\r\n    return \"High\";\r\n  }\r\n  const safeThreshold = Math.max(1, Number(threshold || 1));\r\n  if (observedCount >= safeThreshold * 2) {\r\n    return \"High\";\r\n  }\r\n  if (severity === \"high\") {\r\n    return \"High\";\r\n  }\r\n  return \"Low\";\r\n}\r\n\r\nfunction extractEventContext(entry) {\r\n  const metadata = asObject(entry?.metadata);\r\n  return {\r\n    actorEmail: normalizeEmail(entry?.performedBy),\r\n    status: normalizeText(entry?.status),\r\n    moduleName: normalizeText(entry?.module),\r\n    activityName: normalizeText(entry?.activityName),\r\n    reason: normalizeText(metadata.reason),\r\n    requestPath: normalizeText(metadata.requestPath || entry?.requestPath),\r\n    requestMethod: normalizeText(metadata.requestMethod || entry?.requestMethod),\r\n    sourceIp: normalizeIp(metadata.sourceIp || entry?.sourceIp),\r\n    sensitivity: normalizeText(entry?.sensitivity),\r\n    targetEmployeeEmail: normalizeEmail(metadata.targetEmployeeEmail || metadata.employeeEmail || metadata.affectedEmployeeEmail),\r\n    ownerEmail: normalizeEmail(metadata.ownerEmail),\r\n    targetRole: normalizeRoleKey(metadata.targetRole || metadata.assignedRole || \"\"),\r\n    actorRole: normalizeRoleKey(metadata.actorRole || metadata.currentRole || \"\"),\r\n    occurredAtMs: toTimeMs(entry?.occurredAt) || Date.now(),\r\n  };\r\n}\r\n\r\nfunction isDeniedStatus(status) {\r\n  return status === \"failed\" || status === \"rejected\";\r\n}\r\n\r\nfunction detectAuthFailureSpike(entry, context, config) {\r\n  if (!context.moduleName.includes(\"authentication\") || !isDeniedStatus(context.status)) {\r\n    return null;\r\n  }\r\n\r\n  const key = `auth-fail:${context.sourceIp || context.actorEmail || \"unknown\"}`;\r\n  const count = incrementCounterWindow(\r\n    key,\r\n    context.occurredAtMs,\r\n    config.authFailureWindowMinutes * 60 * 1000,\r\n  );\r\n  if (count < config.authFailureThreshold) {\r\n    return null;\r\n  }\r\n\r\n  const severity = chooseSeverity(\"high\", count, config.authFailureThreshold);\r\n  return {\r\n    ruleId: \"AUTH_BRUTE_FORCE\",\r\n    incidentType: \"Credential Compromise\",\r\n    severity,\r\n    restrictedPiiInvolved: false,\r\n    observedCount: count,\r\n    windowMinutes: config.authFailureWindowMinutes,\r\n    affectedEmployeeEmail: context.actorEmail,\r\n    title: \"Repeated authentication failures detected\",\r\n    summary: `Detected ${count} failed/rejected authentication events from ${context.sourceIp} within ${config.authFailureWindowMinutes} minute(s).`,\r\n    tags: [\"authentication\", \"brute-force\", \"ids\"],\r\n  };\r\n}\r\n\r\nfunction detectPermissionDeniedSpike(entry, context, config) {\r\n  const isPermissionDenied =\r\n    isDeniedStatus(context.status) &&\r\n    (PERMISSION_DENIED_REASONS.has(context.reason) ||\r\n      context.activityName.includes(\"permission\") ||\r\n      context.activityName.includes(\"ownership\") ||\r\n      context.activityName.includes(\"forbidden\"));\r\n  if (!isPermissionDenied) {\r\n    return null;\r\n  }\r\n\r\n  const key = `permission-denied:${context.actorEmail || context.sourceIp || \"unknown\"}`;\r\n  const count = incrementCounterWindow(\r\n    key,\r\n    context.occurredAtMs,\r\n    config.permissionDeniedWindowMinutes * 60 * 1000,\r\n  );\r\n  if (count < config.permissionDeniedThreshold) {\r\n    return null;\r\n  }\r\n\r\n  const piiModule =\r\n    context.moduleName.includes(\"employee records\") ||\r\n    context.moduleName.includes(\"performance\") ||\r\n    context.moduleName.includes(\"attendance\");\r\n  const severity = chooseSeverity(piiModule ? \"high\" : \"low\", count, config.permissionDeniedThreshold);\r\n  return {\r\n    ruleId: \"UNAUTHORIZED_ACCESS_ATTEMPT\",\r\n    incidentType: \"Unauthorized Access\",\r\n    severity,\r\n    restrictedPiiInvolved: piiModule,\r\n    observedCount: count,\r\n    windowMinutes: config.permissionDeniedWindowMinutes,\r\n    affectedEmployeeEmail: context.targetEmployeeEmail || context.actorEmail,\r\n    title: \"Repeated unauthorized access attempts detected\",\r\n    summary: `Detected ${count} permission/ownership denials for actor ${context.actorEmail || \"unknown\"} within ${config.permissionDeniedWindowMinutes} minute(s).`,\r\n    tags: [\"authorization\", \"idor\", \"least-privilege\", \"ids\"],\r\n  };\r\n}\r\n\r\nfunction detectExportSpike(entry, context, config) {\r\n  const isExportActivity =\r\n    context.moduleName.includes(\"export\") ||\r\n    context.requestPath.includes(\"/api/hris/exports\") ||\r\n    context.activityName.includes(\"export\");\r\n  if (!isExportActivity) {\r\n    return null;\r\n  }\r\n\r\n  if (!(context.status === \"approved\" || context.status === \"completed\")) {\r\n    return null;\r\n  }\r\n\r\n  const key = `export-spike:${context.actorEmail || context.sourceIp || \"unknown\"}`;\r\n  const count = incrementCounterWindow(\r\n    key,\r\n    context.occurredAtMs,\r\n    config.exportSpikeWindowMinutes * 60 * 1000,\r\n  );\r\n  if (count < config.exportSpikeThreshold) {\r\n    return null;\r\n  }\r\n\r\n  const severity = chooseSeverity(\"high\", count, config.exportSpikeThreshold);\r\n  return {\r\n    ruleId: \"MASS_EXPORT_ACTIVITY\",\r\n    incidentType: \"Data Exposure\",\r\n    severity,\r\n    restrictedPiiInvolved: true,\r\n    observedCount: count,\r\n    windowMinutes: config.exportSpikeWindowMinutes,\r\n    affectedEmployeeEmail: context.targetEmployeeEmail || \"\",\r\n    title: \"Mass export activity detected\",\r\n    summary: `Detected ${count} export-related actions by ${context.actorEmail || context.sourceIp} within ${config.exportSpikeWindowMinutes} minute(s).`,\r\n    tags: [\"export\", \"dlp\", \"ids\"],\r\n  };\r\n}\r\n\r\nfunction detectPiiAccessSpike(entry, context, config) {\r\n  const isRecordViewActivity = context.activityName.includes(\"view\") || context.activityName.includes(\"list\");\r\n  const isUnauthorizedRecordView =\r\n    context.moduleName.includes(\"employee records\") &&\r\n    isRecordViewActivity &&\r\n    isDeniedStatus(context.status) &&\r\n    (PERMISSION_DENIED_REASONS.has(context.reason) ||\r\n      context.activityName.includes(\"permission\") ||\r\n      context.activityName.includes(\"ownership\") ||\r\n      context.activityName.includes(\"forbidden\"));\r\n  if (!isUnauthorizedRecordView) {\r\n    return null;\r\n  }\r\n\r\n  const key = `unauthorized-record-view:${context.actorEmail || context.sourceIp || \"unknown\"}`;\r\n  const count = incrementCounterWindow(\r\n    key,\r\n    context.occurredAtMs,\r\n    config.piiAccessSpikeWindowMinutes * 60 * 1000,\r\n  );\r\n  if (count < config.piiAccessSpikeThreshold) {\r\n    return null;\r\n  }\r\n\r\n  const severity = chooseSeverity(\"high\", count, config.piiAccessSpikeThreshold);\r\n  return {\r\n    ruleId: \"UNAUTHORIZED_RECORD_VIEW_SPIKE\",\r\n    incidentType: \"Unauthorized Access\",\r\n    severity,\r\n    restrictedPiiInvolved: true,\r\n    observedCount: count,\r\n    windowMinutes: config.piiAccessSpikeWindowMinutes,\r\n    affectedEmployeeEmail: context.targetEmployeeEmail || \"\",\r\n    title: \"Unauthorized employee-record view attempts detected\",\r\n    summary: `Detected ${count} denied employee-record view/list actions in ${config.piiAccessSpikeWindowMinutes} minute(s).`,\r\n    tags: [\"authorization\", \"employee-records\", \"pii\", \"ids\"],\r\n  };\r\n}\r\n\r\nfunction detectOffboardedAccessAttempt(entry, context, config) {\r\n  const isAuthenticationModule = context.moduleName.includes(\"authentication\") || context.requestPath.includes(\"/api/auth/\");\r\n  const isAccountBlockedAttempt =\r\n    isDeniedStatus(context.status) &&\r\n    (ACCOUNT_ACCESS_BLOCK_REASONS.has(context.reason) ||\r\n      context.activityName.includes(\"account disabled\") ||\r\n      context.activityName.includes(\"account inactive\") ||\r\n      context.activityName.includes(\"offboard\"));\r\n  if (!(isAuthenticationModule && isAccountBlockedAttempt)) {\r\n    return null;\r\n  }\r\n\r\n  const key = `offboarded-access:${context.actorEmail || context.sourceIp || \"unknown\"}`;\r\n  const count = incrementCounterWindow(\r\n    key,\r\n    context.occurredAtMs,\r\n    config.offboardedAccessWindowMinutes * 60 * 1000,\r\n  );\r\n  if (count < config.offboardedAccessThreshold) {\r\n    return null;\r\n  }\r\n\r\n  const severity = chooseSeverity(\"high\", count, config.offboardedAccessThreshold);\r\n  return {\r\n    ruleId: \"OFFBOARDED_ACCESS_ATTEMPT\",\r\n    incidentType: \"Unauthorized Access\",\r\n    severity,\r\n    restrictedPiiInvolved: true,\r\n    observedCount: count,\r\n    windowMinutes: config.offboardedAccessWindowMinutes,\r\n    affectedEmployeeEmail: context.actorEmail || context.targetEmployeeEmail,\r\n    title: \"Offboarded/disabled account access attempts detected\",\r\n    summary: `Detected ${count} blocked sign-in/access attempts for disabled or offboarded account ${context.actorEmail || \"unknown\"} within ${config.offboardedAccessWindowMinutes} minute(s).`,\r\n    tags: [\"authentication\", \"offboarding\", \"access-control\", \"ids\"],\r\n  };\r\n}\r\n\r\nfunction detectPrivilegedRoleAssignmentSpike(entry, context, config) {\r\n  const isRoleAssignmentActivity =\r\n    context.moduleName.includes(\"user management\") &&\r\n    context.activityName.includes(\"role updated\") &&\r\n    (context.status === \"approved\" || context.status === \"completed\");\r\n  if (!isRoleAssignmentActivity) {\r\n    return null;\r\n  }\r\n  if (!context.targetRole || !PRIVILEGED_ROLE_KEYS.has(context.targetRole)) {\r\n    return null;\r\n  }\r\n\r\n  const key = `priv-role-assignment:${context.actorEmail || \"unknown\"}:${context.targetRole}`;\r\n  const count = incrementCounterWindow(\r\n    key,\r\n    context.occurredAtMs,\r\n    config.privilegedRoleChangeWindowMinutes * 60 * 1000,\r\n  );\r\n  if (count < config.privilegedRoleChangeThreshold) {\r\n    return null;\r\n  }\r\n\r\n  const severity = chooseSeverity(\"high\", count, config.privilegedRoleChangeThreshold);\r\n  return {\r\n    ruleId: \"PRIVILEGED_ROLE_ASSIGNMENT_SPIKE\",\r\n    incidentType: \"Policy Violation\",\r\n    severity,\r\n    restrictedPiiInvolved: true,\r\n    observedCount: count,\r\n    windowMinutes: config.privilegedRoleChangeWindowMinutes,\r\n    affectedEmployeeEmail: context.targetEmployeeEmail || \"\",\r\n    title: \"Privileged role assignment spike detected\",\r\n    summary: `Detected ${count} privileged role assignments (${context.targetRole}) by ${context.actorEmail || \"unknown\"} within ${config.privilegedRoleChangeWindowMinutes} minute(s).`,\r\n    tags: [\"rbac\", \"role-assignment\", \"privilege\", \"ids\"],\r\n  };\r\n}\r\n\r\nfunction detectPotentialBreach(entry, context, config) {\r\n  const windowMs = config.breachWindowMinutes * 60 * 1000;\r\n  const actorKey = context.actorEmail || context.sourceIp || \"unknown\";\r\n\r\n  const isExportActivity =\r\n    context.moduleName.includes(\"export\") ||\r\n    context.requestPath.includes(\"/api/hris/exports\") ||\r\n    context.activityName.includes(\"export\");\r\n  const isExportCompleted =\r\n    isExportActivity && (context.status === \"approved\" || context.status === \"completed\");\r\n  if (isExportCompleted) {\r\n    incrementCounterWindow(`breach-export:${actorKey}`, context.occurredAtMs, windowMs);\r\n  }\r\n\r\n  const isPiiRead =\r\n    context.sensitivity === \"sensitive\" &&\r\n    context.moduleName.includes(\"employee records\") &&\r\n    (context.activityName.includes(\"view\") || context.activityName.includes(\"list\")) &&\r\n    (context.status === \"completed\" || context.status === \"approved\");\r\n  if (isPiiRead) {\r\n    incrementCounterWindow(`breach-pii:${actorKey}`, context.occurredAtMs, windowMs);\r\n  }\r\n\r\n  const isPermissionDenied =\r\n    isDeniedStatus(context.status) &&\r\n    (PERMISSION_DENIED_REASONS.has(context.reason) ||\r\n      context.activityName.includes(\"permission\") ||\r\n      context.activityName.includes(\"ownership\") ||\r\n      context.activityName.includes(\"forbidden\"));\r\n  if (isPermissionDenied) {\r\n    incrementCounterWindow(`breach-denied:${actorKey}`, context.occurredAtMs, windowMs);\r\n  }\r\n\r\n  const exportCount = getCounterCount(`breach-export:${actorKey}`, context.occurredAtMs, windowMs);\r\n  const piiCount = getCounterCount(`breach-pii:${actorKey}`, context.occurredAtMs, windowMs);\r\n  const deniedCount = getCounterCount(`breach-denied:${actorKey}`, context.occurredAtMs, windowMs);\r\n\r\n  const meetsExport = exportCount >= config.breachExportThreshold;\r\n  const meetsPii = piiCount >= config.breachPiiThreshold;\r\n  const meetsDenied = config.breachDeniedThreshold <= 0 || deniedCount >= config.breachDeniedThreshold;\r\n  if (!(meetsExport && meetsPii && meetsDenied)) {\r\n    return null;\r\n  }\r\n\r\n  const severity = chooseSeverity(\"high\", exportCount + piiCount + deniedCount, Math.max(1, config.breachExportThreshold));\r\n  return {\r\n    ruleId: \"POTENTIAL_BREACH_SIGNAL\",\r\n    incidentType: \"Data Exposure\",\r\n    severity,\r\n    restrictedPiiInvolved: true,\r\n    observedCount: exportCount + piiCount + deniedCount,\r\n    windowMinutes: config.breachWindowMinutes,\r\n    affectedEmployeeEmail: context.targetEmployeeEmail || context.actorEmail,\r\n    title: \"Potential breach indicators detected\",\r\n    summary: `Detected ${exportCount} export action(s), ${piiCount} PII access event(s), and ${deniedCount} access denial(s) for ${actorKey} within ${config.breachWindowMinutes} minute(s).`,\r\n    tags: [\"breach-signal\", \"export\", \"pii\", \"ids\"],\r\n  };\r\n}\r\n\r\nfunction detectSuspiciousEvent(entry, context, config) {\r\n  const rules = [\r\n    detectAuthFailureSpike,\r\n    detectPermissionDeniedSpike,\r\n    detectOffboardedAccessAttempt,\r\n    detectPrivilegedRoleAssignmentSpike,\r\n    detectExportSpike,\r\n    detectPiiAccessSpike,\r\n    detectPotentialBreach,\r\n  ];\r\n\r\n  for (const detect of rules) {\r\n    const match = detect(entry, context, config);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction toNotificationTitle(incident, detection) {\r\n  return asString(incident?.title || detection?.title, \"Security anomaly detected\");\r\n}\r\n\r\nfunction toNotificationMessage(incident, detection) {\r\n  const severity = asString(incident?.severity || detection?.severity, \"Medium\");\r\n  const code = asString(incident?.incidentCode, \"INCIDENT\");\r\n  const summary = asString(incident?.summary || detection?.summary, \"Review incident workbench for containment.\");\r\n  return `[${severity}] ${code}: ${summary}`;\r\n}\r\n\r\nfunction parseRoleEmails(value) {\r\n  return asString(value)\r\n    .split(\",\")\r\n    .map((item) => normalizeEmail(item))\r\n    .filter(Boolean);\r\n}\r\n\r\nfunction resolveOwnerEmail(entry, detection) {\r\n  const preferredOwner =\r\n    normalizeEmail(process.env.CLIO_GRC_ALERT_EMAIL) ||\r\n    parseRoleEmails(process.env.GRC_EMAILS)[0] ||\r\n    parseRoleEmails(process.env.SUPER_ADMIN_EMAILS)[0];\r\n  if (preferredOwner) {\r\n    return preferredOwner;\r\n  }\r\n  return normalizeEmail(detection?.affectedEmployeeEmail || entry?.metadata?.ownerEmail || entry?.performedBy || DEFAULT_SYSTEM_ACTOR);\r\n}\r\n\r\nasync function resolveAlertRecipients(entry, detection, incident, config) {\r\n  const owner = resolveOwnerEmail(entry, detection) || normalizeEmail(incident?.ownerEmail);\r\n  const resolved = await resolveIncidentStakeholderRecipients({\r\n    ownerEmail: owner,\r\n    affectedEmployeeEmail: normalizeEmail(detection?.affectedEmployeeEmail),\r\n    actorEmail: normalizeEmail(entry?.performedBy),\r\n    includeAffectedEmployee: true,\r\n    includeActor: true,\r\n  });\r\n  const withExplicitSecurityRecipients = resolveSecurityAlertEmailRecipients(resolved);\r\n  return withExplicitSecurityRecipients.slice(0, config.maxRecipientCount);\r\n}\r\n\r\nfunction buildActionUrl(config, incidentId) {\r\n  if (!incidentId) {\r\n    return \"/incident-management\";\r\n  }\r\n  return `/incident-management?incident=${encodeURIComponent(incidentId)}`;\r\n}\r\n\r\nfunction buildAbsoluteActionUrl(config, actionPath) {\r\n  const base = asString(config?.appBaseUrl).replace(/\\/+$/, \"\");\r\n  const path = asString(actionPath, \"/incident-management\");\r\n  if (path.startsWith(\"http://\") || path.startsWith(\"https://\")) {\r\n    return path;\r\n  }\r\n  if (!base) {\r\n    return path.startsWith(\"/\") ? path : `/${path}`;\r\n  }\r\n  return `${base}${path.startsWith(\"/\") ? path : `/${path}`}`;\r\n}\r\n\r\nfunction getRetryDelaySeconds(attempt, config) {\r\n  const safeAttempt = Math.max(1, Number(attempt || 1));\r\n  const baseSeconds = Math.max(5, Number(config?.retryBaseBackoffSeconds || 30));\r\n  const maxSeconds = Math.max(baseSeconds, Number(config?.retryMaxBackoffSeconds || 1800));\r\n  return Math.min(maxSeconds, baseSeconds * Math.pow(2, Math.max(0, safeAttempt - 1)));\r\n}\r\n\r\nfunction buildRetryQueueEntry({\r\n  entry,\r\n  detection,\r\n  fingerprint,\r\n  correlationKey,\r\n  errorMessage,\r\n  config,\r\n  attempts = 1,\r\n  source = \"live\",\r\n  queuedAtIso = nowIso(),\r\n}) {\r\n  const safeAttempts = Math.max(1, Number(attempts || 1));\r\n  const delaySeconds = getRetryDelaySeconds(safeAttempts, config);\r\n  const nextAttemptAt = new Date(Date.now() + delaySeconds * 1000).toISOString();\r\n  return {\r\n    status: \"pending\",\r\n    source: asString(source, \"live\"),\r\n    attempts: safeAttempts,\r\n    maxAttempts: Math.max(1, Number(config?.retryMaxAttempts || 5)),\r\n    nextAttemptAt,\r\n    lastError: asString(errorMessage, \"ids_processing_failed\"),\r\n    fingerprint: asString(fingerprint),\r\n    correlationKey: asString(correlationKey),\r\n    entry: asObject(entry),\r\n    detection: asObject(detection),\r\n    createdAt: queuedAtIso,\r\n    updatedAt: queuedAtIso,\r\n  };\r\n}\r\n\r\nasync function enqueueDetectionRetryWorkItem({\r\n  entry,\r\n  detection,\r\n  fingerprint,\r\n  correlationKey,\r\n  errorMessage,\r\n  config,\r\n  attempts = 1,\r\n  source = \"live\",\r\n}) {\r\n  if (!config?.retryEnabled) {\r\n    return {\r\n      queued: false,\r\n      reason: \"retry_disabled\",\r\n    };\r\n  }\r\n\r\n  const db = getDetectionQueueDb();\r\n  if (!db) {\r\n    return {\r\n      queued: false,\r\n      reason: \"retry_queue_unavailable\",\r\n    };\r\n  }\r\n\r\n  const now = nowIso();\r\n  const payload = buildRetryQueueEntry({\r\n    entry,\r\n    detection,\r\n    fingerprint,\r\n    correlationKey,\r\n    errorMessage,\r\n    config,\r\n    attempts,\r\n    source,\r\n    queuedAtIso: now,\r\n  });\r\n  const ref = await addDoc(collection(db, config.retryCollectionName), payload);\r\n  return {\r\n    queued: true,\r\n    retryRecordId: ref.id,\r\n    attempts: payload.attempts,\r\n    nextAttemptAt: payload.nextAttemptAt,\r\n  };\r\n}\r\n\r\nasync function listDueRetryQueueRecords(config, { batchSize } = {}) {\r\n  const db = getDetectionQueueDb();\r\n  if (!db) {\r\n    return [];\r\n  }\r\n\r\n  const limitValue = Math.max(1, Number(batchSize || config?.retryBatchSize || 8));\r\n  const scanLimit = Math.max(limitValue * 3, 16);\r\n  const snapshot = await getDocs(\r\n    query(\r\n      collection(db, config.retryCollectionName),\r\n      orderBy(\"nextAttemptAt\", \"asc\"),\r\n      queryLimit(scanLimit),\r\n    ),\r\n  );\r\n  const nowMs = Date.now();\r\n  return snapshot.docs\r\n    .map((docSnapshot) => ({\r\n      id: docSnapshot.id,\r\n      ...(docSnapshot.data() || {}),\r\n    }))\r\n    .filter((row) => normalizeText(row?.status || \"pending\") === \"pending\")\r\n    .filter((row) => {\r\n      const nextAttemptMs = toTimeMs(row?.nextAttemptAt);\r\n      return !Number.isFinite(nextAttemptMs) || nextAttemptMs <= nowMs;\r\n    })\r\n    .slice(0, limitValue);\r\n}\r\n\r\nasync function moveRetryRecordToDeadLetter(config, record, reason) {\r\n  const db = getDetectionQueueDb();\r\n  if (!db) {\r\n    return null;\r\n  }\r\n\r\n  const payload = {\r\n    ...record,\r\n    status: \"dead-letter\",\r\n    deadLetteredAt: nowIso(),\r\n    deadLetterReason: asString(reason, \"ids_retry_exhausted\"),\r\n    originalRetryRecordId: asString(record?.id),\r\n  };\r\n  const ref = await addDoc(collection(db, config.deadLetterCollectionName), payload);\r\n  return ref.id;\r\n}\r\n\r\nasync function updateRetryQueueRecord(config, recordId, patch) {\r\n  const db = getDetectionQueueDb();\r\n  if (!db) {\r\n    return;\r\n  }\r\n  await updateDoc(doc(db, config.retryCollectionName, recordId), {\r\n    ...patch,\r\n    updatedAt: nowIso(),\r\n  });\r\n}\r\n\r\nasync function deleteRetryQueueRecord(config, recordId) {\r\n  const db = getDetectionQueueDb();\r\n  if (!db) {\r\n    return;\r\n  }\r\n  await deleteDoc(doc(db, config.retryCollectionName, recordId));\r\n}\r\n\r\nasync function findConsolidationIncident({ correlationKey, fingerprint, nowMs, config }) {\r\n  let rows = [];\r\n  try {\r\n    rows = await listIncidentRecordsBackend();\r\n  } catch {\r\n    rows = [];\r\n  }\r\n\r\n  const exactActiveMatch = asArray(rows).find((row) => {\r\n    if (!isIncidentOpenForConsolidation(row?.status)) {\r\n      return false;\r\n    }\r\n    const currentCorrelationKey = asString(row?.detectionCorrelationKey);\r\n    if (currentCorrelationKey && currentCorrelationKey === correlationKey) {\r\n      return true;\r\n    }\r\n    const currentFingerprint = asString(row?.detectionFingerprint);\r\n    return Boolean(currentFingerprint && currentFingerprint === fingerprint);\r\n  });\r\n  if (exactActiveMatch) {\r\n    return exactActiveMatch;\r\n  }\r\n\r\n  if (isInIncidentCooldown(fingerprint, nowMs)) {\r\n    return { id: \"\", duplicateOnly: true };\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nasync function mergeDetectionIntoIncident({\r\n  incident,\r\n  entry,\r\n  detection,\r\n  correlationKey,\r\n  fingerprint,\r\n  nowMs,\r\n  config,\r\n}) {\r\n  if (!incident?.id) {\r\n    return null;\r\n  }\r\n  const nextCount = Math.max(1, Number(incident?.alertOccurrenceCount || 1)) + 1;\r\n  const previousOccurrences = asArray(incident?.alertOccurrences).slice(-39);\r\n  const nextOccurrences = [...previousOccurrences, toDetectionOccurrenceEntry(entry)];\r\n  const patchPayload = {\r\n    detectionFingerprint: asString(incident?.detectionFingerprint || fingerprint),\r\n    detectionCorrelationKey: asString(incident?.detectionCorrelationKey || correlationKey),\r\n    detectionWindowEnd: new Date(nowMs).toISOString(),\r\n    alertDescription: detection.summary,\r\n    alertOccurrenceCount: nextCount,\r\n    alertFirstObservedAt: asString(incident?.alertFirstObservedAt || incident?.detectedAt || nowIso()),\r\n    alertLastObservedAt: asString(entry?.occurredAt, nowIso()),\r\n    alertOccurrences: nextOccurrences,\r\n    summary: detection.summary,\r\n    notes: [\r\n      asString(incident?.notes),\r\n      `Latest alert occurrence #${nextCount}: ${asString(entry?.activityName, \"Activity\")} | ${asString(entry?.module, \"System\")} | ${asString(entry?.occurredAt, nowIso())} | Source IP: ${asString(entry?.metadata?.sourceIp || entry?.sourceIp, \"unknown\")}`,\r\n    ]\r\n      .filter(Boolean)\r\n      .join(\"\\n\"),\r\n  };\r\n\r\n  const updated = await updateIncidentRecordBackend(incident.id, patchPayload, config.systemActorEmail);\r\n  rememberIncidentCooldown(fingerprint, nowMs, config.incidentCooldownMinutes);\r\n  return updated;\r\n}\r\n\r\nasync function createAutoIncident(entry, detection, config, fingerprint, correlationKey, nowMs) {\r\n  const occurredAt = asString(entry?.occurredAt, nowIso());\r\n  const ownerEmail = resolveOwnerEmail(entry, detection);\r\n  const actorEmail = config.systemActorEmail || DEFAULT_SYSTEM_ACTOR;\r\n  const sourceMetadata = asObject(entry?.metadata);\r\n  const targetEmployee = asString(\r\n    sourceMetadata.targetEmployeeEmail || sourceMetadata.employeeEmail || detection.affectedEmployeeEmail,\r\n    \"\",\r\n  );\r\n  const recordLabel = asString(sourceMetadata.resourceLabel || sourceMetadata.recordRef || sourceMetadata.recordId, \"\");\r\n  const viewedFields = asArray(sourceMetadata.viewedFields, []);\r\n  const accessedDocuments = asArray(sourceMetadata.accessedDocuments, []);\r\n  const firstObservedAt = asString(entry?.occurredAt, nowIso());\r\n  const firstOccurrence = toDetectionOccurrenceEntry(entry);\r\n  const payload = {\r\n    title: detection.title,\r\n    summary: detection.summary,\r\n    incidentType: detection.incidentType,\r\n    severity: detection.severity,\r\n    status: \"Open\",\r\n    restrictedPiiInvolved: Boolean(detection.restrictedPiiInvolved),\r\n    affectedEmployeeEmail: normalizeEmail(detection.affectedEmployeeEmail || sourceMetadata.targetEmployeeEmail || \"\"),\r\n    ownerEmail,\r\n    detectedAt: occurredAt,\r\n    escalationRequired: true,\r\n    containmentStatus: \"Not Started\",\r\n    impactAssessmentStatus: \"Pending\",\r\n    regulatoryNotificationRequired: Boolean(detection.restrictedPiiInvolved),\r\n    documentationRetained: true,\r\n    classificationStandard: \"CLIO-IDS-V1\",\r\n    notes: [\r\n      `Auto-generated by CLIO IDS rule: ${detection.ruleId}`,\r\n      `Observed count: ${Number(detection.observedCount || 0)}`,\r\n      `Window: ${Number(detection.windowMinutes || 0)} minute(s)`,\r\n      targetEmployee ? `Target employee: ${targetEmployee}` : null,\r\n      recordLabel ? `Record reference: ${recordLabel}` : null,\r\n      viewedFields.length > 0 ? `Viewed fields: ${viewedFields.slice(0, 12).join(\", \")}` : null,\r\n      accessedDocuments.length > 0\r\n        ? `Accessed documents: ${accessedDocuments\r\n            .map((doc) => asString(doc?.name || doc?.ref || doc?.id))\r\n            .filter(Boolean)\r\n            .slice(0, 6)\r\n            .join(\", \")}`\r\n        : null,\r\n      `Source event: ${asString(entry?.id, \"N/A\")} | ${asString(entry?.module, \"System\")} | ${asString(entry?.activityName, \"Activity\")}`,\r\n      `Source IP: ${asString(sourceMetadata.sourceIp || entry?.sourceIp, \"unknown\")}`,\r\n      `Request: ${asString(sourceMetadata.requestMethod || entry?.requestMethod, \"GET\")} ${asString(sourceMetadata.requestPath || entry?.requestPath, \"unknown\")}`,\r\n    ]\r\n      .filter(Boolean)\r\n      .join(\"\\n\"),\r\n    autoGenerated: true,\r\n    detectionRuleId: detection.ruleId,\r\n    detectionFingerprint: fingerprint,\r\n    detectionCorrelationKey: correlationKey,\r\n    detectionWindowStart: new Date(nowMs - detection.windowMinutes * 60 * 1000).toISOString(),\r\n    detectionWindowEnd: new Date(nowMs).toISOString(),\r\n    alertDescription: detection.summary,\r\n    alertOccurrenceCount: 1,\r\n    alertFirstObservedAt: firstObservedAt,\r\n    alertLastObservedAt: firstObservedAt,\r\n    alertOccurrences: [firstOccurrence],\r\n    sourceSystem: \"CLIO_IDS\",\r\n    sourceEventId: asString(entry?.id),\r\n    sourceEventModule: asString(entry?.module),\r\n    sourceEventPath: asString(sourceMetadata.requestPath || entry?.requestPath),\r\n    sourceIp: asString(sourceMetadata.sourceIp || entry?.sourceIp),\r\n    alertRecipients: [],\r\n    actionUrl: \"/incident-management\",\r\n  };\r\n\r\n  const created = await createIncidentRecordBackend(payload, actorEmail);\r\n  rememberIncidentCooldown(fingerprint, nowMs, config.incidentCooldownMinutes);\r\n  return created;\r\n}\r\n\r\nasync function createInAppIncidentNotifications({\r\n  incident,\r\n  detection,\r\n  recipients,\r\n  actionUrl,\r\n  actorEmail,\r\n}) {\r\n  const notifications = recipients.map((recipientEmail) => ({\r\n    recipientEmail,\r\n    title: toNotificationTitle(incident, detection),\r\n    message: toNotificationMessage(incident, detection),\r\n    severity: normalizeText(incident?.severity || detection?.severity || \"medium\"),\r\n    type: \"security-anomaly\",\r\n    module: \"Incident Management\",\r\n    actionUrl,\r\n    status: \"unread\",\r\n    createdBy: actorEmail,\r\n    metadata: {\r\n      incidentId: asString(incident?.id || incident?.recordId),\r\n      incidentCode: asString(incident?.incidentCode),\r\n      detectionRuleId: asString(detection?.ruleId),\r\n      autoGenerated: true,\r\n    },\r\n  }));\r\n  return await createInAppNotificationsBulk(notifications);\r\n}\r\n\r\nasync function executeDetectionWorkflow({\r\n  entry,\r\n  detection,\r\n  config,\r\n  fingerprint,\r\n  correlationKey,\r\n  nowMs,\r\n}) {\r\n  const existingIncident = await findConsolidationIncident({\r\n    correlationKey,\r\n    fingerprint,\r\n    nowMs,\r\n    config,\r\n  });\r\n  if (existingIncident?.duplicateOnly) {\r\n    return {\r\n      detected: true,\r\n      duplicate: true,\r\n      detection,\r\n      fingerprint,\r\n      correlationKey,\r\n    };\r\n  }\r\n  if (existingIncident?.id) {\r\n    const updatedIncident = await mergeDetectionIntoIncident({\r\n      incident: existingIncident,\r\n      entry,\r\n      detection,\r\n      correlationKey,\r\n      fingerprint,\r\n      nowMs,\r\n      config,\r\n    });\r\n    return {\r\n      detected: true,\r\n      duplicate: true,\r\n      consolidated: true,\r\n      detection,\r\n      fingerprint,\r\n      correlationKey,\r\n      incidentRecord: updatedIncident || existingIncident,\r\n    };\r\n  }\r\n\r\n  const incident = await createAutoIncident(entry, detection, config, fingerprint, correlationKey, nowMs);\r\n  const actionUrl = buildActionUrl(config, incident?.id || incident?.recordId);\r\n  const absoluteActionUrl = buildAbsoluteActionUrl(config, actionUrl);\r\n  const recipients = await resolveAlertRecipients(entry, detection, incident, config);\r\n  const inAppNotifications = await createInAppIncidentNotifications({\r\n    incident,\r\n    detection,\r\n    recipients,\r\n    actionUrl,\r\n    actorEmail: config.systemActorEmail,\r\n  });\r\n  const deliverySummary = await dispatchSecurityIncidentAlerts({\r\n    incident: {\r\n      ...incident,\r\n      actionUrl: absoluteActionUrl,\r\n    },\r\n    detection,\r\n    sourceEvent: entry,\r\n    emailRecipients: recipients,\r\n  });\r\n\r\n  const patchPayload = {\r\n    alertRecipients: recipients,\r\n    alertDispatchSummary: deliverySummary,\r\n    externalIntegrations: {\r\n      webhooks: deliverySummary?.webhooks || {},\r\n    },\r\n    lastAlertDispatchAt: nowIso(),\r\n  };\r\n  await updateIncidentRecordBackend(incident.id, patchPayload, config.systemActorEmail).catch(() => null);\r\n\r\n  return {\r\n    detected: true,\r\n    duplicate: false,\r\n    detection,\r\n    incidentRecord: incident,\r\n    fingerprint,\r\n    recipients,\r\n    inAppNotificationCount: inAppNotifications.length,\r\n    deliverySummary,\r\n  };\r\n}\r\n\r\nfunction hasForcedDetectionPayload(value) {\r\n  return Boolean(value && typeof value === \"object\" && !Array.isArray(value));\r\n}\r\n\r\nasync function processSingleRetryQueueRecord(config, row) {\r\n  const recordId = asString(row?.id);\r\n  if (!recordId) {\r\n    return { processed: false, reason: \"missing_retry_record_id\" };\r\n  }\r\n\r\n  const attempts = Math.max(1, Number(row?.attempts || 1));\r\n  const maxAttempts = Math.max(1, Number(row?.maxAttempts || config.retryMaxAttempts || 5));\r\n  const entry = asObject(row?.entry);\r\n  const detection = asObject(row?.detection);\r\n  const fingerprint = asString(row?.fingerprint);\r\n  const correlationKey = asString(row?.correlationKey);\r\n  if (!fingerprint || !asString(detection?.ruleId) || (!asString(entry?.activityName) && !asString(entry?.module))) {\r\n    await moveRetryRecordToDeadLetter(config, row, \"invalid_retry_payload\");\r\n    await deleteRetryQueueRecord(config, recordId);\r\n    return { processed: false, deadLettered: true, reason: \"invalid_retry_payload\" };\r\n  }\r\n\r\n  const result = await processAuditEventForSecurityDetections(entry, {\r\n    forcedDetection: detection,\r\n    forcedFingerprint: fingerprint,\r\n    forcedCorrelationKey: correlationKey,\r\n    skipQueueOnError: true,\r\n    disableQueueDrain: true,\r\n  });\r\n\r\n  if (!result?.failed) {\r\n    await deleteRetryQueueRecord(config, recordId);\r\n    return {\r\n      processed: true,\r\n      duplicate: Boolean(result?.duplicate),\r\n      detected: Boolean(result?.detected),\r\n    };\r\n  }\r\n\r\n  const nextAttempts = attempts + 1;\r\n  const errorMessage = asString(result?.error, \"ids_processing_failed\");\r\n  if (nextAttempts > maxAttempts) {\r\n    await moveRetryRecordToDeadLetter(config, {\r\n      ...row,\r\n      attempts: nextAttempts,\r\n      maxAttempts,\r\n      lastError: errorMessage,\r\n    }, errorMessage);\r\n    await deleteRetryQueueRecord(config, recordId);\r\n    return {\r\n      processed: false,\r\n      deadLettered: true,\r\n      reason: errorMessage,\r\n    };\r\n  }\r\n\r\n  const nextAttemptAt = new Date(Date.now() + getRetryDelaySeconds(nextAttempts, config) * 1000).toISOString();\r\n  await updateRetryQueueRecord(config, recordId, {\r\n    attempts: nextAttempts,\r\n    maxAttempts,\r\n    nextAttemptAt,\r\n    lastError: errorMessage,\r\n    status: \"pending\",\r\n  });\r\n\r\n  return {\r\n    processed: false,\r\n    retried: true,\r\n    reason: errorMessage,\r\n    nextAttemptAt,\r\n  };\r\n}\r\n\r\nexport async function drainSecurityDetectionRetryQueue({ reason = \"manual\", batchSize } = {}) {\r\n  const config = getDetectionConfig();\r\n  if (!config.enabled || !config.retryEnabled) {\r\n    return {\r\n      processedCount: 0,\r\n      reason: !config.enabled ? \"ids_disabled\" : \"retry_disabled\",\r\n    };\r\n  }\r\n\r\n  if (IDS_RETRY_DRAIN_PROMISE) {\r\n    return IDS_RETRY_DRAIN_PROMISE;\r\n  }\r\n\r\n  IDS_RETRY_DRAIN_PROMISE = (async () => {\r\n    const dueRecords = await listDueRetryQueueRecords(config, {\r\n      batchSize: Number(batchSize || config.retryBatchSize || 8),\r\n    });\r\n    let processedCount = 0;\r\n    let deadLetterCount = 0;\r\n    let failedCount = 0;\r\n\r\n    for (const row of dueRecords) {\r\n      try {\r\n        const result = await processSingleRetryQueueRecord(config, row);\r\n        if (result?.processed) {\r\n          processedCount += 1;\r\n        }\r\n        if (result?.deadLettered) {\r\n          deadLetterCount += 1;\r\n        }\r\n      } catch {\r\n        failedCount += 1;\r\n      }\r\n    }\r\n\r\n    return {\r\n      reason: asString(reason, \"manual\"),\r\n      processedCount,\r\n      deadLetterCount,\r\n      failedCount,\r\n      dueCount: dueRecords.length,\r\n    };\r\n  })();\r\n\r\n  try {\r\n    return await IDS_RETRY_DRAIN_PROMISE;\r\n  } finally {\r\n    IDS_RETRY_DRAIN_PROMISE = null;\r\n  }\r\n}\r\n\r\nexport async function processAuditEventForSecurityDetections(entry, options = {}) {\r\n  const config = getDetectionConfig();\r\n  if (!config.enabled) {\r\n    return {\r\n      detected: false,\r\n      reason: \"ids_disabled\",\r\n    };\r\n  }\r\n\r\n  if (!entry || typeof entry !== \"object\") {\r\n    return {\r\n      detected: false,\r\n      reason: \"invalid_audit_entry\",\r\n    };\r\n  }\r\n\r\n  if (!options?.disableQueueDrain && config.retryEnabled) {\r\n    void drainSecurityDetectionRetryQueue({ reason: \"audit-event\" }).catch(() => null);\r\n  }\r\n\r\n  const forcedDetection = hasForcedDetectionPayload(options?.forcedDetection)\r\n    ? options.forcedDetection\r\n    : null;\r\n  if (!forcedDetection && shouldSkipEvent(entry)) {\r\n    return {\r\n      detected: false,\r\n      reason: \"event_skipped\",\r\n    };\r\n  }\r\n\r\n  const context = extractEventContext(entry);\r\n  const detection = forcedDetection || detectSuspiciousEvent(entry, context, config);\r\n  if (!detection) {\r\n    return {\r\n      detected: false,\r\n      reason: \"no_rule_match\",\r\n    };\r\n  }\r\n\r\n  const nowMs = context.occurredAtMs || Date.now();\r\n  const fingerprint =\r\n    asString(options?.forcedFingerprint) ||\r\n    buildFingerprint(\r\n      detection.ruleId,\r\n      entry,\r\n      detection,\r\n      nowMs,\r\n      detection.windowMinutes || config.incidentCooldownMinutes,\r\n    );\r\n  const correlationKey =\r\n    asString(options?.forcedCorrelationKey) || buildCorrelationKey(detection.ruleId, entry, detection);\r\n\r\n  try {\r\n    return await executeDetectionWorkflow({\r\n      entry,\r\n      detection,\r\n      config,\r\n      fingerprint,\r\n      correlationKey,\r\n      nowMs,\r\n    });\r\n  } catch (error) {\r\n    const errorMessage = error instanceof Error ? asString(error.message, \"ids_processing_failed\") : \"ids_processing_failed\";\r\n    if (options?.skipQueueOnError) {\r\n      return {\r\n        detected: true,\r\n        duplicate: false,\r\n        failed: true,\r\n        detection,\r\n        fingerprint,\r\n        reason: \"processing_failed\",\r\n        error: errorMessage,\r\n      };\r\n    }\r\n\r\n    const queueResult = await enqueueDetectionRetryWorkItem({\r\n      entry,\r\n      detection,\r\n      fingerprint,\r\n      correlationKey,\r\n      errorMessage,\r\n      config,\r\n      attempts: 1,\r\n      source: \"live\",\r\n    });\r\n    return {\r\n      detected: true,\r\n      duplicate: false,\r\n      failed: true,\r\n      queuedForRetry: Boolean(queueResult?.queued),\r\n      retryRecordId: asString(queueResult?.retryRecordId),\r\n      detection,\r\n      fingerprint,\r\n      reason: \"processing_failed\",\r\n      error: errorMessage,\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}