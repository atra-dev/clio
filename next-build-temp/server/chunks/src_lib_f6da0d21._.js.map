{"version":3,"sources":["../../../src/lib/security-notifications.js","../../../src/lib/api-rate-limit.js","../../../src/lib/security-alert-delivery.js","../../../src/lib/incident-notification-text.js","../../../src/lib/incident-evidence-security.js"],"sourcesContent":["import {\r\n  addDoc,\r\n  collection,\r\n  doc,\r\n  getDoc,\r\n  getDocs,\r\n  limit as queryLimit,\r\n  orderBy,\r\n  query,\r\n  updateDoc,\r\n} from \"firebase/firestore/lite\";\r\nimport { getFirestoreDb, isFirestoreEnabled } from \"@/lib/firebase\";\r\nimport { listUserAccounts } from \"@/lib/user-accounts\";\r\n\r\nconst DEFAULT_LIST_LIMIT = 20;\r\nconst MAX_LIST_LIMIT = 120;\r\nconst MAX_READ_ALL_LIMIT = 300;\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction asString(value, fallback = \"\") {\r\n  const normalized = String(value || \"\").trim();\r\n  return normalized || fallback;\r\n}\r\n\r\nfunction asBoolean(value, fallback = false) {\r\n  if (typeof value === \"boolean\") {\r\n    return value;\r\n  }\r\n  if (typeof value === \"number\") {\r\n    return value !== 0;\r\n  }\r\n  if (typeof value === \"string\") {\r\n    const normalized = value.trim().toLowerCase();\r\n    if (!normalized) {\r\n      return fallback;\r\n    }\r\n    if ([\"true\", \"1\", \"yes\", \"on\", \"y\"].includes(normalized)) {\r\n      return true;\r\n    }\r\n    if ([\"false\", \"0\", \"no\", \"off\", \"n\"].includes(normalized)) {\r\n      return false;\r\n    }\r\n  }\r\n  return fallback;\r\n}\r\n\r\nfunction asObject(value) {\r\n  if (value && typeof value === \"object\" && !Array.isArray(value)) {\r\n    return value;\r\n  }\r\n  return {};\r\n}\r\n\r\nfunction asArray(value) {\r\n  return Array.isArray(value) ? value : [];\r\n}\r\n\r\nfunction clampInt(value, fallback, { min = 1, max = Number.MAX_SAFE_INTEGER } = {}) {\r\n  const parsed = Number.parseInt(String(value || \"\"), 10);\r\n  if (!Number.isFinite(parsed)) {\r\n    return fallback;\r\n  }\r\n  return Math.min(max, Math.max(min, parsed));\r\n}\r\n\r\nfunction normalizeEmail(value) {\r\n  return String(value || \"\").trim().toLowerCase();\r\n}\r\n\r\nfunction normalizeText(value) {\r\n  return String(value || \"\").trim().toLowerCase();\r\n}\r\n\r\nfunction parseEmailList(rawValue) {\r\n  return String(rawValue || \"\")\r\n    .split(\",\")\r\n    .map((item) => normalizeEmail(item))\r\n    .filter(Boolean);\r\n}\r\n\r\nfunction normalizeSeverity(value) {\r\n  const normalized = String(value || \"\").trim().toLowerCase();\r\n  if (normalized === \"critical\") return \"critical\";\r\n  if (normalized === \"high\") return \"high\";\r\n  if (normalized === \"low\") return \"low\";\r\n  return \"medium\";\r\n}\r\n\r\nfunction normalizeNotificationStatus(value) {\r\n  return String(value || \"\").trim().toLowerCase() === \"read\" ? \"read\" : \"unread\";\r\n}\r\n\r\nfunction getNotificationsCollectionName() {\r\n  return asString(process.env.CLIO_FIRESTORE_NOTIFICATIONS_COLLECTION, \"clio_notifications\");\r\n}\r\n\r\nfunction getFirestoreStore() {\r\n  if (!isFirestoreEnabled()) {\r\n    return null;\r\n  }\r\n  return getFirestoreDb();\r\n}\r\n\r\nfunction toNotificationRecord(snapshot) {\r\n  const payload = snapshot.data() || {};\r\n  return {\r\n    ...payload,\r\n    id: snapshot.id,\r\n    recordId: snapshot.id,\r\n  };\r\n}\r\n\r\nfunction isVisibleNotification(row, recipientEmail) {\r\n  const recipient = normalizeEmail(recipientEmail);\r\n  const owner = normalizeEmail(row?.recipientEmail);\r\n  const broadcast = asBoolean(row?.broadcast, false);\r\n  return broadcast || (recipient && owner && recipient === owner);\r\n}\r\n\r\nfunction sortByCreatedDesc(left, right) {\r\n  return new Date(right?.createdAt || 0).getTime() - new Date(left?.createdAt || 0).getTime();\r\n}\r\n\r\nfunction normalizeNotificationPayload(payload) {\r\n  const now = nowIso();\r\n  const recipientEmail = normalizeEmail(payload?.recipientEmail);\r\n  const broadcast = asBoolean(payload?.broadcast, false);\r\n  if (!recipientEmail && !broadcast) {\r\n    throw new Error(\"invalid_notification_recipient\");\r\n  }\r\n\r\n  return {\r\n    title: asString(payload?.title, \"Security notification\"),\r\n    message: asString(payload?.message, \"A security event requires review.\"),\r\n    severity: normalizeSeverity(payload?.severity),\r\n    type: asString(payload?.type, \"security\"),\r\n    module: asString(payload?.module, \"Incident Management\"),\r\n    actionUrl: asString(payload?.actionUrl, \"/incident-management\"),\r\n    recipientEmail,\r\n    broadcast,\r\n    status: normalizeNotificationStatus(payload?.status),\r\n    metadata: asObject(payload?.metadata),\r\n    createdAt: asString(payload?.createdAt, now),\r\n    updatedAt: asString(payload?.updatedAt, now),\r\n    readAt: asString(payload?.readAt, \"\"),\r\n    createdBy: normalizeEmail(payload?.createdBy),\r\n  };\r\n}\r\n\r\nexport async function createInAppNotification(payload) {\r\n  const db = getFirestoreStore();\r\n  if (!db) {\r\n    return null;\r\n  }\r\n\r\n  const normalized = normalizeNotificationPayload(payload);\r\n  const ref = await addDoc(collection(db, getNotificationsCollectionName()), normalized);\r\n  return {\r\n    ...normalized,\r\n    id: ref.id,\r\n    recordId: ref.id,\r\n  };\r\n}\r\n\r\nexport async function createInAppNotificationsBulk(payloads) {\r\n  const entries = asArray(payloads);\r\n  if (entries.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  const created = [];\r\n  for (const payload of entries) {\r\n    const result = await createInAppNotification(payload);\r\n    if (result) {\r\n      created.push(result);\r\n    }\r\n  }\r\n  return created;\r\n}\r\n\r\nexport async function getInAppNotificationForRecipient(recordId, recipientEmail) {\r\n  const db = getFirestoreStore();\r\n  if (!db) {\r\n    return null;\r\n  }\r\n\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    throw new Error(\"invalid_record_id\");\r\n  }\r\n\r\n  const ref = doc(db, getNotificationsCollectionName(), normalizedId);\r\n  const snapshot = await getDoc(ref);\r\n  if (!snapshot.exists()) {\r\n    return null;\r\n  }\r\n\r\n  const current = toNotificationRecord(snapshot);\r\n  if (!isVisibleNotification(current, recipientEmail)) {\r\n    throw new Error(\"forbidden_notification_access\");\r\n  }\r\n\r\n  return current;\r\n}\r\n\r\nexport async function listInAppNotifications({\r\n  recipientEmail,\r\n  status = \"all\",\r\n  limit = DEFAULT_LIST_LIMIT,\r\n} = {}) {\r\n  const db = getFirestoreStore();\r\n  if (!db) {\r\n    return {\r\n      records: [],\r\n      unreadCount: 0,\r\n      totalScoped: 0,\r\n    };\r\n  }\r\n\r\n  const normalizedStatus = String(status || \"\").trim().toLowerCase();\r\n  const safeLimit = clampInt(limit, DEFAULT_LIST_LIMIT, { min: 1, max: MAX_LIST_LIMIT });\r\n  const scanLimit = Math.max(safeLimit * 4, 100);\r\n\r\n  const snapshot = await getDocs(\r\n    query(\r\n      collection(db, getNotificationsCollectionName()),\r\n      orderBy(\"createdAt\", \"desc\"),\r\n      queryLimit(scanLimit),\r\n    ),\r\n  );\r\n\r\n  const scoped = snapshot.docs.map(toNotificationRecord).filter((row) => isVisibleNotification(row, recipientEmail));\r\n  const unreadCount = scoped.reduce((count, row) => count + (normalizeNotificationStatus(row?.status) === \"unread\" ? 1 : 0), 0);\r\n\r\n  const statusFiltered = scoped.filter((row) => {\r\n    if (normalizedStatus === \"all\" || !normalizedStatus) {\r\n      return true;\r\n    }\r\n    return normalizeNotificationStatus(row?.status) === normalizedStatus;\r\n  });\r\n\r\n  return {\r\n    records: statusFiltered.sort(sortByCreatedDesc).slice(0, safeLimit),\r\n    unreadCount,\r\n    totalScoped: scoped.length,\r\n  };\r\n}\r\n\r\nexport async function markInAppNotificationRead(recordId, recipientEmail) {\r\n  const db = getFirestoreStore();\r\n  if (!db) {\r\n    return null;\r\n  }\r\n\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    throw new Error(\"invalid_record_id\");\r\n  }\r\n\r\n  const ref = doc(db, getNotificationsCollectionName(), normalizedId);\r\n  const snapshot = await getDoc(ref);\r\n  if (!snapshot.exists()) {\r\n    return null;\r\n  }\r\n\r\n  const current = toNotificationRecord(snapshot);\r\n  if (!isVisibleNotification(current, recipientEmail)) {\r\n    throw new Error(\"forbidden_notification_access\");\r\n  }\r\n\r\n  if (normalizeNotificationStatus(current.status) === \"read\") {\r\n    return current;\r\n  }\r\n\r\n  const patched = {\r\n    ...current,\r\n    status: \"read\",\r\n    readAt: nowIso(),\r\n    updatedAt: nowIso(),\r\n  };\r\n  await updateDoc(ref, patched);\r\n  return patched;\r\n}\r\n\r\nexport async function resolveDeviceVerificationNotification(recordId, recipientEmail, decision) {\n  const db = getFirestoreStore();\r\n  if (!db) {\r\n    return null;\r\n  }\r\n\r\n  const normalizedId = asString(recordId);\r\n  if (!normalizedId) {\r\n    throw new Error(\"invalid_record_id\");\r\n  }\r\n\r\n  const normalizedRecipient = normalizeEmail(recipientEmail);\r\n  const normalizedDecision = asString(decision).toLowerCase();\r\n  if (normalizedDecision !== \"confirm\" && normalizedDecision !== \"deny\") {\r\n    throw new Error(\"invalid_device_verification_decision\");\r\n  }\r\n\r\n  const ref = doc(db, getNotificationsCollectionName(), normalizedId);\r\n  const snapshot = await getDoc(ref);\r\n  if (!snapshot.exists()) {\r\n    return null;\r\n  }\r\n\r\n  const current = toNotificationRecord(snapshot);\n  if (!isVisibleNotification(current, normalizedRecipient)) {\n    throw new Error(\"forbidden_notification_access\");\n  }\n\n  const metadata = asObject(current?.metadata);\n  const existingDecision = asString(metadata?.deviceVerificationDecision).toLowerCase();\n  if (existingDecision) {\n    if (existingDecision === normalizedDecision) {\n      return current;\n    }\n    throw new Error(\"device_verification_already_resolved\");\n  }\n\n  const now = nowIso();\n  const patched = {\n    ...current,\n    status: \"read\",\n    readAt: asString(current?.readAt, now),\r\n    updatedAt: now,\r\n    metadata: {\r\n      ...metadata,\r\n      deviceVerificationDecision: normalizedDecision,\r\n      deviceVerificationResolvedAt: now,\r\n      deviceVerificationResponder: normalizedRecipient,\r\n    },\r\n  };\r\n\r\n  await updateDoc(ref, patched);\r\n  return patched;\r\n}\r\n\r\nexport async function markAllInAppNotificationsRead({ recipientEmail, limit = 120 } = {}) {\r\n  const normalizedRecipient = normalizeEmail(recipientEmail);\r\n  if (!normalizedRecipient) {\r\n    return {\r\n      updatedCount: 0,\r\n    };\r\n  }\r\n\r\n  const db = getFirestoreStore();\r\n  if (!db) {\r\n    return {\r\n      updatedCount: 0,\r\n    };\r\n  }\r\n\r\n  const safeLimit = clampInt(limit, 120, { min: 1, max: MAX_READ_ALL_LIMIT });\r\n  const { records } = await listInAppNotifications({\r\n    recipientEmail: normalizedRecipient,\r\n    status: \"unread\",\r\n    limit: safeLimit,\r\n  });\r\n\r\n  let updatedCount = 0;\r\n  for (const row of records) {\r\n    const recordId = asString(row?.id || row?.recordId);\r\n    if (!recordId) {\r\n      continue;\r\n    }\r\n    const ref = doc(db, getNotificationsCollectionName(), recordId);\r\n    await updateDoc(ref, {\r\n      status: \"read\",\r\n      readAt: nowIso(),\r\n      updatedAt: nowIso(),\r\n    });\r\n    updatedCount += 1;\r\n  }\r\n\r\n  return {\r\n    updatedCount,\r\n  };\r\n}\r\n\r\nexport function resolveNotificationRecipients(values = []) {\r\n  return Array.from(\r\n    new Set(\r\n      asArray(values)\r\n        .map((value) => normalizeEmail(value))\r\n        .filter(Boolean),\r\n    ),\r\n  );\r\n}\r\n\r\nexport async function resolveIncidentStakeholderRecipients({\r\n  ownerEmail,\r\n  affectedEmployeeEmail,\r\n  actorEmail,\r\n  includeAffectedEmployee = true,\r\n  includeActor = false,\r\n} = {}) {\r\n  const baseRecipients = [\r\n    normalizeEmail(process.env.CLIO_GRC_ALERT_EMAIL),\r\n    ...parseEmailList(process.env.GRC_EMAILS),\r\n    normalizeEmail(ownerEmail),\r\n  ];\r\n\r\n  if (includeAffectedEmployee) {\r\n    baseRecipients.push(normalizeEmail(affectedEmployeeEmail));\r\n  }\r\n  if (includeActor) {\r\n    baseRecipients.push(normalizeEmail(actorEmail));\r\n  }\r\n\r\n  let dynamicRoleRecipients = [];\r\n  try {\r\n    const users = await listUserAccounts();\r\n    dynamicRoleRecipients = asArray(users)\r\n      .filter((user) => normalizeEmail(user?.email))\r\n      .filter((user) => normalizeText(user?.status) === \"active\")\r\n      .filter((user) => {\r\n        const role = String(user?.role || \"\").trim().toUpperCase();\r\n        return role === \"GRC\";\r\n      })\r\n      .map((user) => normalizeEmail(user?.email));\r\n  } catch {\r\n    dynamicRoleRecipients = [];\r\n  }\r\n\r\n  return resolveNotificationRecipients([...baseRecipients, ...dynamicRoleRecipients]);\r\n}\r\n\r\nexport async function resolveGrcRecipients() {\r\n  const baseRecipients = [\r\n    normalizeEmail(process.env.CLIO_GRC_ALERT_EMAIL),\r\n    ...parseEmailList(process.env.GRC_EMAILS),\r\n  ];\r\n\r\n  let dynamicRoleRecipients = [];\r\n  try {\r\n    const users = await listUserAccounts();\r\n    dynamicRoleRecipients = asArray(users)\r\n      .filter((user) => normalizeEmail(user?.email))\r\n      .filter((user) => normalizeText(user?.status) === \"active\")\r\n      .filter((user) => String(user?.role || \"\").trim().toUpperCase() === \"GRC\")\r\n      .map((user) => normalizeEmail(user?.email));\r\n  } catch {\r\n    dynamicRoleRecipients = [];\r\n  }\r\n\r\n  return resolveNotificationRecipients([...baseRecipients, ...dynamicRoleRecipients]);\r\n}\r\n","const GLOBAL_BUCKET_KEY = \"__clio_rate_limit_buckets__\";\r\nconst MAX_BUCKETS = 5000;\r\n\r\nfunction getBuckets() {\r\n  if (!globalThis[GLOBAL_BUCKET_KEY]) {\r\n    globalThis[GLOBAL_BUCKET_KEY] = new Map();\r\n  }\r\n  return globalThis[GLOBAL_BUCKET_KEY];\r\n}\r\n\r\nfunction nowMs() {\r\n  return Date.now();\r\n}\r\n\r\nfunction cleanupExpiredBuckets(buckets, currentMs) {\r\n  if (buckets.size <= MAX_BUCKETS) {\r\n    return;\r\n  }\r\n\r\n  for (const [key, value] of buckets.entries()) {\r\n    if (!value || currentMs >= value.resetAt) {\r\n      buckets.delete(key);\r\n    }\r\n  }\r\n\r\n  if (buckets.size <= MAX_BUCKETS) {\r\n    return;\r\n  }\r\n\r\n  let removeCount = buckets.size - MAX_BUCKETS;\r\n  for (const key of buckets.keys()) {\r\n    buckets.delete(key);\r\n    removeCount -= 1;\r\n    if (removeCount <= 0) {\r\n      break;\r\n    }\r\n  }\r\n}\r\n\r\nfunction normalizeIdentifier(value) {\r\n  return String(value || \"\")\r\n    .trim()\r\n    .toLowerCase();\r\n}\r\n\r\nexport function getRequestSourceIp(request) {\r\n  if (!request || !request.headers) {\r\n    return \"unknown\";\r\n  }\r\n\r\n  const forwardedFor = request.headers.get(\"x-forwarded-for\");\r\n  if (forwardedFor) {\r\n    const firstIp = forwardedFor.split(\",\")[0]?.trim();\r\n    if (firstIp) {\r\n      return firstIp;\r\n    }\r\n  }\r\n\r\n  const candidates = [\"x-real-ip\", \"cf-connecting-ip\", \"x-vercel-forwarded-for\"];\r\n  for (const headerName of candidates) {\r\n    const value = String(request.headers.get(headerName) || \"\").trim();\r\n    if (value) {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  return \"unknown\";\r\n}\r\n\r\nexport function consumeRateLimit({\r\n  scope,\r\n  identifier,\r\n  limit = 20,\r\n  windowMs = 5 * 60 * 1000,\r\n}) {\r\n  const safeScope = String(scope || \"default\")\r\n    .trim()\r\n    .toLowerCase();\r\n  const safeIdentifier = normalizeIdentifier(identifier) || \"unknown\";\r\n  const safeLimit = Math.max(1, Number.parseInt(String(limit), 10) || 1);\r\n  const safeWindowMs = Math.max(1000, Number.parseInt(String(windowMs), 10) || 1000);\r\n\r\n  const buckets = getBuckets();\r\n  const currentMs = nowMs();\r\n  cleanupExpiredBuckets(buckets, currentMs);\r\n\r\n  const key = `${safeScope}:${safeIdentifier}`;\r\n  const existing = buckets.get(key);\r\n\r\n  let bucket = existing;\r\n  if (!bucket || currentMs >= bucket.resetAt) {\r\n    bucket = {\r\n      count: 0,\r\n      resetAt: currentMs + safeWindowMs,\r\n    };\r\n  }\r\n\r\n  bucket.count += 1;\r\n  buckets.set(key, bucket);\r\n\r\n  const remaining = Math.max(0, safeLimit - bucket.count);\r\n  const retryAfterSeconds = Math.max(1, Math.ceil((bucket.resetAt - currentMs) / 1000));\r\n  const allowed = bucket.count <= safeLimit;\r\n\r\n  return {\r\n    allowed,\r\n    key,\r\n    remaining,\r\n    retryAfterSeconds,\r\n    resetAt: bucket.resetAt,\r\n    headers: {\r\n      \"Retry-After\": String(retryAfterSeconds),\r\n      \"X-RateLimit-Limit\": String(safeLimit),\r\n      \"X-RateLimit-Remaining\": String(remaining),\r\n      \"X-RateLimit-Reset\": String(Math.floor(bucket.resetAt / 1000)),\r\n    },\r\n  };\r\n}\r\n\r\nexport function enforceRateLimitByRequest({\r\n  request,\r\n  scope,\r\n  identifier,\r\n  limit,\r\n  windowMs,\r\n}) {\r\n  const resolvedIdentifier = normalizeIdentifier(identifier) || getRequestSourceIp(request);\r\n  return consumeRateLimit({\r\n    scope,\r\n    identifier: resolvedIdentifier,\r\n    limit,\r\n    windowMs,\r\n  });\r\n}\r\n","const RESEND_API_BASE = \"https://api.resend.com\";\r\nconst TWILIO_API_BASE = \"https://api.twilio.com/2010-04-01\";\r\n\r\nfunction asString(value, fallback = \"\") {\r\n  const normalized = String(value || \"\").trim();\r\n  return normalized || fallback;\r\n}\r\n\r\nfunction asArray(value) {\r\n  return Array.isArray(value) ? value : [];\r\n}\r\n\r\nfunction parseBooleanEnv(name, fallbackValue = false) {\r\n  const raw = asString(process.env[name]).toLowerCase();\r\n  if (!raw) {\r\n    return fallbackValue;\r\n  }\r\n  return raw === \"true\" || raw === \"1\" || raw === \"yes\";\r\n}\r\n\r\nfunction normalizeEmail(value) {\r\n  return asString(value).toLowerCase();\r\n}\r\n\r\nfunction normalizePhone(value) {\r\n  return String(value || \"\").replace(/[^\\d+]/g, \"\").trim();\r\n}\r\n\r\nfunction parseCsvList(value) {\r\n  return asString(value)\r\n    .split(\",\")\r\n    .map((item) => item.trim())\r\n    .filter(Boolean);\r\n}\r\n\r\nfunction dedupe(values = []) {\r\n  return Array.from(new Set(values.filter(Boolean)));\r\n}\r\n\r\nfunction normalizeEmailProvider(value) {\r\n  const normalized = asString(value).toLowerCase();\r\n  if (!normalized) {\r\n    return \"\";\r\n  }\r\n  if (normalized.includes(\"resend\")) return \"resend\";\r\n  if (normalized.includes(\"firebase\")) return \"firebase\";\r\n  if (normalized.includes(\"console\") || normalized === \"dev\") return \"console\";\r\n  if (normalized === \"none\" || normalized === \"off\") return \"none\";\r\n  return normalized;\r\n}\r\n\r\nfunction normalizeSmsProvider(value) {\r\n  const normalized = asString(value).toLowerCase();\r\n  if (!normalized) {\r\n    return \"\";\r\n  }\r\n  if (normalized.includes(\"twilio\")) return \"twilio\";\r\n  if (normalized.includes(\"console\") || normalized === \"dev\") return \"console\";\r\n  if (normalized === \"none\" || normalized === \"off\") return \"none\";\r\n  return normalized;\r\n}\r\n\r\nfunction resolveAlertEmailProvider() {\r\n  const configured = normalizeEmailProvider(process.env.CLIO_ALERT_EMAIL_PROVIDER);\r\n  if (configured) {\r\n    return configured;\r\n  }\r\n  if (process.env.NODE_ENV === \"production\") {\r\n    return \"none\";\r\n  }\r\n  const hasResend = asString(process.env.RESEND_API_KEY).startsWith(\"re_\") && asString(process.env.CLIO_EMAIL_FROM);\r\n  return hasResend ? \"resend\" : \"console\";\r\n}\r\n\r\nfunction resolveAlertSmsProvider() {\r\n  const configured = normalizeSmsProvider(process.env.CLIO_ALERT_SMS_PROVIDER);\r\n  if (configured) {\r\n    return configured;\r\n  }\r\n  return \"none\";\r\n}\r\n\r\nfunction resolveSecurityAlertRecipients(explicitRecipients = []) {\r\n  const fromEnv = [\r\n    ...parseCsvList(process.env.CLIO_SECURITY_ALERT_RECIPIENTS),\r\n    ...parseCsvList(process.env.GRC_EMAILS),\r\n    ...parseCsvList(process.env.SUPER_ADMIN_EMAILS),\r\n  ];\r\n  return dedupe(\r\n    [...fromEnv, ...asArray(explicitRecipients)]\r\n      .map((value) => normalizeEmail(value))\r\n      .filter(Boolean),\r\n  );\r\n}\r\n\r\nfunction resolveSmsRecipients(explicitRecipients = []) {\r\n  const fromEnv = parseCsvList(process.env.CLIO_SMS_ALERT_RECIPIENTS);\r\n  return dedupe([...fromEnv, ...asArray(explicitRecipients)].map((value) => normalizePhone(value)).filter(Boolean));\r\n}\r\n\r\nfunction buildIncidentAlertSubject({ incident, detection }) {\r\n  const severity = asString(incident?.severity || detection?.severity || \"Medium\").toUpperCase();\r\n  const incidentCode = asString(incident?.incidentCode, \"INCIDENT\");\r\n  const title = asString(incident?.title, \"Security anomaly detected\");\r\n  return `[CLIO][${severity}] ${incidentCode} - ${title}`;\r\n}\r\n\r\nfunction buildIncidentAlertText({ incident, detection, sourceEvent }) {\r\n  const ruleId = asString(detection?.ruleId, \"N/A\");\r\n  const sourceIp = asString(sourceEvent?.metadata?.sourceIp || sourceEvent?.sourceIp, \"unknown\");\r\n  const actor = asString(sourceEvent?.performedBy, \"unknown\");\r\n  const requestPath = asString(sourceEvent?.metadata?.requestPath || sourceEvent?.requestPath, \"unknown\");\r\n  const observedCount = Number(detection?.observedCount || 0);\r\n  const detectedAt = asString(incident?.detectedAt || sourceEvent?.occurredAt, new Date().toISOString());\r\n  return [\r\n    \"CLIO security anomaly alert\",\r\n    `Incident: ${asString(incident?.incidentCode, \"-\")} | ${asString(incident?.title, \"-\")}`,\r\n    `Severity: ${asString(incident?.severity, \"-\")}`,\r\n    `Rule: ${ruleId}`,\r\n    `Detected At: ${detectedAt}`,\r\n    `Actor: ${actor}`,\r\n    `Source IP: ${sourceIp}`,\r\n    `Request Path: ${requestPath}`,\r\n    `Observed Count: ${observedCount > 0 ? observedCount : \"-\"}`,\r\n    `Summary: ${asString(incident?.summary || detection?.summary, \"-\")}`,\r\n    `Action URL: ${asString(incident?.actionUrl, \"/incident-management\")}`,\r\n  ].join(\"\\n\");\r\n}\r\n\r\nfunction buildIncidentAlertHtml(text) {\r\n  const escaped = String(text || \"\")\r\n    .replaceAll(\"&\", \"&amp;\")\r\n    .replaceAll(\"<\", \"&lt;\")\r\n    .replaceAll(\">\", \"&gt;\");\r\n  return `<pre style=\"font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap;\">${escaped}</pre>`;\r\n}\r\n\r\nasync function sendEmailViaResend({ recipients, subject, text, html }) {\r\n  const apiKey = asString(process.env.RESEND_API_KEY);\r\n  const fromAddress = asString(process.env.CLIO_EMAIL_FROM);\r\n  if (!apiKey || !fromAddress || !apiKey.startsWith(\"re_\")) {\r\n    throw new Error(\"email_provider_not_configured\");\r\n  }\r\n\r\n  const response = await fetch(`${RESEND_API_BASE}/emails`, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      Authorization: `Bearer ${apiKey}`,\r\n    },\r\n    body: JSON.stringify({\r\n      from: fromAddress,\r\n      to: recipients,\r\n      subject,\r\n      text,\r\n      html,\r\n    }),\r\n  });\r\n\r\n  const payload = await response.json().catch(() => ({}));\r\n  if (!response.ok) {\r\n    const message =\r\n      asString(payload?.message) ||\r\n      asString(payload?.error?.message) ||\r\n      \"email_delivery_failed\";\r\n    throw new Error(`email_delivery_failed:${message}`);\r\n  }\r\n\r\n  return {\r\n    provider: \"resend\",\r\n    status: \"sent\",\r\n    messageId: asString(payload?.id, `resend-${Date.now()}`),\r\n    recipientCount: recipients.length,\r\n  };\r\n}\r\n\r\nfunction sendEmailViaConsole({ recipients, subject, text }) {\r\n  if (parseBooleanEnv(\"CLIO_ALLOW_CONSOLE_EMAIL\", true) || process.env.NODE_ENV !== \"production\") {\r\n    console.info(\"[CLIO:SecurityAlert:Email]\", {\r\n      recipients,\r\n      subject,\r\n      text,\r\n    });\r\n  }\r\n  return {\r\n    provider: \"console\",\r\n    status: \"simulated\",\r\n    recipientCount: recipients.length,\r\n  };\r\n}\r\n\r\nasync function dispatchEmailAlerts({ recipients, subject, text, html }) {\r\n  const safeRecipients = dedupe(asArray(recipients).map(normalizeEmail).filter(Boolean));\r\n  if (safeRecipients.length === 0) {\r\n    return {\r\n      provider: \"none\",\r\n      status: \"skipped\",\r\n      reason: \"no_recipients\",\r\n      recipientCount: 0,\r\n    };\r\n  }\r\n\r\n  const provider = resolveAlertEmailProvider();\r\n  if (provider === \"none\") {\r\n    return {\r\n      provider,\r\n      status: \"skipped\",\r\n      reason: \"provider_disabled\",\r\n      recipientCount: 0,\r\n    };\r\n  }\r\n  if (provider === \"firebase\") {\r\n    return {\r\n      provider,\r\n      status: \"skipped\",\r\n      reason: \"firebase_not_supported_for_custom_alert_email\",\r\n      recipientCount: 0,\r\n    };\r\n  }\r\n  if (provider === \"console\") {\r\n    return sendEmailViaConsole({\r\n      recipients: safeRecipients,\r\n      subject,\r\n      text,\r\n    });\r\n  }\r\n  if (provider === \"resend\") {\r\n    return await sendEmailViaResend({\r\n      recipients: safeRecipients,\r\n      subject,\r\n      text,\r\n      html,\r\n    });\r\n  }\r\n\r\n  return {\r\n    provider,\r\n    status: \"skipped\",\r\n    reason: \"unsupported_provider\",\r\n    recipientCount: 0,\r\n  };\r\n}\r\n\r\nasync function sendSmsViaTwilio({ recipients, body }) {\r\n  const accountSid = asString(process.env.TWILIO_ACCOUNT_SID);\r\n  const authToken = asString(process.env.TWILIO_AUTH_TOKEN);\r\n  const fromNumber = asString(process.env.TWILIO_FROM_NUMBER);\r\n  if (!accountSid || !authToken || !fromNumber) {\r\n    throw new Error(\"twilio_not_configured\");\r\n  }\r\n\r\n  const authHeader = Buffer.from(`${accountSid}:${authToken}`, \"utf8\").toString(\"base64\");\r\n  const requests = recipients.map(async (to) => {\r\n    const form = new URLSearchParams();\r\n    form.set(\"To\", to);\r\n    form.set(\"From\", fromNumber);\r\n    form.set(\"Body\", body);\r\n    const response = await fetch(`${TWILIO_API_BASE}/Accounts/${encodeURIComponent(accountSid)}/Messages.json`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        Authorization: `Basic ${authHeader}`,\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n      },\r\n      body: form.toString(),\r\n    });\r\n    const payload = await response.json().catch(() => ({}));\r\n    if (!response.ok) {\r\n      const message = asString(payload?.message, \"sms_delivery_failed\");\r\n      throw new Error(`twilio_delivery_failed:${message}`);\r\n    }\r\n    return {\r\n      to,\r\n      sid: asString(payload?.sid),\r\n    };\r\n  });\r\n\r\n  const settled = await Promise.allSettled(requests);\r\n  const delivered = settled\r\n    .filter((item) => item.status === \"fulfilled\")\r\n    .map((item) => item.value);\r\n  const failed = settled\r\n    .filter((item) => item.status === \"rejected\")\r\n    .map((item) => asString(item.reason?.message || \"sms_delivery_failed\"));\r\n\r\n  return {\r\n    provider: \"twilio\",\r\n    status: failed.length > 0 ? (delivered.length > 0 ? \"partial\" : \"failed\") : \"sent\",\r\n    deliveredCount: delivered.length,\r\n    recipientCount: recipients.length,\r\n    delivered,\r\n    failed,\r\n  };\r\n}\r\n\r\nfunction sendSmsViaConsole({ recipients, body }) {\r\n  if (process.env.NODE_ENV !== \"production\") {\r\n    console.info(\"[CLIO:SecurityAlert:SMS]\", {\r\n      recipients,\r\n      body,\r\n    });\r\n  }\r\n  return {\r\n    provider: \"console\",\r\n    status: \"simulated\",\r\n    deliveredCount: recipients.length,\r\n    recipientCount: recipients.length,\r\n    delivered: recipients.map((to) => ({ to, sid: `console-${Date.now()}` })),\r\n    failed: [],\r\n  };\r\n}\r\n\r\nasync function dispatchSmsAlerts({ recipients, body }) {\r\n  const safeRecipients = dedupe(asArray(recipients).map(normalizePhone).filter(Boolean));\r\n  if (safeRecipients.length === 0) {\r\n    return {\r\n      provider: \"none\",\r\n      status: \"skipped\",\r\n      reason: \"no_recipients\",\r\n      deliveredCount: 0,\r\n      recipientCount: 0,\r\n      failed: [],\r\n    };\r\n  }\r\n\r\n  const provider = resolveAlertSmsProvider();\r\n  if (provider === \"none\") {\r\n    return {\r\n      provider,\r\n      status: \"skipped\",\r\n      reason: \"provider_disabled\",\r\n      deliveredCount: 0,\r\n      recipientCount: safeRecipients.length,\r\n      failed: [],\r\n    };\r\n  }\r\n  if (provider === \"console\") {\r\n    return sendSmsViaConsole({\r\n      recipients: safeRecipients,\r\n      body,\r\n    });\r\n  }\r\n  if (provider === \"twilio\") {\r\n    return await sendSmsViaTwilio({\r\n      recipients: safeRecipients,\r\n      body,\r\n    });\r\n  }\r\n\r\n  return {\r\n    provider,\r\n    status: \"skipped\",\r\n    reason: \"unsupported_provider\",\r\n    deliveredCount: 0,\r\n    recipientCount: safeRecipients.length,\r\n    failed: [],\r\n  };\r\n}\r\n\r\nfunction getConfiguredWebhookTargets() {\r\n  const generic = parseCsvList(process.env.CLIO_SECURITY_WEBHOOK_URLS).map((url) => ({\r\n    label: \"security-webhook\",\r\n    url,\r\n    token: asString(process.env.CLIO_SECURITY_WEBHOOK_TOKEN),\r\n  }));\r\n  const siemUrl = asString(process.env.CLIO_SIEM_WEBHOOK_URL);\r\n  const edrUrl = asString(process.env.CLIO_EDR_WEBHOOK_URL);\r\n  const targets = [...generic];\r\n  if (siemUrl) {\r\n    targets.push({\r\n      label: \"siem\",\r\n      url: siemUrl,\r\n      token: asString(process.env.CLIO_SIEM_WEBHOOK_TOKEN),\r\n    });\r\n  }\r\n  if (edrUrl) {\r\n    targets.push({\r\n      label: \"edr\",\r\n      url: edrUrl,\r\n      token: asString(process.env.CLIO_EDR_WEBHOOK_TOKEN),\r\n    });\r\n  }\r\n  return targets.filter((target) => asString(target.url));\r\n}\r\n\r\nasync function postWebhook({ url, label, token, payload, timeoutMs }) {\r\n  const controller = new AbortController();\r\n  const timer = setTimeout(() => controller.abort(), timeoutMs);\r\n  try {\r\n    const headers = {\r\n      \"Content-Type\": \"application/json\",\r\n      \"X-CLIO-Source\": \"security-detection\",\r\n      \"X-CLIO-Target\": label,\r\n    };\r\n    if (token) {\r\n      headers.Authorization = `Bearer ${token}`;\r\n    }\r\n    const response = await fetch(url, {\r\n      method: \"POST\",\r\n      headers,\r\n      body: JSON.stringify(payload),\r\n      signal: controller.signal,\r\n    });\r\n    const body = await response.text().catch(() => \"\");\r\n    return {\r\n      label,\r\n      url,\r\n      ok: response.ok,\r\n      status: response.status,\r\n      body: asString(body),\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      label,\r\n      url,\r\n      ok: false,\r\n      status: 0,\r\n      body: asString(error?.message, \"webhook_delivery_failed\"),\r\n    };\r\n  } finally {\r\n    clearTimeout(timer);\r\n  }\r\n}\r\n\r\nasync function dispatchWebhooks(payload) {\r\n  const targets = getConfiguredWebhookTargets();\r\n  if (targets.length === 0) {\r\n    return {\r\n      status: \"skipped\",\r\n      targets: [],\r\n      successCount: 0,\r\n    };\r\n  }\r\n\r\n  const timeoutMs = Number.parseInt(asString(process.env.CLIO_SECURITY_WEBHOOK_TIMEOUT_MS, \"5000\"), 10) || 5000;\r\n  const results = await Promise.all(\r\n    targets.map((target) =>\r\n      postWebhook({\r\n        ...target,\r\n        payload,\r\n        timeoutMs: Math.max(1000, Math.min(20000, timeoutMs)),\r\n      }),\r\n    ),\r\n  );\r\n  const successCount = results.filter((item) => item.ok).length;\r\n  return {\r\n    status: successCount === results.length ? \"sent\" : successCount > 0 ? \"partial\" : \"failed\",\r\n    targets: results,\r\n    successCount,\r\n  };\r\n}\r\n\r\nexport async function dispatchSecurityIncidentAlerts({\r\n  incident,\r\n  detection,\r\n  sourceEvent,\r\n  emailRecipients = [],\r\n  smsRecipients = [],\r\n} = {}) {\r\n  const recipients = resolveSecurityAlertRecipients(emailRecipients);\r\n  const smsTargets = resolveSmsRecipients(smsRecipients);\r\n  const subject = buildIncidentAlertSubject({ incident, detection });\r\n  const text = buildIncidentAlertText({ incident, detection, sourceEvent });\r\n  const html = buildIncidentAlertHtml(text);\r\n\r\n  const [emailResult, smsResult, webhookResult] = await Promise.all([\r\n    dispatchEmailAlerts({\r\n      recipients,\r\n      subject,\r\n      text,\r\n      html,\r\n    }).catch((error) => ({\r\n      provider: resolveAlertEmailProvider(),\r\n      status: \"failed\",\r\n      reason: asString(error?.message, \"email_delivery_failed\"),\r\n      recipientCount: recipients.length,\r\n    })),\r\n    dispatchSmsAlerts({\r\n      recipients: smsTargets,\r\n      body: `${subject}\\n${text}`.slice(0, 1200),\r\n    }).catch((error) => ({\r\n      provider: resolveAlertSmsProvider(),\r\n      status: \"failed\",\r\n      reason: asString(error?.message, \"sms_delivery_failed\"),\r\n      deliveredCount: 0,\r\n      recipientCount: smsTargets.length,\r\n      failed: [asString(error?.message, \"sms_delivery_failed\")],\r\n    })),\r\n    dispatchWebhooks({\r\n      eventType: \"clio.security.incident\",\r\n      generatedAt: new Date().toISOString(),\r\n      incident,\r\n      detection,\r\n      sourceEvent: {\r\n        id: asString(sourceEvent?.id),\r\n        module: asString(sourceEvent?.module),\r\n        activityName: asString(sourceEvent?.activityName),\r\n        status: asString(sourceEvent?.status),\r\n        occurredAt: asString(sourceEvent?.occurredAt),\r\n        sourceIp: asString(sourceEvent?.metadata?.sourceIp || sourceEvent?.sourceIp),\r\n        requestPath: asString(sourceEvent?.metadata?.requestPath || sourceEvent?.requestPath),\r\n      },\r\n    }),\r\n  ]);\r\n\r\n  return {\r\n    subject,\r\n    email: emailResult,\r\n    sms: smsResult,\r\n    webhooks: webhookResult,\r\n    recipients,\r\n    smsRecipients: smsTargets,\r\n  };\r\n}\r\n\r\nexport function resolveSecurityAlertEmailRecipients(explicitRecipients = []) {\r\n  return resolveSecurityAlertRecipients(explicitRecipients);\r\n}\r\n\r\nexport async function dispatchDirectSms({ recipients = [], body = \"\" } = {}) {\r\n  return await dispatchSmsAlerts({\r\n    recipients,\r\n    body: asString(body, \"\"),\r\n  });\r\n}\r\n","function asString(value, fallback = \"\") {\r\n  const normalized = String(value || \"\").trim();\r\n  return normalized || fallback;\r\n}\r\n\r\nconst INCIDENT_FIELD_LABELS = {\r\n  title: \"Incident title\",\r\n  summary: \"Incident summary\",\r\n  incidentType: \"Incident type\",\r\n  severity: \"Severity\",\r\n  status: \"Status\",\r\n  containmentStatus: \"Containment status\",\r\n  containmentSummary: \"Containment summary\",\r\n  impactAssessmentStatus: \"Impact assessment status\",\r\n  impactSummary: \"Impact assessment summary\",\r\n  ownerEmail: \"Incident owner\",\r\n  affectedEmployeeEmail: \"Affected employee\",\r\n  restrictedPiiInvolved: \"Restricted PII flag\",\r\n  escalationRequired: \"Escalation requirement\",\r\n  executiveNotificationRequired: \"Executive notification requirement\",\r\n  regulatoryNotificationRequired: \"Regulatory notification requirement\",\r\n  regulatoryNotifiedAt: \"Regulator notification\",\r\n  affectedIndividualsNotifiedAt: \"Affected-individual notification\",\r\n  grcAlertedAt: \"GRC alert timestamp\",\r\n  executiveNotifiedAt: \"Executive notification timestamp\",\r\n  documentationRetained: \"Documentation retention\",\r\n  documentationLocation: \"Documentation location\",\r\n  classificationStandard: \"Classification standard\",\r\n  notes: \"Investigation notes\",\r\n  forensicWindowStart: \"Forensic window start\",\r\n  forensicWindowEnd: \"Forensic window end\",\r\n};\r\n\r\nfunction humanizeFieldKey(key) {\r\n  const normalized = asString(key);\r\n  if (!normalized) return \"Field\";\r\n  if (INCIDENT_FIELD_LABELS[normalized]) {\r\n    return INCIDENT_FIELD_LABELS[normalized];\r\n  }\r\n  return normalized\r\n    .replace(/([a-z0-9])([A-Z])/g, \"$1 $2\")\r\n    .replace(/[_-]+/g, \" \")\r\n    .replace(/\\s+/g, \" \")\r\n    .trim()\r\n    .replace(/^./, (char) => char.toUpperCase());\r\n}\r\n\r\nfunction summarizeChangedFields(changedFields = [], { max = 4 } = {}) {\r\n  const labels = Array.from(\r\n    new Set(\r\n      (Array.isArray(changedFields) ? changedFields : [])\r\n        .map((field) => humanizeFieldKey(field))\r\n        .filter(Boolean),\r\n    ),\r\n  );\r\n\r\n  if (labels.length === 0) {\r\n    return \"\";\r\n  }\r\n  if (labels.length <= max) {\r\n    return labels.join(\", \");\r\n  }\r\n  const visible = labels.slice(0, max).join(\", \");\r\n  return `${visible}, +${labels.length - max} more`;\r\n}\r\n\r\nexport function resolveIncidentDisplayName(incident = {}, fallbackRecordId = \"\") {\r\n  const title = asString(incident?.title);\r\n  if (title) {\r\n    return title;\r\n  }\r\n  const code = asString(incident?.incidentCode);\r\n  if (code) {\r\n    return `Case ${code}`;\r\n  }\r\n  if (asString(fallbackRecordId)) {\r\n    return \"Incident Record\";\r\n  }\r\n  return \"Incident\";\r\n}\r\n\r\nexport function buildIncidentCreatedNotification(incident = {}, fallbackRecordId = \"\") {\r\n  const displayName = resolveIncidentDisplayName(incident, fallbackRecordId);\r\n  const severity = asString(incident?.severity, \"Medium\");\r\n  const status = asString(incident?.status, \"Open\");\r\n  return {\r\n    title: `New Incident: ${displayName}`,\r\n    message: `A new incident has been logged for review. Severity: ${severity}. Current status: ${status}.`,\r\n  };\r\n}\r\n\r\nexport function buildIncidentUpdatedNotification(\r\n  incident = {},\r\n  changedFields = [],\r\n  fallbackRecordId = \"\",\r\n) {\r\n  const displayName = resolveIncidentDisplayName(incident, fallbackRecordId);\r\n  const changedSummary = summarizeChangedFields(changedFields);\r\n\r\n  const normalizedChanged = new Set((Array.isArray(changedFields) ? changedFields : []).map((field) => asString(field)));\r\n\r\n  let actionSummary = \"Incident workflow details were updated.\";\r\n  if (normalizedChanged.has(\"status\")) {\r\n    actionSummary = `Incident status is now ${asString(incident?.status, \"updated\")}.`;\r\n  } else if (normalizedChanged.has(\"containmentStatus\")) {\r\n    actionSummary = `Containment status is now ${asString(incident?.containmentStatus, \"updated\")}.`;\r\n  } else if (normalizedChanged.has(\"regulatoryNotifiedAt\")) {\r\n    actionSummary = \"Regulator notification has been recorded.\";\r\n  } else if (normalizedChanged.has(\"affectedIndividualsNotifiedAt\")) {\r\n    actionSummary = \"Affected-individual notification has been recorded.\";\r\n  } else if (normalizedChanged.has(\"executiveNotifiedAt\")) {\r\n    actionSummary = \"Executive notification has been recorded.\";\r\n  } else if (normalizedChanged.has(\"grcAlertedAt\")) {\r\n    actionSummary = \"GRC alert timestamp has been recorded.\";\r\n  }\r\n\r\n  const changedText = changedSummary ? ` Updated fields: ${changedSummary}.` : \"\";\r\n  return {\r\n    title: `Incident Updated: ${displayName}`,\r\n    message: `${actionSummary}${changedText}`.trim(),\r\n  };\r\n}\r\n","const DEFAULT_MAX_BYTES = 10 * 1024 * 1024;\r\nconst DEFAULT_ALLOWED_EXTENSIONS = new Set([\"pdf\", \"png\", \"jpg\", \"jpeg\", \"webp\", \"doc\", \"docx\", \"xls\", \"xlsx\", \"csv\", \"txt\"]);\r\nconst DEFAULT_ALLOWED_MIME_TYPES = new Set([\r\n  \"application/pdf\",\r\n  \"image/png\",\r\n  \"image/jpeg\",\r\n  \"image/webp\",\r\n  \"application/msword\",\r\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\r\n  \"application/vnd.ms-excel\",\r\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\r\n  \"text/csv\",\r\n  \"text/plain\",\r\n]);\r\n\r\nfunction asString(value, fallback = \"\") {\r\n  const normalized = String(value || \"\").trim();\r\n  return normalized || fallback;\r\n}\r\n\r\nfunction asArray(value) {\r\n  return Array.isArray(value) ? value : [];\r\n}\r\n\r\nfunction asObject(value, fallback = null) {\r\n  if (value && typeof value === \"object\" && !Array.isArray(value)) {\r\n    return value;\r\n  }\r\n  return fallback;\r\n}\r\n\r\nfunction normalizeText(value) {\r\n  return asString(value).toLowerCase();\r\n}\r\n\r\nfunction parseBooleanEnv(name, fallbackValue = false) {\r\n  const normalized = normalizeText(process.env[name]);\r\n  if (!normalized) {\r\n    return fallbackValue;\r\n  }\r\n  return normalized === \"true\" || normalized === \"1\" || normalized === \"yes\" || normalized === \"on\";\r\n}\r\n\r\nfunction parseIntegerEnv(name, fallbackValue, { min = 1, max = Number.MAX_SAFE_INTEGER } = {}) {\r\n  const parsed = Number.parseInt(asString(process.env[name]), 10);\r\n  if (!Number.isFinite(parsed)) {\r\n    return fallbackValue;\r\n  }\r\n  return Math.min(max, Math.max(min, parsed));\r\n}\r\n\r\nfunction parseCsvSetEnv(name, fallbackSet) {\r\n  const raw = asString(process.env[name]);\r\n  if (!raw) {\r\n    return new Set([...fallbackSet]);\r\n  }\r\n  const values = raw\r\n    .split(\",\")\r\n    .map((item) => normalizeText(item))\r\n    .filter(Boolean);\r\n  return values.length > 0 ? new Set(values) : new Set([...fallbackSet]);\r\n}\r\n\r\nfunction normalizeEmail(value) {\r\n  return asString(value).toLowerCase();\r\n}\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction getFileExtensionFromText(value) {\r\n  const input = asString(value).toLowerCase();\r\n  if (!input) {\r\n    return \"\";\r\n  }\r\n  const clean = input.split(\"?\")[0].split(\"#\")[0];\r\n  const token = clean.split(\".\").pop() || \"\";\r\n  if (!/^[a-z0-9]{2,10}$/.test(token)) {\r\n    return \"\";\r\n  }\r\n  return token;\r\n}\r\n\r\nfunction inferMimeTypeFromExtension(extension) {\r\n  const ext = normalizeText(extension);\r\n  if (ext === \"pdf\") return \"application/pdf\";\r\n  if (ext === \"png\") return \"image/png\";\r\n  if (ext === \"jpg\" || ext === \"jpeg\") return \"image/jpeg\";\r\n  if (ext === \"webp\") return \"image/webp\";\r\n  if (ext === \"doc\") return \"application/msword\";\r\n  if (ext === \"docx\") return \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\";\r\n  if (ext === \"xls\") return \"application/vnd.ms-excel\";\r\n  if (ext === \"xlsx\") return \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\r\n  if (ext === \"csv\") return \"text/csv\";\r\n  if (ext === \"txt\") return \"text/plain\";\r\n  return \"\";\r\n}\r\n\r\nfunction normalizeEvidenceType(value) {\r\n  const normalized = asString(value, \"Incident Evidence\");\r\n  return normalized.slice(0, 80);\r\n}\r\n\r\nfunction getValidationConfig() {\r\n  return {\r\n    maxBytes: parseIntegerEnv(\"CLIO_INCIDENT_EVIDENCE_MAX_BYTES\", DEFAULT_MAX_BYTES, {\r\n      min: 128 * 1024,\r\n      max: 50 * 1024 * 1024,\r\n    }),\r\n    allowedExtensions: parseCsvSetEnv(\"CLIO_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS\", DEFAULT_ALLOWED_EXTENSIONS),\r\n    allowedMimeTypes: parseCsvSetEnv(\"CLIO_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES\", DEFAULT_ALLOWED_MIME_TYPES),\r\n    requireMimeType: parseBooleanEnv(\"CLIO_INCIDENT_EVIDENCE_REQUIRE_MIME_TYPE\", true),\r\n    avHookUrl: asString(process.env.CLIO_INCIDENT_EVIDENCE_AV_HOOK_URL),\r\n    avHookToken: asString(process.env.CLIO_INCIDENT_EVIDENCE_AV_HOOK_TOKEN),\r\n    avRequired: parseBooleanEnv(\"CLIO_INCIDENT_EVIDENCE_AV_REQUIRED\", false),\r\n    avFailOpen: parseBooleanEnv(\"CLIO_INCIDENT_EVIDENCE_AV_FAIL_OPEN\", false),\r\n    avTimeoutMs: parseIntegerEnv(\"CLIO_INCIDENT_EVIDENCE_AV_TIMEOUT_MS\", 5000, {\r\n      min: 1000,\r\n      max: 20000,\r\n    }),\r\n  };\r\n}\r\n\r\nfunction normalizeEvidenceRecord(entry, index, actorEmail, config) {\r\n  const source = asObject(entry);\r\n  if (!source) {\r\n    throw new Error(\"invalid_incident_evidence_payload\");\r\n  }\r\n\r\n  const name = asString(source.name);\r\n  if (!name) {\r\n    throw new Error(\"invalid_incident_evidence_name\");\r\n  }\r\n\r\n  const ref = asString(source.ref);\r\n  const storagePath = asString(source.storagePath);\r\n  if (!ref && !storagePath) {\r\n    throw new Error(\"invalid_incident_evidence_reference\");\r\n  }\r\n\r\n  const fileExtension =\r\n    getFileExtensionFromText(source.fileExtension) ||\r\n    getFileExtensionFromText(name) ||\r\n    getFileExtensionFromText(storagePath) ||\r\n    getFileExtensionFromText(ref);\r\n  if (!fileExtension || !config.allowedExtensions.has(fileExtension)) {\r\n    throw new Error(\"invalid_incident_evidence_extension\");\r\n  }\r\n\r\n  const normalizedContentType = normalizeText(source.contentType) || inferMimeTypeFromExtension(fileExtension);\r\n  if (!normalizedContentType || !config.allowedMimeTypes.has(normalizedContentType)) {\r\n    throw new Error(\"invalid_incident_evidence_content_type\");\r\n  }\r\n\r\n  if (config.requireMimeType && !asString(source.contentType)) {\r\n    throw new Error(\"invalid_incident_evidence_content_type\");\r\n  }\r\n\r\n  const rawSize = Number(source.sizeBytes);\r\n  if (!Number.isFinite(rawSize) || rawSize <= 0 || rawSize > config.maxBytes) {\r\n    throw new Error(\"invalid_incident_evidence_size\");\r\n  }\r\n\r\n  const uploadedAt = asString(source.uploadedAt, nowIso());\r\n  const uploadedBy = normalizeEmail(source.uploadedBy || actorEmail);\r\n  const id = asString(source.id || source.recordId, `incident-evidence-${Date.now()}-${index + 1}`);\r\n\r\n  return {\r\n    id,\r\n    name: name.slice(0, 180),\r\n    type: normalizeEvidenceType(source.type),\r\n    ref,\r\n    storagePath,\r\n    fileExtension,\r\n    contentType: normalizedContentType,\r\n    sizeBytes: Math.round(rawSize),\r\n    uploadedAt,\r\n    uploadedBy: uploadedBy || normalizeEmail(actorEmail) || \"system@gmail.com\",\r\n    scanStatus: asString(source.scanStatus),\r\n    scanReference: asString(source.scanReference),\r\n  };\r\n}\r\n\r\nasync function runEvidenceAvHook(records, actorEmail, config) {\r\n  if (!config.avHookUrl) {\r\n    if (config.avRequired) {\r\n      throw new Error(\"incident_evidence_av_not_configured\");\r\n    }\r\n    return {\r\n      status: \"skipped\",\r\n      provider: \"none\",\r\n      blockedIds: [],\r\n      reference: \"\",\r\n    };\r\n  }\r\n\r\n  const controller = new AbortController();\r\n  const timeout = setTimeout(() => controller.abort(), config.avTimeoutMs);\r\n  try {\r\n    const headers = {\r\n      \"Content-Type\": \"application/json\",\r\n      \"X-CLIO-Source\": \"incident-evidence-validation\",\r\n    };\r\n    if (config.avHookToken) {\r\n      headers.Authorization = `Bearer ${config.avHookToken}`;\r\n    }\r\n\r\n    const response = await fetch(config.avHookUrl, {\r\n      method: \"POST\",\r\n      headers,\r\n      body: JSON.stringify({\r\n        generatedAt: nowIso(),\r\n        actorEmail: normalizeEmail(actorEmail),\r\n        records: records.map((record) => ({\r\n          id: record.id,\r\n          name: record.name,\r\n          storagePath: record.storagePath,\r\n          ref: record.ref,\r\n          contentType: record.contentType,\r\n          fileExtension: record.fileExtension,\r\n          sizeBytes: record.sizeBytes,\r\n        })),\r\n      }),\r\n      signal: controller.signal,\r\n    });\r\n\r\n    const payload = await response.json().catch(() => ({}));\r\n    if (!response.ok) {\r\n      throw new Error(asString(payload?.message, \"incident_evidence_av_hook_failed\"));\r\n    }\r\n\r\n    const blockedIds = asArray(payload?.blockedIds)\r\n      .map((item) => asString(item))\r\n      .filter(Boolean);\r\n    const blocked = payload?.allowed === false || payload?.blocked === true || blockedIds.length > 0;\r\n    if (blocked) {\r\n      throw new Error(\"incident_evidence_av_blocked\");\r\n    }\r\n\r\n    return {\r\n      status: \"passed\",\r\n      provider: \"hook\",\r\n      blockedIds: [],\r\n      reference: asString(payload?.scanId || payload?.reference || \"\"),\r\n    };\r\n  } catch (error) {\r\n    if (config.avFailOpen && !config.avRequired) {\r\n      return {\r\n        status: \"failed-open\",\r\n        provider: \"hook\",\r\n        blockedIds: [],\r\n        reference: \"\",\r\n      };\r\n    }\r\n    const reason = error instanceof Error ? asString(error.message) : \"\";\r\n    if (reason === \"incident_evidence_av_blocked\") {\r\n      throw error;\r\n    }\r\n    throw new Error(\"incident_evidence_av_hook_failed\");\r\n  } finally {\r\n    clearTimeout(timeout);\r\n  }\r\n}\r\n\r\nexport async function validateIncidentEvidenceDocumentsStrict(records, { actorEmail } = {}) {\r\n  if (!Array.isArray(records)) {\r\n    throw new Error(\"invalid_incident_evidence_payload\");\r\n  }\r\n\r\n  const config = getValidationConfig();\r\n  const normalizedRecords = records.map((entry, index) =>\r\n    normalizeEvidenceRecord(entry, index, actorEmail, config),\r\n  );\r\n\r\n  const avResult = await runEvidenceAvHook(normalizedRecords, actorEmail, config);\r\n  const scannedAt = nowIso();\r\n  return normalizedRecords.map((record) => ({\r\n    ...record,\r\n    scanStatus: record.scanStatus || avResult.status,\r\n    scanReference: record.scanReference || avResult.reference,\r\n    scannedAt,\r\n  }));\r\n}\r\n"],"names":[],"mappings":"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"}