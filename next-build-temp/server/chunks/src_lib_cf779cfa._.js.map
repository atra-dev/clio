{"version":3,"sources":["../../../src/lib/actor-directory.js"],"sourcesContent":["import { listUserAccounts } from \"@/lib/user-accounts\";\r\nimport { formatPersonName, formatNameFromEmail } from \"@/lib/name-utils\";\r\n\r\nconst ACTOR_DIRECTORY_CACHE_TTL_MS = 30 * 1000;\r\nlet cachedUserAccounts = [];\r\nlet cachedUserAccountsAt = 0;\r\n\r\nfunction normalizeActorEmail(value) {\r\n  const normalized = String(value || \"\").trim().toLowerCase();\r\n  if (!normalized || !normalized.includes(\"@\")) {\r\n    return \"\";\r\n  }\r\n  return normalized;\r\n}\r\n\r\nfunction buildAccountDisplayName(account, fallbackEmail) {\r\n  return formatPersonName({\r\n    firstName: account?.firstName,\r\n    middleName: account?.middleName,\r\n    lastName: account?.lastName,\r\n    fallbackEmail,\r\n    fallbackLabel: \"User\",\r\n  });\r\n}\r\n\r\nasync function getCachedUserAccounts() {\r\n  const now = Date.now();\r\n  if (now - cachedUserAccountsAt < ACTOR_DIRECTORY_CACHE_TTL_MS && Array.isArray(cachedUserAccounts)) {\r\n    return cachedUserAccounts;\r\n  }\r\n\r\n  const users = await listUserAccounts();\r\n  cachedUserAccounts = Array.isArray(users) ? users : [];\r\n  cachedUserAccountsAt = now;\r\n  return cachedUserAccounts;\r\n}\r\n\r\nexport function collectActorEmailSet(values = []) {\r\n  const set = new Set();\r\n\r\n  values.forEach((value) => {\r\n    const normalizedEmail = normalizeActorEmail(value);\r\n    if (normalizedEmail) {\r\n      set.add(normalizedEmail);\r\n    }\r\n  });\r\n\r\n  return set;\r\n}\r\n\r\nexport async function createActorDirectory(values = []) {\r\n  const emailSet = collectActorEmailSet(values);\r\n  const includeAll = emailSet.size === 0;\r\n  const directory = new Map();\r\n\r\n  try {\r\n    const users = await getCachedUserAccounts();\r\n\r\n    users.forEach((user) => {\r\n      const email = normalizeActorEmail(user?.email);\r\n      if (!email) {\r\n        return;\r\n      }\r\n      if (!includeAll && !emailSet.has(email)) {\r\n        return;\r\n      }\r\n\r\n      directory.set(email, {\r\n        email,\r\n        name: buildAccountDisplayName(user, email),\r\n        avatarUrl: typeof user?.profilePhotoDataUrl === \"string\" ? user.profilePhotoDataUrl : null,\r\n      });\r\n    });\r\n  } catch {\r\n    // Fallback to deterministic email-derived names if account lookup fails.\r\n  }\r\n\r\n  emailSet.forEach((email) => {\r\n    if (!directory.has(email)) {\r\n      directory.set(email, {\r\n        email,\r\n        name: formatNameFromEmail(email),\r\n        avatarUrl: null,\r\n      });\r\n    }\r\n  });\r\n\r\n  return directory;\r\n}\r\n\r\nexport function resolveActor(directory, actorValue) {\r\n  const email = normalizeActorEmail(actorValue);\r\n  if (email && directory instanceof Map) {\r\n    const actor = directory.get(email);\r\n    if (actor) {\r\n      return actor;\r\n    }\r\n  }\r\n\r\n  if (email) {\r\n    return {\r\n      email,\r\n      name: formatNameFromEmail(email),\r\n      avatarUrl: null,\r\n    };\r\n  }\r\n\r\n  const raw = String(actorValue || \"\").trim();\r\n  if (!raw) {\r\n    return {\r\n      email: \"\",\r\n      name: \"System\",\r\n      avatarUrl: null,\r\n    };\r\n  }\r\n\r\n  return {\r\n    email: raw,\r\n    name: raw,\r\n    avatarUrl: null,\r\n  };\r\n}\r\n\r\nexport function enrichTrailActors(events, directory, { actorKey = \"by\" } = {}) {\r\n  if (!Array.isArray(events)) {\r\n    return [];\r\n  }\r\n\r\n  return events.map((event) => {\r\n    const actor = resolveActor(directory, event?.[actorKey]);\r\n    return {\r\n      ...event,\r\n      [`${actorKey}Name`]: actor.name,\r\n      [`${actorKey}Email`]: actor.email || String(event?.[actorKey] || \"\"),\r\n      [`${actorKey}Avatar`]: actor.avatarUrl,\r\n    };\r\n  });\r\n}\r\n\r\nexport function collectEmailsFromTrail(events, actorKey = \"by\") {\r\n  if (!Array.isArray(events)) {\r\n    return [];\r\n  }\r\n\r\n  return events.map((event) => event?.[actorKey]).filter(Boolean);\r\n}\r\n\r\nexport function collectEmployeeActorValues(record) {\r\n  if (!record || typeof record !== \"object\") {\r\n    return [];\r\n  }\r\n\r\n  const values = [record.createdBy, record.updatedBy];\r\n  if (Array.isArray(record.activityHistory)) {\r\n    record.activityHistory.forEach((item) => {\r\n      values.push(item?.by);\r\n    });\r\n  }\r\n  if (Array.isArray(record.documents)) {\r\n    record.documents.forEach((item) => {\r\n      values.push(item?.uploadedBy);\r\n    });\r\n  }\r\n\r\n  return values.filter(Boolean);\r\n}\r\n\r\nexport function enrichEmployeeRecordActors(record, directory) {\r\n  if (!record || typeof record !== \"object\") {\r\n    return record;\r\n  }\r\n\r\n  const createdActor = resolveActor(directory, record.createdBy);\r\n  const updatedActor = resolveActor(directory, record.updatedBy);\r\n\r\n  const activityHistory = Array.isArray(record.activityHistory)\r\n    ? record.activityHistory.map((item) => {\r\n        const actor = resolveActor(directory, item?.by);\r\n        return {\r\n          ...item,\r\n          byName: actor.name,\r\n          byEmail: actor.email || String(item?.by || \"\"),\r\n          byAvatar: actor.avatarUrl,\r\n        };\r\n      })\r\n    : [];\r\n\r\n  const documents = Array.isArray(record.documents)\r\n    ? record.documents.map((item) => {\r\n        const actor = resolveActor(directory, item?.uploadedBy);\r\n        return {\r\n          ...item,\r\n          uploadedByName: actor.name,\r\n          uploadedByEmail: actor.email || String(item?.uploadedBy || \"\"),\r\n          uploadedByAvatar: actor.avatarUrl,\r\n        };\r\n      })\r\n    : [];\r\n\r\n  return {\r\n    ...record,\r\n    createdByName: createdActor.name,\r\n    createdByEmail: createdActor.email || String(record.createdBy || \"\"),\r\n    createdByAvatar: createdActor.avatarUrl,\r\n    updatedByName: updatedActor.name,\r\n    updatedByEmail: updatedActor.email || String(record.updatedBy || \"\"),\r\n    updatedByAvatar: updatedActor.avatarUrl,\r\n    activityHistory,\r\n    documents,\r\n  };\r\n}\r\n\r\nexport function collectTemplateActorValues(record) {\r\n  if (!record || typeof record !== \"object\") {\r\n    return [];\r\n  }\r\n\r\n  const values = [record.createdBy, record.updatedBy];\r\n\r\n  if (Array.isArray(record.versionHistory)) {\r\n    record.versionHistory.forEach((item) => {\r\n      values.push(item?.changedBy);\r\n    });\r\n  }\r\n  if (Array.isArray(record.modificationLog)) {\r\n    record.modificationLog.forEach((item) => {\r\n      values.push(item?.by);\r\n    });\r\n  }\r\n  if (Array.isArray(record.usageLogs)) {\r\n    record.usageLogs.forEach((item) => {\r\n      values.push(item?.by, item?.uploadedBy, item?.performedBy);\r\n    });\r\n  }\r\n\r\n  return values.filter(Boolean);\r\n}\r\n\r\nexport function enrichTemplateRecordActors(record, directory) {\r\n  if (!record || typeof record !== \"object\") {\r\n    return record;\r\n  }\r\n\r\n  const createdActor = resolveActor(directory, record.createdBy);\r\n  const updatedActor = resolveActor(directory, record.updatedBy);\r\n\r\n  const versionHistory = Array.isArray(record.versionHistory)\r\n    ? record.versionHistory.map((item) => {\r\n        const actor = resolveActor(directory, item?.changedBy);\r\n        return {\r\n          ...item,\r\n          changedByName: actor.name,\r\n          changedByEmail: actor.email || String(item?.changedBy || \"\"),\r\n          changedByAvatar: actor.avatarUrl,\r\n        };\r\n      })\r\n    : [];\r\n\r\n  const modificationLog = Array.isArray(record.modificationLog)\r\n    ? record.modificationLog.map((item) => {\r\n        const actor = resolveActor(directory, item?.by);\r\n        return {\r\n          ...item,\r\n          byName: actor.name,\r\n          byEmail: actor.email || String(item?.by || \"\"),\r\n          byAvatar: actor.avatarUrl,\r\n        };\r\n      })\r\n    : [];\r\n\r\n  return {\r\n    ...record,\r\n    createdByName: createdActor.name,\r\n    createdByEmail: createdActor.email || String(record.createdBy || \"\"),\r\n    createdByAvatar: createdActor.avatarUrl,\r\n    updatedByName: updatedActor.name,\r\n    updatedByEmail: updatedActor.email || String(record.updatedBy || \"\"),\r\n    updatedByAvatar: updatedActor.avatarUrl,\r\n    versionHistory,\r\n    modificationLog,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}