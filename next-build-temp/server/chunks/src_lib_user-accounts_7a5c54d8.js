module.exports=[45709,28221,11655,e=>{"use strict";let t;var i=e.i(66680),r=e.i(2157),n=e.i(50227);e.i(18097);var a=e.i(19e3);let o=[{id:"SUPER_ADMIN",label:"Super Admin",description:"Full system access and administrative control"},{id:"GRC",label:"GRC",description:"Governance, Risk, and Compliance oversight"},{id:"HR",label:"HR",description:"Human Resources operations and employee lifecycle"},{id:"EA",label:"EA",description:"Executive assistance and department coordination"},{id:"EMPLOYEE_L1",label:"Employee (L1)",description:"Can access and update limited personal profile details"},{id:"EMPLOYEE_L2",label:"Employee (L2)",description:"Can access and update limited personal profile details"},{id:"EMPLOYEE_L3",label:"Employee (L3)",description:"Can access and update limited personal profile details"}];e.s(["MODULE_ACCESS",0,{SUPER_ADMIN:["dashboard","activity-log","user-management","settings"],GRC:["dashboard","employees","employment-lifecycle","attendance","performance","documents","activity-log","exports","user-management","retention-archive","incident-management","settings"],HR:["dashboard","employees","employment-lifecycle","attendance","performance","documents","exports","settings"],EA:["dashboard","employees","employment-lifecycle","attendance","performance","documents","exports","settings"],EMPLOYEE_L1:["dashboard","employees","attendance","performance","documents","settings"],EMPLOYEE_L2:["dashboard","employees","attendance","performance","documents","settings"],EMPLOYEE_L3:["dashboard","employees","attendance","performance","documents","settings"]},"ROLES",0,o],28221);let s="https://oauth2.googleapis.com/token",l={token:"",expiresAtMs:0,cacheKey:""};function u(e){return String(process.env[e]||"").trim()}function d(e){return Buffer.from(JSON.stringify(e),"utf8").toString("base64url")}async function c(e){let t=`${e.projectId}:${e.clientEmail}`,r=Date.now();if(l.token&&l.cacheKey===t&&r<l.expiresAtMs-6e4)return l.token;let n=new URLSearchParams({grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:function({clientEmail:e,privateKey:t}){let r=Math.floor(Date.now()/1e3),n=d({alg:"RS256",typ:"JWT"}),a=d({iss:e,scope:"https://www.googleapis.com/auth/identitytoolkit",aud:s,iat:r,exp:r+3600}),o=`${n}.${a}`,l=(0,i.createSign)("RSA-SHA256");l.update(o),l.end();let u=l.sign(t,"base64url");return`${o}.${u}`}(e)}),a=await fetch(s,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n,cache:"no-store"}),o=await a.json().catch(()=>({}));if(!a.ok||!o?.access_token)throw Error("firebase_admin_access_token_failed");let u=Number.parseInt(String(o.expires_in||"3600"),10)||3600;return(l={token:String(o.access_token),expiresAtMs:r+1e3*u,cacheKey:t}).token}async function f(e,t,i,r){let n=await fetch(`https://identitytoolkit.googleapis.com/v1/projects/${encodeURIComponent(e.projectId)}/${i}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(r||{}),cache:"no-store"}),a=await n.json().catch(()=>({}));if(!n.ok){let e;throw Error((e=String(a?.error?.message||"").trim())?"EMAIL_NOT_FOUND"===e||"USER_NOT_FOUND"===e?"firebase_user_not_found":"INVALID_CUSTOM_ATTRIBUTES"===e?"invalid_custom_claims_payload":"INSUFFICIENT_PERMISSION"===e?"firebase_admin_permission_denied":"PROJECT_NOT_FOUND"===e?"firebase_project_not_found":"firebase_identity_toolkit_request_failed":"firebase_identity_toolkit_request_failed")}return a}function p(e){return String(e||"").trim().toLowerCase()}function v(e){return String(e||"").trim().toUpperCase()}async function h({config:e,accessToken:t,uid:i,email:r}){let n=String(i||"").trim(),a=p(r);if(n){let i=await f(e,t,"accounts:lookup",{localId:[n]}),r=Array.isArray(i?.users)?i.users[0]:null;if(r)return r}if(a)try{let i=await f(e,t,"accounts:lookup",{email:[a]}),r=Array.isArray(i?.users)?i.users[0]:null;if(r)return r}catch(e){if("firebase_user_not_found"===String(e?.message||""))return null;throw e}return null}async function m({uid:e,email:t,role:i,status:r,sessionVersion:n,allowMissingUser:a=!0,strict:o}={}){let s,l,d,_=(s=u("FIREBASE_ADMIN_PROJECT_ID")||u("NEXT_PUBLIC_FIREBASE_PROJECT_ID"),l=u("FIREBASE_ADMIN_CLIENT_EMAIL"),d=String(u("FIREBASE_ADMIN_PRIVATE_KEY")||"").replace(/\\n/g,"\n").trim(),s&&l&&d?{projectId:s,clientEmail:l,privateKey:d}:null),A="boolean"==typeof o?o:function(e,t=!1){let i=u(e).toLowerCase();return i?"true"===i||"1"===i||"yes"===i:t}("CLIO_REQUIRE_FIREBASE_CUSTOM_CLAIMS",!0);if(!_){if(A)throw Error("firebase_custom_claims_not_configured");return{ok:!1,reason:"firebase_custom_claims_not_configured",uid:"",email:p(t)}}let w=await c(_),g=await h({config:_,accessToken:w,uid:e,email:t});if(!g){if(a)return{ok:!1,reason:"firebase_user_not_found",uid:String(e||"").trim(),email:p(t)};throw Error("firebase_user_not_found")}let E=String(g.localId||"").trim(),y=p(t)||p(g.email);if(!E||!y)throw Error("firebase_user_not_found");let S={...function(e){if(!e)return{};try{let t=JSON.parse(String(e||""));if(t&&"object"==typeof t&&!Array.isArray(t))return t}catch{}return{}}(g.customAttributes),...function({role:e,email:t,status:i,sessionVersion:r}){let n,a={role:v(e)||"EMPLOYEE_L1",clioRole:v(e)||"EMPLOYEE_L1",clioEmail:p(t)||"",clioStatus:String(i||"").trim().toLowerCase()||"pending",clioSessionVersion:!Number.isFinite(n=Number.parseInt(String(r??""),10))||n<1?1:n};if(JSON.stringify(a).length>1e3)throw Error("invalid_custom_claims_payload");return a}({role:i,email:y,status:r,sessionVersion:n})},x=JSON.stringify(S);if(x.length>1e3)throw Error("invalid_custom_claims_payload");return await f(_,w,"accounts:update",{localId:E,customAttributes:x}),{ok:!0,reason:"synced",uid:E,email:y,claims:S}}e.s(["syncFirebaseCustomClaimsForUser",()=>m],11655);var _=e.i(67658);let A=n.default.join(process.cwd(),"data"),w=n.default.join(A,"user-accounts.json"),g=new Set(["pending","active","disabled"]),E=new Set(["sent","otp_sent","verified","revoked","expired"]),y=new Set(o.map(e=>e.id)),S="EMPLOYEE_L1",x=new Set(["superadmin@clio.local","temp.admin@clio.local","hr@clio.local","grc@clio.local","ea@clio.local"]);function b(){return new Date().toISOString()}function L(e){if("string"!=typeof e)return"";let t=new Date(e);return Number.isNaN(t.getTime())?"":t.toISOString()}function M({archivedAt:e,retentionDeleteAt:t}){let i,r=L(t);if(r)return r;var n=!Number.isFinite(i=Number.parseInt(String(process.env.CLIO_RETENTION_YEARS||"").trim(),10))||i<1?5:Math.min(i,25);let a=new Date(e);if(Number.isNaN(a.getTime())){let e=new Date;return e.setUTCFullYear(e.getUTCFullYear()+n),e.toISOString()}return a.setUTCFullYear(a.getUTCFullYear()+n),a.toISOString()}function D(e){return`${e}-${Date.now()}-${Math.random().toString(36).slice(2,8).toUpperCase()}`}function k(){return(0,i.randomBytes)(20).toString("hex")}function I(e){return String(e||"").trim().toLowerCase()}function C(e,t=1){let i=Number.parseInt(String(e??""),10);return!Number.isFinite(i)||i<1?t:i}function N(e){return x.has(I(e))}function O(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(I(e))}function R(e,{allowEmpty:t=!0}={}){let i=String(e||"").trim().replace(/\s+/g," ");if(!i)return t?"":null;if(i.length>80)throw Error("invalid_name");return i}function H(e){if(null==e||""===e)return null;let t=String(e).trim();if(!t)return null;if(/^data:image\/(png|jpeg|jpg|webp);base64,/i.test(t)){if(t.length>15e5)throw Error("invalid_profile_photo");return t}if(!/^https?:\/\/[^\s]+$/i.test(t)||t.length>2048)throw Error("invalid_profile_photo");return t}function V(e){if(null==e||""===e)return null;let t=String(e).trim().replace(/^\/+/,"");if(!t)return null;if(t.length>512||t.includes("..")||t.includes("\\")||!/^clio\/[a-z0-9/_\-.\s]+$/i.test(t))throw Error("invalid_storage_path");return t}function T(e,t,{min:i,max:r}={}){let n=Number.parseInt(String(process.env[e]||"").trim(),10);return Number.isFinite(n)?Number.isFinite(i)&&n<i?i:Number.isFinite(r)&&n>r?r:n:t}function U(){return new Date(Date.now()+24*T("CLIO_INVITE_EXPIRATION_DAYS",7,{min:1,max:90})*36e5).toISOString()}function P(){return T("CLIO_SMS_OTP_TTL_SECONDS",300,{min:60,max:900})}function F(){return T("CLIO_SMS_OTP_MAX_ATTEMPTS",5,{min:1,max:10})}function B(){return T("CLIO_SMS_OTP_RESEND_COOLDOWN_SECONDS",60,{min:15,max:300})}function $(){return T("CLIO_LOGIN_MFA_CHALLENGE_TTL_SECONDS",600,{min:120,max:1800})}function q(e){let t=String(e||"").trim();if(!t)return"";let i=t.replace(/[()\s-]/g,"");if(i.startsWith("00")&&(i=`+${i.slice(2)}`),i.startsWith("+"))i=`+${i.slice(1).replace(/\D/g,"")}`;else{let e=String(process.env.CLIO_SMS_DEFAULT_COUNTRY_CODE||"+63").trim().replace(/[^\d+]/g,""),t=e.startsWith("+")?e:`+${e}`,r=i.replace(/\D/g,"");i=`${t}${r}`}return/^\+\d{10,15}$/.test(i)?i:""}function Y(e){let t=q(e);if(!t)return"";let i=t.slice(-4);return`***-***-${i}`}function j(e){let t=q(e);return t?t.slice(-4):""}function J(e,t){return(0,i.createHmac)("sha256",function(){let e=String(process.env.CLIO_SMS_OTP_SECRET||"").trim();if(e)return e;let t=String(process.env.CLIO_SESSION_SECRET||"").trim();if(t)return t;throw Error("sms_otp_secret_required")}()).update(`${e}:${t}`).digest("hex")}function G({token:e,code:t}){return J("otp",`${e}:${String(t||"").trim()}`)}function W(e){return J("phone",q(e))}function z(e){let t=String(e?.deviceId||"").trim();if(!t)return null;let i=L(e?.firstSeenAt)||b(),r=L(e?.lastSeenAt)||i,n=String(e?.label||"").trim()||"Unknown device",a=String(e?.userAgent||"").trim()||"unknown",o=String(e?.lastIp||"").trim()||"unknown",s=!!e?.trusted;return{deviceId:t,label:n,userAgent:a,lastIp:o,firstSeenAt:i,lastSeenAt:r,trusted:s,deniedAt:L(e?.deniedAt)||null,deniedReason:"string"==typeof e?.deniedReason?e.deniedReason:null}}function K(e){return(Array.isArray(e)?e:[]).map(z).filter(Boolean).sort((e,t)=>new Date(t.lastSeenAt||0).getTime()-new Date(e.lastSeenAt||0).getTime()).slice(0,12)}function X(e){return/^\d{6}$/.test(String(e||"").trim())}function Q(){return String((0,i.randomInt)(0,1e6)).padStart(6,"0")}function Z(e,t){let r=Buffer.from(String(e||""),"utf8"),n=Buffer.from(String(t||""),"utf8");return r.length===n.length&&(0,i.timingSafeEqual)(r,n)}function ee(e){let t=String(e||"").trim().toLowerCase();return/^[a-f0-9]{24,128}$/.test(t)?t:""}function et(e,t=[]){return"string"!=typeof e||0===e.trim().length?t.map(I).filter(Boolean):e.split(",").map(I).filter(Boolean)}function ei(e){let t,i=String(e||"").trim().toUpperCase();return i?"EMPLOYEE"===i?S:y.has(i)?"EMPLOYEE"===(t=String(i||"").trim().toUpperCase())||t.startsWith("EMPLOYEE_")?S:i:"":""}function er(e,t="HR"){let i=ei(e);return i||ei(t)||"HR"}function en(){return[{role:"SUPER_ADMIN",emails:et(process.env.SUPER_ADMIN_EMAILS,[])},{role:"HR",emails:et(process.env.HR_EMAILS,[])},{role:"GRC",emails:et(process.env.GRC_EMAILS,[])},{role:"EA",emails:et(process.env.EA_EMAILS,[])},{role:"EMPLOYEE_L1",emails:et(process.env.EMPLOYEE_L1_EMAILS,[])},{role:"EMPLOYEE_L2",emails:et(process.env.EMPLOYEE_L2_EMAILS,[])},{role:"EMPLOYEE_L3",emails:et(process.env.EMPLOYEE_L3_EMAILS,[])}].flatMap(e=>e.emails.map(t=>({email:t,role:ei(e.role)||e.role})))}function ea(e){let t=I(e?.email);if(!O(t))return null;let i=er(e?.role,"HR"),r=g.has(e?.status)?e.status:"pending",n="string"==typeof e?.invitedAt?e.invitedAt:b(),a="string"==typeof e?.updatedAt?e.updatedAt:n,o=L(e?.archivedAt),s=M({archivedAt:o||n,retentionDeleteAt:e?.retentionDeleteAt}),l=I(e?.archivedBy)||null,u="string"==typeof e?.archiveReason?e.archiveReason:null,d="",c="",f="",p=null,v=null;try{d=R(e?.firstName),c=R(e?.middleName),f=R(e?.lastName)}catch{d="",c="",f=""}try{p=H(e?.profilePhotoDataUrl)}catch{p=null}try{v=V(e?.profilePhotoStoragePath)}catch{v=null}let h=e?.loginMfa&&"object"==typeof e.loginMfa?e.loginMfa:null,m="string"==typeof h?.challengeTokenHash?h.challengeTokenHash:null,_=L(h?.challengeExpiresAt),A=m?{challengeTokenHash:m,challengeExpiresAt:_||null,phoneMasked:"string"==typeof h?.phoneMasked?h.phoneMasked:null,phoneLast4:"string"==typeof h?.phoneLast4?h.phoneLast4:null,phoneHash:"string"==typeof h?.phoneHash?h.phoneHash:null,otpHash:"string"==typeof h?.otpHash?h.otpHash:null,otpExpiresAt:L(h?.otpExpiresAt)||null,otpRequestedAt:L(h?.otpRequestedAt)||null,otpAttemptCount:Number.isFinite(h?.otpAttemptCount)?Math.max(0,h.otpAttemptCount):0,otpMaxAttempts:Number.isFinite(h?.otpMaxAttempts)?Math.max(1,h.otpMaxAttempts):F(),resendAvailableAt:L(h?.resendAvailableAt)||null,updatedAt:L(h?.updatedAt)||null}:null,w=K(e?.knownDevices);return{id:"string"==typeof e?.id&&e.id.trim().length>0?e.id:t,email:t,role:i,status:r,sessionVersion:C(e?.sessionVersion,1),invitedBy:I(e?.invitedBy)||"system.clio@gmail.com",invitedAt:n,activatedAt:"string"==typeof e?.activatedAt?e.activatedAt:null,emailVerifiedAt:"string"==typeof e?.emailVerifiedAt?e.emailVerifiedAt:null,lastLoginAt:"string"==typeof e?.lastLoginAt?e.lastLoginAt:null,phoneVerifiedAt:"string"==typeof e?.phoneVerifiedAt?e.phoneVerifiedAt:null,phoneLast4:"string"==typeof e?.phoneLast4?e.phoneLast4:null,phoneHash:"string"==typeof e?.phoneHash?e.phoneHash:null,smsMfaEnabled:function(e,t=!1){if("boolean"==typeof e)return e;let i=String(e||"").trim().toLowerCase();return i?"true"===i||"1"===i||"yes"===i:t}(e?.smsMfaEnabled,!1),verificationMethod:["sms","email"].includes(e?.verificationMethod)?e.verificationMethod:null,archivedAt:o||null,archivedBy:l,archiveReason:u,isArchived:!!(e?.isArchived||o),retentionDeleteAt:o?s:L(e?.retentionDeleteAt)||null,firstName:d,middleName:c,lastName:f,profilePhotoDataUrl:p,profilePhotoStoragePath:v,profileUpdatedAt:"string"==typeof e?.profileUpdatedAt?e.profileUpdatedAt:null,knownDevices:w,loginMfa:A,updatedAt:a,source:e?.source==="bootstrap"?"bootstrap":"invite"}}async function eo(e,{allowMissingUser:t=!0,strict:i=!1}={}){if(!e||"object"!=typeof e)return{ok:!1,reason:"invalid_user_payload",email:""};let r=I(e.email);if(!r)return{ok:!1,reason:"invalid_user_email",email:""};try{return await m({email:r,role:er(e.role,"HR"),status:String(e.status||"").trim().toLowerCase()||"pending",sessionVersion:C(e.sessionVersion,1),allowMissingUser:t,strict:i})}catch(e){if(i)throw e;return{ok:!1,reason:e instanceof Error?e.message:"firebase_claims_sync_failed",email:r}}}function es(e){let t=I(e?.email);if(!O(t))return null;let i=er(e?.role,"HR"),r="string"==typeof e?.invitedAt?e.invitedAt:b(),n="string"==typeof e?.expiresAt?e.expiresAt:U(),a=E.has(e?.status)?e.status:"sent",o="string"==typeof e?.verification?.phoneMasked?e.verification.phoneMasked:null,s="string"==typeof e?.verification?.phoneLast4?e.verification.phoneLast4:null,l="string"==typeof e?.verification?.otpHash?e.verification.otpHash:null,u="string"==typeof e?.verification?.otpExpiresAt?e.verification.otpExpiresAt:null,d="string"==typeof e?.verification?.otpRequestedAt?e.verification.otpRequestedAt:null,c=Number.isFinite(e?.verification?.otpAttemptCount)?Math.max(0,e.verification.otpAttemptCount):0,f=Number.isFinite(e?.verification?.otpMaxAttempts)?Math.max(1,e.verification.otpMaxAttempts):F(),p="string"==typeof e?.verification?.resendAvailableAt?e.verification.resendAvailableAt:null,v="string"==typeof e?.verification?.verifiedAt?e.verification.verifiedAt:null,h="string"==typeof e?.verification?.phoneHash?e.verification.phoneHash:null,m="string"==typeof e?.createdAt?e.createdAt:r,_="string"==typeof e?.updatedAt?e.updatedAt:r;return{id:"string"==typeof e?.id&&e.id.trim().length>0?e.id:D("INV"),email:t,role:i,invitedBy:I(e?.invitedBy)||"system.clio@gmail.com",invitedAt:r,expiresAt:n,token:"string"==typeof e?.token&&e.token.trim().length>0?e.token:k(),status:a,createdAt:m,updatedAt:_,verification:{phoneMasked:o,phoneLast4:s,phoneHash:h,otpHash:l,otpExpiresAt:u,otpRequestedAt:d,otpAttemptCount:c,otpMaxAttempts:f,resendAvailableAt:p,verifiedAt:v}}}function el(e){let t=Array.isArray(e?.users)?e.users:[],i=Array.isArray(e?.invites)?e.invites:[],r=new Map;return t.map(ea).filter(Boolean).forEach(e=>{r.has(e.email)||r.set(e.email,e)}),{users:Array.from(r.values()),invites:i.map(es).filter(Boolean)}}function eu(e){let t={users:[...e.users],invites:[...e.invites]},i=new Set(t.users.map(e=>e.email)),r=b(),n=!1;for(let e of en())i.has(e.email)||(t.users.push({id:e.email,email:e.email,role:e.role,status:"active",sessionVersion:1,invitedBy:"system.clio@gmail.com",invitedAt:r,activatedAt:r,emailVerifiedAt:r,lastLoginAt:null,phoneVerifiedAt:r,phoneLast4:null,phoneHash:null,verificationMethod:"email",updatedAt:r,source:"bootstrap"}),i.add(e.email),n=!0);return{store:t,changed:n}}function ed(e){let t=e.users.filter(e=>!N(e?.email)),i=e.invites.filter(e=>!N(e?.email)),r=t.length!==e.users.length||i.length!==e.invites.length;return{store:{users:t,invites:i},changed:r}}function ec(e){return[...e].sort((e,t)=>{let i=new Date(e.updatedAt||e.invitedAt).getTime();return new Date(t.updatedAt||t.invitedAt).getTime()-i})}function ef(e){return{id:e.id,email:e.email,role:e.role,status:e.status,sessionVersion:C(e?.sessionVersion,1),invitedBy:e.invitedBy,invitedAt:e.invitedAt,activatedAt:e.activatedAt,emailVerifiedAt:e.emailVerifiedAt,lastLoginAt:e.lastLoginAt,phoneVerifiedAt:e.phoneVerifiedAt,phoneLast4:e.phoneLast4,smsMfaEnabled:!!e?.smsMfaEnabled,verificationMethod:e.verificationMethod,archivedAt:e.archivedAt||null,archivedBy:e.archivedBy||null,archiveReason:e.archiveReason||null,isArchived:!!(e.isArchived||e.archivedAt),retentionDeleteAt:e.retentionDeleteAt||null,firstName:e.firstName||"",middleName:e.middleName||"",lastName:e.lastName||"",profilePhotoDataUrl:e.profilePhotoDataUrl||null,profilePhotoStoragePath:e.profilePhotoStoragePath||null,profileUpdatedAt:e.profileUpdatedAt||null,updatedAt:e.updatedAt,source:e.source}}function ep(){return String(process.env.CLIO_FIRESTORE_USERS_COLLECTION||"clio_users").trim()||"clio_users"}function ev(){return String(process.env.CLIO_FIRESTORE_INVITES_COLLECTION||"clio_user_invites").trim()||"clio_user_invites"}async function eh(){return(0,_.isFirestoreEnabled)()?(0,_.getFirestoreDb)():null}function em(e,t="user_accounts"){let i=Error("firestore_operation_failed");throw i.cause=e,i.operation=t,i.firestoreReason=e instanceof Error?e.message:"unknown_firestore_error",i}function e_(e,t){return ea({id:e,...t})}async function eA(e){let t=ep(),i=b();for(let r of en()){let n=I(r.email);if(!n)continue;let o=(0,a.doc)(e,t,n);(await (0,a.getDoc)(o)).exists()||await (0,a.setDoc)(o,{id:n,email:n,role:r.role,status:"active",sessionVersion:1,invitedBy:"system.clio@gmail.com",invitedAt:i,activatedAt:i,emailVerifiedAt:i,lastLoginAt:null,phoneVerifiedAt:i,phoneLast4:null,phoneHash:null,verificationMethod:"email",updatedAt:i,source:"bootstrap"})}}async function ew(e){let t=ep(),i=ev(),r=Array.from(x);for(let i of r)try{let r=(0,a.doc)(e,t,i);(await (0,a.getDoc)(r)).exists()&&await (0,a.deleteDoc)(r)}catch{}try{let t=(0,a.query)((0,a.collection)(e,i),(0,a.where)("email","in",r),(0,a.limit)(20));for(let r of(await (0,a.getDocs)(t)).docs){let t=r.data()||{},n=I(t.email);x.has(n)&&await (0,a.deleteDoc)((0,a.doc)(e,i,r.id))}}catch{}}async function eg(e){await ew(e),await eA(e)}async function eE(e){return await eg(e),ec((await (0,a.getDocs)((0,a.collection)(e,ep()))).docs.map(e=>e_(e.id,e.data())).filter(Boolean).filter(e=>!N(e.email)).map(ef))}async function ey(e,t){if(N(t))return null;await eg(e);let i=(0,a.doc)(e,ep(),t),r=await (0,a.getDoc)(i);if(!r.exists())return null;let n=e_(r.id,r.data());return n?ef(n):null}async function eS(e,t){let i=(0,a.doc)(e,ep(),t),r=await (0,a.getDoc)(i);if(!r.exists())return null;let n=b();await (0,a.updateDoc)(i,{lastLoginAt:n,updatedAt:n});let o=e_(r.id,{...r.data(),lastLoginAt:n,updatedAt:n});return o?ef(o):null}async function ex(e,{userId:t}){let i=String(t||"").trim().toLowerCase();if(!i)throw Error("invalid_user");let r=(0,a.doc)(e,ep(),i),n=await (0,a.getDoc)(r);if(!n.exists())return null;let o=n.data()||{},s={sessionVersion:C(o?.sessionVersion,1)+1,updatedAt:b()};await (0,a.updateDoc)(r,s);let l=e_(n.id,{...o,...s});return l?ef(l):null}async function eb(e,{email:t,role:i,invitedBy:r}){let n=I(t);if(!O(n))throw Error("invalid_email");let o=ei(i);if(!o)throw Error("invalid_role");let s=I(r)||"superadmin.clio@gmail.com",l=b(),u=(0,a.doc)(e,ep(),n),d=await (0,a.getDoc)(u),c=d.exists()?d.data():{},f=d.exists()?C(c?.sessionVersion,1)+1:1,p=ea({...c,id:n,email:n,role:o,status:"pending",sessionVersion:f,invitedBy:s,invitedAt:l,emailVerifiedAt:null,phoneVerifiedAt:null,phoneLast4:null,phoneHash:null,verificationMethod:null,updatedAt:l,source:c?.source==="bootstrap"?"bootstrap":"invite"});for(let t of(await (0,a.setDoc)(u,p),(await (0,a.getDocs)((0,a.query)((0,a.collection)(e,ev()),(0,a.where)("email","==",n)))).docs)){let i=t.data()||{};["sent","otp_sent","expired"].includes(i?.status)&&await (0,a.updateDoc)((0,a.doc)(e,ev(),t.id),{status:"revoked",updatedAt:l})}let v={email:n,role:o,invitedBy:s,invitedAt:l,expiresAt:U(),token:k(),status:"sent",createdAt:l,updatedAt:l,verification:{phoneMasked:null,phoneLast4:null,phoneHash:null,otpHash:null,otpExpiresAt:null,otpRequestedAt:null,otpAttemptCount:0,otpMaxAttempts:F(),resendAvailableAt:null,verifiedAt:null}},h=await (0,a.addDoc)((0,a.collection)(e,ev()),v);return{user:ef(p),invite:{id:h.id,email:v.email,role:v.role,invitedBy:v.invitedBy,invitedAt:v.invitedAt,expiresAt:v.expiresAt,status:v.status,token:v.token}}}async function eL(e,{userId:t,status:i}){let r=String(i||"").trim().toLowerCase();if(!g.has(r))throw Error("invalid_status");let n=String(t||"").trim().toLowerCase();if(!n)throw Error("invalid_user");let o=(0,a.doc)(e,ep(),n),s=await (0,a.getDoc)(o);if(!s.exists())return null;let l=s.data()||{},u=String(l?.status||"").trim().toLowerCase(),d=C(l?.sessionVersion,1),c=b(),f={status:r,sessionVersion:r!==u?d+1:d,updatedAt:c};"active"!==r||l?.activatedAt||(f.activatedAt=c),await (0,a.updateDoc)(o,f);let p=e_(s.id,{...l,...f});return p?ef(p):null}async function eM(e,{userId:t,role:i}){let r=ei(i);if(!r)throw Error("invalid_role");let n=String(t||"").trim().toLowerCase();if(!n)throw Error("invalid_user");let o=(0,a.doc)(e,ep(),n),s=await (0,a.getDoc)(o);if(!s.exists())return null;let l=s.data()||{},u=er(l?.role,"HR"),d=C(l?.sessionVersion,1),c={role:r,sessionVersion:r!==u?d+1:d,updatedAt:b()};await (0,a.updateDoc)(o,c);let f=e_(s.id,{...l,...c});return f?ef(f):null}async function eD(e,{userId:t,archivedBy:i,reason:r,retentionDeleteAt:n}){let o=String(t||"").trim().toLowerCase();if(!o)throw Error("invalid_user");let s=(0,a.doc)(e,ep(),o),l=await (0,a.getDoc)(s);if(!l.exists())return null;let u=l.data()||{},d=String(u?.status||"").trim().toLowerCase(),c=C(u?.sessionVersion,1),f=b(),p={status:"disabled",archivedAt:f,archivedBy:I(i)||"system.clio@gmail.com",archiveReason:String(r||"").trim()||"Resigned",isArchived:!0,retentionDeleteAt:M({archivedAt:f,retentionDeleteAt:n}),sessionVersion:"disabled"!==d?c+1:c,updatedAt:f};await (0,a.updateDoc)(s,p);let v=e_(l.id,{...u,...p});return v?ef(v):null}async function ek(e,{userId:t,firstName:i,middleName:r,lastName:n,profilePhotoDataUrl:o,profilePhotoStoragePath:s,smsMfaEnabled:l}){let u=String(t||"").trim().toLowerCase();if(!u)throw Error("invalid_user");let d=(0,a.doc)(e,ep(),u),c=await (0,a.getDoc)(d);if(!c.exists())return null;let f=e_(c.id,c.data());if(!f)return null;let p=b(),v="boolean"==typeof l;if(v&&l&&!f.phoneVerifiedAt)throw Error("mfa_phone_not_verified");let h={firstName:R(i),middleName:R(r),lastName:R(n),profilePhotoDataUrl:H(o),profilePhotoStoragePath:V(s),profileUpdatedAt:p,updatedAt:p};v&&(h.smsMfaEnabled=l,l||(h.loginMfa=null)),await (0,a.updateDoc)(d,h);let m=e_(c.id,{...c.data(),...h});return m?ef(m):null}async function eI(e){await r.promises.writeFile(w,`${JSON.stringify(e,null,2)}
`,"utf8")}async function eC(){let e=await r.promises.readFile(w,"utf8").catch(()=>"");if(!e.trim())return{users:[],invites:[]};try{return JSON.parse(e)}catch{return{users:[],invites:[]}}}async function eN(){return t||(t=(async()=>{await r.promises.mkdir(A,{recursive:!0});let{store:e}=ed(el(await eC())),{store:t}=eu(e);await eI(t)})()),t}async function eO(){await eN();let{store:e,changed:t}=ed(el(await eC())),{store:i,changed:r}=eu(e);return(t||r)&&await eI(i),i}async function eR(){return ec((await eO()).users).filter(e=>!N(e.email)).map(ef)}async function eH(e){let t=I(e);if(!t||N(t))return null;let i=(await eO()).users.find(e=>e.email===t);return i?ef(i):null}async function eV(e){let t=I(e);if(!t)return null;let i=await eO(),r=i.users.find(e=>e.email===t);if(!r)return null;let n=b();return r.lastLoginAt=n,r.updatedAt=n,await eI(i),ef(r)}async function eT({email:e,device:t}){let i=I(e);if(!i)return null;let r=await eO(),n=r.users.find(e=>e.email===i);if(!n)return null;let a=b(),o=z({...t,firstSeenAt:a,lastSeenAt:a});if(!o)return null;let s=K(n.knownDevices),l=s.findIndex(e=>e.deviceId===o.deviceId),u=l>=0?{...s[l],label:o.label||s[l].label,userAgent:o.userAgent||s[l].userAgent,lastIp:o.lastIp||s[l].lastIp,lastSeenAt:a}:o,d=[...s];return l>=0?d.splice(l,1,u):d.push(u),n.knownDevices=K(d),n.updatedAt=a,await eI(r),{isNew:l<0,device:u}}async function eU(e,{email:t,deviceId:i,trusted:r,deniedReason:n}){let o=(0,a.doc)(e,ep(),t),s=await (0,a.getDoc)(o);if(!s.exists())return null;let l=e_(s.id,s.data());if(!l)return null;let u=K(l.knownDevices),d=u.findIndex(e=>e.deviceId===i);if(d<0)return null;let c=b(),f={...u[d],trusted:!!r,deniedAt:r?null:c,deniedReason:r?null:n||"user_reported",lastSeenAt:c},p=[...u];p.splice(d,1,f);let v=K(p);return await (0,a.updateDoc)(o,{knownDevices:v,updatedAt:c}),f}async function eP({email:e,deviceId:t,trusted:i,deniedReason:r}){let n=I(e);if(!n)return null;let a=await eO(),o=a.users.find(e=>e.email===n);if(!o)return null;let s=K(o.knownDevices),l=s.findIndex(e=>e.deviceId===t);if(l<0)return null;let u=b(),d={...s[l],trusted:!!i,deniedAt:i?null:u,deniedReason:i?null:r||"user_reported",lastSeenAt:u},c=[...s];return c.splice(l,1,d),o.knownDevices=K(c),o.updatedAt=u,await eI(a),d}async function eF({userId:e}){let t=String(e||"").trim().toLowerCase();if(!t)throw Error("invalid_user");let i=await eO(),r=i.users.find(e=>e.id===t||e.email===t);if(!r)return null;let n=C(r.sessionVersion,1);return r.sessionVersion=n+1,r.updatedAt=b(),await eI(i),ef(r)}async function eB({email:e,role:t,invitedBy:i}){let r=I(e);if(!O(r))throw Error("invalid_email");let n=ei(t);if(!n)throw Error("invalid_role");let a=await eO(),o=b(),s=I(i)||"superadmin.clio@gmail.com";for(let e of a.invites)e.email===r&&["sent","otp_sent","expired"].includes(e.status)&&(e.status="revoked",e.updatedAt=o);let l=a.users.find(e=>e.email===r);if(l){let e=C(l.sessionVersion,1);l.role=n,l.status="pending",l.sessionVersion=e+1,l.invitedBy=s,l.invitedAt=o,l.emailVerifiedAt=null,l.phoneVerifiedAt=null,l.phoneLast4=null,l.phoneHash=null,l.verificationMethod=null,l.updatedAt=o,"bootstrap"!==l.source&&(l.source="invite")}else l={id:r,email:r,role:n,status:"pending",sessionVersion:1,invitedBy:s,invitedAt:o,activatedAt:null,emailVerifiedAt:null,lastLoginAt:null,phoneVerifiedAt:null,phoneLast4:null,phoneHash:null,verificationMethod:null,updatedAt:o,source:"invite"},a.users.push(l);let u=U(),d={id:D("INV"),email:r,role:n,invitedBy:s,invitedAt:o,expiresAt:u,token:k(),status:"sent",createdAt:o,updatedAt:o,verification:{phoneMasked:null,phoneLast4:null,phoneHash:null,otpHash:null,otpExpiresAt:null,otpRequestedAt:null,otpAttemptCount:0,otpMaxAttempts:F(),resendAvailableAt:null,verifiedAt:null}};return a.invites.unshift(d),a.invites.length>500&&(a.invites.length=500),await eI(a),{user:ef(l),invite:{id:d.id,email:d.email,role:d.role,invitedBy:d.invitedBy,invitedAt:d.invitedAt,expiresAt:d.expiresAt,status:d.status,token:d.token}}}async function e$({userId:e,status:t}){let i=String(t||"").trim().toLowerCase();if(!g.has(i))throw Error("invalid_status");let r=String(e||"").trim().toLowerCase();if(!r)throw Error("invalid_user");let n=await eO(),a=n.users.find(e=>e.id===r||e.email===r);if(!a)return null;let o=b(),s=String(a.status||"").trim().toLowerCase(),l=C(a.sessionVersion,1);return a.status=i,a.sessionVersion=i!==s?l+1:l,a.updatedAt=o,"active"!==i||a.activatedAt||(a.activatedAt=o),await eI(n),ef(a)}async function eq({userId:e,role:t}){let i=ei(t);if(!i)throw Error("invalid_role");let r=String(e||"").trim().toLowerCase();if(!r)throw Error("invalid_user");let n=await eO(),a=n.users.find(e=>e.id===r||e.email===r);if(!a)return null;let o=er(a.role,"HR"),s=C(a.sessionVersion,1);return a.role=i,a.sessionVersion=i!==o?s+1:s,a.updatedAt=b(),await eI(n),ef(a)}async function eY({userId:e,archivedBy:t,reason:i,retentionDeleteAt:r}){let n=String(e||"").trim().toLowerCase();if(!n)throw Error("invalid_user");let a=await eO(),o=a.users.find(e=>e.id===n||e.email===n);if(!o)return null;let s=b(),l=String(o.status||"").trim().toLowerCase(),u=C(o.sessionVersion,1);return o.status="disabled",o.archivedAt=s,o.archivedBy=I(t)||"system.clio@gmail.com",o.archiveReason=String(i||"").trim()||"Resigned",o.isArchived=!0,o.retentionDeleteAt=M({archivedAt:s,retentionDeleteAt:r}),o.sessionVersion="disabled"!==l?u+1:u,o.updatedAt=s,await eI(a),ef(o)}async function ej({userId:e,firstName:t,middleName:i,lastName:r,profilePhotoDataUrl:n,profilePhotoStoragePath:a,smsMfaEnabled:o}){let s=String(e||"").trim().toLowerCase();if(!s)throw Error("invalid_user");let l=await eO(),u=l.users.find(e=>e.id===s||e.email===s);if(!u)return null;let d="boolean"==typeof o;if(d&&o&&!u.phoneVerifiedAt)throw Error("mfa_phone_not_verified");return u.firstName=R(t),u.middleName=R(i),u.lastName=R(r),u.profilePhotoDataUrl=H(n),u.profilePhotoStoragePath=V(a),d&&(u.smsMfaEnabled=o,o||(u.loginMfa=null)),u.profileUpdatedAt=b(),u.updatedAt=u.profileUpdatedAt,await eI(l),ef(u)}async function eJ(e,{now:t}){let i=L(t)||b(),r=(0,a.collection)(e,ep()),n=await (0,a.getDocs)((0,a.query)(r,(0,a.where)("retentionDeleteAt","<=",i))),o=0,s=0,l=[];for(let t of n.docs){let i=t.data()||{};if(!L(i.archivedAt))continue;let r=I(i.email||t.id);if(await (0,a.deleteDoc)((0,a.doc)(e,ep(),t.id)),o+=1,r){l.push(r);let t=(0,a.collection)(e,ev());for(let i of(await (0,a.getDocs)((0,a.query)(t,(0,a.where)("email","==",r)))).docs)await (0,a.deleteDoc)((0,a.doc)(e,ev(),i.id)),s+=1}}return{cutoff:i,deletedUsers:o,deletedInvites:s,deletedEmails:l}}async function eG({now:e}){let t=L(e)||b(),i=await eO(),r=new Set;if(i.users.forEach(e=>{let i=L(e.archivedAt);!i||M({archivedAt:i,retentionDeleteAt:e.retentionDeleteAt})<=t&&r.add(e.email)}),0===r.size)return{cutoff:t,deletedUsers:0,deletedInvites:0,deletedEmails:[]};let n=i.users.length,a=i.invites.length;return i.users=i.users.filter(e=>!r.has(e.email)),i.invites=i.invites.filter(e=>!r.has(e.email)),await eI(i),{cutoff:t,deletedUsers:n-i.users.length,deletedInvites:a-i.invites.length,deletedEmails:Array.from(r.values())}}async function eW(e,t){let i=String(t||"").trim();if(!i)throw Error("invalid_invite");let r=(0,a.doc)(e,ev(),i),n=await (0,a.getDoc)(r);if(!n.exists())return null;let o=b();await (0,a.updateDoc)(r,{status:"revoked",updatedAt:o});let s=es({id:n.id,...n.data(),status:"revoked",updatedAt:o});return s?eX(s):null}async function ez(e){let t=String(e||"").trim();if(!t)throw Error("invalid_invite");let i=await eO(),r=i.invites.find(e=>e.id===t);return r?(r.status="revoked",r.updatedAt=b(),await eI(i),eX(r)):null}function eK(e){let t;return e?"verified"===e.status||"revoked"===e.status||"expired"===e.status?e.status:Number.isFinite(t=new Date(e?.expiresAt).getTime())&&t<=Date.now()?"expired":e.status:"revoked"}function eX(e){let t=eK(e);return{id:e.id,role:e.role,status:t,invitedAt:e.invitedAt,expiresAt:e.expiresAt,emailMasked:function(e){let[t,i]=I(e).split("@");return t&&i?t.length<=2?`**@${i}`:`${t.slice(0,2)}***@${i}`:""}(e.email),phoneMasked:e.verification?.phoneMasked||null,verifiedAt:e.verification?.verifiedAt||null,otpRequestedAt:e.verification?.otpRequestedAt||null,otpExpiresAt:e.verification?.otpExpiresAt||null,resendAvailableAt:e.verification?.resendAvailableAt||null}}async function eQ(e,t){let i=ee(t);if(!i)return null;let r=await (0,a.getDocs)((0,a.query)((0,a.collection)(e,ev()),(0,a.where)("token","==",i),(0,a.limit)(1)));if(r.empty)return null;let n=r.docs[0],o=es({id:n.id,...n.data()});return o?{ref:(0,a.doc)(e,ev(),n.id),invite:o}:null}async function eZ(e){let t=ee(e);if(!t)return null;let i=await eO(),r=i.invites.findIndex(e=>e.token===t);return -1===r?null:{store:i,inviteIndex:r,invite:i.invites[r]}}async function e0(e,t){let i=await eQ(e,t);if(!i)return null;if("expired"===eK(i.invite)&&"expired"!==i.invite.status){let e=b();await (0,a.updateDoc)(i.ref,{status:"expired",updatedAt:e}),i.invite.status="expired",i.invite.updatedAt=e}return eX(i.invite)}async function e1(e){let t=await eZ(e);return t?("expired"===eK(t.invite)&&"expired"!==t.invite.status&&(t.invite.status="expired",t.invite.updatedAt=b(),await eI(t.store)),eX(t.invite)):null}async function e4(e,{token:t,phoneNumber:i}){let r=ee(t);if(!r)throw Error("invalid_invite_token");let n=q(i);if(!n)throw Error("invalid_phone_number");let o=await eQ(e,r);if(!o)throw Error("invite_not_found");let s=eK(o.invite);if("expired"===s){let e=b();throw await (0,a.updateDoc)(o.ref,{status:"expired",updatedAt:e}),Error("invite_expired")}if("revoked"===s)throw Error("invite_revoked");let l=(0,a.doc)(e,ep(),o.invite.email),u=await (0,a.getDoc)(l);if(!u.exists())throw Error("invite_user_not_found");let d=e_(u.id,u.data());if(!d)throw Error("invite_user_not_found");if("disabled"===d.status)throw Error("account_disabled");let c=!!(d.phoneVerifiedAt||"sms"===d.verificationMethod);if("verified"===s&&c)throw Error("invite_already_verified");let f=o.invite.verification?.resendAvailableAt;if(f&&new Date(f).getTime()>Date.now())throw Error("otp_cooldown");let p=b(),v=Q(),h=new Date(Date.now()+1e3*P()).toISOString(),m={phoneMasked:Y(n),phoneLast4:j(n),phoneHash:W(n),otpHash:G({token:r,code:v}),otpExpiresAt:h,otpRequestedAt:p,otpAttemptCount:0,otpMaxAttempts:F(),resendAvailableAt:new Date(Date.now()+1e3*B()).toISOString(),verifiedAt:null};return await (0,a.updateDoc)(o.ref,{status:"otp_sent",updatedAt:p,verification:m}),{invite:eX({...o.invite,status:"otp_sent",updatedAt:p,verification:m}),otpCode:v,phoneNumber:n,otpExpiresAt:h,phoneMasked:m.phoneMasked,resendAvailableAt:m.resendAvailableAt}}async function e2({token:e,phoneNumber:t}){let i=ee(e);if(!i)throw Error("invalid_invite_token");let r=q(t);if(!r)throw Error("invalid_phone_number");let n=await eZ(i);if(!n)throw Error("invite_not_found");let a=eK(n.invite);if("expired"===a)throw n.invite.status="expired",n.invite.updatedAt=b(),await eI(n.store),Error("invite_expired");if("revoked"===a)throw Error("invite_revoked");let o=n.store.users.find(e=>e.email===n.invite.email);if(!o)throw Error("invite_user_not_found");if("disabled"===o.status)throw Error("account_disabled");let s=!!(o.phoneVerifiedAt||"sms"===o.verificationMethod);if("verified"===a&&s)throw Error("invite_already_verified");let l=n.invite.verification?.resendAvailableAt;if(l&&new Date(l).getTime()>Date.now())throw Error("otp_cooldown");let u=b(),d=Q(),c=new Date(Date.now()+1e3*P()).toISOString(),f={phoneMasked:Y(r),phoneLast4:j(r),phoneHash:W(r),otpHash:G({token:i,code:d}),otpExpiresAt:c,otpRequestedAt:u,otpAttemptCount:0,otpMaxAttempts:F(),resendAvailableAt:new Date(Date.now()+1e3*B()).toISOString(),verifiedAt:null};return n.invite.status="otp_sent",n.invite.updatedAt=u,n.invite.verification=f,await eI(n.store),{invite:eX(n.invite),otpCode:d,phoneNumber:r,otpExpiresAt:c,phoneMasked:f.phoneMasked,resendAvailableAt:f.resendAvailableAt}}async function e6(e,{token:t,otpCode:i}){let r=ee(t);if(!r)throw Error("invalid_invite_token");if(!X(i))throw Error("invalid_otp");let n=await eQ(e,r);if(!n)throw Error("invite_not_found");let o=eK(n.invite);if("expired"===o)throw await (0,a.updateDoc)(n.ref,{status:"expired",updatedAt:b()}),Error("invite_expired");if("revoked"===o)throw Error("invite_revoked");if("verified"===o)throw Error("invite_already_verified");let s=n.invite.verification||{};if(!s.otpHash||!s.otpExpiresAt)throw Error("otp_not_requested");if(new Date(s.otpExpiresAt).getTime()<=Date.now())throw await (0,a.updateDoc)(n.ref,{updatedAt:b(),verification:{...s,otpHash:null,otpExpiresAt:null}}),Error("otp_expired");let l=Number.isFinite(s.otpMaxAttempts)?Math.max(1,s.otpMaxAttempts):F(),u=Number.isFinite(s.otpAttemptCount)?Math.max(0,s.otpAttemptCount):0;if(u>=l)throw Error("otp_attempts_exceeded");if(!Z(G({token:r,code:String(i).trim()}),s.otpHash)){let e=u+1,t=b(),i=e>=l;if(await (0,a.updateDoc)(n.ref,{status:i?"revoked":n.invite.status,updatedAt:t,verification:{...s,otpAttemptCount:e}}),i)throw Error("otp_attempts_exceeded");throw Error("invalid_otp")}let d=(0,a.doc)(e,ep(),n.invite.email),c=await (0,a.getDoc)(d);if(!c.exists())throw Error("invite_user_not_found");let f=e_(c.id,c.data());if(!f)throw Error("invite_user_not_found");if("disabled"===f.status)throw Error("account_disabled");let p=b(),v=ea({...f,status:"active",activatedAt:f.activatedAt||p,emailVerifiedAt:f.emailVerifiedAt||p,updatedAt:p,phoneVerifiedAt:p,phoneLast4:s.phoneLast4||null,phoneHash:s.phoneHash||null,verificationMethod:"sms"});await (0,a.setDoc)(d,v);let h={...s,otpHash:null,otpExpiresAt:null,otpAttemptCount:0,verifiedAt:p};return await (0,a.updateDoc)(n.ref,{status:"verified",updatedAt:p,verification:h}),{user:ef(v),invite:eX({...n.invite,status:"verified",updatedAt:p,verification:h})}}async function e3({token:e,otpCode:t}){let i=ee(e);if(!i)throw Error("invalid_invite_token");if(!X(t))throw Error("invalid_otp");let r=await eZ(i);if(!r)throw Error("invite_not_found");let n=eK(r.invite);if("expired"===n)throw r.invite.status="expired",r.invite.updatedAt=b(),await eI(r.store),Error("invite_expired");if("revoked"===n)throw Error("invite_revoked");if("verified"===n)throw Error("invite_already_verified");let a=r.invite.verification||{};if(!a.otpHash||!a.otpExpiresAt)throw Error("otp_not_requested");if(new Date(a.otpExpiresAt).getTime()<=Date.now())throw r.invite.updatedAt=b(),r.invite.verification={...a,otpHash:null,otpExpiresAt:null},await eI(r.store),Error("otp_expired");let o=Number.isFinite(a.otpMaxAttempts)?Math.max(1,a.otpMaxAttempts):F(),s=Number.isFinite(a.otpAttemptCount)?Math.max(0,a.otpAttemptCount):0;if(s>=o)throw Error("otp_attempts_exceeded");if(!Z(G({token:i,code:String(t).trim()}),a.otpHash)){let e=b(),t=s+1,i=t>=o;if(r.invite.status=i?"revoked":r.invite.status,r.invite.updatedAt=e,r.invite.verification={...a,otpAttemptCount:t},await eI(r.store),i)throw Error("otp_attempts_exceeded");throw Error("invalid_otp")}let l=r.store.users.find(e=>e.email===r.invite.email);if(!l)throw Error("invite_user_not_found");if("disabled"===l.status)throw Error("account_disabled");let u=b();return l.status="active",l.activatedAt=l.activatedAt||u,l.emailVerifiedAt=l.emailVerifiedAt||u,l.phoneVerifiedAt=u,l.phoneLast4=a.phoneLast4||null,l.phoneHash=a.phoneHash||null,l.verificationMethod="sms",l.updatedAt=u,r.invite.status="verified",r.invite.updatedAt=u,r.invite.verification={...a,otpHash:null,otpExpiresAt:null,otpAttemptCount:0,verifiedAt:u},await eI(r.store),{user:ef(l),invite:eX(r.invite)}}async function e5(e,{email:t}){let i=I(t);if(!O(i))throw Error("invalid_email");let r=(0,a.doc)(e,ep(),i),n=await (0,a.getDoc)(r);if(!n.exists())throw Error("user_not_found");let o=e_(n.id,n.data());if(!o)throw Error("user_not_found");if("disabled"===o.status)throw Error("account_disabled");let s=k(),l=b(),u=new Date(Date.now()+1e3*$()).toISOString(),d={challengeTokenHash:J("login_mfa_challenge",s),challengeExpiresAt:u,phoneMasked:null,phoneLast4:null,phoneHash:null,otpHash:null,otpExpiresAt:null,otpRequestedAt:null,otpAttemptCount:0,otpMaxAttempts:F(),resendAvailableAt:null,updatedAt:l};return await (0,a.updateDoc)(r,{loginMfa:d,updatedAt:l}),{challengeToken:s,challengeExpiresAt:u}}async function e8({email:e}){let t=I(e);if(!O(t))throw Error("invalid_email");let i=await eO(),r=i.users.find(e=>e.email===t);if(!r)throw Error("user_not_found");if("disabled"===r.status)throw Error("account_disabled");let n=k(),a=b(),o=new Date(Date.now()+1e3*$()).toISOString();return r.loginMfa={challengeTokenHash:J("login_mfa_challenge",n),challengeExpiresAt:o,phoneMasked:null,phoneLast4:null,phoneHash:null,otpHash:null,otpExpiresAt:null,otpRequestedAt:null,otpAttemptCount:0,otpMaxAttempts:F(),resendAvailableAt:null,updatedAt:a},r.updatedAt=a,await eI(i),{challengeToken:n,challengeExpiresAt:o}}function e9({challengeToken:e,loginMfa:t}){let i=ee(e);if(!i)throw Error("invalid_mfa_challenge");let r=function(e){if(!e||"object"!=typeof e)return null;let t="string"==typeof e.challengeTokenHash?e.challengeTokenHash:"";return t?{challengeTokenHash:t,challengeExpiresAt:L(e.challengeExpiresAt)||"",phoneMasked:"string"==typeof e.phoneMasked?e.phoneMasked:"",phoneLast4:"string"==typeof e.phoneLast4?e.phoneLast4:"",phoneHash:"string"==typeof e.phoneHash?e.phoneHash:"",otpHash:"string"==typeof e.otpHash?e.otpHash:"",otpExpiresAt:L(e.otpExpiresAt)||"",otpRequestedAt:L(e.otpRequestedAt)||"",otpAttemptCount:Number.isFinite(e.otpAttemptCount)?Math.max(0,e.otpAttemptCount):0,otpMaxAttempts:Number.isFinite(e.otpMaxAttempts)?Math.max(1,e.otpMaxAttempts):F(),resendAvailableAt:L(e.resendAvailableAt)||"",updatedAt:L(e.updatedAt)||""}:null}(t);if(!r?.challengeTokenHash||!Z(J("login_mfa_challenge",i),r.challengeTokenHash)||!r.challengeExpiresAt||new Date(r.challengeExpiresAt).getTime()<=Date.now())throw Error("invalid_mfa_challenge");return{normalizedToken:i,state:r}}async function e7(e,{email:t,device:i}){let r=(0,a.doc)(e,ep(),t),n=await (0,a.getDoc)(r);if(!n.exists())return null;let o=b(),s=e_(n.id,n.data());if(!s)return null;let l=z({...i,firstSeenAt:o,lastSeenAt:o});if(!l)return null;let u=K(s.knownDevices),d=u.findIndex(e=>e.deviceId===l.deviceId),c=d>=0?{...u[d],label:l.label||u[d].label,userAgent:l.userAgent||u[d].userAgent,lastIp:l.lastIp||u[d].lastIp,lastSeenAt:o}:l,f=[...u];d>=0?f.splice(d,1,c):f.push(c);let p=K(f);return await (0,a.updateDoc)(r,{knownDevices:p,updatedAt:o}),{isNew:d<0,device:c}}async function te(e,{email:t,challengeToken:i,phoneNumber:r}){let n=I(t);if(!O(n))throw Error("invalid_email");let o=q(r);if(!o)throw Error("invalid_phone_number");let s=(0,a.doc)(e,ep(),n),l=await (0,a.getDoc)(s);if(!l.exists())throw Error("user_not_found");let u=l.data()||{},d=e_(l.id,u);if(!d)throw Error("user_not_found");if("disabled"===d.status)throw Error("account_disabled");e9({challengeToken:i,loginMfa:u.loginMfa});let c=b(),f={phoneVerifiedAt:d.phoneVerifiedAt||c,phoneLast4:j(o),phoneHash:W(o),verificationMethod:"sms",loginMfa:null,updatedAt:c};await (0,a.updateDoc)(s,f);let p=e_(l.id,{...u,...f});return p?ef(p):null}async function tt({email:e,challengeToken:t,phoneNumber:i}){let r=I(e);if(!O(r))throw Error("invalid_email");let n=q(i);if(!n)throw Error("invalid_phone_number");let a=await eO(),o=a.users.find(e=>e.email===r);if(!o)throw Error("user_not_found");if("disabled"===o.status)throw Error("account_disabled");e9({challengeToken:t,loginMfa:o.loginMfa});let s=b();return o.phoneVerifiedAt=o.phoneVerifiedAt||s,o.phoneLast4=j(n),o.phoneHash=W(n),o.verificationMethod="sms",o.loginMfa=null,o.updatedAt=s,await eI(a),ef(o)}async function ti(e,{token:t}){let i=ee(t);if(!i)throw Error("invalid_invite_token");let r=await eQ(e,i);if(!r)throw Error("invite_not_found");let n=eK(r.invite);if("expired"===n)throw await (0,a.updateDoc)(r.ref,{status:"expired",updatedAt:b()}),Error("invite_expired");if("revoked"===n)throw Error("invite_revoked");if("verified"===n)throw Error("invite_already_verified");let o=(0,a.doc)(e,ep(),r.invite.email),s=await (0,a.getDoc)(o);if(!s.exists())throw Error("invite_user_not_found");let l=e_(s.id,s.data());if(!l)throw Error("invite_user_not_found");if("disabled"===l.status)throw Error("account_disabled");let u=b(),d=ea({...l,status:"active",activatedAt:l.activatedAt||u,emailVerifiedAt:u,verificationMethod:"email",updatedAt:u});await (0,a.setDoc)(o,d);let c={...r.invite.verification||{},otpHash:null,otpExpiresAt:null,otpAttemptCount:0,verifiedAt:u};return await (0,a.updateDoc)(r.ref,{status:"verified",updatedAt:u,verification:c}),{user:ef(d),invite:eX({...r.invite,status:"verified",updatedAt:u,verification:c})}}async function tr({token:e}){let t=ee(e);if(!t)throw Error("invalid_invite_token");let i=await eZ(t);if(!i)throw Error("invite_not_found");let r=eK(i.invite);if("expired"===r)throw i.invite.status="expired",i.invite.updatedAt=b(),await eI(i.store),Error("invite_expired");if("revoked"===r)throw Error("invite_revoked");if("verified"===r)throw Error("invite_already_verified");let n=i.store.users.find(e=>e.email===i.invite.email);if(!n)throw Error("invite_user_not_found");if("disabled"===n.status)throw Error("account_disabled");let a=b();return n.status="active",n.activatedAt=n.activatedAt||a,n.emailVerifiedAt=a,n.verificationMethod="email",n.updatedAt=a,i.invite.status="verified",i.invite.updatedAt=a,i.invite.verification={...i.invite.verification||{},otpHash:null,otpExpiresAt:null,otpAttemptCount:0,verifiedAt:a},await eI(i.store),{user:ef(n),invite:eX(i.invite)}}async function tn(e){let t=new Set(["invalid_invite_token","invite_not_found","invite_expired","invite_revoked","invite_already_verified","invite_user_not_found","account_disabled"]),i=await eh();if(i)try{return await e0(i,e)}catch(i){let e=i instanceof Error?i.message:"";if(t.has(e))throw i;em(i,"get_invite_for_email_verification")}return await e1(e)}async function ta({token:e,phoneNumber:t}){let i=new Set(["invalid_invite_token","invalid_phone_number","invite_not_found","invite_expired","invite_revoked","invite_already_verified","invite_user_not_found","account_disabled","otp_cooldown"]),r=await eh();if(r)try{return await e4(r,{token:e,phoneNumber:t})}catch(t){let e=t instanceof Error?t.message:"";if(i.has(e))throw t;em(t,"start_invite_sms_verification")}return await e2({token:e,phoneNumber:t})}async function to({token:e,otpCode:t}){let i,r=new Set(["invalid_invite_token","invite_not_found","invite_expired","invite_revoked","invite_already_verified","invite_user_not_found","account_disabled","otp_not_requested","otp_expired","otp_attempts_exceeded","invalid_otp"]),n=await eh();if(n)try{i=await e6(n,{token:e,otpCode:t})}catch(t){let e=t instanceof Error?t.message:"";if(r.has(e))throw t;em(t,"complete_invite_sms_verification")}else i=await e3({token:e,otpCode:t});return await eo(i?.user,{allowMissingUser:!1,strict:!1}),i}async function ts({token:e}){let t,i=new Set(["invalid_invite_token","invite_not_found","invite_expired","invite_revoked","invite_already_verified","invite_user_not_found","account_disabled"]),r=await eh();if(r)try{t=await ti(r,{token:e})}catch(t){let e=t instanceof Error?t.message:"";if(i.has(e))throw t;em(t,"verify_invite_email")}else t=await tr({token:e});return await eo(t?.user,{allowMissingUser:!1,strict:!1}),t}async function tl({email:e}){let t=I(e);if(!t)throw Error("invalid_email");let i=await eh();if(i)try{return await e5(i,{email:t})}catch(e){if(["invalid_email","user_not_found","account_disabled","already_verified"].includes(e instanceof Error?e.message:""))throw e;em(e,"create_login_sms_challenge")}return await e8({email:t})}async function tu({email:e,challengeToken:t,phoneNumber:i}){let r=I(e);if(!r)throw Error("invalid_email");let n=new Set(["invalid_email","invalid_phone_number","invalid_mfa_challenge","user_not_found","account_disabled","already_verified"]),a=null,o=await eh();if(o)try{a=await te(o,{email:r,challengeToken:t,phoneNumber:i})}catch(t){let e=t instanceof Error?t.message:"";if(n.has(e))throw t;em(t,"complete_login_sms_verification_firebase")}else a=await tt({email:r,challengeToken:t,phoneNumber:i});return await eo(a,{allowMissingUser:!1,strict:!1}),a}async function td(e){let t=await eh();if(t)try{return await eW(t,e)}catch(e){em(e,"revoke_invite")}return await ez(e)}async function tc(){let e=await eh();if(e)try{return await eE(e)}catch(e){em(e,"list_user_accounts")}return await eR()}async function tf(e){let t=I(e);if(!t)return null;let i=await eh();if(i)try{return await ey(i,t)}catch(e){em(e,"get_login_account")}return await eH(t)}async function tp(e){let t=I(e);if(!t)return null;let i=await eh();if(i)try{return await eS(i,t)}catch(e){em(e,"mark_user_login")}return await eV(t)}async function tv({email:e,userAgent:t,ip:i,acceptLanguage:r,secChUa:n,secChUaPlatform:a,secChUaMobile:o}){let s=I(e);if(!s)return null;let l=function({userAgent:e,ip:t,acceptLanguage:i,secChUa:r,secChUaPlatform:n,secChUaMobile:a}={}){let o,s,l;return{deviceId:function({userAgent:e,acceptLanguage:t,secChUa:i,secChUaPlatform:r,secChUaMobile:n}={}){return J("device",[String(e||"").trim(),String(t||"").trim(),String(i||"").trim(),String(r||"").trim(),String(n||"").trim()].filter(Boolean).join("|")||"unknown-device")}({userAgent:e,acceptLanguage:i,secChUa:r,secChUaPlatform:n,secChUaMobile:a}),label:(l=String(e||"").trim())&&"unknown"!==l?`${!(o=String(l||"").toLowerCase())||"unknown"===o?"Unknown Browser":o.includes("edg/")?"Microsoft Edge":o.includes("opr/")||o.includes("opera")?"Opera":o.includes("firefox/")?"Firefox":o.includes("safari/")&&!o.includes("chrome/")?"Safari":o.includes("chrome/")?"Chrome":"Browser"} on ${!(s=String(l||"").toLowerCase())||"unknown"===s?"Unknown OS":s.includes("windows")?"Windows":s.includes("mac os x")||s.includes("macintosh")?"macOS":s.includes("android")?"Android":s.includes("iphone")||s.includes("ipad")||s.includes("ios")?"iOS":s.includes("linux")?"Linux":"OS"}`:"Unknown device",userAgent:String(e||"").trim()||"unknown",lastIp:String(t||"").trim()||"unknown"}}({userAgent:t,ip:i,acceptLanguage:r,secChUa:n,secChUaPlatform:a,secChUaMobile:o}),u=await eh();if(u)try{return await e7(u,{email:s,device:l})}catch(e){em(e,"record_login_device")}return await eT({email:s,device:l})}async function th({email:e,deviceId:t,trusted:i,deniedReason:r}){let n=I(e),a=String(t||"").trim();if(!n||!a)throw Error("invalid_device");let o=await eh();if(o)try{return await eU(o,{email:n,deviceId:a,trusted:i,deniedReason:r})}catch(e){em(e,"update_login_device_trust")}return await eP({email:n,deviceId:a,trusted:i,deniedReason:r})}async function tm({userId:e}){let t,i=String(e||"").trim().toLowerCase();if(!i)throw Error("invalid_user");let r=await eh();if(r)try{t=await ex(r,{userId:i})}catch(e){em(e,"revoke_user_sessions")}else t=await eF({userId:i});return await eo(t,{allowMissingUser:!1,strict:!1}),t}async function t_({email:e,role:t,invitedBy:i}){let r,n=await eh();if(n)try{r=await eb(n,{email:e,role:t,invitedBy:i})}catch(e){em(e,"invite_user_account")}else r=await eB({email:e,role:t,invitedBy:i});return await eo(r?.user,{allowMissingUser:!0,strict:!1}),r}async function tA({userId:e,status:t}){let i,r=await eh();if(r)try{i=await eL(r,{userId:e,status:t})}catch(e){em(e,"update_user_account_status")}else i=await e$({userId:e,status:t});return await eo(i,{allowMissingUser:!1,strict:!1}),i}async function tw({userId:e,archivedBy:t,reason:i,retentionDeleteAt:r}){let n,a=await eh();if(a)try{n=await eD(a,{userId:e,archivedBy:t,reason:i,retentionDeleteAt:r})}catch(e){em(e,"archive_user_account")}else n=await eY({userId:e,archivedBy:t,reason:i,retentionDeleteAt:r});return await eo(n,{allowMissingUser:!1,strict:!1}),n}async function tg({userId:e,role:t}){let i,r=await eh();if(r)try{i=await eM(r,{userId:e,role:t})}catch(e){em(e,"update_user_account_role")}else i=await eq({userId:e,role:t});return await eo(i,{allowMissingUser:!1,strict:!1}),i}async function tE({now:e}={}){let t=await eh();if(t)try{return await eJ(t,{now:e})}catch(e){em(e,"purge_due_archived_user_accounts")}return await eG({now:e})}async function ty({userId:e,firstName:t,middleName:i,lastName:r,profilePhotoDataUrl:n,profilePhotoStoragePath:a,smsMfaEnabled:o}){let s=await eh();if(s)try{return await ek(s,{userId:e,firstName:t,middleName:i,lastName:r,profilePhotoDataUrl:n,profilePhotoStoragePath:a,smsMfaEnabled:o})}catch(e){em(e,"update_user_account_profile")}return await ej({userId:e,firstName:t,middleName:i,lastName:r,profilePhotoDataUrl:n,profilePhotoStoragePath:a,smsMfaEnabled:o})}e.s(["archiveUserAccount",()=>tw,"completeInviteSmsVerification",()=>to,"completeLoginSmsVerificationWithFirebase",()=>tu,"createLoginSmsChallenge",()=>tl,"getInviteForEmailVerification",()=>tn,"getLoginAccount",()=>tf,"inviteUserAccount",()=>t_,"listUserAccounts",()=>tc,"markUserLogin",()=>tp,"purgeDueArchivedUserAccounts",()=>tE,"recordLoginDevice",()=>tv,"revokeInviteById",()=>td,"revokeUserSessions",()=>tm,"startInviteSmsVerification",()=>ta,"updateLoginDeviceTrust",()=>th,"updateUserAccountProfile",()=>ty,"updateUserAccountRole",()=>tg,"updateUserAccountStatus",()=>tA,"verifyInviteEmail",()=>ts],45709)}];

//# sourceMappingURL=src_lib_user-accounts_7a5c54d8.js.map