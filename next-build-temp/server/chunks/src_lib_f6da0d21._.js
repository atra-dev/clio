module.exports=[33355,e=>{"use strict";e.i(18097);var t=e.i(19e3),n=e.i(67658),i=e.i(45709);function r(){return new Date().toISOString()}function o(e,t=""){return String(e||"").trim()||t}function a(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){let n=e.trim().toLowerCase();if(!n)return t;if(["true","1","yes","on","y"].includes(n))return!0;if(["false","0","no","off","n"].includes(n))return!1}return t}function s(e){return e&&"object"==typeof e&&!Array.isArray(e)?e:{}}function c(e){return Array.isArray(e)?e:[]}function l(e,t,{min:n=1,max:i=Number.MAX_SAFE_INTEGER}={}){let r=Number.parseInt(String(e||""),10);return Number.isFinite(r)?Math.min(i,Math.max(n,r)):t}function d(e){return String(e||"").trim().toLowerCase()}function u(e){return String(e||"").trim().toLowerCase()}function f(e){return String(e||"").split(",").map(e=>d(e)).filter(Boolean)}function p(e){return"read"===String(e||"").trim().toLowerCase()?"read":"unread"}function m(){return o(process.env.CLIO_FIRESTORE_NOTIFICATIONS_COLLECTION,"clio_notifications")}function _(){return(0,n.isFirestoreEnabled)()?(0,n.getFirestoreDb)():null}function v(e){return{...e.data()||{},id:e.id,recordId:e.id}}function I(e,t){let n=d(t),i=d(e?.recipientEmail);return a(e?.broadcast,!1)||n&&i&&n===i}function y(e,t){return new Date(t?.createdAt||0).getTime()-new Date(e?.createdAt||0).getTime()}async function E(e){let n=_();if(!n)return null;let i=function(e){let t,n=r(),i=d(e?.recipientEmail),c=a(e?.broadcast,!1);if(!i&&!c)throw Error("invalid_notification_recipient");return{title:o(e?.title,"Security notification"),message:o(e?.message,"A security event requires review."),severity:"critical"===(t=String(e?.severity||"").trim().toLowerCase())?"critical":"high"===t?"high":"low"===t?"low":"medium",type:o(e?.type,"security"),module:o(e?.module,"Incident Management"),actionUrl:o(e?.actionUrl,"/incident-management"),recipientEmail:i,broadcast:c,status:p(e?.status),metadata:s(e?.metadata),createdAt:o(e?.createdAt,n),updatedAt:o(e?.updatedAt,n),readAt:o(e?.readAt,""),createdBy:d(e?.createdBy)}}(e),c=await (0,t.addDoc)((0,t.collection)(n,m()),i);return{...i,id:c.id,recordId:c.id}}async function g(e){let t=c(e);if(0===t.length)return[];let n=[];for(let e of t){let t=await E(e);t&&n.push(t)}return n}async function w(e,n){let i=_();if(!i)return null;let r=o(e);if(!r)throw Error("invalid_record_id");let a=(0,t.doc)(i,m(),r),s=await (0,t.getDoc)(a);if(!s.exists())return null;let c=v(s);if(!I(c,n))throw Error("forbidden_notification_access");return c}async function h({recipientEmail:e,status:n="all",limit:i=20}={}){let r=_();if(!r)return{records:[],unreadCount:0,totalScoped:0};let o=String(n||"").trim().toLowerCase(),a=l(i,20,{min:1,max:120}),s=Math.max(4*a,100),c=(await (0,t.getDocs)((0,t.query)((0,t.collection)(r,m()),(0,t.orderBy)("createdAt","desc"),(0,t.limit)(s)))).docs.map(v).filter(t=>I(t,e)),d=c.reduce((e,t)=>e+ +("unread"===p(t?.status)),0);return{records:c.filter(e=>"all"===o||!o||p(e?.status)===o).sort(y).slice(0,a),unreadCount:d,totalScoped:c.length}}async function C(e,n){let i=_();if(!i)return null;let a=o(e);if(!a)throw Error("invalid_record_id");let s=(0,t.doc)(i,m(),a),c=await (0,t.getDoc)(s);if(!c.exists())return null;let l=v(c);if(!I(l,n))throw Error("forbidden_notification_access");if("read"===p(l.status))return l;let d={...l,status:"read",readAt:r(),updatedAt:r()};return await (0,t.updateDoc)(s,d),d}async function A(e,n,i){let a=_();if(!a)return null;let c=o(e);if(!c)throw Error("invalid_record_id");let l=d(n),u=o(i).toLowerCase();if("confirm"!==u&&"deny"!==u)throw Error("invalid_device_verification_decision");let f=(0,t.doc)(a,m(),c),p=await (0,t.getDoc)(f);if(!p.exists())return null;let y=v(p);if(!I(y,l))throw Error("forbidden_notification_access");let E=s(y?.metadata),g=o(E?.deviceVerificationDecision).toLowerCase();if(g){if(g===u)return y;throw Error("device_verification_already_resolved")}let w=r(),h={...y,status:"read",readAt:o(y?.readAt,w),updatedAt:w,metadata:{...E,deviceVerificationDecision:u,deviceVerificationResolvedAt:w,deviceVerificationResponder:l}};return await (0,t.updateDoc)(f,h),h}async function S({recipientEmail:e,limit:n=120}={}){let i=d(e);if(!i)return{updatedCount:0};let a=_();if(!a)return{updatedCount:0};let s=l(n,120,{min:1,max:300}),{records:c}=await h({recipientEmail:i,status:"unread",limit:s}),u=0;for(let e of c){let n=o(e?.id||e?.recordId);if(!n)continue;let i=(0,t.doc)(a,m(),n);await (0,t.updateDoc)(i,{status:"read",readAt:r(),updatedAt:r()}),u+=1}return{updatedCount:u}}function O(e=[]){return Array.from(new Set(c(e).map(e=>d(e)).filter(Boolean)))}async function L({ownerEmail:e,affectedEmployeeEmail:t,actorEmail:n,includeAffectedEmployee:r=!0,includeActor:o=!1}={}){let a=[d(process.env.CLIO_GRC_ALERT_EMAIL),...f(process.env.GRC_EMAILS),d(e)];r&&a.push(d(t)),o&&a.push(d(n));let s=[];try{let e=await (0,i.listUserAccounts)();s=c(e).filter(e=>d(e?.email)).filter(e=>"active"===u(e?.status)).filter(e=>{let t=String(e?.role||"").trim().toUpperCase();return"GRC"===t}).map(e=>d(e?.email))}catch{s=[]}return O([...a,...s])}async function N(){let e=[d(process.env.CLIO_GRC_ALERT_EMAIL),...f(process.env.GRC_EMAILS)],t=[];try{let e=await (0,i.listUserAccounts)();t=c(e).filter(e=>d(e?.email)).filter(e=>"active"===u(e?.status)).filter(e=>"GRC"===String(e?.role||"").trim().toUpperCase()).map(e=>d(e?.email))}catch{t=[]}return O([...e,...t])}e.s(["createInAppNotification",()=>E,"createInAppNotificationsBulk",()=>g,"getInAppNotificationForRecipient",()=>w,"listInAppNotifications",()=>h,"markAllInAppNotificationsRead",()=>S,"markInAppNotificationRead",()=>C,"resolveDeviceVerificationNotification",()=>A,"resolveGrcRecipients",()=>N,"resolveIncidentStakeholderRecipients",()=>L])},4381,e=>{"use strict";let t="__clio_rate_limit_buckets__";function n(e){return String(e||"").trim().toLowerCase()}function i(e){if(!e||!e.headers)return"unknown";let t=e.headers.get("x-forwarded-for");if(t){let e=t.split(",")[0]?.trim();if(e)return e}for(let t of["x-real-ip","cf-connecting-ip","x-vercel-forwarded-for"]){let n=String(e.headers.get(t)||"").trim();if(n)return n}return"unknown"}function r({scope:e,identifier:i,limit:r=20,windowMs:o=3e5}){let a=String(e||"default").trim().toLowerCase(),s=n(i)||"unknown",c=Math.max(1,Number.parseInt(String(r),10)||1),l=Math.max(1e3,Number.parseInt(String(o),10)||1e3),d=(globalThis[t]||(globalThis[t]=new Map),globalThis[t]),u=Date.now();!function(e,t){if(e.size<=5e3)return;for(let[n,i]of e.entries())(!i||t>=i.resetAt)&&e.delete(n);if(e.size<=5e3)return;let n=e.size-5e3;for(let t of e.keys())if(e.delete(t),(n-=1)<=0)break}(d,u);let f=`${a}:${s}`,p=d.get(f);(!p||u>=p.resetAt)&&(p={count:0,resetAt:u+l}),p.count+=1,d.set(f,p);let m=Math.max(0,c-p.count),_=Math.max(1,Math.ceil((p.resetAt-u)/1e3));return{allowed:p.count<=c,key:f,remaining:m,retryAfterSeconds:_,resetAt:p.resetAt,headers:{"Retry-After":String(_),"X-RateLimit-Limit":String(c),"X-RateLimit-Remaining":String(m),"X-RateLimit-Reset":String(Math.floor(p.resetAt/1e3))}}}function o({request:e,scope:t,identifier:o,limit:a,windowMs:s}){return r({scope:t,identifier:n(o)||i(e),limit:a,windowMs:s})}e.s(["consumeRateLimit",()=>r,"enforceRateLimitByRequest",()=>o,"getRequestSourceIp",()=>i])},22177,e=>{"use strict";function t(e,n=""){return String(e||"").trim()||n}function n(e){return Array.isArray(e)?e:[]}function i(e){return t(e).toLowerCase()}function r(e){return String(e||"").replace(/[^\d+]/g,"").trim()}function o(e){return t(e).split(",").map(e=>e.trim()).filter(Boolean)}function a(e=[]){return Array.from(new Set(e.filter(Boolean)))}function s(){let e,n=(e=t(process.env.CLIO_ALERT_EMAIL_PROVIDER).toLowerCase())?e.includes("resend")?"resend":e.includes("firebase")?"firebase":e.includes("console")||"dev"===e?"console":"none"===e||"off"===e?"none":e:"";return n||"none"}function c(){let e,n=(e=t(process.env.CLIO_ALERT_SMS_PROVIDER).toLowerCase())?e.includes("twilio")?"twilio":e.includes("console")||"dev"===e?"console":"none"===e||"off"===e?"none":e:"";return n||"none"}function l(e=[]){return a([...o(process.env.CLIO_SECURITY_ALERT_RECIPIENTS),...o(process.env.GRC_EMAILS),...o(process.env.SUPER_ADMIN_EMAILS),...n(e)].map(e=>i(e)).filter(Boolean))}async function d({recipients:e,subject:n,text:i,html:r}){let o=t(process.env.RESEND_API_KEY),a=t(process.env.CLIO_EMAIL_FROM);if(!o||!a||!o.startsWith("re_"))throw Error("email_provider_not_configured");let s=await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({from:a,to:e,subject:n,text:i,html:r})}),c=await s.json().catch(()=>({}));if(!s.ok){let e=t(c?.message)||t(c?.error?.message)||"email_delivery_failed";throw Error(`email_delivery_failed:${e}`)}return{provider:"resend",status:"sent",messageId:t(c?.id,`resend-${Date.now()}`),recipientCount:e.length}}async function u({recipients:e,subject:r,text:o,html:c}){let l=a(n(e).map(i).filter(Boolean));if(0===l.length)return{provider:"none",status:"skipped",reason:"no_recipients",recipientCount:0};let u=s();return"none"===u?{provider:u,status:"skipped",reason:"provider_disabled",recipientCount:0}:"firebase"===u?{provider:u,status:"skipped",reason:"firebase_not_supported_for_custom_alert_email",recipientCount:0}:"console"===u?function({recipients:e,subject:n,text:i}){return function(e,n=!1){let i=t(process.env[e]).toLowerCase();return i?"true"===i||"1"===i||"yes"===i:n}("CLIO_ALLOW_CONSOLE_EMAIL",!0)&&console.info("[CLIO:SecurityAlert:Email]",{recipients:e,subject:n,text:i}),{provider:"console",status:"simulated",recipientCount:e.length}}({recipients:l,subject:r,text:o}):"resend"===u?await d({recipients:l,subject:r,text:o,html:c}):{provider:u,status:"skipped",reason:"unsupported_provider",recipientCount:0}}async function f({recipients:e,body:n}){let i=t(process.env.TWILIO_ACCOUNT_SID),r=t(process.env.TWILIO_AUTH_TOKEN),o=t(process.env.TWILIO_FROM_NUMBER);if(!i||!r||!o)throw Error("twilio_not_configured");let a=Buffer.from(`${i}:${r}`,"utf8").toString("base64"),s=e.map(async e=>{let r=new URLSearchParams;r.set("To",e),r.set("From",o),r.set("Body",n);let s=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${encodeURIComponent(i)}/Messages.json`,{method:"POST",headers:{Authorization:`Basic ${a}`,"Content-Type":"application/x-www-form-urlencoded"},body:r.toString()}),c=await s.json().catch(()=>({}));if(!s.ok){let e=t(c?.message,"sms_delivery_failed");throw Error(`twilio_delivery_failed:${e}`)}return{to:e,sid:t(c?.sid)}}),c=await Promise.allSettled(s),l=c.filter(e=>"fulfilled"===e.status).map(e=>e.value),d=c.filter(e=>"rejected"===e.status).map(e=>t(e.reason?.message||"sms_delivery_failed"));return{provider:"twilio",status:d.length>0?l.length>0?"partial":"failed":"sent",deliveredCount:l.length,recipientCount:e.length,delivered:l,failed:d}}async function p({recipients:e,body:t}){let i=a(n(e).map(r).filter(Boolean));if(0===i.length)return{provider:"none",status:"skipped",reason:"no_recipients",deliveredCount:0,recipientCount:0,failed:[]};let o=c();return"none"===o?{provider:o,status:"skipped",reason:"provider_disabled",deliveredCount:0,recipientCount:i.length,failed:[]}:"console"===o?function({recipients:e,body:t}){return{provider:"console",status:"simulated",deliveredCount:e.length,recipientCount:e.length,delivered:e.map(e=>({to:e,sid:`console-${Date.now()}`})),failed:[]}}({recipients:i,body:t}):"twilio"===o?await f({recipients:i,body:t}):{provider:o,status:"skipped",reason:"unsupported_provider",deliveredCount:0,recipientCount:i.length,failed:[]}}async function m({url:e,label:n,token:i,payload:r,timeoutMs:o}){let a=new AbortController,s=setTimeout(()=>a.abort(),o);try{let o={"Content-Type":"application/json","X-CLIO-Source":"security-detection","X-CLIO-Target":n};i&&(o.Authorization=`Bearer ${i}`);let s=await fetch(e,{method:"POST",headers:o,body:JSON.stringify(r),signal:a.signal}),c=await s.text().catch(()=>"");return{label:n,url:e,ok:s.ok,status:s.status,body:t(c)}}catch(i){return{label:n,url:e,ok:!1,status:0,body:t(i?.message,"webhook_delivery_failed")}}finally{clearTimeout(s)}}async function _(e){let n,i,r,a,s=(n=o(process.env.CLIO_SECURITY_WEBHOOK_URLS).map(e=>({label:"security-webhook",url:e,token:t(process.env.CLIO_SECURITY_WEBHOOK_TOKEN)})),i=t(process.env.CLIO_SIEM_WEBHOOK_URL),r=t(process.env.CLIO_EDR_WEBHOOK_URL),a=[...n],i&&a.push({label:"siem",url:i,token:t(process.env.CLIO_SIEM_WEBHOOK_TOKEN)}),r&&a.push({label:"edr",url:r,token:t(process.env.CLIO_EDR_WEBHOOK_TOKEN)}),a.filter(e=>t(e.url)));if(0===s.length)return{status:"skipped",targets:[],successCount:0};let c=Number.parseInt(t(process.env.CLIO_SECURITY_WEBHOOK_TIMEOUT_MS,"5000"),10)||5e3,l=await Promise.all(s.map(t=>m({...t,payload:e,timeoutMs:Math.max(1e3,Math.min(2e4,c))}))),d=l.filter(e=>e.ok).length;return{status:d===l.length?"sent":d>0?"partial":"failed",targets:l,successCount:d}}async function v({incident:e,detection:i,sourceEvent:d,emailRecipients:f=[],smsRecipients:m=[]}={}){let I,y=l(f),E=function(e=[]){return a([...o(process.env.CLIO_SMS_ALERT_RECIPIENTS),...n(e)].map(e=>r(e)).filter(Boolean))}(m),g=function({incident:e,detection:n}){let i=t(e?.severity||n?.severity||"Medium").toUpperCase(),r=t(e?.incidentCode,"INCIDENT"),o=t(e?.title,"Security anomaly detected");return`[CLIO][${i}] ${r} - ${o}`}({incident:e,detection:i}),w=function({incident:e,detection:n,sourceEvent:i}){let r=t(n?.ruleId,"N/A"),o=t(i?.metadata?.sourceIp||i?.sourceIp,"unknown"),a=t(i?.performedBy,"unknown"),s=t(i?.metadata?.requestPath||i?.requestPath,"unknown"),c=Number(n?.observedCount||0),l=t(e?.detectedAt||i?.occurredAt,new Date().toISOString());return`CLIO security anomaly alert
Incident: ${t(e?.incidentCode,"-")} | ${t(e?.title,"-")}
Severity: ${t(e?.severity,"-")}
Rule: ${r}
Detected At: ${l}
Actor: ${a}
Source IP: ${o}
Request Path: ${s}
Observed Count: ${c>0?c:"-"}
Summary: ${t(e?.summary||n?.summary,"-")}
Action URL: ${t(e?.actionUrl,"/incident-management")}`}({incident:e,detection:i,sourceEvent:d}),h=(I=String(w||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"),`<pre style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap;">${I}</pre>`),[C,A,S]=await Promise.all([u({recipients:y,subject:g,text:w,html:h}).catch(e=>({provider:s(),status:"failed",reason:t(e?.message,"email_delivery_failed"),recipientCount:y.length})),p({recipients:E,body:`${g}
${w}`.slice(0,1200)}).catch(e=>({provider:c(),status:"failed",reason:t(e?.message,"sms_delivery_failed"),deliveredCount:0,recipientCount:E.length,failed:[t(e?.message,"sms_delivery_failed")]})),_({eventType:"clio.security.incident",generatedAt:new Date().toISOString(),incident:e,detection:i,sourceEvent:{id:t(d?.id),module:t(d?.module),activityName:t(d?.activityName),status:t(d?.status),occurredAt:t(d?.occurredAt),sourceIp:t(d?.metadata?.sourceIp||d?.sourceIp),requestPath:t(d?.metadata?.requestPath||d?.requestPath)}})]);return{subject:g,email:C,sms:A,webhooks:S,recipients:y,smsRecipients:E}}function I(e=[]){return l(e)}async function y({recipients:e=[],body:n=""}={}){return await p({recipients:e,body:t(n,"")})}e.s(["dispatchDirectSms",()=>y,"dispatchSecurityIncidentAlerts",()=>v,"resolveSecurityAlertEmailRecipients",()=>I])},39552,e=>{"use strict";function t(e,n=""){return String(e||"").trim()||n}let n={title:"Incident title",summary:"Incident summary",incidentType:"Incident type",severity:"Severity",status:"Status",containmentStatus:"Containment status",containmentSummary:"Containment summary",impactAssessmentStatus:"Impact assessment status",impactSummary:"Impact assessment summary",ownerEmail:"Incident owner",affectedEmployeeEmail:"Affected employee",restrictedPiiInvolved:"Restricted PII flag",escalationRequired:"Escalation requirement",executiveNotificationRequired:"Executive notification requirement",regulatoryNotificationRequired:"Regulatory notification requirement",regulatoryNotifiedAt:"Regulator notification",affectedIndividualsNotifiedAt:"Affected-individual notification",grcAlertedAt:"GRC alert timestamp",executiveNotifiedAt:"Executive notification timestamp",documentationRetained:"Documentation retention",documentationLocation:"Documentation location",classificationStandard:"Classification standard",notes:"Investigation notes",forensicWindowStart:"Forensic window start",forensicWindowEnd:"Forensic window end"};function i(e={},n=""){let r=t(e?.title);if(r)return r;let o=t(e?.incidentCode);return o?`Case ${o}`:t(n)?"Incident Record":"Incident"}function r(e={},n=""){let o=i(e,n),a=t(e?.severity,"Medium"),s=t(e?.status,"Open");return{title:`New Incident: ${o}`,message:`A new incident has been logged for review. Severity: ${a}. Current status: ${s}.`}}function o(e={},r=[],a=""){let s=i(e,a),c=function(e=[],{max:i=4}={}){let r=Array.from(new Set((Array.isArray(e)?e:[]).map(e=>{let i;return(i=t(e))?n[i]?n[i]:i.replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/[_-]+/g," ").replace(/\s+/g," ").trim().replace(/^./,e=>e.toUpperCase()):"Field"}).filter(Boolean)));if(0===r.length)return"";if(r.length<=i)return r.join(", ");let o=r.slice(0,i).join(", ");return`${o}, +${r.length-i} more`}(r),l=new Set((Array.isArray(r)?r:[]).map(e=>t(e))),d="Incident workflow details were updated.";l.has("status")?d=`Incident status is now ${t(e?.status,"updated")}.`:l.has("containmentStatus")?d=`Containment status is now ${t(e?.containmentStatus,"updated")}.`:l.has("regulatoryNotifiedAt")?d="Regulator notification has been recorded.":l.has("affectedIndividualsNotifiedAt")?d="Affected-individual notification has been recorded.":l.has("executiveNotifiedAt")?d="Executive notification has been recorded.":l.has("grcAlertedAt")&&(d="GRC alert timestamp has been recorded.");let u=c?` Updated fields: ${c}.`:"";return{title:`Incident Updated: ${s}`,message:`${d}${u}`.trim()}}e.s(["buildIncidentCreatedNotification",()=>r,"buildIncidentUpdatedNotification",()=>o])},72331,e=>{"use strict";let t=new Set(["pdf","png","jpg","jpeg","webp","doc","docx","xls","xlsx","csv","txt"]),n=new Set(["application/pdf","image/png","image/jpeg","image/webp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv","text/plain"]);function i(e,t=""){return String(e||"").trim()||t}function r(e){return i(e).toLowerCase()}function o(e,t=!1){let n=r(process.env[e]);return n?"true"===n||"1"===n||"yes"===n||"on"===n:t}function a(e,t,{min:n=1,max:r=Number.MAX_SAFE_INTEGER}={}){let o=Number.parseInt(i(process.env[e]),10);return Number.isFinite(o)?Math.min(r,Math.max(n,o)):t}function s(e,t){let n=i(process.env[e]);if(!n)return new Set([...t]);let o=n.split(",").map(e=>r(e)).filter(Boolean);return new Set(o.length>0?o:[...t])}function c(e){return i(e).toLowerCase()}function l(){return new Date().toISOString()}function d(e){let t=i(e).toLowerCase();if(!t)return"";let n=t.split("?")[0].split("#")[0].split(".").pop()||"";return/^[a-z0-9]{2,10}$/.test(n)?n:""}async function u(e,t,n){if(!n.avHookUrl){if(n.avRequired)throw Error("incident_evidence_av_not_configured");return{status:"skipped",provider:"none",blockedIds:[],reference:""}}let r=new AbortController,o=setTimeout(()=>r.abort(),n.avTimeoutMs);try{var a;let o={"Content-Type":"application/json","X-CLIO-Source":"incident-evidence-validation"};n.avHookToken&&(o.Authorization=`Bearer ${n.avHookToken}`);let s=await fetch(n.avHookUrl,{method:"POST",headers:o,body:JSON.stringify({generatedAt:l(),actorEmail:c(t),records:e.map(e=>({id:e.id,name:e.name,storagePath:e.storagePath,ref:e.ref,contentType:e.contentType,fileExtension:e.fileExtension,sizeBytes:e.sizeBytes}))}),signal:r.signal}),d=await s.json().catch(()=>({}));if(!s.ok)throw Error(i(d?.message,"incident_evidence_av_hook_failed"));let u=(a=d?.blockedIds,Array.isArray(a)?a:[]).map(e=>i(e)).filter(Boolean);if(d?.allowed===!1||d?.blocked===!0||u.length>0)throw Error("incident_evidence_av_blocked");return{status:"passed",provider:"hook",blockedIds:[],reference:i(d?.scanId||d?.reference||"")}}catch(e){if(n.avFailOpen&&!n.avRequired)return{status:"failed-open",provider:"hook",blockedIds:[],reference:""};if("incident_evidence_av_blocked"===(e instanceof Error?i(e.message):""))throw e;throw Error("incident_evidence_av_hook_failed")}finally{clearTimeout(o)}}async function f(e,{actorEmail:p}={}){if(!Array.isArray(e))throw Error("invalid_incident_evidence_payload");let m={maxBytes:a("CLIO_INCIDENT_EVIDENCE_MAX_BYTES",0xa00000,{min:131072,max:0x3200000}),allowedExtensions:s("CLIO_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS",t),allowedMimeTypes:s("CLIO_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES",n),requireMimeType:o("CLIO_INCIDENT_EVIDENCE_REQUIRE_MIME_TYPE",!0),avHookUrl:i(process.env.CLIO_INCIDENT_EVIDENCE_AV_HOOK_URL),avHookToken:i(process.env.CLIO_INCIDENT_EVIDENCE_AV_HOOK_TOKEN),avRequired:o("CLIO_INCIDENT_EVIDENCE_AV_REQUIRED",!1),avFailOpen:o("CLIO_INCIDENT_EVIDENCE_AV_FAIL_OPEN",!1),avTimeoutMs:a("CLIO_INCIDENT_EVIDENCE_AV_TIMEOUT_MS",5e3,{min:1e3,max:2e4})},_=e.map((e,t)=>(function(e,t,n,o){let a,s=function(e,t=null){return e&&"object"==typeof e&&!Array.isArray(e)?e:t}(e);if(!s)throw Error("invalid_incident_evidence_payload");let u=i(s.name);if(!u)throw Error("invalid_incident_evidence_name");let f=i(s.ref),p=i(s.storagePath);if(!f&&!p)throw Error("invalid_incident_evidence_reference");let m=d(s.fileExtension)||d(u)||d(p)||d(f);if(!m||!o.allowedExtensions.has(m))throw Error("invalid_incident_evidence_extension");let _=r(s.contentType)||("pdf"===(a=r(m))?"application/pdf":"png"===a?"image/png":"jpg"===a||"jpeg"===a?"image/jpeg":"webp"===a?"image/webp":"doc"===a?"application/msword":"docx"===a?"application/vnd.openxmlformats-officedocument.wordprocessingml.document":"xls"===a?"application/vnd.ms-excel":"xlsx"===a?"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"csv"===a?"text/csv":"txt"===a?"text/plain":"");if(!_||!o.allowedMimeTypes.has(_)||o.requireMimeType&&!i(s.contentType))throw Error("invalid_incident_evidence_content_type");let v=Number(s.sizeBytes);if(!Number.isFinite(v)||v<=0||v>o.maxBytes)throw Error("invalid_incident_evidence_size");let I=i(s.uploadedAt,l()),y=c(s.uploadedBy||n);return{id:i(s.id||s.recordId,`incident-evidence-${Date.now()}-${t+1}`),name:u.slice(0,180),type:i(s.type,"Incident Evidence").slice(0,80),ref:f,storagePath:p,fileExtension:m,contentType:_,sizeBytes:Math.round(v),uploadedAt:I,uploadedBy:y||c(n)||"system@gmail.com",scanStatus:i(s.scanStatus),scanReference:i(s.scanReference)}})(e,t,p,m)),v=await u(_,p,m),I=l();return _.map(e=>({...e,scanStatus:e.scanStatus||v.status,scanReference:e.scanReference||v.reference,scannedAt:I}))}e.s(["validateIncidentEvidenceDocumentsStrict",()=>f])},11072,e=>{e.v(e=>Promise.resolve().then(()=>e(74405)))}];

//# sourceMappingURL=src_lib_f6da0d21._.js.map