{"version":3,"sources":["../../../src/lib/hris-api.js","../../../src/lib/invite-delivery.js","../../../src/lib/api-authorization.js","../../../src/lib/rbac.js","../../../src/lib/name-utils.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { canAccessResource, hasPermission } from \"@/lib/rbac\";\r\nimport { recordAuditEvent } from \"@/lib/audit-log\";\r\n\r\nconst PRIVILEGED_OWNER_BYPASS_ROLES = [\"SUPER_ADMIN\", \"GRC\", \"HR\", \"EA\"];\r\n\r\nexport function normalizeEmail(value) {\r\n  return String(value || \"\").trim().toLowerCase();\r\n}\r\n\r\nexport function maskValue(value, { start = 2, end = 2, fallback = \"Masked\" } = {}) {\r\n  const raw = String(value || \"\").trim();\r\n  if (!raw) {\r\n    return fallback;\r\n  }\r\n\r\n  if (raw.length <= start + end) {\r\n    return `${raw.slice(0, 1)}***`;\r\n  }\r\n\r\n  return `${raw.slice(0, start)}***${raw.slice(raw.length - end)}`;\r\n}\r\n\r\nexport function isEmployeeRole(role) {\r\n  return String(role || \"\")\r\n    .trim()\r\n    .toUpperCase()\r\n    .startsWith(\"EMPLOYEE_\");\r\n}\r\n\r\nexport function ensureArray(value) {\r\n  return Array.isArray(value) ? value : [];\r\n}\r\n\r\nfunction ensureObject(value, fallback = {}) {\r\n  if (value && typeof value === \"object\" && !Array.isArray(value)) {\r\n    return value;\r\n  }\r\n  return fallback;\r\n}\r\n\r\nfunction asString(value, fallback = \"\") {\r\n  const normalized = String(value || \"\").trim();\r\n  return normalized || fallback;\r\n}\r\n\r\nfunction asNumber(value, fallback = 0) {\r\n  const parsed = Number(value);\r\n  return Number.isFinite(parsed) ? parsed : fallback;\r\n}\r\n\r\nfunction normalizeStringArray(value, { lowercase = false } = {}) {\r\n  const source = Array.isArray(value)\r\n    ? value\r\n    : typeof value === \"string\"\r\n      ? value.split(\",\")\r\n      : [];\r\n  return source\r\n    .map((item) => String(item || \"\").trim())\r\n    .filter(Boolean)\r\n    .map((item) => (lowercase ? item.toLowerCase() : item));\r\n}\r\n\r\nfunction normalizeIncidentEvidenceDocuments(value) {\r\n  const rows = ensureArray(value);\r\n  return rows.map((entry, index) => {\r\n    const item = ensureObject(entry, {});\r\n    return {\r\n      id: asString(item.id || `${index + 1}`),\r\n      name: asString(item.name, \"Incident Evidence\"),\r\n      type: asString(item.type, \"Incident Evidence\"),\r\n      ref: asString(item.ref),\r\n      storagePath: asString(item.storagePath),\r\n      contentType: asString(item.contentType),\r\n      fileExtension: asString(item.fileExtension),\r\n      sizeBytes: asNumber(item.sizeBytes, 0),\r\n      uploadedAt: asString(item.uploadedAt),\r\n      uploadedBy: asString(item.uploadedBy).toLowerCase(),\r\n    };\r\n  });\r\n}\r\n\r\nexport function enrichIncidentRecordForApi(record) {\r\n  const source = ensureObject(record, {});\r\n  const involvedEmployees = normalizeStringArray(source.involvedEmployees, { lowercase: true });\r\n  const alertRecipients = normalizeStringArray(source.alertRecipients, { lowercase: true });\r\n  const evidenceDocuments = normalizeIncidentEvidenceDocuments(source.evidenceDocuments);\r\n  const evidenceDocumentsCount = Math.max(\r\n    evidenceDocuments.length,\r\n    asNumber(source.evidenceDocumentsCount, evidenceDocuments.length),\r\n  );\r\n  const traceability = ensureArray(source.traceability).map((entry) => ensureObject(entry, {}));\r\n  const forensicSummary = ensureObject(source.forensicSummary, {});\r\n  const forensicSnapshot = ensureObject(source.forensicSnapshot, {});\r\n  const alertDispatchSummary = ensureObject(source.alertDispatchSummary, {});\r\n  const externalIntegrations = ensureObject(source.externalIntegrations, {});\r\n\r\n  const normalizedRecord = {\r\n    ...source,\r\n    incidentCode: asString(source.incidentCode),\r\n    title: asString(source.title),\r\n    summary: asString(source.summary),\r\n    incidentType: asString(source.incidentType),\r\n    severity: asString(source.severity),\r\n    status: asString(source.status),\r\n    ownerEmail: asString(source.ownerEmail).toLowerCase(),\r\n    affectedEmployeeEmail: asString(source.affectedEmployeeEmail).toLowerCase(),\r\n    department: asString(source.department),\r\n    involvedEmployees,\r\n    escalationLevel: asString(source.escalationLevel),\r\n    containmentStatus: asString(source.containmentStatus),\r\n    impactAssessmentStatus: asString(source.impactAssessmentStatus),\r\n    regulatoryStatus: asString(source.regulatoryStatus),\r\n    detectedAt: asString(source.detectedAt),\r\n    resolvedAt: asString(source.resolvedAt),\r\n    closedAt: asString(source.closedAt),\r\n    createdAt: asString(source.createdAt),\r\n    updatedAt: asString(source.updatedAt),\r\n    createdBy: asString(source.createdBy).toLowerCase(),\r\n    updatedBy: asString(source.updatedBy).toLowerCase(),\r\n    alertDescription: asString(source.alertDescription),\r\n    alertOccurrenceCount: Math.max(1, asNumber(source.alertOccurrenceCount, 1)),\r\n    alertFirstObservedAt: asString(source.alertFirstObservedAt),\r\n    alertLastObservedAt: asString(source.alertLastObservedAt),\r\n    alertRecipients,\r\n    alertDispatchSummary,\r\n    externalIntegrations,\r\n    forensicSummary,\r\n    forensicSnapshot,\r\n    evidenceDocuments,\r\n    evidenceDocumentsCount,\r\n    traceability,\r\n  };\r\n\r\n  const detailPayload = {\r\n    caseProfile: {\r\n      id: asString(normalizedRecord.id),\r\n      recordId: asString(normalizedRecord.recordId),\r\n      incidentCode: normalizedRecord.incidentCode,\r\n      title: normalizedRecord.title,\r\n      summary: normalizedRecord.summary,\r\n      incidentType: normalizedRecord.incidentType,\r\n      severity: normalizedRecord.severity,\r\n      status: normalizedRecord.status,\r\n      restrictedPiiInvolved: Boolean(source.restrictedPiiInvolved),\r\n      breachConfirmed: Boolean(source.breachConfirmed),\r\n    },\r\n    ownership: {\r\n      ownerEmail: normalizedRecord.ownerEmail,\r\n      affectedEmployeeEmail: normalizedRecord.affectedEmployeeEmail,\r\n      department: normalizedRecord.department,\r\n      involvedEmployees: normalizedRecord.involvedEmployees,\r\n    },\r\n    handling: {\r\n      escalationRequired: Boolean(source.escalationRequired),\r\n      escalationLevel: normalizedRecord.escalationLevel,\r\n      containmentStatus: normalizedRecord.containmentStatus,\r\n      containmentSummary: asString(source.containmentSummary),\r\n      impactAssessmentStatus: normalizedRecord.impactAssessmentStatus,\r\n      impactSummary: asString(source.impactSummary),\r\n      executiveNotificationRequired: Boolean(source.executiveNotificationRequired),\r\n    },\r\n    compliance: {\r\n      regulatoryNotificationRequired: Boolean(source.regulatoryNotificationRequired),\r\n      regulatoryStatus: normalizedRecord.regulatoryStatus,\r\n      regulatoryDueAt: asString(source.regulatoryDueAt),\r\n      regulatoryNotifiedAt: asString(source.regulatoryNotifiedAt),\r\n      affectedIndividualsNotifiedAt: asString(source.affectedIndividualsNotifiedAt),\r\n      documentationRetained: Boolean(source.documentationRetained),\r\n      documentationRetainedAt: asString(source.documentationRetainedAt),\r\n      documentationLocation: asString(source.documentationLocation),\r\n      classificationStandard: asString(source.classificationStandard),\r\n    },\r\n    timeline: {\r\n      detectedAt: normalizedRecord.detectedAt,\r\n      grcAlertedAt: asString(source.grcAlertedAt),\r\n      executiveNotifiedAt: asString(source.executiveNotifiedAt),\r\n      resolvedAt: normalizedRecord.resolvedAt,\r\n      closedAt: normalizedRecord.closedAt,\r\n      createdAt: normalizedRecord.createdAt,\r\n      updatedAt: normalizedRecord.updatedAt,\r\n    },\r\n    evidence: {\r\n      count: normalizedRecord.evidenceDocumentsCount,\r\n      documents: normalizedRecord.evidenceDocuments,\r\n      notes: asString(source.notes),\r\n      correctiveActions: asString(source.correctiveActions),\r\n      disciplinaryActions: asString(source.disciplinaryActions),\r\n      resolutionNotes: asString(source.resolutionNotes),\r\n    },\r\n    alerting: {\r\n      description: normalizedRecord.alertDescription,\r\n      occurrences: normalizedRecord.alertOccurrenceCount,\r\n      firstObservedAt: normalizedRecord.alertFirstObservedAt,\r\n      lastObservedAt: normalizedRecord.alertLastObservedAt,\r\n      recipients: normalizedRecord.alertRecipients,\r\n      dispatchSummary: normalizedRecord.alertDispatchSummary,\r\n      lastAlertDispatchAt: asString(source.lastAlertDispatchAt),\r\n    },\r\n    forensic: {\r\n      windowStart: asString(source.forensicWindowStart),\r\n      windowEnd: asString(source.forensicWindowEnd),\r\n      summary: normalizedRecord.forensicSummary,\r\n      snapshot: normalizedRecord.forensicSnapshot,\r\n    },\r\n    audit: {\r\n      traceability: normalizedRecord.traceability,\r\n      createdBy: normalizedRecord.createdBy,\r\n      updatedBy: normalizedRecord.updatedBy,\r\n    },\r\n  };\r\n\r\n  return {\r\n    ...normalizedRecord,\r\n    details: detailPayload,\r\n  };\r\n}\r\n\r\nexport function parsePositiveInt(value, fallback, { min = 1, max = 1000 } = {}) {\r\n  const parsed = Number.parseInt(String(value || \"\"), 10);\r\n  if (!Number.isFinite(parsed)) {\r\n    return fallback;\r\n  }\r\n  return Math.min(max, Math.max(min, parsed));\r\n}\r\n\r\nexport function paginateRows(rows, { page = 1, pageSize = 20 } = {}) {\r\n  const safePage = parsePositiveInt(page, 1, { min: 1, max: 100000 });\r\n  const safePageSize = parsePositiveInt(pageSize, 20, { min: 1, max: 200 });\r\n  const total = rows.length;\r\n  const totalPages = Math.max(1, Math.ceil(total / safePageSize));\r\n  const currentPage = Math.min(safePage, totalPages);\r\n  const start = (currentPage - 1) * safePageSize;\r\n  const end = start + safePageSize;\r\n  const data = rows.slice(start, end);\r\n\r\n  return {\r\n    data,\r\n    pagination: {\r\n      page: currentPage,\r\n      pageSize: safePageSize,\r\n      total,\r\n      totalPages,\r\n    },\r\n  };\r\n}\r\n\r\nexport async function parseJsonBody(request) {\r\n  try {\r\n    const body = await request.json();\r\n    return body && typeof body === \"object\" ? body : {};\r\n  } catch {\r\n    throw new Error(\"invalid_json_body\");\r\n  }\r\n}\r\n\r\nexport function badRequest(message) {\r\n  return NextResponse.json({ message }, { status: 400 });\r\n}\r\n\r\nexport function forbidden(message = \"Forbidden.\") {\r\n  return NextResponse.json({ message }, { status: 403 });\r\n}\r\n\r\nexport function notFound(message = \"Record not found.\") {\r\n  return NextResponse.json({ message }, { status: 404 });\r\n}\r\n\r\nexport function getSelfRestrictedOwnerEmail({ session, requestedOwnerEmail, fallbackOwnerEmail }) {\r\n  if (!session || !isEmployeeRole(session.role)) {\r\n    const requested = normalizeEmail(requestedOwnerEmail || fallbackOwnerEmail);\r\n    return requested || null;\r\n  }\r\n\r\n  const actorEmail = normalizeEmail(session.email);\r\n  if (!actorEmail) {\r\n    throw new Error(\"employee_session_email_missing\");\r\n  }\r\n\r\n  return actorEmail;\r\n}\r\n\r\nexport function canViewSensitiveEmployeeFields(role) {\r\n  return hasPermission(role, \"employees:view:sensitive\");\r\n}\r\n\r\nexport function sanitizeEmployeeRecordForViewer(record, role) {\r\n  if (!record || typeof record !== \"object\") {\r\n    return record;\r\n  }\r\n\r\n  if (canViewSensitiveEmployeeFields(role)) {\r\n    return record;\r\n  }\r\n\r\n  const maskedGovernmentIds =\r\n    record.governmentIds && typeof record.governmentIds === \"object\"\r\n      ? Object.entries(record.governmentIds).reduce((accumulator, [key, value]) => {\r\n          accumulator[key] = maskValue(value, { start: 2, end: 2 });\r\n          return accumulator;\r\n        }, {})\r\n      : {};\r\n\r\n  const payrollInformation =\r\n    record.payrollInformation && typeof record.payrollInformation === \"object\"\r\n      ? Object.keys(record.payrollInformation).reduce((accumulator, key) => {\r\n          accumulator[key] = \"Restricted\";\r\n          return accumulator;\r\n        }, {})\r\n      : {};\r\n\r\n  return {\r\n    ...record,\r\n    govId: maskValue(record.govId, { start: 2, end: 2 }),\r\n    governmentIds: maskedGovernmentIds,\r\n    payrollInformation,\r\n  };\r\n}\r\n\r\nexport function canActorAccessOwner({\r\n  session,\r\n  ownerEmail,\r\n  ownerBypassRoles = PRIVILEGED_OWNER_BYPASS_ROLES,\r\n}) {\r\n  const owner = normalizeEmail(ownerEmail);\r\n  if (!owner) {\r\n    return false;\r\n  }\r\n\r\n  return canAccessResource({\r\n    role: session.role,\r\n    actorIdentifier: session.email,\r\n    ownerIdentifier: owner,\r\n    allowRoles: ownerBypassRoles,\r\n  });\r\n}\r\n\r\nexport function canActorEditModule({\r\n  role,\r\n  editPermission,\r\n  selfEditPermission,\r\n  isSelfResource,\r\n}) {\r\n  if (hasPermission(role, editPermission)) {\r\n    return true;\r\n  }\r\n\r\n  if (isSelfResource && selfEditPermission && hasPermission(role, selfEditPermission)) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function mapBackendError(reason, fallbackMessage) {\r\n  const normalized = String(reason || \"\").trim();\r\n  switch (normalized) {\r\n    case \"invalid_json_body\":\r\n      return { status: 400, message: \"Invalid request payload.\" };\r\n    case \"invalid_record_id\":\r\n      return { status: 400, message: \"Invalid record identifier.\" };\r\n    case \"invalid_employee_email\":\r\n      return { status: 400, message: \"Employee email is required.\" };\r\n    case \"employee_account_not_found\":\r\n      return {\r\n        status: 409,\r\n        message: \"No user account found for this employee email. Invite or activate the user account first.\",\r\n      };\r\n    case \"invalid_target_role\":\r\n      return {\r\n        status: 400,\r\n        message: \"Target role is required and must be a valid system role.\",\r\n      };\r\n    case \"forbidden_target_role\":\r\n      return {\r\n        status: 403,\r\n        message: \"Target role assignment is not allowed by lifecycle permission policy.\",\r\n      };\r\n    case \"role_sync_failed\":\r\n      return {\r\n        status: 409,\r\n        message: \"Employee user account was not found. Invite or activate the account before applying role changes.\",\r\n      };\r\n    case \"approval_required\":\r\n      return {\r\n        status: 409,\r\n        message: \"Workflow approval chain must be completed before setting this status.\",\r\n      };\r\n    case \"invalid_workflow_action\":\r\n      return {\r\n        status: 400,\r\n        message: \"Invalid workflow action payload.\",\r\n      };\r\n    case \"invalid_approval_decision\":\r\n      return {\r\n        status: 400,\r\n        message: \"Approval decision must be approve or reject.\",\r\n      };\r\n    case \"no_pending_approval_step\":\r\n      return {\r\n        status: 409,\r\n        message: \"No pending approval step remains for this workflow.\",\r\n      };\r\n    case \"approval_not_allowed_for_role\":\r\n      return {\r\n        status: 403,\r\n        message: \"Current role is not allowed to approve the active step.\",\r\n      };\r\n    case \"lifecycle_required_evidence_missing\":\r\n      return {\r\n        status: 409,\r\n        message:\r\n          \"Required supporting documents are missing for this lifecycle category. Attach all required evidence before setting final status.\",\r\n      };\r\n    case \"invalid_template_name\":\r\n      return { status: 400, message: \"Template name is required.\" };\r\n    case \"invalid_export_dataset\":\r\n      return { status: 400, message: \"Export dataset is required.\" };\r\n    case \"invalid_incident_title\":\r\n      return { status: 400, message: \"Incident title is required.\" };\r\n    case \"invalid_incident_evidence_payload\":\r\n      return { status: 400, message: \"Incident evidence payload must be a valid document array.\" };\r\n    case \"invalid_incident_evidence_name\":\r\n      return { status: 400, message: \"Incident evidence file name is required.\" };\r\n    case \"invalid_incident_evidence_reference\":\r\n      return { status: 400, message: \"Incident evidence must include a valid file reference.\" };\r\n    case \"invalid_incident_evidence_extension\":\r\n      return { status: 400, message: \"Incident evidence file extension is not allowed.\" };\r\n    case \"invalid_incident_evidence_content_type\":\r\n      return { status: 400, message: \"Incident evidence MIME type is not allowed.\" };\r\n    case \"invalid_incident_evidence_size\":\r\n      return { status: 400, message: \"Incident evidence file size exceeds the allowed limit.\" };\r\n    case \"incident_evidence_av_not_configured\":\r\n      return { status: 503, message: \"Evidence security scan provider is not configured.\" };\r\n    case \"incident_evidence_av_hook_failed\":\r\n      return { status: 502, message: \"Evidence security scan failed. Retry after security provider is available.\" };\r\n    case \"incident_evidence_av_blocked\":\r\n      return { status: 403, message: \"Evidence file blocked by malware/security policy scan.\" };\r\n    case \"invalid_reference_kind\":\r\n      return { status: 400, message: \"Reference type is invalid.\" };\r\n    case \"invalid_reference_label\":\r\n      return {\r\n        status: 400,\r\n        message: \"Reference label is required and must be within the allowed length.\",\r\n      };\r\n    case \"invalid_retention_module\":\r\n      return {\r\n        status: 400,\r\n        message: \"Retention module filter is invalid.\",\r\n      };\r\n    case \"invalid_purge_confirmation\":\r\n      return {\r\n        status: 400,\r\n        message: \"Invalid purge confirmation phrase.\",\r\n      };\r\n    case \"duplicate_reference_value\":\r\n      return {\r\n        status: 409,\r\n        message: \"Reference value already exists.\",\r\n      };\r\n    case \"immutable_reference_item\":\r\n      return {\r\n        status: 403,\r\n        message: \"System reference values cannot be removed.\",\r\n      };\r\n    case \"access_revocation_failed\":\r\n      return {\r\n        status: 409,\r\n        message:\r\n          \"Access revocation could not be confirmed for this employee account. Retry offboarding or review account status.\",\r\n      };\r\n    case \"account_activation_failed\":\r\n      return {\r\n        status: 409,\r\n        message: \"Account activation could not be confirmed for this employee account.\",\r\n      };\r\n    case \"email_provider_not_configured\":\r\n      return {\r\n        status: 502,\r\n        message:\r\n          \"Email provider is not configured. Set CLIO_EMAIL_PROVIDER=firebase and configure Firebase Authentication email template/SMTP settings.\",\r\n      };\r\n    case \"firebase_api_key_not_configured\":\r\n      return {\r\n        status: 502,\r\n        message: \"Firebase API key is not configured. Set NEXT_PUBLIC_FIREBASE_API_KEY.\",\r\n      };\r\n    case \"firebase_email_provider_not_enabled\":\r\n      return {\r\n        status: 502,\r\n        message: \"Firebase email-link provider is not enabled. Enable Email link (passwordless sign-in) in Firebase Authentication.\",\r\n      };\r\n    case \"firebase_continue_url_invalid\":\r\n      return {\r\n        status: 502,\r\n        message:\r\n          \"Firebase continue URL is invalid. Check NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN (or CLIO_APP_BASE_URL override) and authorize the domain in Firebase Authentication.\",\r\n      };\r\n    case \"unsafe_app_base_url_for_production\":\r\n      return {\r\n        status: 502,\r\n        message:\r\n          \"Invite base URL is unsafe for production (localhost). Remove CLIO_APP_BASE_URL/NEXT_PUBLIC_APP_URL localhost overrides and use NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN.\",\r\n      };\r\n    case \"unsupported_email_provider\":\r\n      return {\r\n        status: 502,\r\n        message: \"Unsupported email provider configuration.\",\r\n      };\r\n    case \"email_delivery_failed\":\r\n      return {\r\n        status: 502,\r\n        message: \"Unable to deliver invite email.\",\r\n      };\r\n    case \"firestore_not_configured\":\n      return {\n        status: 503,\n        message:\n          \"Database is not configured. Set Firebase environment variables and restart the app.\",\n      };\n    case \"firestore_operation_failed\":\n      return {\n        status: 503,\n        message:\n          \"Database operation failed. Retry after Firestore is available.\",\n      };\n    case \"employee_session_email_missing\":\r\n      return {\r\n        status: 401,\r\n        message: \"Session is invalid. Sign in again.\",\r\n      };\r\n    default:\r\n      return { status: 400, message: fallbackMessage || \"Unable to process request.\" };\r\n  }\r\n}\r\n\r\nfunction normalizeAuditTextValue(value) {\r\n  return String(value || \"\").trim();\r\n}\r\n\r\nfunction toComparableAuditValue(value) {\r\n  if (value == null) {\r\n    return null;\r\n  }\r\n  if (Array.isArray(value)) {\r\n    return value.map((entry) => toComparableAuditValue(entry));\r\n  }\r\n  if (typeof value === \"object\") {\r\n    return Object.keys(value)\r\n      .sort()\r\n      .reduce((accumulator, key) => {\r\n        accumulator[key] = toComparableAuditValue(value[key]);\r\n        return accumulator;\r\n      }, {});\r\n  }\r\n  if (typeof value === \"string\") {\r\n    return value.trim();\r\n  }\r\n  return value;\r\n}\r\n\r\nexport function areAuditValuesEqual(left, right) {\r\n  return JSON.stringify(toComparableAuditValue(left)) === JSON.stringify(toComparableAuditValue(right));\r\n}\r\n\r\nexport function resolveAuditChangedFields(previousRecord, nextRecord, candidateFields = []) {\r\n  const fields = Array.isArray(candidateFields) ? candidateFields : [];\r\n  return fields.filter((field) => !areAuditValuesEqual(previousRecord?.[field], nextRecord?.[field]));\r\n}\r\n\r\nexport function resolveAuditViewedFields(record, excludeFields = []) {\r\n  if (!record || typeof record !== \"object\") {\r\n    return [];\r\n  }\r\n  const exclude = new Set(\r\n    (Array.isArray(excludeFields) ? excludeFields : []).map((field) => normalizeAuditTextValue(field)),\r\n  );\r\n  return Object.keys(record)\r\n    .filter((field) => !exclude.has(field))\r\n    .sort();\r\n}\r\n\r\nexport function resolveAuditRecordRef(record, fallbackRecordId = \"\", candidateKeys = []) {\r\n  const keys = Array.isArray(candidateKeys) ? candidateKeys : [];\r\n  const defaultCandidates = [\r\n    record?.employeeId,\r\n    record?.workflowId,\r\n    record?.lifecycleId,\r\n    record?.templateId,\r\n    record?.exportId,\r\n    record?.id,\r\n    fallbackRecordId,\r\n  ];\r\n  for (const key of keys) {\r\n    const fromRecord = normalizeAuditTextValue(record?.[key]);\r\n    if (fromRecord) {\r\n      return fromRecord;\r\n    }\r\n  }\r\n  for (const candidate of defaultCandidates) {\r\n    const normalized = normalizeAuditTextValue(candidate);\r\n    if (normalized) {\r\n      return normalized;\r\n    }\r\n  }\r\n  return \"N/A\";\r\n}\r\n\r\nexport function summarizeAuditFieldList(fields = [], emptyFallback = \"No field details recorded.\") {\r\n  const normalized = ensureArray(fields)\r\n    .map((field) => normalizeAuditTextValue(field))\r\n    .filter(Boolean);\r\n  if (normalized.length === 0) {\r\n    return emptyFallback;\r\n  }\r\n  return normalized.join(\", \");\r\n}\r\n\r\nexport async function logApiAudit({\r\n  request,\r\n  module,\r\n  activityName,\r\n  status = \"Completed\",\r\n  sensitivity = \"Sensitive\",\r\n  performedBy = \"system@gmail.com\",\r\n  metadata,\r\n}) {\r\n  const shouldWriteAsync =\r\n    process.env.CLIO_AUDIT_ASYNC === \"true\" ||\r\n    (process.env.CLIO_AUDIT_ASYNC !== \"false\" && process.env.NODE_ENV !== \"production\");\r\n\r\n  const writePromise = recordAuditEvent({\r\n    activityName,\r\n    status,\r\n    module,\r\n    performedBy,\r\n    sensitivity,\r\n    metadata,\r\n    request,\r\n  }).catch(() => null);\r\n\r\n  if (shouldWriteAsync) {\r\n    return;\r\n  }\r\n\r\n  await writePromise;\r\n}\r\n","function normalizeEmailProvider(rawValue) {\r\n  const raw = String(rawValue || \"\")\r\n    .trim()\r\n    .toLowerCase();\r\n  if (!raw) {\r\n    return \"\";\r\n  }\r\n\r\n  if (raw === \"firebase\" || raw.includes(\"firebase\")) {\r\n    return \"firebase\";\r\n  }\r\n\r\n  if (raw === \"resend\" || raw.includes(\"resend\")) {\r\n    return \"resend\";\r\n  }\r\n\r\n  if (raw === \"console\" || raw === \"dev\" || raw.includes(\"console\")) {\r\n    return \"console\";\r\n  }\r\n\r\n  return raw;\r\n}\r\n\r\nfunction getEmailProvider() {\r\n  const configured = normalizeEmailProvider(process.env.CLIO_EMAIL_PROVIDER);\r\n  if (configured) {\r\n    return configured;\r\n  }\r\n\r\n  const hasResendConfig =\r\n    String(process.env.RESEND_API_KEY || \"\").trim().startsWith(\"re_\") &&\r\n    String(process.env.CLIO_EMAIL_FROM || \"\").trim().length > 0;\r\n  if (hasResendConfig) {\r\n    return \"resend\";\r\n  }\r\n\r\n  return \"firebase\";\r\n}\r\n\r\nfunction isConsoleEmailAllowed() {\r\n  return String(process.env.CLIO_ALLOW_CONSOLE_EMAIL || \"\")\r\n    .trim()\r\n    .toLowerCase() === \"true\";\r\n}\r\n\r\nfunction normalizeBaseUrl(value) {\r\n  const raw = String(value || \"\").trim();\r\n  if (!raw) {\r\n    return \"\";\r\n  }\r\n\r\n  if (raw.startsWith(\"http://\") || raw.startsWith(\"https://\")) {\r\n    return raw.replace(/\\/+$/, \"\");\r\n  }\r\n\r\n  return `https://${raw.replace(/^\\/+/, \"\").replace(/\\/+$/, \"\")}`;\r\n}\r\n\r\nfunction assertSafeProductionBaseUrl(baseUrl) {\r\n  if (process.env.NODE_ENV !== \"production\") {\r\n    return;\r\n  }\r\n\r\n  let parsed;\r\n  try {\r\n    parsed = new URL(baseUrl);\r\n  } catch {\r\n    throw new Error(\"app_base_url_not_configured\");\r\n  }\r\n\r\n  const hostname = String(parsed.hostname || \"\").trim().toLowerCase();\r\n  const isLocalHost =\r\n    hostname === \"localhost\" ||\r\n    hostname === \"127.0.0.1\" ||\r\n    hostname === \"::1\" ||\r\n    hostname.endsWith(\".local\");\r\n\r\n  if (isLocalHost) {\r\n    throw new Error(\"unsafe_app_base_url_for_production\");\r\n  }\r\n}\r\n\r\nfunction getAppBaseUrl({ requestOrigin } = {}) {\r\n  const requestOriginUrl = normalizeBaseUrl(requestOrigin);\r\n  const firebaseAuthDomain = normalizeBaseUrl(\r\n    process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN || process.env.FIREBASE_AUTH_DOMAIN,\r\n  );\r\n  const vercelUrl = normalizeBaseUrl(\r\n    process.env.VERCEL_PROJECT_PRODUCTION_URL || process.env.VERCEL_URL,\r\n  );\r\n  const configured = normalizeBaseUrl(process.env.CLIO_APP_BASE_URL);\r\n  const publicSiteUrl = normalizeBaseUrl(process.env.NEXT_PUBLIC_APP_URL);\r\n\r\n  const candidates =\r\n    process.env.NODE_ENV === \"production\"\r\n      ? [requestOriginUrl, configured, publicSiteUrl, vercelUrl, firebaseAuthDomain]\r\n      : [requestOriginUrl, configured, publicSiteUrl, firebaseAuthDomain, vercelUrl];\r\n\r\n  for (const candidate of candidates) {\r\n    if (!candidate) {\r\n      continue;\r\n    }\r\n    assertSafeProductionBaseUrl(candidate);\r\n    return candidate;\r\n  }\r\n\r\n  throw new Error(\"app_base_url_not_configured\");\r\n}\r\n\r\nfunction getLoginPath() {\r\n  const configured = String(process.env.CLIO_LOGIN_PATH || \"\").trim();\r\n  if (!configured) {\r\n    return \"/login\";\r\n  }\r\n  return configured.startsWith(\"/\") ? configured : `/${configured}`;\r\n}\r\n\r\nfunction getInviteVerifyPath() {\r\n  const configured = String(process.env.CLIO_INVITE_VERIFY_PATH || \"\").trim();\r\n  if (!configured) {\r\n    return \"/verify-invite\";\r\n  }\r\n  return configured.startsWith(\"/\") ? configured : `/${configured}`;\r\n}\r\n\r\nfunction buildLoginUrl(baseUrl) {\r\n  return `${baseUrl}${getLoginPath()}`;\r\n}\r\n\r\nfunction buildInviteVerificationUrl(inviteToken, baseUrl) {\r\n  const path = getInviteVerifyPath();\r\n  const token = String(inviteToken || \"\").trim();\r\n  if (!token) {\r\n    throw new Error(\"invalid_invite_token\");\r\n  }\r\n  return `${baseUrl}${path}?token=${encodeURIComponent(token)}`;\r\n}\r\n\r\nfunction isDevelopmentPreviewEnabled() {\r\n  return process.env.NODE_ENV !== \"production\";\r\n}\r\n\r\nfunction escapeHtml(value) {\r\n  return String(value || \"\")\r\n    .replaceAll(\"&\", \"&amp;\")\r\n    .replaceAll(\"<\", \"&lt;\")\r\n    .replaceAll(\">\", \"&gt;\")\r\n    .replaceAll('\"', \"&quot;\")\r\n    .replaceAll(\"'\", \"&#39;\");\r\n}\r\n\r\nfunction buildEmailContent({ role, invitedBy, verifyUrl, loginUrl, expiresAt }) {\r\n  const expirationDate = new Date(expiresAt);\r\n  const readableExpiration = Number.isNaN(expirationDate.getTime())\r\n    ? expiresAt\r\n    : expirationDate.toLocaleString(\"en-US\", {\r\n        month: \"short\",\r\n        day: \"2-digit\",\r\n        year: \"numeric\",\r\n        hour: \"2-digit\",\r\n        minute: \"2-digit\",\r\n      });\r\n\r\n  const roleText = String(role || \"Employee\").trim() || \"Employee\";\r\n  const invitedByText = String(invitedBy || \"CLIO Administrator\").trim() || \"CLIO Administrator\";\r\n  const brandDomain = String(process.env.CLIO_EMAIL_BRAND_DOMAIN || \"cisoasaservice.io\").trim() || \"cisoasaservice.io\";\r\n  const safeRole = escapeHtml(roleText);\r\n  const safeInvitedBy = escapeHtml(invitedByText);\r\n  const safeVerifyUrl = escapeHtml(verifyUrl);\r\n  const safeLoginUrl = escapeHtml(loginUrl);\r\n  const safeReadableExpiration = escapeHtml(readableExpiration);\r\n  const safeBrandDomain = escapeHtml(brandDomain);\r\n\r\n  const subject = \"You're invited to verify your email and open your Clio account\";\r\n  const text = [\r\n    \"You have been invited to Clio Secured HRIS.\",\r\n    \"\",\r\n    \"To open your account, please verify your email first.\",\r\n    `Verify your Clio account: ${verifyUrl}`,\r\n    `Sign in after verification: ${loginUrl}`,\r\n    \"\",\r\n    `Assigned role: ${roleText}`,\r\n    `Invited by: ${invitedByText}`,\r\n    `Invitation expires: ${readableExpiration}`,\r\n    \"\",\r\n    \"For security, complete SMS OTP after email verification.\",\r\n    \"Use the same invited work email when signing in.\",\r\n    \"\",\r\n    `Domain: ${brandDomain}`,\r\n  ].join(\"\\n\");\r\n\r\n  return {\r\n    subject,\r\n    text,\r\n    html: [\r\n      \"<div style=\\\"font-family:Arial,sans-serif;line-height:1.6;color:#0f172a;max-width:620px\\\">\",\r\n      \"<p style=\\\"margin:0 0 12px 0\\\">Hello,</p>\",\r\n      \"<p style=\\\"margin:0 0 12px 0\\\">You have been invited to <strong>Clio Secured HRIS</strong>.</p>\",\r\n      \"<p style=\\\"margin:0 0 16px 0\\\">To open your account, please verify your email and complete secure onboarding.</p>\",\r\n      `<p style=\"margin:0 0 16px 0\"><a href=\"${safeVerifyUrl}\" style=\"display:inline-block;background:#0f6bcf;color:#ffffff;text-decoration:none;padding:10px 18px;border-radius:10px;font-weight:600\">Verify Clio Account</a></p>`,\r\n      `<p style=\"margin:0 0 12px 0\"><strong>Assigned role:</strong> ${safeRole}<br/>`,\r\n      `<strong>Invited by:</strong> ${safeInvitedBy}<br/>`,\r\n      `<strong>Invitation expires:</strong> ${safeReadableExpiration}</p>`,\r\n      `<p style=\"margin:0 0 12px 0\">After verification, sign in here: <a href=\"${safeLoginUrl}\">${safeLoginUrl}</a></p>`,\r\n      `<p style=\"margin:0 0 12px 0\">For security, complete SMS OTP after email verification and use the same invited work email.</p>`,\r\n      `<p style=\"margin:0;color:#475569;font-size:12px\">This invitation is intended for authorized recipients of ${safeBrandDomain}.</p>`,\r\n      \"</div>\",\r\n    ].join(\"\"),\r\n  };\r\n}\r\n\r\nfunction parseFirebaseAuthError(payload) {\r\n  const code = String(payload?.error?.message || \"\").trim();\r\n  if (!code) {\r\n    return \"email_delivery_failed\";\r\n  }\r\n  if (code === \"OPERATION_NOT_ALLOWED\") {\r\n    return \"firebase_email_provider_not_enabled\";\r\n  }\r\n  if (code === \"MISSING_CONTINUE_URI\" || code === \"INVALID_CONTINUE_URI\") {\r\n    return \"firebase_continue_url_invalid\";\r\n  }\r\n  if (code === \"INVALID_EMAIL\") {\r\n    return \"invalid_email\";\r\n  }\r\n  if (code === \"PROJECT_NOT_FOUND\" || code === \"API_KEY_INVALID\") {\r\n    return \"firebase_api_key_not_configured\";\r\n  }\r\n  return \"email_delivery_failed\";\r\n}\r\n\r\nasync function sendViaFirebaseAuth({ toEmail, verifyUrl }) {\r\n  const apiKey = String(process.env.NEXT_PUBLIC_FIREBASE_API_KEY || \"\").trim();\r\n  if (!apiKey) {\r\n    throw new Error(\"firebase_api_key_not_configured\");\r\n  }\r\n\r\n  const response = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:sendOobCode?key=${apiKey}`, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n    },\r\n    body: JSON.stringify({\r\n      requestType: \"EMAIL_SIGNIN\",\r\n      email: toEmail,\r\n      continueUrl: verifyUrl,\r\n      canHandleCodeInApp: true,\r\n    }),\r\n  });\r\n\r\n  const payload = await response.json().catch(() => ({}));\r\n  if (!response.ok) {\r\n    throw new Error(parseFirebaseAuthError(payload));\r\n  }\r\n\r\n  return {\r\n    provider: \"firebase\",\r\n    status: \"sent\",\r\n    messageId: `firebase-${Date.now()}`,\r\n  };\r\n}\r\n\r\nasync function sendViaResend({ toEmail, subject, html, text }) {\r\n  const apiKey = String(process.env.RESEND_API_KEY || \"\").trim();\r\n  const fromAddress = String(process.env.CLIO_EMAIL_FROM || \"\").trim();\r\n  if (!apiKey || !fromAddress || !apiKey.startsWith(\"re_\")) {\r\n    throw new Error(\"email_provider_not_configured\");\r\n  }\r\n\r\n  const response = await fetch(\"https://api.resend.com/emails\", {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      Authorization: `Bearer ${apiKey}`,\r\n    },\r\n    body: JSON.stringify({\r\n      from: fromAddress,\r\n      to: [toEmail],\r\n      subject,\r\n      html,\r\n      text,\r\n    }),\r\n  });\r\n\r\n  if (!response.ok) {\r\n    const payload = await response.json().catch(() => ({}));\r\n    const providerMessage =\r\n      typeof payload?.message === \"string\"\r\n        ? payload.message\r\n        : typeof payload?.error?.message === \"string\"\r\n          ? payload.error.message\r\n          : \"\";\r\n    throw new Error(\r\n      providerMessage ? `email_delivery_failed:${providerMessage}` : \"email_delivery_failed\",\r\n    );\r\n  }\r\n\r\n  const payload = await response.json().catch(() => ({}));\r\n  return {\r\n    provider: \"resend\",\r\n    status: \"sent\",\r\n    messageId: typeof payload?.id === \"string\" ? payload.id : `resend-${Date.now()}`,\r\n  };\r\n}\r\n\r\nfunction sendViaConsole({ toEmail, subject, verifyUrl, loginUrl }) {\r\n  const messageId = `console-${Date.now()}`;\r\n  if (isDevelopmentPreviewEnabled()) {\r\n    console.info(\"[CLIO:InviteEmail]\", {\r\n      toEmail,\r\n      subject,\r\n      verifyUrl,\r\n      loginUrl,\r\n      messageId,\r\n    });\r\n  }\r\n\r\n  return {\r\n    provider: \"console\",\r\n    status: \"simulated\",\r\n    messageId,\r\n    previewUrl: verifyUrl,\r\n    loginUrl,\r\n  };\r\n}\r\n\r\nexport async function deliverInviteEmail({\r\n  toEmail,\r\n  role,\r\n  invitedBy,\r\n  expiresAt,\r\n  inviteToken,\r\n  requestOrigin = \"\",\r\n}) {\r\n  const baseUrl = getAppBaseUrl({ requestOrigin });\r\n  const verifyUrl = buildInviteVerificationUrl(inviteToken, baseUrl);\r\n  const loginUrl = buildLoginUrl(baseUrl);\r\n  const content = buildEmailContent({\r\n    role,\r\n    invitedBy,\r\n    verifyUrl,\r\n    loginUrl,\r\n    expiresAt,\r\n  });\r\n  const provider = getEmailProvider();\r\n\r\n  if (provider === \"firebase\") {\r\n    return await sendViaFirebaseAuth({\r\n      toEmail,\r\n      verifyUrl,\r\n    });\r\n  }\r\n\r\n  if (provider === \"resend\") {\r\n    return await sendViaResend({\r\n      toEmail,\r\n      subject: content.subject,\r\n      html: content.html,\r\n      text: content.text,\r\n    });\r\n  }\r\n\r\n  if (provider === \"console\") {\r\n    if (!isConsoleEmailAllowed()) {\r\n      throw new Error(\"email_provider_not_configured\");\r\n    }\r\n\r\n    return sendViaConsole({\r\n      toEmail,\r\n      subject: content.subject,\r\n      verifyUrl,\r\n      loginUrl,\r\n    });\r\n  }\r\n\r\n  throw new Error(\"unsupported_email_provider\");\r\n}\r\n","import { NextResponse } from \"next/server\";\r\nimport { SESSION_COOKIE_NAME, verifySessionToken } from \"@/lib/auth-session\";\r\nimport { normalizeRole } from \"@/lib/hris\";\r\nimport { canAccessResource, hasPermission } from \"@/lib/rbac\";\r\nimport { recordAuditEvent } from \"@/lib/audit-log\";\r\nimport { getLoginAccount } from \"@/lib/user-accounts\";\r\n\r\nfunction deny(status, message) {\r\n  return { error: NextResponse.json({ message }, { status }) };\r\n}\r\n\r\nexport async function authorizeApiRequest(\r\n  request,\r\n  {\r\n    allowedRoles,\r\n    requiredPermissions = [],\r\n    ownerIdentifier,\r\n    ownerBypassRoles = [\"SUPER_ADMIN\"],\r\n    auditModule = \"Authorization\",\r\n    auditAction = \"API access check\",\r\n  } = {},\r\n) {\r\n  const token = request.cookies.get(SESSION_COOKIE_NAME)?.value;\r\n  const rawSession = verifySessionToken(token);\r\n\r\n  if (!rawSession) {\r\n    await recordAuditEvent({\r\n      activityName: `${auditAction} denied (no active session)`,\r\n      status: \"Failed\",\r\n      module: auditModule,\r\n      performedBy: \"anonymous@gmail.com\",\r\n      sensitivity: \"Sensitive\",\r\n      metadata: {\r\n        reason: \"unauthorized\",\r\n      },\r\n      request,\r\n    });\r\n\r\n    return deny(401, \"Unauthorized.\");\r\n  }\r\n\r\n  const session = {\r\n    ...rawSession,\r\n    role: normalizeRole(rawSession.role),\r\n  };\r\n\r\n  const account = await getLoginAccount(session.email).catch(() => null);\r\n  if (!account) {\r\n    await recordAuditEvent({\r\n      activityName: `${auditAction} denied (account not found)`,\r\n      status: \"Failed\",\r\n      module: auditModule,\r\n      performedBy: session.email,\r\n      sensitivity: \"Sensitive\",\r\n      metadata: {\r\n        reason: \"account_not_found\",\r\n      },\r\n      request,\r\n    });\r\n\r\n    return deny(401, \"Session is no longer valid. Please sign in again.\");\r\n  }\r\n\r\n  if (account.status !== \"active\") {\r\n    await recordAuditEvent({\r\n      activityName: `${auditAction} blocked by account status`,\r\n      status: \"Rejected\",\r\n      module: auditModule,\r\n      performedBy: session.email,\r\n      sensitivity: \"Sensitive\",\r\n      metadata: {\r\n        reason: \"account_not_active\",\r\n        accountStatus: account.status,\r\n      },\r\n      request,\r\n    });\r\n\r\n    return deny(403, \"Account is not active.\");\r\n  }\r\n\r\n  const accountRole = normalizeRole(account.role);\r\n  const accountSessionVersion = Number.parseInt(String(account.sessionVersion ?? \"\"), 10) || 1;\r\n  const allowsRoleContextSwitch = accountRole === \"SUPER_ADMIN\";\r\n  const roleMismatch = session.role !== accountRole;\r\n  const staleSessionVersion = session.sessionVersion !== accountSessionVersion;\r\n  if (staleSessionVersion || (roleMismatch && !allowsRoleContextSwitch)) {\r\n    await recordAuditEvent({\r\n      activityName: `${auditAction} denied (stale session)`,\r\n      status: \"Rejected\",\r\n      module: auditModule,\r\n      performedBy: session.email,\r\n      sensitivity: \"Sensitive\",\r\n      metadata: {\r\n        reason: staleSessionVersion ? \"session_version_mismatch\" : \"session_role_mismatch\",\r\n        tokenRole: session.role,\r\n        accountRole,\r\n        tokenSessionVersion: session.sessionVersion,\r\n        accountSessionVersion,\r\n      },\r\n      request,\r\n    });\r\n\r\n    return deny(401, \"Session expired. Please sign in again.\");\r\n  }\r\n\r\n  if (Array.isArray(allowedRoles) && allowedRoles.length > 0 && !allowedRoles.includes(session.role)) {\r\n    await recordAuditEvent({\r\n      activityName: `${auditAction} blocked by role policy`,\r\n      status: \"Rejected\",\r\n      module: auditModule,\r\n      performedBy: session.email,\r\n      sensitivity: \"Sensitive\",\r\n      metadata: {\r\n        role: session.role,\r\n        allowedRoles,\r\n        reason: \"role_not_allowed\",\r\n      },\r\n      request,\r\n    });\r\n\r\n    return deny(403, \"Forbidden.\");\r\n  }\r\n\r\n  if (requiredPermissions.length > 0) {\r\n    const hasAllPermissions = requiredPermissions.every((permission) =>\r\n      hasPermission(session.role, permission),\r\n    );\r\n\r\n    if (!hasAllPermissions) {\r\n      await recordAuditEvent({\r\n        activityName: `${auditAction} blocked by permission policy`,\r\n        status: \"Rejected\",\r\n        module: auditModule,\r\n        performedBy: session.email,\r\n        sensitivity: \"Sensitive\",\r\n        metadata: {\r\n          role: session.role,\r\n          requiredPermissions,\r\n          reason: \"missing_permission\",\r\n        },\r\n        request,\r\n      });\r\n\r\n      return deny(403, \"Forbidden.\");\r\n    }\r\n  }\r\n\r\n  if (ownerIdentifier) {\r\n    const actorEmail = session.email;\r\n    const ownerEmail = typeof ownerIdentifier === \"function\" ? await ownerIdentifier(session) : ownerIdentifier;\r\n\r\n    if (\r\n      !canAccessResource({\r\n        role: session.role,\r\n        actorIdentifier: actorEmail,\r\n        ownerIdentifier: ownerEmail,\r\n        allowRoles: ownerBypassRoles,\r\n      })\r\n    ) {\r\n      await recordAuditEvent({\r\n        activityName: `${auditAction} blocked by ownership policy`,\r\n        status: \"Rejected\",\r\n        module: auditModule,\r\n        performedBy: session.email,\r\n        sensitivity: \"Sensitive\",\r\n        metadata: {\r\n          role: session.role,\r\n          ownerIdentifier: ownerEmail,\r\n          reason: \"ownership_validation_failed\",\r\n        },\r\n        request,\r\n      });\r\n\r\n      return deny(403, \"Forbidden.\");\r\n    }\r\n  }\r\n\r\n  return { session };\r\n}\r\n\r\n","import { MODULE_ACCESS } from \"@/features/hris/constants\";\r\nimport { normalizeRole } from \"@/lib/hris\";\r\n\r\nconst ROLE_PERMISSIONS = {\r\n  SUPER_ADMIN: [\"*\"],\r\n  GRC: [\r\n    \"dashboard:view\",\r\n    \"employees:view\",\r\n    \"employees:edit\",\r\n    \"employees:view:sensitive\",\r\n    \"lifecycle:view\",\r\n    \"lifecycle:edit\",\r\n    \"lifecycle:approve\",\r\n    \"attendance:view\",\r\n    \"attendance:edit\",\r\n    \"attendance:approve\",\r\n    \"performance:view\",\r\n    \"performance:edit\",\r\n    \"performance:approve\",\r\n    \"templates:view\",\r\n    \"templates:edit\",\r\n    \"exports:view\",\r\n    \"exports:manage\",\r\n    \"exports:approve\",\r\n    \"exports:request\",\r\n    \"activity_log:export\",\r\n    \"activity_log:view\",\r\n    \"audit:view\",\r\n    \"access_management:view\",\r\n    \"retention_archive:view\",\r\n    \"retention_archive:manage\",\r\n    \"incident_management:view\",\r\n    \"incident_management:edit\",\r\n    \"user_management:view\",\r\n    \"user_management:manage\",\r\n    \"settings:view\",\r\n    \"audit:write:nonsensitive\",\r\n    \"auth:logout\",\r\n    \"resource:own\",\r\n  ],\r\n  HR: [\r\n    \"dashboard:view\",\r\n    \"employees:view\",\r\n    \"employees:edit\",\r\n    \"employees:view:sensitive\",\r\n    \"lifecycle:view\",\r\n    \"lifecycle:edit\",\r\n    \"lifecycle:approve\",\r\n    \"attendance:view\",\r\n    \"attendance:edit\",\r\n    \"attendance:approve\",\r\n    \"performance:view\",\r\n    \"performance:edit\",\r\n    \"performance:approve\",\r\n    \"templates:view\",\r\n    \"templates:edit\",\r\n    \"exports:view\",\r\n    \"exports:manage\",\r\n    \"exports:approve\",\r\n    \"exports:request\",\r\n    \"activity_log:export\",\r\n    \"settings:view\",\r\n    \"audit:write:nonsensitive\",\r\n    \"auth:logout\",\r\n    \"resource:own\",\r\n  ],\r\n  EA: [\r\n    \"dashboard:view\",\r\n    \"employees:view\",\r\n    \"employees:edit\",\r\n    \"employees:view:sensitive\",\r\n    \"lifecycle:view\",\r\n    \"lifecycle:edit\",\r\n    \"lifecycle:approve\",\r\n    \"attendance:view\",\r\n    \"attendance:edit\",\r\n    \"attendance:approve\",\r\n    \"performance:view\",\r\n    \"performance:edit\",\r\n    \"performance:approve\",\r\n    \"templates:view\",\r\n    \"templates:edit\",\r\n    \"exports:view\",\r\n    \"exports:manage\",\r\n    \"exports:approve\",\r\n    \"exports:request\",\r\n    \"activity_log:export\",\r\n    \"settings:view\",\r\n    \"audit:write:nonsensitive\",\r\n    \"auth:logout\",\r\n    \"resource:own\",\r\n  ],\r\n  EMPLOYEE_L1: [\r\n    \"dashboard:view\",\r\n    \"employees:view\",\r\n    \"employees:edit:self\",\r\n    \"attendance:view\",\r\n    \"attendance:edit:self\",\r\n    \"performance:view\",\r\n    \"templates:view\",\r\n    \"requests:view\",\r\n    \"requests:create:self\",\r\n    \"exports:request:self\",\r\n    \"settings:view\",\r\n    \"audit:write:nonsensitive\",\r\n    \"auth:logout\",\r\n    \"resource:own\",\r\n  ],\r\n  EMPLOYEE_L2: [\r\n    \"dashboard:view\",\r\n    \"employees:view\",\r\n    \"employees:edit:self\",\r\n    \"attendance:view\",\r\n    \"attendance:edit:self\",\r\n    \"performance:view\",\r\n    \"templates:view\",\r\n    \"requests:view\",\r\n    \"requests:create:self\",\r\n    \"exports:request:self\",\r\n    \"settings:view\",\r\n    \"audit:write:nonsensitive\",\r\n    \"auth:logout\",\r\n    \"resource:own\",\r\n  ],\r\n  EMPLOYEE_L3: [\r\n    \"dashboard:view\",\r\n    \"employees:view\",\r\n    \"employees:edit:self\",\r\n    \"attendance:view\",\r\n    \"attendance:edit:self\",\r\n    \"performance:view\",\r\n    \"templates:view\",\r\n    \"requests:view\",\r\n    \"requests:create:self\",\r\n    \"exports:request:self\",\r\n    \"settings:view\",\r\n    \"audit:write:nonsensitive\",\r\n    \"auth:logout\",\r\n    \"resource:own\",\r\n  ],\r\n};\r\n\r\nconst MODULE_REQUIRED_PERMISSION = {\r\n  dashboard: \"dashboard:view\",\r\n  employees: \"employees:view\",\r\n  \"employment-lifecycle\": \"lifecycle:view\",\r\n  attendance: \"attendance:view\",\r\n  performance: \"performance:view\",\r\n  \"activity-log\": \"activity_log:view\",\r\n  exports: \"exports:view\",\r\n  documents: \"templates:view\",\r\n  \"access-management\": \"access_management:view\",\r\n  \"retention-archive\": \"retention_archive:view\",\r\n  \"incident-management\": \"incident_management:view\",\r\n  requests: \"requests:view\",\r\n  settings: \"settings:view\",\r\n  \"user-management\": \"user_management:view\",\r\n};\r\n\r\nconst DEFAULT_ROLE_EMAILS = {\r\n  SUPER_ADMIN: [],\r\n  HR: [],\r\n  GRC: [],\r\n  EA: [],\r\n  EMPLOYEE_L1: [],\r\n  EMPLOYEE_L2: [],\r\n  EMPLOYEE_L3: [],\r\n};\r\n\r\nfunction parseEnvEmailList(rawValue, fallbackValues = []) {\r\n  if (typeof rawValue !== \"string\") {\r\n    return new Set(fallbackValues.map((value) => value.trim().toLowerCase()).filter(Boolean));\r\n  }\r\n\r\n  if (rawValue.trim().length === 0) {\r\n    return new Set(fallbackValues.map((value) => value.trim().toLowerCase()).filter(Boolean));\r\n  }\r\n\r\n  return new Set(\r\n    rawValue\r\n      .split(\",\")\r\n      .map((item) => item.trim().toLowerCase())\r\n      .filter(Boolean),\r\n  );\r\n}\r\n\r\nexport function getPermissionsForRole(role) {\r\n  const normalized = normalizeRole(role);\r\n  return ROLE_PERMISSIONS[normalized] ?? [];\r\n}\r\n\r\nexport function hasPermission(role, permission) {\r\n  const permissions = getPermissionsForRole(role);\r\n  return permissions.includes(\"*\") || permissions.includes(permission);\r\n}\r\n\r\nexport function canAccessModule(role, moduleId) {\r\n  const normalized = normalizeRole(role);\r\n  const allowedModules = new Set(MODULE_ACCESS[normalized] ?? []);\r\n\r\n  if (!allowedModules.has(moduleId)) {\r\n    return false;\r\n  }\r\n\r\n  const requiredPermission = MODULE_REQUIRED_PERMISSION[moduleId];\r\n  if (!requiredPermission) {\r\n    return true;\r\n  }\r\n\r\n  return hasPermission(normalized, requiredPermission);\r\n}\r\n\r\nexport function canAccessResource({\r\n  role,\r\n  actorIdentifier,\r\n  ownerIdentifier,\r\n  allowRoles = [\"SUPER_ADMIN\"],\r\n}) {\r\n  const normalized = normalizeRole(role);\r\n  if (allowRoles.includes(normalized)) {\r\n    return true;\r\n  }\r\n\r\n  if (!hasPermission(normalized, \"resource:own\")) {\r\n    return false;\r\n  }\r\n\r\n  const actor = String(actorIdentifier || \"\").trim().toLowerCase();\r\n  const owner = String(ownerIdentifier || \"\").trim().toLowerCase();\r\n  if (!actor || !owner) {\r\n    return false;\r\n  }\r\n\r\n  return actor === owner;\r\n}\r\n\r\nexport function resolveRoleForEmail(email) {\r\n  const normalizedEmail = String(email || \"\").trim().toLowerCase();\r\n  if (!normalizedEmail) {\r\n    return null;\r\n  }\r\n\r\n  const explicitRoleMap = {\r\n    SUPER_ADMIN: parseEnvEmailList(process.env.SUPER_ADMIN_EMAILS, DEFAULT_ROLE_EMAILS.SUPER_ADMIN),\r\n    HR: parseEnvEmailList(process.env.HR_EMAILS, DEFAULT_ROLE_EMAILS.HR),\r\n    GRC: parseEnvEmailList(process.env.GRC_EMAILS, DEFAULT_ROLE_EMAILS.GRC),\r\n    EA: parseEnvEmailList(process.env.EA_EMAILS, DEFAULT_ROLE_EMAILS.EA),\r\n    EMPLOYEE_L1: parseEnvEmailList(process.env.EMPLOYEE_L1_EMAILS, DEFAULT_ROLE_EMAILS.EMPLOYEE_L1),\r\n    EMPLOYEE_L2: parseEnvEmailList(process.env.EMPLOYEE_L2_EMAILS, DEFAULT_ROLE_EMAILS.EMPLOYEE_L2),\r\n    EMPLOYEE_L3: parseEnvEmailList(process.env.EMPLOYEE_L3_EMAILS, DEFAULT_ROLE_EMAILS.EMPLOYEE_L3),\r\n  };\r\n\r\n  for (const role of [\"SUPER_ADMIN\", \"HR\", \"GRC\", \"EA\", \"EMPLOYEE_L1\", \"EMPLOYEE_L2\", \"EMPLOYEE_L3\"]) {\r\n    if (explicitRoleMap[role].has(normalizedEmail)) {\r\n      return role;\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nexport function getModuleIdFromPathname(pathname) {\r\n  const path = String(pathname || \"\")\r\n    .trim()\r\n    .replace(/^\\/+|\\/+$/g, \"\");\r\n\r\n  if (!path) {\r\n    return \"dashboard\";\r\n  }\r\n\r\n  const firstSegment = path.split(\"/\")[0];\r\n  return MODULE_REQUIRED_PERMISSION[firstSegment] ? firstSegment : null;\r\n}\r\n","function normalizeNamePart(value) {\r\n  return String(value ?? \"\").trim();\r\n}\r\n\r\nfunction capitalizeWord(word) {\r\n  const value = normalizeNamePart(word).toLowerCase();\r\n  if (!value) {\r\n    return \"\";\r\n  }\r\n  return `${value.charAt(0).toUpperCase()}${value.slice(1)}`;\r\n}\r\n\r\nexport function formatNameFromEmail(email, { fallbackLabel = \"User\", maxTokens = 3 } = {}) {\r\n  const normalizedEmail = normalizeNamePart(email).toLowerCase();\r\n  const safeFallback = normalizeNamePart(fallbackLabel) || \"User\";\r\n  if (!normalizedEmail.includes(\"@\")) {\r\n    return safeFallback;\r\n  }\r\n\r\n  const localPart = normalizedEmail.split(\"@\")[0] || \"\";\r\n  const tokens = localPart\r\n    .split(/[._-]+/g)\r\n    .map((item) => capitalizeWord(item))\r\n    .filter(Boolean)\r\n    .slice(0, Math.max(1, Number.isFinite(maxTokens) ? maxTokens : 3));\r\n\r\n  if (tokens.length === 0) {\r\n    return safeFallback;\r\n  }\r\n\r\n  return tokens.join(\" \");\r\n}\r\n\r\nfunction formatNameBody({ firstName, middleName, lastName, order }) {\r\n  const normalizedFirstName = normalizeNamePart(firstName);\r\n  const normalizedMiddleName = normalizeNamePart(middleName);\r\n  const normalizedLastName = normalizeNamePart(lastName);\r\n\r\n  if (order === \"last-first\") {\r\n    const firstBlock = [normalizedFirstName, normalizedMiddleName].filter(Boolean).join(\" \");\r\n    if (normalizedLastName) {\r\n      return `${normalizedLastName}${firstBlock ? `, ${firstBlock}` : \"\"}`;\r\n    }\r\n    return firstBlock;\r\n  }\r\n\r\n  return [normalizedFirstName, normalizedMiddleName, normalizedLastName].filter(Boolean).join(\" \");\r\n}\r\n\r\nfunction resolveFallbackName({ fallback, fallbackEmail, fallbackLabel }) {\r\n  const directFallback = normalizeNamePart(fallback);\r\n  if (directFallback) {\r\n    return directFallback;\r\n  }\r\n\r\n  const email = normalizeNamePart(fallbackEmail);\r\n  if (email) {\r\n    return formatNameFromEmail(email, { fallbackLabel });\r\n  }\r\n\r\n  return normalizeNamePart(fallbackLabel) || \"User\";\r\n}\r\n\r\nexport function formatPersonName({\r\n  firstName,\r\n  middleName,\r\n  lastName,\r\n  suffix,\r\n  fallback = \"\",\r\n  fallbackEmail = \"\",\r\n  fallbackLabel = \"User\",\r\n} = {}) {\r\n  const body = formatNameBody({\r\n    firstName,\r\n    middleName,\r\n    lastName,\r\n    order: \"first-last\",\r\n  });\r\n  const normalizedSuffix = normalizeNamePart(suffix);\r\n  const fullName = [body, normalizedSuffix].filter(Boolean).join(\" \").trim();\r\n  if (fullName) {\r\n    return fullName;\r\n  }\r\n\r\n  return resolveFallbackName({\r\n    fallback,\r\n    fallbackEmail,\r\n    fallbackLabel,\r\n  });\r\n}\r\n\r\nexport function formatEmployeeName({\r\n  firstName,\r\n  middleName,\r\n  lastName,\r\n  suffix,\r\n  fallback = \"\",\r\n  fallbackEmail = \"\",\r\n  fallbackLabel = \"Employee\",\r\n} = {}) {\r\n  const body = formatNameBody({\r\n    firstName,\r\n    middleName,\r\n    lastName,\r\n    order: \"last-first\",\r\n  });\r\n  const normalizedSuffix = normalizeNamePart(suffix);\r\n  const fullName = [body, normalizedSuffix].filter(Boolean).join(\" \").trim();\r\n  if (fullName) {\r\n    return fullName;\r\n  }\r\n\r\n  return resolveFallbackName({\r\n    fallback,\r\n    fallbackEmail,\r\n    fallbackLabel,\r\n  });\r\n}\r\n"],"names":[],"mappings":"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AAE,EAY/D,MAAO,CACL,SAAU,UACV,OAAQ,YACR,UAdgB,CAAC,QAAQ,EAAE,KAAK,GAAG,GAAA,CAAI,CAevC,WAAY,WACZ,CACF,CACF,EA2C0B,SACpB,EACA,QAAS,EAAQ,OAAO,WACxB,WACA,CACF,EACF,CAEA,MAAM,AAAI,MAAM,6BAClB,q1CCxXA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OCFA,EAAA,EAAA,CAAA,CAAA,OAGA,IAAM,EAAmB,CACvB,YAAa,CAAC,IAAI,CAClB,IAAK,CACH,iBACA,iBACA,iBACA,2BACA,iBACA,iBACA,oBACA,kBACA,kBACA,qBACA,mBACA,mBACA,sBACA,iBACA,iBACA,eACA,iBACA,kBACA,kBACA,sBACA,oBACA,aACA,yBACA,yBACA,2BACA,2BACA,2BACA,uBACA,yBACA,gBACA,2BACA,cACA,eACD,CACD,GAAI,CACF,iBACA,iBACA,iBACA,2BACA,iBACA,iBACA,oBACA,kBACA,kBACA,qBACA,mBACA,mBACA,sBACA,iBACA,iBACA,eACA,iBACA,kBACA,kBACA,sBACA,gBACA,2BACA,cACA,eACD,CACD,GAAI,CACF,iBACA,iBACA,iBACA,2BACA,iBACA,iBACA,oBACA,kBACA,kBACA,qBACA,mBACA,mBACA,sBACA,iBACA,iBACA,eACA,iBACA,kBACA,kBACA,sBACA,gBACA,2BACA,cACA,eACD,CACD,YAAa,CACX,iBACA,iBACA,sBACA,kBACA,uBACA,mBACA,iBACA,gBACA,uBACA,uBACA,gBACA,2BACA,cACA,eACD,CACD,YAAa,CACX,iBACA,iBACA,sBACA,kBACA,uBACA,mBACA,iBACA,gBACA,uBACA,uBACA,gBACA,2BACA,cACA,eACD,CACD,YAAa,CACX,iBACA,iBACA,sBACA,kBACA,uBACA,mBACA,iBACA,gBACA,uBACA,uBACA,gBACA,2BACA,cACA,eACD,AACH,EAEM,EAA6B,CACjC,UAAW,iBACX,UAAW,iBACX,uBAAwB,iBA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"}