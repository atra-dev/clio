module.exports=[74405,e=>{"use strict";var t=e.i(45787);e.i(18097);var i=e.i(19e3),r=e.i(67658),n=e.i(33355),a=e.i(22177);let o=new Map,s=new Map,d="system@gmail.com",c=null,l=new Set(["missing_permission","role_not_allowed","ownership_validation_failed","unauthorized","account_not_active","session_role_mismatch","session_version_mismatch"]),u=new Set(["account_disabled","account_inactive","account_archived","offboarded_user"]),m=new Set(["SUPER_ADMIN","GRC","HR","EA"]);function p(){return new Date().toISOString()}function E(e,t=""){return String(e||"").trim()||t}function y(e){return e&&"object"==typeof e&&!Array.isArray(e)?e:{}}function f(e){return Array.isArray(e)?e:[]}function h(e){return E(e).toLowerCase()}function I(e){return E(e).toLowerCase()}function _(e){return E(e).toLowerCase()||"unknown"}function w(e){return E(e).toUpperCase().replace(/[^A-Z0-9]+/g,"_").replace(/^_+|_+$/g,"")}function S(e){let t=new Date(e||"").getTime();return Number.isNaN(t)?null:t}function v(e,t=!1){let i=h(process.env[e]);return i?"true"===i||"1"===i||"yes"===i:t}function A(e,t,{min:i=1,max:r=Number.MAX_SAFE_INTEGER}={}){let n=Number.parseInt(E(process.env[e]),10);return Number.isFinite(n)?Math.min(r,Math.max(i,n)):t}function D(e){let t=E(e);return t?t.startsWith("http://")||t.startsWith("https://")?t.replace(/\/+$/,""):`https://${t.replace(/^\/+/,"").replace(/\/+$/,"")}`:""}function C(){return(0,r.isFirestoreEnabled)()?(0,r.getFirestoreDb)():null}function M(){return{enabled:v("CLIO_IDS_ENABLED",!0),authFailureThreshold:A("CLIO_IDS_AUTH_FAILURE_THRESHOLD",5,{min:2,max:30}),authFailureWindowMinutes:A("CLIO_IDS_AUTH_FAILURE_WINDOW_MINUTES",10,{min:1,max:120}),permissionDeniedThreshold:A("CLIO_IDS_PERMISSION_DENIED_THRESHOLD",3,{min:2,max:20}),permissionDeniedWindowMinutes:A("CLIO_IDS_PERMISSION_DENIED_WINDOW_MINUTES",15,{min:1,max:120}),exportSpikeThreshold:A("CLIO_IDS_EXPORT_SPIKE_THRESHOLD",4,{min:2,max:20}),exportSpikeWindowMinutes:A("CLIO_IDS_EXPORT_SPIKE_WINDOW_MINUTES",20,{min:1,max:180}),piiAccessSpikeThreshold:A("CLIO_IDS_PII_ACCESS_SPIKE_THRESHOLD",12,{min:4,max:80}),piiAccessSpikeWindowMinutes:A("CLIO_IDS_PII_ACCESS_SPIKE_WINDOW_MINUTES",15,{min:1,max:180}),offboardedAccessThreshold:A("CLIO_IDS_OFFBOARDED_ACCESS_THRESHOLD",2,{min:1,max:30}),offboardedAccessWindowMinutes:A("CLIO_IDS_OFFBOARDED_ACCESS_WINDOW_MINUTES",30,{min:1,max:240}),privilegedRoleChangeThreshold:A("CLIO_IDS_ROLE_ESCALATION_THRESHOLD",2,{min:1,max:20}),privilegedRoleChangeWindowMinutes:A("CLIO_IDS_ROLE_ESCALATION_WINDOW_MINUTES",60,{min:1,max:480}),breachWindowMinutes:A("CLIO_IDS_BREACH_WINDOW_MINUTES",30,{min:5,max:240}),breachExportThreshold:A("CLIO_IDS_BREACH_EXPORT_THRESHOLD",2,{min:1,max:50}),breachPiiThreshold:A("CLIO_IDS_BREACH_PII_THRESHOLD",6,{min:1,max:120}),breachDeniedThreshold:A("CLIO_IDS_BREACH_DENIED_THRESHOLD",2,{min:0,max:50}),incidentCooldownMinutes:A("CLIO_IDS_INCIDENT_COOLDOWN_MINUTES",15,{min:1,max:360}),maxRecipientCount:A("CLIO_IDS_MAX_RECIPIENTS",20,{min:1,max:100}),systemActorEmail:I(process.env.CLIO_IDS_SYSTEM_ACTOR_EMAIL)||d,appBaseUrl:function(){let e=D(process.env.CLIO_APP_BASE_URL);if(e)return e;let t=D(process.env.NEXT_PUBLIC_APP_URL);if(t)return t;let i=D("atracaas-platform-1fbeb.firebaseapp.com");if(i)return i;let r=D(process.env.VERCEL_PROJECT_PRODUCTION_URL||process.env.VERCEL_URL);return r||""}(),retryEnabled:v("CLIO_IDS_RETRY_ENABLED",!0),retryBatchSize:A("CLIO_IDS_RETRY_BATCH_SIZE",8,{min:1,max:32}),retryMaxAttempts:A("CLIO_IDS_RETRY_MAX_ATTEMPTS",5,{min:1,max:20}),retryBaseBackoffSeconds:A("CLIO_IDS_RETRY_BASE_BACKOFF_SECONDS",30,{min:5,max:3600}),retryMaxBackoffSeconds:A("CLIO_IDS_RETRY_MAX_BACKOFF_SECONDS",1800,{min:30,max:86400}),retryCollectionName:E(process.env.CLIO_FIRESTORE_IDS_RETRY_COLLECTION,"clio_ids_retry_queue"),deadLetterCollectionName:E(process.env.CLIO_FIRESTORE_IDS_DEAD_LETTER_COLLECTION,"clio_ids_dead_letter")}}function N(e,t,i){let r=t-i;return e.filter(e=>e>=r).slice(-256)}function R(e,t,i){let r=E(e);if(!r)return 0;let n=Number.isFinite(t)?t:Date.now(),a=N(o.get(r)||[],n,i);return a.push(n),o.set(r,a),a.length}function g(e,t,i){let r=E(e);if(!r)return 0;let n=Number.isFinite(t)?t:Date.now(),a=N(o.get(r)||[],n,i);return o.set(r,a),a.length}function b(e,t,i){let r=60*Math.max(1,Number(i||1))*1e3;s.set(e,t+r)}function O(e){let t=y(e?.metadata);return{at:E(e?.occurredAt,p()),activityName:E(e?.activityName,"Activity"),module:E(e?.module,"System"),sourceEventId:E(e?.id),sourceIp:E(t.sourceIp||e?.sourceIp),requestPath:E(t.requestPath||e?.requestPath),requestMethod:E(t.requestMethod||e?.requestMethod),actorEmail:I(e?.performedBy),targetEmployeeEmail:I(t.targetEmployeeEmail||t.employeeEmail||t.affectedEmployeeEmail)}}function T(e,t,i){let r=h(e);return"critical"===r||t>=2*Math.max(1,Number(i||1))||"high"===r?"High":"Low"}function L(e){return"failed"===e||"rejected"===e}function x(e,t,i){if(!t.moduleName.includes("authentication")||!L(t.status))return null;let r=R(`auth-fail:${t.sourceIp||t.actorEmail||"unknown"}`,t.occurredAtMs,60*i.authFailureWindowMinutes*1e3);return r<i.authFailureThreshold?null:{ruleId:"AUTH_BRUTE_FORCE",incidentType:"Credential Compromise",severity:T("high",r,i.authFailureThreshold),restrictedPiiInvolved:!1,observedCount:r,windowMinutes:i.authFailureWindowMinutes,affectedEmployeeEmail:t.actorEmail,title:"Repeated authentication failures detected",summary:`Detected ${r} failed/rejected authentication events from ${t.sourceIp} within ${i.authFailureWindowMinutes} minute(s).`,tags:["authentication","brute-force","ids"]}}function $(e,t,i){if(!(L(t.status)&&(l.has(t.reason)||t.activityName.includes("permission")||t.activityName.includes("ownership")||t.activityName.includes("forbidden"))))return null;let r=R(`permission-denied:${t.actorEmail||t.sourceIp||"unknown"}`,t.occurredAtMs,60*i.permissionDeniedWindowMinutes*1e3);if(r<i.permissionDeniedThreshold)return null;let n=t.moduleName.includes("employee records")||t.moduleName.includes("performance")||t.moduleName.includes("attendance");return{ruleId:"UNAUTHORIZED_ACCESS_ATTEMPT",incidentType:"Unauthorized Access",severity:T(n?"high":"low",r,i.permissionDeniedThreshold),restrictedPiiInvolved:n,observedCount:r,windowMinutes:i.permissionDeniedWindowMinutes,affectedEmployeeEmail:t.targetEmployeeEmail||t.actorEmail,title:"Repeated unauthorized access attempts detected",summary:`Detected ${r} permission/ownership denials for actor ${t.actorEmail||"unknown"} within ${i.permissionDeniedWindowMinutes} minute(s).`,tags:["authorization","idor","least-privilege","ids"]}}function P(e,t,i){if(!(t.moduleName.includes("export")||t.requestPath.includes("/api/hris/exports")||t.activityName.includes("export"))||"approved"!==t.status&&"completed"!==t.status)return null;let r=R(`export-spike:${t.actorEmail||t.sourceIp||"unknown"}`,t.occurredAtMs,60*i.exportSpikeWindowMinutes*1e3);return r<i.exportSpikeThreshold?null:{ruleId:"MASS_EXPORT_ACTIVITY",incidentType:"Data Exposure",severity:T("high",r,i.exportSpikeThreshold),restrictedPiiInvolved:!0,observedCount:r,windowMinutes:i.exportSpikeWindowMinutes,affectedEmployeeEmail:t.targetEmployeeEmail||"",title:"Mass export activity detected",summary:`Detected ${r} export-related actions by ${t.actorEmail||t.sourceIp} within ${i.exportSpikeWindowMinutes} minute(s).`,tags:["export","dlp","ids"]}}function W(e,t,i){let r=t.activityName.includes("view")||t.activityName.includes("list");if(!(t.moduleName.includes("employee records")&&r&&L(t.status)&&(l.has(t.reason)||t.activityName.includes("permission")||t.activityName.includes("ownership")||t.activityName.includes("forbidden"))))return null;let n=R(`unauthorized-record-view:${t.actorEmail||t.sourceIp||"unknown"}`,t.occurredAtMs,60*i.piiAccessSpikeWindowMinutes*1e3);return n<i.piiAccessSpikeThreshold?null:{ruleId:"UNAUTHORIZED_RECORD_VIEW_SPIKE",incidentType:"Unauthorized Access",severity:T("high",n,i.piiAccessSpikeThreshold),restrictedPiiInvolved:!0,observedCount:n,windowMinutes:i.piiAccessSpikeWindowMinutes,affectedEmployeeEmail:t.targetEmployeeEmail||"",title:"Unauthorized employee-record view attempts detected",summary:`Detected ${n} denied employee-record view/list actions in ${i.piiAccessSpikeWindowMinutes} minute(s).`,tags:["authorization","employee-records","pii","ids"]}}function k(e,t,i){let r=t.moduleName.includes("authentication")||t.requestPath.includes("/api/auth/"),n=L(t.status)&&(u.has(t.reason)||t.activityName.includes("account disabled")||t.activityName.includes("account inactive")||t.activityName.includes("offboard"));if(!(r&&n))return null;let a=R(`offboarded-access:${t.actorEmail||t.sourceIp||"unknown"}`,t.occurredAtMs,60*i.offboardedAccessWindowMinutes*1e3);return a<i.offboardedAccessThreshold?null:{ruleId:"OFFBOARDED_ACCESS_ATTEMPT",incidentType:"Unauthorized Access",severity:T("high",a,i.offboardedAccessThreshold),restrictedPiiInvolved:!0,observedCount:a,windowMinutes:i.offboardedAccessWindowMinutes,affectedEmployeeEmail:t.actorEmail||t.targetEmployeeEmail,title:"Offboarded/disabled account access attempts detected",summary:`Detected ${a} blocked sign-in/access attempts for disabled or offboarded account ${t.actorEmail||"unknown"} within ${i.offboardedAccessWindowMinutes} minute(s).`,tags:["authentication","offboarding","access-control","ids"]}}function B(e,t,i){if(!(t.moduleName.includes("user management")&&t.activityName.includes("role updated")&&("approved"===t.status||"completed"===t.status))||!t.targetRole||!m.has(t.targetRole))return null;let r=R(`priv-role-assignment:${t.actorEmail||"unknown"}:${t.targetRole}`,t.occurredAtMs,60*i.privilegedRoleChangeWindowMinutes*1e3);return r<i.privilegedRoleChangeThreshold?null:{ruleId:"PRIVILEGED_ROLE_ASSIGNMENT_SPIKE",incidentType:"Policy Violation",severity:T("high",r,i.privilegedRoleChangeThreshold),restrictedPiiInvolved:!0,observedCount:r,windowMinutes:i.privilegedRoleChangeWindowMinutes,affectedEmployeeEmail:t.targetEmployeeEmail||"",title:"Privileged role assignment spike detected",summary:`Detected ${r} privileged role assignments (${t.targetRole}) by ${t.actorEmail||"unknown"} within ${i.privilegedRoleChangeWindowMinutes} minute(s).`,tags:["rbac","role-assignment","privilege","ids"]}}function F(e,t,i){let r=60*i.breachWindowMinutes*1e3,n=t.actorEmail||t.sourceIp||"unknown";(t.moduleName.includes("export")||t.requestPath.includes("/api/hris/exports")||t.activityName.includes("export"))&&("approved"===t.status||"completed"===t.status)&&R(`breach-export:${n}`,t.occurredAtMs,r),"sensitive"===t.sensitivity&&t.moduleName.includes("employee records")&&(t.activityName.includes("view")||t.activityName.includes("list"))&&("completed"===t.status||"approved"===t.status)&&R(`breach-pii:${n}`,t.occurredAtMs,r),L(t.status)&&(l.has(t.reason)||t.activityName.includes("permission")||t.activityName.includes("ownership")||t.activityName.includes("forbidden"))&&R(`breach-denied:${n}`,t.occurredAtMs,r);let a=g(`breach-export:${n}`,t.occurredAtMs,r),o=g(`breach-pii:${n}`,t.occurredAtMs,r),s=g(`breach-denied:${n}`,t.occurredAtMs,r),d=a>=i.breachExportThreshold,c=o>=i.breachPiiThreshold,u=i.breachDeniedThreshold<=0||s>=i.breachDeniedThreshold;return d&&c&&u?{ruleId:"POTENTIAL_BREACH_SIGNAL",incidentType:"Data Exposure",severity:T("high",a+o+s,Math.max(1,i.breachExportThreshold)),restrictedPiiInvolved:!0,observedCount:a+o+s,windowMinutes:i.breachWindowMinutes,affectedEmployeeEmail:t.targetEmployeeEmail||t.actorEmail,title:"Potential breach indicators detected",summary:`Detected ${a} export action(s), ${o} PII access event(s), and ${s} access denial(s) for ${n} within ${i.breachWindowMinutes} minute(s).`,tags:["breach-signal","export","pii","ids"]}:null}function U(e){return E(e).split(",").map(e=>I(e)).filter(Boolean)}function q(e,t){let i=I(process.env.CLIO_GRC_ALERT_EMAIL)||U(process.env.GRC_EMAILS)[0]||U(process.env.SUPER_ADMIN_EMAILS)[0];return i||I(t?.affectedEmployeeEmail||e?.metadata?.ownerEmail||e?.performedBy||d)}async function H(e,t,i,r){let o=q(e,t)||I(i?.ownerEmail),s=await (0,n.resolveIncidentStakeholderRecipients)({ownerEmail:o,affectedEmployeeEmail:I(t?.affectedEmployeeEmail),actorEmail:I(e?.performedBy),includeAffectedEmployee:!0,includeActor:!0});return(0,a.resolveSecurityAlertEmailRecipients)(s).slice(0,r.maxRecipientCount)}function K(e,t){let i=Math.max(1,Number(e||1)),r=Math.max(5,Number(t?.retryBaseBackoffSeconds||30));return Math.min(Math.max(r,Number(t?.retryMaxBackoffSeconds||1800)),r*Math.pow(2,Math.max(0,i-1)))}async function z({entry:e,detection:t,fingerprint:r,correlationKey:n,errorMessage:a,config:o,attempts:s=1,source:d="live"}){if(!o?.retryEnabled)return{queued:!1,reason:"retry_disabled"};let c=C();if(!c)return{queued:!1,reason:"retry_queue_unavailable"};let l=function({entry:e,detection:t,fingerprint:i,correlationKey:r,errorMessage:n,config:a,attempts:o=1,source:s="live",queuedAtIso:d=p()}){let c=Math.max(1,Number(o||1)),l=K(c,a),u=new Date(Date.now()+1e3*l).toISOString();return{status:"pending",source:E(s,"live"),attempts:c,maxAttempts:Math.max(1,Number(a?.retryMaxAttempts||5)),nextAttemptAt:u,lastError:E(n,"ids_processing_failed"),fingerprint:E(i),correlationKey:E(r),entry:y(e),detection:y(t),createdAt:d,updatedAt:d}}({entry:e,detection:t,fingerprint:r,correlationKey:n,errorMessage:a,config:o,attempts:s,source:d,queuedAtIso:p()});return{queued:!0,retryRecordId:(await (0,i.addDoc)((0,i.collection)(c,o.retryCollectionName),l)).id,attempts:l.attempts,nextAttemptAt:l.nextAttemptAt}}async function j(e,{batchSize:t}={}){let r=C();if(!r)return[];let n=Math.max(1,Number(t||e?.retryBatchSize||8)),a=Math.max(3*n,16),o=await (0,i.getDocs)((0,i.query)((0,i.collection)(r,e.retryCollectionName),(0,i.orderBy)("nextAttemptAt","asc"),(0,i.limit)(a))),s=Date.now();return o.docs.map(e=>({id:e.id,...e.data()||{}})).filter(e=>"pending"===h(e?.status||"pending")).filter(e=>{let t=S(e?.nextAttemptAt);return!Number.isFinite(t)||t<=s}).slice(0,n)}async function G(e,t,r){let n=C();if(!n)return null;let a={...t,status:"dead-letter",deadLetteredAt:p(),deadLetterReason:E(r,"ids_retry_exhausted"),originalRetryRecordId:E(t?.id)};return(await (0,i.addDoc)((0,i.collection)(n,e.deadLetterCollectionName),a)).id}async function X(e,t,r){let n=C();n&&await (0,i.updateDoc)((0,i.doc)(n,e.retryCollectionName,t),{...r,updatedAt:p()})}async function V(e,t){let r=C();r&&await (0,i.deleteDoc)((0,i.doc)(r,e.retryCollectionName,t))}async function Y({correlationKey:e,fingerprint:i,nowMs:r,config:n}){let a=[];try{a=await (0,t.listIncidentRecordsBackend)()}catch{a=[]}let o=f(a).find(t=>{if(["resolved","closed"].includes(h(t?.status).replace(/\s+/g,"_")))return!1;let r=E(t?.detectionCorrelationKey);if(r&&r===e)return!0;let n=E(t?.detectionFingerprint);return!!(n&&n===i)});return o||(!function(e,t){let i=Number.isFinite(t)?t:Date.now();for(let[e,t]of s.entries())(!Number.isFinite(t)||t<=i)&&s.delete(e);let r=s.get(e);return Number.isFinite(r)&&r>t}(i,r)?null:{id:"",duplicateOnly:!0})}async function Q({incident:e,entry:i,detection:r,correlationKey:n,fingerprint:a,nowMs:o,config:s}){if(!e?.id)return null;let d=Math.max(1,Number(e?.alertOccurrenceCount||1))+1,c=[...f(e?.alertOccurrences).slice(-39),O(i)],l={detectionFingerprint:E(e?.detectionFingerprint||a),detectionCorrelationKey:E(e?.detectionCorrelationKey||n),detectionWindowEnd:new Date(o).toISOString(),alertDescription:r.summary,alertOccurrenceCount:d,alertFirstObservedAt:E(e?.alertFirstObservedAt||e?.detectedAt||p()),alertLastObservedAt:E(i?.occurredAt,p()),alertOccurrences:c,summary:r.summary,notes:[E(e?.notes),`Latest alert occurrence #${d}: ${E(i?.activityName,"Activity")} | ${E(i?.module,"System")} | ${E(i?.occurredAt,p())} | Source IP: ${E(i?.metadata?.sourceIp||i?.sourceIp,"unknown")}`].filter(Boolean).join("\n")},u=await (0,t.updateIncidentRecordBackend)(e.id,l,s.systemActorEmail);return b(a,o,s.incidentCooldownMinutes),u}async function Z(e,i,r,n,a,o){let s=E(e?.occurredAt,p()),c=q(e,i),l=r.systemActorEmail||d,u=y(e?.metadata),m=E(u.targetEmployeeEmail||u.employeeEmail||i.affectedEmployeeEmail,""),h=E(u.resourceLabel||u.recordRef||u.recordId,""),_=f(u.viewedFields,[]),w=f(u.accessedDocuments,[]),S=E(e?.occurredAt,p()),v=O(e),A={title:i.title,summary:i.summary,incidentType:i.incidentType,severity:i.severity,status:"Open",restrictedPiiInvolved:!!i.restrictedPiiInvolved,affectedEmployeeEmail:I(i.affectedEmployeeEmail||u.targetEmployeeEmail||""),ownerEmail:c,detectedAt:s,escalationRequired:!0,containmentStatus:"Not Started",impactAssessmentStatus:"Pending",regulatoryNotificationRequired:!!i.restrictedPiiInvolved,documentationRetained:!0,classificationStandard:"CLIO-IDS-V1",notes:[`Auto-generated by CLIO IDS rule: ${i.ruleId}`,`Observed count: ${Number(i.observedCount||0)}`,`Window: ${Number(i.windowMinutes||0)} minute(s)`,m?`Target employee: ${m}`:null,h?`Record reference: ${h}`:null,_.length>0?`Viewed fields: ${_.slice(0,12).join(", ")}`:null,w.length>0?`Accessed documents: ${w.map(e=>E(e?.name||e?.ref||e?.id)).filter(Boolean).slice(0,6).join(", ")}`:null,`Source event: ${E(e?.id,"N/A")} | ${E(e?.module,"System")} | ${E(e?.activityName,"Activity")}`,`Source IP: ${E(u.sourceIp||e?.sourceIp,"unknown")}`,`Request: ${E(u.requestMethod||e?.requestMethod,"GET")} ${E(u.requestPath||e?.requestPath,"unknown")}`].filter(Boolean).join("\n"),autoGenerated:!0,detectionRuleId:i.ruleId,detectionFingerprint:n,detectionCorrelationKey:a,detectionWindowStart:new Date(o-60*i.windowMinutes*1e3).toISOString(),detectionWindowEnd:new Date(o).toISOString(),alertDescription:i.summary,alertOccurrenceCount:1,alertFirstObservedAt:S,alertLastObservedAt:S,alertOccurrences:[v],sourceSystem:"CLIO_IDS",sourceEventId:E(e?.id),sourceEventModule:E(e?.module),sourceEventPath:E(u.requestPath||e?.requestPath),sourceIp:E(u.sourceIp||e?.sourceIp),alertRecipients:[],actionUrl:"/incident-management"},D=await (0,t.createIncidentRecordBackend)(A,l);return b(n,o,r.incidentCooldownMinutes),D}async function J({incident:e,detection:t,recipients:i,actionUrl:r,actorEmail:a}){let o=i.map(i=>{let n,o,s;return{recipientEmail:i,title:E(e?.title||t?.title,"Security anomaly detected"),message:(n=E(e?.severity||t?.severity,"Medium"),o=E(e?.incidentCode,"INCIDENT"),s=E(e?.summary||t?.summary,"Review incident workbench for containment."),`[${n}] ${o}: ${s}`),severity:h(e?.severity||t?.severity||"medium"),type:"security-anomaly",module:"Incident Management",actionUrl:r,status:"unread",createdBy:a,metadata:{incidentId:E(e?.id||e?.recordId),incidentCode:E(e?.incidentCode),detectionRuleId:E(t?.ruleId),autoGenerated:!0}}});return await (0,n.createInAppNotificationsBulk)(o)}async function ee({entry:e,detection:i,config:r,fingerprint:n,correlationKey:o,nowMs:s}){var d;let c,l,u=await Y({correlationKey:o,fingerprint:n,nowMs:s,config:r});if(u?.duplicateOnly)return{detected:!0,duplicate:!0,detection:i,fingerprint:n,correlationKey:o};if(u?.id){let t=await Q({incident:u,entry:e,detection:i,correlationKey:o,fingerprint:n,nowMs:s,config:r});return{detected:!0,duplicate:!0,consolidated:!0,detection:i,fingerprint:n,correlationKey:o,incidentRecord:t||u}}let m=await Z(e,i,r,n,o,s),y=(d=m?.id||m?.recordId)?`/incident-management?incident=${encodeURIComponent(d)}`:"/incident-management",f=(c=E(r?.appBaseUrl).replace(/\/+$/,""),(l=E(y,"/incident-management")).startsWith("http://")||l.startsWith("https://")?l:c?`${c}${l.startsWith("/")?l:`/${l}`}`:l.startsWith("/")?l:`/${l}`),h=await H(e,i,m,r),I=await J({incident:m,detection:i,recipients:h,actionUrl:y,actorEmail:r.systemActorEmail}),_=await (0,a.dispatchSecurityIncidentAlerts)({incident:{...m,actionUrl:f},detection:i,sourceEvent:e,emailRecipients:h}),w={alertRecipients:h,alertDispatchSummary:_,externalIntegrations:{webhooks:_?.webhooks||{}},lastAlertDispatchAt:p()};return await (0,t.updateIncidentRecordBackend)(m.id,w,r.systemActorEmail).catch(()=>null),{detected:!0,duplicate:!1,detection:i,incidentRecord:m,fingerprint:n,recipients:h,inAppNotificationCount:I.length,deliverySummary:_}}async function et(e,t){let i=E(t?.id);if(!i)return{processed:!1,reason:"missing_retry_record_id"};let r=Math.max(1,Number(t?.attempts||1)),n=Math.max(1,Number(t?.maxAttempts||e.retryMaxAttempts||5)),a=y(t?.entry),o=y(t?.detection),s=E(t?.fingerprint),d=E(t?.correlationKey);if(!s||!E(o?.ruleId)||!E(a?.activityName)&&!E(a?.module))return await G(e,t,"invalid_retry_payload"),await V(e,i),{processed:!1,deadLettered:!0,reason:"invalid_retry_payload"};let c=await er(a,{forcedDetection:o,forcedFingerprint:s,forcedCorrelationKey:d,skipQueueOnError:!0,disableQueueDrain:!0});if(!c?.failed)return await V(e,i),{processed:!0,duplicate:!!c?.duplicate,detected:!!c?.detected};let l=r+1,u=E(c?.error,"ids_processing_failed");if(l>n)return await G(e,{...t,attempts:l,maxAttempts:n,lastError:u},u),await V(e,i),{processed:!1,deadLettered:!0,reason:u};let m=new Date(Date.now()+1e3*K(l,e)).toISOString();return await X(e,i,{attempts:l,maxAttempts:n,nextAttemptAt:m,lastError:u,status:"pending"}),{processed:!1,retried:!0,reason:u,nextAttemptAt:m}}async function ei({reason:e="manual",batchSize:t}={}){let i=M();if(!i.enabled||!i.retryEnabled)return{processedCount:0,reason:i.enabled?"retry_disabled":"ids_disabled"};if(c)return c;c=(async()=>{let r=await j(i,{batchSize:Number(t||i.retryBatchSize||8)}),n=0,a=0,o=0;for(let e of r)try{let t=await et(i,e);t?.processed&&(n+=1),t?.deadLettered&&(a+=1)}catch{o+=1}return{reason:E(e,"manual"),processedCount:n,deadLetterCount:a,failedCount:o,dueCount:r.length}})();try{return await c}finally{c=null}}async function er(e,t={}){var i,r,n,a;let o,s,d,c,l,u,m,p,f,v,A=M();if(!A.enabled)return{detected:!1,reason:"ids_disabled"};if(!e||"object"!=typeof e)return{detected:!1,reason:"invalid_audit_entry"};!t?.disableQueueDrain&&A.retryEnabled&&ei({reason:"audit-event"}).catch(()=>null);let D=(i=t?.forcedDetection)&&"object"==typeof i&&!Array.isArray(i)?t.forcedDetection:null;if(!D&&function(e){let t=y(e?.metadata);if(!0===t.skipAnomalyDetection||!0===t.autoGenerated)return!0;let i=h(e?.module),r=h(t.requestPath||e?.requestPath);return!!(i.includes("incident management")||r.startsWith("/api/notifications"))}(e))return{detected:!1,reason:"event_skipped"};let C=(o=y(e?.metadata),{actorEmail:I(e?.performedBy),status:h(e?.status),moduleName:h(e?.module),activityName:h(e?.activityName),reason:h(o.reason),requestPath:h(o.requestPath||e?.requestPath),requestMethod:h(o.requestMethod||e?.requestMethod),sourceIp:_(o.sourceIp||e?.sourceIp),sensitivity:h(e?.sensitivity),targetEmployeeEmail:I(o.targetEmployeeEmail||o.employeeEmail||o.affectedEmployeeEmail),ownerEmail:I(o.ownerEmail),targetRole:w(o.targetRole||o.assignedRole||""),actorRole:w(o.actorRole||o.currentRole||""),occurredAtMs:S(e?.occurredAt)||Date.now()}),N=D||function(e,t,i){for(let r of[x,$,k,B,P,W,F]){let n=r(e,t,i);if(n)return n}return null}(e,C,A);if(!N)return{detected:!1,reason:"no_rule_match"};let R=C.occurredAtMs||Date.now(),g=E(t?.forcedFingerprint)||(r=N.ruleId,n=N.windowMinutes||A.incidentCooldownMinutes,s=I(e?.performedBy),d=_(e?.metadata?.sourceIp||e?.sourceIp),c=h(e?.module||""),l=I(N?.affectedEmployeeEmail||e?.metadata?.employeeEmail||""),u=Math.floor(R/(60*Math.max(1,Number(n||1))*1e3)),[E(r),s||"unknown",d,c||"module",l||"none",u].join("|")),b=E(t?.forcedCorrelationKey)||(a=N.ruleId,m=I(e?.performedBy),p=_(e?.metadata?.sourceIp||e?.sourceIp),f=h(e?.module||""),v=I(N?.affectedEmployeeEmail||e?.metadata?.employeeEmail||""),[E(a),m||"unknown",p,f||"module",v||"none"].join("|"));try{return await ee({entry:e,detection:N,config:A,fingerprint:g,correlationKey:b,nowMs:R})}catch(n){let i=n instanceof Error?E(n.message,"ids_processing_failed"):"ids_processing_failed";if(t?.skipQueueOnError)return{detected:!0,duplicate:!1,failed:!0,detection:N,fingerprint:g,reason:"processing_failed",error:i};let r=await z({entry:e,detection:N,fingerprint:g,correlationKey:b,errorMessage:i,config:A,attempts:1,source:"live"});return{detected:!0,duplicate:!1,failed:!0,queuedForRetry:!!r?.queued,retryRecordId:E(r?.retryRecordId),detection:N,fingerprint:g,reason:"processing_failed",error:i}}}e.s(["drainSecurityDetectionRetryQueue",()=>ei,"processAuditEventForSecurityDetections",()=>er])}];

//# sourceMappingURL=src_lib_security-detection_4bdbe3ad.js.map