module.exports=[36725,a=>{"use strict";a.i(2446);var b=a.i(73004),c=a.i(70767),d=a.i(39748);a.i(64368);var e=a.i(2252);let f=["Low","High"],g=["Open","Containment","Investigating","Escalated","Regulatory Review","Resolved","Closed"],h=["Not Started","In Progress","Contained"],i=["Pending","In Progress","Completed"],j=["Unauthorized Access","Data Exposure","Credential Compromise","Insider Misuse","Malware / Ransomware","Policy Violation","System Misconfiguration","Other"],k=new Set(["pdf","png","jpg","jpeg","webp","doc","docx","xls","xlsx","csv","txt"]),l=new Set(["application/pdf","image/png","image/jpeg","image/webp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv","text/plain"]);function m(a,b){return String(process.env[a]||"").trim()||b}function n(a,b){let c=String(a||"").split(",").map(a=>String(a||"").trim().toLowerCase()).filter(Boolean);return new Set(0===c.length?[...b]:c)}function o(){return new Date().toISOString()}function p(a,b=""){return String(a??"").trim()||b}function q(a){return String(a||"").trim().toLowerCase()}function r(a){return String(a||"").trim().toLowerCase()}function s(a){return Array.isArray(a)?a:[]}function t(a,b={}){return a&&"object"==typeof a&&!Array.isArray(a)?a:b}function u(a,b=!1){if("boolean"==typeof a)return a;if("number"==typeof a)return 0!==a;if("string"==typeof a){let c=a.trim().toLowerCase();if(!c)return b;if(["true","1","yes","y","on"].includes(c))return!0;if(["false","0","no","n","off"].includes(c))return!1}return b}function v(a,b){return new Date(b.updatedAt||b.createdAt||0).getTime()-new Date(a.updatedAt||a.createdAt||0).getTime()}function w(a){return({employees:m("CLIO_FIRESTORE_EMPLOYEES_COLLECTION","employees"),lifecycle:m("CLIO_FIRESTORE_LIFECYCLE_COLLECTION","employment_lifecycle"),attendance:m("CLIO_FIRESTORE_ATTENDANCE_COLLECTION","attendance"),leave:m("CLIO_FIRESTORE_LEAVE_COLLECTION","leave_requests"),performance:m("CLIO_FIRESTORE_PERFORMANCE_COLLECTION","performance_records"),templates:m("CLIO_FIRESTORE_TEMPLATES_COLLECTION","document_templates"),exports:m("CLIO_FIRESTORE_EXPORTS_COLLECTION","export_requests"),incidents:m("CLIO_FIRESTORE_INCIDENTS_COLLECTION","security_incidents"),settingsReference:m("CLIO_FIRESTORE_SETTINGS_REFERENCE_COLLECTION","settings_reference_data")})[a]||a}function x(){if(!(0,c.isFirestoreEnabled)())throw Error("firestore_not_configured");let a=(0,c.getFirestoreDb)();if(!a)throw Error("firestore_not_configured");return a}async function y(a,{filterField:c,filterValue:d}={}){let e=x(),f=(0,b.collection)(e,a);return(c&&"string"==typeof d&&d.trim()?await (0,b.getDocs)((0,b.query)(f,(0,b.where)(c,"==",d.trim()))):await (0,b.getDocs)(f)).docs.map(a=>({...a.data(),id:a.id,recordId:a.id})).sort(v)}async function z(a,c){let d=x(),e=p(c);if(!e)throw Error("invalid_record_id");let f=(0,b.doc)(d,a,e),g=await (0,b.getDoc)(f);return g.exists()?{...g.data(),id:g.id,recordId:g.id}:null}async function A(a,c){let d=x(),e=await (0,b.addDoc)((0,b.collection)(d,a),c);return{...c,id:e.id,recordId:e.id}}async function B(a,c,d){let e=x(),f=p(c);if(!f)throw Error("invalid_record_id");let g=(0,b.doc)(e,a,f),h=await (0,b.getDoc)(g);if(!h.exists())return null;let i={...h.data()||{},...d};return await (0,b.updateDoc)(g,i),{...i,id:h.id,recordId:h.id}}function C(a,b="Low"){let c=p(a,b).toLowerCase();return"critical"===c?"High":"medium"===c?"Low":f.find(a=>a.toLowerCase()===c)||"Low"}function D(a){return+("High"===C(a))}async function E(a,{limit:b}={}){let c=o(),d=M(a?.forensicWindowStart||a?.detectedAt)||c,f=M(a?.forensicWindowEnd||c)||c,g=L(d)||0,h=L(f)||Date.now(),i=r(a?.affectedEmployeeEmail||a?.employeeEmail||""),j=Number.isFinite(Number(b))?Number(b):1800,k=[];try{k=await (0,e.listAuditEvents)({limit:Math.max(100,Math.min(5e3,j))})}catch{k=[]}let l=k.filter(a=>{let b=L(a?.occurredAt||a?.loggedAt);if(!Number.isFinite(b)||b<g||b>h)return!1;let c=r(i);if(!c)return!0;let d=t(a?.metadata,{});return[a?.performedBy,a?.performedByEmail,d.employeeEmail,d.ownerEmail,d.requestedBy,d.targetEmployeeEmail,d.affectedEmployeeEmail].some(a=>r(a)===c)}),m=[],n=[],u=[],v=[];return l.forEach(a=>{let b,c,d,e,f,g,h,i,j,k,l,o=(b=t(a?.metadata,{}),{id:p(a?.id),activityName:p(a?.activityName),module:p(a?.module),status:p(a?.status),occurredAt:p(a?.occurredAt),performedBy:p(a?.performedBy),requestMethod:p(a?.requestMethod),requestPath:p(a?.requestPath),sourceIp:p(a?.sourceIp||b?.sourceIp),userAgent:p(a?.userAgent||b?.userAgent),device:p(b?.device||""),recordRef:p(b?.recordRef||b?.recordId),resourceLabel:p(b?.resourceLabel),employeeEmail:p(b?.employeeEmail),targetEmployeeEmail:p(b?.targetEmployeeEmail||b?.affectedEmployeeEmail),viewedFields:s(b?.viewedFields,[]),viewedFieldCount:Number(b?.viewedFieldCount||0),accessedDocuments:s(b?.accessedDocuments,[]),accessedDocumentCount:Number(b?.accessedDocumentCount||0),updatedFields:s(b?.updatedFields,[]),changedFields:s(b?.changedFields,[])});(c=q(a?.requestMethod),d=q(a?.activityName),"delete"===c||d.includes("delete")||d.includes("purge")||d.includes("removed")||d.includes("archive"))?v.push(o):(e=q(a?.module),f=q(a?.requestPath),g=q(a?.activityName),e.includes("export")||f.includes("/api/hris/exports")||g.includes("export"))?n.push(o):(h=q(a?.module),i=q(a?.requestMethod),j=q(a?.activityName),h.includes("authorization")||h.includes("user management")||h.includes("access management")||"patch"===i||"post"===i||j.includes("approve")||j.includes("revok")||j.includes("invite")||j.includes("role"))?u.push(o):(k=q(a?.requestMethod),l=q(a?.activityName),("get"===k||l.includes("viewed")||l.includes("listed")||l.includes("access"))&&m.push(o))}),{generatedAt:c,windowStart:d,windowEnd:f,scopedSubjectEmail:i||"",totalScopedLogs:l.length,accessLogsCount:m.length,exportLogsCount:n.length,administrativeActionsCount:u.length,deletionActivitiesCount:v.length,accessLogs:m.slice(0,8),exportLogs:n.slice(0,8),administrativeActions:u.slice(0,8),deletionActivities:v.slice(0,8)}}function F(a,b,{base:c}={}){var d,e,f;let m,v,w,x,y,z=o(),A=p(a?.title,p(c?.title));if(!A)throw Error("invalid_incident_title");let B=M(a?.detectedAt||c?.detectedAt||z)||z,E=C(a?.severity,p(c?.severity,"Low")),G=function(a,b="Other"){let c=p(a,b).toLowerCase();return j.find(a=>a.toLowerCase()===c)||"Other"}(a?.incidentType,p(c?.incidentType,"Other")),H=u(a?.restrictedPiiInvolved,u(c?.restrictedPiiInvolved,!1)),I=u(a?.executiveNotificationRequired,"High"===E||u(c?.executiveNotificationRequired,!1)),J=u(a?.escalationRequired,I||H||D(E)>=D("High")||u(c?.escalationRequired,!1)),K=function({severity:a,restrictedPiiInvolved:b,executiveNotificationRequired:c}){return"High"===a||c?"Executive":b?"GRC":"Operational"}({severity:E,restrictedPiiInvolved:H,executiveNotificationRequired:I}),N=function(a,b="Open"){let c=p(a,b).toLowerCase();return g.find(a=>a.toLowerCase()===c)||"Open"}(a?.status,p(c?.status,"Open")),O=function(a,b="Not Started"){let c=p(a,b).toLowerCase();return h.find(a=>a.toLowerCase()===c)||"Not Started"}(a?.containmentStatus,p(c?.containmentStatus,"Not Started")),P=function(a,b="Pending"){let c=p(a,b).toLowerCase();return i.find(a=>a.toLowerCase()===c)||"Pending"}(a?.impactAssessmentStatus,p(c?.impactAssessmentStatus,"Pending")),Q=u(a?.regulatoryNotificationRequired,H||u(c?.regulatoryNotificationRequired,!1)),R=Q?p(c?.regulatoryDueAt,(m=Number.isFinite(Number(72))?Number(72):0,Number.isNaN((v=new Date(B||o())).getTime())?o():(v.setTime(v.getTime()+60*Math.max(0,m)*6e4),v.toISOString()))):"",S=M(a?.regulatoryNotifiedAt||c?.regulatoryNotifiedAt||""),T=M(a?.affectedIndividualsNotifiedAt||c?.affectedIndividualsNotifiedAt||""),U=function({regulatoryNotificationRequired:a,regulatoryNotifiedAt:b,regulatoryDueAt:c,nowIsoValue:d=o()}){if(!a)return"Not Required";if(L(b))return"Notified";let e=L(c),f=L(d)||Date.now();return Number.isFinite(e)&&e<f?"Overdue":"Pending"}({regulatoryNotificationRequired:Q,regulatoryNotifiedAt:S,regulatoryDueAt:R,nowIsoValue:z}),V=u(a?.documentationRetained,u(c?.documentationRetained,!1)),W=V?M(a?.documentationRetainedAt||c?.documentationRetainedAt||z)||z:"",X=M(a?.executiveNotifiedAt||c?.executiveNotifiedAt||""),Y=J?M(a?.grcAlertedAt||c?.grcAlertedAt||z)||z:"",Z=u(a?.breachConfirmed,u(c?.breachConfirmed,!1)),$=Z?M(a?.breachConfirmedAt||c?.breachConfirmedAt||z)||z:"",_=Z?r(a?.breachConfirmedBy||c?.breachConfirmedBy||b):"",aa="In Progress"===O||"Contained"===O?M(a?.containmentStartedAt||c?.containmentStartedAt||z)||z:M(a?.containmentStartedAt||c?.containmentStartedAt||""),ab="Contained"===O?M(a?.containmentCompletedAt||c?.containmentCompletedAt||z)||z:M(a?.containmentCompletedAt||c?.containmentCompletedAt||""),ac="Completed"===P?M(a?.impactAssessmentCompletedAt||c?.impactAssessmentCompletedAt||z)||z:M(a?.impactAssessmentCompletedAt||c?.impactAssessmentCompletedAt||""),ad=M(a?.forensicWindowStart||c?.forensicWindowStart||B)||B,ae=M(a?.forensicWindowEnd||c?.forensicWindowEnd||z)||z,af=(d=Object.prototype.hasOwnProperty.call(t(a,{}),"evidenceDocuments")?a?.evidenceDocuments:c?.evidenceDocuments,w=p(z,o()),x={maxBytes:function(a,b,{min:c=1,max:d=Number.MAX_SAFE_INTEGER}={}){let e=Number.parseInt(String(process.env[a]||"").trim(),10);return Number.isFinite(e)?Math.min(d,Math.max(c,e)):0xa00000}("CLIO_INCIDENT_EVIDENCE_MAX_BYTES",0,{min:131072,max:0x3200000}),allowedExtensions:n(process.env.CLIO_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS,k),allowedMimeTypes:n(process.env.CLIO_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES,l)},s(d).map((a,c)=>{let d=t(a,{}),e=M(d.uploadedAt||w)||w,f=r(d.uploadedBy||b),g=p(d.name,`Incident Evidence ${c+1}`),h=p(d.type,"Incident Evidence"),i=p(d.ref),j=p(d.storagePath),k=function(a){let b=p(a).toLowerCase();if(!b)return"";let c=b.split("?")[0].split("#")[0].split(".").pop()||"";return/^[a-z0-9]{2,10}$/.test(c)?c:""}(d.fileExtension||g||j||i),l=q(d.contentType),m=Number.isFinite(Number(d.sizeBytes))?Number(d.sizeBytes):0,n=p(d.id||d.recordId||j||`${c+1}`);if(!g&&!i&&!j)return null;if(k&&!x.allowedExtensions.has(k))throw Error("invalid_incident_evidence_extension");if(l&&!x.allowedMimeTypes.has(l))throw Error("invalid_incident_evidence_content_type");if(m>x.maxBytes)throw Error("invalid_incident_evidence_size");return{id:n,name:g||"Incident Evidence",type:h||"Incident Evidence",ref:i,storagePath:j,fileExtension:k,contentType:l,sizeBytes:m,scanStatus:p(d.scanStatus),scanReference:p(d.scanReference),scannedAt:M(d.scannedAt||""),uploadedAt:e,uploadedBy:f||b}}).filter(Boolean).slice(0,50)),ag=M(a?.detectionWindowStart||c?.detectionWindowStart||""),ah=M(a?.detectionWindowEnd||c?.detectionWindowEnd||""),ai=p(a?.detectionCorrelationKey,p(c?.detectionCorrelationKey)),aj=p(a?.alertDescription,p(c?.alertDescription)),ak=s(a?.alertOccurrences||c?.alertOccurrences).map(a=>{let b=t(a,{}),c=M(b.at||b.occurredAt||"");return c?{at:c,activityName:p(b.activityName||b.action||"Activity"),module:p(b.module||"System"),sourceEventId:p(b.sourceEventId||b.eventId||""),sourceIp:p(b.sourceIp||""),requestPath:p(b.requestPath||""),requestMethod:p(b.requestMethod||""),actorEmail:r(b.actorEmail||b.performedBy||""),targetEmployeeEmail:r(b.targetEmployeeEmail||b.employeeEmail||"")}:null}).filter(Boolean).slice(-40),al=M(a?.alertFirstObservedAt||c?.alertFirstObservedAt||B||""),am=M(a?.alertLastObservedAt||c?.alertLastObservedAt||B||""),an=ak.length>0?ak.length:1,ao=Math.max(1,Number.parseInt(String(a?.alertOccurrenceCount??c?.alertOccurrenceCount??an),10)||an),ap=s(a?.alertRecipients||c?.alertRecipients).map(a=>r(a)).filter(Boolean).slice(0,40),aq=s(a?.involvedEmployees||c?.involvedEmployees).map(a=>r(a)).filter(Boolean).slice(0,40);return{incidentCode:p(c?.incidentCode,function(a=o()){let b=new Date(a||o());if(Number.isNaN(b.getTime()))return`INC-${Date.now().toString().slice(-10)}`;let c=String(b.getUTCFullYear()),d=String(b.getUTCMonth()+1).padStart(2,"0"),e=String(b.getUTCDate()).padStart(2,"0"),f=String(b.getUTCHours()).padStart(2,"0"),g=String(b.getUTCMinutes()).padStart(2,"0"),h=Math.random().toString(36).slice(2,5).toUpperCase();return`INC-${c}${d}${e}-${f}${g}${h}`}(B)),title:A,summary:p(a?.summary,p(c?.summary)),incidentType:G,severity:E,status:N,restrictedPiiInvolved:H,affectedEmployeeEmail:r(a?.affectedEmployeeEmail||c?.affectedEmployeeEmail),ownerEmail:r(a?.ownerEmail||c?.ownerEmail||b),department:p(a?.department,p(c?.department)),involvedEmployees:aq,escalationRequired:J,escalationLevel:K,executiveNotificationRequired:I,executiveNotifiedAt:X,grcAlertedAt:Y,containmentStatus:O,containmentSummary:p(a?.containmentSummary,p(c?.containmentSummary)),containmentStartedAt:aa,containmentCompletedAt:ab,impactAssessmentStatus:P,impactSummary:p(a?.impactSummary,p(c?.impactSummary)),impactAssessmentCompletedAt:ac,regulatoryNotificationRequired:Q,regulatoryDueAt:R,regulatoryNotifiedAt:S,affectedIndividualsNotifiedAt:T,regulatoryStatus:U,documentationRetained:V,documentationRetainedAt:W,documentationLocation:p(a?.documentationLocation,p(c?.documentationLocation)),breachConfirmed:Z,breachConfirmedAt:$,breachConfirmedBy:_,correctiveActions:p(a?.correctiveActions,p(c?.correctiveActions)),disciplinaryActions:p(a?.disciplinaryActions,p(c?.disciplinaryActions)),resolutionNotes:p(a?.resolutionNotes,p(c?.resolutionNotes)),closureApprovalStatus:p(a?.closureApprovalStatus,p(c?.closureApprovalStatus,"Pending Approval")),closureApprovedBy:p(a?.closureApprovedBy,p(c?.closureApprovedBy)),closureApprovedAt:M(a?.closureApprovedAt||c?.closureApprovedAt||""),forensicWindowStart:ad,forensicWindowEnd:ae,evidenceDocuments:af,evidenceDocumentsCount:af.length,notes:p(a?.notes,p(c?.notes)),classificationStandard:p(a?.classificationStandard,p(c?.classificationStandard,"CLIO-IR-SEVERITY-V1")),autoGenerated:u(a?.autoGenerated,u(c?.autoGenerated,!1)),detectionRuleId:p(a?.detectionRuleId,p(c?.detectionRuleId)),detectionFingerprint:p(a?.detectionFingerprint,p(c?.detectionFingerprint)),detectionCorrelationKey:ai,detectionWindowStart:ag,detectionWindowEnd:ah,alertDescription:aj,alertOccurrenceCount:ao,alertFirstObservedAt:al,alertLastObservedAt:am,alertOccurrences:ak,sourceSystem:p(a?.sourceSystem,p(c?.sourceSystem)),sourceEventId:p(a?.sourceEventId,p(c?.sourceEventId)),sourceEventModule:p(a?.sourceEventModule,p(c?.sourceEventModule)),sourceEventPath:p(a?.sourceEventPath,p(c?.sourceEventPath)),sourceIp:p(a?.sourceIp,p(c?.sourceIp)),alertRecipients:ap,alertDispatchSummary:t(a?.alertDispatchSummary,t(c?.alertDispatchSummary,{})),externalIntegrations:t(a?.externalIntegrations,t(c?.externalIntegrations,{})),lastAlertDispatchAt:M(a?.lastAlertDispatchAt||c?.lastAlertDispatchAt||""),detectedAt:B,resolvedAt:M(a?.resolvedAt||c?.resolvedAt||("Resolved"===N?z:"")),closedAt:M(a?.closedAt||c?.closedAt||("Closed"===N?z:"")),createdAt:p(c?.createdAt,z),createdBy:p(c?.createdBy,b),updatedAt:z,updatedBy:b,traceability:(e=c?.traceability,f={at:z,by:b,action:c?"update":"create",status:N,severity:E,escalationLevel:K,regulatoryStatus:U},(y=[...s(e),f]).length<=80?y:y.slice(y.length-80))}}function G(a,b,c){let d=t(b,{});return{...a,forensicSnapshot:d,forensicSummary:{accessLogsCount:Number(d.accessLogsCount||0),exportLogsCount:Number(d.exportLogsCount||0),administrativeActionsCount:Number(d.administrativeActionsCount||0),deletionActivitiesCount:Number(d.deletionActivitiesCount||0),totalScopedLogs:Number(d.totalScopedLogs||0),generatedAt:p(d.generatedAt),windowStart:p(d.windowStart),windowEnd:p(d.windowEnd)},forensicLastUpdatedAt:p(d.generatedAt,o()),forensicLastUpdatedBy:c}}async function H(){return await y(w("incidents"))}async function I(a){return await z(w("incidents"),a)}async function J(a,b){let c=F(a,b),d=await E(c,{limit:Number.parseInt(m("CLIO_INCIDENT_FORENSIC_LOG_LIMIT","1800"),10)}),e=G(c,d,b);return await A(w("incidents"),e)}async function K(a,b,c){let d=await I(a);if(!d)return null;let e=F(b,c,{base:d}),f=u(b?.refreshForensicSnapshot,!1)||Object.prototype.hasOwnProperty.call(t(b,{}),"forensicWindowStart")||Object.prototype.hasOwnProperty.call(t(b,{}),"forensicWindowEnd")||Object.prototype.hasOwnProperty.call(t(b,{}),"affectedEmployeeEmail")||Object.prototype.hasOwnProperty.call(t(b,{}),"detectedAt")?await E(e,{limit:Number.parseInt(m("CLIO_INCIDENT_FORENSIC_LOG_LIMIT","1800"),10)}):t(d.forensicSnapshot,{}),g=G(e,f,c);return await B(w("incidents"),a,g)}function L(a){let b=new Date(a||"").getTime();return Number.isNaN(b)?null:b}function M(a){let b=L(a);return Number.isFinite(b)?new Date(b).toISOString():""}function N(a,b=""){return String(a||"").trim()||b}function O(a){return Array.isArray(a)?a:[]}function P(a){return String(a||"").trim().toLowerCase()}async function Q(a){let d=(0,c.isFirestoreEnabled)()?(0,c.getFirestoreDb)():null;if(!d)return null;let e=function(a){var b;let c,d=new Date().toISOString(),e=P(a?.recipientEmail),f=function(a,b=!1){if("boolean"==typeof a)return a;if("number"==typeof a)return 0!==a;if("string"==typeof a){let c=a.trim().toLowerCase();if(!c)return b;if(["true","1","yes","on","y"].includes(c))return!0;if(["false","0","no","off","n"].includes(c))return!1}return b}(a?.broadcast,!1);if(!e&&!f)throw Error("invalid_notification_recipient");return{title:N(a?.title,"Security notification"),message:N(a?.message,"A security event requires review."),severity:"critical"===(c=String(a?.severity||"").trim().toLowerCase())?"critical":"high"===c?"high":"low"===c?"low":"medium",type:N(a?.type,"security"),module:N(a?.module,"Incident Management"),actionUrl:N(a?.actionUrl,"/incident-management"),recipientEmail:e,broadcast:f,status:"read"===String(a?.status||"").trim().toLowerCase()?"read":"unread",metadata:(b=a?.metadata)&&"object"==typeof b&&!Array.isArray(b)?b:{},createdAt:N(a?.createdAt,d),updatedAt:N(a?.updatedAt,d),readAt:N(a?.readAt,""),createdBy:P(a?.createdBy)}}(a),f=await (0,b.addDoc)((0,b.collection)(d,N(process.env.CLIO_FIRESTORE_NOTIFICATIONS_COLLECTION,"clio_notifications")),e);return{...e,id:f.id,recordId:f.id}}async function R(a){let b=O(a);if(0===b.length)return[];let c=[];for(let a of b){let b=await Q(a);b&&c.push(b)}return c}async function S({ownerEmail:a,affectedEmployeeEmail:b,actorEmail:c,includeAffectedEmployee:e=!0,includeActor:f=!1}={}){let g=[P(process.env.CLIO_GRC_ALERT_EMAIL),...String(process.env.GRC_EMAILS||"").split(",").map(a=>P(a)).filter(Boolean),P(a)];e&&g.push(P(b)),f&&g.push(P(c));let h=[];try{let a=await (0,d.listUserAccounts)();h=O(a).filter(a=>P(a?.email)).filter(a=>{var b;return"active"===(b=a?.status,String(b||"").trim().toLowerCase())}).filter(a=>{let b=String(a?.role||"").trim().toUpperCase();return"GRC"===b}).map(a=>P(a?.email))}catch{h=[]}return function(a=[]){return Array.from(new Set(O(a).map(a=>P(a)).filter(Boolean)))}([...g,...h])}function T(a,b=""){return String(a||"").trim()||b}function U(a){return Array.isArray(a)?a:[]}function V(a){return T(a).toLowerCase()}function W(a){return String(a||"").replace(/[^\d+]/g,"").trim()}function X(a){return T(a).split(",").map(a=>a.trim()).filter(Boolean)}function Y(a=[]){return Array.from(new Set(a.filter(Boolean)))}function Z(){let a,b=(a=T(process.env.CLIO_ALERT_EMAIL_PROVIDER).toLowerCase())?a.includes("resend")?"resend":a.includes("firebase")?"firebase":a.includes("console")||"dev"===a?"console":"none"===a||"off"===a?"none":a:"";return b||"none"}function $(){let a,b=(a=T(process.env.CLIO_ALERT_SMS_PROVIDER).toLowerCase())?a.includes("twilio")?"twilio":a.includes("console")||"dev"===a?"console":"none"===a||"off"===a?"none":a:"";return b||"none"}function _(a=[]){return Y([...X(process.env.CLIO_SECURITY_ALERT_RECIPIENTS),...X(process.env.GRC_EMAILS),...X(process.env.SUPER_ADMIN_EMAILS),...U(a)].map(a=>V(a)).filter(Boolean))}async function aa({recipients:a,subject:b,text:c,html:d}){let e=T(process.env.RESEND_API_KEY),f=T(process.env.CLIO_EMAIL_FROM);if(!e||!f||!e.startsWith("re_"))throw Error("email_provider_not_configured");let g=await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({from:f,to:a,subject:b,text:c,html:d})}),h=await g.json().catch(()=>({}));if(!g.ok){let a=T(h?.message)||T(h?.error?.message)||"email_delivery_failed";throw Error(`email_delivery_failed:${a}`)}return{provider:"resend",status:"sent",messageId:T(h?.id,`resend-${Date.now()}`),recipientCount:a.length}}async function ab({recipients:a,subject:b,text:c,html:d}){let e=Y(U(a).map(V).filter(Boolean));if(0===e.length)return{provider:"none",status:"skipped",reason:"no_recipients",recipientCount:0};let f=Z();return"none"===f?{provider:f,status:"skipped",reason:"provider_disabled",recipientCount:0}:"firebase"===f?{provider:f,status:"skipped",reason:"firebase_not_supported_for_custom_alert_email",recipientCount:0}:"console"===f?function({recipients:a,subject:b,text:c}){return function(a,b=!1){let c=T(process.env[a]).toLowerCase();return c?"true"===c||"1"===c||"yes"===c:b}("CLIO_ALLOW_CONSOLE_EMAIL",!0)&&console.info("[CLIO:SecurityAlert:Email]",{recipients:a,subject:b,text:c}),{provider:"console",status:"simulated",recipientCount:a.length}}({recipients:e,subject:b,text:c}):"resend"===f?await aa({recipients:e,subject:b,text:c,html:d}):{provider:f,status:"skipped",reason:"unsupported_provider",recipientCount:0}}async function ac({recipients:a,body:b}){let c=T(process.env.TWILIO_ACCOUNT_SID),d=T(process.env.TWILIO_AUTH_TOKEN),e=T(process.env.TWILIO_FROM_NUMBER);if(!c||!d||!e)throw Error("twilio_not_configured");let f=Buffer.from(`${c}:${d}`,"utf8").toString("base64"),g=a.map(async a=>{let d=new URLSearchParams;d.set("To",a),d.set("From",e),d.set("Body",b);let g=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${encodeURIComponent(c)}/Messages.json`,{method:"POST",headers:{Authorization:`Basic ${f}`,"Content-Type":"application/x-www-form-urlencoded"},body:d.toString()}),h=await g.json().catch(()=>({}));if(!g.ok){let a=T(h?.message,"sms_delivery_failed");throw Error(`twilio_delivery_failed:${a}`)}return{to:a,sid:T(h?.sid)}}),h=await Promise.allSettled(g),i=h.filter(a=>"fulfilled"===a.status).map(a=>a.value),j=h.filter(a=>"rejected"===a.status).map(a=>T(a.reason?.message||"sms_delivery_failed"));return{provider:"twilio",status:j.length>0?i.length>0?"partial":"failed":"sent",deliveredCount:i.length,recipientCount:a.length,delivered:i,failed:j}}async function ad({recipients:a,body:b}){let c=Y(U(a).map(W).filter(Boolean));if(0===c.length)return{provider:"none",status:"skipped",reason:"no_recipients",deliveredCount:0,recipientCount:0,failed:[]};let d=$();return"none"===d?{provider:d,status:"skipped",reason:"provider_disabled",deliveredCount:0,recipientCount:c.length,failed:[]}:"console"===d?function({recipients:a,body:b}){return{provider:"console",status:"simulated",deliveredCount:a.length,recipientCount:a.length,delivered:a.map(a=>({to:a,sid:`console-${Date.now()}`})),failed:[]}}({recipients:c,body:b}):"twilio"===d?await ac({recipients:c,body:b}):{provider:d,status:"skipped",reason:"unsupported_provider",deliveredCount:0,recipientCount:c.length,failed:[]}}async function ae({url:a,label:b,token:c,payload:d,timeoutMs:e}){let f=new AbortController,g=setTimeout(()=>f.abort(),e);try{let e={"Content-Type":"application/json","X-CLIO-Source":"security-detection","X-CLIO-Target":b};c&&(e.Authorization=`Bearer ${c}`);let g=await fetch(a,{method:"POST",headers:e,body:JSON.stringify(d),signal:f.signal}),h=await g.text().catch(()=>"");return{label:b,url:a,ok:g.ok,status:g.status,body:T(h)}}catch(c){return{label:b,url:a,ok:!1,status:0,body:T(c?.message,"webhook_delivery_failed")}}finally{clearTimeout(g)}}async function af(a){let b,c,d,e,f=(b=X(process.env.CLIO_SECURITY_WEBHOOK_URLS).map(a=>({label:"security-webhook",url:a,token:T(process.env.CLIO_SECURITY_WEBHOOK_TOKEN)})),c=T(process.env.CLIO_SIEM_WEBHOOK_URL),d=T(process.env.CLIO_EDR_WEBHOOK_URL),e=[...b],c&&e.push({label:"siem",url:c,token:T(process.env.CLIO_SIEM_WEBHOOK_TOKEN)}),d&&e.push({label:"edr",url:d,token:T(process.env.CLIO_EDR_WEBHOOK_TOKEN)}),e.filter(a=>T(a.url)));if(0===f.length)return{status:"skipped",targets:[],successCount:0};let g=Number.parseInt(T(process.env.CLIO_SECURITY_WEBHOOK_TIMEOUT_MS,"5000"),10)||5e3,h=await Promise.all(f.map(b=>ae({...b,payload:a,timeoutMs:Math.max(1e3,Math.min(2e4,g))}))),i=h.filter(a=>a.ok).length;return{status:i===h.length?"sent":i>0?"partial":"failed",targets:h,successCount:i}}async function ag({incident:a,detection:b,sourceEvent:c,emailRecipients:d=[],smsRecipients:e=[]}={}){let f,g=_(d),h=function(a=[]){return Y([...X(process.env.CLIO_SMS_ALERT_RECIPIENTS),...U(a)].map(a=>W(a)).filter(Boolean))}(e),i=function({incident:a,detection:b}){let c=T(a?.severity||b?.severity||"Medium").toUpperCase(),d=T(a?.incidentCode,"INCIDENT"),e=T(a?.title,"Security anomaly detected");return`[CLIO][${c}] ${d} - ${e}`}({incident:a,detection:b}),j=function({incident:a,detection:b,sourceEvent:c}){let d=T(b?.ruleId,"N/A"),e=T(c?.metadata?.sourceIp||c?.sourceIp,"unknown"),f=T(c?.performedBy,"unknown"),g=T(c?.metadata?.requestPath||c?.requestPath,"unknown"),h=Number(b?.observedCount||0),i=T(a?.detectedAt||c?.occurredAt,new Date().toISOString());return`CLIO security anomaly alert
Incident: ${T(a?.incidentCode,"-")} | ${T(a?.title,"-")}
Severity: ${T(a?.severity,"-")}
Rule: ${d}
Detected At: ${i}
Actor: ${f}
Source IP: ${e}
Request Path: ${g}
Observed Count: ${h>0?h:"-"}
Summary: ${T(a?.summary||b?.summary,"-")}
Action URL: ${T(a?.actionUrl,"/incident-management")}`}({incident:a,detection:b,sourceEvent:c}),k=(f=String(j||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"),`<pre style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap;">${f}</pre>`),[l,m,n]=await Promise.all([ab({recipients:g,subject:i,text:j,html:k}).catch(a=>({provider:Z(),status:"failed",reason:T(a?.message,"email_delivery_failed"),recipientCount:g.length})),ad({recipients:h,body:`${i}
${j}`.slice(0,1200)}).catch(a=>({provider:$(),status:"failed",reason:T(a?.message,"sms_delivery_failed"),deliveredCount:0,recipientCount:h.length,failed:[T(a?.message,"sms_delivery_failed")]})),af({eventType:"clio.security.incident",generatedAt:new Date().toISOString(),incident:a,detection:b,sourceEvent:{id:T(c?.id),module:T(c?.module),activityName:T(c?.activityName),status:T(c?.status),occurredAt:T(c?.occurredAt),sourceIp:T(c?.metadata?.sourceIp||c?.sourceIp),requestPath:T(c?.metadata?.requestPath||c?.requestPath)}})]);return{subject:i,email:l,sms:m,webhooks:n,recipients:g,smsRecipients:h}}let ah=new Map,ai=new Map,aj="system@gmail.com",ak=null,al=new Set(["missing_permission","role_not_allowed","ownership_validation_failed","unauthorized","account_not_active","session_role_mismatch","session_version_mismatch"]),am=new Set(["account_disabled","account_inactive","account_archived","offboarded_user"]),an=new Set(["SUPER_ADMIN","GRC","HR","EA"]);function ao(){return new Date().toISOString()}function ap(a,b=""){return String(a||"").trim()||b}function aq(a){return a&&"object"==typeof a&&!Array.isArray(a)?a:{}}function ar(a){return Array.isArray(a)?a:[]}function as(a){return ap(a).toLowerCase()}function at(a){return ap(a).toLowerCase()}function au(a){return ap(a).toLowerCase()||"unknown"}function av(a){return ap(a).toUpperCase().replace(/[^A-Z0-9]+/g,"_").replace(/^_+|_+$/g,"")}function aw(a){let b=new Date(a||"").getTime();return Number.isNaN(b)?null:b}function ax(a,b=!1){let c=as(process.env[a]);return c?"true"===c||"1"===c||"yes"===c:b}function ay(a,b,{min:c=1,max:d=Number.MAX_SAFE_INTEGER}={}){let e=Number.parseInt(ap(process.env[a]),10);return Number.isFinite(e)?Math.min(d,Math.max(c,e)):b}function az(a){let b=ap(a);return b?b.startsWith("http://")||b.startsWith("https://")?b.replace(/\/+$/,""):`https://${b.replace(/^\/+/,"").replace(/\/+$/,"")}`:""}function aA(){return(0,c.isFirestoreEnabled)()?(0,c.getFirestoreDb)():null}function aB(){return{enabled:ax("CLIO_IDS_ENABLED",!0),authFailureThreshold:ay("CLIO_IDS_AUTH_FAILURE_THRESHOLD",5,{min:2,max:30}),authFailureWindowMinutes:ay("CLIO_IDS_AUTH_FAILURE_WINDOW_MINUTES",10,{min:1,max:120}),permissionDeniedThreshold:ay("CLIO_IDS_PERMISSION_DENIED_THRESHOLD",3,{min:2,max:20}),permissionDeniedWindowMinutes:ay("CLIO_IDS_PERMISSION_DENIED_WINDOW_MINUTES",15,{min:1,max:120}),exportSpikeThreshold:ay("CLIO_IDS_EXPORT_SPIKE_THRESHOLD",4,{min:2,max:20}),exportSpikeWindowMinutes:ay("CLIO_IDS_EXPORT_SPIKE_WINDOW_MINUTES",20,{min:1,max:180}),piiAccessSpikeThreshold:ay("CLIO_IDS_PII_ACCESS_SPIKE_THRESHOLD",12,{min:4,max:80}),piiAccessSpikeWindowMinutes:ay("CLIO_IDS_PII_ACCESS_SPIKE_WINDOW_MINUTES",15,{min:1,max:180}),offboardedAccessThreshold:ay("CLIO_IDS_OFFBOARDED_ACCESS_THRESHOLD",2,{min:1,max:30}),offboardedAccessWindowMinutes:ay("CLIO_IDS_OFFBOARDED_ACCESS_WINDOW_MINUTES",30,{min:1,max:240}),privilegedRoleChangeThreshold:ay("CLIO_IDS_ROLE_ESCALATION_THRESHOLD",2,{min:1,max:20}),privilegedRoleChangeWindowMinutes:ay("CLIO_IDS_ROLE_ESCALATION_WINDOW_MINUTES",60,{min:1,max:480}),breachWindowMinutes:ay("CLIO_IDS_BREACH_WINDOW_MINUTES",30,{min:5,max:240}),breachExportThreshold:ay("CLIO_IDS_BREACH_EXPORT_THRESHOLD",2,{min:1,max:50}),breachPiiThreshold:ay("CLIO_IDS_BREACH_PII_THRESHOLD",6,{min:1,max:120}),breachDeniedThreshold:ay("CLIO_IDS_BREACH_DENIED_THRESHOLD",2,{min:0,max:50}),incidentCooldownMinutes:ay("CLIO_IDS_INCIDENT_COOLDOWN_MINUTES",15,{min:1,max:360}),maxRecipientCount:ay("CLIO_IDS_MAX_RECIPIENTS",20,{min:1,max:100}),systemActorEmail:at(process.env.CLIO_IDS_SYSTEM_ACTOR_EMAIL)||aj,appBaseUrl:function(){let a=az(process.env.CLIO_APP_BASE_URL);if(a)return a;let b=az(process.env.NEXT_PUBLIC_APP_URL);if(b)return b;let c=az("atracaas-platform-1fbeb.firebaseapp.com");if(c)return c;let d=az(process.env.VERCEL_PROJECT_PRODUCTION_URL||process.env.VERCEL_URL);return d||""}(),retryEnabled:ax("CLIO_IDS_RETRY_ENABLED",!0),retryBatchSize:ay("CLIO_IDS_RETRY_BATCH_SIZE",8,{min:1,max:32}),retryMaxAttempts:ay("CLIO_IDS_RETRY_MAX_ATTEMPTS",5,{min:1,max:20}),retryBaseBackoffSeconds:ay("CLIO_IDS_RETRY_BASE_BACKOFF_SECONDS",30,{min:5,max:3600}),retryMaxBackoffSeconds:ay("CLIO_IDS_RETRY_MAX_BACKOFF_SECONDS",1800,{min:30,max:86400}),retryCollectionName:ap(process.env.CLIO_FIRESTORE_IDS_RETRY_COLLECTION,"clio_ids_retry_queue"),deadLetterCollectionName:ap(process.env.CLIO_FIRESTORE_IDS_DEAD_LETTER_COLLECTION,"clio_ids_dead_letter")}}function aC(a,b,c){let d=b-c;return a.filter(a=>a>=d).slice(-256)}function aD(a,b,c){let d=ap(a);if(!d)return 0;let e=Number.isFinite(b)?b:Date.now(),f=aC(ah.get(d)||[],e,c);return f.push(e),ah.set(d,f),f.length}function aE(a,b,c){let d=ap(a);if(!d)return 0;let e=Number.isFinite(b)?b:Date.now(),f=aC(ah.get(d)||[],e,c);return ah.set(d,f),f.length}function aF(a,b,c){let d=60*Math.max(1,Number(c||1))*1e3;ai.set(a,b+d)}function aG(a){let b=aq(a?.metadata);return{at:ap(a?.occurredAt,ao()),activityName:ap(a?.activityName,"Activity"),module:ap(a?.module,"System"),sourceEventId:ap(a?.id),sourceIp:ap(b.sourceIp||a?.sourceIp),requestPath:ap(b.requestPath||a?.requestPath),requestMethod:ap(b.requestMethod||a?.requestMethod),actorEmail:at(a?.performedBy),targetEmployeeEmail:at(b.targetEmployeeEmail||b.employeeEmail||b.affectedEmployeeEmail)}}function aH(a,b,c){let d=as(a);return"critical"===d||b>=2*Math.max(1,Number(c||1))||"high"===d?"High":"Low"}function aI(a){return"failed"===a||"rejected"===a}function aJ(a,b,c){if(!b.moduleName.includes("authentication")||!aI(b.status))return null;let d=aD(`auth-fail:${b.sourceIp||b.actorEmail||"unknown"}`,b.occurredAtMs,60*c.authFailureWindowMinutes*1e3);return d<c.authFailureThreshold?null:{ruleId:"AUTH_BRUTE_FORCE",incidentType:"Credential Compromise",severity:aH("high",d,c.authFailureThreshold),restrictedPiiInvolved:!1,observedCount:d,windowMinutes:c.authFailureWindowMinutes,affectedEmployeeEmail:b.actorEmail,title:"Repeated authentication failures detected",summary:`Detected ${d} failed/rejected authentication events from ${b.sourceIp} within ${c.authFailureWindowMinutes} minute(s).`,tags:["authentication","brute-force","ids"]}}function aK(a,b,c){if(!(aI(b.status)&&(al.has(b.reason)||b.activityName.includes("permission")||b.activityName.includes("ownership")||b.activityName.includes("forbidden"))))return null;let d=aD(`permission-denied:${b.actorEmail||b.sourceIp||"unknown"}`,b.occurredAtMs,60*c.permissionDeniedWindowMinutes*1e3);if(d<c.permissionDeniedThreshold)return null;let e=b.moduleName.includes("employee records")||b.moduleName.includes("performance")||b.moduleName.includes("attendance");return{ruleId:"UNAUTHORIZED_ACCESS_ATTEMPT",incidentType:"Unauthorized Access",severity:aH(e?"high":"low",d,c.permissionDeniedThreshold),restrictedPiiInvolved:e,observedCount:d,windowMinutes:c.permissionDeniedWindowMinutes,affectedEmployeeEmail:b.targetEmployeeEmail||b.actorEmail,title:"Repeated unauthorized access attempts detected",summary:`Detected ${d} permission/ownership denials for actor ${b.actorEmail||"unknown"} within ${c.permissionDeniedWindowMinutes} minute(s).`,tags:["authorization","idor","least-privilege","ids"]}}function aL(a,b,c){if(!(b.moduleName.includes("export")||b.requestPath.includes("/api/hris/exports")||b.activityName.includes("export"))||"approved"!==b.status&&"completed"!==b.status)return null;let d=aD(`export-spike:${b.actorEmail||b.sourceIp||"unknown"}`,b.occurredAtMs,60*c.exportSpikeWindowMinutes*1e3);return d<c.exportSpikeThreshold?null:{ruleId:"MASS_EXPORT_ACTIVITY",incidentType:"Data Exposure",severity:aH("high",d,c.exportSpikeThreshold),restrictedPiiInvolved:!0,observedCount:d,windowMinutes:c.exportSpikeWindowMinutes,affectedEmployeeEmail:b.targetEmployeeEmail||"",title:"Mass export activity detected",summary:`Detected ${d} export-related actions by ${b.actorEmail||b.sourceIp} within ${c.exportSpikeWindowMinutes} minute(s).`,tags:["export","dlp","ids"]}}function aM(a,b,c){let d=b.activityName.includes("view")||b.activityName.includes("list");if(!(b.moduleName.includes("employee records")&&d&&aI(b.status)&&(al.has(b.reason)||b.activityName.includes("permission")||b.activityName.includes("ownership")||b.activityName.includes("forbidden"))))return null;let e=aD(`unauthorized-record-view:${b.actorEmail||b.sourceIp||"unknown"}`,b.occurredAtMs,60*c.piiAccessSpikeWindowMinutes*1e3);return e<c.piiAccessSpikeThreshold?null:{ruleId:"UNAUTHORIZED_RECORD_VIEW_SPIKE",incidentType:"Unauthorized Access",severity:aH("high",e,c.piiAccessSpikeThreshold),restrictedPiiInvolved:!0,observedCount:e,windowMinutes:c.piiAccessSpikeWindowMinutes,affectedEmployeeEmail:b.targetEmployeeEmail||"",title:"Unauthorized employee-record view attempts detected",summary:`Detected ${e} denied employee-record view/list actions in ${c.piiAccessSpikeWindowMinutes} minute(s).`,tags:["authorization","employee-records","pii","ids"]}}function aN(a,b,c){let d=b.moduleName.includes("authentication")||b.requestPath.includes("/api/auth/"),e=aI(b.status)&&(am.has(b.reason)||b.activityName.includes("account disabled")||b.activityName.includes("account inactive")||b.activityName.includes("offboard"));if(!(d&&e))return null;let f=aD(`offboarded-access:${b.actorEmail||b.sourceIp||"unknown"}`,b.occurredAtMs,60*c.offboardedAccessWindowMinutes*1e3);return f<c.offboardedAccessThreshold?null:{ruleId:"OFFBOARDED_ACCESS_ATTEMPT",incidentType:"Unauthorized Access",severity:aH("high",f,c.offboardedAccessThreshold),restrictedPiiInvolved:!0,observedCount:f,windowMinutes:c.offboardedAccessWindowMinutes,affectedEmployeeEmail:b.actorEmail||b.targetEmployeeEmail,title:"Offboarded/disabled account access attempts detected",summary:`Detected ${f} blocked sign-in/access attempts for disabled or offboarded account ${b.actorEmail||"unknown"} within ${c.offboardedAccessWindowMinutes} minute(s).`,tags:["authentication","offboarding","access-control","ids"]}}function aO(a,b,c){if(!(b.moduleName.includes("user management")&&b.activityName.includes("role updated")&&("approved"===b.status||"completed"===b.status))||!b.targetRole||!an.has(b.targetRole))return null;let d=aD(`priv-role-assignment:${b.actorEmail||"unknown"}:${b.targetRole}`,b.occurredAtMs,60*c.privilegedRoleChangeWindowMinutes*1e3);return d<c.privilegedRoleChangeThreshold?null:{ruleId:"PRIVILEGED_ROLE_ASSIGNMENT_SPIKE",incidentType:"Policy Violation",severity:aH("high",d,c.privilegedRoleChangeThreshold),restrictedPiiInvolved:!0,observedCount:d,windowMinutes:c.privilegedRoleChangeWindowMinutes,affectedEmployeeEmail:b.targetEmployeeEmail||"",title:"Privileged role assignment spike detected",summary:`Detected ${d} privileged role assignments (${b.targetRole}) by ${b.actorEmail||"unknown"} within ${c.privilegedRoleChangeWindowMinutes} minute(s).`,tags:["rbac","role-assignment","privilege","ids"]}}function aP(a,b,c){let d=60*c.breachWindowMinutes*1e3,e=b.actorEmail||b.sourceIp||"unknown";(b.moduleName.includes("export")||b.requestPath.includes("/api/hris/exports")||b.activityName.includes("export"))&&("approved"===b.status||"completed"===b.status)&&aD(`breach-export:${e}`,b.occurredAtMs,d),"sensitive"===b.sensitivity&&b.moduleName.includes("employee records")&&(b.activityName.includes("view")||b.activityName.includes("list"))&&("completed"===b.status||"approved"===b.status)&&aD(`breach-pii:${e}`,b.occurredAtMs,d),aI(b.status)&&(al.has(b.reason)||b.activityName.includes("permission")||b.activityName.includes("ownership")||b.activityName.includes("forbidden"))&&aD(`breach-denied:${e}`,b.occurredAtMs,d);let f=aE(`breach-export:${e}`,b.occurredAtMs,d),g=aE(`breach-pii:${e}`,b.occurredAtMs,d),h=aE(`breach-denied:${e}`,b.occurredAtMs,d),i=f>=c.breachExportThreshold,j=g>=c.breachPiiThreshold,k=c.breachDeniedThreshold<=0||h>=c.breachDeniedThreshold;return i&&j&&k?{ruleId:"POTENTIAL_BREACH_SIGNAL",incidentType:"Data Exposure",severity:aH("high",f+g+h,Math.max(1,c.breachExportThreshold)),restrictedPiiInvolved:!0,observedCount:f+g+h,windowMinutes:c.breachWindowMinutes,affectedEmployeeEmail:b.targetEmployeeEmail||b.actorEmail,title:"Potential breach indicators detected",summary:`Detected ${f} export action(s), ${g} PII access event(s), and ${h} access denial(s) for ${e} within ${c.breachWindowMinutes} minute(s).`,tags:["breach-signal","export","pii","ids"]}:null}function aQ(a){return ap(a).split(",").map(a=>at(a)).filter(Boolean)}function aR(a,b){let c=at(process.env.CLIO_GRC_ALERT_EMAIL)||aQ(process.env.GRC_EMAILS)[0]||aQ(process.env.SUPER_ADMIN_EMAILS)[0];return c||at(b?.affectedEmployeeEmail||a?.metadata?.ownerEmail||a?.performedBy||aj)}async function aS(a,b,c,d){let e=aR(a,b)||at(c?.ownerEmail);return(function(a=[]){return _(a)})(await S({ownerEmail:e,affectedEmployeeEmail:at(b?.affectedEmployeeEmail),actorEmail:at(a?.performedBy),includeAffectedEmployee:!0,includeActor:!0})).slice(0,d.maxRecipientCount)}function aT(a,b){let c=Math.max(1,Number(a||1)),d=Math.max(5,Number(b?.retryBaseBackoffSeconds||30));return Math.min(Math.max(d,Number(b?.retryMaxBackoffSeconds||1800)),d*Math.pow(2,Math.max(0,c-1)))}async function aU({entry:a,detection:c,fingerprint:d,correlationKey:e,errorMessage:f,config:g,attempts:h=1,source:i="live"}){if(!g?.retryEnabled)return{queued:!1,reason:"retry_disabled"};let j=aA();if(!j)return{queued:!1,reason:"retry_queue_unavailable"};let k=function({entry:a,detection:b,fingerprint:c,correlationKey:d,errorMessage:e,config:f,attempts:g=1,source:h="live",queuedAtIso:i=ao()}){let j=Math.max(1,Number(g||1)),k=aT(j,f),l=new Date(Date.now()+1e3*k).toISOString();return{status:"pending",source:ap(h,"live"),attempts:j,maxAttempts:Math.max(1,Number(f?.retryMaxAttempts||5)),nextAttemptAt:l,lastError:ap(e,"ids_processing_failed"),fingerprint:ap(c),correlationKey:ap(d),entry:aq(a),detection:aq(b),createdAt:i,updatedAt:i}}({entry:a,detection:c,fingerprint:d,correlationKey:e,errorMessage:f,config:g,attempts:h,source:i,queuedAtIso:ao()});return{queued:!0,retryRecordId:(await (0,b.addDoc)((0,b.collection)(j,g.retryCollectionName),k)).id,attempts:k.attempts,nextAttemptAt:k.nextAttemptAt}}async function aV(a,{batchSize:c}={}){let d=aA();if(!d)return[];let e=Math.max(1,Number(c||a?.retryBatchSize||8)),f=Math.max(3*e,16),g=await (0,b.getDocs)((0,b.query)((0,b.collection)(d,a.retryCollectionName),(0,b.orderBy)("nextAttemptAt","asc"),(0,b.limit)(f))),h=Date.now();return g.docs.map(a=>({id:a.id,...a.data()||{}})).filter(a=>"pending"===as(a?.status||"pending")).filter(a=>{let b=aw(a?.nextAttemptAt);return!Number.isFinite(b)||b<=h}).slice(0,e)}async function aW(a,c,d){let e=aA();if(!e)return null;let f={...c,status:"dead-letter",deadLetteredAt:ao(),deadLetterReason:ap(d,"ids_retry_exhausted"),originalRetryRecordId:ap(c?.id)};return(await (0,b.addDoc)((0,b.collection)(e,a.deadLetterCollectionName),f)).id}async function aX(a,c,d){let e=aA();e&&await (0,b.updateDoc)((0,b.doc)(e,a.retryCollectionName,c),{...d,updatedAt:ao()})}async function aY(a,c){let d=aA();d&&await (0,b.deleteDoc)((0,b.doc)(d,a.retryCollectionName,c))}async function aZ({correlationKey:a,fingerprint:b,nowMs:c,config:d}){let e=[];try{e=await H()}catch{e=[]}let f=ar(e).find(c=>{if(["resolved","closed"].includes(as(c?.status).replace(/\s+/g,"_")))return!1;let d=ap(c?.detectionCorrelationKey);if(d&&d===a)return!0;let e=ap(c?.detectionFingerprint);return!!(e&&e===b)});return f||(!function(a,b){let c=Number.isFinite(b)?b:Date.now();for(let[a,b]of ai.entries())(!Number.isFinite(b)||b<=c)&&ai.delete(a);let d=ai.get(a);return Number.isFinite(d)&&d>b}(b,c)?null:{id:"",duplicateOnly:!0})}async function a$({incident:a,entry:b,detection:c,correlationKey:d,fingerprint:e,nowMs:f,config:g}){if(!a?.id)return null;let h=Math.max(1,Number(a?.alertOccurrenceCount||1))+1,i=[...ar(a?.alertOccurrences).slice(-39),aG(b)],j={detectionFingerprint:ap(a?.detectionFingerprint||e),detectionCorrelationKey:ap(a?.detectionCorrelationKey||d),detectionWindowEnd:new Date(f).toISOString(),alertDescription:c.summary,alertOccurrenceCount:h,alertFirstObservedAt:ap(a?.alertFirstObservedAt||a?.detectedAt||ao()),alertLastObservedAt:ap(b?.occurredAt,ao()),alertOccurrences:i,summary:c.summary,notes:[ap(a?.notes),`Latest alert occurrence #${h}: ${ap(b?.activityName,"Activity")} | ${ap(b?.module,"System")} | ${ap(b?.occurredAt,ao())} | Source IP: ${ap(b?.metadata?.sourceIp||b?.sourceIp,"unknown")}`].filter(Boolean).join("\n")},k=await K(a.id,j,g.systemActorEmail);return aF(e,f,g.incidentCooldownMinutes),k}async function a_(a,b,c,d,e,f){let g=ap(a?.occurredAt,ao()),h=aR(a,b),i=c.systemActorEmail||aj,j=aq(a?.metadata),k=ap(j.targetEmployeeEmail||j.employeeEmail||b.affectedEmployeeEmail,""),l=ap(j.resourceLabel||j.recordRef||j.recordId,""),m=ar(j.viewedFields,[]),n=ar(j.accessedDocuments,[]),o=ap(a?.occurredAt,ao()),p=aG(a),q={title:b.title,summary:b.summary,incidentType:b.incidentType,severity:b.severity,status:"Open",restrictedPiiInvolved:!!b.restrictedPiiInvolved,affectedEmployeeEmail:at(b.affectedEmployeeEmail||j.targetEmployeeEmail||""),ownerEmail:h,detectedAt:g,escalationRequired:!0,containmentStatus:"Not Started",impactAssessmentStatus:"Pending",regulatoryNotificationRequired:!!b.restrictedPiiInvolved,documentationRetained:!0,classificationStandard:"CLIO-IDS-V1",notes:[`Auto-generated by CLIO IDS rule: ${b.ruleId}`,`Observed count: ${Number(b.observedCount||0)}`,`Window: ${Number(b.windowMinutes||0)} minute(s)`,k?`Target employee: ${k}`:null,l?`Record reference: ${l}`:null,m.length>0?`Viewed fields: ${m.slice(0,12).join(", ")}`:null,n.length>0?`Accessed documents: ${n.map(a=>ap(a?.name||a?.ref||a?.id)).filter(Boolean).slice(0,6).join(", ")}`:null,`Source event: ${ap(a?.id,"N/A")} | ${ap(a?.module,"System")} | ${ap(a?.activityName,"Activity")}`,`Source IP: ${ap(j.sourceIp||a?.sourceIp,"unknown")}`,`Request: ${ap(j.requestMethod||a?.requestMethod,"GET")} ${ap(j.requestPath||a?.requestPath,"unknown")}`].filter(Boolean).join("\n"),autoGenerated:!0,detectionRuleId:b.ruleId,detectionFingerprint:d,detectionCorrelationKey:e,detectionWindowStart:new Date(f-60*b.windowMinutes*1e3).toISOString(),detectionWindowEnd:new Date(f).toISOString(),alertDescription:b.summary,alertOccurrenceCount:1,alertFirstObservedAt:o,alertLastObservedAt:o,alertOccurrences:[p],sourceSystem:"CLIO_IDS",sourceEventId:ap(a?.id),sourceEventModule:ap(a?.module),sourceEventPath:ap(j.requestPath||a?.requestPath),sourceIp:ap(j.sourceIp||a?.sourceIp),alertRecipients:[],actionUrl:"/incident-management"},r=await J(q,i);return aF(d,f,c.incidentCooldownMinutes),r}async function a0({incident:a,detection:b,recipients:c,actionUrl:d,actorEmail:e}){let f=c.map(c=>{let f,g,h;return{recipientEmail:c,title:ap(a?.title||b?.title,"Security anomaly detected"),message:(f=ap(a?.severity||b?.severity,"Medium"),g=ap(a?.incidentCode,"INCIDENT"),h=ap(a?.summary||b?.summary,"Review incident workbench for containment."),`[${f}] ${g}: ${h}`),severity:as(a?.severity||b?.severity||"medium"),type:"security-anomaly",module:"Incident Management",actionUrl:d,status:"unread",createdBy:e,metadata:{incidentId:ap(a?.id||a?.recordId),incidentCode:ap(a?.incidentCode),detectionRuleId:ap(b?.ruleId),autoGenerated:!0}}});return await R(f)}async function a1({entry:a,detection:b,config:c,fingerprint:d,correlationKey:e,nowMs:f}){var g;let h,i,j=await aZ({correlationKey:e,fingerprint:d,nowMs:f,config:c});if(j?.duplicateOnly)return{detected:!0,duplicate:!0,detection:b,fingerprint:d,correlationKey:e};if(j?.id){let g=await a$({incident:j,entry:a,detection:b,correlationKey:e,fingerprint:d,nowMs:f,config:c});return{detected:!0,duplicate:!0,consolidated:!0,detection:b,fingerprint:d,correlationKey:e,incidentRecord:g||j}}let k=await a_(a,b,c,d,e,f),l=(g=k?.id||k?.recordId)?`/incident-management?incident=${encodeURIComponent(g)}`:"/incident-management",m=(h=ap(c?.appBaseUrl).replace(/\/+$/,""),(i=ap(l,"/incident-management")).startsWith("http://")||i.startsWith("https://")?i:h?`${h}${i.startsWith("/")?i:`/${i}`}`:i.startsWith("/")?i:`/${i}`),n=await aS(a,b,k,c),o=await a0({incident:k,detection:b,recipients:n,actionUrl:l,actorEmail:c.systemActorEmail}),p=await ag({incident:{...k,actionUrl:m},detection:b,sourceEvent:a,emailRecipients:n}),q={alertRecipients:n,alertDispatchSummary:p,externalIntegrations:{webhooks:p?.webhooks||{}},lastAlertDispatchAt:ao()};return await K(k.id,q,c.systemActorEmail).catch(()=>null),{detected:!0,duplicate:!1,detection:b,incidentRecord:k,fingerprint:d,recipients:n,inAppNotificationCount:o.length,deliverySummary:p}}async function a2(a,b){let c=ap(b?.id);if(!c)return{processed:!1,reason:"missing_retry_record_id"};let d=Math.max(1,Number(b?.attempts||1)),e=Math.max(1,Number(b?.maxAttempts||a.retryMaxAttempts||5)),f=aq(b?.entry),g=aq(b?.detection),h=ap(b?.fingerprint),i=ap(b?.correlationKey);if(!h||!ap(g?.ruleId)||!ap(f?.activityName)&&!ap(f?.module))return await aW(a,b,"invalid_retry_payload"),await aY(a,c),{processed:!1,deadLettered:!0,reason:"invalid_retry_payload"};let j=await a4(f,{forcedDetection:g,forcedFingerprint:h,forcedCorrelationKey:i,skipQueueOnError:!0,disableQueueDrain:!0});if(!j?.failed)return await aY(a,c),{processed:!0,duplicate:!!j?.duplicate,detected:!!j?.detected};let k=d+1,l=ap(j?.error,"ids_processing_failed");if(k>e)return await aW(a,{...b,attempts:k,maxAttempts:e,lastError:l},l),await aY(a,c),{processed:!1,deadLettered:!0,reason:l};let m=new Date(Date.now()+1e3*aT(k,a)).toISOString();return await aX(a,c,{attempts:k,maxAttempts:e,nextAttemptAt:m,lastError:l,status:"pending"}),{processed:!1,retried:!0,reason:l,nextAttemptAt:m}}async function a3({reason:a="manual",batchSize:b}={}){let c=aB();if(!c.enabled||!c.retryEnabled)return{processedCount:0,reason:c.enabled?"retry_disabled":"ids_disabled"};if(ak)return ak;ak=(async()=>{let d=await aV(c,{batchSize:Number(b||c.retryBatchSize||8)}),e=0,f=0,g=0;for(let a of d)try{let b=await a2(c,a);b?.processed&&(e+=1),b?.deadLettered&&(f+=1)}catch{g+=1}return{reason:ap(a,"manual"),processedCount:e,deadLetterCount:f,failedCount:g,dueCount:d.length}})();try{return await ak}finally{ak=null}}async function a4(a,b={}){var c,d,e,f;let g,h,i,j,k,l,m,n,o,p,q=aB();if(!q.enabled)return{detected:!1,reason:"ids_disabled"};if(!a||"object"!=typeof a)return{detected:!1,reason:"invalid_audit_entry"};!b?.disableQueueDrain&&q.retryEnabled&&a3({reason:"audit-event"}).catch(()=>null);let r=(c=b?.forcedDetection)&&"object"==typeof c&&!Array.isArray(c)?b.forcedDetection:null;if(!r&&function(a){let b=aq(a?.metadata);if(!0===b.skipAnomalyDetection||!0===b.autoGenerated)return!0;let c=as(a?.module),d=as(b.requestPath||a?.requestPath);return!!(c.includes("incident management")||d.startsWith("/api/notifications"))}(a))return{detected:!1,reason:"event_skipped"};let s=(g=aq(a?.metadata),{actorEmail:at(a?.performedBy),status:as(a?.status),moduleName:as(a?.module),activityName:as(a?.activityName),reason:as(g.reason),requestPath:as(g.requestPath||a?.requestPath),requestMethod:as(g.requestMethod||a?.requestMethod),sourceIp:au(g.sourceIp||a?.sourceIp),sensitivity:as(a?.sensitivity),targetEmployeeEmail:at(g.targetEmployeeEmail||g.employeeEmail||g.affectedEmployeeEmail),ownerEmail:at(g.ownerEmail),targetRole:av(g.targetRole||g.assignedRole||""),actorRole:av(g.actorRole||g.currentRole||""),occurredAtMs:aw(a?.occurredAt)||Date.now()}),t=r||function(a,b,c){for(let d of[aJ,aK,aN,aO,aL,aM,aP]){let e=d(a,b,c);if(e)return e}return null}(a,s,q);if(!t)return{detected:!1,reason:"no_rule_match"};let u=s.occurredAtMs||Date.now(),v=ap(b?.forcedFingerprint)||(d=t.ruleId,e=t.windowMinutes||q.incidentCooldownMinutes,h=at(a?.performedBy),i=au(a?.metadata?.sourceIp||a?.sourceIp),j=as(a?.module||""),k=at(t?.affectedEmployeeEmail||a?.metadata?.employeeEmail||""),l=Math.floor(u/(60*Math.max(1,Number(e||1))*1e3)),[ap(d),h||"unknown",i,j||"module",k||"none",l].join("|")),w=ap(b?.forcedCorrelationKey)||(f=t.ruleId,m=at(a?.performedBy),n=au(a?.metadata?.sourceIp||a?.sourceIp),o=as(a?.module||""),p=at(t?.affectedEmployeeEmail||a?.metadata?.employeeEmail||""),[ap(f),m||"unknown",n,o||"module",p||"none"].join("|"));try{return await a1({entry:a,detection:t,config:q,fingerprint:v,correlationKey:w,nowMs:u})}catch(e){let c=e instanceof Error?ap(e.message,"ids_processing_failed"):"ids_processing_failed";if(b?.skipQueueOnError)return{detected:!0,duplicate:!1,failed:!0,detection:t,fingerprint:v,reason:"processing_failed",error:c};let d=await aU({entry:a,detection:t,fingerprint:v,correlationKey:w,errorMessage:c,config:q,attempts:1,source:"live"});return{detected:!0,duplicate:!1,failed:!0,queuedForRetry:!!d?.queued,retryRecordId:ap(d?.retryRecordId),detection:t,fingerprint:v,reason:"processing_failed",error:c}}}a.s(["drainSecurityDetectionRetryQueue",()=>a3,"processAuditEventForSecurityDetections",()=>a4],36725)}];

//# sourceMappingURL=src_lib_security-detection_fc1cf3d7.js.map