rules_version = "2";

service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function role() {
      return isAuthenticated() ? request.auth.token.role : null;
    }

    function actorEmail() {
      return isAuthenticated() ? request.auth.token.email : null;
    }

    function isSuperAdmin() {
      return role() == "SUPER_ADMIN";
    }

    function isGRC() {
      return role() == "GRC";
    }

    function isHR() {
      return role() == "HR";
    }

    function isEA() {
      return role() == "EA";
    }

    function isPrivilegedRole() {
      return isSuperAdmin() || isGRC() || isHR() || isEA();
    }

    function isEmployeeRole() {
      return role() in ["EMPLOYEE_L1", "EMPLOYEE_L2", "EMPLOYEE_L3"];
    }

    function isOwnerEmail(emailValue) {
      return isAuthenticated() && emailValue is string && emailValue == actorEmail();
    }

    function employeeEditableSelfFieldsOnly() {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly([
        "contact",
        "address",
        "updatedAt",
        "updatedBy",
        "activityHistory"
      ]);
    }

    function leaveRequestEditableSelfFieldsOnly() {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly([
        "leaveType",
        "startDate",
        "endDate",
        "reason",
        "updatedAt",
        "updatedBy",
        "modificationTrail"
      ]);
    }

    function exportRequestEditableSelfFieldsOnly() {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly([
        "dataset",
        "format",
        "scope",
        "estimateVolume",
        "justification",
        "updatedAt",
        "updatedBy",
        "history"
      ]);
    }

    // Account directory and role assignment
    match /clio_users/{userId} {
      allow read: if isSuperAdmin() || isPrivilegedRole() || isOwnerEmail(resource.data.email);
      allow create, update, delete: if isSuperAdmin();
    }

    // Invitation-only onboarding
    match /clio_user_invites/{inviteId} {
      allow read, create, update, delete: if isSuperAdmin();
    }

    // Employee Records
    match /employees/{employeeId} {
      allow read: if isPrivilegedRole() || isOwnerEmail(resource.data.email);
      allow create: if isPrivilegedRole();
      allow update: if isPrivilegedRole() || (isEmployeeRole() && isOwnerEmail(resource.data.email) && employeeEditableSelfFieldsOnly());
      allow delete: if isSuperAdmin() || isHR() || isGRC();
    }

    // Employment Lifecycle
    match /employment_lifecycle/{recordId} {
      allow read: if isPrivilegedRole();
      allow create, update: if isPrivilegedRole();
      allow delete: if isSuperAdmin() || isGRC();
    }

    // Attendance Logs
    match /attendance/{recordId} {
      allow read: if isPrivilegedRole() || isOwnerEmail(resource.data.employeeEmail);
      allow create, update: if isPrivilegedRole() || (isEmployeeRole() && isOwnerEmail(request.resource.data.employeeEmail));
      allow delete: if isSuperAdmin() || isHR() || isGRC();
    }

    // Leave Requests and Approvals
    match /leave_requests/{recordId} {
      allow read: if isPrivilegedRole() || isOwnerEmail(resource.data.employeeEmail);
      allow create: if isPrivilegedRole() || (isEmployeeRole() && isOwnerEmail(request.resource.data.employeeEmail));
      allow update: if isPrivilegedRole() || (isEmployeeRole() && isOwnerEmail(resource.data.employeeEmail) && leaveRequestEditableSelfFieldsOnly());
      allow delete: if isSuperAdmin() || isHR() || isGRC();
    }

    // Performance
    match /performance_records/{recordId} {
      allow read: if isPrivilegedRole() || isOwnerEmail(resource.data.employeeEmail);
      allow create, update: if isPrivilegedRole();
      allow delete: if isSuperAdmin() || isHR() || isGRC();
    }

    // Document Template Repository
    match /document_templates/{recordId} {
      allow read: if isPrivilegedRole() || isEmployeeRole();
      allow create, update: if isPrivilegedRole();
      allow delete: if isSuperAdmin() || isHR() || isGRC();
    }

    // Export Control
    match /export_requests/{recordId} {
      allow read: if isPrivilegedRole() || isOwnerEmail(resource.data.requestedBy);
      allow create: if isPrivilegedRole() || (isEmployeeRole() && isOwnerEmail(request.resource.data.requestedBy));
      allow update: if isPrivilegedRole() || (isEmployeeRole() && isOwnerEmail(resource.data.requestedBy) && exportRequestEditableSelfFieldsOnly());
      allow delete: if isSuperAdmin() || isGRC();
    }

    // Immutable Audit Trail
    match /clio_audit_logs/{logId} {
      allow read: if isSuperAdmin() || isGRC();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
