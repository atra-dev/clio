module.exports=[33355,t=>{"use strict";t.i(18097);var e=t.i(19e3),r=t.i(67658),i=t.i(45709);function n(){return new Date().toISOString()}function a(t,e=""){return String(t||"").trim()||e}function o(t,e=!1){if("boolean"==typeof t)return t;if("number"==typeof t)return 0!==t;if("string"==typeof t){let r=t.trim().toLowerCase();if(!r)return e;if(["true","1","yes","on","y"].includes(r))return!0;if(["false","0","no","off","n"].includes(r))return!1}return e}function u(t){return Array.isArray(t)?t:[]}function c(t,e,{min:r=1,max:i=Number.MAX_SAFE_INTEGER}={}){let n=Number.parseInt(String(t||""),10);return Number.isFinite(n)?Math.min(i,Math.max(r,n)):e}function l(t){return String(t||"").trim().toLowerCase()}function s(t){return String(t||"").split(",").map(t=>l(t)).filter(Boolean)}function d(t){return"read"===String(t||"").trim().toLowerCase()?"read":"unread"}function f(){return a(process.env.CLIO_FIRESTORE_NOTIFICATIONS_COLLECTION,"clio_notifications")}function m(){return(0,r.isFirestoreEnabled)()?(0,r.getFirestoreDb)():null}function p(t){return{...t.data()||{},id:t.id,recordId:t.id}}function A(t,e){let r=l(e),i=l(t?.recipientEmail);return o(t?.broadcast,!1)||r&&i&&r===i}function y(t,e){return new Date(e?.createdAt||0).getTime()-new Date(t?.createdAt||0).getTime()}async function g(t){let r=m();if(!r)return null;let i=function(t){var e;let r,i=n(),u=l(t?.recipientEmail),c=o(t?.broadcast,!1);if(!u&&!c)throw Error("invalid_notification_recipient");return{title:a(t?.title,"Security notification"),message:a(t?.message,"A security event requires review."),severity:"critical"===(r=String(t?.severity||"").trim().toLowerCase())?"critical":"high"===r?"high":"low"===r?"low":"medium",type:a(t?.type,"security"),module:a(t?.module,"Incident Management"),actionUrl:a(t?.actionUrl,"/incident-management"),recipientEmail:u,broadcast:c,status:d(t?.status),metadata:(e=t?.metadata)&&"object"==typeof e&&!Array.isArray(e)?e:{},createdAt:a(t?.createdAt,i),updatedAt:a(t?.updatedAt,i),readAt:a(t?.readAt,""),createdBy:l(t?.createdBy)}}(t),u=await (0,e.addDoc)((0,e.collection)(r,f()),i);return{...i,id:u.id,recordId:u.id}}async function w(t){let e=u(t);if(0===e.length)return[];let r=[];for(let t of e){let e=await g(t);e&&r.push(e)}return r}async function I({recipientEmail:t,status:r="all",limit:i=20}={}){let n=m();if(!n)return{records:[],unreadCount:0,totalScoped:0};let a=String(r||"").trim().toLowerCase(),o=c(i,20,{min:1,max:120}),u=Math.max(4*o,100),l=(await (0,e.getDocs)((0,e.query)((0,e.collection)(n,f()),(0,e.orderBy)("createdAt","desc"),(0,e.limit)(u)))).docs.map(p).filter(e=>A(e,t)),s=l.reduce((t,e)=>t+ +("unread"===d(e?.status)),0);return{records:l.filter(t=>"all"===a||!a||d(t?.status)===a).sort(y).slice(0,o),unreadCount:s,totalScoped:l.length}}async function S(t,r){let i=m();if(!i)return null;let o=a(t);if(!o)throw Error("invalid_record_id");let u=(0,e.doc)(i,f(),o),c=await (0,e.getDoc)(u);if(!c.exists())return null;let l=p(c);if(!A(l,r))throw Error("forbidden_notification_access");if("read"===d(l.status))return l;let s={...l,status:"read",readAt:n(),updatedAt:n()};return await (0,e.updateDoc)(u,s),s}async function E({recipientEmail:t,limit:r=120}={}){let i=l(t);if(!i)return{updatedCount:0};let o=m();if(!o)return{updatedCount:0};let u=c(r,120,{min:1,max:300}),{records:s}=await I({recipientEmail:i,status:"unread",limit:u}),d=0;for(let t of s){let r=a(t?.id||t?.recordId);if(!r)continue;let i=(0,e.doc)(o,f(),r);await (0,e.updateDoc)(i,{status:"read",readAt:n(),updatedAt:n()}),d+=1}return{updatedCount:d}}async function _({ownerEmail:t,affectedEmployeeEmail:e,actorEmail:r,includeAffectedEmployee:n=!0,includeActor:a=!1}={}){let o=[l(process.env.CLIO_GRC_ALERT_EMAIL),...s(process.env.GRC_EMAILS),...s(process.env.SUPER_ADMIN_EMAILS),l(t)];n&&o.push(l(e)),a&&o.push(l(r));let c=[];try{let t=await (0,i.listUserAccounts)();c=u(t).filter(t=>l(t?.email)).filter(t=>{var e;return"active"===(e=t?.status,String(e||"").trim().toLowerCase())}).filter(t=>{let e=String(t?.role||"").trim().toUpperCase();return"GRC"===e||"SUPER_ADMIN"===e}).map(t=>l(t?.email))}catch{c=[]}return function(t=[]){return Array.from(new Set(u(t).map(t=>l(t)).filter(Boolean)))}([...o,...c])}t.s(["createInAppNotificationsBulk",()=>w,"listInAppNotifications",()=>I,"markAllInAppNotificationsRead",()=>E,"markInAppNotificationRead",()=>S,"resolveIncidentStakeholderRecipients",()=>_])}];

//# sourceMappingURL=src_lib_security-notifications_5f07320b.js.map