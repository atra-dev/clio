{"version":3,"sources":["../../../src/lib/security-detection.js","../../../src/lib/security-alert-delivery.js"],"sourcesContent":["import {\n  createIncidentRecordBackend,\n  listIncidentRecordsBackend,\n  updateIncidentRecordBackend,\n} from \"@/lib/hris-backend\";\nimport {\n  addDoc,\n  collection,\n  deleteDoc,\n  doc,\n  getDocs,\n  limit as queryLimit,\n  orderBy,\n  query,\n  updateDoc,\n} from \"firebase/firestore/lite\";\nimport { getFirestoreDb, isFirestoreEnabled } from \"@/lib/firebase\";\nimport {\n  createInAppNotificationsBulk,\n  resolveIncidentStakeholderRecipients,\n} from \"@/lib/security-notifications\";\nimport {\n  dispatchSecurityIncidentAlerts,\n  resolveSecurityAlertEmailRecipients,\n} from \"@/lib/security-alert-delivery\";\n\nconst EVENT_COUNTER_WINDOWS = new Map();\nconst INCIDENT_COOLDOWN_CACHE = new Map();\nconst MAX_COUNTER_BUCKET_SIZE = 256;\nconst DEFAULT_SYSTEM_ACTOR = \"system@gmail.com\";\nlet IDS_RETRY_DRAIN_PROMISE = null;\n\nconst PERMISSION_DENIED_REASONS = new Set([\n  \"missing_permission\",\n  \"role_not_allowed\",\n  \"ownership_validation_failed\",\n  \"unauthorized\",\n  \"account_not_active\",\n  \"session_role_mismatch\",\n  \"session_version_mismatch\",\n]);\n\nfunction nowIso() {\n  return new Date().toISOString();\n}\n\nfunction asString(value, fallback = \"\") {\n  const normalized = String(value || \"\").trim();\n  return normalized || fallback;\n}\n\nfunction asObject(value) {\n  if (value && typeof value === \"object\" && !Array.isArray(value)) {\n    return value;\n  }\n  return {};\n}\n\nfunction asArray(value) {\n  return Array.isArray(value) ? value : [];\n}\n\nfunction normalizeText(value) {\n  return asString(value).toLowerCase();\n}\n\nfunction normalizeEmail(value) {\n  return asString(value).toLowerCase();\n}\n\nfunction normalizeIp(value) {\n  const ip = asString(value).toLowerCase();\n  return ip || \"unknown\";\n}\n\nfunction toTimeMs(value) {\n  const timestamp = new Date(value || \"\").getTime();\n  return Number.isNaN(timestamp) ? null : timestamp;\n}\n\nfunction parseBooleanEnv(name, fallbackValue = false) {\n  const raw = normalizeText(process.env[name]);\n  if (!raw) {\n    return fallbackValue;\n  }\n  return raw === \"true\" || raw === \"1\" || raw === \"yes\";\n}\n\nfunction parseIntegerEnv(name, fallbackValue, { min = 1, max = Number.MAX_SAFE_INTEGER } = {}) {\n  const parsed = Number.parseInt(asString(process.env[name]), 10);\n  if (!Number.isFinite(parsed)) {\n    return fallbackValue;\n  }\n  return Math.min(max, Math.max(min, parsed));\n}\n\nfunction getDetectionRetryQueueCollectionName() {\n  return asString(process.env.CLIO_FIRESTORE_IDS_RETRY_COLLECTION, \"clio_ids_retry_queue\");\n}\n\nfunction getDetectionDeadLetterCollectionName() {\n  return asString(process.env.CLIO_FIRESTORE_IDS_DEAD_LETTER_COLLECTION, \"clio_ids_dead_letter\");\n}\n\nfunction getDetectionQueueDb() {\n  if (!isFirestoreEnabled()) {\n    return null;\n  }\n  return getFirestoreDb();\n}\n\nfunction getDetectionConfig() {\n  return {\n    enabled: parseBooleanEnv(\"CLIO_IDS_ENABLED\", true),\n    authFailureThreshold: parseIntegerEnv(\"CLIO_IDS_AUTH_FAILURE_THRESHOLD\", 5, { min: 2, max: 30 }),\n    authFailureWindowMinutes: parseIntegerEnv(\"CLIO_IDS_AUTH_FAILURE_WINDOW_MINUTES\", 10, { min: 1, max: 120 }),\n    permissionDeniedThreshold: parseIntegerEnv(\"CLIO_IDS_PERMISSION_DENIED_THRESHOLD\", 3, { min: 2, max: 20 }),\n    permissionDeniedWindowMinutes: parseIntegerEnv(\"CLIO_IDS_PERMISSION_DENIED_WINDOW_MINUTES\", 15, { min: 1, max: 120 }),\n    exportSpikeThreshold: parseIntegerEnv(\"CLIO_IDS_EXPORT_SPIKE_THRESHOLD\", 4, { min: 2, max: 20 }),\n    exportSpikeWindowMinutes: parseIntegerEnv(\"CLIO_IDS_EXPORT_SPIKE_WINDOW_MINUTES\", 20, { min: 1, max: 180 }),\n    piiAccessSpikeThreshold: parseIntegerEnv(\"CLIO_IDS_PII_ACCESS_SPIKE_THRESHOLD\", 12, { min: 4, max: 80 }),\n    piiAccessSpikeWindowMinutes: parseIntegerEnv(\"CLIO_IDS_PII_ACCESS_SPIKE_WINDOW_MINUTES\", 15, { min: 1, max: 180 }),\n    incidentCooldownMinutes: parseIntegerEnv(\"CLIO_IDS_INCIDENT_COOLDOWN_MINUTES\", 15, { min: 1, max: 360 }),\n    maxRecipientCount: parseIntegerEnv(\"CLIO_IDS_MAX_RECIPIENTS\", 20, { min: 1, max: 100 }),\n    systemActorEmail: normalizeEmail(process.env.CLIO_IDS_SYSTEM_ACTOR_EMAIL) || DEFAULT_SYSTEM_ACTOR,\n    appBaseUrl: asString(process.env.CLIO_APP_BASE_URL, \"http://localhost:3000\").replace(/\\/+$/, \"\"),\n    retryEnabled: parseBooleanEnv(\"CLIO_IDS_RETRY_ENABLED\", true),\n    retryBatchSize: parseIntegerEnv(\"CLIO_IDS_RETRY_BATCH_SIZE\", 8, { min: 1, max: 32 }),\n    retryMaxAttempts: parseIntegerEnv(\"CLIO_IDS_RETRY_MAX_ATTEMPTS\", 5, { min: 1, max: 20 }),\n    retryBaseBackoffSeconds: parseIntegerEnv(\"CLIO_IDS_RETRY_BASE_BACKOFF_SECONDS\", 30, {\n      min: 5,\n      max: 3600,\n    }),\n    retryMaxBackoffSeconds: parseIntegerEnv(\"CLIO_IDS_RETRY_MAX_BACKOFF_SECONDS\", 1800, {\n      min: 30,\n      max: 24 * 3600,\n    }),\n    retryCollectionName: getDetectionRetryQueueCollectionName(),\n    deadLetterCollectionName: getDetectionDeadLetterCollectionName(),\n  };\n}\n\nfunction pruneCounterWindow(values, currentTimeMs, windowMs) {\n  const cutoff = currentTimeMs - windowMs;\n  return values.filter((value) => value >= cutoff).slice(-MAX_COUNTER_BUCKET_SIZE);\n}\n\nfunction incrementCounterWindow(key, timestampMs, windowMs) {\n  const normalizedKey = asString(key);\n  if (!normalizedKey) {\n    return 0;\n  }\n  const safeTimestamp = Number.isFinite(timestampMs) ? timestampMs : Date.now();\n  const existing = EVENT_COUNTER_WINDOWS.get(normalizedKey) || [];\n  const pruned = pruneCounterWindow(existing, safeTimestamp, windowMs);\n  pruned.push(safeTimestamp);\n  EVENT_COUNTER_WINDOWS.set(normalizedKey, pruned);\n  return pruned.length;\n}\n\nfunction cleanupIncidentCooldown(nowMs) {\n  const current = Number.isFinite(nowMs) ? nowMs : Date.now();\n  for (const [key, value] of INCIDENT_COOLDOWN_CACHE.entries()) {\n    if (!Number.isFinite(value) || value <= current) {\n      INCIDENT_COOLDOWN_CACHE.delete(key);\n    }\n  }\n}\n\nfunction isInIncidentCooldown(fingerprint, nowMs) {\n  cleanupIncidentCooldown(nowMs);\n  const expiresAt = INCIDENT_COOLDOWN_CACHE.get(fingerprint);\n  return Number.isFinite(expiresAt) && expiresAt > nowMs;\n}\n\nfunction rememberIncidentCooldown(fingerprint, nowMs, minutes) {\n  const ttlMs = Math.max(1, Number(minutes || 1)) * 60 * 1000;\n  INCIDENT_COOLDOWN_CACHE.set(fingerprint, nowMs + ttlMs);\n}\n\nfunction shouldSkipEvent(entry) {\n  const metadata = asObject(entry?.metadata);\n  if (metadata.skipAnomalyDetection === true || metadata.autoGenerated === true) {\n    return true;\n  }\n\n  const moduleName = normalizeText(entry?.module);\n  const requestPath = normalizeText(metadata.requestPath || entry?.requestPath);\n  if (moduleName.includes(\"incident management\")) {\n    return true;\n  }\n  if (requestPath.startsWith(\"/api/notifications\")) {\n    return true;\n  }\n  return false;\n}\n\nfunction buildFingerprint(ruleId, entry, detection, nowMs, windowMinutes) {\n  const actor = normalizeEmail(entry?.performedBy);\n  const sourceIp = normalizeIp(entry?.metadata?.sourceIp || entry?.sourceIp);\n  const moduleName = normalizeText(entry?.module || \"\");\n  const target = normalizeEmail(detection?.affectedEmployeeEmail || entry?.metadata?.employeeEmail || \"\");\n  const bucket = Math.floor(nowMs / (Math.max(1, Number(windowMinutes || 1)) * 60 * 1000));\n  return [asString(ruleId), actor || \"unknown\", sourceIp, moduleName || \"module\", target || \"none\", bucket].join(\"|\");\n}\n\nfunction chooseSeverity(baseSeverity, observedCount, threshold) {\n  const severity = normalizeText(baseSeverity);\n  if (severity === \"critical\") {\n    return \"Critical\";\n  }\n  const safeThreshold = Math.max(1, Number(threshold || 1));\n  if (observedCount >= safeThreshold * 2) {\n    return \"Critical\";\n  }\n  if (severity === \"high\") {\n    return \"High\";\n  }\n  if (severity === \"medium\") {\n    return \"Medium\";\n  }\n  return \"Low\";\n}\n\nfunction extractEventContext(entry) {\n  const metadata = asObject(entry?.metadata);\n  return {\n    actorEmail: normalizeEmail(entry?.performedBy),\n    status: normalizeText(entry?.status),\n    moduleName: normalizeText(entry?.module),\n    activityName: normalizeText(entry?.activityName),\n    reason: normalizeText(metadata.reason),\n    requestPath: normalizeText(metadata.requestPath || entry?.requestPath),\n    requestMethod: normalizeText(metadata.requestMethod || entry?.requestMethod),\n    sourceIp: normalizeIp(metadata.sourceIp || entry?.sourceIp),\n    sensitivity: normalizeText(entry?.sensitivity),\n    targetEmployeeEmail: normalizeEmail(metadata.targetEmployeeEmail || metadata.employeeEmail || metadata.affectedEmployeeEmail),\n    ownerEmail: normalizeEmail(metadata.ownerEmail),\n    occurredAtMs: toTimeMs(entry?.occurredAt) || Date.now(),\n  };\n}\n\nfunction isDeniedStatus(status) {\n  return status === \"failed\" || status === \"rejected\";\n}\n\nfunction detectAuthFailureSpike(entry, context, config) {\n  if (!context.moduleName.includes(\"authentication\") || !isDeniedStatus(context.status)) {\n    return null;\n  }\n\n  const key = `auth-fail:${context.sourceIp || context.actorEmail || \"unknown\"}`;\n  const count = incrementCounterWindow(\n    key,\n    context.occurredAtMs,\n    config.authFailureWindowMinutes * 60 * 1000,\n  );\n  if (count < config.authFailureThreshold) {\n    return null;\n  }\n\n  const severity = chooseSeverity(\"high\", count, config.authFailureThreshold);\n  return {\n    ruleId: \"AUTH_BRUTE_FORCE\",\n    incidentType: \"Credential Compromise\",\n    severity,\n    restrictedPiiInvolved: false,\n    observedCount: count,\n    windowMinutes: config.authFailureWindowMinutes,\n    affectedEmployeeEmail: context.actorEmail,\n    title: \"Repeated authentication failures detected\",\n    summary: `Detected ${count} failed/rejected authentication events from ${context.sourceIp} within ${config.authFailureWindowMinutes} minute(s).`,\n    tags: [\"authentication\", \"brute-force\", \"ids\"],\n  };\n}\n\nfunction detectPermissionDeniedSpike(entry, context, config) {\n  const isPermissionDenied =\n    isDeniedStatus(context.status) &&\n    (PERMISSION_DENIED_REASONS.has(context.reason) ||\n      context.activityName.includes(\"permission\") ||\n      context.activityName.includes(\"ownership\") ||\n      context.activityName.includes(\"forbidden\"));\n  if (!isPermissionDenied) {\n    return null;\n  }\n\n  const key = `permission-denied:${context.actorEmail || context.sourceIp || \"unknown\"}`;\n  const count = incrementCounterWindow(\n    key,\n    context.occurredAtMs,\n    config.permissionDeniedWindowMinutes * 60 * 1000,\n  );\n  if (count < config.permissionDeniedThreshold) {\n    return null;\n  }\n\n  const piiModule =\n    context.moduleName.includes(\"employee records\") ||\n    context.moduleName.includes(\"performance\") ||\n    context.moduleName.includes(\"attendance\");\n  const severity = chooseSeverity(piiModule ? \"high\" : \"medium\", count, config.permissionDeniedThreshold);\n  return {\n    ruleId: \"UNAUTHORIZED_ACCESS_ATTEMPT\",\n    incidentType: \"Unauthorized Access\",\n    severity,\n    restrictedPiiInvolved: piiModule,\n    observedCount: count,\n    windowMinutes: config.permissionDeniedWindowMinutes,\n    affectedEmployeeEmail: context.targetEmployeeEmail || context.actorEmail,\n    title: \"Repeated unauthorized access attempts detected\",\n    summary: `Detected ${count} permission/ownership denials for actor ${context.actorEmail || \"unknown\"} within ${config.permissionDeniedWindowMinutes} minute(s).`,\n    tags: [\"authorization\", \"idor\", \"least-privilege\", \"ids\"],\n  };\n}\n\nfunction detectExportSpike(entry, context, config) {\n  const isExportActivity =\n    context.moduleName.includes(\"export\") ||\n    context.requestPath.includes(\"/api/hris/exports\") ||\n    context.activityName.includes(\"export\");\n  if (!isExportActivity) {\n    return null;\n  }\n\n  if (!(context.status === \"approved\" || context.status === \"completed\")) {\n    return null;\n  }\n\n  const key = `export-spike:${context.actorEmail || context.sourceIp || \"unknown\"}`;\n  const count = incrementCounterWindow(\n    key,\n    context.occurredAtMs,\n    config.exportSpikeWindowMinutes * 60 * 1000,\n  );\n  if (count < config.exportSpikeThreshold) {\n    return null;\n  }\n\n  const severity = chooseSeverity(\"high\", count, config.exportSpikeThreshold);\n  return {\n    ruleId: \"MASS_EXPORT_ACTIVITY\",\n    incidentType: \"Data Exposure\",\n    severity,\n    restrictedPiiInvolved: true,\n    observedCount: count,\n    windowMinutes: config.exportSpikeWindowMinutes,\n    affectedEmployeeEmail: context.targetEmployeeEmail || \"\",\n    title: \"Mass export activity detected\",\n    summary: `Detected ${count} export-related actions by ${context.actorEmail || context.sourceIp} within ${config.exportSpikeWindowMinutes} minute(s).`,\n    tags: [\"export\", \"dlp\", \"ids\"],\n  };\n}\n\nfunction detectPiiAccessSpike(entry, context, config) {\n  const isPiiRead =\n    context.sensitivity === \"sensitive\" &&\n    context.moduleName.includes(\"employee records\") &&\n    (context.activityName.includes(\"view\") || context.activityName.includes(\"list\")) &&\n    (context.status === \"completed\" || context.status === \"approved\");\n  if (!isPiiRead) {\n    return null;\n  }\n\n  const key = `pii-read:${context.actorEmail || context.sourceIp || \"unknown\"}`;\n  const count = incrementCounterWindow(\n    key,\n    context.occurredAtMs,\n    config.piiAccessSpikeWindowMinutes * 60 * 1000,\n  );\n  if (count < config.piiAccessSpikeThreshold) {\n    return null;\n  }\n\n  const severity = chooseSeverity(\"medium\", count, config.piiAccessSpikeThreshold);\n  return {\n    ruleId: \"PII_ACCESS_VOLUME_SPIKE\",\n    incidentType: \"Policy Violation\",\n    severity,\n    restrictedPiiInvolved: true,\n    observedCount: count,\n    windowMinutes: config.piiAccessSpikeWindowMinutes,\n    affectedEmployeeEmail: context.targetEmployeeEmail || \"\",\n    title: \"Sensitive PII access spike detected\",\n    summary: `Detected ${count} sensitive employee-record read actions in ${config.piiAccessSpikeWindowMinutes} minute(s).`,\n    tags: [\"pii\", \"privacy\", \"monitoring\", \"ids\"],\n  };\n}\n\nfunction detectSuspiciousEvent(entry, context, config) {\n  const rules = [\n    detectAuthFailureSpike,\n    detectPermissionDeniedSpike,\n    detectExportSpike,\n    detectPiiAccessSpike,\n  ];\n\n  for (const detect of rules) {\n    const match = detect(entry, context, config);\n    if (match) {\n      return match;\n    }\n  }\n  return null;\n}\n\nfunction toNotificationTitle(incident, detection) {\n  return asString(incident?.title || detection?.title, \"Security anomaly detected\");\n}\n\nfunction toNotificationMessage(incident, detection) {\n  const severity = asString(incident?.severity || detection?.severity, \"Medium\");\n  const code = asString(incident?.incidentCode, \"INCIDENT\");\n  const summary = asString(incident?.summary || detection?.summary, \"Review incident workbench for containment.\");\n  return `[${severity}] ${code}: ${summary}`;\n}\n\nfunction parseRoleEmails(value) {\n  return asString(value)\n    .split(\",\")\n    .map((item) => normalizeEmail(item))\n    .filter(Boolean);\n}\n\nfunction resolveOwnerEmail(entry, detection) {\n  const preferredOwner =\n    normalizeEmail(process.env.CLIO_GRC_ALERT_EMAIL) ||\n    parseRoleEmails(process.env.GRC_EMAILS)[0] ||\n    parseRoleEmails(process.env.SUPER_ADMIN_EMAILS)[0];\n  if (preferredOwner) {\n    return preferredOwner;\n  }\n  return normalizeEmail(detection?.affectedEmployeeEmail || entry?.metadata?.ownerEmail || entry?.performedBy || DEFAULT_SYSTEM_ACTOR);\n}\n\nasync function resolveAlertRecipients(entry, detection, incident, config) {\n  const owner = resolveOwnerEmail(entry, detection) || normalizeEmail(incident?.ownerEmail);\n  const resolved = await resolveIncidentStakeholderRecipients({\n    ownerEmail: owner,\n    affectedEmployeeEmail: normalizeEmail(detection?.affectedEmployeeEmail),\n    actorEmail: normalizeEmail(entry?.performedBy),\n    includeAffectedEmployee: true,\n    includeActor: true,\n  });\n  const withExplicitSecurityRecipients = resolveSecurityAlertEmailRecipients(resolved);\n  return withExplicitSecurityRecipients.slice(0, config.maxRecipientCount);\n}\n\nfunction buildActionUrl(config, incidentId) {\n  if (!incidentId) {\n    return \"/incident-management\";\n  }\n  return `/incident-management?incident=${encodeURIComponent(incidentId)}`;\n}\n\nfunction buildAbsoluteActionUrl(config, actionPath) {\n  const base = asString(config?.appBaseUrl, \"http://localhost:3000\").replace(/\\/+$/, \"\");\n  const path = asString(actionPath, \"/incident-management\");\n  if (path.startsWith(\"http://\") || path.startsWith(\"https://\")) {\n    return path;\n  }\n  return `${base}${path.startsWith(\"/\") ? path : `/${path}`}`;\n}\n\nfunction getRetryDelaySeconds(attempt, config) {\n  const safeAttempt = Math.max(1, Number(attempt || 1));\n  const baseSeconds = Math.max(5, Number(config?.retryBaseBackoffSeconds || 30));\n  const maxSeconds = Math.max(baseSeconds, Number(config?.retryMaxBackoffSeconds || 1800));\n  return Math.min(maxSeconds, baseSeconds * Math.pow(2, Math.max(0, safeAttempt - 1)));\n}\n\nfunction buildRetryQueueEntry({\n  entry,\n  detection,\n  fingerprint,\n  errorMessage,\n  config,\n  attempts = 1,\n  source = \"live\",\n  queuedAtIso = nowIso(),\n}) {\n  const safeAttempts = Math.max(1, Number(attempts || 1));\n  const delaySeconds = getRetryDelaySeconds(safeAttempts, config);\n  const nextAttemptAt = new Date(Date.now() + delaySeconds * 1000).toISOString();\n  return {\n    status: \"pending\",\n    source: asString(source, \"live\"),\n    attempts: safeAttempts,\n    maxAttempts: Math.max(1, Number(config?.retryMaxAttempts || 5)),\n    nextAttemptAt,\n    lastError: asString(errorMessage, \"ids_processing_failed\"),\n    fingerprint: asString(fingerprint),\n    entry: asObject(entry),\n    detection: asObject(detection),\n    createdAt: queuedAtIso,\n    updatedAt: queuedAtIso,\n  };\n}\n\nasync function enqueueDetectionRetryWorkItem({\n  entry,\n  detection,\n  fingerprint,\n  errorMessage,\n  config,\n  attempts = 1,\n  source = \"live\",\n}) {\n  if (!config?.retryEnabled) {\n    return {\n      queued: false,\n      reason: \"retry_disabled\",\n    };\n  }\n\n  const db = getDetectionQueueDb();\n  if (!db) {\n    return {\n      queued: false,\n      reason: \"retry_queue_unavailable\",\n    };\n  }\n\n  const now = nowIso();\n  const payload = buildRetryQueueEntry({\n    entry,\n    detection,\n    fingerprint,\n    errorMessage,\n    config,\n    attempts,\n    source,\n    queuedAtIso: now,\n  });\n  const ref = await addDoc(collection(db, config.retryCollectionName), payload);\n  return {\n    queued: true,\n    retryRecordId: ref.id,\n    attempts: payload.attempts,\n    nextAttemptAt: payload.nextAttemptAt,\n  };\n}\n\nasync function listDueRetryQueueRecords(config, { batchSize } = {}) {\n  const db = getDetectionQueueDb();\n  if (!db) {\n    return [];\n  }\n\n  const limitValue = Math.max(1, Number(batchSize || config?.retryBatchSize || 8));\n  const scanLimit = Math.max(limitValue * 3, 16);\n  const snapshot = await getDocs(\n    query(\n      collection(db, config.retryCollectionName),\n      orderBy(\"nextAttemptAt\", \"asc\"),\n      queryLimit(scanLimit),\n    ),\n  );\n  const nowMs = Date.now();\n  return snapshot.docs\n    .map((docSnapshot) => ({\n      id: docSnapshot.id,\n      ...(docSnapshot.data() || {}),\n    }))\n    .filter((row) => normalizeText(row?.status || \"pending\") === \"pending\")\n    .filter((row) => {\n      const nextAttemptMs = toTimeMs(row?.nextAttemptAt);\n      return !Number.isFinite(nextAttemptMs) || nextAttemptMs <= nowMs;\n    })\n    .slice(0, limitValue);\n}\n\nasync function moveRetryRecordToDeadLetter(config, record, reason) {\n  const db = getDetectionQueueDb();\n  if (!db) {\n    return null;\n  }\n\n  const payload = {\n    ...record,\n    status: \"dead-letter\",\n    deadLetteredAt: nowIso(),\n    deadLetterReason: asString(reason, \"ids_retry_exhausted\"),\n    originalRetryRecordId: asString(record?.id),\n  };\n  const ref = await addDoc(collection(db, config.deadLetterCollectionName), payload);\n  return ref.id;\n}\n\nasync function updateRetryQueueRecord(config, recordId, patch) {\n  const db = getDetectionQueueDb();\n  if (!db) {\n    return;\n  }\n  await updateDoc(doc(db, config.retryCollectionName, recordId), {\n    ...patch,\n    updatedAt: nowIso(),\n  });\n}\n\nasync function deleteRetryQueueRecord(config, recordId) {\n  const db = getDetectionQueueDb();\n  if (!db) {\n    return;\n  }\n  await deleteDoc(doc(db, config.retryCollectionName, recordId));\n}\n\nasync function hasDuplicateIncident(fingerprint, nowMs, config) {\n  if (isInIncidentCooldown(fingerprint, nowMs)) {\n    return true;\n  }\n\n  let rows = [];\n  try {\n    rows = await listIncidentRecordsBackend();\n  } catch {\n    rows = [];\n  }\n\n  const cooldownMs = config.incidentCooldownMinutes * 60 * 1000;\n  const duplicate = asArray(rows).some((row) => {\n    const currentFingerprint = asString(row?.detectionFingerprint);\n    if (!currentFingerprint || currentFingerprint !== fingerprint) {\n      return false;\n    }\n    const status = normalizeText(row?.status);\n    if (status === \"resolved\" || status === \"closed\") {\n      return false;\n    }\n    const detectedAtMs = toTimeMs(row?.detectedAt || row?.createdAt);\n    if (!Number.isFinite(detectedAtMs)) {\n      return true;\n    }\n    return detectedAtMs >= nowMs - cooldownMs;\n  });\n\n  return duplicate;\n}\n\nasync function createAutoIncident(entry, detection, config, fingerprint, nowMs) {\n  const occurredAt = asString(entry?.occurredAt, nowIso());\n  const ownerEmail = resolveOwnerEmail(entry, detection);\n  const actorEmail = config.systemActorEmail || DEFAULT_SYSTEM_ACTOR;\n  const sourceMetadata = asObject(entry?.metadata);\n  const payload = {\n    title: detection.title,\n    summary: detection.summary,\n    incidentType: detection.incidentType,\n    severity: detection.severity,\n    status: \"Open\",\n    restrictedPiiInvolved: Boolean(detection.restrictedPiiInvolved),\n    affectedEmployeeEmail: normalizeEmail(detection.affectedEmployeeEmail || sourceMetadata.targetEmployeeEmail || \"\"),\n    ownerEmail,\n    detectedAt: occurredAt,\n    escalationRequired: true,\n    containmentStatus: \"Not Started\",\n    impactAssessmentStatus: \"Pending\",\n    regulatoryNotificationRequired: Boolean(detection.restrictedPiiInvolved),\n    documentationRetained: true,\n    classificationStandard: \"CLIO-IDS-V1\",\n    notes: [\n      `Auto-generated by CLIO IDS rule: ${detection.ruleId}`,\n      `Observed count: ${Number(detection.observedCount || 0)}`,\n      `Window: ${Number(detection.windowMinutes || 0)} minute(s)`,\n      `Source event: ${asString(entry?.id, \"N/A\")} | ${asString(entry?.module, \"System\")} | ${asString(entry?.activityName, \"Activity\")}`,\n      `Source IP: ${asString(sourceMetadata.sourceIp || entry?.sourceIp, \"unknown\")}`,\n      `Request: ${asString(sourceMetadata.requestMethod || entry?.requestMethod, \"GET\")} ${asString(sourceMetadata.requestPath || entry?.requestPath, \"unknown\")}`,\n    ].join(\"\\n\"),\n    autoGenerated: true,\n    detectionRuleId: detection.ruleId,\n    detectionFingerprint: fingerprint,\n    detectionWindowStart: new Date(nowMs - detection.windowMinutes * 60 * 1000).toISOString(),\n    detectionWindowEnd: new Date(nowMs).toISOString(),\n    sourceSystem: \"CLIO_IDS\",\n    sourceEventId: asString(entry?.id),\n    sourceEventModule: asString(entry?.module),\n    sourceEventPath: asString(sourceMetadata.requestPath || entry?.requestPath),\n    sourceIp: asString(sourceMetadata.sourceIp || entry?.sourceIp),\n    alertRecipients: [],\n    actionUrl: \"/incident-management\",\n  };\n\n  const created = await createIncidentRecordBackend(payload, actorEmail);\n  rememberIncidentCooldown(fingerprint, nowMs, config.incidentCooldownMinutes);\n  return created;\n}\n\nasync function createInAppIncidentNotifications({\n  incident,\n  detection,\n  recipients,\n  actionUrl,\n  actorEmail,\n}) {\n  const notifications = recipients.map((recipientEmail) => ({\n    recipientEmail,\n    title: toNotificationTitle(incident, detection),\n    message: toNotificationMessage(incident, detection),\n    severity: normalizeText(incident?.severity || detection?.severity || \"medium\"),\n    type: \"security-anomaly\",\n    module: \"Incident Management\",\n    actionUrl,\n    status: \"unread\",\n    createdBy: actorEmail,\n    metadata: {\n      incidentId: asString(incident?.id || incident?.recordId),\n      incidentCode: asString(incident?.incidentCode),\n      detectionRuleId: asString(detection?.ruleId),\n      autoGenerated: true,\n    },\n  }));\n  return await createInAppNotificationsBulk(notifications);\n}\n\nasync function executeDetectionWorkflow({\n  entry,\n  detection,\n  config,\n  fingerprint,\n  nowMs,\n}) {\n  const duplicate = await hasDuplicateIncident(fingerprint, nowMs, config);\n  if (duplicate) {\n    return {\n      detected: true,\n      duplicate: true,\n      detection,\n      fingerprint,\n    };\n  }\n\n  const incident = await createAutoIncident(entry, detection, config, fingerprint, nowMs);\n  const actionUrl = buildActionUrl(config, incident?.id || incident?.recordId);\n  const absoluteActionUrl = buildAbsoluteActionUrl(config, actionUrl);\n  const recipients = await resolveAlertRecipients(entry, detection, incident, config);\n  const inAppNotifications = await createInAppIncidentNotifications({\n    incident,\n    detection,\n    recipients,\n    actionUrl,\n    actorEmail: config.systemActorEmail,\n  });\n  const deliverySummary = await dispatchSecurityIncidentAlerts({\n    incident: {\n      ...incident,\n      actionUrl: absoluteActionUrl,\n    },\n    detection,\n    sourceEvent: entry,\n    emailRecipients: recipients,\n  });\n\n  const patchPayload = {\n    alertRecipients: recipients,\n    alertDispatchSummary: deliverySummary,\n    externalIntegrations: {\n      webhooks: deliverySummary?.webhooks || {},\n    },\n    lastAlertDispatchAt: nowIso(),\n  };\n  await updateIncidentRecordBackend(incident.id, patchPayload, config.systemActorEmail).catch(() => null);\n\n  return {\n    detected: true,\n    duplicate: false,\n    detection,\n    incidentRecord: incident,\n    fingerprint,\n    recipients,\n    inAppNotificationCount: inAppNotifications.length,\n    deliverySummary,\n  };\n}\n\nfunction hasForcedDetectionPayload(value) {\n  return Boolean(value && typeof value === \"object\" && !Array.isArray(value));\n}\n\nasync function processSingleRetryQueueRecord(config, row) {\n  const recordId = asString(row?.id);\n  if (!recordId) {\n    return { processed: false, reason: \"missing_retry_record_id\" };\n  }\n\n  const attempts = Math.max(1, Number(row?.attempts || 1));\n  const maxAttempts = Math.max(1, Number(row?.maxAttempts || config.retryMaxAttempts || 5));\n  const entry = asObject(row?.entry);\n  const detection = asObject(row?.detection);\n  const fingerprint = asString(row?.fingerprint);\n  if (!fingerprint || !asString(detection?.ruleId) || (!asString(entry?.activityName) && !asString(entry?.module))) {\n    await moveRetryRecordToDeadLetter(config, row, \"invalid_retry_payload\");\n    await deleteRetryQueueRecord(config, recordId);\n    return { processed: false, deadLettered: true, reason: \"invalid_retry_payload\" };\n  }\n\n  const result = await processAuditEventForSecurityDetections(entry, {\n    forcedDetection: detection,\n    forcedFingerprint: fingerprint,\n    skipQueueOnError: true,\n    disableQueueDrain: true,\n  });\n\n  if (!result?.failed) {\n    await deleteRetryQueueRecord(config, recordId);\n    return {\n      processed: true,\n      duplicate: Boolean(result?.duplicate),\n      detected: Boolean(result?.detected),\n    };\n  }\n\n  const nextAttempts = attempts + 1;\n  const errorMessage = asString(result?.error, \"ids_processing_failed\");\n  if (nextAttempts > maxAttempts) {\n    await moveRetryRecordToDeadLetter(config, {\n      ...row,\n      attempts: nextAttempts,\n      maxAttempts,\n      lastError: errorMessage,\n    }, errorMessage);\n    await deleteRetryQueueRecord(config, recordId);\n    return {\n      processed: false,\n      deadLettered: true,\n      reason: errorMessage,\n    };\n  }\n\n  const nextAttemptAt = new Date(Date.now() + getRetryDelaySeconds(nextAttempts, config) * 1000).toISOString();\n  await updateRetryQueueRecord(config, recordId, {\n    attempts: nextAttempts,\n    maxAttempts,\n    nextAttemptAt,\n    lastError: errorMessage,\n    status: \"pending\",\n  });\n\n  return {\n    processed: false,\n    retried: true,\n    reason: errorMessage,\n    nextAttemptAt,\n  };\n}\n\nexport async function drainSecurityDetectionRetryQueue({ reason = \"manual\", batchSize } = {}) {\n  const config = getDetectionConfig();\n  if (!config.enabled || !config.retryEnabled) {\n    return {\n      processedCount: 0,\n      reason: !config.enabled ? \"ids_disabled\" : \"retry_disabled\",\n    };\n  }\n\n  if (IDS_RETRY_DRAIN_PROMISE) {\n    return IDS_RETRY_DRAIN_PROMISE;\n  }\n\n  IDS_RETRY_DRAIN_PROMISE = (async () => {\n    const dueRecords = await listDueRetryQueueRecords(config, {\n      batchSize: Number(batchSize || config.retryBatchSize || 8),\n    });\n    let processedCount = 0;\n    let deadLetterCount = 0;\n    let failedCount = 0;\n\n    for (const row of dueRecords) {\n      try {\n        const result = await processSingleRetryQueueRecord(config, row);\n        if (result?.processed) {\n          processedCount += 1;\n        }\n        if (result?.deadLettered) {\n          deadLetterCount += 1;\n        }\n      } catch {\n        failedCount += 1;\n      }\n    }\n\n    return {\n      reason: asString(reason, \"manual\"),\n      processedCount,\n      deadLetterCount,\n      failedCount,\n      dueCount: dueRecords.length,\n    };\n  })();\n\n  try {\n    return await IDS_RETRY_DRAIN_PROMISE;\n  } finally {\n    IDS_RETRY_DRAIN_PROMISE = null;\n  }\n}\n\nexport async function processAuditEventForSecurityDetections(entry, options = {}) {\n  const config = getDetectionConfig();\n  if (!config.enabled) {\n    return {\n      detected: false,\n      reason: \"ids_disabled\",\n    };\n  }\n\n  if (!entry || typeof entry !== \"object\") {\n    return {\n      detected: false,\n      reason: \"invalid_audit_entry\",\n    };\n  }\n\n  if (!options?.disableQueueDrain && config.retryEnabled) {\n    void drainSecurityDetectionRetryQueue({ reason: \"audit-event\" }).catch(() => null);\n  }\n\n  const forcedDetection = hasForcedDetectionPayload(options?.forcedDetection)\n    ? options.forcedDetection\n    : null;\n  if (!forcedDetection && shouldSkipEvent(entry)) {\n    return {\n      detected: false,\n      reason: \"event_skipped\",\n    };\n  }\n\n  const context = extractEventContext(entry);\n  const detection = forcedDetection || detectSuspiciousEvent(entry, context, config);\n  if (!detection) {\n    return {\n      detected: false,\n      reason: \"no_rule_match\",\n    };\n  }\n\n  const nowMs = context.occurredAtMs || Date.now();\n  const fingerprint =\n    asString(options?.forcedFingerprint) ||\n    buildFingerprint(\n      detection.ruleId,\n      entry,\n      detection,\n      nowMs,\n      detection.windowMinutes || config.incidentCooldownMinutes,\n    );\n\n  try {\n    return await executeDetectionWorkflow({\n      entry,\n      detection,\n      config,\n      fingerprint,\n      nowMs,\n    });\n  } catch (error) {\n    const errorMessage = error instanceof Error ? asString(error.message, \"ids_processing_failed\") : \"ids_processing_failed\";\n    if (options?.skipQueueOnError) {\n      return {\n        detected: true,\n        duplicate: false,\n        failed: true,\n        detection,\n        fingerprint,\n        reason: \"processing_failed\",\n        error: errorMessage,\n      };\n    }\n\n    const queueResult = await enqueueDetectionRetryWorkItem({\n      entry,\n      detection,\n      fingerprint,\n      errorMessage,\n      config,\n      attempts: 1,\n      source: \"live\",\n    });\n    return {\n      detected: true,\n      duplicate: false,\n      failed: true,\n      queuedForRetry: Boolean(queueResult?.queued),\n      retryRecordId: asString(queueResult?.retryRecordId),\n      detection,\n      fingerprint,\n      reason: \"processing_failed\",\n      error: errorMessage,\n    };\n  }\n}\n","const RESEND_API_BASE = \"https://api.resend.com\";\nconst TWILIO_API_BASE = \"https://api.twilio.com/2010-04-01\";\n\nfunction asString(value, fallback = \"\") {\n  const normalized = String(value || \"\").trim();\n  return normalized || fallback;\n}\n\nfunction asArray(value) {\n  return Array.isArray(value) ? value : [];\n}\n\nfunction parseBooleanEnv(name, fallbackValue = false) {\n  const raw = asString(process.env[name]).toLowerCase();\n  if (!raw) {\n    return fallbackValue;\n  }\n  return raw === \"true\" || raw === \"1\" || raw === \"yes\";\n}\n\nfunction normalizeEmail(value) {\n  return asString(value).toLowerCase();\n}\n\nfunction normalizePhone(value) {\n  return String(value || \"\").replace(/[^\\d+]/g, \"\").trim();\n}\n\nfunction parseCsvList(value) {\n  return asString(value)\n    .split(\",\")\n    .map((item) => item.trim())\n    .filter(Boolean);\n}\n\nfunction dedupe(values = []) {\n  return Array.from(new Set(values.filter(Boolean)));\n}\n\nfunction normalizeEmailProvider(value) {\n  const normalized = asString(value).toLowerCase();\n  if (!normalized) {\n    return \"\";\n  }\n  if (normalized.includes(\"resend\")) return \"resend\";\n  if (normalized.includes(\"firebase\")) return \"firebase\";\n  if (normalized.includes(\"console\") || normalized === \"dev\") return \"console\";\n  if (normalized === \"none\" || normalized === \"off\") return \"none\";\n  return normalized;\n}\n\nfunction normalizeSmsProvider(value) {\n  const normalized = asString(value).toLowerCase();\n  if (!normalized) {\n    return \"\";\n  }\n  if (normalized.includes(\"twilio\")) return \"twilio\";\n  if (normalized.includes(\"console\") || normalized === \"dev\") return \"console\";\n  if (normalized === \"none\" || normalized === \"off\") return \"none\";\n  return normalized;\n}\n\nfunction resolveAlertEmailProvider() {\n  const configured = normalizeEmailProvider(process.env.CLIO_ALERT_EMAIL_PROVIDER);\n  if (configured) {\n    return configured;\n  }\n  const hasResend = asString(process.env.RESEND_API_KEY).startsWith(\"re_\") && asString(process.env.CLIO_EMAIL_FROM);\n  return hasResend ? \"resend\" : \"console\";\n}\n\nfunction resolveAlertSmsProvider() {\n  const configured = normalizeSmsProvider(process.env.CLIO_ALERT_SMS_PROVIDER);\n  if (configured) {\n    return configured;\n  }\n  return \"none\";\n}\n\nfunction resolveSecurityAlertRecipients(explicitRecipients = []) {\n  const fromEnv = [\n    ...parseCsvList(process.env.CLIO_SECURITY_ALERT_RECIPIENTS),\n    ...parseCsvList(process.env.GRC_EMAILS),\n    ...parseCsvList(process.env.SUPER_ADMIN_EMAILS),\n  ];\n  return dedupe(\n    [...fromEnv, ...asArray(explicitRecipients)]\n      .map((value) => normalizeEmail(value))\n      .filter(Boolean),\n  );\n}\n\nfunction resolveSmsRecipients(explicitRecipients = []) {\n  const fromEnv = parseCsvList(process.env.CLIO_SMS_ALERT_RECIPIENTS);\n  return dedupe([...fromEnv, ...asArray(explicitRecipients)].map((value) => normalizePhone(value)).filter(Boolean));\n}\n\nfunction buildIncidentAlertSubject({ incident, detection }) {\n  const severity = asString(incident?.severity || detection?.severity || \"Medium\").toUpperCase();\n  const incidentCode = asString(incident?.incidentCode, \"INCIDENT\");\n  const title = asString(incident?.title, \"Security anomaly detected\");\n  return `[CLIO][${severity}] ${incidentCode} - ${title}`;\n}\n\nfunction buildIncidentAlertText({ incident, detection, sourceEvent }) {\n  const ruleId = asString(detection?.ruleId, \"N/A\");\n  const sourceIp = asString(sourceEvent?.metadata?.sourceIp || sourceEvent?.sourceIp, \"unknown\");\n  const actor = asString(sourceEvent?.performedBy, \"unknown\");\n  const requestPath = asString(sourceEvent?.metadata?.requestPath || sourceEvent?.requestPath, \"unknown\");\n  const observedCount = Number(detection?.observedCount || 0);\n  const detectedAt = asString(incident?.detectedAt || sourceEvent?.occurredAt, new Date().toISOString());\n  return [\n    \"CLIO security anomaly alert\",\n    `Incident: ${asString(incident?.incidentCode, \"-\")} | ${asString(incident?.title, \"-\")}`,\n    `Severity: ${asString(incident?.severity, \"-\")}`,\n    `Rule: ${ruleId}`,\n    `Detected At: ${detectedAt}`,\n    `Actor: ${actor}`,\n    `Source IP: ${sourceIp}`,\n    `Request Path: ${requestPath}`,\n    `Observed Count: ${observedCount > 0 ? observedCount : \"-\"}`,\n    `Summary: ${asString(incident?.summary || detection?.summary, \"-\")}`,\n    `Action URL: ${asString(incident?.actionUrl, \"/incident-management\")}`,\n  ].join(\"\\n\");\n}\n\nfunction buildIncidentAlertHtml(text) {\n  const escaped = String(text || \"\")\n    .replaceAll(\"&\", \"&amp;\")\n    .replaceAll(\"<\", \"&lt;\")\n    .replaceAll(\">\", \"&gt;\");\n  return `<pre style=\"font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap;\">${escaped}</pre>`;\n}\n\nasync function sendEmailViaResend({ recipients, subject, text, html }) {\n  const apiKey = asString(process.env.RESEND_API_KEY);\n  const fromAddress = asString(process.env.CLIO_EMAIL_FROM);\n  if (!apiKey || !fromAddress || !apiKey.startsWith(\"re_\")) {\n    throw new Error(\"email_provider_not_configured\");\n  }\n\n  const response = await fetch(`${RESEND_API_BASE}/emails`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      Authorization: `Bearer ${apiKey}`,\n    },\n    body: JSON.stringify({\n      from: fromAddress,\n      to: recipients,\n      subject,\n      text,\n      html,\n    }),\n  });\n\n  const payload = await response.json().catch(() => ({}));\n  if (!response.ok) {\n    const message =\n      asString(payload?.message) ||\n      asString(payload?.error?.message) ||\n      \"email_delivery_failed\";\n    throw new Error(`email_delivery_failed:${message}`);\n  }\n\n  return {\n    provider: \"resend\",\n    status: \"sent\",\n    messageId: asString(payload?.id, `resend-${Date.now()}`),\n    recipientCount: recipients.length,\n  };\n}\n\nfunction sendEmailViaConsole({ recipients, subject, text }) {\n  if (parseBooleanEnv(\"CLIO_ALLOW_CONSOLE_EMAIL\", true) || process.env.NODE_ENV !== \"production\") {\n    console.info(\"[CLIO:SecurityAlert:Email]\", {\n      recipients,\n      subject,\n      text,\n    });\n  }\n  return {\n    provider: \"console\",\n    status: \"simulated\",\n    recipientCount: recipients.length,\n  };\n}\n\nasync function dispatchEmailAlerts({ recipients, subject, text, html }) {\n  const safeRecipients = dedupe(asArray(recipients).map(normalizeEmail).filter(Boolean));\n  if (safeRecipients.length === 0) {\n    return {\n      provider: \"none\",\n      status: \"skipped\",\n      reason: \"no_recipients\",\n      recipientCount: 0,\n    };\n  }\n\n  const provider = resolveAlertEmailProvider();\n  if (provider === \"none\") {\n    return {\n      provider,\n      status: \"skipped\",\n      reason: \"provider_disabled\",\n      recipientCount: 0,\n    };\n  }\n  if (provider === \"firebase\") {\n    return {\n      provider,\n      status: \"skipped\",\n      reason: \"firebase_not_supported_for_custom_alert_email\",\n      recipientCount: 0,\n    };\n  }\n  if (provider === \"console\") {\n    return sendEmailViaConsole({\n      recipients: safeRecipients,\n      subject,\n      text,\n    });\n  }\n  if (provider === \"resend\") {\n    return await sendEmailViaResend({\n      recipients: safeRecipients,\n      subject,\n      text,\n      html,\n    });\n  }\n\n  return {\n    provider,\n    status: \"skipped\",\n    reason: \"unsupported_provider\",\n    recipientCount: 0,\n  };\n}\n\nasync function sendSmsViaTwilio({ recipients, body }) {\n  const accountSid = asString(process.env.TWILIO_ACCOUNT_SID);\n  const authToken = asString(process.env.TWILIO_AUTH_TOKEN);\n  const fromNumber = asString(process.env.TWILIO_FROM_NUMBER);\n  if (!accountSid || !authToken || !fromNumber) {\n    throw new Error(\"twilio_not_configured\");\n  }\n\n  const authHeader = Buffer.from(`${accountSid}:${authToken}`, \"utf8\").toString(\"base64\");\n  const requests = recipients.map(async (to) => {\n    const form = new URLSearchParams();\n    form.set(\"To\", to);\n    form.set(\"From\", fromNumber);\n    form.set(\"Body\", body);\n    const response = await fetch(`${TWILIO_API_BASE}/Accounts/${encodeURIComponent(accountSid)}/Messages.json`, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Basic ${authHeader}`,\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n      },\n      body: form.toString(),\n    });\n    const payload = await response.json().catch(() => ({}));\n    if (!response.ok) {\n      const message = asString(payload?.message, \"sms_delivery_failed\");\n      throw new Error(`twilio_delivery_failed:${message}`);\n    }\n    return {\n      to,\n      sid: asString(payload?.sid),\n    };\n  });\n\n  const settled = await Promise.allSettled(requests);\n  const delivered = settled\n    .filter((item) => item.status === \"fulfilled\")\n    .map((item) => item.value);\n  const failed = settled\n    .filter((item) => item.status === \"rejected\")\n    .map((item) => asString(item.reason?.message || \"sms_delivery_failed\"));\n\n  return {\n    provider: \"twilio\",\n    status: failed.length > 0 ? (delivered.length > 0 ? \"partial\" : \"failed\") : \"sent\",\n    deliveredCount: delivered.length,\n    recipientCount: recipients.length,\n    delivered,\n    failed,\n  };\n}\n\nfunction sendSmsViaConsole({ recipients, body }) {\n  if (process.env.NODE_ENV !== \"production\") {\n    console.info(\"[CLIO:SecurityAlert:SMS]\", {\n      recipients,\n      body,\n    });\n  }\n  return {\n    provider: \"console\",\n    status: \"simulated\",\n    deliveredCount: recipients.length,\n    recipientCount: recipients.length,\n    delivered: recipients.map((to) => ({ to, sid: `console-${Date.now()}` })),\n    failed: [],\n  };\n}\n\nasync function dispatchSmsAlerts({ recipients, body }) {\n  const safeRecipients = dedupe(asArray(recipients).map(normalizePhone).filter(Boolean));\n  if (safeRecipients.length === 0) {\n    return {\n      provider: \"none\",\n      status: \"skipped\",\n      reason: \"no_recipients\",\n      deliveredCount: 0,\n      recipientCount: 0,\n      failed: [],\n    };\n  }\n\n  const provider = resolveAlertSmsProvider();\n  if (provider === \"none\") {\n    return {\n      provider,\n      status: \"skipped\",\n      reason: \"provider_disabled\",\n      deliveredCount: 0,\n      recipientCount: safeRecipients.length,\n      failed: [],\n    };\n  }\n  if (provider === \"console\") {\n    return sendSmsViaConsole({\n      recipients: safeRecipients,\n      body,\n    });\n  }\n  if (provider === \"twilio\") {\n    return await sendSmsViaTwilio({\n      recipients: safeRecipients,\n      body,\n    });\n  }\n\n  return {\n    provider,\n    status: \"skipped\",\n    reason: \"unsupported_provider\",\n    deliveredCount: 0,\n    recipientCount: safeRecipients.length,\n    failed: [],\n  };\n}\n\nfunction getConfiguredWebhookTargets() {\n  const generic = parseCsvList(process.env.CLIO_SECURITY_WEBHOOK_URLS).map((url) => ({\n    label: \"security-webhook\",\n    url,\n    token: asString(process.env.CLIO_SECURITY_WEBHOOK_TOKEN),\n  }));\n  const siemUrl = asString(process.env.CLIO_SIEM_WEBHOOK_URL);\n  const edrUrl = asString(process.env.CLIO_EDR_WEBHOOK_URL);\n  const targets = [...generic];\n  if (siemUrl) {\n    targets.push({\n      label: \"siem\",\n      url: siemUrl,\n      token: asString(process.env.CLIO_SIEM_WEBHOOK_TOKEN),\n    });\n  }\n  if (edrUrl) {\n    targets.push({\n      label: \"edr\",\n      url: edrUrl,\n      token: asString(process.env.CLIO_EDR_WEBHOOK_TOKEN),\n    });\n  }\n  return targets.filter((target) => asString(target.url));\n}\n\nasync function postWebhook({ url, label, token, payload, timeoutMs }) {\n  const controller = new AbortController();\n  const timer = setTimeout(() => controller.abort(), timeoutMs);\n  try {\n    const headers = {\n      \"Content-Type\": \"application/json\",\n      \"X-CLIO-Source\": \"security-detection\",\n      \"X-CLIO-Target\": label,\n    };\n    if (token) {\n      headers.Authorization = `Bearer ${token}`;\n    }\n    const response = await fetch(url, {\n      method: \"POST\",\n      headers,\n      body: JSON.stringify(payload),\n      signal: controller.signal,\n    });\n    const body = await response.text().catch(() => \"\");\n    return {\n      label,\n      url,\n      ok: response.ok,\n      status: response.status,\n      body: asString(body),\n    };\n  } catch (error) {\n    return {\n      label,\n      url,\n      ok: false,\n      status: 0,\n      body: asString(error?.message, \"webhook_delivery_failed\"),\n    };\n  } finally {\n    clearTimeout(timer);\n  }\n}\n\nasync function dispatchWebhooks(payload) {\n  const targets = getConfiguredWebhookTargets();\n  if (targets.length === 0) {\n    return {\n      status: \"skipped\",\n      targets: [],\n      successCount: 0,\n    };\n  }\n\n  const timeoutMs = Number.parseInt(asString(process.env.CLIO_SECURITY_WEBHOOK_TIMEOUT_MS, \"5000\"), 10) || 5000;\n  const results = await Promise.all(\n    targets.map((target) =>\n      postWebhook({\n        ...target,\n        payload,\n        timeoutMs: Math.max(1000, Math.min(20000, timeoutMs)),\n      }),\n    ),\n  );\n  const successCount = results.filter((item) => item.ok).length;\n  return {\n    status: successCount === results.length ? \"sent\" : successCount > 0 ? \"partial\" : \"failed\",\n    targets: results,\n    successCount,\n  };\n}\n\nexport async function dispatchSecurityIncidentAlerts({\n  incident,\n  detection,\n  sourceEvent,\n  emailRecipients = [],\n  smsRecipients = [],\n} = {}) {\n  const recipients = resolveSecurityAlertRecipients(emailRecipients);\n  const smsTargets = resolveSmsRecipients(smsRecipients);\n  const subject = buildIncidentAlertSubject({ incident, detection });\n  const text = buildIncidentAlertText({ incident, detection, sourceEvent });\n  const html = buildIncidentAlertHtml(text);\n\n  const [emailResult, smsResult, webhookResult] = await Promise.all([\n    dispatchEmailAlerts({\n      recipients,\n      subject,\n      text,\n      html,\n    }).catch((error) => ({\n      provider: resolveAlertEmailProvider(),\n      status: \"failed\",\n      reason: asString(error?.message, \"email_delivery_failed\"),\n      recipientCount: recipients.length,\n    })),\n    dispatchSmsAlerts({\n      recipients: smsTargets,\n      body: `${subject}\\n${text}`.slice(0, 1200),\n    }).catch((error) => ({\n      provider: resolveAlertSmsProvider(),\n      status: \"failed\",\n      reason: asString(error?.message, \"sms_delivery_failed\"),\n      deliveredCount: 0,\n      recipientCount: smsTargets.length,\n      failed: [asString(error?.message, \"sms_delivery_failed\")],\n    })),\n    dispatchWebhooks({\n      eventType: \"clio.security.incident\",\n      generatedAt: new Date().toISOString(),\n      incident,\n      detection,\n      sourceEvent: {\n        id: asString(sourceEvent?.id),\n        module: asString(sourceEvent?.module),\n        activityName: asString(sourceEvent?.activityName),\n        status: asString(sourceEvent?.status),\n        occurredAt: asString(sourceEvent?.occurredAt),\n        sourceIp: asString(sourceEvent?.metadata?.sourceIp || sourceEvent?.sourceIp),\n        requestPath: asString(sourceEvent?.metadata?.requestPath || sourceEvent?.requestPath),\n      },\n    }),\n  ]);\n\n  return {\n    subject,\n    email: emailResult,\n    sms: smsResult,\n    webhooks: webhookResult,\n    recipients,\n    smsRecipients: smsTargets,\n  };\n}\n\nexport function resolveSecurityAlertEmailRecipients(explicitRecipients = []) {\n  return resolveSecurityAlertRecipients(explicitRecipients);\n}\n"],"names":[],"mappings":"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"}