{"version":3,"sources":["../../../src/lib/security-notifications.js"],"sourcesContent":["import {\n  addDoc,\n  collection,\n  doc,\n  getDoc,\n  getDocs,\n  limit as queryLimit,\n  orderBy,\n  query,\n  updateDoc,\n} from \"firebase/firestore/lite\";\nimport { getFirestoreDb, isFirestoreEnabled } from \"@/lib/firebase\";\nimport { listUserAccounts } from \"@/lib/user-accounts\";\n\nconst DEFAULT_LIST_LIMIT = 20;\nconst MAX_LIST_LIMIT = 120;\nconst MAX_READ_ALL_LIMIT = 300;\n\nfunction nowIso() {\n  return new Date().toISOString();\n}\n\nfunction asString(value, fallback = \"\") {\n  const normalized = String(value || \"\").trim();\n  return normalized || fallback;\n}\n\nfunction asBoolean(value, fallback = false) {\n  if (typeof value === \"boolean\") {\n    return value;\n  }\n  if (typeof value === \"number\") {\n    return value !== 0;\n  }\n  if (typeof value === \"string\") {\n    const normalized = value.trim().toLowerCase();\n    if (!normalized) {\n      return fallback;\n    }\n    if ([\"true\", \"1\", \"yes\", \"on\", \"y\"].includes(normalized)) {\n      return true;\n    }\n    if ([\"false\", \"0\", \"no\", \"off\", \"n\"].includes(normalized)) {\n      return false;\n    }\n  }\n  return fallback;\n}\n\nfunction asObject(value) {\n  if (value && typeof value === \"object\" && !Array.isArray(value)) {\n    return value;\n  }\n  return {};\n}\n\nfunction asArray(value) {\n  return Array.isArray(value) ? value : [];\n}\n\nfunction clampInt(value, fallback, { min = 1, max = Number.MAX_SAFE_INTEGER } = {}) {\n  const parsed = Number.parseInt(String(value || \"\"), 10);\n  if (!Number.isFinite(parsed)) {\n    return fallback;\n  }\n  return Math.min(max, Math.max(min, parsed));\n}\n\nfunction normalizeEmail(value) {\n  return String(value || \"\").trim().toLowerCase();\n}\n\nfunction normalizeText(value) {\n  return String(value || \"\").trim().toLowerCase();\n}\n\nfunction parseEmailList(rawValue) {\n  return String(rawValue || \"\")\n    .split(\",\")\n    .map((item) => normalizeEmail(item))\n    .filter(Boolean);\n}\n\nfunction normalizeSeverity(value) {\n  const normalized = String(value || \"\").trim().toLowerCase();\n  if (normalized === \"critical\") return \"critical\";\n  if (normalized === \"high\") return \"high\";\n  if (normalized === \"low\") return \"low\";\n  return \"medium\";\n}\n\nfunction normalizeNotificationStatus(value) {\n  return String(value || \"\").trim().toLowerCase() === \"read\" ? \"read\" : \"unread\";\n}\n\nfunction getNotificationsCollectionName() {\n  return asString(process.env.CLIO_FIRESTORE_NOTIFICATIONS_COLLECTION, \"clio_notifications\");\n}\n\nfunction getFirestoreStore() {\n  if (!isFirestoreEnabled()) {\n    return null;\n  }\n  return getFirestoreDb();\n}\n\nfunction toNotificationRecord(snapshot) {\n  const payload = snapshot.data() || {};\n  return {\n    ...payload,\n    id: snapshot.id,\n    recordId: snapshot.id,\n  };\n}\n\nfunction isVisibleNotification(row, recipientEmail) {\n  const recipient = normalizeEmail(recipientEmail);\n  const owner = normalizeEmail(row?.recipientEmail);\n  const broadcast = asBoolean(row?.broadcast, false);\n  return broadcast || (recipient && owner && recipient === owner);\n}\n\nfunction sortByCreatedDesc(left, right) {\n  return new Date(right?.createdAt || 0).getTime() - new Date(left?.createdAt || 0).getTime();\n}\n\nfunction normalizeNotificationPayload(payload) {\n  const now = nowIso();\n  const recipientEmail = normalizeEmail(payload?.recipientEmail);\n  const broadcast = asBoolean(payload?.broadcast, false);\n  if (!recipientEmail && !broadcast) {\n    throw new Error(\"invalid_notification_recipient\");\n  }\n\n  return {\n    title: asString(payload?.title, \"Security notification\"),\n    message: asString(payload?.message, \"A security event requires review.\"),\n    severity: normalizeSeverity(payload?.severity),\n    type: asString(payload?.type, \"security\"),\n    module: asString(payload?.module, \"Incident Management\"),\n    actionUrl: asString(payload?.actionUrl, \"/incident-management\"),\n    recipientEmail,\n    broadcast,\n    status: normalizeNotificationStatus(payload?.status),\n    metadata: asObject(payload?.metadata),\n    createdAt: asString(payload?.createdAt, now),\n    updatedAt: asString(payload?.updatedAt, now),\n    readAt: asString(payload?.readAt, \"\"),\n    createdBy: normalizeEmail(payload?.createdBy),\n  };\n}\n\nexport async function createInAppNotification(payload) {\n  const db = getFirestoreStore();\n  if (!db) {\n    return null;\n  }\n\n  const normalized = normalizeNotificationPayload(payload);\n  const ref = await addDoc(collection(db, getNotificationsCollectionName()), normalized);\n  return {\n    ...normalized,\n    id: ref.id,\n    recordId: ref.id,\n  };\n}\n\nexport async function createInAppNotificationsBulk(payloads) {\n  const entries = asArray(payloads);\n  if (entries.length === 0) {\n    return [];\n  }\n\n  const created = [];\n  for (const payload of entries) {\n    const result = await createInAppNotification(payload);\n    if (result) {\n      created.push(result);\n    }\n  }\n  return created;\n}\n\nexport async function listInAppNotifications({\n  recipientEmail,\n  status = \"all\",\n  limit = DEFAULT_LIST_LIMIT,\n} = {}) {\n  const db = getFirestoreStore();\n  if (!db) {\n    return {\n      records: [],\n      unreadCount: 0,\n      totalScoped: 0,\n    };\n  }\n\n  const normalizedStatus = String(status || \"\").trim().toLowerCase();\n  const safeLimit = clampInt(limit, DEFAULT_LIST_LIMIT, { min: 1, max: MAX_LIST_LIMIT });\n  const scanLimit = Math.max(safeLimit * 4, 100);\n\n  const snapshot = await getDocs(\n    query(\n      collection(db, getNotificationsCollectionName()),\n      orderBy(\"createdAt\", \"desc\"),\n      queryLimit(scanLimit),\n    ),\n  );\n\n  const scoped = snapshot.docs.map(toNotificationRecord).filter((row) => isVisibleNotification(row, recipientEmail));\n  const unreadCount = scoped.reduce((count, row) => count + (normalizeNotificationStatus(row?.status) === \"unread\" ? 1 : 0), 0);\n\n  const statusFiltered = scoped.filter((row) => {\n    if (normalizedStatus === \"all\" || !normalizedStatus) {\n      return true;\n    }\n    return normalizeNotificationStatus(row?.status) === normalizedStatus;\n  });\n\n  return {\n    records: statusFiltered.sort(sortByCreatedDesc).slice(0, safeLimit),\n    unreadCount,\n    totalScoped: scoped.length,\n  };\n}\n\nexport async function markInAppNotificationRead(recordId, recipientEmail) {\n  const db = getFirestoreStore();\n  if (!db) {\n    return null;\n  }\n\n  const normalizedId = asString(recordId);\n  if (!normalizedId) {\n    throw new Error(\"invalid_record_id\");\n  }\n\n  const ref = doc(db, getNotificationsCollectionName(), normalizedId);\n  const snapshot = await getDoc(ref);\n  if (!snapshot.exists()) {\n    return null;\n  }\n\n  const current = toNotificationRecord(snapshot);\n  if (!isVisibleNotification(current, recipientEmail)) {\n    throw new Error(\"forbidden_notification_access\");\n  }\n\n  if (normalizeNotificationStatus(current.status) === \"read\") {\n    return current;\n  }\n\n  const patched = {\n    ...current,\n    status: \"read\",\n    readAt: nowIso(),\n    updatedAt: nowIso(),\n  };\n  await updateDoc(ref, patched);\n  return patched;\n}\n\nexport async function markAllInAppNotificationsRead({ recipientEmail, limit = 120 } = {}) {\n  const normalizedRecipient = normalizeEmail(recipientEmail);\n  if (!normalizedRecipient) {\n    return {\n      updatedCount: 0,\n    };\n  }\n\n  const db = getFirestoreStore();\n  if (!db) {\n    return {\n      updatedCount: 0,\n    };\n  }\n\n  const safeLimit = clampInt(limit, 120, { min: 1, max: MAX_READ_ALL_LIMIT });\n  const { records } = await listInAppNotifications({\n    recipientEmail: normalizedRecipient,\n    status: \"unread\",\n    limit: safeLimit,\n  });\n\n  let updatedCount = 0;\n  for (const row of records) {\n    const recordId = asString(row?.id || row?.recordId);\n    if (!recordId) {\n      continue;\n    }\n    const ref = doc(db, getNotificationsCollectionName(), recordId);\n    await updateDoc(ref, {\n      status: \"read\",\n      readAt: nowIso(),\n      updatedAt: nowIso(),\n    });\n    updatedCount += 1;\n  }\n\n  return {\n    updatedCount,\n  };\n}\n\nexport function resolveNotificationRecipients(values = []) {\n  return Array.from(\n    new Set(\n      asArray(values)\n        .map((value) => normalizeEmail(value))\n        .filter(Boolean),\n    ),\n  );\n}\n\nexport async function resolveIncidentStakeholderRecipients({\n  ownerEmail,\n  affectedEmployeeEmail,\n  actorEmail,\n  includeAffectedEmployee = true,\n  includeActor = false,\n} = {}) {\n  const baseRecipients = [\n    normalizeEmail(process.env.CLIO_GRC_ALERT_EMAIL),\n    ...parseEmailList(process.env.GRC_EMAILS),\n    ...parseEmailList(process.env.SUPER_ADMIN_EMAILS),\n    normalizeEmail(ownerEmail),\n  ];\n\n  if (includeAffectedEmployee) {\n    baseRecipients.push(normalizeEmail(affectedEmployeeEmail));\n  }\n  if (includeActor) {\n    baseRecipients.push(normalizeEmail(actorEmail));\n  }\n\n  let dynamicRoleRecipients = [];\n  try {\n    const users = await listUserAccounts();\n    dynamicRoleRecipients = asArray(users)\n      .filter((user) => normalizeEmail(user?.email))\n      .filter((user) => normalizeText(user?.status) === \"active\")\n      .filter((user) => {\n        const role = String(user?.role || \"\").trim().toUpperCase();\n        return role === \"GRC\" || role === \"SUPER_ADMIN\";\n      })\n      .map((user) => normalizeEmail(user?.email));\n  } catch {\n    dynamicRoleRecipients = [];\n  }\n\n  return resolveNotificationRecipients([...baseRecipients, ...dynamicRoleRecipients]);\n}\n"],"names":[],"mappings":"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"}