module.exports=[36725,a=>{"use strict";a.i(2446);var b=a.i(73004),c=a.i(70767),d=a.i(39748);a.i(64368);var e=a.i(2252);let f=["Low","Medium","High","Critical"],g=["Open","Containment","Investigating","Escalated","Regulatory Review","Resolved","Closed"],h=["Not Started","In Progress","Contained"],i=["Pending","In Progress","Completed"],j=["Unauthorized Access","Data Exposure","Credential Compromise","Insider Misuse","Malware / Ransomware","Policy Violation","System Misconfiguration","Other"],k=new Set(["pdf","png","jpg","jpeg","webp","doc","docx","xls","xlsx","csv","txt"]),l=new Set(["application/pdf","image/png","image/jpeg","image/webp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv","text/plain"]);function m(a,b){return String(process.env[a]||"").trim()||b}function n(a,b){let c=String(a||"").split(",").map(a=>String(a||"").trim().toLowerCase()).filter(Boolean);return new Set(0===c.length?[...b]:c)}function o(){return new Date().toISOString()}function p(a,b=""){return String(a??"").trim()||b}function q(a){return String(a||"").trim().toLowerCase()}function r(a){return String(a||"").trim().toLowerCase()}function s(a){return Array.isArray(a)?a:[]}function t(a,b={}){return a&&"object"==typeof a&&!Array.isArray(a)?a:b}function u(a,b=!1){if("boolean"==typeof a)return a;if("number"==typeof a)return 0!==a;if("string"==typeof a){let c=a.trim().toLowerCase();if(!c)return b;if(["true","1","yes","y","on"].includes(c))return!0;if(["false","0","no","n","off"].includes(c))return!1}return b}function v(a,b){return new Date(b.updatedAt||b.createdAt||0).getTime()-new Date(a.updatedAt||a.createdAt||0).getTime()}function w(a){return({employees:m("CLIO_FIRESTORE_EMPLOYEES_COLLECTION","employees"),lifecycle:m("CLIO_FIRESTORE_LIFECYCLE_COLLECTION","employment_lifecycle"),attendance:m("CLIO_FIRESTORE_ATTENDANCE_COLLECTION","attendance"),leave:m("CLIO_FIRESTORE_LEAVE_COLLECTION","leave_requests"),performance:m("CLIO_FIRESTORE_PERFORMANCE_COLLECTION","performance_records"),templates:m("CLIO_FIRESTORE_TEMPLATES_COLLECTION","document_templates"),exports:m("CLIO_FIRESTORE_EXPORTS_COLLECTION","export_requests"),incidents:m("CLIO_FIRESTORE_INCIDENTS_COLLECTION","security_incidents"),settingsReference:m("CLIO_FIRESTORE_SETTINGS_REFERENCE_COLLECTION","settings_reference_data")})[a]||a}function x(){if(!(0,c.isFirestoreEnabled)())throw Error("firestore_not_configured");let a=(0,c.getFirestoreDb)();if(!a)throw Error("firestore_not_configured");return a}async function y(a,{filterField:c,filterValue:d}={}){let e=x(),f=(0,b.collection)(e,a);return(c&&"string"==typeof d&&d.trim()?await (0,b.getDocs)((0,b.query)(f,(0,b.where)(c,"==",d.trim()))):await (0,b.getDocs)(f)).docs.map(a=>({...a.data(),id:a.id,recordId:a.id})).sort(v)}async function z(a,c){let d=x(),e=p(c);if(!e)throw Error("invalid_record_id");let f=(0,b.doc)(d,a,e),g=await (0,b.getDoc)(f);return g.exists()?{...g.data(),id:g.id,recordId:g.id}:null}async function A(a,c){let d=x(),e=await (0,b.addDoc)((0,b.collection)(d,a),c);return{...c,id:e.id,recordId:e.id}}async function B(a,c,d){let e=x(),f=p(c);if(!f)throw Error("invalid_record_id");let g=(0,b.doc)(e,a,f),h=await (0,b.getDoc)(g);if(!h.exists())return null;let i={...h.data()||{},...d};return await (0,b.updateDoc)(g,i),{...i,id:h.id,recordId:h.id}}function C(a,b="Medium"){let c=p(a,b).toLowerCase();return f.find(a=>a.toLowerCase()===c)||"Medium"}function D(a){switch(C(a)){case"Critical":return 3;case"High":return 2;case"Medium":return 1;default:return 0}}async function E(a,{limit:b}={}){let c=o(),d=M(a?.forensicWindowStart||a?.detectedAt)||c,f=M(a?.forensicWindowEnd||c)||c,g=L(d)||0,h=L(f)||Date.now(),i=r(a?.affectedEmployeeEmail||a?.employeeEmail||""),j=Number.isFinite(Number(b))?Number(b):1800,k=[];try{k=await (0,e.listAuditEvents)({limit:Math.max(100,Math.min(5e3,j))})}catch{k=[]}let l=k.filter(a=>{let b=L(a?.occurredAt||a?.loggedAt);if(!Number.isFinite(b)||b<g||b>h)return!1;let c=r(i);if(!c)return!0;let d=t(a?.metadata,{});return[a?.performedBy,a?.performedByEmail,d.employeeEmail,d.ownerEmail,d.requestedBy,d.targetEmployeeEmail,d.affectedEmployeeEmail].some(a=>r(a)===c)}),m=[],n=[],s=[],u=[];return l.forEach(a=>{let b,c,d,e,f,g,h,i,j,k,l={id:p(a?.id),activityName:p(a?.activityName),module:p(a?.module),status:p(a?.status),occurredAt:p(a?.occurredAt),performedBy:p(a?.performedBy),requestMethod:p(a?.requestMethod),requestPath:p(a?.requestPath)};(b=q(a?.requestMethod),c=q(a?.activityName),"delete"===b||c.includes("delete")||c.includes("purge")||c.includes("removed")||c.includes("archive"))?u.push(l):(d=q(a?.module),e=q(a?.requestPath),f=q(a?.activityName),d.includes("export")||e.includes("/api/hris/exports")||f.includes("export"))?n.push(l):(g=q(a?.module),h=q(a?.requestMethod),i=q(a?.activityName),g.includes("authorization")||g.includes("user management")||g.includes("access management")||"patch"===h||"post"===h||i.includes("approve")||i.includes("revok")||i.includes("invite")||i.includes("role"))?s.push(l):(j=q(a?.requestMethod),k=q(a?.activityName),("get"===j||k.includes("viewed")||k.includes("listed")||k.includes("access"))&&m.push(l))}),{generatedAt:c,windowStart:d,windowEnd:f,scopedSubjectEmail:i||"",totalScopedLogs:l.length,accessLogsCount:m.length,exportLogsCount:n.length,administrativeActionsCount:s.length,deletionActivitiesCount:u.length,accessLogs:m.slice(0,8),exportLogs:n.slice(0,8),administrativeActions:s.slice(0,8),deletionActivities:u.slice(0,8)}}function F(a,b,{base:c}={}){var d,e,f;let m,v,w,x,y,z=o(),A=p(a?.title,p(c?.title));if(!A)throw Error("invalid_incident_title");let B=M(a?.detectedAt||c?.detectedAt||z)||z,E=C(a?.severity,p(c?.severity,"Medium")),G=function(a,b="Other"){let c=p(a,b).toLowerCase();return j.find(a=>a.toLowerCase()===c)||"Other"}(a?.incidentType,p(c?.incidentType,"Other")),H=u(a?.restrictedPiiInvolved,u(c?.restrictedPiiInvolved,!1)),I=u(a?.executiveNotificationRequired,"Critical"===E||u(c?.executiveNotificationRequired,!1)),J=u(a?.escalationRequired,I||H||D(E)>=D("High")||u(c?.escalationRequired,!1)),K=function({severity:a,restrictedPiiInvolved:b,executiveNotificationRequired:c}){return"Critical"===a||c?"Executive":"High"===a||b?"GRC":"Operational"}({severity:E,restrictedPiiInvolved:H,executiveNotificationRequired:I}),N=function(a,b="Open"){let c=p(a,b).toLowerCase();return g.find(a=>a.toLowerCase()===c)||"Open"}(a?.status,p(c?.status,"Open")),O=function(a,b="Not Started"){let c=p(a,b).toLowerCase();return h.find(a=>a.toLowerCase()===c)||"Not Started"}(a?.containmentStatus,p(c?.containmentStatus,"Not Started")),P=function(a,b="Pending"){let c=p(a,b).toLowerCase();return i.find(a=>a.toLowerCase()===c)||"Pending"}(a?.impactAssessmentStatus,p(c?.impactAssessmentStatus,"Pending")),Q=u(a?.regulatoryNotificationRequired,H||u(c?.regulatoryNotificationRequired,!1)),R=Q?p(c?.regulatoryDueAt,(m=Number.isFinite(Number(72))?Number(72):0,Number.isNaN((v=new Date(B||o())).getTime())?o():(v.setTime(v.getTime()+60*Math.max(0,m)*6e4),v.toISOString()))):"",S=M(a?.regulatoryNotifiedAt||c?.regulatoryNotifiedAt||""),T=M(a?.affectedIndividualsNotifiedAt||c?.affectedIndividualsNotifiedAt||""),U=function({regulatoryNotificationRequired:a,regulatoryNotifiedAt:b,regulatoryDueAt:c,nowIsoValue:d=o()}){if(!a)return"Not Required";if(L(b))return"Notified";let e=L(c),f=L(d)||Date.now();return Number.isFinite(e)&&e<f?"Overdue":"Pending"}({regulatoryNotificationRequired:Q,regulatoryNotifiedAt:S,regulatoryDueAt:R,nowIsoValue:z}),V=u(a?.documentationRetained,u(c?.documentationRetained,!1)),W=V?M(a?.documentationRetainedAt||c?.documentationRetainedAt||z)||z:"",X=M(a?.executiveNotifiedAt||c?.executiveNotifiedAt||""),Y=J?M(a?.grcAlertedAt||c?.grcAlertedAt||z)||z:"",Z="In Progress"===O||"Contained"===O?M(a?.containmentStartedAt||c?.containmentStartedAt||z)||z:M(a?.containmentStartedAt||c?.containmentStartedAt||""),$="Contained"===O?M(a?.containmentCompletedAt||c?.containmentCompletedAt||z)||z:M(a?.containmentCompletedAt||c?.containmentCompletedAt||""),_="Completed"===P?M(a?.impactAssessmentCompletedAt||c?.impactAssessmentCompletedAt||z)||z:M(a?.impactAssessmentCompletedAt||c?.impactAssessmentCompletedAt||""),aa=M(a?.forensicWindowStart||c?.forensicWindowStart||B)||B,ab=M(a?.forensicWindowEnd||c?.forensicWindowEnd||z)||z,ac=(d=Object.prototype.hasOwnProperty.call(t(a,{}),"evidenceDocuments")?a?.evidenceDocuments:c?.evidenceDocuments,w=p(z,o()),x={maxBytes:function(a,b,{min:c=1,max:d=Number.MAX_SAFE_INTEGER}={}){let e=Number.parseInt(String(process.env[a]||"").trim(),10);return Number.isFinite(e)?Math.min(d,Math.max(c,e)):0xa00000}("CLIO_INCIDENT_EVIDENCE_MAX_BYTES",0,{min:131072,max:0x3200000}),allowedExtensions:n(process.env.CLIO_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS,k),allowedMimeTypes:n(process.env.CLIO_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES,l)},s(d).map((a,c)=>{let d=t(a,{}),e=M(d.uploadedAt||w)||w,f=r(d.uploadedBy||b),g=p(d.name,`Incident Evidence ${c+1}`),h=p(d.type,"Incident Evidence"),i=p(d.ref),j=p(d.storagePath),k=function(a){let b=p(a).toLowerCase();if(!b)return"";let c=b.split("?")[0].split("#")[0].split(".").pop()||"";return/^[a-z0-9]{2,10}$/.test(c)?c:""}(d.fileExtension||g||j||i),l=q(d.contentType),m=Number.isFinite(Number(d.sizeBytes))?Number(d.sizeBytes):0,n=p(d.id||d.recordId||j||`${c+1}`);if(!g&&!i&&!j)return null;if(k&&!x.allowedExtensions.has(k))throw Error("invalid_incident_evidence_extension");if(l&&!x.allowedMimeTypes.has(l))throw Error("invalid_incident_evidence_content_type");if(m>x.maxBytes)throw Error("invalid_incident_evidence_size");return{id:n,name:g||"Incident Evidence",type:h||"Incident Evidence",ref:i,storagePath:j,fileExtension:k,contentType:l,sizeBytes:m,scanStatus:p(d.scanStatus),scanReference:p(d.scanReference),scannedAt:M(d.scannedAt||""),uploadedAt:e,uploadedBy:f||b}}).filter(Boolean).slice(0,50)),ad=M(a?.detectionWindowStart||c?.detectionWindowStart||""),ae=M(a?.detectionWindowEnd||c?.detectionWindowEnd||""),af=s(a?.alertRecipients||c?.alertRecipients).map(a=>r(a)).filter(Boolean).slice(0,40);return{incidentCode:p(c?.incidentCode,function(a=o()){let b=new Date(a||o());if(Number.isNaN(b.getTime()))return`INC-${Date.now().toString().slice(-10)}`;let c=String(b.getUTCFullYear()),d=String(b.getUTCMonth()+1).padStart(2,"0"),e=String(b.getUTCDate()).padStart(2,"0"),f=String(b.getUTCHours()).padStart(2,"0"),g=String(b.getUTCMinutes()).padStart(2,"0"),h=Math.random().toString(36).slice(2,5).toUpperCase();return`INC-${c}${d}${e}-${f}${g}${h}`}(B)),title:A,summary:p(a?.summary,p(c?.summary)),incidentType:G,severity:E,status:N,restrictedPiiInvolved:H,affectedEmployeeEmail:r(a?.affectedEmployeeEmail||c?.affectedEmployeeEmail),ownerEmail:r(a?.ownerEmail||c?.ownerEmail||b),escalationRequired:J,escalationLevel:K,executiveNotificationRequired:I,executiveNotifiedAt:X,grcAlertedAt:Y,containmentStatus:O,containmentSummary:p(a?.containmentSummary,p(c?.containmentSummary)),containmentStartedAt:Z,containmentCompletedAt:$,impactAssessmentStatus:P,impactSummary:p(a?.impactSummary,p(c?.impactSummary)),impactAssessmentCompletedAt:_,regulatoryNotificationRequired:Q,regulatoryDueAt:R,regulatoryNotifiedAt:S,affectedIndividualsNotifiedAt:T,regulatoryStatus:U,documentationRetained:V,documentationRetainedAt:W,documentationLocation:p(a?.documentationLocation,p(c?.documentationLocation)),forensicWindowStart:aa,forensicWindowEnd:ab,evidenceDocuments:ac,evidenceDocumentsCount:ac.length,notes:p(a?.notes,p(c?.notes)),classificationStandard:p(a?.classificationStandard,p(c?.classificationStandard,"CLIO-IR-SEVERITY-V1")),autoGenerated:u(a?.autoGenerated,u(c?.autoGenerated,!1)),detectionRuleId:p(a?.detectionRuleId,p(c?.detectionRuleId)),detectionFingerprint:p(a?.detectionFingerprint,p(c?.detectionFingerprint)),detectionWindowStart:ad,detectionWindowEnd:ae,sourceSystem:p(a?.sourceSystem,p(c?.sourceSystem)),sourceEventId:p(a?.sourceEventId,p(c?.sourceEventId)),sourceEventModule:p(a?.sourceEventModule,p(c?.sourceEventModule)),sourceEventPath:p(a?.sourceEventPath,p(c?.sourceEventPath)),sourceIp:p(a?.sourceIp,p(c?.sourceIp)),alertRecipients:af,alertDispatchSummary:t(a?.alertDispatchSummary,t(c?.alertDispatchSummary,{})),externalIntegrations:t(a?.externalIntegrations,t(c?.externalIntegrations,{})),lastAlertDispatchAt:M(a?.lastAlertDispatchAt||c?.lastAlertDispatchAt||""),detectedAt:B,resolvedAt:M(a?.resolvedAt||c?.resolvedAt||("Resolved"===N?z:"")),closedAt:M(a?.closedAt||c?.closedAt||("Closed"===N?z:"")),createdAt:p(c?.createdAt,z),createdBy:p(c?.createdBy,b),updatedAt:z,updatedBy:b,traceability:(e=c?.traceability,f={at:z,by:b,action:c?"update":"create",status:N,severity:E,escalationLevel:K,regulatoryStatus:U},(y=[...s(e),f]).length<=80?y:y.slice(y.length-80))}}function G(a,b,c){let d=t(b,{});return{...a,forensicSnapshot:d,forensicSummary:{accessLogsCount:Number(d.accessLogsCount||0),exportLogsCount:Number(d.exportLogsCount||0),administrativeActionsCount:Number(d.administrativeActionsCount||0),deletionActivitiesCount:Number(d.deletionActivitiesCount||0),totalScopedLogs:Number(d.totalScopedLogs||0),generatedAt:p(d.generatedAt),windowStart:p(d.windowStart),windowEnd:p(d.windowEnd)},forensicLastUpdatedAt:p(d.generatedAt,o()),forensicLastUpdatedBy:c}}async function H(){return await y(w("incidents"))}async function I(a){return await z(w("incidents"),a)}async function J(a,b){let c=F(a,b),d=await E(c,{limit:Number.parseInt(m("CLIO_INCIDENT_FORENSIC_LOG_LIMIT","1800"),10)}),e=G(c,d,b);return await A(w("incidents"),e)}async function K(a,b,c){let d=await I(a);if(!d)return null;let e=F(b,c,{base:d}),f=u(b?.refreshForensicSnapshot,!1)||Object.prototype.hasOwnProperty.call(t(b,{}),"forensicWindowStart")||Object.prototype.hasOwnProperty.call(t(b,{}),"forensicWindowEnd")||Object.prototype.hasOwnProperty.call(t(b,{}),"affectedEmployeeEmail")||Object.prototype.hasOwnProperty.call(t(b,{}),"detectedAt")?await E(e,{limit:Number.parseInt(m("CLIO_INCIDENT_FORENSIC_LOG_LIMIT","1800"),10)}):t(d.forensicSnapshot,{}),g=G(e,f,c);return await B(w("incidents"),a,g)}function L(a){let b=new Date(a||"").getTime();return Number.isNaN(b)?null:b}function M(a){let b=L(a);return Number.isFinite(b)?new Date(b).toISOString():""}function N(a,b=""){return String(a||"").trim()||b}function O(a){return Array.isArray(a)?a:[]}function P(a){return String(a||"").trim().toLowerCase()}function Q(a){return String(a||"").split(",").map(a=>P(a)).filter(Boolean)}async function R(a){let d=(0,c.isFirestoreEnabled)()?(0,c.getFirestoreDb)():null;if(!d)return null;let e=function(a){var b;let c,d=new Date().toISOString(),e=P(a?.recipientEmail),f=function(a,b=!1){if("boolean"==typeof a)return a;if("number"==typeof a)return 0!==a;if("string"==typeof a){let c=a.trim().toLowerCase();if(!c)return b;if(["true","1","yes","on","y"].includes(c))return!0;if(["false","0","no","off","n"].includes(c))return!1}return b}(a?.broadcast,!1);if(!e&&!f)throw Error("invalid_notification_recipient");return{title:N(a?.title,"Security notification"),message:N(a?.message,"A security event requires review."),severity:"critical"===(c=String(a?.severity||"").trim().toLowerCase())?"critical":"high"===c?"high":"low"===c?"low":"medium",type:N(a?.type,"security"),module:N(a?.module,"Incident Management"),actionUrl:N(a?.actionUrl,"/incident-management"),recipientEmail:e,broadcast:f,status:"read"===String(a?.status||"").trim().toLowerCase()?"read":"unread",metadata:(b=a?.metadata)&&"object"==typeof b&&!Array.isArray(b)?b:{},createdAt:N(a?.createdAt,d),updatedAt:N(a?.updatedAt,d),readAt:N(a?.readAt,""),createdBy:P(a?.createdBy)}}(a),f=await (0,b.addDoc)((0,b.collection)(d,N(process.env.CLIO_FIRESTORE_NOTIFICATIONS_COLLECTION,"clio_notifications")),e);return{...e,id:f.id,recordId:f.id}}async function S(a){let b=O(a);if(0===b.length)return[];let c=[];for(let a of b){let b=await R(a);b&&c.push(b)}return c}async function T({ownerEmail:a,affectedEmployeeEmail:b,actorEmail:c,includeAffectedEmployee:e=!0,includeActor:f=!1}={}){let g=[P(process.env.CLIO_GRC_ALERT_EMAIL),...Q(process.env.GRC_EMAILS),...Q(process.env.SUPER_ADMIN_EMAILS),P(a)];e&&g.push(P(b)),f&&g.push(P(c));let h=[];try{let a=await (0,d.listUserAccounts)();h=O(a).filter(a=>P(a?.email)).filter(a=>{var b;return"active"===(b=a?.status,String(b||"").trim().toLowerCase())}).filter(a=>{let b=String(a?.role||"").trim().toUpperCase();return"GRC"===b||"SUPER_ADMIN"===b}).map(a=>P(a?.email))}catch{h=[]}return function(a=[]){return Array.from(new Set(O(a).map(a=>P(a)).filter(Boolean)))}([...g,...h])}function U(a,b=""){return String(a||"").trim()||b}function V(a){return Array.isArray(a)?a:[]}function W(a){return U(a).toLowerCase()}function X(a){return String(a||"").replace(/[^\d+]/g,"").trim()}function Y(a){return U(a).split(",").map(a=>a.trim()).filter(Boolean)}function Z(a=[]){return Array.from(new Set(a.filter(Boolean)))}function $(){let a,b=(a=U(process.env.CLIO_ALERT_EMAIL_PROVIDER).toLowerCase())?a.includes("resend")?"resend":a.includes("firebase")?"firebase":a.includes("console")||"dev"===a?"console":"none"===a||"off"===a?"none":a:"";return b||(U(process.env.RESEND_API_KEY).startsWith("re_")&&U(process.env.CLIO_EMAIL_FROM)?"resend":"console")}function _(){let a,b=(a=U(process.env.CLIO_ALERT_SMS_PROVIDER).toLowerCase())?a.includes("twilio")?"twilio":a.includes("console")||"dev"===a?"console":"none"===a||"off"===a?"none":a:"";return b||"none"}function aa(a=[]){return Z([...Y(process.env.CLIO_SECURITY_ALERT_RECIPIENTS),...Y(process.env.GRC_EMAILS),...Y(process.env.SUPER_ADMIN_EMAILS),...V(a)].map(a=>W(a)).filter(Boolean))}async function ab({recipients:a,subject:b,text:c,html:d}){let e=U(process.env.RESEND_API_KEY),f=U(process.env.CLIO_EMAIL_FROM);if(!e||!f||!e.startsWith("re_"))throw Error("email_provider_not_configured");let g=await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({from:f,to:a,subject:b,text:c,html:d})}),h=await g.json().catch(()=>({}));if(!g.ok){let a=U(h?.message)||U(h?.error?.message)||"email_delivery_failed";throw Error(`email_delivery_failed:${a}`)}return{provider:"resend",status:"sent",messageId:U(h?.id,`resend-${Date.now()}`),recipientCount:a.length}}async function ac({recipients:a,subject:b,text:c,html:d}){let e=Z(V(a).map(W).filter(Boolean));if(0===e.length)return{provider:"none",status:"skipped",reason:"no_recipients",recipientCount:0};let f=$();return"none"===f?{provider:f,status:"skipped",reason:"provider_disabled",recipientCount:0}:"firebase"===f?{provider:f,status:"skipped",reason:"firebase_not_supported_for_custom_alert_email",recipientCount:0}:"console"===f?function({recipients:a,subject:b,text:c}){return function(a,b=!1){let c=U(process.env[a]).toLowerCase();return c?"true"===c||"1"===c||"yes"===c:b}("CLIO_ALLOW_CONSOLE_EMAIL",!0)&&console.info("[CLIO:SecurityAlert:Email]",{recipients:a,subject:b,text:c}),{provider:"console",status:"simulated",recipientCount:a.length}}({recipients:e,subject:b,text:c}):"resend"===f?await ab({recipients:e,subject:b,text:c,html:d}):{provider:f,status:"skipped",reason:"unsupported_provider",recipientCount:0}}async function ad({recipients:a,body:b}){let c=U(process.env.TWILIO_ACCOUNT_SID),d=U(process.env.TWILIO_AUTH_TOKEN),e=U(process.env.TWILIO_FROM_NUMBER);if(!c||!d||!e)throw Error("twilio_not_configured");let f=Buffer.from(`${c}:${d}`,"utf8").toString("base64"),g=a.map(async a=>{let d=new URLSearchParams;d.set("To",a),d.set("From",e),d.set("Body",b);let g=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${encodeURIComponent(c)}/Messages.json`,{method:"POST",headers:{Authorization:`Basic ${f}`,"Content-Type":"application/x-www-form-urlencoded"},body:d.toString()}),h=await g.json().catch(()=>({}));if(!g.ok){let a=U(h?.message,"sms_delivery_failed");throw Error(`twilio_delivery_failed:${a}`)}return{to:a,sid:U(h?.sid)}}),h=await Promise.allSettled(g),i=h.filter(a=>"fulfilled"===a.status).map(a=>a.value),j=h.filter(a=>"rejected"===a.status).map(a=>U(a.reason?.message||"sms_delivery_failed"));return{provider:"twilio",status:j.length>0?i.length>0?"partial":"failed":"sent",deliveredCount:i.length,recipientCount:a.length,delivered:i,failed:j}}async function ae({recipients:a,body:b}){let c=Z(V(a).map(X).filter(Boolean));if(0===c.length)return{provider:"none",status:"skipped",reason:"no_recipients",deliveredCount:0,recipientCount:0,failed:[]};let d=_();return"none"===d?{provider:d,status:"skipped",reason:"provider_disabled",deliveredCount:0,recipientCount:c.length,failed:[]}:"console"===d?function({recipients:a,body:b}){return{provider:"console",status:"simulated",deliveredCount:a.length,recipientCount:a.length,delivered:a.map(a=>({to:a,sid:`console-${Date.now()}`})),failed:[]}}({recipients:c,body:b}):"twilio"===d?await ad({recipients:c,body:b}):{provider:d,status:"skipped",reason:"unsupported_provider",deliveredCount:0,recipientCount:c.length,failed:[]}}async function af({url:a,label:b,token:c,payload:d,timeoutMs:e}){let f=new AbortController,g=setTimeout(()=>f.abort(),e);try{let e={"Content-Type":"application/json","X-CLIO-Source":"security-detection","X-CLIO-Target":b};c&&(e.Authorization=`Bearer ${c}`);let g=await fetch(a,{method:"POST",headers:e,body:JSON.stringify(d),signal:f.signal}),h=await g.text().catch(()=>"");return{label:b,url:a,ok:g.ok,status:g.status,body:U(h)}}catch(c){return{label:b,url:a,ok:!1,status:0,body:U(c?.message,"webhook_delivery_failed")}}finally{clearTimeout(g)}}async function ag(a){let b,c,d,e,f=(b=Y(process.env.CLIO_SECURITY_WEBHOOK_URLS).map(a=>({label:"security-webhook",url:a,token:U(process.env.CLIO_SECURITY_WEBHOOK_TOKEN)})),c=U(process.env.CLIO_SIEM_WEBHOOK_URL),d=U(process.env.CLIO_EDR_WEBHOOK_URL),e=[...b],c&&e.push({label:"siem",url:c,token:U(process.env.CLIO_SIEM_WEBHOOK_TOKEN)}),d&&e.push({label:"edr",url:d,token:U(process.env.CLIO_EDR_WEBHOOK_TOKEN)}),e.filter(a=>U(a.url)));if(0===f.length)return{status:"skipped",targets:[],successCount:0};let g=Number.parseInt(U(process.env.CLIO_SECURITY_WEBHOOK_TIMEOUT_MS,"5000"),10)||5e3,h=await Promise.all(f.map(b=>af({...b,payload:a,timeoutMs:Math.max(1e3,Math.min(2e4,g))}))),i=h.filter(a=>a.ok).length;return{status:i===h.length?"sent":i>0?"partial":"failed",targets:h,successCount:i}}async function ah({incident:a,detection:b,sourceEvent:c,emailRecipients:d=[],smsRecipients:e=[]}={}){let f,g=aa(d),h=function(a=[]){return Z([...Y(process.env.CLIO_SMS_ALERT_RECIPIENTS),...V(a)].map(a=>X(a)).filter(Boolean))}(e),i=function({incident:a,detection:b}){let c=U(a?.severity||b?.severity||"Medium").toUpperCase(),d=U(a?.incidentCode,"INCIDENT"),e=U(a?.title,"Security anomaly detected");return`[CLIO][${c}] ${d} - ${e}`}({incident:a,detection:b}),j=function({incident:a,detection:b,sourceEvent:c}){let d=U(b?.ruleId,"N/A"),e=U(c?.metadata?.sourceIp||c?.sourceIp,"unknown"),f=U(c?.performedBy,"unknown"),g=U(c?.metadata?.requestPath||c?.requestPath,"unknown"),h=Number(b?.observedCount||0),i=U(a?.detectedAt||c?.occurredAt,new Date().toISOString());return`CLIO security anomaly alert
Incident: ${U(a?.incidentCode,"-")} | ${U(a?.title,"-")}
Severity: ${U(a?.severity,"-")}
Rule: ${d}
Detected At: ${i}
Actor: ${f}
Source IP: ${e}
Request Path: ${g}
Observed Count: ${h>0?h:"-"}
Summary: ${U(a?.summary||b?.summary,"-")}
Action URL: ${U(a?.actionUrl,"/incident-management")}`}({incident:a,detection:b,sourceEvent:c}),k=(f=String(j||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"),`<pre style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap;">${f}</pre>`),[l,m,n]=await Promise.all([ac({recipients:g,subject:i,text:j,html:k}).catch(a=>({provider:$(),status:"failed",reason:U(a?.message,"email_delivery_failed"),recipientCount:g.length})),ae({recipients:h,body:`${i}
${j}`.slice(0,1200)}).catch(a=>({provider:_(),status:"failed",reason:U(a?.message,"sms_delivery_failed"),deliveredCount:0,recipientCount:h.length,failed:[U(a?.message,"sms_delivery_failed")]})),ag({eventType:"clio.security.incident",generatedAt:new Date().toISOString(),incident:a,detection:b,sourceEvent:{id:U(c?.id),module:U(c?.module),activityName:U(c?.activityName),status:U(c?.status),occurredAt:U(c?.occurredAt),sourceIp:U(c?.metadata?.sourceIp||c?.sourceIp),requestPath:U(c?.metadata?.requestPath||c?.requestPath)}})]);return{subject:i,email:l,sms:m,webhooks:n,recipients:g,smsRecipients:h}}let ai=new Map,aj=new Map,ak="system@gmail.com",al=null,am=new Set(["missing_permission","role_not_allowed","ownership_validation_failed","unauthorized","account_not_active","session_role_mismatch","session_version_mismatch"]);function an(){return new Date().toISOString()}function ao(a,b=""){return String(a||"").trim()||b}function ap(a){return a&&"object"==typeof a&&!Array.isArray(a)?a:{}}function aq(a){return ao(a).toLowerCase()}function ar(a){return ao(a).toLowerCase()}function as(a){return ao(a).toLowerCase()||"unknown"}function at(a){let b=new Date(a||"").getTime();return Number.isNaN(b)?null:b}function au(a,b=!1){let c=aq(process.env[a]);return c?"true"===c||"1"===c||"yes"===c:b}function av(a,b,{min:c=1,max:d=Number.MAX_SAFE_INTEGER}={}){let e=Number.parseInt(ao(process.env[a]),10);return Number.isFinite(e)?Math.min(d,Math.max(c,e)):b}function aw(){return(0,c.isFirestoreEnabled)()?(0,c.getFirestoreDb)():null}function ax(){return{enabled:au("CLIO_IDS_ENABLED",!0),authFailureThreshold:av("CLIO_IDS_AUTH_FAILURE_THRESHOLD",5,{min:2,max:30}),authFailureWindowMinutes:av("CLIO_IDS_AUTH_FAILURE_WINDOW_MINUTES",10,{min:1,max:120}),permissionDeniedThreshold:av("CLIO_IDS_PERMISSION_DENIED_THRESHOLD",3,{min:2,max:20}),permissionDeniedWindowMinutes:av("CLIO_IDS_PERMISSION_DENIED_WINDOW_MINUTES",15,{min:1,max:120}),exportSpikeThreshold:av("CLIO_IDS_EXPORT_SPIKE_THRESHOLD",4,{min:2,max:20}),exportSpikeWindowMinutes:av("CLIO_IDS_EXPORT_SPIKE_WINDOW_MINUTES",20,{min:1,max:180}),piiAccessSpikeThreshold:av("CLIO_IDS_PII_ACCESS_SPIKE_THRESHOLD",12,{min:4,max:80}),piiAccessSpikeWindowMinutes:av("CLIO_IDS_PII_ACCESS_SPIKE_WINDOW_MINUTES",15,{min:1,max:180}),incidentCooldownMinutes:av("CLIO_IDS_INCIDENT_COOLDOWN_MINUTES",15,{min:1,max:360}),maxRecipientCount:av("CLIO_IDS_MAX_RECIPIENTS",20,{min:1,max:100}),systemActorEmail:ar(process.env.CLIO_IDS_SYSTEM_ACTOR_EMAIL)||ak,appBaseUrl:ao(process.env.CLIO_APP_BASE_URL,"http://localhost:3000").replace(/\/+$/,""),retryEnabled:au("CLIO_IDS_RETRY_ENABLED",!0),retryBatchSize:av("CLIO_IDS_RETRY_BATCH_SIZE",8,{min:1,max:32}),retryMaxAttempts:av("CLIO_IDS_RETRY_MAX_ATTEMPTS",5,{min:1,max:20}),retryBaseBackoffSeconds:av("CLIO_IDS_RETRY_BASE_BACKOFF_SECONDS",30,{min:5,max:3600}),retryMaxBackoffSeconds:av("CLIO_IDS_RETRY_MAX_BACKOFF_SECONDS",1800,{min:30,max:86400}),retryCollectionName:ao(process.env.CLIO_FIRESTORE_IDS_RETRY_COLLECTION,"clio_ids_retry_queue"),deadLetterCollectionName:ao(process.env.CLIO_FIRESTORE_IDS_DEAD_LETTER_COLLECTION,"clio_ids_dead_letter")}}function ay(a,b,c){var d;let e,f=ao(a);if(!f)return 0;let g=Number.isFinite(b)?b:Date.now(),h=(d=ai.get(f)||[],e=g-c,d.filter(a=>a>=e).slice(-256));return h.push(g),ai.set(f,h),h.length}function az(a,b,c){let d=aq(a);return"critical"===d||b>=2*Math.max(1,Number(c||1))?"Critical":"high"===d?"High":"medium"===d?"Medium":"Low"}function aA(a){return"failed"===a||"rejected"===a}function aB(a,b,c){if(!b.moduleName.includes("authentication")||!aA(b.status))return null;let d=ay(`auth-fail:${b.sourceIp||b.actorEmail||"unknown"}`,b.occurredAtMs,60*c.authFailureWindowMinutes*1e3);return d<c.authFailureThreshold?null:{ruleId:"AUTH_BRUTE_FORCE",incidentType:"Credential Compromise",severity:az("high",d,c.authFailureThreshold),restrictedPiiInvolved:!1,observedCount:d,windowMinutes:c.authFailureWindowMinutes,affectedEmployeeEmail:b.actorEmail,title:"Repeated authentication failures detected",summary:`Detected ${d} failed/rejected authentication events from ${b.sourceIp} within ${c.authFailureWindowMinutes} minute(s).`,tags:["authentication","brute-force","ids"]}}function aC(a,b,c){if(!(aA(b.status)&&(am.has(b.reason)||b.activityName.includes("permission")||b.activityName.includes("ownership")||b.activityName.includes("forbidden"))))return null;let d=ay(`permission-denied:${b.actorEmail||b.sourceIp||"unknown"}`,b.occurredAtMs,60*c.permissionDeniedWindowMinutes*1e3);if(d<c.permissionDeniedThreshold)return null;let e=b.moduleName.includes("employee records")||b.moduleName.includes("performance")||b.moduleName.includes("attendance");return{ruleId:"UNAUTHORIZED_ACCESS_ATTEMPT",incidentType:"Unauthorized Access",severity:az(e?"high":"medium",d,c.permissionDeniedThreshold),restrictedPiiInvolved:e,observedCount:d,windowMinutes:c.permissionDeniedWindowMinutes,affectedEmployeeEmail:b.targetEmployeeEmail||b.actorEmail,title:"Repeated unauthorized access attempts detected",summary:`Detected ${d} permission/ownership denials for actor ${b.actorEmail||"unknown"} within ${c.permissionDeniedWindowMinutes} minute(s).`,tags:["authorization","idor","least-privilege","ids"]}}function aD(a,b,c){if(!(b.moduleName.includes("export")||b.requestPath.includes("/api/hris/exports")||b.activityName.includes("export"))||"approved"!==b.status&&"completed"!==b.status)return null;let d=ay(`export-spike:${b.actorEmail||b.sourceIp||"unknown"}`,b.occurredAtMs,60*c.exportSpikeWindowMinutes*1e3);return d<c.exportSpikeThreshold?null:{ruleId:"MASS_EXPORT_ACTIVITY",incidentType:"Data Exposure",severity:az("high",d,c.exportSpikeThreshold),restrictedPiiInvolved:!0,observedCount:d,windowMinutes:c.exportSpikeWindowMinutes,affectedEmployeeEmail:b.targetEmployeeEmail||"",title:"Mass export activity detected",summary:`Detected ${d} export-related actions by ${b.actorEmail||b.sourceIp} within ${c.exportSpikeWindowMinutes} minute(s).`,tags:["export","dlp","ids"]}}function aE(a,b,c){if(!("sensitive"===b.sensitivity&&b.moduleName.includes("employee records")&&(b.activityName.includes("view")||b.activityName.includes("list"))&&("completed"===b.status||"approved"===b.status)))return null;let d=ay(`pii-read:${b.actorEmail||b.sourceIp||"unknown"}`,b.occurredAtMs,60*c.piiAccessSpikeWindowMinutes*1e3);return d<c.piiAccessSpikeThreshold?null:{ruleId:"PII_ACCESS_VOLUME_SPIKE",incidentType:"Policy Violation",severity:az("medium",d,c.piiAccessSpikeThreshold),restrictedPiiInvolved:!0,observedCount:d,windowMinutes:c.piiAccessSpikeWindowMinutes,affectedEmployeeEmail:b.targetEmployeeEmail||"",title:"Sensitive PII access spike detected",summary:`Detected ${d} sensitive employee-record read actions in ${c.piiAccessSpikeWindowMinutes} minute(s).`,tags:["pii","privacy","monitoring","ids"]}}function aF(a){return ao(a).split(",").map(a=>ar(a)).filter(Boolean)}function aG(a,b){let c=ar(process.env.CLIO_GRC_ALERT_EMAIL)||aF(process.env.GRC_EMAILS)[0]||aF(process.env.SUPER_ADMIN_EMAILS)[0];return c||ar(b?.affectedEmployeeEmail||a?.metadata?.ownerEmail||a?.performedBy||ak)}async function aH(a,b,c,d){let e=aG(a,b)||ar(c?.ownerEmail);return(function(a=[]){return aa(a)})(await T({ownerEmail:e,affectedEmployeeEmail:ar(b?.affectedEmployeeEmail),actorEmail:ar(a?.performedBy),includeAffectedEmployee:!0,includeActor:!0})).slice(0,d.maxRecipientCount)}function aI(a,b){let c=Math.max(1,Number(a||1)),d=Math.max(5,Number(b?.retryBaseBackoffSeconds||30));return Math.min(Math.max(d,Number(b?.retryMaxBackoffSeconds||1800)),d*Math.pow(2,Math.max(0,c-1)))}async function aJ({entry:a,detection:c,fingerprint:d,errorMessage:e,config:f,attempts:g=1,source:h="live"}){if(!f?.retryEnabled)return{queued:!1,reason:"retry_disabled"};let i=aw();if(!i)return{queued:!1,reason:"retry_queue_unavailable"};let j=function({entry:a,detection:b,fingerprint:c,errorMessage:d,config:e,attempts:f=1,source:g="live",queuedAtIso:h=an()}){let i=Math.max(1,Number(f||1)),j=aI(i,e),k=new Date(Date.now()+1e3*j).toISOString();return{status:"pending",source:ao(g,"live"),attempts:i,maxAttempts:Math.max(1,Number(e?.retryMaxAttempts||5)),nextAttemptAt:k,lastError:ao(d,"ids_processing_failed"),fingerprint:ao(c),entry:ap(a),detection:ap(b),createdAt:h,updatedAt:h}}({entry:a,detection:c,fingerprint:d,errorMessage:e,config:f,attempts:g,source:h,queuedAtIso:an()});return{queued:!0,retryRecordId:(await (0,b.addDoc)((0,b.collection)(i,f.retryCollectionName),j)).id,attempts:j.attempts,nextAttemptAt:j.nextAttemptAt}}async function aK(a,{batchSize:c}={}){let d=aw();if(!d)return[];let e=Math.max(1,Number(c||a?.retryBatchSize||8)),f=Math.max(3*e,16),g=await (0,b.getDocs)((0,b.query)((0,b.collection)(d,a.retryCollectionName),(0,b.orderBy)("nextAttemptAt","asc"),(0,b.limit)(f))),h=Date.now();return g.docs.map(a=>({id:a.id,...a.data()||{}})).filter(a=>"pending"===aq(a?.status||"pending")).filter(a=>{let b=at(a?.nextAttemptAt);return!Number.isFinite(b)||b<=h}).slice(0,e)}async function aL(a,c,d){let e=aw();if(!e)return null;let f={...c,status:"dead-letter",deadLetteredAt:an(),deadLetterReason:ao(d,"ids_retry_exhausted"),originalRetryRecordId:ao(c?.id)};return(await (0,b.addDoc)((0,b.collection)(e,a.deadLetterCollectionName),f)).id}async function aM(a,c,d){let e=aw();e&&await (0,b.updateDoc)((0,b.doc)(e,a.retryCollectionName,c),{...d,updatedAt:an()})}async function aN(a,c){let d=aw();d&&await (0,b.deleteDoc)((0,b.doc)(d,a.retryCollectionName,c))}async function aO(a,b,c){var d;if(function(a,b){let c=Number.isFinite(b)?b:Date.now();for(let[a,b]of aj.entries())(!Number.isFinite(b)||b<=c)&&aj.delete(a);let d=aj.get(a);return Number.isFinite(d)&&d>b}(a,b))return!0;let e=[];try{e=await H()}catch{e=[]}let f=60*c.incidentCooldownMinutes*1e3;return(Array.isArray(d=e)?d:[]).some(c=>{let d=ao(c?.detectionFingerprint);if(!d||d!==a)return!1;let e=aq(c?.status);if("resolved"===e||"closed"===e)return!1;let g=at(c?.detectedAt||c?.createdAt);return!Number.isFinite(g)||g>=b-f})}async function aP(a,b,c,d,e){let f,g=ao(a?.occurredAt,an()),h=aG(a,b),i=c.systemActorEmail||ak,j=ap(a?.metadata),k={title:b.title,summary:b.summary,incidentType:b.incidentType,severity:b.severity,status:"Open",restrictedPiiInvolved:!!b.restrictedPiiInvolved,affectedEmployeeEmail:ar(b.affectedEmployeeEmail||j.targetEmployeeEmail||""),ownerEmail:h,detectedAt:g,escalationRequired:!0,containmentStatus:"Not Started",impactAssessmentStatus:"Pending",regulatoryNotificationRequired:!!b.restrictedPiiInvolved,documentationRetained:!0,classificationStandard:"CLIO-IDS-V1",notes:`Auto-generated by CLIO IDS rule: ${b.ruleId}
Observed count: ${Number(b.observedCount||0)}
Window: ${Number(b.windowMinutes||0)} minute(s)
Source event: ${ao(a?.id,"N/A")} | ${ao(a?.module,"System")} | ${ao(a?.activityName,"Activity")}
Source IP: ${ao(j.sourceIp||a?.sourceIp,"unknown")}
Request: ${ao(j.requestMethod||a?.requestMethod,"GET")} ${ao(j.requestPath||a?.requestPath,"unknown")}`,autoGenerated:!0,detectionRuleId:b.ruleId,detectionFingerprint:d,detectionWindowStart:new Date(e-60*b.windowMinutes*1e3).toISOString(),detectionWindowEnd:new Date(e).toISOString(),sourceSystem:"CLIO_IDS",sourceEventId:ao(a?.id),sourceEventModule:ao(a?.module),sourceEventPath:ao(j.requestPath||a?.requestPath),sourceIp:ao(j.sourceIp||a?.sourceIp),alertRecipients:[],actionUrl:"/incident-management"},l=await J(k,i);return f=60*Math.max(1,Number(c.incidentCooldownMinutes||1))*1e3,aj.set(d,e+f),l}async function aQ({incident:a,detection:b,recipients:c,actionUrl:d,actorEmail:e}){let f=c.map(c=>{let f,g,h;return{recipientEmail:c,title:ao(a?.title||b?.title,"Security anomaly detected"),message:(f=ao(a?.severity||b?.severity,"Medium"),g=ao(a?.incidentCode,"INCIDENT"),h=ao(a?.summary||b?.summary,"Review incident workbench for containment."),`[${f}] ${g}: ${h}`),severity:aq(a?.severity||b?.severity||"medium"),type:"security-anomaly",module:"Incident Management",actionUrl:d,status:"unread",createdBy:e,metadata:{incidentId:ao(a?.id||a?.recordId),incidentCode:ao(a?.incidentCode),detectionRuleId:ao(b?.ruleId),autoGenerated:!0}}});return await S(f)}async function aR({entry:a,detection:b,config:c,fingerprint:d,nowMs:e}){var f;let g,h;if(await aO(d,e,c))return{detected:!0,duplicate:!0,detection:b,fingerprint:d};let i=await aP(a,b,c,d,e),j=(f=i?.id||i?.recordId)?`/incident-management?incident=${encodeURIComponent(f)}`:"/incident-management",k=(g=ao(c?.appBaseUrl,"http://localhost:3000").replace(/\/+$/,""),(h=ao(j,"/incident-management")).startsWith("http://")||h.startsWith("https://")?h:`${g}${h.startsWith("/")?h:`/${h}`}`),l=await aH(a,b,i,c),m=await aQ({incident:i,detection:b,recipients:l,actionUrl:j,actorEmail:c.systemActorEmail}),n=await ah({incident:{...i,actionUrl:k},detection:b,sourceEvent:a,emailRecipients:l}),o={alertRecipients:l,alertDispatchSummary:n,externalIntegrations:{webhooks:n?.webhooks||{}},lastAlertDispatchAt:an()};return await K(i.id,o,c.systemActorEmail).catch(()=>null),{detected:!0,duplicate:!1,detection:b,incidentRecord:i,fingerprint:d,recipients:l,inAppNotificationCount:m.length,deliverySummary:n}}async function aS(a,b){let c=ao(b?.id);if(!c)return{processed:!1,reason:"missing_retry_record_id"};let d=Math.max(1,Number(b?.attempts||1)),e=Math.max(1,Number(b?.maxAttempts||a.retryMaxAttempts||5)),f=ap(b?.entry),g=ap(b?.detection),h=ao(b?.fingerprint);if(!h||!ao(g?.ruleId)||!ao(f?.activityName)&&!ao(f?.module))return await aL(a,b,"invalid_retry_payload"),await aN(a,c),{processed:!1,deadLettered:!0,reason:"invalid_retry_payload"};let i=await aU(f,{forcedDetection:g,forcedFingerprint:h,skipQueueOnError:!0,disableQueueDrain:!0});if(!i?.failed)return await aN(a,c),{processed:!0,duplicate:!!i?.duplicate,detected:!!i?.detected};let j=d+1,k=ao(i?.error,"ids_processing_failed");if(j>e)return await aL(a,{...b,attempts:j,maxAttempts:e,lastError:k},k),await aN(a,c),{processed:!1,deadLettered:!0,reason:k};let l=new Date(Date.now()+1e3*aI(j,a)).toISOString();return await aM(a,c,{attempts:j,maxAttempts:e,nextAttemptAt:l,lastError:k,status:"pending"}),{processed:!1,retried:!0,reason:k,nextAttemptAt:l}}async function aT({reason:a="manual",batchSize:b}={}){let c=ax();if(!c.enabled||!c.retryEnabled)return{processedCount:0,reason:c.enabled?"retry_disabled":"ids_disabled"};if(al)return al;al=(async()=>{let d=await aK(c,{batchSize:Number(b||c.retryBatchSize||8)}),e=0,f=0,g=0;for(let a of d)try{let b=await aS(c,a);b?.processed&&(e+=1),b?.deadLettered&&(f+=1)}catch{g+=1}return{reason:ao(a,"manual"),processedCount:e,deadLetterCount:f,failedCount:g,dueCount:d.length}})();try{return await al}finally{al=null}}async function aU(a,b={}){var c,d,e;let f,g,h,i,j,k,l=ax();if(!l.enabled)return{detected:!1,reason:"ids_disabled"};if(!a||"object"!=typeof a)return{detected:!1,reason:"invalid_audit_entry"};!b?.disableQueueDrain&&l.retryEnabled&&aT({reason:"audit-event"}).catch(()=>null);let m=(c=b?.forcedDetection)&&"object"==typeof c&&!Array.isArray(c)?b.forcedDetection:null;if(!m&&function(a){let b=ap(a?.metadata);if(!0===b.skipAnomalyDetection||!0===b.autoGenerated)return!0;let c=aq(a?.module),d=aq(b.requestPath||a?.requestPath);return!!(c.includes("incident management")||d.startsWith("/api/notifications"))}(a))return{detected:!1,reason:"event_skipped"};let n=(f=ap(a?.metadata),{actorEmail:ar(a?.performedBy),status:aq(a?.status),moduleName:aq(a?.module),activityName:aq(a?.activityName),reason:aq(f.reason),requestPath:aq(f.requestPath||a?.requestPath),requestMethod:aq(f.requestMethod||a?.requestMethod),sourceIp:as(f.sourceIp||a?.sourceIp),sensitivity:aq(a?.sensitivity),targetEmployeeEmail:ar(f.targetEmployeeEmail||f.employeeEmail||f.affectedEmployeeEmail),ownerEmail:ar(f.ownerEmail),occurredAtMs:at(a?.occurredAt)||Date.now()}),o=m||function(a,b,c){for(let d of[aB,aC,aD,aE]){let e=d(a,b,c);if(e)return e}return null}(a,n,l);if(!o)return{detected:!1,reason:"no_rule_match"};let p=n.occurredAtMs||Date.now(),q=ao(b?.forcedFingerprint)||(d=o.ruleId,e=o.windowMinutes||l.incidentCooldownMinutes,g=ar(a?.performedBy),h=as(a?.metadata?.sourceIp||a?.sourceIp),i=aq(a?.module||""),j=ar(o?.affectedEmployeeEmail||a?.metadata?.employeeEmail||""),k=Math.floor(p/(60*Math.max(1,Number(e||1))*1e3)),[ao(d),g||"unknown",h,i||"module",j||"none",k].join("|"));try{return await aR({entry:a,detection:o,config:l,fingerprint:q,nowMs:p})}catch(e){let c=e instanceof Error?ao(e.message,"ids_processing_failed"):"ids_processing_failed";if(b?.skipQueueOnError)return{detected:!0,duplicate:!1,failed:!0,detection:o,fingerprint:q,reason:"processing_failed",error:c};let d=await aJ({entry:a,detection:o,fingerprint:q,errorMessage:c,config:l,attempts:1,source:"live"});return{detected:!0,duplicate:!1,failed:!0,queuedForRetry:!!d?.queued,retryRecordId:ao(d?.retryRecordId),detection:o,fingerprint:q,reason:"processing_failed",error:c}}}a.s(["drainSecurityDetectionRetryQueue",()=>aT,"processAuditEventForSecurityDetections",()=>aU],36725)}];

//# sourceMappingURL=src_lib_security-detection_fc1cf3d7.js.map