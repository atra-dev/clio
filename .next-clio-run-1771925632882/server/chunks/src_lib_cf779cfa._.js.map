{"version":3,"sources":["../../../src/lib/actor-directory.js"],"sourcesContent":["import { listUserAccounts } from \"@/lib/user-accounts\";\nimport { formatPersonName, formatNameFromEmail } from \"@/lib/name-utils\";\n\nconst ACTOR_DIRECTORY_CACHE_TTL_MS = 30 * 1000;\nlet cachedUserAccounts = [];\nlet cachedUserAccountsAt = 0;\n\nfunction normalizeActorEmail(value) {\n  const normalized = String(value || \"\").trim().toLowerCase();\n  if (!normalized || !normalized.includes(\"@\")) {\n    return \"\";\n  }\n  return normalized;\n}\n\nfunction buildAccountDisplayName(account, fallbackEmail) {\n  return formatPersonName({\n    firstName: account?.firstName,\n    middleName: account?.middleName,\n    lastName: account?.lastName,\n    fallbackEmail,\n    fallbackLabel: \"User\",\n  });\n}\n\nasync function getCachedUserAccounts() {\n  const now = Date.now();\n  if (now - cachedUserAccountsAt < ACTOR_DIRECTORY_CACHE_TTL_MS && Array.isArray(cachedUserAccounts)) {\n    return cachedUserAccounts;\n  }\n\n  const users = await listUserAccounts();\n  cachedUserAccounts = Array.isArray(users) ? users : [];\n  cachedUserAccountsAt = now;\n  return cachedUserAccounts;\n}\n\nexport function collectActorEmailSet(values = []) {\n  const set = new Set();\n\n  values.forEach((value) => {\n    const normalizedEmail = normalizeActorEmail(value);\n    if (normalizedEmail) {\n      set.add(normalizedEmail);\n    }\n  });\n\n  return set;\n}\n\nexport async function createActorDirectory(values = []) {\n  const emailSet = collectActorEmailSet(values);\n  const includeAll = emailSet.size === 0;\n  const directory = new Map();\n\n  try {\n    const users = await getCachedUserAccounts();\n\n    users.forEach((user) => {\n      const email = normalizeActorEmail(user?.email);\n      if (!email) {\n        return;\n      }\n      if (!includeAll && !emailSet.has(email)) {\n        return;\n      }\n\n      directory.set(email, {\n        email,\n        name: buildAccountDisplayName(user, email),\n        avatarUrl: typeof user?.profilePhotoDataUrl === \"string\" ? user.profilePhotoDataUrl : null,\n      });\n    });\n  } catch {\n    // Fallback to deterministic email-derived names if account lookup fails.\n  }\n\n  emailSet.forEach((email) => {\n    if (!directory.has(email)) {\n      directory.set(email, {\n        email,\n        name: formatNameFromEmail(email),\n        avatarUrl: null,\n      });\n    }\n  });\n\n  return directory;\n}\n\nexport function resolveActor(directory, actorValue) {\n  const email = normalizeActorEmail(actorValue);\n  if (email && directory instanceof Map) {\n    const actor = directory.get(email);\n    if (actor) {\n      return actor;\n    }\n  }\n\n  if (email) {\n    return {\n      email,\n      name: formatNameFromEmail(email),\n      avatarUrl: null,\n    };\n  }\n\n  const raw = String(actorValue || \"\").trim();\n  if (!raw) {\n    return {\n      email: \"\",\n      name: \"System\",\n      avatarUrl: null,\n    };\n  }\n\n  return {\n    email: raw,\n    name: raw,\n    avatarUrl: null,\n  };\n}\n\nexport function enrichTrailActors(events, directory, { actorKey = \"by\" } = {}) {\n  if (!Array.isArray(events)) {\n    return [];\n  }\n\n  return events.map((event) => {\n    const actor = resolveActor(directory, event?.[actorKey]);\n    return {\n      ...event,\n      [`${actorKey}Name`]: actor.name,\n      [`${actorKey}Email`]: actor.email || String(event?.[actorKey] || \"\"),\n      [`${actorKey}Avatar`]: actor.avatarUrl,\n    };\n  });\n}\n\nexport function collectEmailsFromTrail(events, actorKey = \"by\") {\n  if (!Array.isArray(events)) {\n    return [];\n  }\n\n  return events.map((event) => event?.[actorKey]).filter(Boolean);\n}\n\nexport function collectEmployeeActorValues(record) {\n  if (!record || typeof record !== \"object\") {\n    return [];\n  }\n\n  const values = [record.createdBy, record.updatedBy];\n  if (Array.isArray(record.activityHistory)) {\n    record.activityHistory.forEach((item) => {\n      values.push(item?.by);\n    });\n  }\n  if (Array.isArray(record.documents)) {\n    record.documents.forEach((item) => {\n      values.push(item?.uploadedBy);\n    });\n  }\n\n  return values.filter(Boolean);\n}\n\nexport function enrichEmployeeRecordActors(record, directory) {\n  if (!record || typeof record !== \"object\") {\n    return record;\n  }\n\n  const createdActor = resolveActor(directory, record.createdBy);\n  const updatedActor = resolveActor(directory, record.updatedBy);\n\n  const activityHistory = Array.isArray(record.activityHistory)\n    ? record.activityHistory.map((item) => {\n        const actor = resolveActor(directory, item?.by);\n        return {\n          ...item,\n          byName: actor.name,\n          byEmail: actor.email || String(item?.by || \"\"),\n          byAvatar: actor.avatarUrl,\n        };\n      })\n    : [];\n\n  const documents = Array.isArray(record.documents)\n    ? record.documents.map((item) => {\n        const actor = resolveActor(directory, item?.uploadedBy);\n        return {\n          ...item,\n          uploadedByName: actor.name,\n          uploadedByEmail: actor.email || String(item?.uploadedBy || \"\"),\n          uploadedByAvatar: actor.avatarUrl,\n        };\n      })\n    : [];\n\n  return {\n    ...record,\n    createdByName: createdActor.name,\n    createdByEmail: createdActor.email || String(record.createdBy || \"\"),\n    createdByAvatar: createdActor.avatarUrl,\n    updatedByName: updatedActor.name,\n    updatedByEmail: updatedActor.email || String(record.updatedBy || \"\"),\n    updatedByAvatar: updatedActor.avatarUrl,\n    activityHistory,\n    documents,\n  };\n}\n\nexport function collectTemplateActorValues(record) {\n  if (!record || typeof record !== \"object\") {\n    return [];\n  }\n\n  const values = [record.createdBy, record.updatedBy];\n\n  if (Array.isArray(record.versionHistory)) {\n    record.versionHistory.forEach((item) => {\n      values.push(item?.changedBy);\n    });\n  }\n  if (Array.isArray(record.modificationLog)) {\n    record.modificationLog.forEach((item) => {\n      values.push(item?.by);\n    });\n  }\n  if (Array.isArray(record.usageLogs)) {\n    record.usageLogs.forEach((item) => {\n      values.push(item?.by, item?.uploadedBy, item?.performedBy);\n    });\n  }\n\n  return values.filter(Boolean);\n}\n\nexport function enrichTemplateRecordActors(record, directory) {\n  if (!record || typeof record !== \"object\") {\n    return record;\n  }\n\n  const createdActor = resolveActor(directory, record.createdBy);\n  const updatedActor = resolveActor(directory, record.updatedBy);\n\n  const versionHistory = Array.isArray(record.versionHistory)\n    ? record.versionHistory.map((item) => {\n        const actor = resolveActor(directory, item?.changedBy);\n        return {\n          ...item,\n          changedByName: actor.name,\n          changedByEmail: actor.email || String(item?.changedBy || \"\"),\n          changedByAvatar: actor.avatarUrl,\n        };\n      })\n    : [];\n\n  const modificationLog = Array.isArray(record.modificationLog)\n    ? record.modificationLog.map((item) => {\n        const actor = resolveActor(directory, item?.by);\n        return {\n          ...item,\n          byName: actor.name,\n          byEmail: actor.email || String(item?.by || \"\"),\n          byAvatar: actor.avatarUrl,\n        };\n      })\n    : [];\n\n  return {\n    ...record,\n    createdByName: createdActor.name,\n    createdByEmail: createdActor.email || String(record.createdBy || \"\"),\n    createdByAvatar: createdActor.avatarUrl,\n    updatedByName: updatedActor.name,\n    updatedByEmail: updatedActor.email || String(record.updatedBy || \"\"),\n    updatedByAvatar: updatedActor.avatarUrl,\n    versionHistory,\n    modificationLog,\n  };\n}\n"],"names":[],"mappings":"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"}