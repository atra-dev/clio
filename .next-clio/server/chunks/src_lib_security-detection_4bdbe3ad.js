module.exports=[74405,e=>{"use strict";var t=e.i(45787);e.i(18097);var i=e.i(19e3),r=e.i(67658),n=e.i(33355);function a(e,t=""){return String(e||"").trim()||t}function o(e){return Array.isArray(e)?e:[]}function s(e){return a(e).toLowerCase()}function d(e){return String(e||"").replace(/[^\d+]/g,"").trim()}function u(e){return a(e).split(",").map(e=>e.trim()).filter(Boolean)}function c(e=[]){return Array.from(new Set(e.filter(Boolean)))}function l(){let e,t=(e=a(process.env.CLIO_ALERT_EMAIL_PROVIDER).toLowerCase())?e.includes("resend")?"resend":e.includes("firebase")?"firebase":e.includes("console")||"dev"===e?"console":"none"===e||"off"===e?"none":e:"";return t||(a(process.env.RESEND_API_KEY).startsWith("re_")&&a(process.env.CLIO_EMAIL_FROM)?"resend":"console")}function m(){let e,t=(e=a(process.env.CLIO_ALERT_SMS_PROVIDER).toLowerCase())?e.includes("twilio")?"twilio":e.includes("console")||"dev"===e?"console":"none"===e||"off"===e?"none":e:"";return t||"none"}function p(e=[]){return c([...u(process.env.CLIO_SECURITY_ALERT_RECIPIENTS),...u(process.env.GRC_EMAILS),...u(process.env.SUPER_ADMIN_EMAILS),...o(e)].map(e=>s(e)).filter(Boolean))}async function _({recipients:e,subject:t,text:i,html:r}){let n=a(process.env.RESEND_API_KEY),o=a(process.env.CLIO_EMAIL_FROM);if(!n||!o||!n.startsWith("re_"))throw Error("email_provider_not_configured");let s=await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({from:o,to:e,subject:t,text:i,html:r})}),d=await s.json().catch(()=>({}));if(!s.ok){let e=a(d?.message)||a(d?.error?.message)||"email_delivery_failed";throw Error(`email_delivery_failed:${e}`)}return{provider:"resend",status:"sent",messageId:a(d?.id,`resend-${Date.now()}`),recipientCount:e.length}}async function f({recipients:e,subject:t,text:i,html:r}){let n=c(o(e).map(s).filter(Boolean));if(0===n.length)return{provider:"none",status:"skipped",reason:"no_recipients",recipientCount:0};let d=l();return"none"===d?{provider:d,status:"skipped",reason:"provider_disabled",recipientCount:0}:"firebase"===d?{provider:d,status:"skipped",reason:"firebase_not_supported_for_custom_alert_email",recipientCount:0}:"console"===d?function({recipients:e,subject:t,text:i}){return function(e,t=!1){let i=a(process.env[e]).toLowerCase();return i?"true"===i||"1"===i||"yes"===i:t}("CLIO_ALLOW_CONSOLE_EMAIL",!0)&&console.info("[CLIO:SecurityAlert:Email]",{recipients:e,subject:t,text:i}),{provider:"console",status:"simulated",recipientCount:e.length}}({recipients:n,subject:t,text:i}):"resend"===d?await _({recipients:n,subject:t,text:i,html:r}):{provider:d,status:"skipped",reason:"unsupported_provider",recipientCount:0}}async function I({recipients:e,body:t}){let i=a(process.env.TWILIO_ACCOUNT_SID),r=a(process.env.TWILIO_AUTH_TOKEN),n=a(process.env.TWILIO_FROM_NUMBER);if(!i||!r||!n)throw Error("twilio_not_configured");let o=Buffer.from(`${i}:${r}`,"utf8").toString("base64"),s=e.map(async e=>{let r=new URLSearchParams;r.set("To",e),r.set("From",n),r.set("Body",t);let s=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${encodeURIComponent(i)}/Messages.json`,{method:"POST",headers:{Authorization:`Basic ${o}`,"Content-Type":"application/x-www-form-urlencoded"},body:r.toString()}),d=await s.json().catch(()=>({}));if(!s.ok){let e=a(d?.message,"sms_delivery_failed");throw Error(`twilio_delivery_failed:${e}`)}return{to:e,sid:a(d?.sid)}}),d=await Promise.allSettled(s),u=d.filter(e=>"fulfilled"===e.status).map(e=>e.value),c=d.filter(e=>"rejected"===e.status).map(e=>a(e.reason?.message||"sms_delivery_failed"));return{provider:"twilio",status:c.length>0?u.length>0?"partial":"failed":"sent",deliveredCount:u.length,recipientCount:e.length,delivered:u,failed:c}}async function y({recipients:e,body:t}){let i=c(o(e).map(d).filter(Boolean));if(0===i.length)return{provider:"none",status:"skipped",reason:"no_recipients",deliveredCount:0,recipientCount:0,failed:[]};let r=m();return"none"===r?{provider:r,status:"skipped",reason:"provider_disabled",deliveredCount:0,recipientCount:i.length,failed:[]}:"console"===r?function({recipients:e,body:t}){return{provider:"console",status:"simulated",deliveredCount:e.length,recipientCount:e.length,delivered:e.map(e=>({to:e,sid:`console-${Date.now()}`})),failed:[]}}({recipients:i,body:t}):"twilio"===r?await I({recipients:i,body:t}):{provider:r,status:"skipped",reason:"unsupported_provider",deliveredCount:0,recipientCount:i.length,failed:[]}}async function E({url:e,label:t,token:i,payload:r,timeoutMs:n}){let o=new AbortController,s=setTimeout(()=>o.abort(),n);try{let n={"Content-Type":"application/json","X-CLIO-Source":"security-detection","X-CLIO-Target":t};i&&(n.Authorization=`Bearer ${i}`);let s=await fetch(e,{method:"POST",headers:n,body:JSON.stringify(r),signal:o.signal}),d=await s.text().catch(()=>"");return{label:t,url:e,ok:s.ok,status:s.status,body:a(d)}}catch(i){return{label:t,url:e,ok:!1,status:0,body:a(i?.message,"webhook_delivery_failed")}}finally{clearTimeout(s)}}async function h(e){let t,i,r,n,o=(t=u(process.env.CLIO_SECURITY_WEBHOOK_URLS).map(e=>({label:"security-webhook",url:e,token:a(process.env.CLIO_SECURITY_WEBHOOK_TOKEN)})),i=a(process.env.CLIO_SIEM_WEBHOOK_URL),r=a(process.env.CLIO_EDR_WEBHOOK_URL),n=[...t],i&&n.push({label:"siem",url:i,token:a(process.env.CLIO_SIEM_WEBHOOK_TOKEN)}),r&&n.push({label:"edr",url:r,token:a(process.env.CLIO_EDR_WEBHOOK_TOKEN)}),n.filter(e=>a(e.url)));if(0===o.length)return{status:"skipped",targets:[],successCount:0};let s=Number.parseInt(a(process.env.CLIO_SECURITY_WEBHOOK_TIMEOUT_MS,"5000"),10)||5e3,d=await Promise.all(o.map(t=>E({...t,payload:e,timeoutMs:Math.max(1e3,Math.min(2e4,s))}))),c=d.filter(e=>e.ok).length;return{status:c===d.length?"sent":c>0?"partial":"failed",targets:d,successCount:c}}async function S({incident:e,detection:t,sourceEvent:i,emailRecipients:r=[],smsRecipients:n=[]}={}){let s,_=p(r),I=function(e=[]){return c([...u(process.env.CLIO_SMS_ALERT_RECIPIENTS),...o(e)].map(e=>d(e)).filter(Boolean))}(n),E=function({incident:e,detection:t}){let i=a(e?.severity||t?.severity||"Medium").toUpperCase(),r=a(e?.incidentCode,"INCIDENT"),n=a(e?.title,"Security anomaly detected");return`[CLIO][${i}] ${r} - ${n}`}({incident:e,detection:t}),v=function({incident:e,detection:t,sourceEvent:i}){let r=a(t?.ruleId,"N/A"),n=a(i?.metadata?.sourceIp||i?.sourceIp,"unknown"),o=a(i?.performedBy,"unknown"),s=a(i?.metadata?.requestPath||i?.requestPath,"unknown"),d=Number(t?.observedCount||0),u=a(e?.detectedAt||i?.occurredAt,new Date().toISOString());return`CLIO security anomaly alert
Incident: ${a(e?.incidentCode,"-")} | ${a(e?.title,"-")}
Severity: ${a(e?.severity,"-")}
Rule: ${r}
Detected At: ${u}
Actor: ${o}
Source IP: ${n}
Request Path: ${s}
Observed Count: ${d>0?d:"-"}
Summary: ${a(e?.summary||t?.summary,"-")}
Action URL: ${a(e?.actionUrl,"/incident-management")}`}({incident:e,detection:t,sourceEvent:i}),w=(s=String(v||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"),`<pre style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap;">${s}</pre>`),[C,A,O]=await Promise.all([f({recipients:_,subject:E,text:v,html:w}).catch(e=>({provider:l(),status:"failed",reason:a(e?.message,"email_delivery_failed"),recipientCount:_.length})),y({recipients:I,body:`${E}
${v}`.slice(0,1200)}).catch(e=>({provider:m(),status:"failed",reason:a(e?.message,"sms_delivery_failed"),deliveredCount:0,recipientCount:I.length,failed:[a(e?.message,"sms_delivery_failed")]})),h({eventType:"clio.security.incident",generatedAt:new Date().toISOString(),incident:e,detection:t,sourceEvent:{id:a(i?.id),module:a(i?.module),activityName:a(i?.activityName),status:a(i?.status),occurredAt:a(i?.occurredAt),sourceIp:a(i?.metadata?.sourceIp||i?.sourceIp),requestPath:a(i?.metadata?.requestPath||i?.requestPath)}})]);return{subject:E,email:C,sms:A,webhooks:O,recipients:_,smsRecipients:I}}let v=new Map,w=new Map,C="system@gmail.com",A=null,O=new Set(["missing_permission","role_not_allowed","ownership_validation_failed","unauthorized","account_not_active","session_role_mismatch","session_version_mismatch"]);function M(){return new Date().toISOString()}function g(e,t=""){return String(e||"").trim()||t}function N(e){return e&&"object"==typeof e&&!Array.isArray(e)?e:{}}function R(e){return g(e).toLowerCase()}function D(e){return g(e).toLowerCase()}function L(e){return g(e).toLowerCase()||"unknown"}function T(e){let t=new Date(e||"").getTime();return Number.isNaN(t)?null:t}function b(e,t=!1){let i=R(process.env[e]);return i?"true"===i||"1"===i||"yes"===i:t}function k(e,t,{min:i=1,max:r=Number.MAX_SAFE_INTEGER}={}){let n=Number.parseInt(g(process.env[e]),10);return Number.isFinite(n)?Math.min(r,Math.max(i,n)):t}function x(){return(0,r.isFirestoreEnabled)()?(0,r.getFirestoreDb)():null}function P(){return{enabled:b("CLIO_IDS_ENABLED",!0),authFailureThreshold:k("CLIO_IDS_AUTH_FAILURE_THRESHOLD",5,{min:2,max:30}),authFailureWindowMinutes:k("CLIO_IDS_AUTH_FAILURE_WINDOW_MINUTES",10,{min:1,max:120}),permissionDeniedThreshold:k("CLIO_IDS_PERMISSION_DENIED_THRESHOLD",3,{min:2,max:20}),permissionDeniedWindowMinutes:k("CLIO_IDS_PERMISSION_DENIED_WINDOW_MINUTES",15,{min:1,max:120}),exportSpikeThreshold:k("CLIO_IDS_EXPORT_SPIKE_THRESHOLD",4,{min:2,max:20}),exportSpikeWindowMinutes:k("CLIO_IDS_EXPORT_SPIKE_WINDOW_MINUTES",20,{min:1,max:180}),piiAccessSpikeThreshold:k("CLIO_IDS_PII_ACCESS_SPIKE_THRESHOLD",12,{min:4,max:80}),piiAccessSpikeWindowMinutes:k("CLIO_IDS_PII_ACCESS_SPIKE_WINDOW_MINUTES",15,{min:1,max:180}),incidentCooldownMinutes:k("CLIO_IDS_INCIDENT_COOLDOWN_MINUTES",15,{min:1,max:360}),maxRecipientCount:k("CLIO_IDS_MAX_RECIPIENTS",20,{min:1,max:100}),systemActorEmail:D(process.env.CLIO_IDS_SYSTEM_ACTOR_EMAIL)||C,appBaseUrl:g(process.env.CLIO_APP_BASE_URL,"http://localhost:3000").replace(/\/+$/,""),retryEnabled:b("CLIO_IDS_RETRY_ENABLED",!0),retryBatchSize:k("CLIO_IDS_RETRY_BATCH_SIZE",8,{min:1,max:32}),retryMaxAttempts:k("CLIO_IDS_RETRY_MAX_ATTEMPTS",5,{min:1,max:20}),retryBaseBackoffSeconds:k("CLIO_IDS_RETRY_BASE_BACKOFF_SECONDS",30,{min:5,max:3600}),retryMaxBackoffSeconds:k("CLIO_IDS_RETRY_MAX_BACKOFF_SECONDS",1800,{min:30,max:86400}),retryCollectionName:g(process.env.CLIO_FIRESTORE_IDS_RETRY_COLLECTION,"clio_ids_retry_queue"),deadLetterCollectionName:g(process.env.CLIO_FIRESTORE_IDS_DEAD_LETTER_COLLECTION,"clio_ids_dead_letter")}}function $(e,t,i){var r;let n,a=g(e);if(!a)return 0;let o=Number.isFinite(t)?t:Date.now(),s=(r=v.get(a)||[],n=o-i,r.filter(e=>e>=n).slice(-256));return s.push(o),v.set(a,s),s.length}function B(e,t,i){let r=R(e);return"critical"===r||t>=2*Math.max(1,Number(i||1))?"Critical":"high"===r?"High":"medium"===r?"Medium":"Low"}function W(e){return"failed"===e||"rejected"===e}function U(e,t,i){if(!t.moduleName.includes("authentication")||!W(t.status))return null;let r=$(`auth-fail:${t.sourceIp||t.actorEmail||"unknown"}`,t.occurredAtMs,60*i.authFailureWindowMinutes*1e3);return r<i.authFailureThreshold?null:{ruleId:"AUTH_BRUTE_FORCE",incidentType:"Credential Compromise",severity:B("high",r,i.authFailureThreshold),restrictedPiiInvolved:!1,observedCount:r,windowMinutes:i.authFailureWindowMinutes,affectedEmployeeEmail:t.actorEmail,title:"Repeated authentication failures detected",summary:`Detected ${r} failed/rejected authentication events from ${t.sourceIp} within ${i.authFailureWindowMinutes} minute(s).`,tags:["authentication","brute-force","ids"]}}function F(e,t,i){if(!(W(t.status)&&(O.has(t.reason)||t.activityName.includes("permission")||t.activityName.includes("ownership")||t.activityName.includes("forbidden"))))return null;let r=$(`permission-denied:${t.actorEmail||t.sourceIp||"unknown"}`,t.occurredAtMs,60*i.permissionDeniedWindowMinutes*1e3);if(r<i.permissionDeniedThreshold)return null;let n=t.moduleName.includes("employee records")||t.moduleName.includes("performance")||t.moduleName.includes("attendance");return{ruleId:"UNAUTHORIZED_ACCESS_ATTEMPT",incidentType:"Unauthorized Access",severity:B(n?"high":"medium",r,i.permissionDeniedThreshold),restrictedPiiInvolved:n,observedCount:r,windowMinutes:i.permissionDeniedWindowMinutes,affectedEmployeeEmail:t.targetEmployeeEmail||t.actorEmail,title:"Repeated unauthorized access attempts detected",summary:`Detected ${r} permission/ownership denials for actor ${t.actorEmail||"unknown"} within ${i.permissionDeniedWindowMinutes} minute(s).`,tags:["authorization","idor","least-privilege","ids"]}}function q(e,t,i){if(!(t.moduleName.includes("export")||t.requestPath.includes("/api/hris/exports")||t.activityName.includes("export"))||"approved"!==t.status&&"completed"!==t.status)return null;let r=$(`export-spike:${t.actorEmail||t.sourceIp||"unknown"}`,t.occurredAtMs,60*i.exportSpikeWindowMinutes*1e3);return r<i.exportSpikeThreshold?null:{ruleId:"MASS_EXPORT_ACTIVITY",incidentType:"Data Exposure",severity:B("high",r,i.exportSpikeThreshold),restrictedPiiInvolved:!0,observedCount:r,windowMinutes:i.exportSpikeWindowMinutes,affectedEmployeeEmail:t.targetEmployeeEmail||"",title:"Mass export activity detected",summary:`Detected ${r} export-related actions by ${t.actorEmail||t.sourceIp} within ${i.exportSpikeWindowMinutes} minute(s).`,tags:["export","dlp","ids"]}}function H(e,t,i){if(!("sensitive"===t.sensitivity&&t.moduleName.includes("employee records")&&(t.activityName.includes("view")||t.activityName.includes("list"))&&("completed"===t.status||"approved"===t.status)))return null;let r=$(`pii-read:${t.actorEmail||t.sourceIp||"unknown"}`,t.occurredAtMs,60*i.piiAccessSpikeWindowMinutes*1e3);return r<i.piiAccessSpikeThreshold?null:{ruleId:"PII_ACCESS_VOLUME_SPIKE",incidentType:"Policy Violation",severity:B("medium",r,i.piiAccessSpikeThreshold),restrictedPiiInvolved:!0,observedCount:r,windowMinutes:i.piiAccessSpikeWindowMinutes,affectedEmployeeEmail:t.targetEmployeeEmail||"",title:"Sensitive PII access spike detected",summary:`Detected ${r} sensitive employee-record read actions in ${i.piiAccessSpikeWindowMinutes} minute(s).`,tags:["pii","privacy","monitoring","ids"]}}function K(e){return g(e).split(",").map(e=>D(e)).filter(Boolean)}function Y(e,t){let i=D(process.env.CLIO_GRC_ALERT_EMAIL)||K(process.env.GRC_EMAILS)[0]||K(process.env.SUPER_ADMIN_EMAILS)[0];return i||D(t?.affectedEmployeeEmail||e?.metadata?.ownerEmail||e?.performedBy||C)}async function j(e,t,i,r){let a=Y(e,t)||D(i?.ownerEmail);return(function(e=[]){return p(e)})(await (0,n.resolveIncidentStakeholderRecipients)({ownerEmail:a,affectedEmployeeEmail:D(t?.affectedEmployeeEmail),actorEmail:D(e?.performedBy),includeAffectedEmployee:!0,includeActor:!0})).slice(0,r.maxRecipientCount)}function z(e,t){let i=Math.max(1,Number(e||1)),r=Math.max(5,Number(t?.retryBaseBackoffSeconds||30));return Math.min(Math.max(r,Number(t?.retryMaxBackoffSeconds||1800)),r*Math.pow(2,Math.max(0,i-1)))}async function X({entry:e,detection:t,fingerprint:r,errorMessage:n,config:a,attempts:o=1,source:s="live"}){if(!a?.retryEnabled)return{queued:!1,reason:"retry_disabled"};let d=x();if(!d)return{queued:!1,reason:"retry_queue_unavailable"};let u=function({entry:e,detection:t,fingerprint:i,errorMessage:r,config:n,attempts:a=1,source:o="live",queuedAtIso:s=M()}){let d=Math.max(1,Number(a||1)),u=z(d,n),c=new Date(Date.now()+1e3*u).toISOString();return{status:"pending",source:g(o,"live"),attempts:d,maxAttempts:Math.max(1,Number(n?.retryMaxAttempts||5)),nextAttemptAt:c,lastError:g(r,"ids_processing_failed"),fingerprint:g(i),entry:N(e),detection:N(t),createdAt:s,updatedAt:s}}({entry:e,detection:t,fingerprint:r,errorMessage:n,config:a,attempts:o,source:s,queuedAtIso:M()});return{queued:!0,retryRecordId:(await (0,i.addDoc)((0,i.collection)(d,a.retryCollectionName),u)).id,attempts:u.attempts,nextAttemptAt:u.nextAttemptAt}}async function G(e,{batchSize:t}={}){let r=x();if(!r)return[];let n=Math.max(1,Number(t||e?.retryBatchSize||8)),a=Math.max(3*n,16),o=await (0,i.getDocs)((0,i.query)((0,i.collection)(r,e.retryCollectionName),(0,i.orderBy)("nextAttemptAt","asc"),(0,i.limit)(a))),s=Date.now();return o.docs.map(e=>({id:e.id,...e.data()||{}})).filter(e=>"pending"===R(e?.status||"pending")).filter(e=>{let t=T(e?.nextAttemptAt);return!Number.isFinite(t)||t<=s}).slice(0,n)}async function V(e,t,r){let n=x();if(!n)return null;let a={...t,status:"dead-letter",deadLetteredAt:M(),deadLetterReason:g(r,"ids_retry_exhausted"),originalRetryRecordId:g(t?.id)};return(await (0,i.addDoc)((0,i.collection)(n,e.deadLetterCollectionName),a)).id}async function Q(e,t,r){let n=x();n&&await (0,i.updateDoc)((0,i.doc)(n,e.retryCollectionName,t),{...r,updatedAt:M()})}async function J(e,t){let r=x();r&&await (0,i.deleteDoc)((0,i.doc)(r,e.retryCollectionName,t))}async function Z(e,i,r){var n;if(function(e,t){let i=Number.isFinite(t)?t:Date.now();for(let[e,t]of w.entries())(!Number.isFinite(t)||t<=i)&&w.delete(e);let r=w.get(e);return Number.isFinite(r)&&r>t}(e,i))return!0;let a=[];try{a=await (0,t.listIncidentRecordsBackend)()}catch{a=[]}let o=60*r.incidentCooldownMinutes*1e3;return(Array.isArray(n=a)?n:[]).some(t=>{let r=g(t?.detectionFingerprint);if(!r||r!==e)return!1;let n=R(t?.status);if("resolved"===n||"closed"===n)return!1;let a=T(t?.detectedAt||t?.createdAt);return!Number.isFinite(a)||a>=i-o})}async function ee(e,i,r,n,a){let o,s=g(e?.occurredAt,M()),d=Y(e,i),u=r.systemActorEmail||C,c=N(e?.metadata),l={title:i.title,summary:i.summary,incidentType:i.incidentType,severity:i.severity,status:"Open",restrictedPiiInvolved:!!i.restrictedPiiInvolved,affectedEmployeeEmail:D(i.affectedEmployeeEmail||c.targetEmployeeEmail||""),ownerEmail:d,detectedAt:s,escalationRequired:!0,containmentStatus:"Not Started",impactAssessmentStatus:"Pending",regulatoryNotificationRequired:!!i.restrictedPiiInvolved,documentationRetained:!0,classificationStandard:"CLIO-IDS-V1",notes:`Auto-generated by CLIO IDS rule: ${i.ruleId}
Observed count: ${Number(i.observedCount||0)}
Window: ${Number(i.windowMinutes||0)} minute(s)
Source event: ${g(e?.id,"N/A")} | ${g(e?.module,"System")} | ${g(e?.activityName,"Activity")}
Source IP: ${g(c.sourceIp||e?.sourceIp,"unknown")}
Request: ${g(c.requestMethod||e?.requestMethod,"GET")} ${g(c.requestPath||e?.requestPath,"unknown")}`,autoGenerated:!0,detectionRuleId:i.ruleId,detectionFingerprint:n,detectionWindowStart:new Date(a-60*i.windowMinutes*1e3).toISOString(),detectionWindowEnd:new Date(a).toISOString(),sourceSystem:"CLIO_IDS",sourceEventId:g(e?.id),sourceEventModule:g(e?.module),sourceEventPath:g(c.requestPath||e?.requestPath),sourceIp:g(c.sourceIp||e?.sourceIp),alertRecipients:[],actionUrl:"/incident-management"},m=await (0,t.createIncidentRecordBackend)(l,u);return o=60*Math.max(1,Number(r.incidentCooldownMinutes||1))*1e3,w.set(n,a+o),m}async function et({incident:e,detection:t,recipients:i,actionUrl:r,actorEmail:a}){let o=i.map(i=>{let n,o,s;return{recipientEmail:i,title:g(e?.title||t?.title,"Security anomaly detected"),message:(n=g(e?.severity||t?.severity,"Medium"),o=g(e?.incidentCode,"INCIDENT"),s=g(e?.summary||t?.summary,"Review incident workbench for containment."),`[${n}] ${o}: ${s}`),severity:R(e?.severity||t?.severity||"medium"),type:"security-anomaly",module:"Incident Management",actionUrl:r,status:"unread",createdBy:a,metadata:{incidentId:g(e?.id||e?.recordId),incidentCode:g(e?.incidentCode),detectionRuleId:g(t?.ruleId),autoGenerated:!0}}});return await (0,n.createInAppNotificationsBulk)(o)}async function ei({entry:e,detection:i,config:r,fingerprint:n,nowMs:a}){var o;let s,d;if(await Z(n,a,r))return{detected:!0,duplicate:!0,detection:i,fingerprint:n};let u=await ee(e,i,r,n,a),c=(o=u?.id||u?.recordId)?`/incident-management?incident=${encodeURIComponent(o)}`:"/incident-management",l=(s=g(r?.appBaseUrl,"http://localhost:3000").replace(/\/+$/,""),(d=g(c,"/incident-management")).startsWith("http://")||d.startsWith("https://")?d:`${s}${d.startsWith("/")?d:`/${d}`}`),m=await j(e,i,u,r),p=await et({incident:u,detection:i,recipients:m,actionUrl:c,actorEmail:r.systemActorEmail}),_=await S({incident:{...u,actionUrl:l},detection:i,sourceEvent:e,emailRecipients:m}),f={alertRecipients:m,alertDispatchSummary:_,externalIntegrations:{webhooks:_?.webhooks||{}},lastAlertDispatchAt:M()};return await (0,t.updateIncidentRecordBackend)(u.id,f,r.systemActorEmail).catch(()=>null),{detected:!0,duplicate:!1,detection:i,incidentRecord:u,fingerprint:n,recipients:m,inAppNotificationCount:p.length,deliverySummary:_}}async function er(e,t){let i=g(t?.id);if(!i)return{processed:!1,reason:"missing_retry_record_id"};let r=Math.max(1,Number(t?.attempts||1)),n=Math.max(1,Number(t?.maxAttempts||e.retryMaxAttempts||5)),a=N(t?.entry),o=N(t?.detection),s=g(t?.fingerprint);if(!s||!g(o?.ruleId)||!g(a?.activityName)&&!g(a?.module))return await V(e,t,"invalid_retry_payload"),await J(e,i),{processed:!1,deadLettered:!0,reason:"invalid_retry_payload"};let d=await ea(a,{forcedDetection:o,forcedFingerprint:s,skipQueueOnError:!0,disableQueueDrain:!0});if(!d?.failed)return await J(e,i),{processed:!0,duplicate:!!d?.duplicate,detected:!!d?.detected};let u=r+1,c=g(d?.error,"ids_processing_failed");if(u>n)return await V(e,{...t,attempts:u,maxAttempts:n,lastError:c},c),await J(e,i),{processed:!1,deadLettered:!0,reason:c};let l=new Date(Date.now()+1e3*z(u,e)).toISOString();return await Q(e,i,{attempts:u,maxAttempts:n,nextAttemptAt:l,lastError:c,status:"pending"}),{processed:!1,retried:!0,reason:c,nextAttemptAt:l}}async function en({reason:e="manual",batchSize:t}={}){let i=P();if(!i.enabled||!i.retryEnabled)return{processedCount:0,reason:i.enabled?"retry_disabled":"ids_disabled"};if(A)return A;A=(async()=>{let r=await G(i,{batchSize:Number(t||i.retryBatchSize||8)}),n=0,a=0,o=0;for(let e of r)try{let t=await er(i,e);t?.processed&&(n+=1),t?.deadLettered&&(a+=1)}catch{o+=1}return{reason:g(e,"manual"),processedCount:n,deadLetterCount:a,failedCount:o,dueCount:r.length}})();try{return await A}finally{A=null}}async function ea(e,t={}){var i,r,n;let a,o,s,d,u,c,l=P();if(!l.enabled)return{detected:!1,reason:"ids_disabled"};if(!e||"object"!=typeof e)return{detected:!1,reason:"invalid_audit_entry"};!t?.disableQueueDrain&&l.retryEnabled&&en({reason:"audit-event"}).catch(()=>null);let m=(i=t?.forcedDetection)&&"object"==typeof i&&!Array.isArray(i)?t.forcedDetection:null;if(!m&&function(e){let t=N(e?.metadata);if(!0===t.skipAnomalyDetection||!0===t.autoGenerated)return!0;let i=R(e?.module),r=R(t.requestPath||e?.requestPath);return!!(i.includes("incident management")||r.startsWith("/api/notifications"))}(e))return{detected:!1,reason:"event_skipped"};let p=(a=N(e?.metadata),{actorEmail:D(e?.performedBy),status:R(e?.status),moduleName:R(e?.module),activityName:R(e?.activityName),reason:R(a.reason),requestPath:R(a.requestPath||e?.requestPath),requestMethod:R(a.requestMethod||e?.requestMethod),sourceIp:L(a.sourceIp||e?.sourceIp),sensitivity:R(e?.sensitivity),targetEmployeeEmail:D(a.targetEmployeeEmail||a.employeeEmail||a.affectedEmployeeEmail),ownerEmail:D(a.ownerEmail),occurredAtMs:T(e?.occurredAt)||Date.now()}),_=m||function(e,t,i){for(let r of[U,F,q,H]){let n=r(e,t,i);if(n)return n}return null}(e,p,l);if(!_)return{detected:!1,reason:"no_rule_match"};let f=p.occurredAtMs||Date.now(),I=g(t?.forcedFingerprint)||(r=_.ruleId,n=_.windowMinutes||l.incidentCooldownMinutes,o=D(e?.performedBy),s=L(e?.metadata?.sourceIp||e?.sourceIp),d=R(e?.module||""),u=D(_?.affectedEmployeeEmail||e?.metadata?.employeeEmail||""),c=Math.floor(f/(60*Math.max(1,Number(n||1))*1e3)),[g(r),o||"unknown",s,d||"module",u||"none",c].join("|"));try{return await ei({entry:e,detection:_,config:l,fingerprint:I,nowMs:f})}catch(n){let i=n instanceof Error?g(n.message,"ids_processing_failed"):"ids_processing_failed";if(t?.skipQueueOnError)return{detected:!0,duplicate:!1,failed:!0,detection:_,fingerprint:I,reason:"processing_failed",error:i};let r=await X({entry:e,detection:_,fingerprint:I,errorMessage:i,config:l,attempts:1,source:"live"});return{detected:!0,duplicate:!1,failed:!0,queuedForRetry:!!r?.queued,retryRecordId:g(r?.retryRecordId),detection:_,fingerprint:I,reason:"processing_failed",error:i}}}e.s(["drainSecurityDetectionRetryQueue",()=>en,"processAuditEventForSecurityDetections",()=>ea],74405)}];

//# sourceMappingURL=src_lib_security-detection_4bdbe3ad.js.map