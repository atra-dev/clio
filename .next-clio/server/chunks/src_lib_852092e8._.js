module.exports=[33355,e=>{"use strict";e.i(18097);var t=e.i(19e3),n=e.i(67658),i=e.i(45709);function r(){return new Date().toISOString()}function a(e,t=""){return String(e||"").trim()||t}function o(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){let n=e.trim().toLowerCase();if(!n)return t;if(["true","1","yes","on","y"].includes(n))return!0;if(["false","0","no","off","n"].includes(n))return!1}return t}function s(e){return Array.isArray(e)?e:[]}function c(e,t,{min:n=1,max:i=Number.MAX_SAFE_INTEGER}={}){let r=Number.parseInt(String(e||""),10);return Number.isFinite(r)?Math.min(i,Math.max(n,r)):t}function d(e){return String(e||"").trim().toLowerCase()}function l(e){return String(e||"").split(",").map(e=>d(e)).filter(Boolean)}function u(e){return"read"===String(e||"").trim().toLowerCase()?"read":"unread"}function f(){return a(process.env.CLIO_FIRESTORE_NOTIFICATIONS_COLLECTION,"clio_notifications")}function m(){return(0,n.isFirestoreEnabled)()?(0,n.getFirestoreDb)():null}function p(e){return{...e.data()||{},id:e.id,recordId:e.id}}function _(e,t){let n=d(t),i=d(e?.recipientEmail);return o(e?.broadcast,!1)||n&&i&&n===i}function E(e,t){return new Date(t?.createdAt||0).getTime()-new Date(e?.createdAt||0).getTime()}async function I(e){let n=m();if(!n)return null;let i=function(e){var t;let n,i=r(),s=d(e?.recipientEmail),c=o(e?.broadcast,!1);if(!s&&!c)throw Error("invalid_notification_recipient");return{title:a(e?.title,"Security notification"),message:a(e?.message,"A security event requires review."),severity:"critical"===(n=String(e?.severity||"").trim().toLowerCase())?"critical":"high"===n?"high":"low"===n?"low":"medium",type:a(e?.type,"security"),module:a(e?.module,"Incident Management"),actionUrl:a(e?.actionUrl,"/incident-management"),recipientEmail:s,broadcast:c,status:u(e?.status),metadata:(t=e?.metadata)&&"object"==typeof t&&!Array.isArray(t)?t:{},createdAt:a(e?.createdAt,i),updatedAt:a(e?.updatedAt,i),readAt:a(e?.readAt,""),createdBy:d(e?.createdBy)}}(e),s=await (0,t.addDoc)((0,t.collection)(n,f()),i);return{...i,id:s.id,recordId:s.id}}async function v(e){let t=s(e);if(0===t.length)return[];let n=[];for(let e of t){let t=await I(e);t&&n.push(t)}return n}async function g({recipientEmail:e,status:n="all",limit:i=20}={}){let r=m();if(!r)return{records:[],unreadCount:0,totalScoped:0};let a=String(n||"").trim().toLowerCase(),o=c(i,20,{min:1,max:120}),s=Math.max(4*o,100),d=(await (0,t.getDocs)((0,t.query)((0,t.collection)(r,f()),(0,t.orderBy)("createdAt","desc"),(0,t.limit)(s)))).docs.map(p).filter(t=>_(t,e)),l=d.reduce((e,t)=>e+ +("unread"===u(t?.status)),0);return{records:d.filter(e=>"all"===a||!a||u(e?.status)===a).sort(E).slice(0,o),unreadCount:l,totalScoped:d.length}}async function y(e,n){let i=m();if(!i)return null;let o=a(e);if(!o)throw Error("invalid_record_id");let s=(0,t.doc)(i,f(),o),c=await (0,t.getDoc)(s);if(!c.exists())return null;let d=p(c);if(!_(d,n))throw Error("forbidden_notification_access");if("read"===u(d.status))return d;let l={...d,status:"read",readAt:r(),updatedAt:r()};return await (0,t.updateDoc)(s,l),l}async function w({recipientEmail:e,limit:n=120}={}){let i=d(e);if(!i)return{updatedCount:0};let o=m();if(!o)return{updatedCount:0};let s=c(n,120,{min:1,max:300}),{records:l}=await g({recipientEmail:i,status:"unread",limit:s}),u=0;for(let e of l){let n=a(e?.id||e?.recordId);if(!n)continue;let i=(0,t.doc)(o,f(),n);await (0,t.updateDoc)(i,{status:"read",readAt:r(),updatedAt:r()}),u+=1}return{updatedCount:u}}async function A({ownerEmail:e,affectedEmployeeEmail:t,actorEmail:n,includeAffectedEmployee:r=!0,includeActor:a=!1}={}){let o=[d(process.env.CLIO_GRC_ALERT_EMAIL),...l(process.env.GRC_EMAILS),...l(process.env.SUPER_ADMIN_EMAILS),d(e)];r&&o.push(d(t)),a&&o.push(d(n));let c=[];try{let e=await (0,i.listUserAccounts)();c=s(e).filter(e=>d(e?.email)).filter(e=>{var t;return"active"===(t=e?.status,String(t||"").trim().toLowerCase())}).filter(e=>{let t=String(e?.role||"").trim().toUpperCase();return"GRC"===t||"SUPER_ADMIN"===t}).map(e=>d(e?.email))}catch{c=[]}return function(e=[]){return Array.from(new Set(s(e).map(e=>d(e)).filter(Boolean)))}([...o,...c])}e.s(["createInAppNotificationsBulk",()=>v,"listInAppNotifications",()=>g,"markAllInAppNotificationsRead",()=>w,"markInAppNotificationRead",()=>y,"resolveIncidentStakeholderRecipients",()=>A])},4381,e=>{"use strict";let t="__clio_rate_limit_buckets__";function n(e){return String(e||"").trim().toLowerCase()}function i({scope:e,identifier:i,limit:r=20,windowMs:a=3e5}){let o=String(e||"default").trim().toLowerCase(),s=n(i)||"unknown",c=Math.max(1,Number.parseInt(String(r),10)||1),d=Math.max(1e3,Number.parseInt(String(a),10)||1e3),l=(globalThis[t]||(globalThis[t]=new Map),globalThis[t]),u=Date.now();!function(e,t){if(e.size<=5e3)return;for(let[n,i]of e.entries())(!i||t>=i.resetAt)&&e.delete(n);if(e.size<=5e3)return;let n=e.size-5e3;for(let t of e.keys())if(e.delete(t),(n-=1)<=0)break}(l,u);let f=`${o}:${s}`,m=l.get(f);(!m||u>=m.resetAt)&&(m={count:0,resetAt:u+d}),m.count+=1,l.set(f,m);let p=Math.max(0,c-m.count),_=Math.max(1,Math.ceil((m.resetAt-u)/1e3));return{allowed:m.count<=c,key:f,remaining:p,retryAfterSeconds:_,resetAt:m.resetAt,headers:{"Retry-After":String(_),"X-RateLimit-Limit":String(c),"X-RateLimit-Remaining":String(p),"X-RateLimit-Reset":String(Math.floor(m.resetAt/1e3))}}}function r({request:e,scope:t,identifier:r,limit:a,windowMs:o}){return i({scope:t,identifier:n(r)||function(e){if(!e||!e.headers)return"unknown";let t=e.headers.get("x-forwarded-for");if(t){let e=t.split(",")[0]?.trim();if(e)return e}for(let t of["x-real-ip","cf-connecting-ip","x-vercel-forwarded-for"]){let n=String(e.headers.get(t)||"").trim();if(n)return n}return"unknown"}(e),limit:a,windowMs:o})}e.s(["consumeRateLimit",()=>i,"enforceRateLimitByRequest",()=>r])},39552,72331,e=>{"use strict";function t(e,n=""){return String(e||"").trim()||n}let n={title:"Incident title",summary:"Incident summary",incidentType:"Incident type",severity:"Severity",status:"Status",containmentStatus:"Containment status",containmentSummary:"Containment summary",impactAssessmentStatus:"Impact assessment status",impactSummary:"Impact assessment summary",ownerEmail:"Incident owner",affectedEmployeeEmail:"Affected employee",restrictedPiiInvolved:"Restricted PII flag",escalationRequired:"Escalation requirement",executiveNotificationRequired:"Executive notification requirement",regulatoryNotificationRequired:"Regulatory notification requirement",regulatoryNotifiedAt:"Regulator notification",affectedIndividualsNotifiedAt:"Affected-individual notification",grcAlertedAt:"GRC alert timestamp",executiveNotifiedAt:"Executive notification timestamp",documentationRetained:"Documentation retention",documentationLocation:"Documentation location",classificationStandard:"Classification standard",notes:"Investigation notes",forensicWindowStart:"Forensic window start",forensicWindowEnd:"Forensic window end"};function i(e={},n=""){let r=t(e?.title);if(r)return r;let a=t(e?.incidentCode);return a?`Case ${a}`:t(n)?"Incident Record":"Incident"}function r(e={},n=""){let a=i(e,n),o=t(e?.severity,"Medium"),s=t(e?.status,"Open");return{title:`New Incident: ${a}`,message:`A new incident has been logged for review. Severity: ${o}. Current status: ${s}.`}}function a(e={},r=[],o=""){let s=i(e,o),c=function(e=[],{max:i=4}={}){let r=Array.from(new Set((Array.isArray(e)?e:[]).map(e=>{let i;return(i=t(e))?n[i]?n[i]:i.replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/[_-]+/g," ").replace(/\s+/g," ").trim().replace(/^./,e=>e.toUpperCase()):"Field"}).filter(Boolean)));if(0===r.length)return"";if(r.length<=i)return r.join(", ");let a=r.slice(0,i).join(", ");return`${a}, +${r.length-i} more`}(r),d=new Set((Array.isArray(r)?r:[]).map(e=>t(e))),l="Incident workflow details were updated.";d.has("status")?l=`Incident status is now ${t(e?.status,"updated")}.`:d.has("containmentStatus")?l=`Containment status is now ${t(e?.containmentStatus,"updated")}.`:d.has("regulatoryNotifiedAt")?l="Regulator notification has been recorded.":d.has("affectedIndividualsNotifiedAt")?l="Affected-individual notification has been recorded.":d.has("executiveNotifiedAt")?l="Executive notification has been recorded.":d.has("grcAlertedAt")&&(l="GRC alert timestamp has been recorded.");let u=c?` Updated fields: ${c}.`:"";return{title:`Incident Updated: ${s}`,message:`${l}${u}`.trim()}}e.s(["buildIncidentCreatedNotification",()=>r,"buildIncidentUpdatedNotification",()=>a],39552);let o=new Set(["pdf","png","jpg","jpeg","webp","doc","docx","xls","xlsx","csv","txt"]),s=new Set(["application/pdf","image/png","image/jpeg","image/webp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv","text/plain"]);function c(e,t=""){return String(e||"").trim()||t}function d(e){return c(e).toLowerCase()}function l(e,t=!1){let n=d(process.env[e]);return n?"true"===n||"1"===n||"yes"===n||"on"===n:t}function u(e,t,{min:n=1,max:i=Number.MAX_SAFE_INTEGER}={}){let r=Number.parseInt(c(process.env[e]),10);return Number.isFinite(r)?Math.min(i,Math.max(n,r)):t}function f(e,t){let n=c(process.env[e]);if(!n)return new Set([...t]);let i=n.split(",").map(e=>d(e)).filter(Boolean);return new Set(i.length>0?i:[...t])}function m(e){return c(e).toLowerCase()}function p(){return new Date().toISOString()}function _(e){let t=c(e).toLowerCase();if(!t)return"";let n=t.split("?")[0].split("#")[0].split(".").pop()||"";return/^[a-z0-9]{2,10}$/.test(n)?n:""}async function E(e,t,n){if(!n.avHookUrl){if(n.avRequired)throw Error("incident_evidence_av_not_configured");return{status:"skipped",provider:"none",blockedIds:[],reference:""}}let i=new AbortController,r=setTimeout(()=>i.abort(),n.avTimeoutMs);try{var a;let r={"Content-Type":"application/json","X-CLIO-Source":"incident-evidence-validation"};n.avHookToken&&(r.Authorization=`Bearer ${n.avHookToken}`);let o=await fetch(n.avHookUrl,{method:"POST",headers:r,body:JSON.stringify({generatedAt:p(),actorEmail:m(t),records:e.map(e=>({id:e.id,name:e.name,storagePath:e.storagePath,ref:e.ref,contentType:e.contentType,fileExtension:e.fileExtension,sizeBytes:e.sizeBytes}))}),signal:i.signal}),s=await o.json().catch(()=>({}));if(!o.ok)throw Error(c(s?.message,"incident_evidence_av_hook_failed"));let d=(a=s?.blockedIds,Array.isArray(a)?a:[]).map(e=>c(e)).filter(Boolean);if(s?.allowed===!1||s?.blocked===!0||d.length>0)throw Error("incident_evidence_av_blocked");return{status:"passed",provider:"hook",blockedIds:[],reference:c(s?.scanId||s?.reference||"")}}catch(e){if(n.avFailOpen&&!n.avRequired)return{status:"failed-open",provider:"hook",blockedIds:[],reference:""};if("incident_evidence_av_blocked"===(e instanceof Error?c(e.message):""))throw e;throw Error("incident_evidence_av_hook_failed")}finally{clearTimeout(r)}}async function I(e,{actorEmail:t}={}){if(!Array.isArray(e))throw Error("invalid_incident_evidence_payload");let n={maxBytes:u("CLIO_INCIDENT_EVIDENCE_MAX_BYTES",0xa00000,{min:131072,max:0x3200000}),allowedExtensions:f("CLIO_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS",o),allowedMimeTypes:f("CLIO_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES",s),requireMimeType:l("CLIO_INCIDENT_EVIDENCE_REQUIRE_MIME_TYPE",!0),avHookUrl:c(process.env.CLIO_INCIDENT_EVIDENCE_AV_HOOK_URL),avHookToken:c(process.env.CLIO_INCIDENT_EVIDENCE_AV_HOOK_TOKEN),avRequired:l("CLIO_INCIDENT_EVIDENCE_AV_REQUIRED",!1),avFailOpen:l("CLIO_INCIDENT_EVIDENCE_AV_FAIL_OPEN",!1),avTimeoutMs:u("CLIO_INCIDENT_EVIDENCE_AV_TIMEOUT_MS",5e3,{min:1e3,max:2e4})},i=e.map((e,i)=>(function(e,t,n,i){let r,a=function(e,t=null){return e&&"object"==typeof e&&!Array.isArray(e)?e:t}(e);if(!a)throw Error("invalid_incident_evidence_payload");let o=c(a.name);if(!o)throw Error("invalid_incident_evidence_name");let s=c(a.ref),l=c(a.storagePath);if(!s&&!l)throw Error("invalid_incident_evidence_reference");let u=_(a.fileExtension)||_(o)||_(l)||_(s);if(!u||!i.allowedExtensions.has(u))throw Error("invalid_incident_evidence_extension");let f=d(a.contentType)||("pdf"===(r=d(u))?"application/pdf":"png"===r?"image/png":"jpg"===r||"jpeg"===r?"image/jpeg":"webp"===r?"image/webp":"doc"===r?"application/msword":"docx"===r?"application/vnd.openxmlformats-officedocument.wordprocessingml.document":"xls"===r?"application/vnd.ms-excel":"xlsx"===r?"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"csv"===r?"text/csv":"txt"===r?"text/plain":"");if(!f||!i.allowedMimeTypes.has(f)||i.requireMimeType&&!c(a.contentType))throw Error("invalid_incident_evidence_content_type");let E=Number(a.sizeBytes);if(!Number.isFinite(E)||E<=0||E>i.maxBytes)throw Error("invalid_incident_evidence_size");let I=c(a.uploadedAt,p()),v=m(a.uploadedBy||n);return{id:c(a.id||a.recordId,`incident-evidence-${Date.now()}-${t+1}`),name:o.slice(0,180),type:c(a.type,"Incident Evidence").slice(0,80),ref:s,storagePath:l,fileExtension:u,contentType:f,sizeBytes:Math.round(E),uploadedAt:I,uploadedBy:v||m(n)||"system@gmail.com",scanStatus:c(a.scanStatus),scanReference:c(a.scanReference)}})(e,i,t,n)),r=await E(i,t,n),a=p();return i.map(e=>({...e,scanStatus:e.scanStatus||r.status,scanReference:e.scanReference||r.reference,scannedAt:a}))}e.s(["validateIncidentEvidenceDocumentsStrict",()=>I],72331)},11072,e=>{e.v(e=>Promise.resolve().then(()=>e(74405)))}];

//# sourceMappingURL=src_lib_852092e8._.js.map