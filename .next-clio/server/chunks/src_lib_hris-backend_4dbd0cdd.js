module.exports=[45787,e=>{"use strict";e.i(18097);var t=e.i(19e3),a=e.i(67658),r=e.i(45709),i=e.i(35110),n=e.i(44801),o=e.i(96864);let l=new Set(["role","department"]),d=[{value:"SUPER_ADMIN",label:"Super Admin"},{value:"GRC",label:"GRC"},{value:"HR",label:"HR"},{value:"EA",label:"EA"},{value:"EMPLOYEE_L1",label:"Employee (L1)"},{value:"EMPLOYEE_L2",label:"Employee (L2)"},{value:"EMPLOYEE_L3",label:"Employee (L3)"}],c=["Governance, Risk, and Compliance (GRC)","Research and Development (R&D)","Cyber Security Operations Center (CSOC)","Threat Intelligence (TI)"],s=new Map([["SUPER_ADMIN","SUPER_ADMIN"],["SUPERADMIN","SUPER_ADMIN"],["ADMIN","SUPER_ADMIN"],["GRC","GRC"],["HR","HR"],["EA","EA"],["EMPLOYEE","EMPLOYEE_L1"],["EMPLOYEE_L1","EMPLOYEE_L1"],["EMPLOYEE_L2","EMPLOYEE_L2"],["EMPLOYEE_L3","EMPLOYEE_L3"],["L1","EMPLOYEE_L1"],["L2","EMPLOYEE_L2"],["L3","EMPLOYEE_L3"]]),u={onboarding:{type:"onboarding",category:"Onboarding",stages:["Initiated","Document Verification","Access Provisioning","Activation"],checklist:[{id:"profile-intake",label:"Collect employee profile and contacts",required:!0,slaHours:12},{id:"contract-check",label:"Validate contract and onboarding requirements",required:!0,slaHours:24},{id:"account-activation",label:"Activate employee account",required:!0,slaHours:48}],approverRoles:["HR","GRC"],slaHours:72},"role-change":{type:"role-change",category:"Role Change",stages:["Initiated","Approval Review","Role Sync","Completed"],checklist:[{id:"movement-justification",label:"Attach role-change justification",required:!0,slaHours:24},{id:"effective-date-review",label:"Validate effective date and scope",required:!0,slaHours:24},{id:"permission-sync",label:"Apply role and permission sync",required:!0,slaHours:48}],approverRoles:["HR","GRC"],slaHours:96},disciplinary:{type:"disciplinary",category:"Disciplinary",stages:["Case Opened","Investigation","Decision","Closed"],checklist:[{id:"incident-report",label:"Record incident report",required:!0,slaHours:24},{id:"evidence-review",label:"Attach and review case evidence",required:!0,slaHours:48},{id:"decision-log",label:"Finalize disciplinary decision",required:!0,slaHours:72}],approverRoles:["HR","GRC"],slaHours:120},offboarding:{type:"offboarding",category:"Offboarding",stages:["Initiated","Clearance","Access Revocation","Archived"],checklist:[{id:"clearance-init",label:"Start employee clearance checklist",required:!0,slaHours:12},{id:"access-revoked",label:"Disable account and revoke access",required:!0,slaHours:24},{id:"archive-records",label:"Archive employee records",required:!0,slaHours:48}],approverRoles:["HR","GRC"],slaHours:72}},m=new Set(["SUPER_ADMIN","GRC","HR","EA"]),p=new Set(["EMPLOYEE_L1","EMPLOYEE_L2","EMPLOYEE_L3"]),f=new Set(["GRC","HR","EA","EMPLOYEE_L1","EMPLOYEE_L2","EMPLOYEE_L3"]),y=["Low","Medium","High","Critical"],w=["Open","Containment","Investigating","Escalated","Regulatory Review","Resolved","Closed"],v=["Not Started","In Progress","Contained"],g=["Pending","In Progress","Completed"],E=["Unauthorized Access","Data Exposure","Credential Compromise","Insider Misuse","Malware / Ransomware","Policy Violation","System Misconfiguration","Other"],h=new Set(["pdf","png","jpg","jpeg","webp","doc","docx","xls","xlsx","csv","txt"]),A=new Set(["application/pdf","image/png","image/jpeg","image/webp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv","text/plain"]);function _(e,t){return String(process.env[e]||"").trim()||t}function b(e,t){let a=String(e||"").split(",").map(e=>String(e||"").trim().toLowerCase()).filter(Boolean);return new Set(0===a.length?[...t]:a)}function S(){return new Date().toISOString()}function I(){let e=Number.parseInt(String(process.env.CLIO_RETENTION_YEARS||"").trim(),10);return!Number.isFinite(e)||e<1?5:Math.min(e,25)}function C(e,t=""){return String(e??"").trim()||t}function L(e){return String(e||"").trim().toLowerCase()}function N(e){return String(e||"").trim().toLowerCase()}function R(e){return String(e||"").trim().toUpperCase().replace(/[^A-Z0-9]+/g,"_").replace(/^_+|_+$/g,"")}function B(e){let t=String(e||"").trim().toLowerCase();return l.has(t)?t:""}function k(e,t){let a=B(e);return a?"role"===a?R(t):String(t||"").trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""):""}function D(e){return[...e].sort((e,t)=>!!e?.isSystem!=!!t?.isSystem?e?.isSystem?-1:1:String(e?.label||"").localeCompare(String(t?.label||""),void 0,{sensitivity:"base"}))}function O(e){return Array.isArray(e)?e:[]}function T(e,t={}){return e&&"object"==typeof e&&!Array.isArray(e)?e:t}function M(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){let a=e.trim().toLowerCase();if(!a)return t;if(["true","1","yes","y","on"].includes(a))return!0;if(["false","0","no","n","off"].includes(a))return!1}return t}function P(e,{actorEmail:t,now:a}={}){let r=N(t)||"system@gmail.com",i=C(a,S());return O(e).map((e,t)=>{let a=T(e,{}),n=C(a.uploadedAt,i),o=N(a.uploadedBy||r)||r,l=Number(a.sizeBytes);return{id:C(a.id),name:C(a.name,"Employee Document"),type:C(a.type,"General"),ref:C(a.ref),storagePath:C(a.storagePath),contentType:C(a.contentType),sizeBytes:Number.isFinite(l)&&l>=0?l:0,uploadedAt:n,uploadedBy:o,order:Number.isFinite(Number(a.order))?Number(a.order):t}}).filter(e=>e.ref||e.name)}async function x(e,{db:a}={}){let r=C(e);if(!r)return[];let i=a||ei(),n=ea("employees"),o=er();return(await (0,t.getDocs)((0,t.collection)(i,n,r,o))).docs.map((e,t)=>{let a=P([e.data()],{now:S()})[0];return a?{...a,id:e.id,recordId:e.id,order:Number.isFinite(Number(a.order))?Number(a.order):t}:null}).filter(Boolean).sort((e,t)=>{let a=new Date(e.uploadedAt||0).getTime(),r=new Date(t.uploadedAt||0).getTime();return Number.isFinite(a)&&Number.isFinite(r)&&r!==a?r-a:Number(e.order||0)-Number(t.order||0)})}async function F(e,{db:a}={}){let r=C(e);if(!r)return 0;let i=a||ei(),n=ea("employees"),o=er(),l=await (0,t.getDocs)((0,t.collection)(i,n,r,o)),d=0;for(let e of l.docs)await (0,t.deleteDoc)(e.ref),d+=1;return d}async function q(e,a,{actorEmail:r,db:i}={}){let n=C(e);if(!n)throw Error("invalid_record_id");let o=i||ei(),l=ea("employees"),d=er(),c=(0,t.collection)(o,l,n,d),s=P(a,{actorEmail:r,now:S()});await F(n,{db:o});let u=[];for(let e of s){let a={name:e.name,type:e.type,ref:e.ref,storagePath:e.storagePath,contentType:e.contentType,sizeBytes:e.sizeBytes,uploadedAt:e.uploadedAt,uploadedBy:e.uploadedBy,order:e.order},r=await (0,t.addDoc)(c,a);u.push({...a,id:r.id,recordId:r.id})}return u.sort((e,t)=>new Date(t.uploadedAt||0).getTime()-new Date(e.uploadedAt||0).getTime()).map((e,t)=>({...e,order:Number.isFinite(Number(e.order))?Number(e.order):t}))}function H(e,t=[]){let a=Array.isArray(t)?t:[];return{...e,documents:a,documentsCount:a.length}}async function U(e,{db:t}={}){if(!e?.id)return[];let a=await x(e.id,{db:t});if(a.length>0)return a;let r=function(e,t=[]){return Array.isArray(t)&&t.length>0?t:P(e?.documents,{actorEmail:e?.updatedBy||e?.createdBy,now:e?.updatedAt||e?.createdAt||S()})}(e,[]);if(0===r.length)return[];let i=await q(e.id,r,{actorEmail:e.updatedBy||e.createdBy,db:t});return await Y(e.id,{documentsCount:i.length,db:t}),i}async function Y(e,{documentsCount:a,db:r}={}){let i=C(e);if(!i)return;let n=r||ei(),o={documents:(0,t.deleteField)()};Number.isFinite(Number(a))&&(o.documentsCount=Math.max(0,Number(a))),await (0,t.updateDoc)((0,t.doc)(n,ea("employees"),i),o)}function j(e,t){let a=[],r=new Set,i=0,n=(e,t=!1)=>{let n=P([e],{actorEmail:e?.uploadedBy,now:e?.uploadedAt})[0];if(!n)return;let o=function(e){let t=C(e?.storagePath);if(t)return`path:${t}`;let a=C(e?.ref);return a?`ref:${a}`:`fallback:${C(e?.name)}|${Number.isFinite(Number(e?.sizeBytes))?Number(e.sizeBytes):0}|${C(e?.uploadedAt)}`}(n);!r.has(o)&&(r.add(o),a.push(n),t&&(i+=1))};return O(e).forEach(e=>n(e,!1)),O(t).forEach(e=>n(e,!0)),{merged:a,addedCount:i}}function $(e,t){let a=S();return P(O(e).map(e=>{let r=T(e,{});return{id:C(r.id),name:C(r.name,"Onboarding Document"),type:C(r.type,"Onboarding"),ref:C(r.ref),storagePath:C(r.storagePath),contentType:C(r.contentType),sizeBytes:Number.isFinite(Number(r.sizeBytes))?Number(r.sizeBytes):0,uploadedAt:C(r.uploadedAt,a),uploadedBy:C(r.uploadedBy,t)}}),{actorEmail:t,now:a})}async function G(e,t){if(!C(e?.category).toLowerCase().includes("onboarding"))return{synced:!1,addedCount:0};let a=N(e?.employeeEmail);if(!a)return{synced:!1,addedCount:0};let r=$(e?.evidence,t);if(0===r.length)return{synced:!1,addedCount:0};let i=(await en(ea("employees"),{filterField:"email",filterValue:a}))[0];if(!i?.id)return{synced:!1,addedCount:0};let{merged:n,addedCount:o}=j(await U(i),r);if(o<=0)return{synced:!1,addedCount:0};let l=await q(i.id,n,{actorEmail:t});return await Y(i.id,{documentsCount:l.length}),{synced:!0,addedCount:o,documentsCount:l.length,employeeRecordId:i.id}}async function V(e,t){let a=N(e);return a?j([],(await en(ea("lifecycle"),{filterField:"employeeEmail",filterValue:a})).filter(e=>C(e?.category).toLowerCase().includes("onboarding")).flatMap(e=>$(e?.evidence,t))).merged:[]}function z({firstName:e,middleName:t,lastName:a,suffix:r,fallback:i}){return(0,n.formatEmployeeName)({firstName:C(e),middleName:C(t),lastName:C(a),suffix:C(r),fallback:C(i),fallbackLabel:"Employee"})}function W(e,t){let a=Number.isFinite(Number(t))?Number(t):0,r=new Date(e||S());return Number.isNaN(r.getTime())?S():(r.setTime(r.getTime()+60*Math.max(0,a)*6e4),r.toISOString())}function X(e){return String(e||"").trim().toUpperCase().replace(/[^A-Z0-9_]+/g,"")}function J(e){let t=O(e);return 0===t.length?"Not Required":t.some(e=>"rejected"===L(e?.status))?"Rejected":t.length>0&&t.every(e=>"approved"===L(e?.status))?"Approved":"Pending"}function Z(e){let t=e.filter(e=>!1!==e.required),a=t.filter(e=>"completed"===L(e.status)).length,r=t.length;return{completedRequired:a,totalRequired:r,percent:0===r?0:Math.round(a/r*100)}}function Q(e,t){let a=Number.parseInt(String(e??""),10);return Number.isFinite(a)?Math.max(0,Math.min(a,Math.max(0,t-1))):0}function K({actorRole:e,targetRole:t}){if(!t)return;let a=X(e),r=X(t);if("SUPER_ADMIN"!==a){if("GRC"===a){if("SUPER_ADMIN"===r)throw Error("forbidden_target_role");if(!f.has(r))throw Error("invalid_target_role");return}if("HR"===a||"EA"===a){if(!p.has(r))throw Error("forbidden_target_role");return}if(m.has(r))throw Error("forbidden_target_role");if(!p.has(r))throw Error("invalid_target_role")}}function ee(e,t){let a=[...O(e),t];return a.length<=80?a:a.slice(a.length-80)}function et(e,t){return new Date(t.updatedAt||t.createdAt||0).getTime()-new Date(e.updatedAt||e.createdAt||0).getTime()}function ea(e){return({employees:_("CLIO_FIRESTORE_EMPLOYEES_COLLECTION","employees"),lifecycle:_("CLIO_FIRESTORE_LIFECYCLE_COLLECTION","employment_lifecycle"),attendance:_("CLIO_FIRESTORE_ATTENDANCE_COLLECTION","attendance"),leave:_("CLIO_FIRESTORE_LEAVE_COLLECTION","leave_requests"),performance:_("CLIO_FIRESTORE_PERFORMANCE_COLLECTION","performance_records"),templates:_("CLIO_FIRESTORE_TEMPLATES_COLLECTION","document_templates"),exports:_("CLIO_FIRESTORE_EXPORTS_COLLECTION","export_requests"),incidents:_("CLIO_FIRESTORE_INCIDENTS_COLLECTION","security_incidents"),settingsReference:_("CLIO_FIRESTORE_SETTINGS_REFERENCE_COLLECTION","settings_reference_data")})[e]||e}function er(){return _("CLIO_FIRESTORE_EMPLOYEE_DOCUMENTS_SUBCOLLECTION","documents")}function ei(){if(!(0,a.isFirestoreEnabled)())throw Error("firestore_not_configured");let e=(0,a.getFirestoreDb)();if(!e)throw Error("firestore_not_configured");return e}async function en(e,{filterField:a,filterValue:r}={}){let i=ei(),n=(0,t.collection)(i,e);return(a&&"string"==typeof r&&r.trim()?await (0,t.getDocs)((0,t.query)(n,(0,t.where)(a,"==",r.trim()))):await (0,t.getDocs)(n)).docs.map(e=>({...e.data(),id:e.id,recordId:e.id})).sort(et)}async function eo(e,a){let r=ei(),i=C(a);if(!i)throw Error("invalid_record_id");let n=(0,t.doc)(r,e,i),o=await (0,t.getDoc)(n);return o.exists()?{...o.data(),id:o.id,recordId:o.id}:null}async function el(e,a){let r=ei(),i=await (0,t.addDoc)((0,t.collection)(r,e),a);return{...a,id:i.id,recordId:i.id}}async function ed(e,a,r){let i=ei(),n=C(a);if(!n)throw Error("invalid_record_id");let o=(0,t.doc)(i,e,n),l=await (0,t.getDoc)(o);if(!l.exists())return null;let d={...l.data()||{},...r};return await (0,t.updateDoc)(o,d),{...d,id:l.id,recordId:l.id}}async function ec(e,a,r,i){let n=ei(),o=C(r);if(!o)return 0;let l=await (0,t.getDocs)((0,t.query)((0,t.collection)(n,e),(0,t.where)(a,"==",o))),d=0;for(let a of l.docs){let r=i(a.data()||{},a.id);r&&"object"==typeof r&&0!==Object.keys(r).length&&(await (0,t.updateDoc)((0,t.doc)(n,e,a.id),r),d+=1)}return d}async function es(e,a){let r=ei(),i=C(a);if(!i)throw Error("invalid_record_id");let n=(0,t.doc)(r,e,i),o=await (0,t.getDoc)(n);return o.exists()?(await (0,t.deleteDoc)(n),{...o.data(),id:o.id,recordId:o.id}):null}function eu(e,t){let a=B(t||e?.kind);if(!a)return null;let r=C(e?.value||e?.label),i=C(e?.label||e?.value),n=r||i,o=i||r,l=k(a,n||o);return n&&o&&l?{id:C(e?.id||e?.recordId),kind:a,key:l,value:n,label:o,isSystem:!!e?.isSystem,createdAt:C(e?.createdAt),updatedAt:C(e?.updatedAt)}:null}async function em(){let e=ea("settingsReference"),t={roles:d.map(e=>{let t=C(e.value),a=C(e.label,t),r=k("role",t||a);return{id:`system-role-${r}`,kind:"role",key:r,value:t,label:a,isSystem:!0,createdAt:"",updatedAt:""}}),departments:c.map(e=>{let t=C(e),a=k("department",t);return{id:`system-department-${a}`,kind:"department",key:a,value:t,label:t,isSystem:!0,createdAt:"",updatedAt:""}})},a=(await en(e)).slice(0,256),r=new Map(t.roles.map(e=>[e.key,e])),i=new Map(t.departments.map(e=>[e.key,e]));return a.forEach(e=>{let t=eu(e);if(t){if("role"===t.kind){r.has(t.key)||r.set(t.key,t);return}i.has(t.key)||i.set(t.key,t)}}),{roles:D([...r.values()]),departments:D([...i.values()])}}async function ep({kind:e,label:t},a){let r=B(e);if(!r)throw Error("invalid_reference_kind");let i=String(t||"").trim().replace(/\s+/g," ");if(!i||i.length>72)throw Error("invalid_reference_label");let n=k(r,i);if(!n)throw Error("invalid_reference_label");let o=await em();if(("role"===r?o.roles:o.departments).some(e=>e.key===n))throw Error("duplicate_reference_value");let l=S(),d=eu(await el(ea("settingsReference"),{kind:r,key:n,value:i,label:i,isSystem:!1,createdAt:l,createdBy:a,updatedAt:l,updatedBy:a}),r);if(!d)throw Error("invalid_reference_label");return d}async function ef({kind:e,recordId:t}){let a=B(e);if(!a)throw Error("invalid_reference_kind");let r=C(t);if(!r||r.startsWith("system-"))throw Error("immutable_reference_item");let i=await eo(ea("settingsReference"),r);if(!i)return null;let n=B(i.kind);if(!n||n!==a||!0===i.isSystem)throw Error("immutable_reference_item");return eu(await es(ea("settingsReference"),r),a)}function ey(e,t,{base:a}={}){let r=S(),i=N(e?.email||a?.email);if(!i)throw Error("invalid_employee_email");let n=T(a?.governmentIds,{}),o=T(e?.governmentIds,{}),l={...n,...o},d=T(a?.payrollInformation,{}),c=T(e?.payrollInformation,{}),s={...d,...c},u=N(e?.managerEmail||a?.managerEmail),m=C(e?.contact,C(a?.contact,"-")),p=C(e?.address,C(a?.address,"-")),f=C(e?.emergencyContact,C(a?.emergencyContact,"-")),y=C(e?.govId,C(a?.govId,"Masked")),w=C(e?.firstName,C(a?.firstName,"")),v=C(e?.middleName,C(a?.middleName,"")),g=C(e?.lastName,C(a?.lastName,"")),E=C(e?.suffix,C(a?.suffix,"")),h=z({firstName:w,middleName:v,lastName:g,suffix:E,fallback:C(e?.name,C(a?.name,i))||i});l.primaryId||(l.primaryId=y);let A=Object.prototype.hasOwnProperty.call(T(e,{}),"documents")?O(e?.documents):null,_=Number(a?.documentsCount),b=Number.isFinite(_)?Math.max(0,_):O(a?.documents).length,I=A?A.length:b;return{employeeId:C(e?.employeeId,C(a?.employeeId,`CL-${Date.now().toString().slice(-6)}`)),name:h,firstName:w,middleName:v,lastName:g,suffix:E,email:i,role:C(e?.role,C(a?.role,"EMPLOYEE_L1")),department:C(e?.department,C(a?.department,"-")),jobTitle:C(e?.jobTitle,C(a?.jobTitle,"-")),managerEmail:u,hireDate:C(e?.hireDate,C(a?.hireDate,"")),employmentStatus:C(e?.employmentStatus,C(a?.employmentStatus,"Active Employee")),status:C(e?.status,C(a?.status,"Active")),governmentIds:l,govId:y,contact:m,address:p,emergencyContact:f,contactInformation:{primaryPhone:m,address:p,emergencyContact:f},payrollInformation:s,payrollGroup:C(e?.payrollGroup,C(a?.payrollGroup,"-")),documentsCount:I,classification:"Restricted PII",createdAt:C(a?.createdAt,r),createdBy:C(a?.createdBy,t),updatedAt:r,updatedBy:t,activityHistory:ee(a?.activityHistory,{at:r,by:t,action:a?"update":"create"})}}async function ew({ownerEmail:e,includeDocuments:t=!1}={}){let a=await en(ea("employees"),{filterField:e?"email":void 0,filterValue:e?N(e):void 0});return t?await Promise.all(a.map(async e=>{let t=await U(e);return H(e,t)})):a}async function ev(e,{includeDocuments:t=!0}={}){let a=await eo(ea("employees"),e);if(!a||!t)return a;let r=await U(a);if(0===r.length){let e=await V(a.email,a.updatedBy||a.createdBy);e.length>0&&(r=await q(a.id,e,{actorEmail:a.updatedBy||a.createdBy}),await Y(a.id,{documentsCount:r.length}))}return H(a,r)}async function eg(e,t){let a=ey(e,t),r=await el(ea("employees"),a),i=O(e?.documents);if(0===i.length)return H(r,[]);let n=await q(r.id,i,{actorEmail:t});return await Y(r.id,{documentsCount:n.length}),H(r,n)}async function eE(e,t,a){let r=await ev(e,{includeDocuments:!0});if(!r)return null;let i=Object.prototype.hasOwnProperty.call(T(t,{}),"documents")?O(t?.documents):null,n=ey(t,a,{base:r}),o=await ed(ea("employees"),e,n);if(!o)return null;if(i){let t=await q(e,i,{actorEmail:a});return await Y(e,{documentsCount:t.length}),H(o,t)}let l=await U(o);return H(o,l)}async function eh(e){return await F(e),await es(ea("employees"),e)}function eA(e,t,a,{base:r}={}){let i,n=S(),o=C(e?.category,C(r?.category,"Onboarding")),l=N(e?.employeeEmail||r?.employeeEmail);if(!l)throw Error("invalid_employee_email");let d=T(r?.details,{}),c=T(e?.details,{}),s={...d,...c},m=u[!(i=String(o||"").trim().toLowerCase())?"onboarding":i.includes("role")||i.includes("promotion")?"role-change":i.includes("disciplin")?"disciplinary":i.includes("offboard")||i.includes("resign")||i.includes("terminate")?"offboarding":(i.includes("onboard"),"onboarding")]||u.onboarding,p=T(r?.workflow,{}),f=T(e?.workflow,{}),y=function({template:e,baseWorkflow:t,requiredApprovers:a,atIso:r,actorEmail:i}){var n,o;let l,d,c=function(e,{atIso:t}){return O(e?.checklist).slice(0,32).map((e,a)=>{let r=C(e?.id,`task-${a+1}`),i=Number.parseInt(String(e?.slaHours||""),10);return{id:r,label:C(e?.label,r),required:e?.required!==!1,status:"Pending",dueAt:W(t,Number.isFinite(i)&&i>0?i:24),completedAt:"",completedBy:""}})}(e,{atIso:r}),s=(n=t?.checklist,l=new Map,O(n).forEach(e=>{let t=C(e?.id);t&&l.set(t,e)}),c.map(e=>{let t=l.get(e.id);return t?{...e,status:C(t.status,e.status),dueAt:C(t.dueAt,e.dueAt),completedAt:C(t.completedAt),completedBy:C(t.completedBy)}:e})),u=(o=t?.approvalChain,d=new Map,O(o).forEach(e=>{let t=X(e?.role);t&&d.set(t,e)}),a.map((e,t)=>{let a=d.get(e);return{order:t+1,role:e,status:C(a?.status,"Pending"),decidedAt:C(a?.decidedAt),decidedBy:C(a?.decidedBy),note:C(a?.note)}})),m=O(e?.stages).map(e=>C(e)).filter(Boolean),p=Q(t?.stageIndex??0,m.length),f=C(m[p],"Initiated"),y=ee(t?.stageHistory,{at:r,by:i,stage:f}),w=Z(s);return{type:C(e?.type,"onboarding"),stageIndex:p,stage:f,stages:m,checklist:s,stageHistory:y,approvalChain:u,approvalState:J(u),progress:w,slaDueAt:C(t?.slaDueAt,W(r,Number.parseInt(String(e?.slaHours||72),10))),slaBreached:!1,updatedAt:r}}({template:m,baseWorkflow:{...p,...f},requiredApprovers:[],atIso:n,actorEmail:t}),w=e?.workflowAction&&"object"==typeof e.workflowAction?e.workflowAction:null,v=function({workflow:e,evidence:t,action:a,actorEmail:r,atIso:i}){let n={...e,checklist:O(e.checklist).map(e=>({...e})),stageHistory:O(e.stageHistory).map(e=>({...e}))},o=O(t).map(e=>({...e})),l=L(a?.type);if(!l)return{workflow:n,evidence:o};if("toggle-task"===l){let e=C(a?.taskId);if(!e)throw Error("invalid_workflow_action");let t=!1;if(n.checklist=n.checklist.map(n=>{if(n.id!==e)return n;t=!0;let o=!!a?.completed;return{...n,status:o?"Completed":"Pending",completedAt:o?i:"",completedBy:o?r:""}}),!t)throw Error("invalid_workflow_action")}else if("set-stage"===l){let e=Q(a?.stageIndex,O(n.stages).length),t=C(n.stages?.[e],n.stage);n.stageIndex=e,n.stage=t,n.stageHistory=ee(n.stageHistory,{at:i,by:r,stage:t,action:"stage-update"})}else if("add-evidence"===l){let e=T(a?.evidence,null);if(!e)throw Error("invalid_workflow_action");o=[...o,{id:C(e.id,`evidence-${Date.now()}-${Math.random().toString(36).slice(2,8)}`),name:C(e.name,"Evidence File"),ref:C(e.ref),storagePath:C(e.storagePath),contentType:C(e.contentType),sizeBytes:Number.isFinite(Number(e.sizeBytes))?Number(e.sizeBytes):0,uploadedAt:C(e.uploadedAt,i),uploadedBy:C(e.uploadedBy,r),note:C(e.note)}].slice(-80)}else if("remove-evidence"===l){let e=C(a?.evidenceId);if(!e)throw Error("invalid_workflow_action");o=o.filter(t=>C(t?.id)!==e)}else throw Error("invalid_workflow_action");let d=Z(n.checklist);return n.progress=d,n.updatedAt=i,n.slaBreached=!!n.slaDueAt&&new Date(n.slaDueAt).getTime()<new Date(i).getTime()&&d.completedRequired<d.totalRequired,{workflow:n,evidence:o}}({workflow:y,evidence:O(r?.evidence),action:w,actorEmail:t,atIso:n}),g=Z(v.workflow.checklist);v.workflow.progress=g,v.workflow.slaBreached=!!v.workflow.slaDueAt&&new Date(v.workflow.slaDueAt).getTime()<new Date(n).getTime()&&g.completedRequired<g.totalRequired,v.workflow.approvalState=J(v.workflow.approvalChain);let E=C(e?.status,C(r?.status,"In Progress"));return{employeeEmail:l,employee:C(e?.employee,C(r?.employee,l||"Unknown Employee")),category:o,workflowType:C(m.type,"onboarding"),owner:C(e?.owner,C(r?.owner,"HR Operations")),details:s,evidence:v.evidence,workflow:v.workflow,status:E,createdAt:C(r?.createdAt,n),createdBy:C(r?.createdBy,t),updatedAt:n,updatedBy:t,traceability:ee(r?.traceability,{at:n,by:t,action:r?"update":"create",category:o,status:E,stage:v.workflow.stage,checklistProgress:v.workflow.progress.percent,approvalState:v.workflow.approvalState})}}async function e_(e,t,a){let n=N(e?.employeeEmail);if(!n)throw Error("invalid_employee_email");let o=await (0,r.getLoginAccount)(n).catch(()=>null);if("active"===C(o?.status).toLowerCase())return{type:"onboarding-invite-skipped",message:"User account is already active. Invite was not reissued.",accountStatus:"active"};let l=function(e){let t=T(e?.details,{}),a=C(t?.roleTo||t?.role||t?.roleFrom);if(!a)return"EMPLOYEE_L1";let r=R(a);return r&&(s.get(r)||r)||"EMPLOYEE_L1"}(e);K({actorRole:a,targetRole:l});let d=await (0,r.inviteUserAccount)({email:n,role:l,invitedBy:t}),c=function(e,t=!1){let a=String(process.env[e]||"").trim().toLowerCase();return a?"true"===a||"1"===a||"yes"===a:t}("CLIO_REQUIRE_EMAIL_DELIVERY",!0),u=null;try{u=await (0,i.deliverInviteEmail)({toEmail:d.user.email,role:d.user.role,invitedBy:t,expiresAt:d.invite.expiresAt,inviteToken:d.invite.token})}catch(a){let e,t=(e=String((a instanceof Error?a.message:"email_delivery_failed")||"").trim()).startsWith("email_delivery_failed:")?{code:"email_delivery_failed",providerMessage:e.slice(22).trim()}:{code:e||"email_delivery_failed",providerMessage:""};if(c)throw await (0,r.revokeInviteById)(d.invite.id).catch(()=>null),Error(t.code||"email_delivery_failed");u={provider:"unavailable",status:"failed",messageId:null,reason:t.code||"email_delivery_failed",providerMessage:t.providerMessage||null}}return{type:"onboarding-invite",message:u?.status==="failed"?"Onboarding invite was created. Email delivery failed in test mode.":"Onboarding invite sent. User can verify email and activate access.",inviteId:d.invite.id,inviteStatus:d.invite.status,role:d.user.role,deliveryProvider:u?.provider||"unknown",deliveryStatus:u?.status||"unknown"}}function eb(e){let t=T(e?.details,{}),a=C(t?.roleTo);if(!a)return"";let r=R(a);return s.get(r)||""}function eS(e,{actorEmail:t,archivedAt:a,reason:r,retentionDeleteAt:i,trailField:n}){let o={isArchived:!0,archivedAt:a,archivedBy:t,archiveReason:r,retentionDeleteAt:i,updatedAt:a,updatedBy:t};return n&&(o[n]=ee(e?.[n],{at:a,by:t,action:"archive",reason:r})),o}async function eI(e,t){let a=N(e?.employeeEmail);if(!a)throw Error("invalid_employee_email");let i=eb(e);if(!i)throw Error("invalid_target_role");K({actorRole:t,targetRole:i});let n=await (0,r.updateUserAccountRole)({userId:a,role:i});if(!n)throw Error("role_sync_failed");return n}async function eC(e,t,a){let r=N(e?.employeeEmail);if(!r)throw Error("invalid_employee_email");let i=eb(e);if(!i)throw Error("invalid_target_role");K({actorRole:a,targetRole:i});let n=T(e?.details,{}),o=C(n?.departmentTo),l=S();return await ec(ea("employees"),"email",r,e=>{let a={role:i,updatedAt:l,updatedBy:t,activityHistory:ee(e?.activityHistory,{at:l,by:t,action:"lifecycle-role-sync",role:i})};return o&&(a.department=o),a})}async function eL(e){let t=N(e);if(!t)throw Error("invalid_employee_email");let a=await (0,r.updateUserAccountStatus)({userId:t,status:"disabled"});if(!a)throw Error("employee_account_not_found");if("disabled"!==C(a.status).toLowerCase())throw Error("access_revocation_failed");return a}async function eN(e){let t=N(e);if(!t)throw Error("invalid_employee_email");let a=await (0,r.updateUserAccountStatus)({userId:t,status:"active"});if(!a)throw Error("employee_account_not_found");if("active"!==C(a.status).toLowerCase())throw Error("account_activation_failed");return a}async function eR(e,t){let a=N(e?.employeeEmail);if(!a)throw Error("invalid_employee_email");let r=T(e?.details,{}),i=C(r?.employeeId||r?.employeeNumber),n=C(r?.firstName),o=C(r?.middleName),l=C(r?.lastName),d=C(r?.suffix),c=C(r?.startDate),u=R(C(r?.roleTo||r?.role||r?.roleFrom)),m=s.get(u)||u||"EMPLOYEE_L1",p=C(r?.departmentTo||r?.department),f=z({firstName:n,middleName:o,lastName:l,suffix:d,fallback:C(e?.employee,a)}),y=S(),w=await ec(ea("employees"),"email",a,e=>{let a={status:"Active",employmentStatus:"Active Employee",isArchived:!1,updatedAt:y,updatedBy:t,activityHistory:ee(e?.activityHistory,{at:y,by:t,action:"lifecycle-onboarding-sync",status:"Active"})};return i&&(a.employeeId=i),n&&(a.firstName=n),o&&(a.middleName=o),l&&(a.lastName=l),d&&(a.suffix=d),f&&(a.name=f),p&&(a.department=p),a.role=m,c&&(a.hireDate=c),a});if(w>0)return w;let v=ey({employeeId:i,email:a,name:f,firstName:n,middleName:o,lastName:l,suffix:d,role:m||"EMPLOYEE_L1",department:p||"-",hireDate:c||"",status:"Active",employmentStatus:"Active Employee"},t);return await el(ea("employees"),v),1}async function eB(e,t){let a=N(e?.employeeEmail);if(!a)throw Error("invalid_employee_email");let i=S(),n=function(e,t){let a=new Date(e);if(Number.isNaN(a.getTime())){let e=new Date;return e.setUTCFullYear(e.getUTCFullYear()+t),e.toISOString()}return a.setUTCFullYear(a.getUTCFullYear()+t),a.toISOString()}(i,I()),o=function(e){let t=T(e?.details,{}),a=C(t?.offboardingReason||t?.reason||t?.note);if(a)return a;let r=C(e?.category),i=C(e?.status);return r||i?[r,i].filter(Boolean).join(" - "):"Resigned"}(e),l=await (0,r.archiveUserAccount)({userId:a,archivedBy:t,reason:o,retentionDeleteAt:n}),d=await ec(ea("employees"),"email",a,e=>({...eS(e,{actorEmail:t,archivedAt:i,reason:o,retentionDeleteAt:n,trailField:"activityHistory"}),status:"Archived",employmentStatus:"Resigned"})),c=await ec(ea("lifecycle"),"employeeEmail",a,e=>({...eS(e,{actorEmail:t,archivedAt:i,reason:o,retentionDeleteAt:n,trailField:"traceability"}),archiveStatus:"Archived"})),s=await ec(ea("attendance"),"employeeEmail",a,e=>({...eS(e,{actorEmail:t,archivedAt:i,reason:o,retentionDeleteAt:n,trailField:"modificationTrail"}),archiveStatus:"Archived"})),u=await ec(ea("leave"),"employeeEmail",a,e=>({...eS(e,{actorEmail:t,archivedAt:i,reason:o,retentionDeleteAt:n,trailField:"modificationTrail"}),archiveStatus:"Archived"})),m=await ec(ea("performance"),"employeeEmail",a,e=>({...eS(e,{actorEmail:t,archivedAt:i,reason:o,retentionDeleteAt:n,trailField:"traceability"}),archiveStatus:"Archived"})),p=await ec(ea("exports"),"requestedBy",a,e=>({...eS(e,{actorEmail:t,archivedAt:i,reason:o,retentionDeleteAt:n,trailField:"history"}),archiveStatus:"Archived"}));return{archivedAt:i,retentionDeleteAt:n,reason:o,userStatus:l?.status||"disabled",counts:{employees:d,lifecycle:c,attendance:s,leave:u,performance:m,exports:p}}}async function ek(e,t,a){let r,i,n,o,l,d,c,s,u,m,p,f,y,w,v=[];if(r=C(e?.category).toLowerCase(),i=C(e?.status).toLowerCase(),n=r.includes("onboarding"),o=i.includes("approved")||i.includes("completed"),n&&o){let a=await eN(e.employeeEmail),r=await eR(e,t);v.push({type:"onboarding-activation",message:"User account and employee profile activated.",accountStatus:a?.status||"active",employeeRecordsUpdated:r})}if(l=C(e?.category).toLowerCase(),d=C(e?.status).toLowerCase(),c=l.includes("role change")||l.includes("promotion"),s=d.includes("approved")||d.includes("completed"),c&&s){let r=await eC(e,t,a),i=await eI(e,a);v.push({type:"role-sync",message:`Role synchronized to ${i?.role||"target role"}.`,role:i?.role||null,employeeRecordsUpdated:r})}if(u=C(e?.category).toLowerCase(),m=C(e?.status).toLowerCase(),u.includes("offboarding")||m.includes("resign")||m.includes("terminated")||m.includes("access revoked")){let t=await eL(e.employeeEmail);v.push({type:"access-revocation",message:"User account access revoked.",accountStatus:t?.status||"disabled"})}if(p=C(e?.category).toLowerCase(),y=(f=C(e?.status).toLowerCase()).includes("resign")||f.includes("terminated")||f.includes("access revoked"),w=p.includes("offboarding")&&(f.includes("approved")||f.includes("completed")||f.includes("revoked")),y||w){let a=await eB(e,t);v.push({type:"archive-policy",message:`Employee data archived until ${a.retentionDeleteAt}.`,retentionDeleteAt:a.retentionDeleteAt,archivedAt:a.archivedAt,counts:a.counts})}return v}async function eD(){return await en(ea("lifecycle"))}async function eO(e){return await eo(ea("lifecycle"),e)}async function eT(e,t,a=""){let r=eA(e,t,a),i=[];if(C(r?.category).toLowerCase().includes("onboarding")){let e=await e_(r,t,a);e&&i.push(e)}let n=await ek(r,t,a);i.push(...n);let o=await el(ea("lifecycle"),{...r,lastAutomationEffects:i,lastAutomationAt:S(),lastAutomationBy:t});return await G(o,t).catch(()=>null),{record:o,effects:i}}async function eM(e,t,a,r=""){let i=await eO(e);if(!i)return null;let n=eA(t,a,r,{base:i}),o=await ek(n,a,r),l=await ed(ea("lifecycle"),e,{...n,lastAutomationEffects:o,lastAutomationAt:S(),lastAutomationBy:a});return await G(l,a).catch(()=>null),{record:l,effects:o}}async function eP(e,t,a,r=""){return await eM(e,{category:"Offboarding",status:"Access Revoked",details:{offboardingReason:C(a,"Resignation")}},t,r)}function ex(e,t,{base:a}={}){let r=S(),i=N(e?.employeeEmail||a?.employeeEmail);if(!i)throw Error("invalid_employee_email");let n={employeeEmail:i,employee:C(e?.employee,C(a?.employee,i)),date:C(e?.date,C(a?.date,r.slice(0,10))),checkIn:C(e?.checkIn,C(a?.checkIn,"-")),checkOut:C(e?.checkOut,C(a?.checkOut,"-")),status:C(e?.status,C(a?.status,"Recorded")),reason:C(e?.reason,C(a?.reason,"")),createdAt:C(a?.createdAt,r),createdBy:C(a?.createdBy,t),updatedAt:r,updatedBy:t};return n.modificationTrail=ee(a?.modificationTrail,{at:r,by:t,action:a?"update":"create",status:n.status,checkIn:n.checkIn,checkOut:n.checkOut,reason:n.reason}),n}function eF(e,t,{base:a}={}){let r=S(),i=N(e?.employeeEmail||a?.employeeEmail);if(!i)throw Error("invalid_employee_email");let n=C(e?.status,C(a?.status,"Pending")),o={employeeEmail:i,employee:C(e?.employee,C(a?.employee,i)),leaveType:C(e?.leaveType,C(a?.leaveType,"Leave")),startDate:C(e?.startDate,C(a?.startDate,"")),endDate:C(e?.endDate,C(a?.endDate,"")),reason:C(e?.reason,C(a?.reason,"")),status:n,approver:C(e?.approver,C(a?.approver,"")),approvalNote:C(e?.approvalNote,C(a?.approvalNote,"")),createdAt:C(a?.createdAt,r),createdBy:C(a?.createdBy,t),updatedAt:r,updatedBy:t};return o.modificationTrail=ee(a?.modificationTrail,{at:r,by:t,action:a?"update":"create",status:n,leaveType:o.leaveType}),o}async function eq({ownerEmail:e}={}){return await en(ea("attendance"),{filterField:e?"employeeEmail":void 0,filterValue:e?N(e):void 0})}async function eH(e){return await eo(ea("attendance"),e)}async function eU(e,t){let a=ex(e,t);return await el(ea("attendance"),a)}async function eY(e,t,a){let r=await eH(e);if(!r)return null;let i=ex(t,a,{base:r});return await ed(ea("attendance"),e,i)}async function ej({ownerEmail:e}={}){return await en(ea("leave"),{filterField:e?"employeeEmail":void 0,filterValue:e?N(e):void 0})}async function e$(e){return await eo(ea("leave"),e)}async function eG(e,t){let a=eF(e,t);return await el(ea("leave"),a)}async function eV(e,t,a){let r=await e$(e);if(!r)return null;let i=eF(t,a,{base:r});return await ed(ea("leave"),e,i)}function ez(e,t,{base:a}={}){let r=S(),i=N(e?.employeeEmail||a?.employeeEmail);if(!i)throw Error("invalid_employee_email");return{employeeEmail:i,employee:C(e?.employee,C(a?.employee,i)),period:C(e?.period,C(a?.period,"")),kpiScore:C(e?.kpiScore,C(a?.kpiScore,"")),evaluationForm:e?.evaluationForm??a?.evaluationForm??{},reviewHistory:O(e?.reviewHistory??a?.reviewHistory),promotionJustification:C(e?.promotionJustification,C(a?.promotionJustification,"")),reviewer:C(e?.reviewer,C(a?.reviewer,"")),rating:C(e?.rating,C(a?.rating,"")),status:C(e?.status,C(a?.status,"Draft")),createdAt:C(a?.createdAt,r),createdBy:C(a?.createdBy,t),updatedAt:r,updatedBy:t,traceability:ee(a?.traceability,{at:r,by:t,action:a?"update":"create",period:C(e?.period,C(a?.period,""))})}}async function eW({ownerEmail:e}={}){return await en(ea("performance"),{filterField:e?"employeeEmail":void 0,filterValue:e?N(e):void 0})}async function eX(e){return await eo(ea("performance"),e)}async function eJ(e,t){let a=ez(e,t);return await el(ea("performance"),a)}async function eZ(e,t,a){let r=await eX(e);if(!r)return null;let i=ez(t,a,{base:r});return await ed(ea("performance"),e,i)}function eQ(e,t,{base:a}={}){let r=S(),i=C(e?.version,C(a?.version,"v1.0")),n=C(e?.templateName,C(a?.templateName));if(!n)throw Error("invalid_template_name");let o=a?{version:C(a.version,"v1.0"),changedAt:r,changedBy:t,note:C(e?.changeNote,"Template updated")}:null,l=O(a?.versionHistory),d=o?ee(l,o):l,c=ee(a?.modificationLog,{at:r,by:t,action:a?"update":"upload",version:i});return{templateName:n,category:C(e?.category,C(a?.category,"HR Template")),classification:C(e?.classification,C(a?.classification,"Restricted PII")),documentType:C(e?.documentType,C(a?.documentType,"Template")),tags:O(e?.tags??a?.tags),version:i,status:C(e?.status,C(a?.status,"Active")),contentRef:C(e?.contentRef,C(a?.contentRef,"")),acknowledgments:O(e?.acknowledgments??a?.acknowledgments),usageLogs:O(e?.usageLogs??a?.usageLogs),versionHistory:d,modificationLog:c,createdAt:C(a?.createdAt,r),createdBy:C(a?.createdBy,t),updatedAt:r,updatedBy:t}}async function eK(){return await en(ea("templates"))}async function e0(e){return await eo(ea("templates"),e)}async function e1(e,t){let a=eQ(e,t);return await el(ea("templates"),a)}async function e2(e,t,a){let r=await e0(e);if(!r)return null;let i=eQ(t,a,{base:r});return await ed(ea("templates"),e,i)}async function e3(e,t){let a=await e0(e);return a?await ed(ea("templates"),e,{...a,status:"Archived",archivedAt:S(),archivedBy:t,updatedAt:S(),updatedBy:t,modificationLog:ee(a.modificationLog,{at:S(),by:t,action:"archive",version:C(a.version,"v1.0")})}):null}function e8(e,t,{base:a}={}){let r=S(),i=C(e?.dataset,C(a?.dataset,"Employee Dataset"));if(!i)throw Error("invalid_export_dataset");let n=C(e?.format,C(a?.format,"CSV")).toUpperCase(),o=N(e?.requestedBy||a?.requestedBy||t),l=C(e?.scope,C(a?.scope,"full")),d=C(e?.status,C(a?.status,"Pending"));return{dataset:i,format:n,requestedBy:o,scope:l,estimateVolume:C(e?.estimateVolume,C(a?.estimateVolume,"0")),justification:C(e?.justification,C(a?.justification)),status:d,reviewer:C(e?.reviewer,C(a?.reviewer,"")),reviewNote:C(e?.reviewNote,C(a?.reviewNote,"")),reviewedAt:C(e?.reviewedAt,C(a?.reviewedAt,"")),exportedAt:C(e?.exportedAt,C(a?.exportedAt,"")),exportedBy:C(e?.exportedBy,C(a?.exportedBy,"")),alert:C(e?.alert,C(a?.alert,"")),createdAt:C(a?.createdAt,r),createdBy:C(a?.createdBy,t),updatedAt:r,updatedBy:t,history:ee(a?.history,{at:r,by:t,action:a?"update":"create",status:d})}}async function e4({ownerEmail:e}={}){return await en(ea("exports"),{filterField:e?"requestedBy":void 0,filterValue:e?N(e):void 0})}async function e6(e){return await eo(ea("exports"),e)}async function e5(e,t){let a=e8(e,t);return await el(ea("exports"),a)}async function e7(e,t,a){let r=await e6(e);if(!r)return null;let i=e8(t,a,{base:r});return await ed(ea("exports"),e,i)}async function e9(e,t,{approved:a,note:r}={}){return await e7(e,{status:a?"Approved":"Rejected",reviewer:t,reviewNote:C(r,""),reviewedAt:S()},t)}async function te(e,t){return await e7(e,{status:"Exported",exportedBy:t,exportedAt:S()},t)}function tt(e,t="Medium"){let a=C(e,t).toLowerCase();return y.find(e=>e.toLowerCase()===a)||"Medium"}function ta(e){switch(tt(e)){case"Critical":return 3;case"High":return 2;case"Medium":return 1;default:return 0}}async function tr(e,{limit:t}={}){let a=S(),r=tf(e?.forensicWindowStart||e?.detectedAt)||a,i=tf(e?.forensicWindowEnd||a)||a,n=tp(r)||0,l=tp(i)||Date.now(),d=N(e?.affectedEmployeeEmail||e?.employeeEmail||""),c=Number.isFinite(Number(t))?Number(t):1800,s=[];try{s=await (0,o.listAuditEvents)({limit:Math.max(100,Math.min(5e3,c))})}catch{s=[]}let u=s.filter(e=>{let t=tp(e?.occurredAt||e?.loggedAt);if(!Number.isFinite(t)||t<n||t>l)return!1;let a=N(d);if(!a)return!0;let r=T(e?.metadata,{});return[e?.performedBy,e?.performedByEmail,r.employeeEmail,r.ownerEmail,r.requestedBy,r.targetEmployeeEmail,r.affectedEmployeeEmail].some(e=>N(e)===a)}),m=[],p=[],f=[],y=[];return u.forEach(e=>{let t,a,r,i,n,o,l,d,c,s,u={id:C(e?.id),activityName:C(e?.activityName),module:C(e?.module),status:C(e?.status),occurredAt:C(e?.occurredAt),performedBy:C(e?.performedBy),requestMethod:C(e?.requestMethod),requestPath:C(e?.requestPath)};(t=L(e?.requestMethod),a=L(e?.activityName),"delete"===t||a.includes("delete")||a.includes("purge")||a.includes("removed")||a.includes("archive"))?y.push(u):(r=L(e?.module),i=L(e?.requestPath),n=L(e?.activityName),r.includes("export")||i.includes("/api/hris/exports")||n.includes("export"))?p.push(u):(o=L(e?.module),l=L(e?.requestMethod),d=L(e?.activityName),o.includes("authorization")||o.includes("user management")||o.includes("access management")||"patch"===l||"post"===l||d.includes("approve")||d.includes("revok")||d.includes("invite")||d.includes("role"))?f.push(u):(c=L(e?.requestMethod),s=L(e?.activityName),("get"===c||s.includes("viewed")||s.includes("listed")||s.includes("access"))&&m.push(u))}),{generatedAt:a,windowStart:r,windowEnd:i,scopedSubjectEmail:d||"",totalScopedLogs:u.length,accessLogsCount:m.length,exportLogsCount:p.length,administrativeActionsCount:f.length,deletionActivitiesCount:y.length,accessLogs:m.slice(0,8),exportLogs:p.slice(0,8),administrativeActions:f.slice(0,8),deletionActivities:y.slice(0,8)}}function ti(e,t,{base:a}={}){var r;let i,n,o=S(),l=C(e?.title,C(a?.title));if(!l)throw Error("invalid_incident_title");let d=tf(e?.detectedAt||a?.detectedAt||o)||o,c=tt(e?.severity,C(a?.severity,"Medium")),s=function(e,t="Other"){let a=C(e,t).toLowerCase();return E.find(e=>e.toLowerCase()===a)||"Other"}(e?.incidentType,C(a?.incidentType,"Other")),u=M(e?.restrictedPiiInvolved,M(a?.restrictedPiiInvolved,!1)),m=M(e?.executiveNotificationRequired,"Critical"===c||M(a?.executiveNotificationRequired,!1)),p=M(e?.escalationRequired,m||u||ta(c)>=ta("High")||M(a?.escalationRequired,!1)),f=function({severity:e,restrictedPiiInvolved:t,executiveNotificationRequired:a}){return"Critical"===e||a?"Executive":"High"===e||t?"GRC":"Operational"}({severity:c,restrictedPiiInvolved:u,executiveNotificationRequired:m}),y=function(e,t="Open"){let a=C(e,t).toLowerCase();return w.find(e=>e.toLowerCase()===a)||"Open"}(e?.status,C(a?.status,"Open")),_=function(e,t="Not Started"){let a=C(e,t).toLowerCase();return v.find(e=>e.toLowerCase()===a)||"Not Started"}(e?.containmentStatus,C(a?.containmentStatus,"Not Started")),I=function(e,t="Pending"){let a=C(e,t).toLowerCase();return g.find(e=>e.toLowerCase()===a)||"Pending"}(e?.impactAssessmentStatus,C(a?.impactAssessmentStatus,"Pending")),R=M(e?.regulatoryNotificationRequired,u||M(a?.regulatoryNotificationRequired,!1)),B=R?C(a?.regulatoryDueAt,W(d,72)):"",k=tf(e?.regulatoryNotifiedAt||a?.regulatoryNotifiedAt||""),D=tf(e?.affectedIndividualsNotifiedAt||a?.affectedIndividualsNotifiedAt||""),P=function({regulatoryNotificationRequired:e,regulatoryNotifiedAt:t,regulatoryDueAt:a,nowIsoValue:r=S()}){if(!e)return"Not Required";if(tp(t))return"Notified";let i=tp(a),n=tp(r)||Date.now();return Number.isFinite(i)&&i<n?"Overdue":"Pending"}({regulatoryNotificationRequired:R,regulatoryNotifiedAt:k,regulatoryDueAt:B,nowIsoValue:o}),x=M(e?.documentationRetained,M(a?.documentationRetained,!1)),F=x?tf(e?.documentationRetainedAt||a?.documentationRetainedAt||o)||o:"",q=tf(e?.executiveNotifiedAt||a?.executiveNotifiedAt||""),H=p?tf(e?.grcAlertedAt||a?.grcAlertedAt||o)||o:"",U="In Progress"===_||"Contained"===_?tf(e?.containmentStartedAt||a?.containmentStartedAt||o)||o:tf(e?.containmentStartedAt||a?.containmentStartedAt||""),Y="Contained"===_?tf(e?.containmentCompletedAt||a?.containmentCompletedAt||o)||o:tf(e?.containmentCompletedAt||a?.containmentCompletedAt||""),j="Completed"===I?tf(e?.impactAssessmentCompletedAt||a?.impactAssessmentCompletedAt||o)||o:tf(e?.impactAssessmentCompletedAt||a?.impactAssessmentCompletedAt||""),$=tf(e?.forensicWindowStart||a?.forensicWindowStart||d)||d,G=tf(e?.forensicWindowEnd||a?.forensicWindowEnd||o)||o,V=(r=Object.prototype.hasOwnProperty.call(T(e,{}),"evidenceDocuments")?e?.evidenceDocuments:a?.evidenceDocuments,i=C(o,S()),n={maxBytes:function(e,t,{min:a=1,max:r=Number.MAX_SAFE_INTEGER}={}){let i=Number.parseInt(String(process.env[e]||"").trim(),10);return Number.isFinite(i)?Math.min(r,Math.max(a,i)):0xa00000}("CLIO_INCIDENT_EVIDENCE_MAX_BYTES",0,{min:131072,max:0x3200000}),allowedExtensions:b(process.env.CLIO_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS,h),allowedMimeTypes:b(process.env.CLIO_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES,A)},O(r).map((e,a)=>{let r=T(e,{}),o=tf(r.uploadedAt||i)||i,l=N(r.uploadedBy||t),d=C(r.name,`Incident Evidence ${a+1}`),c=C(r.type,"Incident Evidence"),s=C(r.ref),u=C(r.storagePath),m=function(e){let t=C(e).toLowerCase();if(!t)return"";let a=t.split("?")[0].split("#")[0].split(".").pop()||"";return/^[a-z0-9]{2,10}$/.test(a)?a:""}(r.fileExtension||d||u||s),p=L(r.contentType),f=Number.isFinite(Number(r.sizeBytes))?Number(r.sizeBytes):0,y=C(r.id||r.recordId||u||`${a+1}`);if(!d&&!s&&!u)return null;if(m&&!n.allowedExtensions.has(m))throw Error("invalid_incident_evidence_extension");if(p&&!n.allowedMimeTypes.has(p))throw Error("invalid_incident_evidence_content_type");if(f>n.maxBytes)throw Error("invalid_incident_evidence_size");return{id:y,name:d||"Incident Evidence",type:c||"Incident Evidence",ref:s,storagePath:u,fileExtension:m,contentType:p,sizeBytes:f,scanStatus:C(r.scanStatus),scanReference:C(r.scanReference),scannedAt:tf(r.scannedAt||""),uploadedAt:o,uploadedBy:l||t}}).filter(Boolean).slice(0,50)),z=tf(e?.detectionWindowStart||a?.detectionWindowStart||""),X=tf(e?.detectionWindowEnd||a?.detectionWindowEnd||""),J=O(e?.alertRecipients||a?.alertRecipients).map(e=>N(e)).filter(Boolean).slice(0,40);return{incidentCode:C(a?.incidentCode,function(e=S()){let t=new Date(e||S());if(Number.isNaN(t.getTime()))return`INC-${Date.now().toString().slice(-10)}`;let a=String(t.getUTCFullYear()),r=String(t.getUTCMonth()+1).padStart(2,"0"),i=String(t.getUTCDate()).padStart(2,"0"),n=String(t.getUTCHours()).padStart(2,"0"),o=String(t.getUTCMinutes()).padStart(2,"0"),l=Math.random().toString(36).slice(2,5).toUpperCase();return`INC-${a}${r}${i}-${n}${o}${l}`}(d)),title:l,summary:C(e?.summary,C(a?.summary)),incidentType:s,severity:c,status:y,restrictedPiiInvolved:u,affectedEmployeeEmail:N(e?.affectedEmployeeEmail||a?.affectedEmployeeEmail),ownerEmail:N(e?.ownerEmail||a?.ownerEmail||t),escalationRequired:p,escalationLevel:f,executiveNotificationRequired:m,executiveNotifiedAt:q,grcAlertedAt:H,containmentStatus:_,containmentSummary:C(e?.containmentSummary,C(a?.containmentSummary)),containmentStartedAt:U,containmentCompletedAt:Y,impactAssessmentStatus:I,impactSummary:C(e?.impactSummary,C(a?.impactSummary)),impactAssessmentCompletedAt:j,regulatoryNotificationRequired:R,regulatoryDueAt:B,regulatoryNotifiedAt:k,affectedIndividualsNotifiedAt:D,regulatoryStatus:P,documentationRetained:x,documentationRetainedAt:F,documentationLocation:C(e?.documentationLocation,C(a?.documentationLocation)),forensicWindowStart:$,forensicWindowEnd:G,evidenceDocuments:V,evidenceDocumentsCount:V.length,notes:C(e?.notes,C(a?.notes)),classificationStandard:C(e?.classificationStandard,C(a?.classificationStandard,"CLIO-IR-SEVERITY-V1")),autoGenerated:M(e?.autoGenerated,M(a?.autoGenerated,!1)),detectionRuleId:C(e?.detectionRuleId,C(a?.detectionRuleId)),detectionFingerprint:C(e?.detectionFingerprint,C(a?.detectionFingerprint)),detectionWindowStart:z,detectionWindowEnd:X,sourceSystem:C(e?.sourceSystem,C(a?.sourceSystem)),sourceEventId:C(e?.sourceEventId,C(a?.sourceEventId)),sourceEventModule:C(e?.sourceEventModule,C(a?.sourceEventModule)),sourceEventPath:C(e?.sourceEventPath,C(a?.sourceEventPath)),sourceIp:C(e?.sourceIp,C(a?.sourceIp)),alertRecipients:J,alertDispatchSummary:T(e?.alertDispatchSummary,T(a?.alertDispatchSummary,{})),externalIntegrations:T(e?.externalIntegrations,T(a?.externalIntegrations,{})),lastAlertDispatchAt:tf(e?.lastAlertDispatchAt||a?.lastAlertDispatchAt||""),detectedAt:d,resolvedAt:tf(e?.resolvedAt||a?.resolvedAt||("Resolved"===y?o:"")),closedAt:tf(e?.closedAt||a?.closedAt||("Closed"===y?o:"")),createdAt:C(a?.createdAt,o),createdBy:C(a?.createdBy,t),updatedAt:o,updatedBy:t,traceability:ee(a?.traceability,{at:o,by:t,action:a?"update":"create",status:y,severity:c,escalationLevel:f,regulatoryStatus:P})}}function tn(e,t,a){let r=T(t,{});return{...e,forensicSnapshot:r,forensicSummary:{accessLogsCount:Number(r.accessLogsCount||0),exportLogsCount:Number(r.exportLogsCount||0),administrativeActionsCount:Number(r.administrativeActionsCount||0),deletionActivitiesCount:Number(r.deletionActivitiesCount||0),totalScopedLogs:Number(r.totalScopedLogs||0),generatedAt:C(r.generatedAt),windowStart:C(r.windowStart),windowEnd:C(r.windowEnd)},forensicLastUpdatedAt:C(r.generatedAt,S()),forensicLastUpdatedBy:a}}async function to(){return await en(ea("incidents"))}async function tl(e){return await eo(ea("incidents"),e)}async function td(e,t){let a=ti(e,t),r=await tr(a,{limit:Number.parseInt(_("CLIO_INCIDENT_FORENSIC_LOG_LIMIT","1800"),10)}),i=tn(a,r,t);return await el(ea("incidents"),i)}async function tc(e,t,a){let r=await tl(e);if(!r)return null;let i=ti(t,a,{base:r}),n=M(t?.refreshForensicSnapshot,!1)||Object.prototype.hasOwnProperty.call(T(t,{}),"forensicWindowStart")||Object.prototype.hasOwnProperty.call(T(t,{}),"forensicWindowEnd")||Object.prototype.hasOwnProperty.call(T(t,{}),"affectedEmployeeEmail")||Object.prototype.hasOwnProperty.call(T(t,{}),"detectedAt")?await tr(i,{limit:Number.parseInt(_("CLIO_INCIDENT_FORENSIC_LOG_LIMIT","1800"),10)}):T(r.forensicSnapshot,{}),o=tn(i,n,a);return await ed(ea("incidents"),e,o)}async function ts(e,a){let r=ei(),i=await (0,t.getDocs)((0,t.query)((0,t.collection)(r,e),(0,t.where)("retentionDeleteAt","<=",a))),n=0;for(let a of i.docs)await (0,t.deleteDoc)((0,t.doc)(r,e,a.id)),n+=1;return n}async function tu(e){let a=ei(),r=ea("employees"),i=await (0,t.getDocs)((0,t.query)((0,t.collection)(a,r),(0,t.where)("retentionDeleteAt","<=",e))),n=0;for(let e of i.docs)await F(e.id,{db:a}),await (0,t.deleteDoc)((0,t.doc)(a,r,e.id)),n+=1;return n}async function tm({now:e}={}){let t=C(e,S()),a={employees:await tu(t),lifecycle:await ts(ea("lifecycle"),t),attendance:await ts(ea("attendance"),t),leave:await ts(ea("leave"),t),performance:await ts(ea("performance"),t),exports:await ts(ea("exports"),t)},i=await (0,r.purgeDueArchivedUserAccounts)({now:t});return{cutoff:t,deletedByCollection:a,deletedUsers:i}}function tp(e){let t=new Date(e||"").getTime();return Number.isNaN(t)?null:t}function tf(e){let t=tp(e);return Number.isFinite(t)?new Date(t).toISOString():""}async function ty({moduleId:e="all",status:t="all",queryText:a="",dueWithinDays:i=30,now:n}={}){let o,l=L(e)||"all",d=L(t)||"all",c=L(a),s=I(),u=function(e,t,{min:a=0,max:r=Number.MAX_SAFE_INTEGER}={}){let i=Number.parseInt(String(e??""),10);return Number.isFinite(i)?Math.min(r,Math.max(a,i)):30}(i,0,{min:1,max:365}),m=tf(n)||S(),p=tp(m)||Date.now(),f=24*u*36e5,y=[{id:"employees",label:"Employee Records",loader:()=>ew()},{id:"lifecycle",label:"Employment Lifecycle",loader:()=>eD()},{id:"attendance",label:"Attendance",loader:()=>eq()},{id:"leave",label:"Leave Requests",loader:()=>ej()},{id:"performance",label:"Performance",loader:()=>eW()},{id:"exports",label:"Reports & Exports",loader:()=>e4()},{id:"user_accounts",label:"User Accounts",loader:()=>(0,r.listUserAccounts)()}],w=new Set(y.map(e=>e.id));if("all"!==l&&!w.has(l))throw Error("invalid_retention_module");let v=new Set(["all","due","due_soon","scheduled","no_retention"]).has(d)?d:"all",g=(await Promise.all(y.map(async e=>{let t=await e.loader();return{...e,rows:Array.isArray(t)?t:[]}}))).flatMap(e=>e.rows.map(t=>(function({moduleId:e,moduleLabel:t,row:a,nowMs:r,dueWithinMs:i}){var n,o,l;let d,c=tf(a?.archivedAt),s=tf(a?.retentionDeleteAt),u=L(a?.status),m=L(a?.archiveStatus);if(!(a?.isArchived||c||s||"archived"===u||"archived"===m))return null;let p=C(a?.recordId,C(a?.id)),f=function(e,t,a){let r=tp(e);if(!Number.isFinite(r))return{state:"no_retention",daysToDeletion:null};let i=Math.ceil((r-t)/864e5);return r<=t?{state:"due",daysToDeletion:i}:r<=t+a?{state:"due_soon",daysToDeletion:i}:{state:"scheduled",daysToDeletion:i}}(s,r,i),y=(n=e,o=a,l=t,d=C(o?.recordId,C(o?.id)),"employees"===n?C(o?.name,C(o?.employeeId,C(o?.email,d||`${l} Record`))):"lifecycle"===n?[C(o?.employee,C(o?.employeeEmail))||"Employee",C(o?.category)].filter(Boolean).join(" - "):"attendance"===n?[C(o?.employee,"Employee"),C(o?.date)].filter(Boolean).join(" - "):"leave"===n?[C(o?.employee,"Employee"),C(o?.leaveType,"Leave")].filter(Boolean).join(" - "):"performance"===n?[C(o?.employee,"Employee"),C(o?.period,"Performance")].filter(Boolean).join(" - "):"exports"===n?[C(o?.dataset,"Export Request"),C(o?.format)].filter(Boolean).join(" - "):"user_accounts"===n?C(o?.email,d||"User Account"):C(o?.name,C(o?.employee,C(o?.dataset,C(o?.email,d||`${l} Record`))))),w=N(a?.employeeEmail||a?.email||a?.requestedBy||a?.ownerEmail),v=[C(a?.employeeId),w,C(a?.department),C(a?.category)].filter(Boolean);return{id:`${e}:${p||Math.random().toString(36).slice(2,10)}`,moduleId:e,moduleLabel:t,recordId:p||"",title:y,subtitle:v.join(" | "),ownerEmail:w||"",status:C(a?.status,C(a?.archiveStatus,"Archived")),archiveReason:C(a?.archiveReason,C(a?.reason,C(a?.reviewNote,""))),archivedAt:c,retentionDeleteAt:s,daysToDeletion:f.daysToDeletion,deletionState:f.state,updatedAt:tf(a?.updatedAt)}})({moduleId:e.id,moduleLabel:e.label,row:t,nowMs:p,dueWithinMs:f})).filter(Boolean)),E="all"===l?g:g.filter(e=>e.moduleId===l),h=E.filter(e=>{let t="all"===v||e.deletionState===v,a=L([e.moduleLabel,e.recordId,e.title,e.subtitle,e.ownerEmail,e.archiveReason].join(" ")),r=!c||a.includes(c);return t&&r});return{policy:{retentionYears:s,dueWithinDays:u,generatedAt:m,moduleCatalog:y.map(e=>({id:e.id,label:e.label}))},summary:function(e,{moduleCatalog:t,nowMs:a,dueWithinDays:r}){let i={due:0,dueSoon:0,scheduled:0,noRetention:0},n=t.map(e=>({id:e.id,label:e.label,count:0})),o=new Map(n.map(e=>[e.id,e])),l="",d="";return e.forEach(e=>{"due"===e.deletionState?i.due+=1:"due_soon"===e.deletionState?i.dueSoon+=1:"scheduled"===e.deletionState?i.scheduled+=1:i.noRetention+=1;let t=o.get(e.moduleId);t&&(t.count+=1),e.retentionDeleteAt&&(!l||tp(e.retentionDeleteAt)<tp(l))&&(l=e.retentionDeleteAt),e.archivedAt&&(!d||tp(e.archivedAt)<tp(d))&&(d=e.archivedAt)}),{generatedAt:new Date(a).toISOString(),totalArchived:e.length,dueNow:i.due,dueWithinWindow:i.due+i.dueSoon,scheduledFuture:i.scheduled,missingRetentionDate:i.noRetention,nextDeletionAt:l||null,oldestArchivedAt:d||null,dueWithinDays:r,moduleBreakdown:n.sort((e,t)=>t.count-e.count)}}(E,{moduleCatalog:y,nowMs:p,dueWithinDays:u}),records:(o={due:0,due_soon:1,scheduled:2,no_retention:3},[...h].sort((e,t)=>{let a=o[e.deletionState]??9,r=o[t.deletionState]??9;if(a!==r)return a-r;let i=tp(e.retentionDeleteAt),n=tp(t.retentionDeleteAt);return Number.isFinite(i)&&Number.isFinite(n)&&i!==n?i-n:Number.isFinite(i)&&!Number.isFinite(n)?-1:!Number.isFinite(i)&&Number.isFinite(n)?1:(tp(t.archivedAt)||0)-(tp(e.archivedAt)||0)}))}}e.s(["approveExportRequestBackend",()=>e9,"createAttendanceLogBackend",()=>eU,"createDocumentTemplateBackend",()=>e1,"createEmployeeRecordBackend",()=>eg,"createExportRequestBackend",()=>e5,"createIncidentRecordBackend",()=>td,"createLeaveRequestBackend",()=>eG,"createLifecycleRecordBackend",()=>eT,"createPerformanceRecordBackend",()=>eJ,"createSettingsReferenceItemBackend",()=>ep,"deleteDocumentTemplateBackend",()=>e3,"deleteEmployeeRecordBackend",()=>eh,"deleteSettingsReferenceItemBackend",()=>ef,"forceOffboardLifecycleRecordBackend",()=>eP,"getAttendanceLogBackend",()=>eH,"getDocumentTemplateBackend",()=>e0,"getEmployeeRecordBackend",()=>ev,"getExportRequestBackend",()=>e6,"getIncidentRecordBackend",()=>tl,"getLeaveRequestBackend",()=>e$,"getLifecycleRecordBackend",()=>eO,"getPerformanceRecordBackend",()=>eX,"listAttendanceLogsBackend",()=>eq,"listDocumentTemplatesBackend",()=>eK,"listEmployeeRecordsBackend",()=>ew,"listExportRequestsBackend",()=>e4,"listIncidentRecordsBackend",()=>to,"listLeaveRequestsBackend",()=>ej,"listLifecycleRecordsBackend",()=>eD,"listPerformanceRecordsBackend",()=>eW,"listRetentionArchiveSnapshotBackend",()=>ty,"listSettingsReferenceCatalogBackend",()=>em,"markExportAsCompletedBackend",()=>te,"purgeArchivedEmployeeDataBackend",()=>tm,"updateAttendanceLogBackend",()=>eY,"updateDocumentTemplateBackend",()=>e2,"updateEmployeeRecordBackend",()=>eE,"updateExportRequestBackend",()=>e7,"updateIncidentRecordBackend",()=>tc,"updateLeaveRequestBackend",()=>eV,"updateLifecycleRecordBackend",()=>eM,"updatePerformanceRecordBackend",()=>eZ])}];

//# sourceMappingURL=src_lib_hris-backend_4dbd0cdd.js.map