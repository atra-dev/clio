{"version":3,"sources":["../../../src/lib/api-rate-limit.js"],"sourcesContent":["const GLOBAL_BUCKET_KEY = \"__clio_rate_limit_buckets__\";\nconst MAX_BUCKETS = 5000;\n\nfunction getBuckets() {\n  if (!globalThis[GLOBAL_BUCKET_KEY]) {\n    globalThis[GLOBAL_BUCKET_KEY] = new Map();\n  }\n  return globalThis[GLOBAL_BUCKET_KEY];\n}\n\nfunction nowMs() {\n  return Date.now();\n}\n\nfunction cleanupExpiredBuckets(buckets, currentMs) {\n  if (buckets.size <= MAX_BUCKETS) {\n    return;\n  }\n\n  for (const [key, value] of buckets.entries()) {\n    if (!value || currentMs >= value.resetAt) {\n      buckets.delete(key);\n    }\n  }\n\n  if (buckets.size <= MAX_BUCKETS) {\n    return;\n  }\n\n  let removeCount = buckets.size - MAX_BUCKETS;\n  for (const key of buckets.keys()) {\n    buckets.delete(key);\n    removeCount -= 1;\n    if (removeCount <= 0) {\n      break;\n    }\n  }\n}\n\nfunction normalizeIdentifier(value) {\n  return String(value || \"\")\n    .trim()\n    .toLowerCase();\n}\n\nexport function getRequestSourceIp(request) {\n  if (!request || !request.headers) {\n    return \"unknown\";\n  }\n\n  const forwardedFor = request.headers.get(\"x-forwarded-for\");\n  if (forwardedFor) {\n    const firstIp = forwardedFor.split(\",\")[0]?.trim();\n    if (firstIp) {\n      return firstIp;\n    }\n  }\n\n  const candidates = [\"x-real-ip\", \"cf-connecting-ip\", \"x-vercel-forwarded-for\"];\n  for (const headerName of candidates) {\n    const value = String(request.headers.get(headerName) || \"\").trim();\n    if (value) {\n      return value;\n    }\n  }\n\n  return \"unknown\";\n}\n\nexport function consumeRateLimit({\n  scope,\n  identifier,\n  limit = 20,\n  windowMs = 5 * 60 * 1000,\n}) {\n  const safeScope = String(scope || \"default\")\n    .trim()\n    .toLowerCase();\n  const safeIdentifier = normalizeIdentifier(identifier) || \"unknown\";\n  const safeLimit = Math.max(1, Number.parseInt(String(limit), 10) || 1);\n  const safeWindowMs = Math.max(1000, Number.parseInt(String(windowMs), 10) || 1000);\n\n  const buckets = getBuckets();\n  const currentMs = nowMs();\n  cleanupExpiredBuckets(buckets, currentMs);\n\n  const key = `${safeScope}:${safeIdentifier}`;\n  const existing = buckets.get(key);\n\n  let bucket = existing;\n  if (!bucket || currentMs >= bucket.resetAt) {\n    bucket = {\n      count: 0,\n      resetAt: currentMs + safeWindowMs,\n    };\n  }\n\n  bucket.count += 1;\n  buckets.set(key, bucket);\n\n  const remaining = Math.max(0, safeLimit - bucket.count);\n  const retryAfterSeconds = Math.max(1, Math.ceil((bucket.resetAt - currentMs) / 1000));\n  const allowed = bucket.count <= safeLimit;\n\n  return {\n    allowed,\n    key,\n    remaining,\n    retryAfterSeconds,\n    resetAt: bucket.resetAt,\n    headers: {\n      \"Retry-After\": String(retryAfterSeconds),\n      \"X-RateLimit-Limit\": String(safeLimit),\n      \"X-RateLimit-Remaining\": String(remaining),\n      \"X-RateLimit-Reset\": String(Math.floor(bucket.resetAt / 1000)),\n    },\n  };\n}\n\nexport function enforceRateLimitByRequest({\n  request,\n  scope,\n  identifier,\n  limit,\n  windowMs,\n}) {\n  const resolvedIdentifier = normalizeIdentifier(identifier) || getRequestSourceIp(request);\n  return consumeRateLimit({\n    scope,\n    identifier: resolvedIdentifier,\n    limit,\n    windowMs,\n  });\n}\n"],"names":[],"mappings":"0zCAAA,IAAM,EAAoB,8BAuC1B,SAAS,EAAoB,CAAK,EAChC,OAAO,OAAO,GAAS,IACpB,IAAI,GACJ,WAAW,EAChB,CA0BO,SAAS,EAAiB,OAC/B,CAAK,YACL,CAAU,OACV,EAAQ,EAAE,UACV,EAAW,GAAa,CAAT,AAChB,EACC,GAFoB,CAEd,EAAY,OAAO,GAAS,WAC/B,IAAI,GACJ,WAAW,GACR,EAAiB,EAAoB,IAAe,UACpD,EAAY,KAAK,GAAG,CAAC,EAAG,OAAO,QAAQ,CAAC,OAAO,GAAQ,KAAO,GAC9D,EAAe,KAAK,GAAG,CAAC,IAAM,OAAO,QAAQ,CAAC,OAAO,GAAW,KAAO,KAEvE,GA9EF,AAAC,OA8EW,GA9ED,CAAC,EAAkB,EAAE,CAClC,UAAU,CAAC,EAAkB,CAAG,IAAI,GAAA,EAE/B,UAAU,CAAC,EAAkB,EA4E9B,EAxEC,KAAK,GAAG,EAwEG,EArEpB,AAsEE,SAtEO,AAAsB,CAAO,CAAE,CAAS,EAC/C,GAAI,EAAQ,IAAI,IAAI,EAClB,OAGF,IAJiC,AAI5B,GAAM,CAAC,EAAK,EAAM,GAAI,EAAQ,OAAO,GAAI,CACxC,CAAC,GAAS,GAAa,EAAM,OAAA,AAAO,EAAE,CACxC,EAAQ,MAAM,CAAC,GAInB,GAAI,EAAQ,IAAI,IAAI,EAClB,OAGF,IAAI,AAJ6B,EAIf,EAAQ,IAAI,CA5BZ,EA4Be,EACjC,IAAK,IAAM,KAAO,EAAQ,IAAI,GAAI,AAGhC,GAFA,EAAQ,MAAM,CAAC,GAEX,CADJ,IAAe,GACI,EACjB,CADoB,IAI1B,EA+CwB,EAAS,GAE/B,IAAM,EAAM,CAAA,EAAG,EAAU,CAAC,EAAE,EAAA,CAAgB,CAGxC,EAFa,EAAQ,GAAG,CAAC,CAEhB,GACT,CAAC,GAAU,GAAa,EAAO,OAAA,AAAO,EAAE,EAC1C,EAAS,CACP,MAAO,EACP,QAAS,EAAY,EACvB,EAGF,EAAO,KAAK,EAAI,EAChB,EAAQ,GAAG,CAAC,EAAK,GAEjB,IAAM,EAAY,KAAK,GAAG,CAAC,EAAG,EAAY,EAAO,KAAK,EAChD,EAAoB,KAAK,GAAG,CAAC,EAAG,KAAK,IAAI,CAAC,CAAC,EAAO,OAAO,CAAG,CAAA,CAAS,CAAI,MAG/E,MAAO,CACL,QAHc,EAAO,KAAK,EAAI,MAI9B,YACA,oBACA,EACA,QAAS,EAAO,OAAO,CACvB,QAAS,CACP,cAAe,OAAO,GACtB,oBAAqB,OAAO,GAC5B,wBAAyB,OAAO,GAChC,oBAAqB,OAAO,KAAK,KAAK,CAAC,EAAO,OAAO,CAAG,KAC1D,CACF,CACF,CAEO,SAAS,EAA0B,CACxC,SAAO,OACP,CAAK,YACL,CAAU,OACV,CAAK,UACL,CAAQ,CACT,EAEC,OAAO,EAAiB,CACtB,QACA,WAHyB,CAGb,CAHiC,IAjF1C,AAiFyD,SAjFhD,AAAmB,CAAO,EACxC,GAAI,CAAC,GAAW,CAAC,EAAQ,OAAO,CAC9B,CADgC,KACzB,UAGT,IAAM,EAAe,EAAQ,OAAO,CAAC,GAAG,CAAC,mBACzC,GAAI,EAAc,CAChB,IAAM,EAAU,EAAa,KAAK,CAAC,IAAI,CAAC,EAAE,EAAE,OAC5C,GAAI,EACF,OADW,AACJ,CAEX,CAGA,IAAK,IAAM,IADQ,CAAC,SACK,GADQ,mBAAoB,yBAAyB,CACzC,CACnC,IAAM,EAAQ,OAAO,EAAQ,OAAO,CAAC,GAAG,CAAC,IAAe,IAAI,IAAI,GAChE,GAAI,EACF,KADS,EACF,CAEX,CAEA,MAAO,SACT,EA2DmF,SAI/E,WACA,CACF,EACF"}