module.exports=[6617,e=>{"use strict";var t=e.i(47909),i=e.i(74017),a=e.i(96250),r=e.i(59756),o=e.i(61916),n=e.i(74677),s=e.i(69741),d=e.i(16795),u=e.i(87718),l=e.i(95169),c=e.i(47587),m=e.i(66012),p=e.i(70101),v=e.i(26937),f=e.i(10372),g=e.i(93695);e.i(52474);var h=e.i(220),y=e.i(89171),_=e.i(59979),w=e.i(4381),A=e.i(96864);async function R(e){let t=String(e||"").trim();if(!t)throw Error("missing_id_token");let i=String(process.env.NEXT_PUBLIC_FIREBASE_API_KEY||"").trim();if(!i)throw Error("firebase_api_key_not_configured");let a=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:t}),cache:"no-store"}),r=await a.json().catch(()=>({}));if(!a.ok){let e;throw Error("INVALID_ID_TOKEN"===(e=String(r?.error?.message||"").trim())||"TOKEN_EXPIRED"===e?"invalid_id_token":"USER_NOT_FOUND"===e?"firebase_user_not_found":"identity_lookup_failed")}let o=Array.isArray(r?.users)?r.users[0]:null;if(!o)throw Error("firebase_user_not_found");let n=String(o.email||"").trim().toLowerCase();if(!n)throw Error("firebase_user_missing_email");let s=Array.isArray(o.providerUserInfo)?o.providerUserInfo.map(e=>String(e?.providerId||"").trim()).filter(Boolean):[];return{uid:String(o.localId||"").trim(),email:n,emailVerified:!0===o.emailVerified,providerIds:s}}var E=e.i(11655),b=e.i(45709);function S(e,{status:t=200,rateLimit:i}={}){var a=y.NextResponse.json(e,{status:t});if(!i?.headers||"object"!=typeof i.headers)return a;for(let[e,t]of Object.entries(i.headers))a.headers.set(e,String(t));return a}async function N(e){let t=(0,w.enforceRateLimitByRequest)({request:e,scope:"auth-login-ip",limit:30,windowMs:3e5});if(!t.allowed)return await (0,A.recordAuditEvent)({activityName:"Login request rate-limited (IP)",status:"Rejected",module:"Authentication",performedBy:"anonymous@gmail.com",sensitivity:"Sensitive",metadata:{reason:"rate_limit_exceeded",scope:"auth-login-ip"},request:e}),S({message:"Too many login attempts. Please try again in a few minutes."},{status:429,rateLimit:t});try{let i=await e.json(),a="string"==typeof i?.idToken?i.idToken:"",r=await R(a),o=r.email,n=(0,w.consumeRateLimit)({scope:"auth-login-email",identifier:o,limit:12,windowMs:6e5});if(t=n,!n.allowed)return await (0,A.recordAuditEvent)({activityName:"Login request rate-limited (account)",status:"Rejected",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{reason:"rate_limit_exceeded",scope:"auth-login-email"},request:e}),S({message:"Too many login attempts for this account. Please try again shortly."},{status:429,rateLimit:n});if(!r.emailVerified)return await (0,A.recordAuditEvent)({activityName:"Login attempt rejected: email not verified",status:"Rejected",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{reason:"email_not_verified",authProvider:"firebase",firebaseUid:r.uid},request:e}),S({message:"Google account email must be verified."},{status:403,rateLimit:t});if(!r.providerIds.includes("google.com"))return await (0,A.recordAuditEvent)({activityName:"Login attempt rejected: unsupported auth provider",status:"Rejected",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{reason:"provider_not_allowed",authProvider:"firebase",firebaseUid:r.uid,providerIds:r.providerIds},request:e}),S({message:"Only Google sign-in is allowed for this workspace."},{status:403,rateLimit:t});let s=await (0,b.getLoginAccount)(o);if(!s)return await (0,A.recordAuditEvent)({activityName:"Login attempt rejected: account not provisioned",status:"Rejected",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{reason:"role_not_provisioned",authProvider:"google",firebaseUid:r.uid},request:e}),S({message:"Account is not provisioned for this workspace."},{status:403,rateLimit:t});if("disabled"===s.status)return await (0,A.recordAuditEvent)({activityName:"Login attempt rejected: account disabled",status:"Rejected",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{reason:"account_disabled",accountStatus:s.status,authProvider:"google",firebaseUid:r.uid},request:e}),S({message:"Account is disabled. Please contact Super Admin."},{status:403,rateLimit:t});if("invite"===s.source&&!s.emailVerifiedAt)return await (0,A.recordAuditEvent)({activityName:"Login attempt rejected: invite email verification required",status:"Rejected",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{reason:"invite_email_verification_required",accountStatus:s.status,authProvider:"google",firebaseUid:r.uid,source:s.source},request:e}),S({message:"Account invitation must be verified first. Open your invite verification email link."},{status:403,rateLimit:t});if("active"!==s.status)return await (0,A.recordAuditEvent)({activityName:"Login attempt rejected: account inactive",status:"Rejected",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{reason:"account_inactive",accountStatus:s.status,authProvider:"google",firebaseUid:r.uid},request:e}),S({message:"Account is not active yet. Please contact Super Admin."},{status:403,rateLimit:t});let d=null;try{d=await (0,E.syncFirebaseCustomClaimsForUser)({uid:r.uid,email:o,role:s.role,status:s.status,sessionVersion:s.sessionVersion,allowMissingUser:!1,strict:!0})}catch(a){let i=a instanceof Error?a.message:"firebase_claims_sync_failed";return await (0,A.recordAuditEvent)({activityName:"Login attempt rejected: custom claims sync failed",status:"Failed",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{reason:i,authProvider:"google",firebaseUid:r.uid},request:e}),S({message:"Secure login is temporarily unavailable. Please contact Super Admin."},{status:503,rateLimit:t})}if(!d?.ok)return await (0,A.recordAuditEvent)({activityName:"Login attempt rejected: custom claims not synchronized",status:"Failed",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{reason:d?.reason||"firebase_claims_sync_failed",authProvider:"google",firebaseUid:r.uid},request:e}),S({message:"Secure login is temporarily unavailable. Please contact Super Admin."},{status:503,rateLimit:t});let{token:u,expiresAt:l}=(0,_.createSession)(o,s.role,{sessionVersion:s.sessionVersion}),c=S({ok:!0},{rateLimit:t});return c.cookies.set(_.SESSION_COOKIE_NAME,u,(0,_.getSessionCookieOptions)(l)),await (0,b.markUserLogin)(o),await (0,A.recordAuditEvent)({activityName:`User login successful (${s.role})`,status:"Completed",module:"Authentication",performedBy:o,sensitivity:"Sensitive",metadata:{assignedRole:s.role,accountStatus:s.status,sessionVersion:s.sessionVersion,authProvider:"google",firebaseUid:r.uid,claimsSync:d.reason||"synced"},request:e}),c}catch(a){let i=a instanceof Error?a.message:"request_parse_or_internal_error";return await (0,A.recordAuditEvent)({activityName:"Login request failed",status:"Failed",module:"Authentication",performedBy:"anonymous@gmail.com",sensitivity:"Sensitive",metadata:{reason:i},request:e}),S({message:"missing_id_token"===i?"Google sign-in token is missing.":"invalid_id_token"===i?"Invalid Google sign-in token.":"firebase_api_key_not_configured"===i?"Firebase API key is not configured.":"firebase_user_not_found"===i?"Unable to verify Google account.":"firebase_user_missing_email"===i?"Google account does not expose an email.":"identity_lookup_failed"===i?"Unable to verify Google login with Firebase.":"invite_email_verification_required"===i?"Account invitation must be verified first.":"firebase_custom_claims_not_configured"===i?"Firebase custom claims are not configured.":"Unable to process login request."},{status:400,rateLimit:t})}}e.s(["POST",()=>N],41361);var P=e.i(41361);let C=new t.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:""},distDir:".next-clio",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/auth/login/route.js",nextConfigOutput:"",userland:P}),{workAsyncStorage:k,workUnitAsyncStorage:U,serverHooks:T}=C;function x(){return(0,a.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:U})}async function L(e,t,a){C.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/auth/login/route";y=y.replace(/\/index$/,"")||"/";let _=await C.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!_)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:A,nextConfig:R,parsedUrl:E,isDraftMode:b,prerenderManifest:S,routerServerContext:N,isOnDemandRevalidate:P,revalidateOnlyGenerated:k,resolvedPathname:U,clientReferenceManifest:T,serverActionsManifest:x}=_,L=(0,s.normalizeAppPath)(y),O=!!(S.dynamicRoutes[L]||S.routes[U]),I=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,E,!1):t.end("This page could not be found"),null);if(O&&!b){let e=!!S.routes[U],t=S.dynamicRoutes[L];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await I();throw new g.NoFallbackError}}let j=null;!O||C.isDev||b||(j="/index"===(j=U)?"/":j);let q=!0===C.isDev||!O,B=O&&!q;x&&T&&(0,n.setManifestsSingleton)({page:y,clientReferenceManifest:T,serverActionsManifest:x});let F=e.method||"GET",D=(0,o.getTracer)(),H=D.getActiveScopeSpan(),M={params:A,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,a,r)=>C.onRequestError(e,t,a,r,N)},sharedContext:{buildId:w}},V=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),$=u.NextRequestAdapter.fromNodeNextRequest(V,(0,u.signalFromNodeResponse)(t));try{let n=async e=>C.handle($,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=D.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=i.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${y}`)}),s=!!(0,r.getRequestMeta)(e,"minimalMode"),d=async r=>{var o,d;let u=async({previousCacheEntry:i})=>{try{if(!s&&P&&k&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await n(r);e.fetchMetrics=M.renderOpts.fetchMetrics;let d=M.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let u=M.renderOpts.collectedTags;if(!O)return await (0,m.sendResponse)(V,K,o,M.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,a=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:a}}}}catch(t){throw(null==i?void 0:i.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:P})},!1,N),t}},l=await C.handleResponse({req:e,nextConfig:R,cacheKey:j,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:k,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:s});if(!O)return null;if((null==l||null==(o=l.value)?void 0:o.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",P?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return s&&O||g.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,v.getCacheControlHeader)(l.cacheControl)),await (0,m.sendResponse)(V,K,new Response(l.value.body,{headers:g,status:l.value.status||200})),null};H?await d(H):await D.withPropagatedContext(e.headers,()=>D.trace(l.BaseServerSpan.handleRequest,{spanName:`${F} ${y}`,kind:o.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},d))}catch(t){if(t instanceof g.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:L,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:P})},!1,N),O)throw t;return await (0,m.sendResponse)(V,K,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>x,"routeModule",()=>C,"serverHooks",()=>T,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>U],6617)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_3e349984.js.map