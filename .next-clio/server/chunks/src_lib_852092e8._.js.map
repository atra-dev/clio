{"version":3,"sources":["../../../src/lib/security-notifications.js","../../../src/lib/api-rate-limit.js","../../../src/lib/incident-notification-text.js","../../../src/lib/incident-evidence-security.js"],"sourcesContent":["import {\n  addDoc,\n  collection,\n  doc,\n  getDoc,\n  getDocs,\n  limit as queryLimit,\n  orderBy,\n  query,\n  updateDoc,\n} from \"firebase/firestore/lite\";\nimport { getFirestoreDb, isFirestoreEnabled } from \"@/lib/firebase\";\nimport { listUserAccounts } from \"@/lib/user-accounts\";\n\nconst DEFAULT_LIST_LIMIT = 20;\nconst MAX_LIST_LIMIT = 120;\nconst MAX_READ_ALL_LIMIT = 300;\n\nfunction nowIso() {\n  return new Date().toISOString();\n}\n\nfunction asString(value, fallback = \"\") {\n  const normalized = String(value || \"\").trim();\n  return normalized || fallback;\n}\n\nfunction asBoolean(value, fallback = false) {\n  if (typeof value === \"boolean\") {\n    return value;\n  }\n  if (typeof value === \"number\") {\n    return value !== 0;\n  }\n  if (typeof value === \"string\") {\n    const normalized = value.trim().toLowerCase();\n    if (!normalized) {\n      return fallback;\n    }\n    if ([\"true\", \"1\", \"yes\", \"on\", \"y\"].includes(normalized)) {\n      return true;\n    }\n    if ([\"false\", \"0\", \"no\", \"off\", \"n\"].includes(normalized)) {\n      return false;\n    }\n  }\n  return fallback;\n}\n\nfunction asObject(value) {\n  if (value && typeof value === \"object\" && !Array.isArray(value)) {\n    return value;\n  }\n  return {};\n}\n\nfunction asArray(value) {\n  return Array.isArray(value) ? value : [];\n}\n\nfunction clampInt(value, fallback, { min = 1, max = Number.MAX_SAFE_INTEGER } = {}) {\n  const parsed = Number.parseInt(String(value || \"\"), 10);\n  if (!Number.isFinite(parsed)) {\n    return fallback;\n  }\n  return Math.min(max, Math.max(min, parsed));\n}\n\nfunction normalizeEmail(value) {\n  return String(value || \"\").trim().toLowerCase();\n}\n\nfunction normalizeText(value) {\n  return String(value || \"\").trim().toLowerCase();\n}\n\nfunction parseEmailList(rawValue) {\n  return String(rawValue || \"\")\n    .split(\",\")\n    .map((item) => normalizeEmail(item))\n    .filter(Boolean);\n}\n\nfunction normalizeSeverity(value) {\n  const normalized = String(value || \"\").trim().toLowerCase();\n  if (normalized === \"critical\") return \"critical\";\n  if (normalized === \"high\") return \"high\";\n  if (normalized === \"low\") return \"low\";\n  return \"medium\";\n}\n\nfunction normalizeNotificationStatus(value) {\n  return String(value || \"\").trim().toLowerCase() === \"read\" ? \"read\" : \"unread\";\n}\n\nfunction getNotificationsCollectionName() {\n  return asString(process.env.CLIO_FIRESTORE_NOTIFICATIONS_COLLECTION, \"clio_notifications\");\n}\n\nfunction getFirestoreStore() {\n  if (!isFirestoreEnabled()) {\n    return null;\n  }\n  return getFirestoreDb();\n}\n\nfunction toNotificationRecord(snapshot) {\n  const payload = snapshot.data() || {};\n  return {\n    ...payload,\n    id: snapshot.id,\n    recordId: snapshot.id,\n  };\n}\n\nfunction isVisibleNotification(row, recipientEmail) {\n  const recipient = normalizeEmail(recipientEmail);\n  const owner = normalizeEmail(row?.recipientEmail);\n  const broadcast = asBoolean(row?.broadcast, false);\n  return broadcast || (recipient && owner && recipient === owner);\n}\n\nfunction sortByCreatedDesc(left, right) {\n  return new Date(right?.createdAt || 0).getTime() - new Date(left?.createdAt || 0).getTime();\n}\n\nfunction normalizeNotificationPayload(payload) {\n  const now = nowIso();\n  const recipientEmail = normalizeEmail(payload?.recipientEmail);\n  const broadcast = asBoolean(payload?.broadcast, false);\n  if (!recipientEmail && !broadcast) {\n    throw new Error(\"invalid_notification_recipient\");\n  }\n\n  return {\n    title: asString(payload?.title, \"Security notification\"),\n    message: asString(payload?.message, \"A security event requires review.\"),\n    severity: normalizeSeverity(payload?.severity),\n    type: asString(payload?.type, \"security\"),\n    module: asString(payload?.module, \"Incident Management\"),\n    actionUrl: asString(payload?.actionUrl, \"/incident-management\"),\n    recipientEmail,\n    broadcast,\n    status: normalizeNotificationStatus(payload?.status),\n    metadata: asObject(payload?.metadata),\n    createdAt: asString(payload?.createdAt, now),\n    updatedAt: asString(payload?.updatedAt, now),\n    readAt: asString(payload?.readAt, \"\"),\n    createdBy: normalizeEmail(payload?.createdBy),\n  };\n}\n\nexport async function createInAppNotification(payload) {\n  const db = getFirestoreStore();\n  if (!db) {\n    return null;\n  }\n\n  const normalized = normalizeNotificationPayload(payload);\n  const ref = await addDoc(collection(db, getNotificationsCollectionName()), normalized);\n  return {\n    ...normalized,\n    id: ref.id,\n    recordId: ref.id,\n  };\n}\n\nexport async function createInAppNotificationsBulk(payloads) {\n  const entries = asArray(payloads);\n  if (entries.length === 0) {\n    return [];\n  }\n\n  const created = [];\n  for (const payload of entries) {\n    const result = await createInAppNotification(payload);\n    if (result) {\n      created.push(result);\n    }\n  }\n  return created;\n}\n\nexport async function listInAppNotifications({\n  recipientEmail,\n  status = \"all\",\n  limit = DEFAULT_LIST_LIMIT,\n} = {}) {\n  const db = getFirestoreStore();\n  if (!db) {\n    return {\n      records: [],\n      unreadCount: 0,\n      totalScoped: 0,\n    };\n  }\n\n  const normalizedStatus = String(status || \"\").trim().toLowerCase();\n  const safeLimit = clampInt(limit, DEFAULT_LIST_LIMIT, { min: 1, max: MAX_LIST_LIMIT });\n  const scanLimit = Math.max(safeLimit * 4, 100);\n\n  const snapshot = await getDocs(\n    query(\n      collection(db, getNotificationsCollectionName()),\n      orderBy(\"createdAt\", \"desc\"),\n      queryLimit(scanLimit),\n    ),\n  );\n\n  const scoped = snapshot.docs.map(toNotificationRecord).filter((row) => isVisibleNotification(row, recipientEmail));\n  const unreadCount = scoped.reduce((count, row) => count + (normalizeNotificationStatus(row?.status) === \"unread\" ? 1 : 0), 0);\n\n  const statusFiltered = scoped.filter((row) => {\n    if (normalizedStatus === \"all\" || !normalizedStatus) {\n      return true;\n    }\n    return normalizeNotificationStatus(row?.status) === normalizedStatus;\n  });\n\n  return {\n    records: statusFiltered.sort(sortByCreatedDesc).slice(0, safeLimit),\n    unreadCount,\n    totalScoped: scoped.length,\n  };\n}\n\nexport async function markInAppNotificationRead(recordId, recipientEmail) {\n  const db = getFirestoreStore();\n  if (!db) {\n    return null;\n  }\n\n  const normalizedId = asString(recordId);\n  if (!normalizedId) {\n    throw new Error(\"invalid_record_id\");\n  }\n\n  const ref = doc(db, getNotificationsCollectionName(), normalizedId);\n  const snapshot = await getDoc(ref);\n  if (!snapshot.exists()) {\n    return null;\n  }\n\n  const current = toNotificationRecord(snapshot);\n  if (!isVisibleNotification(current, recipientEmail)) {\n    throw new Error(\"forbidden_notification_access\");\n  }\n\n  if (normalizeNotificationStatus(current.status) === \"read\") {\n    return current;\n  }\n\n  const patched = {\n    ...current,\n    status: \"read\",\n    readAt: nowIso(),\n    updatedAt: nowIso(),\n  };\n  await updateDoc(ref, patched);\n  return patched;\n}\n\nexport async function markAllInAppNotificationsRead({ recipientEmail, limit = 120 } = {}) {\n  const normalizedRecipient = normalizeEmail(recipientEmail);\n  if (!normalizedRecipient) {\n    return {\n      updatedCount: 0,\n    };\n  }\n\n  const db = getFirestoreStore();\n  if (!db) {\n    return {\n      updatedCount: 0,\n    };\n  }\n\n  const safeLimit = clampInt(limit, 120, { min: 1, max: MAX_READ_ALL_LIMIT });\n  const { records } = await listInAppNotifications({\n    recipientEmail: normalizedRecipient,\n    status: \"unread\",\n    limit: safeLimit,\n  });\n\n  let updatedCount = 0;\n  for (const row of records) {\n    const recordId = asString(row?.id || row?.recordId);\n    if (!recordId) {\n      continue;\n    }\n    const ref = doc(db, getNotificationsCollectionName(), recordId);\n    await updateDoc(ref, {\n      status: \"read\",\n      readAt: nowIso(),\n      updatedAt: nowIso(),\n    });\n    updatedCount += 1;\n  }\n\n  return {\n    updatedCount,\n  };\n}\n\nexport function resolveNotificationRecipients(values = []) {\n  return Array.from(\n    new Set(\n      asArray(values)\n        .map((value) => normalizeEmail(value))\n        .filter(Boolean),\n    ),\n  );\n}\n\nexport async function resolveIncidentStakeholderRecipients({\n  ownerEmail,\n  affectedEmployeeEmail,\n  actorEmail,\n  includeAffectedEmployee = true,\n  includeActor = false,\n} = {}) {\n  const baseRecipients = [\n    normalizeEmail(process.env.CLIO_GRC_ALERT_EMAIL),\n    ...parseEmailList(process.env.GRC_EMAILS),\n    ...parseEmailList(process.env.SUPER_ADMIN_EMAILS),\n    normalizeEmail(ownerEmail),\n  ];\n\n  if (includeAffectedEmployee) {\n    baseRecipients.push(normalizeEmail(affectedEmployeeEmail));\n  }\n  if (includeActor) {\n    baseRecipients.push(normalizeEmail(actorEmail));\n  }\n\n  let dynamicRoleRecipients = [];\n  try {\n    const users = await listUserAccounts();\n    dynamicRoleRecipients = asArray(users)\n      .filter((user) => normalizeEmail(user?.email))\n      .filter((user) => normalizeText(user?.status) === \"active\")\n      .filter((user) => {\n        const role = String(user?.role || \"\").trim().toUpperCase();\n        return role === \"GRC\" || role === \"SUPER_ADMIN\";\n      })\n      .map((user) => normalizeEmail(user?.email));\n  } catch {\n    dynamicRoleRecipients = [];\n  }\n\n  return resolveNotificationRecipients([...baseRecipients, ...dynamicRoleRecipients]);\n}\n","const GLOBAL_BUCKET_KEY = \"__clio_rate_limit_buckets__\";\nconst MAX_BUCKETS = 5000;\n\nfunction getBuckets() {\n  if (!globalThis[GLOBAL_BUCKET_KEY]) {\n    globalThis[GLOBAL_BUCKET_KEY] = new Map();\n  }\n  return globalThis[GLOBAL_BUCKET_KEY];\n}\n\nfunction nowMs() {\n  return Date.now();\n}\n\nfunction cleanupExpiredBuckets(buckets, currentMs) {\n  if (buckets.size <= MAX_BUCKETS) {\n    return;\n  }\n\n  for (const [key, value] of buckets.entries()) {\n    if (!value || currentMs >= value.resetAt) {\n      buckets.delete(key);\n    }\n  }\n\n  if (buckets.size <= MAX_BUCKETS) {\n    return;\n  }\n\n  let removeCount = buckets.size - MAX_BUCKETS;\n  for (const key of buckets.keys()) {\n    buckets.delete(key);\n    removeCount -= 1;\n    if (removeCount <= 0) {\n      break;\n    }\n  }\n}\n\nfunction normalizeIdentifier(value) {\n  return String(value || \"\")\n    .trim()\n    .toLowerCase();\n}\n\nexport function getRequestSourceIp(request) {\n  if (!request || !request.headers) {\n    return \"unknown\";\n  }\n\n  const forwardedFor = request.headers.get(\"x-forwarded-for\");\n  if (forwardedFor) {\n    const firstIp = forwardedFor.split(\",\")[0]?.trim();\n    if (firstIp) {\n      return firstIp;\n    }\n  }\n\n  const candidates = [\"x-real-ip\", \"cf-connecting-ip\", \"x-vercel-forwarded-for\"];\n  for (const headerName of candidates) {\n    const value = String(request.headers.get(headerName) || \"\").trim();\n    if (value) {\n      return value;\n    }\n  }\n\n  return \"unknown\";\n}\n\nexport function consumeRateLimit({\n  scope,\n  identifier,\n  limit = 20,\n  windowMs = 5 * 60 * 1000,\n}) {\n  const safeScope = String(scope || \"default\")\n    .trim()\n    .toLowerCase();\n  const safeIdentifier = normalizeIdentifier(identifier) || \"unknown\";\n  const safeLimit = Math.max(1, Number.parseInt(String(limit), 10) || 1);\n  const safeWindowMs = Math.max(1000, Number.parseInt(String(windowMs), 10) || 1000);\n\n  const buckets = getBuckets();\n  const currentMs = nowMs();\n  cleanupExpiredBuckets(buckets, currentMs);\n\n  const key = `${safeScope}:${safeIdentifier}`;\n  const existing = buckets.get(key);\n\n  let bucket = existing;\n  if (!bucket || currentMs >= bucket.resetAt) {\n    bucket = {\n      count: 0,\n      resetAt: currentMs + safeWindowMs,\n    };\n  }\n\n  bucket.count += 1;\n  buckets.set(key, bucket);\n\n  const remaining = Math.max(0, safeLimit - bucket.count);\n  const retryAfterSeconds = Math.max(1, Math.ceil((bucket.resetAt - currentMs) / 1000));\n  const allowed = bucket.count <= safeLimit;\n\n  return {\n    allowed,\n    key,\n    remaining,\n    retryAfterSeconds,\n    resetAt: bucket.resetAt,\n    headers: {\n      \"Retry-After\": String(retryAfterSeconds),\n      \"X-RateLimit-Limit\": String(safeLimit),\n      \"X-RateLimit-Remaining\": String(remaining),\n      \"X-RateLimit-Reset\": String(Math.floor(bucket.resetAt / 1000)),\n    },\n  };\n}\n\nexport function enforceRateLimitByRequest({\n  request,\n  scope,\n  identifier,\n  limit,\n  windowMs,\n}) {\n  const resolvedIdentifier = normalizeIdentifier(identifier) || getRequestSourceIp(request);\n  return consumeRateLimit({\n    scope,\n    identifier: resolvedIdentifier,\n    limit,\n    windowMs,\n  });\n}\n","function asString(value, fallback = \"\") {\n  const normalized = String(value || \"\").trim();\n  return normalized || fallback;\n}\n\nconst INCIDENT_FIELD_LABELS = {\n  title: \"Incident title\",\n  summary: \"Incident summary\",\n  incidentType: \"Incident type\",\n  severity: \"Severity\",\n  status: \"Status\",\n  containmentStatus: \"Containment status\",\n  containmentSummary: \"Containment summary\",\n  impactAssessmentStatus: \"Impact assessment status\",\n  impactSummary: \"Impact assessment summary\",\n  ownerEmail: \"Incident owner\",\n  affectedEmployeeEmail: \"Affected employee\",\n  restrictedPiiInvolved: \"Restricted PII flag\",\n  escalationRequired: \"Escalation requirement\",\n  executiveNotificationRequired: \"Executive notification requirement\",\n  regulatoryNotificationRequired: \"Regulatory notification requirement\",\n  regulatoryNotifiedAt: \"Regulator notification\",\n  affectedIndividualsNotifiedAt: \"Affected-individual notification\",\n  grcAlertedAt: \"GRC alert timestamp\",\n  executiveNotifiedAt: \"Executive notification timestamp\",\n  documentationRetained: \"Documentation retention\",\n  documentationLocation: \"Documentation location\",\n  classificationStandard: \"Classification standard\",\n  notes: \"Investigation notes\",\n  forensicWindowStart: \"Forensic window start\",\n  forensicWindowEnd: \"Forensic window end\",\n};\n\nfunction humanizeFieldKey(key) {\n  const normalized = asString(key);\n  if (!normalized) return \"Field\";\n  if (INCIDENT_FIELD_LABELS[normalized]) {\n    return INCIDENT_FIELD_LABELS[normalized];\n  }\n  return normalized\n    .replace(/([a-z0-9])([A-Z])/g, \"$1 $2\")\n    .replace(/[_-]+/g, \" \")\n    .replace(/\\s+/g, \" \")\n    .trim()\n    .replace(/^./, (char) => char.toUpperCase());\n}\n\nfunction summarizeChangedFields(changedFields = [], { max = 4 } = {}) {\n  const labels = Array.from(\n    new Set(\n      (Array.isArray(changedFields) ? changedFields : [])\n        .map((field) => humanizeFieldKey(field))\n        .filter(Boolean),\n    ),\n  );\n\n  if (labels.length === 0) {\n    return \"\";\n  }\n  if (labels.length <= max) {\n    return labels.join(\", \");\n  }\n  const visible = labels.slice(0, max).join(\", \");\n  return `${visible}, +${labels.length - max} more`;\n}\n\nexport function resolveIncidentDisplayName(incident = {}, fallbackRecordId = \"\") {\n  const title = asString(incident?.title);\n  if (title) {\n    return title;\n  }\n  const code = asString(incident?.incidentCode);\n  if (code) {\n    return `Case ${code}`;\n  }\n  if (asString(fallbackRecordId)) {\n    return \"Incident Record\";\n  }\n  return \"Incident\";\n}\n\nexport function buildIncidentCreatedNotification(incident = {}, fallbackRecordId = \"\") {\n  const displayName = resolveIncidentDisplayName(incident, fallbackRecordId);\n  const severity = asString(incident?.severity, \"Medium\");\n  const status = asString(incident?.status, \"Open\");\n  return {\n    title: `New Incident: ${displayName}`,\n    message: `A new incident has been logged for review. Severity: ${severity}. Current status: ${status}.`,\n  };\n}\n\nexport function buildIncidentUpdatedNotification(\n  incident = {},\n  changedFields = [],\n  fallbackRecordId = \"\",\n) {\n  const displayName = resolveIncidentDisplayName(incident, fallbackRecordId);\n  const changedSummary = summarizeChangedFields(changedFields);\n\n  const normalizedChanged = new Set((Array.isArray(changedFields) ? changedFields : []).map((field) => asString(field)));\n\n  let actionSummary = \"Incident workflow details were updated.\";\n  if (normalizedChanged.has(\"status\")) {\n    actionSummary = `Incident status is now ${asString(incident?.status, \"updated\")}.`;\n  } else if (normalizedChanged.has(\"containmentStatus\")) {\n    actionSummary = `Containment status is now ${asString(incident?.containmentStatus, \"updated\")}.`;\n  } else if (normalizedChanged.has(\"regulatoryNotifiedAt\")) {\n    actionSummary = \"Regulator notification has been recorded.\";\n  } else if (normalizedChanged.has(\"affectedIndividualsNotifiedAt\")) {\n    actionSummary = \"Affected-individual notification has been recorded.\";\n  } else if (normalizedChanged.has(\"executiveNotifiedAt\")) {\n    actionSummary = \"Executive notification has been recorded.\";\n  } else if (normalizedChanged.has(\"grcAlertedAt\")) {\n    actionSummary = \"GRC alert timestamp has been recorded.\";\n  }\n\n  const changedText = changedSummary ? ` Updated fields: ${changedSummary}.` : \"\";\n  return {\n    title: `Incident Updated: ${displayName}`,\n    message: `${actionSummary}${changedText}`.trim(),\n  };\n}\n","const DEFAULT_MAX_BYTES = 10 * 1024 * 1024;\nconst DEFAULT_ALLOWED_EXTENSIONS = new Set([\"pdf\", \"png\", \"jpg\", \"jpeg\", \"webp\", \"doc\", \"docx\", \"xls\", \"xlsx\", \"csv\", \"txt\"]);\nconst DEFAULT_ALLOWED_MIME_TYPES = new Set([\n  \"application/pdf\",\n  \"image/png\",\n  \"image/jpeg\",\n  \"image/webp\",\n  \"application/msword\",\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n  \"application/vnd.ms-excel\",\n  \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n  \"text/csv\",\n  \"text/plain\",\n]);\n\nfunction asString(value, fallback = \"\") {\n  const normalized = String(value || \"\").trim();\n  return normalized || fallback;\n}\n\nfunction asArray(value) {\n  return Array.isArray(value) ? value : [];\n}\n\nfunction asObject(value, fallback = null) {\n  if (value && typeof value === \"object\" && !Array.isArray(value)) {\n    return value;\n  }\n  return fallback;\n}\n\nfunction normalizeText(value) {\n  return asString(value).toLowerCase();\n}\n\nfunction parseBooleanEnv(name, fallbackValue = false) {\n  const normalized = normalizeText(process.env[name]);\n  if (!normalized) {\n    return fallbackValue;\n  }\n  return normalized === \"true\" || normalized === \"1\" || normalized === \"yes\" || normalized === \"on\";\n}\n\nfunction parseIntegerEnv(name, fallbackValue, { min = 1, max = Number.MAX_SAFE_INTEGER } = {}) {\n  const parsed = Number.parseInt(asString(process.env[name]), 10);\n  if (!Number.isFinite(parsed)) {\n    return fallbackValue;\n  }\n  return Math.min(max, Math.max(min, parsed));\n}\n\nfunction parseCsvSetEnv(name, fallbackSet) {\n  const raw = asString(process.env[name]);\n  if (!raw) {\n    return new Set([...fallbackSet]);\n  }\n  const values = raw\n    .split(\",\")\n    .map((item) => normalizeText(item))\n    .filter(Boolean);\n  return values.length > 0 ? new Set(values) : new Set([...fallbackSet]);\n}\n\nfunction normalizeEmail(value) {\n  return asString(value).toLowerCase();\n}\n\nfunction nowIso() {\n  return new Date().toISOString();\n}\n\nfunction getFileExtensionFromText(value) {\n  const input = asString(value).toLowerCase();\n  if (!input) {\n    return \"\";\n  }\n  const clean = input.split(\"?\")[0].split(\"#\")[0];\n  const token = clean.split(\".\").pop() || \"\";\n  if (!/^[a-z0-9]{2,10}$/.test(token)) {\n    return \"\";\n  }\n  return token;\n}\n\nfunction inferMimeTypeFromExtension(extension) {\n  const ext = normalizeText(extension);\n  if (ext === \"pdf\") return \"application/pdf\";\n  if (ext === \"png\") return \"image/png\";\n  if (ext === \"jpg\" || ext === \"jpeg\") return \"image/jpeg\";\n  if (ext === \"webp\") return \"image/webp\";\n  if (ext === \"doc\") return \"application/msword\";\n  if (ext === \"docx\") return \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\";\n  if (ext === \"xls\") return \"application/vnd.ms-excel\";\n  if (ext === \"xlsx\") return \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\";\n  if (ext === \"csv\") return \"text/csv\";\n  if (ext === \"txt\") return \"text/plain\";\n  return \"\";\n}\n\nfunction normalizeEvidenceType(value) {\n  const normalized = asString(value, \"Incident Evidence\");\n  return normalized.slice(0, 80);\n}\n\nfunction getValidationConfig() {\n  return {\n    maxBytes: parseIntegerEnv(\"CLIO_INCIDENT_EVIDENCE_MAX_BYTES\", DEFAULT_MAX_BYTES, {\n      min: 128 * 1024,\n      max: 50 * 1024 * 1024,\n    }),\n    allowedExtensions: parseCsvSetEnv(\"CLIO_INCIDENT_EVIDENCE_ALLOWED_EXTENSIONS\", DEFAULT_ALLOWED_EXTENSIONS),\n    allowedMimeTypes: parseCsvSetEnv(\"CLIO_INCIDENT_EVIDENCE_ALLOWED_MIME_TYPES\", DEFAULT_ALLOWED_MIME_TYPES),\n    requireMimeType: parseBooleanEnv(\"CLIO_INCIDENT_EVIDENCE_REQUIRE_MIME_TYPE\", true),\n    avHookUrl: asString(process.env.CLIO_INCIDENT_EVIDENCE_AV_HOOK_URL),\n    avHookToken: asString(process.env.CLIO_INCIDENT_EVIDENCE_AV_HOOK_TOKEN),\n    avRequired: parseBooleanEnv(\"CLIO_INCIDENT_EVIDENCE_AV_REQUIRED\", false),\n    avFailOpen: parseBooleanEnv(\"CLIO_INCIDENT_EVIDENCE_AV_FAIL_OPEN\", false),\n    avTimeoutMs: parseIntegerEnv(\"CLIO_INCIDENT_EVIDENCE_AV_TIMEOUT_MS\", 5000, {\n      min: 1000,\n      max: 20000,\n    }),\n  };\n}\n\nfunction normalizeEvidenceRecord(entry, index, actorEmail, config) {\n  const source = asObject(entry);\n  if (!source) {\n    throw new Error(\"invalid_incident_evidence_payload\");\n  }\n\n  const name = asString(source.name);\n  if (!name) {\n    throw new Error(\"invalid_incident_evidence_name\");\n  }\n\n  const ref = asString(source.ref);\n  const storagePath = asString(source.storagePath);\n  if (!ref && !storagePath) {\n    throw new Error(\"invalid_incident_evidence_reference\");\n  }\n\n  const fileExtension =\n    getFileExtensionFromText(source.fileExtension) ||\n    getFileExtensionFromText(name) ||\n    getFileExtensionFromText(storagePath) ||\n    getFileExtensionFromText(ref);\n  if (!fileExtension || !config.allowedExtensions.has(fileExtension)) {\n    throw new Error(\"invalid_incident_evidence_extension\");\n  }\n\n  const normalizedContentType = normalizeText(source.contentType) || inferMimeTypeFromExtension(fileExtension);\n  if (!normalizedContentType || !config.allowedMimeTypes.has(normalizedContentType)) {\n    throw new Error(\"invalid_incident_evidence_content_type\");\n  }\n\n  if (config.requireMimeType && !asString(source.contentType)) {\n    throw new Error(\"invalid_incident_evidence_content_type\");\n  }\n\n  const rawSize = Number(source.sizeBytes);\n  if (!Number.isFinite(rawSize) || rawSize <= 0 || rawSize > config.maxBytes) {\n    throw new Error(\"invalid_incident_evidence_size\");\n  }\n\n  const uploadedAt = asString(source.uploadedAt, nowIso());\n  const uploadedBy = normalizeEmail(source.uploadedBy || actorEmail);\n  const id = asString(source.id || source.recordId, `incident-evidence-${Date.now()}-${index + 1}`);\n\n  return {\n    id,\n    name: name.slice(0, 180),\n    type: normalizeEvidenceType(source.type),\n    ref,\n    storagePath,\n    fileExtension,\n    contentType: normalizedContentType,\n    sizeBytes: Math.round(rawSize),\n    uploadedAt,\n    uploadedBy: uploadedBy || normalizeEmail(actorEmail) || \"system@gmail.com\",\n    scanStatus: asString(source.scanStatus),\n    scanReference: asString(source.scanReference),\n  };\n}\n\nasync function runEvidenceAvHook(records, actorEmail, config) {\n  if (!config.avHookUrl) {\n    if (config.avRequired) {\n      throw new Error(\"incident_evidence_av_not_configured\");\n    }\n    return {\n      status: \"skipped\",\n      provider: \"none\",\n      blockedIds: [],\n      reference: \"\",\n    };\n  }\n\n  const controller = new AbortController();\n  const timeout = setTimeout(() => controller.abort(), config.avTimeoutMs);\n  try {\n    const headers = {\n      \"Content-Type\": \"application/json\",\n      \"X-CLIO-Source\": \"incident-evidence-validation\",\n    };\n    if (config.avHookToken) {\n      headers.Authorization = `Bearer ${config.avHookToken}`;\n    }\n\n    const response = await fetch(config.avHookUrl, {\n      method: \"POST\",\n      headers,\n      body: JSON.stringify({\n        generatedAt: nowIso(),\n        actorEmail: normalizeEmail(actorEmail),\n        records: records.map((record) => ({\n          id: record.id,\n          name: record.name,\n          storagePath: record.storagePath,\n          ref: record.ref,\n          contentType: record.contentType,\n          fileExtension: record.fileExtension,\n          sizeBytes: record.sizeBytes,\n        })),\n      }),\n      signal: controller.signal,\n    });\n\n    const payload = await response.json().catch(() => ({}));\n    if (!response.ok) {\n      throw new Error(asString(payload?.message, \"incident_evidence_av_hook_failed\"));\n    }\n\n    const blockedIds = asArray(payload?.blockedIds)\n      .map((item) => asString(item))\n      .filter(Boolean);\n    const blocked = payload?.allowed === false || payload?.blocked === true || blockedIds.length > 0;\n    if (blocked) {\n      throw new Error(\"incident_evidence_av_blocked\");\n    }\n\n    return {\n      status: \"passed\",\n      provider: \"hook\",\n      blockedIds: [],\n      reference: asString(payload?.scanId || payload?.reference || \"\"),\n    };\n  } catch (error) {\n    if (config.avFailOpen && !config.avRequired) {\n      return {\n        status: \"failed-open\",\n        provider: \"hook\",\n        blockedIds: [],\n        reference: \"\",\n      };\n    }\n    const reason = error instanceof Error ? asString(error.message) : \"\";\n    if (reason === \"incident_evidence_av_blocked\") {\n      throw error;\n    }\n    throw new Error(\"incident_evidence_av_hook_failed\");\n  } finally {\n    clearTimeout(timeout);\n  }\n}\n\nexport async function validateIncidentEvidenceDocumentsStrict(records, { actorEmail } = {}) {\n  if (!Array.isArray(records)) {\n    throw new Error(\"invalid_incident_evidence_payload\");\n  }\n\n  const config = getValidationConfig();\n  const normalizedRecords = records.map((entry, index) =>\n    normalizeEvidenceRecord(entry, index, actorEmail, config),\n  );\n\n  const avResult = await runEvidenceAvHook(normalizedRecords, actorEmail, config);\n  const scannedAt = nowIso();\n  return normalizedRecords.map((record) => ({\n    ...record,\n    scanStatus: record.scanStatus || avResult.status,\n    scanReference: record.scanReference || avResult.reference,\n    scannedAt,\n  }));\n}\n"],"names":[],"mappings":"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"}